<!DOCTYPE html>
<html lang="en">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"jasonxqh.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Jason‘s Blog">
<meta property="og:url" content="https://jasonxqh.github.io/page/26/index.html">
<meta property="og:site_name" content="Jason‘s Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Jason">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://jasonxqh.github.io/page/26/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Jason‘s Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Jason‘s Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://jasonxqh.github.io/2020/06/07/Nodejs%E5%9F%BA%E7%A1%803/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason‘s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%803/" class="post-title-link" itemprop="url">Nodejs基础3</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-07 20:53:52" itemprop="dateCreated datePublished" datetime="2020-06-07T20:53:52+08:00">2020-06-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-06-30 10:38:32" itemprop="dateModified" datetime="2020-06-30T10:38:32+08:00">2020-06-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/node/" itemprop="url" rel="index"><span itemprop="name">node</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Mongo-Data-Validation"><a href="#Mongo-Data-Validation" class="headerlink" title="Mongo - Data Validation"></a>Mongo - Data Validation</h2><h3 id="Validation"><a href="#Validation" class="headerlink" title="Validation"></a>Validation</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> courseSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">  name: <span class="built_in">String</span>,</span><br><span class="line">  author: <span class="built_in">String</span>, </span><br><span class="line">  tags: [ <span class="built_in">String</span> ],</span><br><span class="line">  date: <span class="built_in">Date</span>, </span><br><span class="line">  isPublished: <span class="built_in">Boolean</span>,</span><br><span class="line">  price: <span class="built_in">Number</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>之前我们对于表的定义是这样的，所以当我创建一个空对象也是可以通过验证的。MongoDB不会在意我们的课程是否有单价。所以我们需要required验证器</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> courseSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">  name: &#123;<span class="attr">type</span>: <span class="built_in">String</span>,<span class="attr">required</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">  author: <span class="built_in">String</span>, </span><br><span class="line">  tags: [ <span class="built_in">String</span> ],</span><br><span class="line">  date: <span class="built_in">Date</span>, </span><br><span class="line">  isPublished: <span class="built_in">Boolean</span>,</span><br><span class="line">  price: <span class="built_in">Number</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> course.save();</span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(ex.message);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<p>这时候当我们去掉name信息之后，运行createCourse()函数，catch会捕捉到下面的报错</p>
<p>Course validation failed: name: Path <code>name</code> is required.</p>
<p>我们也可以手工处理验证</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> course.validate();</span><br></pre></td></tr></table></figure>
<p>不想Mysql，mongodb是没有必须填写这种验证的。所以验证只有写在mongoose里面才会起作用。当我们尝试写入数据库时，mongoose会做验证，不通过就不会向数据库写入</p>
<p>当然我们可以使用Joi来验证字符串，一般在RESTful API种使用Joi. Mongoose在写入数据库之前验证数据是否合法</p>
<p>因为可能客户端将合法的数据写在了请求当中，但是当我们在创建http 服务的course对象的时候，也许我们忘记把name属性从req.body.name中读取出来了。所以利用mongoose可以确保数据库中不会出现不合法的数据文档</p>
<h3 id="Built-in-Validators"><a href="#Built-in-Validators" class="headerlink" title="Built-in Validators"></a>Built-in Validators</h3><p>我们现在假设，price只有当isPublished为true得时候才是必需的。现在我们来写这个验证器</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> courseSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">  name: &#123;<span class="attr">type</span>: <span class="built_in">String</span>,<span class="attr">required</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">  author: <span class="built_in">String</span>, </span><br><span class="line">  tags: [ <span class="built_in">String</span> ],</span><br><span class="line">  date: <span class="built_in">Date</span>, </span><br><span class="line">  isPublished: <span class="built_in">Boolean</span>,</span><br><span class="line">  price: &#123;</span><br><span class="line">      type:<span class="built_in">Number</span>,</span><br><span class="line">      required: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>.isPublished;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> Course = mongoose.model(<span class="string">"Course"</span>, courseSchema);</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">createCourse</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> course = <span class="keyword">new</span> Course(&#123;</span><br><span class="line">    <span class="comment">// name: "Node.js Course,</span></span><br><span class="line">    author: <span class="string">"Mosh"</span>,</span><br><span class="line">    tags: [<span class="string">"node"</span>, <span class="string">"backend"</span>],</span><br><span class="line">    isPublished: <span class="literal">true</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> course.save();</span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(ex.message);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意，在这个特定的地方是不能用箭头函数的，因为箭头函数没有this，它使用的this是继承而来的。所以箭头函数中的this指的是courseSchema。</p>
<p>运行后，我们发现</p>
<p>Course validation failed: price: Path <code>price</code> is required., name: Path <code>name</code> is required.</p>
<p>所以验证既可以是一个简单的值，也可以是一个验证条件的函数</p>
<p>当然我们也可以有附加的验证器</p>
<p>比如，在string类型中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">name: &#123;</span><br><span class="line">	type: <span class="built_in">String</span>,</span><br><span class="line">	required: <span class="literal">true</span>,</span><br><span class="line">	minlenght: <span class="number">5</span>,</span><br><span class="line">	maxlenght: <span class="number">255</span>,</span><br><span class="line">	match: <span class="regexp">/pattern/</span> <span class="comment">//写正则表达式</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>我们还可以用enum属性(python中的数组).也就是说，我们添加的新的内容，必须在enum给出的范围之内</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">category:&#123;</span><br><span class="line">	type: <span class="built_in">String</span>,</span><br><span class="line">	required: <span class="literal">true</span>,</span><br><span class="line">	enum: [<span class="string">'web'</span>,<span class="string">'mobile'</span>,<span class="string">'network'</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于数字，我们可以有min 和max</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">price: &#123;</span><br><span class="line">    type:<span class="built_in">Number</span>,</span><br><span class="line">    required: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>.isPublished;&#125;</span><br><span class="line">    min: <span class="number">10</span>,</span><br><span class="line">    max: <span class="number">200</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Custom-Validators"><a href="#Custom-Validators" class="headerlink" title="Custom Validators"></a>Custom Validators</h3><p>有时候内建的验证器并不能满足我们的需求</p>
<p>例如tags属性，他是一个字符串数组，假设我们要求每个课程必须有一个tag，那么我们在这里无法使用required。因为当使用了required，传入一个空数组，mongoose也会认为这是合法的。所以我们要自定义验证器了</p>
<p>我们设置validate属性是一个对象，这个对象中有个属性是validator，这是一个函数，函数里面写验证逻辑</p>
<p>此外还需要一条提示信息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tags:&#123;</span><br><span class="line">	type: <span class="built_in">Array</span>,</span><br><span class="line">	validate:&#123;</span><br><span class="line">		validator: <span class="function"><span class="keyword">function</span>(<span class="params">v</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> v&amp;&amp;v.length&gt;<span class="number">0</span>;</span><br><span class="line">		&#125;,</span><br><span class="line">		message:<span class="string">"A course must have one tag"</span> <span class="comment">//提示信息是可选的</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在当tags数组为空，tags: null 或者不传入tags的时候，就会出现以下报错：</p>
<p>Course validation failed: price: Path <code>price</code> is required., name: Path <code>name</code> is required., tags: A course must have one tag</p>
<h3 id="Async-Validators"><a href="#Async-Validators" class="headerlink" title="Async Validators"></a>Async Validators</h3><p>验证有时候需要读取数据库或者远端的http服务，我们不能直接得到结论。这时候需要异步验证</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">tags:&#123;</span><br><span class="line">	type: <span class="built_in">Array</span>,</span><br><span class="line">	validate:&#123;</span><br><span class="line">		isAsync: <span class="literal">true</span>,</span><br><span class="line">		validator: <span class="function"><span class="keyword">function</span>(<span class="params">v,callback</span>)</span>&#123;</span><br><span class="line">			setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">				<span class="keyword">const</span> result = v&amp;&amp;v.length&gt;<span class="number">0</span>;</span><br><span class="line">				callback(result);</span><br><span class="line">			&#125;,<span class="number">4000</span>);</span><br><span class="line">		&#125;,</span><br><span class="line">		message:<span class="string">"A course must have one tag"</span> </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先设置isAsync 属性为true，其次这一个回调函数。这里用setTimeout()代替</p>
<p>现实项目当中这个结果可能来自于对文件系统，数据库或者远端服务返回值的计算</p>
<h3 id="Validation-Errors"><a href="#Validation-Errors" class="headerlink" title="Validation Errors"></a>Validation Errors</h3><p>现在我们来扩展Error对象的细节</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> course.save();</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">  <span class="keyword">for</span>(field <span class="keyword">in</span> ex.errors)</span><br><span class="line">  	<span class="built_in">console</span>.log(ex.errors[field]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%803/1.png" style="zoom:80%;"></p>
<p>我们可以看到这里 一开始是验证错误的对象，然后是错误信息的提示。然后是堆栈的追踪信息。</p>
<h3 id="SchemaType-Options"><a href="#SchemaType-Options" class="headerlink" title="SchemaType Options"></a>SchemaType Options</h3><p>当定义schema的时候，可以直接定义属性的类型，也可以使用对象：type,required,enum等等属性。</p>
<p>现在我们再来了解几个有用的schema对象的属性</p>
<p>lowercase: 当lowercase is true时，mongoose会自动将字符串转为小写</p>
<p>uppercase: 当uppercase is true时，mongoose会自动将字符串转为大写</p>
<p>自定义get，set。比如我想要对price数值四舍五入小数部分。</p>
<p>这样当写入price的时候，set属性会自动四舍五入</p>
<p>get的作用是在数据库中取得浮点数的时候会自动<strong>以四舍五入的方式呈现</strong>（数据库中没有改变）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">price:&#123;</span><br><span class="line">	<span class="keyword">get</span>: v=&gt;Math.round(v),</span><br><span class="line">	<span class="keyword">set</span>: v=&gt;Math.round(v)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Project-Add-Persistence-to-Genres-API"><a href="#Project-Add-Persistence-to-Genres-API" class="headerlink" title="Project- Add Persistence to Genres API"></a>Project- Add Persistence to Genres API</h3><p>genre.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Joi = <span class="built_in">require</span>(<span class="string">"joi"</span>);</span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">"mongoose"</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Genre = mongoose.model(</span><br><span class="line">  <span class="string">"Genre"</span>,</span><br><span class="line">  <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">    name: &#123;</span><br><span class="line">      type: <span class="built_in">String</span>,</span><br><span class="line">      required: <span class="literal">true</span>,</span><br><span class="line">      minlength: <span class="number">5</span>,</span><br><span class="line">      maxlength: <span class="number">50</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">"/"</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> genres = <span class="keyword">await</span> Genre.find().sort(<span class="string">"name"</span>);</span><br><span class="line">  res.send(genres);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">"/"</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; error &#125; = validateGenre(req.body);</span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">return</span> res.status(<span class="number">400</span>).send(error.details[<span class="number">0</span>].message);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> genre = <span class="keyword">new</span> Genre(&#123; <span class="attr">name</span>: req.body.name &#125;);</span><br><span class="line">  genre = <span class="keyword">await</span> genre.save();</span><br><span class="line"></span><br><span class="line">  res.send(genre);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.put(<span class="string">"/:id"</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; error &#125; = validateGenre(req.body);</span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">return</span> res.status(<span class="number">400</span>).send(error.details[<span class="number">0</span>].message);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> genre = <span class="keyword">await</span> Genre.findByIdAndUpdate(</span><br><span class="line">    req.params.id,</span><br><span class="line">    &#123; <span class="attr">name</span>: req.body.name &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">new</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!genre)</span><br><span class="line">    <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">"The genre with the given ID was not found."</span>);</span><br><span class="line"></span><br><span class="line">  res.send(genre);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.delete(<span class="string">"/:id"</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> genre = <span class="keyword">await</span> Genre.findByIdAndRemove(req.params.id);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!genre)</span><br><span class="line">    <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">"The genre with the given ID was not found."</span>);</span><br><span class="line"></span><br><span class="line">  res.send(genre);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">"/:id"</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> genre = <span class="keyword">await</span> Genre.findById(req.params.id);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!genre)</span><br><span class="line">    <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">"The genre with the given ID was not found."</span>);</span><br><span class="line"></span><br><span class="line">  res.send(genre);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateGenre</span>(<span class="params">genre</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> schema = &#123;</span><br><span class="line">    name: Joi.string().min(<span class="number">3</span>).required(),</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Joi.validate(genre, schema);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<p>index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>)</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"><span class="keyword">const</span> genres = <span class="built_in">require</span>(<span class="string">"./routes/genres"</span>);</span><br><span class="line">app.use(express.json());</span><br><span class="line">mongoose.connect(<span class="string">'mongodb://localhost/vidly'</span>)</span><br><span class="line">    .then(<span class="function"><span class="params">()</span>=&gt;</span><span class="built_in">console</span>.log(<span class="string">"Connected to MongoDB"</span>))</span><br><span class="line">    .catch(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.error(<span class="string">'Could not connect to MongoDB'</span>))</span><br><span class="line">app.use(<span class="string">"/api/genres"</span>, genres);</span><br><span class="line"><span class="keyword">const</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line">app.listen(port, () =&gt; <span class="built_in">console</span>.log(<span class="string">`Listening on port <span class="subst">$&#123;port&#125;</span>...`</span>));</span><br></pre></td></tr></table></figure>
<h3 id="Project-Build-the-Customers-API"><a href="#Project-Build-the-Customers-API" class="headerlink" title="Project- Build the Customers API"></a>Project- Build the Customers API</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Joi = <span class="built_in">require</span>(<span class="string">'joi'</span>);</span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Customer = mongoose.model(<span class="string">'Customer'</span>, <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">  name: &#123;</span><br><span class="line">    type: <span class="built_in">String</span>,</span><br><span class="line">    required: <span class="literal">true</span>,</span><br><span class="line">    minlength: <span class="number">5</span>,</span><br><span class="line">    maxlength: <span class="number">50</span></span><br><span class="line">  &#125;,</span><br><span class="line">  isGold: &#123;</span><br><span class="line">    type: <span class="built_in">Boolean</span>,</span><br><span class="line">    <span class="keyword">default</span>: <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  phone: &#123;</span><br><span class="line">    type: <span class="built_in">String</span>,</span><br><span class="line">    required: <span class="literal">true</span>,</span><br><span class="line">    minlength: <span class="number">5</span>,</span><br><span class="line">    maxlength: <span class="number">50</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/'</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> customers = <span class="keyword">await</span> Customer.find().sort(<span class="string">'name'</span>);</span><br><span class="line">  res.send(customers);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">'/'</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; error &#125; = validateCustomer(req.body); </span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">return</span> res.status(<span class="number">400</span>).send(error.details[<span class="number">0</span>].message);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> customer = <span class="keyword">new</span> Customer(&#123; </span><br><span class="line">    name: req.body.name,</span><br><span class="line">    isGold: req.body.isGold,</span><br><span class="line">    phone: req.body.phone</span><br><span class="line">  &#125;);</span><br><span class="line">  customer = <span class="keyword">await</span> customer.save();</span><br><span class="line">  </span><br><span class="line">  res.send(customer);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.put(<span class="string">'/:id'</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; error &#125; = validateCustomer(req.body); </span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">return</span> res.status(<span class="number">400</span>).send(error.details[<span class="number">0</span>].message);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> customer = <span class="keyword">await</span> Customer.findByIdAndUpdate(req.params.id,</span><br><span class="line">    &#123; </span><br><span class="line">      name: req.body.name,</span><br><span class="line">      isGold: req.body.isGold,</span><br><span class="line">      phone: req.body.phone</span><br><span class="line">    &#125;, &#123; <span class="attr">new</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!customer) <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">'The customer with the given ID was not found.'</span>);</span><br><span class="line">  </span><br><span class="line">  res.send(customer);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.delete(<span class="string">'/:id'</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> customer = <span class="keyword">await</span> Customer.findByIdAndRemove(req.params.id);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!customer) <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">'The customer with the given ID was not found.'</span>);</span><br><span class="line"></span><br><span class="line">  res.send(customer);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/:id'</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> customer = <span class="keyword">await</span> Customer.findById(req.params.id);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!customer) <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">'The customer with the given ID was not found.'</span>);</span><br><span class="line"></span><br><span class="line">  res.send(customer);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateCustomer</span>(<span class="params">customer</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> schema = &#123;</span><br><span class="line">    name: Joi.string().min(<span class="number">5</span>).max(<span class="number">50</span>).required(),</span><br><span class="line">    phone: Joi.string().min(<span class="number">5</span>).max(<span class="number">50</span>).required(),</span><br><span class="line">    isGold: Joi.boolean()</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Joi.validate(customer, schema);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<h3 id="Restructuring-the-Project"><a href="#Restructuring-the-Project" class="headerlink" title="Restructuring the Project"></a>Restructuring the Project</h3><p>现在一个js文件虽然只有80多行，但以后肯定时很庞大的，所以我们要进行代码重构。</p>
<p>所以我们把一些对象都放到models文件夹中，routes专心处理api</p>
<p>在models中我们新建一个customer.js存放</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">"mongoose"</span>);</span><br><span class="line"><span class="keyword">const</span> Joi = <span class="built_in">require</span>(<span class="string">"joi"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Customer = mongoose.model(</span><br><span class="line">  <span class="string">"Customer"</span>,</span><br><span class="line">  <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">    name: &#123;</span><br><span class="line">      type: <span class="built_in">String</span>,</span><br><span class="line">      required: <span class="literal">true</span>,</span><br><span class="line">      minlength: <span class="number">5</span>,</span><br><span class="line">      maxlength: <span class="number">50</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    isGold: &#123;</span><br><span class="line">      type: <span class="built_in">Boolean</span>,</span><br><span class="line">      <span class="keyword">default</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    phone: &#123;</span><br><span class="line">      type: <span class="built_in">String</span>,</span><br><span class="line">      required: <span class="literal">true</span>,</span><br><span class="line">      minlength: <span class="number">5</span>,</span><br><span class="line">      maxlength: <span class="number">50</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateCustomer</span>(<span class="params">customer</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> schema = &#123;</span><br><span class="line">    name: Joi.string().min(<span class="number">5</span>).max(<span class="number">50</span>).required(),</span><br><span class="line">    phone: Joi.string().min(<span class="number">5</span>).max(<span class="number">50</span>).required(),</span><br><span class="line">    isGold: Joi.boolean(),</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Joi.validate(customer, schema);</span><br><span class="line">&#125;</span><br><span class="line">exports.Customer = Customer;</span><br><span class="line">exports.valudate = validateCustomer;</span><br></pre></td></tr></table></figure>
<p>这样我们实现了 single responsibility principle</p>
<p>在customer model中，我们实现了对customer对象的定义和验证。也就是定义了在node中一个customer对象应该长什么样子</p>
<p>routes 中的customer.js 就是全部处理关于customer的路由逻辑</p>
<p>在最后我们导出，并在routes中接收。注意，我们这里用析构而不直接定义，是因为我们不想这样写：customer.Customer，太难看了</p>
<p>const {Customer,validate}= require(‘../model/customer’);</p>
<p>同样的我们对genre.js进行重构</p>
<h3 id="Mongoose-Validation-Recap"><a href="#Mongoose-Validation-Recap" class="headerlink" title="Mongoose Validation Recap"></a>Mongoose Validation Recap</h3><p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%803/2.png"></p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%803/2.png"></p>
<h2 id="Mongoose-Modeling-Relationships-between-Connected-Data"><a href="#Mongoose-Modeling-Relationships-between-Connected-Data" class="headerlink" title="Mongoose- Modeling Relationships between Connected Data"></a>Mongoose- Modeling Relationships between Connected Data</h2><h3 id="Modelling-Relationships"><a href="#Modelling-Relationships" class="headerlink" title="Modelling Relationships"></a>Modelling Relationships</h3><h3 id="Referencing-Documents"><a href="#Referencing-Documents" class="headerlink" title="Referencing Documents"></a>Referencing Documents</h3><h3 id="Population"><a href="#Population" class="headerlink" title="Population"></a>Population</h3><h3 id="Embedding-Documents"><a href="#Embedding-Documents" class="headerlink" title="Embedding Documents"></a>Embedding Documents</h3><h3 id="Using-an-Array-of-Sub-documents"><a href="#Using-an-Array-of-Sub-documents" class="headerlink" title="Using an Array of Sub-documents"></a>Using an Array of Sub-documents</h3><h3 id="Project-Build-the-Movies-API"><a href="#Project-Build-the-Movies-API" class="headerlink" title="Project- Build the Movies API"></a>Project- Build the Movies API</h3><h3 id="Project-Build-the-Rentals-API"><a href="#Project-Build-the-Rentals-API" class="headerlink" title="Project- Build the Rentals API"></a>Project- Build the Rentals API</h3><h3 id="Mongoose-Modelling-Relationships-between-Connected-Data-Recap"><a href="#Mongoose-Modelling-Relationships-between-Connected-Data-Recap" class="headerlink" title="Mongoose- Modelling Relationships between Connected Data Recap"></a>Mongoose- Modelling Relationships between Connected Data Recap</h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://jasonxqh.github.io/2020/06/07/Nodejs%E5%9F%BA%E7%A1%802/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason‘s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%802/" class="post-title-link" itemprop="url">Nodejs基础2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-07 20:53:41" itemprop="dateCreated datePublished" datetime="2020-06-07T20:53:41+08:00">2020-06-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-06-30 10:38:30" itemprop="dateModified" datetime="2020-06-30T10:38:30+08:00">2020-06-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/node/" itemprop="url" rel="index"><span itemprop="name">node</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Nodejs基础2"><a href="#Nodejs基础2" class="headerlink" title="Nodejs基础2"></a>Nodejs基础2</h1><p><a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础1/#more">Nodejs基础1</a></p>
<p><a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础2/#more"> Nodejs基础2</a></p>
<p><a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础3/#more">Nodejs基础3</a></p>
<p><a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础4/#more">Nodejs基础4</a></p>
<h2 id="Asynchronous-JavaScript"><a href="#Asynchronous-JavaScript" class="headerlink" title="Asynchronous JavaScript"></a>Asynchronous JavaScript</h2><h3 id="Synchronous-vs-Asynchronous-Code"><a href="#Synchronous-vs-Asynchronous-Code" class="headerlink" title="Synchronous vs Asynchronous Code"></a>Synchronous vs Asynchronous Code</h3><p>在现实中我们更多的是使用数据库而非数组。在我们讨论Node链接mongodb之前我们先要了解一下异步编程</p>
<p>首先新建一个async文件夹</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"Before"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"After"</span>);</span><br></pre></td></tr></table></figure>
<p>这是一个同步编程（阻塞机制) 的演示。在这种机制之下，第一行执行的时候，程序会暂停，第二行需要第一行结束之后才会执行</p>
<p>相反的，我们有异步编程</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"Before"</span>);</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Reading a user from a database...."</span>);</span><br><span class="line">&#125;, <span class="number">2000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"After"</span>);</span><br></pre></td></tr></table></figure>
<p>比如说这个函数，我们用setTimeout函数来模仿从数据库中读取数据需要2秒种的时间。那么这时候还是先Before再等两秒输出”Reading a user from a database….”，最后After吗？不是的，打印结果如下</p>
<p>Before<br>After<br>Reading a user from a database….</p>
<p>我们立即打印了Before和after，但是等了两秒之后才显示了读取的信息</p>
<p>这就是异步机制。异步机制不是多线程，在这个例子中只有一个线程。</p>
<p>相当于饭店中的服务员不会只服务你一个人，在厨师准备你的餐点的时候，他会取招待其他的顾客。</p>
<h3 id="Patterns-for-Dealing-with-Asynchronous-Code"><a href="#Patterns-for-Dealing-with-Asynchronous-Code" class="headerlink" title="Patterns for Dealing with Asynchronous Code"></a>Patterns for Dealing with Asynchronous Code</h3><p>当我们标记一个异步函数的时候不能这样写</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"Before"</span>);</span><br><span class="line"><span class="keyword">const</span> user = getUser(<span class="number">1</span>);</span><br><span class="line"><span class="built_in">console</span>.log(user)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"After"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Reading a user from a database...."</span>);</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="attr">id</span>: id,<span class="attr">gitHubname</span>:<span class="string">'Jason'</span>&#125;</span><br><span class="line">  &#125;, <span class="number">2000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样写 我们会得到user是undefined的</p>
<h3 id="Callbacks"><a href="#Callbacks" class="headerlink" title="Callbacks"></a>Callbacks</h3><p>我们可以给getUser传入一callback参数，它是再异步操作完毕后调用的参数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"Before"</span>);</span><br><span class="line"><span class="keyword">const</span> user = getUser(<span class="number">1</span>, <span class="function"><span class="keyword">function</span> (<span class="params">user</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"User"</span>, user);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"After"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params">id, callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Reading a user from a database...."</span>);</span><br><span class="line">    callback(&#123; <span class="attr">id</span>: id, <span class="attr">gitHubname</span>: <span class="string">"Jason"</span> &#125;);</span><br><span class="line">  &#125;, <span class="number">2000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Before<br>After<br>Reading a user from a database….<br>User { id: 1, gitHubname: ‘Jason’ }</p>
<p>当一个异步操作的结果 is ready，callback函数就会被调用并传入下面返回结果</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"Before"</span>);</span><br><span class="line"><span class="keyword">const</span> user = getUser(<span class="number">1</span>, <span class="function"><span class="keyword">function</span> (<span class="params">user</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//get the repositories;</span></span><br><span class="line">  getRepositories(user.gitHubname, (repos) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Repos"</span>, repos);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"After"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params">id, callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Reading a user from a database...."</span>);</span><br><span class="line">    callback(&#123; <span class="attr">id</span>: id, <span class="attr">gitHubname</span>: <span class="string">"Jason"</span> &#125;);</span><br><span class="line">  &#125;, <span class="number">2000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRepositories</span>(<span class="params">username, callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Calling GitHub Api..."</span>);</span><br><span class="line">    callback([<span class="string">"repo1"</span>, <span class="string">"repo2"</span>, <span class="string">"repo3"</span>]);</span><br><span class="line">  &#125;, <span class="number">2000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Before<br>After</p>
<p>//两秒之后</p>
<p>Reading a user from a database….</p>
<p>//两秒之后</p>
<p>Calling GitHub Api…<br>Repos [ ‘repo1’, ‘repo2’, ‘repo3’ ]</p>
<h3 id="Callback-Hell"><a href="#Callback-Hell" class="headerlink" title="Callback Hell"></a>Callback Hell</h3><p>我们真实的代码可能远远比这个复杂。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"Before"</span>);</span><br><span class="line"><span class="keyword">const</span> user = getUser(<span class="number">1</span>, <span class="function"><span class="keyword">function</span> (<span class="params">user</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//get the repositories;</span></span><br><span class="line">  getRepositories(user.gitHubname, (repos) =&gt; &#123;</span><br><span class="line">    getCommits(repo,(commits)=&gt;&#123;</span><br><span class="line">    	<span class="comment">//get...</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"After"</span>);</span><br></pre></td></tr></table></figure>
<p>如果所有的异步代码都这样那还得了？全是很深的嵌套解构</p>
<p>我们把它叫做回调陷阱/回调地狱</p>
<h3 id="Named-Functions-to-Rescue"><a href="#Named-Functions-to-Rescue" class="headerlink" title="Named Functions to Rescue"></a>Named Functions to Rescue</h3><p>我们用 这种方式，用引用的方式调用函数。</p>
<p>调用getRepositories ,那么就再getRespositories中调用getCommits </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"Before"</span>);</span><br><span class="line"><span class="keyword">const</span> user = getUser(<span class="number">1</span>,getRepositories);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"After"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">displayUser</span>(<span class="params">user</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(user);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRespositories</span>(<span class="params">user</span>)</span>&#123;</span><br><span class="line">    getRepositories(user.gitHubUsername,getCommits);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCommits</span>(<span class="params">repos</span>)</span>&#123;</span><br><span class="line">    getCommits(repos,displayCommits);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<h3 id="Promises"><a href="#Promises" class="headerlink" title="Promises"></a>Promises</h3><p>promise就是一个用于保存异步操作结果的容器。当一个异步操作结束后，<strong>要么保存了值</strong>，要么<strong>保存了错误信息</strong>。promise就保证给你一个异步操作的结果。这个对象有三个states</p>
<p>1.当我创建了promise对象的时候，它处于Pending阶段。</p>
<p>2.当结果准备好，promise将被履行，也就是说异步操作成功完成，这样就得到一个值。进入Fulfiled阶段</p>
<p>3.否则如果在执行异步操作的过程当中出现了问题，promise进入Reject阶段</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%802/1.png" style="zoom:80%;"></p>
<p>我们用下面这个例子来模拟异步操作成功了. resolve就代表了如果异步操作成功返回的值</p>
<p>然后p.then 就代表了成功以后进行的操作。运行以后我们看到两秒钟之后打印了Result 1</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// Kick off some async work</span></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">      resolve(<span class="number">1</span>);</span><br><span class="line">  &#125;,<span class="number">2000</span>);  </span><br><span class="line">  <span class="comment">//   reject(new Error("message"));</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">p.then(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Result"</span>, result);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>下面这个例子模仿了失败的异步操作,如果有错误，我们需要 p.catch来捕获这个错误，然后进行错误之后的动作</p>
<p>两秒之后我们得到了 Error message的打印信息</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// Kick off some async work</span></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// resolve(1);</span></span><br><span class="line">   reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"message"</span>));</span><br><span class="line">  &#125;, <span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">p.then(<span class="function">(<span class="params">result</span>) =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"Result"</span>, result))</span><br><span class="line"> .catch(<span class="function">(<span class="params">err</span>) =&gt;</span><span class="built_in">console</span>.log(<span class="string">"Error"</span>, err.message));</span><br></pre></td></tr></table></figure>
<h3 id="Replacing-Callbacks-with-Promises"><a href="#Replacing-Callbacks-with-Promises" class="headerlink" title="Replacing Callbacks with Promises"></a>Replacing Callbacks with Promises</h3><p>现在我们用promise来取代callbacks</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Reading a user from a database...."</span>);</span><br><span class="line">      resolve(&#123; <span class="attr">id</span>: id, <span class="attr">gitHubname</span>: <span class="string">"Jason"</span> &#125;);</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRepositories</span>(<span class="params">username</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Calling GitHub Api..."</span>);</span><br><span class="line">      resolve([<span class="string">"repo1"</span>, <span class="string">"repo2"</span>, <span class="string">"repo3"</span>]);</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCommits</span>(<span class="params">repo</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Calling GitHub Api..."</span>);</span><br><span class="line">      resolve([<span class="string">"commit"</span>]);</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Consuming-Promises"><a href="#Consuming-Promises" class="headerlink" title="Consuming Promises"></a>Consuming Promises</h3><p>我们可以链式处理复杂的异步请求，也就是完成了第一步，then第二步，then第三步</p>
<p>但是不论何时使用Promise都需要我们捕捉错误</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'Before'</span>);</span><br><span class="line">getUser(<span class="number">1</span>)</span><br><span class="line">	.then(<span class="function"><span class="params">user</span>=&gt;</span>getRespositories(user.getHubUsername))</span><br><span class="line">	.then(<span class="function"><span class="params">repos</span>=&gt;</span>getCommits(repos[<span class="number">0</span>]))</span><br><span class="line">	.then(<span class="function"><span class="params">commits</span>=&gt;</span><span class="built_in">console</span>.log(<span class="string">'Commits'</span>),commits)</span><br><span class="line">	.catch(<span class="function"><span class="params">err</span>=&gt;</span><span class="built_in">console</span>.log(<span class="string">'Error'</span>),err.message);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Reading a user from a database...."</span>);</span><br><span class="line">      resolve(&#123; <span class="attr">id</span>: id, <span class="attr">gitHubname</span>: <span class="string">"Jason"</span> &#125;);</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRepositories</span>(<span class="params">username</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Calling GitHub Api..."</span>);</span><br><span class="line">      resolve([<span class="string">"repo1"</span>, <span class="string">"repo2"</span>, <span class="string">"repo3"</span>]);</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCommits</span>(<span class="params">repo</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Calling GitHub Api..."</span>);</span><br><span class="line">      resolve([<span class="string">"commit"</span>]);</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Creating-Settled-Promises"><a href="#Creating-Settled-Promises" class="headerlink" title="Creating Settled Promises"></a>Creating Settled Promises</h3><p>有时候需要创建一个already resolved 的 promise 这在单元测试中比较常见</p>
<p>现在我们模仿一个请求服务器的异步请求成功完成，在单元测试中我们需要创建一个已经实现的Promise</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="built_in">Promise</span>.resolve(&#123;<span class="attr">id</span>:<span class="number">1</span>&#125;);</span><br><span class="line">p.then(<span class="function"><span class="params">result</span>=&gt;</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>有时候我们需要创建一个 already  reject的promise，那么我们需要返回一个Error对象，因为里面包含了堆栈错误信息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="built_in">Promise</span>.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'reason for rejection...'</span>));</span><br><span class="line">p.catch(<span class="function"><span class="params">error</span>=&gt;</span><span class="built_in">console</span>.log(error))</span><br></pre></td></tr></table></figure>
<h3 id="Running-Promises-in-Parallel"><a href="#Running-Promises-in-Parallel" class="headerlink" title="Running Promises in Parallel"></a>Running Promises in Parallel</h3><h4 id="all"><a href="#all" class="headerlink" title="all"></a>all</h4><p>我这里有俩Promise对象，现在我想同时操作这两个Promises，当他们都做完了以后我们再去做我们想要的东西。所以我们调用Promise.all传入一个Promise数组。这里将返回一个新的Promise，他将在所有Promise对象全部resolve了以后才resolve</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p1 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Async operation 1.."</span>);</span><br><span class="line">    resolve(<span class="number">1</span>);</span><br><span class="line">  &#125;, <span class="number">2000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> p2 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Async operation 2.."</span>);</span><br><span class="line">    resolve(<span class="number">2</span>);</span><br><span class="line">  &#125;, <span class="number">2000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">Promise</span>.all([p1,p2]).then(<span class="function">(<span class="params">result</span>) =&gt;</span> <span class="built_in">console</span>.log(result));</span><br><span class="line">.catch(<span class="function"><span class="params">err</span>=&gt;</span><span class="built_in">console</span>.log(err.message));</span><br></pre></td></tr></table></figure>
<p>Async operation 1..<br>Async operation 2..<br>[ 1, 2 ]</p>
<p>2s之后打印出这样的信息</p>
<p>注意，这个不是并发操作，这仍然是单线程，单线程几乎是同时进行两个 异步操作的。但这并不是真的同时。</p>
<p>当我们其中一个异步操作产生结果的时候，会把resolve的值存放在数组当中</p>
<p>注意，我们这里没有些error，但是如果Promise.all捕捉到了一个error的话（只要其中一个Promise出错了），全部Promise就没有最终返回值了</p>
<h4 id="race"><a href="#race" class="headerlink" title="race"></a>race</h4><p>但是有时候,我们并不想让这些Promises全部都满足才进行下一步操作，我们可以让一个promise完成后就进行下一步操作。这时候我们需要用到race</p>
<p>这时候 Promise数组中的一个promise is resolved 整个Promise.race就被认为是resolved 了.这时候，返回的结果不再是一个数组了，而是最快实现Promise的旅行值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.race([p1,p2]).then(<span class="function">(<span class="params">result</span>) =&gt;</span> <span class="built_in">console</span>.log(result));</span><br><span class="line">.catch(<span class="function"><span class="params">err</span>=&gt;</span><span class="built_in">console</span>.log(err.message));</span><br></pre></td></tr></table></figure>
<h3 id="Async-and-Await"><a href="#Async-and-Await" class="headerlink" title="Async and Await"></a>Async and Await</h3><p>之前我们学习了用callback函数来处理异步请求。然后用Promise来重写了。但是我们可以用js的新特性。</p>
<p>async和await.它可以让我们像写同步操作一样写异步操作</p>
<p>但是我们还是需要有一个捕获错误的功能，这时候就需要 try和catch了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"Before"</span>);</span><br><span class="line"><span class="comment">// getUser(1)</span></span><br><span class="line"><span class="comment">// 	.then(user=&gt;getRespositories(user.getHubUsername))</span></span><br><span class="line"><span class="comment">// 	.then(repos=&gt;getCommits(repos[0]))</span></span><br><span class="line"><span class="comment">// 	.then(commits=&gt;console.log('Commits'),commits)</span></span><br><span class="line"><span class="comment">// 	.catch(err=&gt;console.log('Error'),err.message);</span></span><br><span class="line"><span class="comment">//上面和下面两段代码表达的意思是一样的，但是风格不一样。</span></span><br><span class="line"><span class="comment">//下面的代码虽然写的像同步代码</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">displayCommits</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> getUser(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">const</span> repos = <span class="keyword">await</span> getRepositories(user.gitHubname);</span><br><span class="line">    <span class="keyword">const</span> commits = <span class="keyword">await</span> getCommits(repos[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">console</span>.log(commits);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Error"</span>, err.message);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">displayCommits();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"after"</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Reading a user from a database...."</span>);</span><br><span class="line">      resolve(&#123; <span class="attr">id</span>: id, <span class="attr">gitHubname</span>: <span class="string">"Jason"</span> &#125;);</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRepositories</span>(<span class="params">username</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Calling GitHub Api..."</span>);</span><br><span class="line">      resolve([<span class="string">"repo1"</span>, <span class="string">"repo2"</span>, <span class="string">"repo3"</span>]);</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCommits</span>(<span class="params">repo</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Calling GitHub Api..."</span>);</span><br><span class="line">      resolve([<span class="string">"commit"</span>]);</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Before<br>after<br>Reading a user from a database….<br>Calling GitHub Api…<br>Calling GitHub Api…<br>[ ‘commit’ ]</p>
<h3 id="Exercise"><a href="#Exercise" class="headerlink" title="Exercise"></a>Exercise</h3><p>用async和await改造这段代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">getCustomer(<span class="number">1</span>, (customer) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Customer: '</span>, customer);</span><br><span class="line">  <span class="keyword">if</span> (customer.isGold) &#123;</span><br><span class="line">    getTopMovies(<span class="function">(<span class="params">movies</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Top movies: '</span>, movies);</span><br><span class="line">      sendEmail(customer.email, movies, () =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Email sent...'</span>)</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCustomer</span>(<span class="params">id, callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    callback(&#123; </span><br><span class="line">      id: <span class="number">1</span>, </span><br><span class="line">      name: <span class="string">'Mosh Hamedani'</span>, </span><br><span class="line">      isGold: <span class="literal">true</span>, </span><br><span class="line">      email: <span class="string">'email'</span> </span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;, <span class="number">4000</span>);  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTopMovies</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    callback([<span class="string">'movie1'</span>, <span class="string">'movie2'</span>]);</span><br><span class="line">  &#125;, <span class="number">4000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendEmail</span>(<span class="params">email, movies, callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    callback();</span><br><span class="line">  &#125;, <span class="number">4000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>答：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">notifyCustomer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> customer = <span class="keyword">await</span> getCustomer(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Customer"</span>, customer);</span><br><span class="line">    <span class="keyword">if</span> (customer.isGold) &#123;</span><br><span class="line">      <span class="keyword">const</span> movies = getTopMovies();</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Top movies:"</span>, movies);</span><br><span class="line">      sendEmail(customer.email, movies);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Email sent..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">notifyCustomer();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCustomer</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      resolve(&#123;</span><br><span class="line">        id: <span class="number">1</span>,</span><br><span class="line">        name: <span class="string">"Mosh Hamedani"</span>,</span><br><span class="line">        isGold: <span class="literal">true</span>,</span><br><span class="line">        email: <span class="string">"email"</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;, <span class="number">4000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTopMovies</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      resolve([<span class="string">"movie1"</span>, <span class="string">"movie2"</span>]);</span><br><span class="line">    &#125;, <span class="number">4000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendEmail</span>(<span class="params">email, movies</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      resolve();</span><br><span class="line">    &#125;, <span class="number">4000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Customer { id: 1, name: &#39;Mosh Hamedani&#39;, isGold: true, email: &#39;email&#39; }</code><br><code>Top movies: Promise { &lt;pending&gt; }</code><br><code>Email sent...</code></p>
<h2 id="CRUD-Operations-Using-Mongoose"><a href="#CRUD-Operations-Using-Mongoose" class="headerlink" title="CRUD Operations Using Mongoose"></a>CRUD Operations Using Mongoose</h2><p>express 可以使用很多的数据库，这里我们用MongoDB。而且在node和express中经常使用</p>
<h3 id="Connecting-to-MongoDB"><a href="#Connecting-to-MongoDB" class="headerlink" title="Connecting to MongoDB"></a>Connecting to MongoDB</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">"mongoose"</span>);</span><br><span class="line">mongoose</span><br><span class="line">  .connect(<span class="string">"mongodb://localhost/playground"</span>)</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"Connected to MongoDB"</span>))</span><br><span class="line">  .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"Could not connect to MongoDB..."</span>));</span><br></pre></td></tr></table></figure>
<p>Connected to MongoDB</p>
<h3 id="Schemas"><a href="#Schemas" class="headerlink" title="Schemas"></a>Schemas</h3><p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%802/2.png" style="zoom:80%;"></p>
<p>这里 collection就是一张表，document就是列。信息是由键值对保存的</p>
<p>我们用schema来设计符合MongoDB集合的文档结构</p>
<p>我们新建张表格，在创建的时候我们创建一个对象，然后传入我们需要传入文档的键值对</p>
<p>这里又name：string类型，auther:string类型 ,tags:string 类型的数组(保存后是一个键值对数组 0:basic,1:advanced)之类的，date：一个对象，对象类型是日期，默认值是当前日期。 isPublished：布尔类型</p>
<p>Schema Types: String,Number,Date,Buffer(字节格式的数据),Boolean,ObjectID,Array</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">"mongoose"</span>);</span><br><span class="line">mongoose</span><br><span class="line">  .connect(<span class="string">"mongodb://localhost/playground"</span>)</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"Connected to MongoDB"</span>))</span><br><span class="line">  .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"Could not connect to MongoDB..."</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> courseSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">  name: <span class="built_in">String</span>,</span><br><span class="line">  auther: <span class="built_in">String</span>,</span><br><span class="line">  tags: [<span class="built_in">String</span>],</span><br><span class="line">  date: &#123; <span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">default</span>: <span class="built_in">Date</span>.now &#125;,</span><br><span class="line">  isPublish:<span class="built_in">Boolean</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Models"><a href="#Models" class="headerlink" title="Models"></a>Models</h3><p>我们用courseSchema来定义数据库中course的文档结构，现在我们要把它弄成一个Model(模型)</p>
<p>在这里我们有一个Course，我们就可以创建一个类对象nodeCourse,然后我们就可以把nodeCourse保存到数据库当中。为了创建一个Course，我们可以把courseSchema变成Model</p>
<p>mongoose.model有两个参数，第一个参数是目标集合（单数）名称，也就是数据库中的collection集合；第二个参数是这个集合所需要的schema结构。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">"mongoose"</span>);</span><br><span class="line">mongoose</span><br><span class="line">  .connect(<span class="string">"mongodb://localhost/playground"</span>)</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"Connected to MongoDB"</span>))</span><br><span class="line">  .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"Could not connect to MongoDB..."</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> courseSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">  name: <span class="built_in">String</span>,</span><br><span class="line">  auther: <span class="built_in">String</span>,</span><br><span class="line">  tags: [<span class="built_in">String</span>],</span><br><span class="line">  date: &#123; <span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">default</span>: <span class="built_in">Date</span>.now &#125;,</span><br><span class="line">  isPublish:<span class="built_in">Boolean</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> Course = mongoose.model(<span class="string">'Course'</span>,courseSchema);<span class="comment">//类</span></span><br><span class="line"><span class="comment">//新建一个对象</span></span><br><span class="line"><span class="keyword">const</span> course = <span class="keyword">new</span> Course(&#123;</span><br><span class="line">	name: <span class="string">'Node.js Course'</span>,</span><br><span class="line">	author:<span class="string">'Mosh'</span>,</span><br><span class="line">	tags:[<span class="string">'node'</span>,<span class="string">'backend'</span>]	,</span><br><span class="line">	<span class="comment">//date是有默认值的</span></span><br><span class="line">	isPublished: <span class="literal">true</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="Saving-a-Document"><a href="#Saving-a-Document" class="headerlink" title="Saving a Document"></a>Saving a Document</h3><p>保存到数据库是一个异步操作。因为保存到数据库得花点时间。因为我们要访问文件系统。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">"mongoose"</span>);</span><br><span class="line">mongoose</span><br><span class="line">  .connect(<span class="string">"mongodb://localhost/playground"</span>)</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"Connected to MongoDB"</span>))</span><br><span class="line">  .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"Could not connect to MongoDB..."</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> courseSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">  name: <span class="built_in">String</span>,</span><br><span class="line">  auther: <span class="built_in">String</span>,</span><br><span class="line">  tags: [<span class="built_in">String</span>],</span><br><span class="line">  date: &#123; <span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">default</span>: <span class="built_in">Date</span>.now &#125;,</span><br><span class="line">  isPublish: <span class="built_in">Boolean</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> Course = mongoose.model(<span class="string">"Course"</span>, courseSchema);</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">createCourse</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="comment">//我们新建一个对象，然后利用model.save方法来把他保存到数据库当中。这个方法返回一个对象。我们打印</span></span><br><span class="line">  <span class="keyword">const</span> course = <span class="keyword">new</span> Course(&#123;</span><br><span class="line">    name: <span class="string">"Node.js Course"</span>,</span><br><span class="line">    author: <span class="string">"Mosh"</span>,</span><br><span class="line">    tags: [<span class="string">"node"</span>, <span class="string">"backend"</span>],</span><br><span class="line">    <span class="comment">//date是有默认值的</span></span><br><span class="line">    isPublished: <span class="literal">true</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> course.save();</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;</span><br><span class="line">createCourse();</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%802/3.png" style="zoom:80%;"></p>
<p>不像关系型数据库，我们不用创建表格，设计表格我们只要创建文档然后存进去就可以了。</p>
<p>现在我们多建几个信息</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%802/4.png" style="zoom:80%;"></p>
<h3 id="Querying-Documents"><a href="#Querying-Documents" class="headerlink" title="Querying Documents"></a>Querying Documents</h3><p>现在我们来查询信息：</p>
<p><code>model.find()</code>我可以得到一个文档的列表</p>
<p><code>model.findById()</code>根据id找</p>
<p><code>model.findOne()</code>返回一个单一的文档</p>
<p>我们也可以 <code>model.find().then()</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourses</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> courses = <span class="keyword">await</span> Course.find();</span><br><span class="line">  <span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line">getCourses();</span><br></pre></td></tr></table></figure>
<p>这样我们就得到了两门课程</p>
<p>我们也可以加上一个过滤器，比如我们可以这样</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourses</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> courses = <span class="keyword">await</span> Course.find(&#123;<span class="attr">author</span>:<span class="string">'Mosh'</span>,<span class="attr">isPublished</span>:<span class="literal">true</span>&#125;);</span><br><span class="line">  <span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line">getCourses();</span><br></pre></td></tr></table></figure>
<p>我们也可以</p>
<p>显示信息的数目，在括号中的数值</p>
<p>对数据进行排序，传入一个对象，里面的键值对用来进行排序。升序写1，降序写-1</p>
<p>对返回的列进行选择，传入一个对象 ，想得到name和tags 那么就写1，代表选中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourses</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> courses = <span class="keyword">await</span> Course.find(&#123; <span class="attr">author</span>: <span class="string">"Mosh"</span>&#125;)</span><br><span class="line">    .limit(<span class="number">10</span>)</span><br><span class="line">    .sort(&#123; <span class="attr">name</span>: <span class="number">1</span> &#125;)</span><br><span class="line">    .select(&#123; <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">tags</span>: <span class="number">1</span> &#125;);</span><br><span class="line">  <span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line">getCourses();</span><br></pre></td></tr></table></figure>
<h3 id="Comparison-Query-Operators比较操作符"><a href="#Comparison-Query-Operators比较操作符" class="headerlink" title="Comparison Query Operators比较操作符"></a>Comparison Query Operators比较操作符</h3><p>在mongo中我们有很多操作符用来做值得比较。这些mongodb使用的操作符在mongoose中同样有效。</p>
<p><code>eq (equal)</code></p>
<p><code>ne (not equal)</code></p>
<p><code>gt(greater than)</code></p>
<p><code>gte (greter than or equal to)</code></p>
<p><code>lt (less than)</code></p>
<p><code>lte (less than or equal to )</code></p>
<p><code>in</code></p>
<p><code>nin (not in )</code></p>
<p>比如我们想找出价格大于10dollar的课程</p>
<p>在<a href="https://jasonxqh.github.io/2020/05/16/Mysql基础/">Mysql基础</a>当中，我们知道了可以直接用大于小于符号来选择，如果是in的话可以这样写IN (‘VA’,’FL’,’GA’)</p>
<p>我们怎么在json对象中描述呢？</p>
<p>我们用一个对象来代替数字，对象中是一个键值对$ 代表这是一个运算符，我们用gt来表示greater than 冒号后面的是数字。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const courses &#x3D; await Course</span><br><span class="line">	.find(&#123; price:&#123;$gt : 10&#125; &#125;)</span><br><span class="line"> console.log(courses);</span><br></pre></td></tr></table></figure>
<p>那么我们如果想找出大于10 小于20 的课程呢？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> courses = <span class="keyword">await</span> Course</span><br><span class="line">	.find(&#123; <span class="attr">price</span>:&#123;<span class="attr">$gt</span> : <span class="number">10</span>,<span class="attr">$lte</span>:<span class="number">20</span> &#125; &#125;)</span><br><span class="line"> <span class="built_in">console</span>.log(courses);</span><br></pre></td></tr></table></figure>
<p>那么我如果想找10，15 或者20 dollar的课程呢? 我们利用数组</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> courses = <span class="keyword">await</span> Course</span><br><span class="line">	.find(&#123; <span class="attr">price</span>:&#123;<span class="attr">$in</span>:[<span class="number">10</span>,<span class="number">15</span>,<span class="number">20</span>] &#125; &#125;)</span><br><span class="line"> <span class="built_in">console</span>.log(courses);</span><br></pre></td></tr></table></figure>
<h3 id="Logical-Query-Operators逻辑运算符"><a href="#Logical-Query-Operators逻辑运算符" class="headerlink" title="Logical Query Operators逻辑运算符"></a>Logical Query Operators逻辑运算符</h3><p><code>Course.find({author:&#39;Mosh&#39;,isPublished:true});</code> 表示的是and，如果我们想要表示or 有应该怎么写呢？ </p>
<p>我们可以先find()也就是全部找到</p>
<p>然后用.and 和 .or 来表达内部的逻辑是and还是or,传入的参数是一个对象数组，里面存放我们需要查找的对象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> courses = <span class="keyword">await</span> Course</span><br><span class="line">	.find()</span><br><span class="line">	.or([&#123;<span class="attr">author</span>:<span class="string">'Mosh'</span>&#125;,&#123;<span class="attr">isPublished</span>:<span class="literal">true</span>&#125;])</span><br><span class="line">	.and([])</span><br></pre></td></tr></table></figure>
<h3 id="Regular-Expressions"><a href="#Regular-Expressions" class="headerlink" title="Regular Expressions"></a>Regular Expressions</h3><p>到现在为止我们得到的都是确定的字符串，但是我们想模糊查询，怎么办呢？</p>
<p>比如我想得到<strong>以Mosh开头</strong>的课程，我们可以这样写</p>
<p>\^ 是表示开头， $表示结尾 。如果<strong>不区分大小写 </strong></p>
<p><strong>/i (忽略大小写)<br>/g (全文查找出现的所有匹配字符)<br>/m (多行查找)<br>/gi(全文查找、忽略大小写)<br>/ig(全文查找、忽略大小写)</strong></p>
<p>如果我们只是想找出包含mosh的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> courses = <span class="keyword">await</span> Course</span><br><span class="line">	.find(&#123;<span class="attr">author</span>: <span class="regexp">/^Mosh/</span> &#125;);</span><br><span class="line">	.find(&#123;<span class="attr">author</span>:<span class="regexp">/Hamedani$/i</span>&#125;)</span><br><span class="line">	.find(&#123;<span class="attr">author</span>:<span class="regexp">/.*Mosh.*/i</span>&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="Counting"><a href="#Counting" class="headerlink" title="Counting"></a>Counting</h3><p>我们如果比较关心数量而不是对象本身，我们可以这样写</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> courses = <span class="keyword">await</span> Course</span><br><span class="line">	.find()</span><br><span class="line">	.count()</span><br></pre></td></tr></table></figure>
<h3 id="Pagination"><a href="#Pagination" class="headerlink" title="Pagination"></a>Pagination</h3><p>与limit方法如影随形的是skip方法，常常用在分页器当中使用</p>
<p>为了实现分页，我们需要调过前面一页的所有文档。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourses</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> pageNumber = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">const</span> pageSize = <span class="number">10</span>;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    在这里硬编码纯粹是为了简化，在现实中我们通过RESTful API 的查询字符串来输入这两个值</span></span><br><span class="line"><span class="comment">    如果我们有一个获取课程列表的API</span></span><br><span class="line"><span class="comment">    /api/course？pageNumber=2&amp;pageSize=10</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> courses = <span class="keyword">await</span> Course</span><br><span class="line">    	.find(&#123;<span class="attr">auther</span>:<span class="string">"MOsh"</span>&#125;)</span><br><span class="line">    	.skip((pageNumber<span class="number">-1</span>)*pageSize)</span><br><span class="line">    	.limit(<span class="number">10</span>);</span><br><span class="line">    	.sort(&#123;<span class="attr">name</span>:<span class="number">1</span>&#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-1"><a href="#Exercise-1" class="headerlink" title="Exercise 1"></a>Exercise 1</h3><p>导入数据后。我们要达到这个目标</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%802/5.png" style="zoom:80%;"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"></span><br><span class="line">mongoose.connect(<span class="string">'mongodb://localhost/mongo-exercises'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> courseSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">  name: <span class="built_in">String</span>,</span><br><span class="line">  author: <span class="built_in">String</span>, </span><br><span class="line">  tags: [ <span class="built_in">String</span> ],</span><br><span class="line">  date: <span class="built_in">Date</span>, </span><br><span class="line">  isPublished: <span class="built_in">Boolean</span>,</span><br><span class="line">  price: <span class="built_in">Number</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Course = mongoose.model(<span class="string">'Course'</span>, courseSchema);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourses</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> Course</span><br><span class="line">  .find(&#123; <span class="attr">isPublished</span>: <span class="literal">true</span>, <span class="attr">tags</span>: <span class="string">'backend'</span> &#125;)</span><br><span class="line">  .sort(&#123; <span class="attr">name</span>: <span class="number">1</span> &#125;)</span><br><span class="line">  .select(&#123; <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">author</span>: <span class="number">1</span> &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> courses = <span class="keyword">await</span> getCourses();</span><br><span class="line">  <span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run();</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-2"><a href="#Exercise-2" class="headerlink" title="Exercise 2"></a>Exercise 2</h3><p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%802/6.png" style="zoom:80%;"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"></span><br><span class="line">mongoose.connect(<span class="string">'mongodb://localhost/mongo-exercises'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> courseSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">  name: <span class="built_in">String</span>,</span><br><span class="line">  author: <span class="built_in">String</span>, </span><br><span class="line">  tags: [ <span class="built_in">String</span> ],</span><br><span class="line">  date: <span class="built_in">Date</span>, </span><br><span class="line">  isPublished: <span class="built_in">Boolean</span>,</span><br><span class="line">  price: <span class="built_in">Number</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Course = mongoose.model(<span class="string">'Course'</span>, courseSchema);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourses</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> Course</span><br><span class="line">  .find(&#123; <span class="attr">isPublished</span>: <span class="literal">true</span>&#125;,&#123;<span class="attr">tags</span>:&#123;<span class="attr">$in</span>:[<span class="string">'frontend'</span>,<span class="string">'backend'</span>]&#125;&#125;)</span><br><span class="line">  .sort(<span class="string">'-price'</span>)<span class="comment">//不传入一个对象，我们也可以用字符串来代替</span></span><br><span class="line">  .select(<span class="string">'name author'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//或者用or .or([&#123;tags:'frontend'&#125;,&#123;tags:'backend'&#125;]) 效果是一样的</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> courses = <span class="keyword">await</span> getCourses();</span><br><span class="line">  <span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run();</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3"><a href="#Exercise-3" class="headerlink" title="Exercise 3"></a>Exercise 3</h3><p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%802/7.png" style="zoom:80%;"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"></span><br><span class="line">mongoose.connect(<span class="string">'mongodb://localhost/mongo-exercises'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> courseSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">  name: <span class="built_in">String</span>,</span><br><span class="line">  author: <span class="built_in">String</span>, </span><br><span class="line">  tags: [ <span class="built_in">String</span> ],</span><br><span class="line">  date: <span class="built_in">Date</span>, </span><br><span class="line">  isPublished: <span class="built_in">Boolean</span>,</span><br><span class="line">  price: <span class="built_in">Number</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Course = mongoose.model(<span class="string">'Course'</span>, courseSchema);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourses</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> Course</span><br><span class="line">  .find()</span><br><span class="line">  .or([</span><br><span class="line">      &#123;<span class="attr">author</span>:<span class="regexp">/.*by.*/i</span>&#125;,</span><br><span class="line">      &#123;<span class="attr">price</span>:&#123;<span class="attr">$gte</span>:<span class="number">15</span>&#125;&#125;</span><br><span class="line">  ])</span><br><span class="line">  .select(<span class="string">'name author'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//或者用or .or([&#123;tags:'frontend'&#125;,&#123;tags:'backend'&#125;]) 效果是一样的</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> courses = <span class="keyword">await</span> getCourses();</span><br><span class="line">  <span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run();</span><br></pre></td></tr></table></figure>
<h3 id="Updating-a-Document-Query-First"><a href="#Updating-a-Document-Query-First" class="headerlink" title="Updating a Document- Query First"></a>Updating a Document- Query First</h3><p>比如我有个ispublished=true的话，author不允许被修改的规则，那么我们可以这样修改<code>if(course.isPublished) return ;</code></p>
<p>如何来更新数据库文档?</p>
<p>先来介绍 Query First 也就是先查询再更新</p>
<p><code>Approach:Update first</code></p>
<p><code>findById</code></p>
<p><code>Modify its properties</code></p>
<p><code>save()</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">updateCourse</span>(<span class="params">id</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">const</span> course=<span class="keyword">await</span> Course.findById(id);</span><br><span class="line">	<span class="keyword">if</span>(!course) <span class="keyword">return</span> ;</span><br><span class="line">	course.isPublished = <span class="literal">true</span>;</span><br><span class="line">	course.auther = <span class="string">'Another Author'</span></span><br><span class="line">	<span class="keyword">const</span> result = <span class="keyword">await</span> course.save();</span><br><span class="line">	<span class="built_in">console</span>.log(result)</span><br><span class="line">&#125;</span><br><span class="line">updateCourse(<span class="string">'5a68fdd7bee8ea64649c2777'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Updating-a-Document-Update-First"><a href="#Updating-a-Document-Update-First" class="headerlink" title="Updating a Document- Update First"></a>Updating a Document- Update First</h3><p>我们也可以直接接入数据库修改文档</p>
<p><code>Approach:Update first</code></p>
<p><code>Update directly</code></p>
<p><code>Optionally: get the updated document</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">updateCourse</span>(<span class="params">id</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//update()的第一个参数是一个filter，可以一次更新很多文档！</span></span><br><span class="line">	<span class="keyword">const</span> result=<span class="keyword">await</span> Course.update(&#123;<span class="attr">_id</span>:id&#125;,&#123;</span><br><span class="line"><span class="comment">//这是实现更新操作的结果而非复合的文档,也就是说我们把满足条件的信息都进行修改</span></span><br><span class="line">	 $<span class="keyword">set</span>:&#123;</span><br><span class="line">	 	author: <span class="string">'Mosh'</span>,</span><br><span class="line">	 	isPublished:<span class="literal">false</span></span><br><span class="line">	 &#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	<span class="built_in">console</span>.log(result)</span><br><span class="line">&#125;</span><br><span class="line">updateCourse(<span class="string">'5a68fdd7bee8ea64649c2777'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Removing-Documents"><a href="#Removing-Documents" class="headerlink" title="Removing Documents"></a>Removing Documents</h3><p>怎么删除文档呢？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">removeCourse</span>(<span class="params">id</span>)</span>&#123;</span><br><span class="line"><span class="comment">//deleteOne()是删除一条信息，参数是一个过滤器,他将找到第一个符合对象的并且删除</span></span><br><span class="line">	<span class="keyword">const</span> result = <span class="keyword">await</span> Course.deleteOne(&#123;<span class="attr">_id</span>:id&#125;)</span><br><span class="line"><span class="comment">//deleteMany()删除符合条件的所有信息</span></span><br><span class="line">	<span class="keyword">const</span> result = <span class="keyword">await</span> Course.deleteMany(&#123;<span class="attr">_id</span>:id&#125;)</span><br><span class="line"><span class="comment">//如果我想得到被删除的文档，我可以使用findByIdAndRemove方法,如果给定的id不存在，就会返回null</span></span><br><span class="line">	<span class="keyword">const</span> course = <span class="keyword">await</span> Course.findByIdAndRemove(&#123;<span class="attr">_id</span>:id&#125;)</span><br><span class="line">	<span class="built_in">console</span>.log(course);</span><br><span class="line">&#125;</span><br><span class="line">removeCourse(<span class="string">'5a68fdd7bee8ea64649c2777'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="CRUD-Operations-with-Mongoose-and-MongoDB-Recap"><a href="#CRUD-Operations-with-Mongoose-and-MongoDB-Recap" class="headerlink" title="CRUD Operations with Mongoose and MongoDB Recap"></a>CRUD Operations with Mongoose and MongoDB Recap</h3><p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%802/8.png"></p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%802/9.png"></p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%802/10.png"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://jasonxqh.github.io/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason‘s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/" class="post-title-link" itemprop="url">Nodejs基础1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-07 20:53:15" itemprop="dateCreated datePublished" datetime="2020-06-07T20:53:15+08:00">2020-06-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-06-30 10:38:26" itemprop="dateModified" datetime="2020-06-30T10:38:26+08:00">2020-06-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/node/" itemprop="url" rel="index"><span itemprop="name">node</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Nodejs基础1"><a href="#Nodejs基础1" class="headerlink" title="Nodejs基础1"></a>Nodejs基础1</h1><p>在 <a href="https://jasonxqh.github.io/2020/06/02/react基础2/">react基础2</a>  <a href="https://jasonxqh.github.io/2020/06/04/react基础3/">react基础3表单与后端</a>  <a href="https://jasonxqh.github.io/2020/06/05/react基础4授权与部署/">react基础4授权与部署</a></p>
<p>这三篇博客中，我们讨论了vidly(一个电影展示项目)的客户端，但是我们在博客中仅仅调用了后端的api，对后端如何构建并没有提及。而Nodejs构造的后端是期末大作业中必不可少的一部分，所以这个系列让我们来谈谈如何用Nodejs+express+mongodb来构建一个vidly后端。</p>
<h2 id="Building-RESTful-API’s-Using-Express"><a href="#Building-RESTful-API’s-Using-Express" class="headerlink" title="Building RESTful API’s Using Express"></a>Building RESTful API’s Using Express</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>下面利用express框架搭建后端</p>
<h3 id="RESTful-Services"><a href="#RESTful-Services" class="headerlink" title="RESTful Services"></a>RESTful Services</h3><p>大多数的网站结构如下：</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/1.png" style="zoom:80%;"></p>
<p>RESTful 就是 Representational State Transfer 的缩写，是用来创建这些规范的HTTP服务的。我们利用简单的Http语言来进行增删改查，也就是CRUD operations</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/2.png" style="zoom:80%;"></p>
<p>大多数的网站url如下</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/3.png" style="zoom:80%;"></p>
<p>我们常常在.com后看到/api，这不是必要的规定，但是可以见到很多公司都遵循这个范式。customer代表了应用中用户的集合。在RESTful中我们把它看成是一种资源。我们可以把诸如用户，电影，租金或者各种资源都开放出去。所以可以是/rentals，/movies 不同的后缀代表操纵不同的用户资源。这个/customer可以对用户资源进行操作比如说创建用户，更新用户信息。</p>
<p>所有的HTTP请求都有所谓的动作或者方法，取决于他们的类型和目的</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/4.png" style="zoom:80%;"></p>
<p>每个动作的模型如下</p>
<p>GET：获取到所有的用户的信息，返回一个列表。如果想单独得到一个用户的信息，需要这么写</p>
<p>/api/customers/1,这样就只返回一个用户的信息</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/5.png" style="zoom: 67%;"></p>
<p>PUT：用户更新</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/6.png" style="zoom: 67%;"></p>
<p>DELETE：删除操作</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/7.png" style="zoom: 67%;"></p>
<p>POST：新建操作</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/8.png" style="zoom: 67%;"></p>
<p>接下来我们把关注点集中在创建http服务上面。因此不适用数据库，就使用简单的数组在内存中保存数据</p>
<h3 id="Introducing-Express"><a href="#Introducing-Express" class="headerlink" title="Introducing Express"></a>Introducing Express</h3><p><a href="http://expressjs.com/en/4x/api.html" target="_blank" rel="noopener">express官方文档</a></p>
<p>express可以更方便的帮助我们管理路由</p>
<p>Express框架可以在良好维护性的前提下创建很多路由规则</p>
<p>新建一个express-demo文件夹，npm init —yes 新建package-json</p>
<p>npm install express</p>
<h3 id="Building-Your-First-Web-Server"><a href="#Building-Your-First-Web-Server" class="headerlink" title="Building Your First Web Server"></a>Building Your First Web Server</h3><p>这里说一嘴 require和import的区别</p>
<p><strong>import和require都是被模块化使用</strong></p>
<ol>
<li><p><strong>a.</strong>  require是CommonJs的语法（AMD规范引入方式），CommonJs的模块是对象。<br> <strong>b.</strong>  import是es6的一个语法标准（浏览器不支持，本质是使用node中的babel将es6转码为es5再执行，import会被转码为require），es6模块不是对象</p>
</li>
<li><p><strong>a. </strong>  require是运行时加载整个模块（即模块中所有方法），生成一个对象，再从对象上读取它的方法（只有运行时才能得到这        个对象,不能在编译时做到静态化），理论上可以用在代码的任何地方<br><strong>b.</strong> import是编译时调用，确定模块的依赖关系，输入变量（es6模块不是对象，而是通过export命令指定输出代码，再通过         import输入，只加载import中导的方法，其他方法不加载），import具有提升效果，会提升到模块的头部（编译时执行）<br> export和import可以位于模块中的任何位置，但是必须是在模块顶层，如果在其他作用域内，会报错<br> es6这样的设计可以提高编译器效率，但没法实现运行时加载</p>
</li>
<li><p><strong>a.  </strong>require是赋值过程，把require的结果（对象，数字，函数等），默认是export的一个对象，赋给某个变量（复制或浅拷贝）<br><strong>b. </strong> import是解构过程（需要谁，加载谁）</p>
</li>
</ol>
<p><a href="https://www.cnblogs.com/suneil/p/11289884.html" target="_blank" rel="noopener">引用于此</a></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//我们首先引入express</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="comment">//然后为了方便我们保存在app中，这个app就代表了我们的应用</span></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">1.我们现在只用app.get() 这需要两个参数，第一个参数是路径，也就是URL;第二个参数是一个回调函数</span></span><br><span class="line"><span class="comment">2.回调函数在给定端口使用get方法时被调用。回调函数有两个函数，request和response，用req，res代替</span></span><br><span class="line"><span class="comment">3.然后是函数体的代码块。request参数给了我们很多请求的属性，可以参考exprss文档</span></span><br><span class="line"><span class="comment">4.我们这里申请了两个路由，一个返回helloworld，一个返回一个数组</span></span><br><span class="line"><span class="comment">5.最后我们要监听特定的端口，我们调用app.listen方法，给他一个端口号，然后给他一个回调函数，来显示</span></span><br><span class="line"><span class="comment">成功以后显示的文字</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">"/"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(<span class="string">"Hello World"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.get(<span class="string">"/api/courses"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line">&#125;);</span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; <span class="built_in">console</span>.log(<span class="string">"Listening on port 3000.."</span>));</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/9.png" style="zoom: 67%;"><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/10.png" style="zoom: 67%;"></p>
<h3 id="Nodemon"><a href="#Nodemon" class="headerlink" title="Nodemon"></a>Nodemon</h3><p>Nodemon可以实时监控后端更改的内容并更新服务器。所以就不用每次修改以后重启服务器了</p>
<p>npm install -g nodemon</p>
<p>nodemon index.js 让nodemon检测该文件夹中所有文件、任何文件名和任何扩展名的改动</p>
<p><a href="https://blog.csdn.net/awsl_666/article/details/103043827" target="_blank" rel="noopener">如果报错看这里</a></p>
<h3 id="Environment-Variables"><a href="#Environment-Variables" class="headerlink" title="Environment Variables"></a>Environment Variables</h3><p>我们现在是规定了在3000端口，但是可能会产生端口冲突，为了解决这个问题我们可以使用环境变量</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">"/"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(<span class="string">"Hello World!!!"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.get(<span class="string">"/api/courses"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//port </span></span><br><span class="line"><span class="keyword">const</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line">app.listen(port, () =&gt; <span class="built_in">console</span>.log(<span class="string">`Listening on port <span class="subst">$&#123;port&#125;</span>..`</span>));</span><br></pre></td></tr></table></figure>
<p>然后设置 set PORT=5000，那么就有两种选择了</p>
<h3 id="Route-Parameters"><a href="#Route-Parameters" class="headerlink" title="Route Parameters"></a>Route Parameters</h3><p>我们现在想获得单一课程的信息也就是 /api/courses/1 </p>
<p>我们在 <a href="https://jasonxqh.github.io/2020/06/02/react基础2/">react基础2</a>  的路由部分有所提及 路由变量</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">"/api/courses/:id"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(req.params.id);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/11.png" style="zoom: 67%;"></p>
<p>也可以有多个变量</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">"/api/posts/:year/:month"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(req.params );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>当我们传入这个的时候，<a href="http://localhost:3000/api/posts/2020/6" target="_blank" rel="noopener">http://localhost:3000/api/posts/2020/6</a> 会显示如下对象</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/12.png" style="zoom: 67%;"></p>
<p>使用这种表达式也可以读取查询字符串。也就是在url后面的参数</p>
<p><a href="http://localhost:3000/api/posts/2020/6?sortBy=name" target="_blank" rel="noopener">http://localhost:3000/api/posts/2020/6?sortBy=name</a> </p>
<p>这个表达式的意思获取所有2020年6 月的帖子，然后根据名字来排序。sortBy=name  是查询字符串。我们使用它来向后端服务传递额外的参数。</p>
<p>所以我们用路由参数提供路由必须的数据与值，使用查询字符串传递附加的内容。</p>
<p>后端可以这么来读取查询字符串</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">"/api/posts/:year/:month"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(req.query);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/13.png" style="zoom: 67%;"></p>
<h3 id="Handling-HTTP-GET-Requests"><a href="#Handling-HTTP-GET-Requests" class="headerlink" title="Handling HTTP GET Requests"></a>Handling HTTP GET Requests</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="comment">//首先定义一个数组</span></span><br><span class="line"><span class="keyword">const</span> courses = [</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">"course1"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">"course2"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">3</span>, <span class="attr">name</span>: <span class="string">"course3"</span> &#125;,</span><br><span class="line">];</span><br><span class="line"><span class="comment">//如果没有路由参数，那么把所有的都返回</span></span><br><span class="line">app.get(<span class="string">"/api/courses"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(courses);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//如果有参数，那么在数组中选择数组元素对象中id等于路由参数id的，返回(注意,req.params.id需要转换)</span></span><br><span class="line">app.get(<span class="string">"/api/courses/:id"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> course = courses.find(<span class="function">(<span class="params">c</span>) =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">  <span class="keyword">if</span> (!course)<span class="comment">//那么如果这个id不存在的话，我们就需要返回404</span></span><br><span class="line">    res.status(<span class="number">404</span>).send(<span class="string">"The course with the given ID was not found "</span>);</span><br><span class="line">  res.send(course);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>入读，我们id=1，匹配到，那么就返回这个对象。否则返回 The course with the given ID was not found</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/14.png" style="zoom: 67%;"></p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/15.png" style="zoom: 67%;"></p>
<h3 id="Handling-HTTP-POST-Requests"><a href="#Handling-HTTP-POST-Requests" class="headerlink" title="Handling HTTP POST Requests"></a>Handling HTTP POST Requests</h3><p>现在我们利用post请求创建新的课程</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">为了能让这个put正常工作，我们需要打开Express获取请求体中JSON对象的功能，我们需要手动设置</span></span><br><span class="line"><span class="comment">这里我们做的其实是添加了一个中间件。当我们调用express.json的时候这个方法返回了一个中间件</span></span><br><span class="line"><span class="comment">然后我们用use方法在处理请求流程中使用这个中间件</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">app.use(express.json());</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">app.post(<span class="string">"/api/courses"</span>, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    	在handler中我们需要新建一个课程信息，然后把他添加到课程数组当中去</span></span><br><span class="line"><span class="comment">    因为没有数据库所以我们要手动设置ID，之后用了数据库ID就会由数据库自动生成</span></span><br><span class="line"><span class="comment">    	这里假设在request中有一个对象，对象中包含了一个name属性。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="keyword">const</span> course = &#123;</span><br><span class="line">    id: courses.length + <span class="number">1</span>,</span><br><span class="line">    name: req.body.name,</span><br><span class="line">  &#125;;</span><br><span class="line">  courses.push(course);<span class="comment">//利用push把这个对象加入到courses数组中</span></span><br><span class="line"><span class="comment">//最后作为惯例，当我们让服务器创建了新的对象或者资源的时候，我们应返回</span></span><br><span class="line">    <span class="comment">//因为客户端可能需要用到这个新创建的值</span></span><br><span class="line">  res.send(course);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Calling-Endpoints-Using-Postman"><a href="#Calling-Endpoints-Using-Postman" class="headerlink" title="Calling Endpoints Using Postman"></a>Calling Endpoints Using Postman</h3><p>我们利用google插件postman，在<a href="https://jasonxqh.github.io/2020/06/04/react基础3/">react基础3表单与后端</a> 中有所介绍</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/17.png" style="zoom: 80%;"></p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/16.png" style="zoom: 100%;"></p>
<p>这就是如何使用postman测试http终端。在实现过程中我们假设请求体中包含一个name属性的对象。</p>
<h3 id="Input-Validation"><a href="#Input-Validation" class="headerlink" title="Input Validation"></a>Input Validation</h3><p>但是如果用户传入了不合法的数据，那么我们需要对其验证。</p>
<p>从安全角度，我们永远不要相信客户输入的内容，所以我们要永远验证输入的内容</p>
<p>在这里我们可以简单写一个验证逻辑</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">app.post(<span class="string">"/api/courses"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (!req.body.name || req.body.name.length &lt; <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="comment">//400 Bad Request</span></span><br><span class="line">    res.status(<span class="number">400</span>).send(<span class="string">"Name is required and should be minimum 3 characters"</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> course = &#123;</span><br><span class="line">    id: courses.length + <span class="number">1</span>,</span><br><span class="line">    name: req.body.name,</span><br><span class="line">  &#125;;</span><br><span class="line">  courses.push(course);</span><br><span class="line">  res.send(course);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>如果不想写复杂的逻辑，我们可以导入一个包 在<a href="https://jasonxqh.github.io/2020/06/04/react基础3/">react基础3表单与后端</a> 中有提到Joi。在后端也可以使用</p>
<p>npm i joi@13.1.0</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">app.post(<span class="string">"/api/courses"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> schema = &#123;</span><br><span class="line">    name: Joi.string().min(<span class="number">3</span>).required(),</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> result = Joi.validate(req.body, schema);</span><br><span class="line">  <span class="keyword">if</span> (result.error) &#123;</span><br><span class="line">    <span class="comment">//400 Bad Request</span></span><br><span class="line">      <span class="built_in">console</span>.log(result);</span><br><span class="line">    res.status(<span class="number">400</span>).send(result.error.details[<span class="number">0</span>].message);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>如果正确，那么我们就打印出来的是一个对象，对象中error属性为null</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/18.png" style="zoom: 100%;"></p>
<p>反之我们对象中就有一个错误了</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/19.png" style="zoom: 100%;"></p>
<p>我们如果res.status(400).send(result.error);会显示一个比较复杂的对象，我们整整需要的是details中的message</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/20.png" style="zoom: 100%;"></p>
<p>所以我们改成这样res.status(400).send(result.error.details[0].message);当再次发送空的name或者name.length&lt;3 的话，在postman中我们得到这两个报错</p>
<p>“name” is required</p>
<p>“name” length must be at least 3 characters long</p>
<h3 id="Handling-HTTP-PUT-Requests"><a href="#Handling-HTTP-PUT-Requests" class="headerlink" title="Handling HTTP PUT Requests"></a>Handling HTTP PUT Requests</h3><p>这里重构了一下，把验证单独抽离出来成为一个函数。</p>
<p>逻辑是这样的，先验证是否存在这个id，再验证要修改的内容是否合法，最后进行更新和返回</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateCourse</span>(<span class="params">course</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> schema = &#123;</span><br><span class="line">    name: Joi.string().min(<span class="number">3</span>).required(),</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> Joi.validate(course, schema);</span><br><span class="line">&#125;</span><br><span class="line">app.put(<span class="string">"/api/courses/:id"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="comment">// Look up the course</span></span><br><span class="line">  <span class="comment">//If not existing ,return 404</span></span><br><span class="line">  <span class="keyword">const</span> course = courses.find(<span class="function">(<span class="params">c</span>) =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">  <span class="keyword">if</span> (!course)</span><br><span class="line">    res.status(<span class="number">404</span>).send(<span class="string">"The course with the given ID was not found "</span>);</span><br><span class="line">  <span class="comment">//Validate</span></span><br><span class="line">  <span class="comment">//If invalid,return 400-Bad request</span></span><br><span class="line">  <span class="keyword">const</span> &#123; error &#125; = validateCourse(req.body);</span><br><span class="line">  <span class="keyword">if</span> (error) &#123;</span><br><span class="line">    <span class="comment">//400 Bad Request</span></span><br><span class="line">    res.status(<span class="number">400</span>).send(error.details[<span class="number">0</span>].message);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//Update course</span></span><br><span class="line">  course.name = req.body.name;</span><br><span class="line">  <span class="comment">//Return the updated course</span></span><br><span class="line">  res.send(course);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/22.png" style="zoom: 100%;"></p>
<h3 id="Handling-HTTP-Delete-Requests"><a href="#Handling-HTTP-Delete-Requests" class="headerlink" title="Handling HTTP Delete Requests"></a>Handling HTTP Delete Requests</h3><p>删除的逻辑：首先找到movie.id，找不到返回404，找到了我们就取这个课程的id。通过splice函数删除</p>
<p>splice(从第几个元素开始,删除几个元素)</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">app.delete(<span class="string">"/api/courses/:id"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="comment">//look up the course</span></span><br><span class="line">  <span class="comment">//Not existing ,return 404</span></span><br><span class="line">  <span class="keyword">const</span> course = courses.find(<span class="function">(<span class="params">c</span>) =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">  <span class="keyword">if</span> (!course)</span><br><span class="line">    res.status(<span class="number">404</span>).send(<span class="string">"The course with the given ID was not found "</span>);</span><br><span class="line">  <span class="comment">//Delete</span></span><br><span class="line">  <span class="keyword">const</span> index = courses.indexOf(course);</span><br><span class="line">  courses.splice(index, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Return the same course</span></span><br><span class="line">  res.send(course);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>如果传入<a href="http://localhost:3000/api/courses/10" target="_blank" rel="noopener">http://localhost:3000/api/courses/10</a></p>
<p>得到 The course with the given ID was not found</p>
<p>我们先来删除，再获取，发现已经找不到courses/1了</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/24.png" style="zoom: 80%;"></p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/23.png" style="zoom: 100%;"></p>
<p>代码还需要做一个小改进，就是当发现错误的时候，立即return</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> Joi = <span class="built_in">require</span>(<span class="string">"joi"</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line">app.use(express.json());</span><br><span class="line"><span class="keyword">const</span> courses = [</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">"course1"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">"course2"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">3</span>, <span class="attr">name</span>: <span class="string">"course3"</span> &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">"/"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(<span class="string">"Hello World!!!"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.get(<span class="string">"/api/courses"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(courses);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">"/api/courses/:id"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> course = courses.find(<span class="function">(<span class="params">c</span>) =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">  <span class="keyword">if</span> (!course)</span><br><span class="line">    <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">"The course with the given ID was not found "</span>);</span><br><span class="line">  res.send(course);</span><br><span class="line">&#125;);</span><br><span class="line">app.get(<span class="string">"/api/posts/:year/:month"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(req.query);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateCourse</span>(<span class="params">course</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> schema = &#123;</span><br><span class="line">    name: Joi.string().min(<span class="number">3</span>).required(),</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> Joi.validate(course, schema);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">"/api/courses"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; error &#125; = validateCourse(req.body);</span><br><span class="line">  <span class="keyword">if</span> (error)</span><br><span class="line">    <span class="comment">//400 Bad Request</span></span><br><span class="line">    <span class="keyword">return</span> res.status(<span class="number">400</span>).send(error.details[<span class="number">0</span>].message);</span><br><span class="line">  <span class="keyword">const</span> course = &#123;</span><br><span class="line">    id: courses.length + <span class="number">1</span>,</span><br><span class="line">    name: req.body.name,</span><br><span class="line">  &#125;;</span><br><span class="line">  courses.push(course);</span><br><span class="line">  res.send(course);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.put(<span class="string">"/api/courses/:id"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="comment">// Look up the course</span></span><br><span class="line">  <span class="comment">//If not existing ,return 404</span></span><br><span class="line">  <span class="keyword">const</span> course = courses.find(<span class="function">(<span class="params">c</span>) =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">  <span class="keyword">if</span> (!course)</span><br><span class="line">    <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">"The course with the given ID was not found "</span>);</span><br><span class="line">  <span class="comment">//Validate</span></span><br><span class="line">  <span class="comment">//If invalid,return 400-Bad request</span></span><br><span class="line">  <span class="keyword">const</span> &#123; error &#125; = validateCourse(req.body);</span><br><span class="line">  <span class="keyword">if</span> (error)</span><br><span class="line">    <span class="comment">//400 Bad Request</span></span><br><span class="line">    <span class="keyword">return</span> res.status(<span class="number">400</span>).send(error.details[<span class="number">0</span>].message);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Update course</span></span><br><span class="line">  course.name = req.body.name;</span><br><span class="line">  <span class="comment">//Return the updated course</span></span><br><span class="line">  res.send(course);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.delete(<span class="string">"/api/courses/:id"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="comment">//look up the course</span></span><br><span class="line">  <span class="comment">//Not existing ,return 404</span></span><br><span class="line">  <span class="keyword">const</span> course = courses.find(<span class="function">(<span class="params">c</span>) =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">  <span class="keyword">if</span> (!course)</span><br><span class="line">    <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">"The course with the given ID was not found "</span>);</span><br><span class="line">  <span class="comment">//Delete</span></span><br><span class="line">  <span class="keyword">const</span> index = courses.indexOf(course);</span><br><span class="line">  courses.splice(index, <span class="number">1</span>);</span><br><span class="line">  res.send(course);</span><br><span class="line">  <span class="comment">// Return the same course</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//port</span></span><br><span class="line"><span class="keyword">const</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line">app.listen(port, () =&gt; <span class="built_in">console</span>.log(<span class="string">`Listening on port <span class="subst">$&#123;port&#125;</span>..`</span>));</span><br></pre></td></tr></table></figure>
<h3 id="Project-Build-the-Genres-API"><a href="#Project-Build-the-Genres-API" class="headerlink" title="Project- Build the Genres API"></a>Project- Build the Genres API</h3><p>现在我们来船舰vidly应用的后端</p>
<p>首先我们创建一个管理电影分类的终端。每个电影都有自己的分类</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Joi = <span class="built_in">require</span>(<span class="string">'joi'</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app.use(express.json());</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> genres = [</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">'Action'</span> &#125;,  </span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">'Horror'</span> &#125;,  </span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">3</span>, <span class="attr">name</span>: <span class="string">'Romance'</span> &#125;,  </span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/api/genres'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(genres);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/api/genres'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; error &#125; = validateGenre(req.body); </span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">return</span> res.status(<span class="number">400</span>).send(error.details[<span class="number">0</span>].message);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> genre = &#123;</span><br><span class="line">    id: genres.length + <span class="number">1</span>,</span><br><span class="line">    name: req.body.name</span><br><span class="line">  &#125;;</span><br><span class="line">  genres.push(genre);</span><br><span class="line">  res.send(genre);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.put(<span class="string">'/api/genres/:id'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> genre = genres.find(<span class="function"><span class="params">c</span> =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">  <span class="keyword">if</span> (!genre) <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">'The genre with the given ID was not found.'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; error &#125; = validateGenre(req.body); </span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">return</span> res.status(<span class="number">400</span>).send(error.details[<span class="number">0</span>].message);</span><br><span class="line">  </span><br><span class="line">  genre.name = req.body.name; </span><br><span class="line">  res.send(genre);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.delete(<span class="string">'/api/genres/:id'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> genre = genres.find(<span class="function"><span class="params">c</span> =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">  <span class="keyword">if</span> (!genre) <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">'The genre with the given ID was not found.'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> index = genres.indexOf(genre);</span><br><span class="line">  genres.splice(index, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  res.send(genre);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/api/genres/:id'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> genre = genres.find(<span class="function"><span class="params">c</span> =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">  <span class="keyword">if</span> (!genre) <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">'The genre with the given ID was not found.'</span>);</span><br><span class="line">  res.send(genre);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateGenre</span>(<span class="params">genre</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> schema = &#123;</span><br><span class="line">    name: Joi.string().min(<span class="number">3</span>).required()</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Joi.validate(genre, schema);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line">app.listen(port, () =&gt; <span class="built_in">console</span>.log(<span class="string">`Listening on port <span class="subst">$&#123;port&#125;</span>...`</span>));</span><br></pre></td></tr></table></figure>
<h3 id="A-Quick-Note"><a href="#A-Quick-Note" class="headerlink" title="A Quick Note"></a>A Quick Note</h3><p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/25.png" style="zoom: 80%;"></p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/26.png" style="zoom: 80%;"></p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/27.png" style="zoom: 80%;"></p>
<h2 id="Express-Advanced-Topics"><a href="#Express-Advanced-Topics" class="headerlink" title="Express- Advanced Topics"></a>Express- Advanced Topics</h2><h3 id="Introduction-1"><a href="#Introduction-1" class="headerlink" title="Introduction"></a>Introduction</h3><p>在这章节我们会学Middleware,Configuration,Debugging,Template Engines</p>
<h3 id="Middleware"><a href="#Middleware" class="headerlink" title="Middleware"></a>Middleware</h3><p>express中的一个核心概念就是中间件（中间件函数） 。一个中间件技术上说就是：我们得到一个请求对象，要么返回客户端，要么传递给一个中间件。</p>
<p>在Express当中，所有route handler都是中间件：因为它需要传入一个请求对象，并且在这里向客户端返回数据。 express.json() 这个函数返回一个中间件。这个函数的作用就是读取请求，如果请求体是一个JSON格式的对象。他就会格式化这个JSON对象并以此设置req.body属性</p>
<p>处理模型大致是这样的。当服务器收到一个请求，请求就进入一个管道，我们将这个管道成为请求处理管道(Request Processing Pipeline) 管道之中由一个或者多个中间件。每个中间件要么根据请求向客户端返回数据，要么将控制权交给其他的中间件</p>
<p>之前的代码中这个 RPP中由两个中间件，一个是把请求转化成一个JSON格式对象，它并没有终结Request Response Circle,所以他把控制权交给了下一个中间件，也就是route handler 。route handler中 req.body属性已经设置好了，这样就可以进行一些操作了。 最后向客户端发送反馈来终结 Request Response Circle</p>
<p>Express中有内部中间件函数，我们同样也可以在RPP中添加自定义的中间件函数</p>
<p>使用自定义的中间件，我们可以创建 Crosscutting Concerns，比如实现登录验证等功能。</p>
<h3 id="Creating-Custom-Middleware"><a href="#Creating-Custom-Middleware" class="headerlink" title="Creating Custom Middleware"></a>Creating Custom Middleware</h3><p>我们通过调用use方法在RPP中安插一个中间件。传入一个函数，里面有三个参数。next表示管道中下一个中间件的引用。这里写了两个中间件。注意，一定要写next()把控制权交给下一个中间件，否则的话我们没有闭合 Request Response Circle，那么就一直显示Loading… </p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/28.png" style="zoom: 67%;"></p>
<p>中间件是按照顺序调用的，首先调用logging函数，其次调用 Authenticating函数</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/29.png" style="zoom: 80%;"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'logging...'</span>);</span><br><span class="line">    next();</span><br><span class="line">&#125;)</span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Authenticating...'</span>);</span><br><span class="line">    next();</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>为了让代码变得更加简明，当我们创建中间件的时候我们不要写在index中。我们要把每个中间件放在各自独立的文件当中</p>
<p>新建一个logger.js存放我们的中间件</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"logging..."</span>);</span><br><span class="line">  next();</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = log;</span><br></pre></td></tr></table></figure>
<p>在index中导入</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> logger = <span class="built_in">require</span>(<span class="string">"./logger"</span>);</span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(logger);</span><br></pre></td></tr></table></figure>
<p>现在理解了express.json()的意思了吧。当我们调用它时，他返回了一个需要三个参数的函数。req，res，next</p>
<p>他格式化了请求体，如果是一个JSON对象他就设置为req.body属性</p>
<h3 id="Built-in-Middleware"><a href="#Built-in-Middleware" class="headerlink" title="Built-in Middleware"></a>Built-in Middleware</h3><p>Express有很多Built-in 中间件，比如 express.json()</p>
<p>还有类似的中间件app.use(express.urlencode());</p>
<p>app.use(express.static(’public‘)); 我们可以把所有静态文件（css，图片等）放到这里去，static中间件是从根目录开始起作用的</p>
<p>这样就可以通过url访问这些文件了</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/30.png" style="zoom: 80%;"></p>
<h3 id="Third-party-Middleware-第三方中间件"><a href="#Third-party-Middleware-第三方中间件" class="headerlink" title="Third-party Middleware 第三方中间件"></a>Third-party Middleware 第三方中间件</h3><p><a href="http://expressjs.com/en/resources/middleware.html" target="_blank" rel="noopener">官方文档</a>中有很多中间件</p>
<p>这里我们使用helmet 中间件，Helps secure your apps by setting various HTTP headers</p>
<p>npm i helmet</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> helmet = <span class="built_in">require</span>(<span class="string">"helmet"</span>);</span><br><span class="line">app.use(helmet);</span><br></pre></td></tr></table></figure>
<p>另一个有用的中间件是Morgan，我们利用它来进行HTTP请求的日志记录.这里是用最简单的格式，tiny</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> morgan = <span class="built_in">require</span>(<span class="string">"morgan"</span>);</span><br><span class="line">app.use(morgan(<span class="string">"tiny"</span>));</span><br></pre></td></tr></table></figure>
<p>使用了Morgan以后，我们再进行操作的话，后端就会出现日志</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/31.png" style="zoom: 80%;"></p>
<p>顺便说，Morgan默认请求实在控制台记录日志。同样也可以设置它写在日志文件当中。我可以有一个配置文件，在某些特定的场景下可以短时间开启这个功能。（开启后对运行效率有影响）</p>
<h3 id="Environments"><a href="#Environments" class="headerlink" title="Environments"></a>Environments</h3><p>也许我们想依照环境类型决定是否开关某功能。例如我们只想再开发环境当中开启对HTTP请求的日志记录</p>
<p>我们利用process对象，他是node的全局对象，通过它可以访问当前的进程，这个process对象有一个env属性</p>
<p>它提供我们环境变量的值。有一个标准的环境变量是NODE_ENV。 这个值返回当前node所在环境的值。如果他没有被设置，那么他就会返回未定义。同样我们可以在外部设置它，把它设置为production,testing等等</p>
<p>还有一种方法可以获得默认环境，是app的一个方法app.get(“env”),这其实默认调用了NODE_ENV，但是当NODE_ENV未定义的时候，这个方法默认返回开发环境的值</p>
<p>我们来打印一下默认的环境</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">`NODE_ENV:<span class="subst">$&#123;process.env.NODE_ENV&#125;</span>`</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`app:<span class="subst">$&#123;app.get(<span class="string">"env"</span>)&#125;</span>`</span>);</span><br></pre></td></tr></table></figure>
<p>NODE_ENV:undefined<br>app:development<br>在这个例子当中我们只想在开发环境使用日志。我们就可以这么写代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(app.get(<span class="string">'env'</span>)===<span class="string">'development'</span>)&#123;</span><br><span class="line">    app.use(morgan(<span class="string">'tiny'</span>));</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Morgan enabled'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是我们如果把环境设为生产，Morgan就不会起作用了</p>
<p>在Windows通过set命令来设置环境变量</p>
<p>set NODE_ENV = production</p>
<h3 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h3><p>现在来讨论如何保存应用的配置数据。并且在不同的环境中复写对应配置</p>
<p>比如在测试环境，我可以需要使用一个不同的数据库或者邮件服务器。</p>
<p>我们可以利用 rc 包</p>
<p><a href="https://www.npmjs.com/package/rc" target="_blank" rel="noopener">https://www.npmjs.com/package/rc</a></p>
<p>也可以使用 config包</p>
<p><a href="https://www.npmjs.com/package/config" target="_blank" rel="noopener">https://www.npmjs.com/package/config</a></p>
<p>npm i config</p>
<p>我们先在根目录下新建一个config文件夹</p>
<p>里面有三个JSON文件：default，development，production</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"name"</span>:<span class="string">"My Express App"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"My Express App =Development"</span>,</span><br><span class="line">  <span class="attr">"mail"</span>: &#123;</span><br><span class="line">    <span class="attr">"host"</span>: <span class="string">"dev-mail-server"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"My Express App =Development"</span>,</span><br><span class="line">  <span class="attr">"mail"</span>: &#123;</span><br><span class="line">    <span class="attr">"host"</span>: <span class="string">"prod-mail-server"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后再index.js中导入这个包。利用get方法就会自动根据当前的环境变量找到相应的文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">"config"</span>);</span><br><span class="line"><span class="comment">//configuration</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Application Name:"</span> + config.get(<span class="string">"name"</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Maile Server Name:"</span> + config.get(<span class="string">"mail.host"</span>));</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<p>Application Name:My Express App =Development<br>Maile Server Name:dev-mail-server</p>
<p>利用这个模块我们可以轻松的设置不同的环境的配置</p>
<p>但是不能把密码等机密放在json文件夹当中。因为这样很不安全，每个人都能看见。。</p>
<p>我们应该把他们保存在环境变量当中。我们来设置一下</p>
<p>终端中输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set app_password&#x3D;1234</span><br></pre></td></tr></table></figure>
<p>然后我们新建一个 custom-environment-variables （名字一定要写对） </p>
<p>在这个文件只有映射关系，映射环境变量和应用配置的关系</p>
<p>在这里只有password 到app_password 的映射关系</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"mail"</span>: &#123;</span><br><span class="line">      <span class="attr">"password"</span>:<span class="string">"app_password"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Debugging"><a href="#Debugging" class="headerlink" title="Debugging"></a>Debugging</h3><p>如果用console.log()来调试，会很麻烦，改来改去。所以更好的在控制台调试的方式是使用node的debug模块</p>
<p>也就是说用debug函数替换所有的console.log 这样就不需要注释掉他们，可以通过在外部修改环境变量实现</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> startupDebugger = <span class="built_in">require</span>(<span class="string">"debug"</span>)(<span class="string">"app:startup"</span>);</span><br><span class="line"><span class="keyword">const</span> dbDebugger = <span class="built_in">require</span>(<span class="string">"debug"</span>)(<span class="string">"app:db"</span>);</span><br></pre></td></tr></table></figure>
<p>然后通过</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> DEBUG=app:startup</span><br></pre></td></tr></table></figure>
<p>查看Debug信息</p>
<h3 id="Templating-Engines"><a href="#Templating-Engines" class="headerlink" title="Templating Engines"></a>Templating Engines</h3><p>有时候我们需要返回HTML标记语言文本到客户端而不是JSON文件，那么我们就需要模板引擎了</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/32.png" style="zoom: 80%;"></p>
<p>那么我们新建一个views文件夹，然后在里面新建一个index.pug文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">html</span><br><span class="line">    head</span><br><span class="line">        title&#x3D;title</span><br><span class="line">    body</span><br><span class="line">        h1&#x3D;message</span><br></pre></td></tr></table></figure>
<p>在index.js中配置</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app.set(<span class="string">"view engine"</span>, <span class="string">"pug"</span>);</span><br><span class="line">app.set(<span class="string">"views"</span>, <span class="string">"./views"</span>); <span class="comment">//optional</span></span><br></pre></td></tr></table></figure>
<p>虽有这样修改，可以看到Helloworld已经被渲染出来了</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/33.png" style="zoom: 80%;"></p>
<p>但是我们后端不需要什么视图引擎或者模板引擎</p>
<h3 id="Database-Integration"><a href="#Database-Integration" class="headerlink" title="Database Integration"></a>Database Integration</h3><p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/34.png" style="zoom: 80%;"></p>
<h3 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h3><p>Express没有验证功能</p>
<h3 id="Structuring-Express-Applications"><a href="#Structuring-Express-Applications" class="headerlink" title="Structuring Express Applications"></a>Structuring Express Applications</h3><p>在现实开发中我们肯定不会把所有的东西放到index.js当中去。所以我们要正确的结构化我的应用</p>
<p>第一件事就是清理所有设计courses的接口，并且把它放到一个独立的文件当中去。换句话说，每个独立的api终端的逻辑代码，都要转为一个独立的文件或者模块。所有的coureses的路由都要丢到一个courses.js文件当中去</p>
<p>我们在根目录新建一个新的routes文件夹里面有文件courses.js。把所有包含courses.js的文件全部放到courses.js中</p>
<p>courses.js的配置 把app都换成router</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<p>同样的，把home.js 抽离出来</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line">router.get(<span class="string">"/"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.render(<span class="string">"index"</span>, &#123; <span class="attr">title</span>: <span class="string">"My Express App"</span>, <span class="attr">message</span>: <span class="string">"Helloworld"</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<p>最后，把logger放到middleware文件夹当中</p>
<p>…</p>
<p>index.js中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> startupDebugger = <span class="built_in">require</span>(<span class="string">"debug"</span>)(<span class="string">"app:startup"</span>);</span><br><span class="line"><span class="keyword">const</span> dbDebugger = <span class="built_in">require</span>(<span class="string">"debug"</span>)(<span class="string">"app:db"</span>);</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">"config"</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"><span class="keyword">const</span> logger = <span class="built_in">require</span>(<span class="string">"./middleware/logger"</span>);</span><br><span class="line"><span class="keyword">const</span> helmet = <span class="built_in">require</span>(<span class="string">"helmet"</span>);</span><br><span class="line"><span class="keyword">const</span> morgan = <span class="built_in">require</span>(<span class="string">"morgan"</span>);</span><br><span class="line"><span class="keyword">const</span> courses = <span class="built_in">require</span>(<span class="string">"./routes/courses"</span>);</span><br><span class="line"><span class="keyword">const</span> home = <span class="built_in">require</span>(<span class="string">"./routes/home"</span>);</span><br><span class="line">app.set(<span class="string">"view engine"</span>, <span class="string">"pug"</span>);</span><br><span class="line">app.set(<span class="string">"views"</span>, <span class="string">"./views"</span>); <span class="comment">//optional</span></span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(express.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">true</span> &#125;));</span><br><span class="line">app.use(logger);</span><br><span class="line">app.use(helmet());</span><br><span class="line"><span class="comment">// route全部以/api/courses开头，那么courses.js中就可以把所有的/api/courses都去掉了，只留下:id。</span></span><br><span class="line">app.use(<span class="string">"/api/courses"</span>, courses);</span><br><span class="line">app.use(<span class="string">"/"</span>, home);</span><br><span class="line"><span class="comment">//configuration</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Application Name:"</span> + config.get(<span class="string">"name"</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Mail  Server Name:"</span> + config.get(<span class="string">"mail.host"</span>));</span><br><span class="line"><span class="comment">// console.log("Maile Server Password:" + config.get("mail.password"));</span></span><br><span class="line"><span class="keyword">if</span> (app.get(<span class="string">"env"</span>) === <span class="string">"development"</span>) &#123;</span><br><span class="line">  app.use(morgan(<span class="string">"tiny"</span>));</span><br><span class="line">  startupDebugger(<span class="string">"Morgan enabled"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Db work</span></span><br><span class="line">dbDebugger(<span class="string">"Connected to the database"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//port</span></span><br><span class="line"><span class="keyword">const</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line">app.listen(port, () =&gt; <span class="built_in">console</span>.log(<span class="string">`Listening on port <span class="subst">$&#123;port&#125;</span>..`</span>));</span><br></pre></td></tr></table></figure>
<h3 id="Project-Restructure-the-App"><a href="#Project-Restructure-the-App" class="headerlink" title="Project- Restructure the App"></a>Project- Restructure the App</h3><p>现在我们重构之前的vidly项目，</p>
<p>index.js</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Joi = <span class="built_in">require</span>(<span class="string">"joi"</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"><span class="keyword">const</span> genres = <span class="built_in">require</span>(<span class="string">"./routes/genres"</span>);</span><br><span class="line">app.use(express.json());</span><br><span class="line"></span><br><span class="line">app.use(<span class="string">"/api/genres"</span>, genres);</span><br><span class="line"><span class="keyword">const</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line">app.listen(port, () =&gt; <span class="built_in">console</span>.log(<span class="string">`Listening on port <span class="subst">$&#123;port&#125;</span>...`</span>));</span><br></pre></td></tr></table></figure>
<p>genres.js 替换app为route, 替换/api/genres为/</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Joi = <span class="built_in">require</span>(<span class="string">"joi"</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://jasonxqh.github.io/2020/06/07/web%E6%9C%9F%E6%9C%AB%E5%A4%A7%E4%BD%9C%E4%B8%9A-%E4%B8%BB%E5%8D%9A%E5%AE%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason‘s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/07/web%E6%9C%9F%E6%9C%AB%E5%A4%A7%E4%BD%9C%E4%B8%9A-%E4%B8%BB%E5%8D%9A%E5%AE%A2/" class="post-title-link" itemprop="url">web期末大作业-主博客</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-07 12:10:31" itemprop="dateCreated datePublished" datetime="2020-06-07T12:10:31+08:00">2020-06-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-06-17 15:53:58" itemprop="dateModified" datetime="2020-06-17T15:53:58+08:00">2020-06-17</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="web期末大作业-主博客"><a href="#web期末大作业-主博客" class="headerlink" title="web期末大作业-主博客"></a>web期末大作业-主博客</h1><h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>这次的期末大作业我选择第一个</p>
<p><img src="/2020/06/07/web%E6%9C%9F%E6%9C%AB%E5%A4%A7%E4%BD%9C%E4%B8%9A-%E4%B8%BB%E5%8D%9A%E5%AE%A2/1.png" style="zoom:80%;"></p>
<p>​        我接触web开发仅仅只有短短半学期时间，能兼顾前后端并把原理说得很明白是很难做到的。作业实现的代码中也有相当一部分在学习相关知识之后还迷迷糊糊未曾深究。加上我的表达能力着实有限，实在无法简洁明了，简单扼要得把整个作业项目庖丁解牛式得展现，有时候不得不借鉴他人的博客。但是我会尽力做到把能够说明白的说清楚。</p>
<p>​        这篇博客是主博客,因为实在无法在一篇博客中写太多的字数，对我和读者都有莫大的挑战，所以我把这篇博客当作索引，分为了大约10篇子博客，具体的博客树大概是这样的。</p>
<p><img src="/2020/06/07/web%E6%9C%9F%E6%9C%AB%E5%A4%A7%E4%BD%9C%E4%B8%9A-%E4%B8%BB%E5%8D%9A%E5%AE%A2/8.png" style="zoom: 50%;"></p>
<p>从上图可知，我做的这个project 是一个标准的 MERN stack，也就是 MongoDB，Express，React 和 Nodejs</p>
<h2 id="需求分析："><a href="#需求分析：" class="headerlink" title="需求分析："></a>需求分析：</h2><ol>
<li><strong>用户可注册登录网站，非注册用户不可登陆查看数据</strong>：这就要求前后端配合，数据库中存储用户信息，前端通过api调用实现认证</li>
<li><strong>用户实现注册，登录，查询等操作记录数据库中的日志</strong>：同样需要前后端配合</li>
<li><strong>实现查询词支持布尔表达式</strong>：需要后端编写查询函数，通过api接口提供给前端</li>
<li><strong>爬虫数据查询结果列表支持分页和排序</strong>：前端通过api接口获得数据库中的信息之后进行排序</li>
<li><strong>用Echarts或者D3实现数据分析图标展示在网站中</strong>： 利用数据可视化工具展示图表</li>
</ol>
<h2 id="网站架构"><a href="#网站架构" class="headerlink" title="网站架构"></a>网站架构</h2><p>前端方面: 利用React框架构造前端</p>
<p>后端方面: 利用MongoDb+Express+Nodejs 构造后端</p>
<h3 id="页面概览"><a href="#页面概览" class="headerlink" title="页面概览"></a>页面概览</h3><ul>
<li>登陆页面</li>
<li>展示页面</li>
<li><p>管理员界面</p>
<ul>
<li>普通用户界面</li>
<li>在界面中可以实现AND和OR的布尔查询</li>
<li>只有登陆了才能看到展示页面。退出以后回到登陆页面。</li>
</ul>
</li>
</ul>
<h2 id="数据源"><a href="#数据源" class="headerlink" title="数据源"></a>数据源</h2><p><a href="https://jasonxqh.github.io/2020/04/30/从-1开始的python爬虫/">从-1开始的python爬虫</a></p>
<p>里面详细介绍了我如歌编写python爬虫并存储数据的。我认为比JavaScript更有效率</p>
<p>在这里，我选择了4张表格来当作我的数据源。</p>
<p>分别是猫眼电影Top100</p>
<p>豆瓣电影Top250</p>
<p>淘宝咖啡商品</p>
<p>美剧天堂的所有剧集。</p>
<p>通过python编写爬虫并存储至MongoDb当中</p>
<h2 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h2><p>前端的话我选择了Facebook开源的React框架。囊括了基本的组件构造、分页排序、路由、登录等功能。接下来我的作业也会沿用这些技术。在作业中的前端中我还用到了以下技术：scss，简单的redux 和基础的中间件，antd样式库.我把需要的知识都写成了学习博客，以供老师和自己今后的项目开发做参考。</p>
<p>下面是我的学习博客，也是期末作业的一部分，总长 4万字左右。</p>
<p><a href="https://jasonxqh.github.io/2020/05/26/OOP-in-JavaScript/">面向对象的Javascript</a></p>
<p><a href="https://jasonxqh.github.io/2020/05/30/react基础/#more">react基础1组件与组合组件</a></p>
<p><a href="https://jasonxqh.github.io/2020/06/02/react基础2/">react基础2分页排序搜索+路由</a></p>
<p> <a href="https://jasonxqh.github.io/2020/06/04/react基础3/">react基础3表单与后端</a></p>
<p><a href="https://jasonxqh.github.io/2020/06/05/react基础4授权与部署/">react基础4授权与部署</a></p>
<p>那么我这个项目需要多少前端页面，又需要编写多少组件呢？在这里，组件如何编写我就不详细阐释了（代码有需求的展示）。因为在react的四篇长文中已经有极其详细的介绍了。我将把重点放到一些疑难困惑地的解决当中去</p>
<h3 id="前端架构"><a href="#前端架构" class="headerlink" title="前端架构"></a>前端架构</h3><p><strong>根目录部分</strong>我们需要写：index.js 主文件和 代理文件</p>
<p><strong>页面部分</strong>我们需要写：登录页面，注册页面，管理员的用户管理页面，4张表格的展示页面。</p>
<p><strong>组件部分</strong>我们需要写：NavBar(导航栏组件)，包含了NavBar的基本界面Layout组件，为了页面美观我们编写的loading组件，和为了登录而写的 private组件。</p>
<p>具体的应用实现，请移步子博文</p>
<p><a href="https://jasonxqh.github.io/2020/06/07/React框架在作业当中的应用/">React框架在作业当中的应用</a></p>
<h2 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h2><p>后端的话我选择了Express框架，一是以前就接触过，虽不是很深入了解但也有点印象。二是我只会这个框架。。。所以在写之前我还是系统学习了一下nodejs和express</p>
<p><a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础1/#more">Nodejs基础1Express和RESTful</a></p>
<p><a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础2/#more"> Nodejs基础2异步操作与CRUD</a></p>
<h3 id="后端架构"><a href="#后端架构" class="headerlink" title="后端架构"></a>后端架构</h3><p> 在博客<a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础1/#more">Nodejs基础1</a>中已经初步建立起了一个后端的框架来了，当然那个只是简易的框架。在作业中，沿用了RESTful法则分为下面几个文件夹</p>
<p>在<a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础2/#more"> Nodejs基础2异步操作与CRUD</a> 中主要介绍了异步操作和链接mongodb之后的CRUD，为作业打好基础。</p>
<p><strong>根目录</strong>: config.js, server.js(app.js)</p>
<p><strong>routes目录</strong>： routes部分就是接出来路由嘛，但是因为这个程序比较复杂，所以我通过routes调用controller来增加代码的层次性</p>
<p><strong>models目录</strong>：存放数据表格式</p>
<p><strong>controller目录</strong>： 具体的后端操作都在这里了</p>
<p><strong>middleware中间件目录</strong>：用来登录认证和错误判断</p>
<p>具体的应用实现，请移步子博文</p>
<p><a href="https://jasonxqh.github.io/2020/06/08/Express框架在后端的应用/">Express框架在后端的应用</a></p>
<h2 id="数据可视化"><a href="#数据可视化" class="headerlink" title="数据可视化"></a>数据可视化</h2><p>数据可视化的工具也学习了几个了，从最开始利用  <a href="https://jasonxqh.github.io/2020/05/13/python数据分析/">pandas </a>和  <a href="https://jasonxqh.github.io/2020/05/14/python数据可视化之matplotlib/">matplotlib</a>入门开始，再到对<a href="https://jasonxqh.github.io/2020/04/29/matlab基础/">matlab基础</a>的学习，都只是在本地画图，但是如果我们想要在dom里画图，就必须使用JavaScript的画图工具 D3 和 Echarts，这里我选择了D3来做</p>
<p>D3的学习和应用，请移步子博文。</p>
<p><a href="https://jasonxqh.github.io/2020/06/12/JavaScript数据可视化之D3/">JavaScript数据可视化之D3</a></p>
<p><a href="https://jasonxqh.github.io/2020/06/16/数据可视化在作业当中的应用/">数据可视化在作业当中的应用</a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>​    这次的作业如果要完成基本操作确实不难。但是我把大量的时间花在了基础知识的学习当中。正所谓万丈高楼平地起。没有基础知识的作业，也只是空中楼阁罢了。</p>
<p>​    所以为了学习基础知识我对比了大量的网络课程，翻阅了大量的文档，最终形成了这些博客。从5月26日写下第一篇  面向对象的Javascript 之后，我平均每天会花上4-5个小时写博客+写代码，双休日更是从早到晚，几乎没有喘息的时间。所以当最后一篇文章更新完毕的时候，从我身体中迸发出来的成就感是不可言说的。对于这门课来说，这只是一个大作业；但对于我来说，这更是一条难忘的学习旅程：从信息收集到后端，从后端到前端，我初步掌握了全栈开发的要领，这个作业也将成为将来一些项目的模板。</p>
<p>​    虽然老师要求的一些拓展功能我还没有办法实现。但这并不影响我今后继续探索的兴趣和信心。随着经验的丰富，我相信这些问题都会迎刃而解。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://jasonxqh.github.io/2020/06/05/react%E5%9F%BA%E7%A1%804%E6%8E%88%E6%9D%83%E4%B8%8E%E9%83%A8%E7%BD%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason‘s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/05/react%E5%9F%BA%E7%A1%804%E6%8E%88%E6%9D%83%E4%B8%8E%E9%83%A8%E7%BD%B2/" class="post-title-link" itemprop="url">react基础4授权与部署</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-05 22:56:38" itemprop="dateCreated datePublished" datetime="2020-06-05T22:56:38+08:00">2020-06-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-06-21 12:43:18" itemprop="dateModified" datetime="2020-06-21T12:43:18+08:00">2020-06-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/react/" itemprop="url" rel="index"><span itemprop="name">react</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="react基础4授权与部署"><a href="#react基础4授权与部署" class="headerlink" title="react基础4授权与部署"></a>react基础4授权与部署</h1><p>最终章。可能有番外吧。。但是也要在完成大作业之后了</p>
<p>前三章：</p>
<p><a href="https://jasonxqh.github.io/2020/06/04/react基础3/">react基础3表单与后端</a></p>
<p><a href="https://jasonxqh.github.io/2020/06/02/react基础2/#more">react基础2排序分页与查询+路由</a></p>
<p><a href="https://jasonxqh.github.io/2020/05/30/react基础/#more">react基础组件+如何组合组件 </a></p>
<h2 id="Authentication-and-Authorization"><a href="#Authentication-and-Authorization" class="headerlink" title="Authentication and Authorization"></a>Authentication and Authorization</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><h3 id="Registering-a-New-User"><a href="#Registering-a-New-User" class="headerlink" title="Registering a New User"></a>Registering a New User</h3><p>利用postman 进行post，成功了</p>
<p><img src="/2020/06/05/react%E5%9F%BA%E7%A1%804%E6%8E%88%E6%9D%83%E4%B8%8E%E9%83%A8%E7%BD%B2/1.png" style="zoom:67%;"></p>
<h3 id="Submitting-the-Registration-Form"><a href="#Submitting-the-Registration-Form" class="headerlink" title="Submitting the Registration Form"></a>Submitting the Registration Form</h3><p>首先新建一个userService.js 这个文件封装了调用后端api的函数，沟通了前后端。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">"./httpService"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; apiUrl &#125; <span class="keyword">from</span> <span class="string">"../config.json"</span>;</span><br><span class="line"><span class="keyword">const</span> apiEndpoint = apiUrl + <span class="string">"/users"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params">user</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> http.post(apiEndpoint, &#123;</span><br><span class="line">    email: user.username,</span><br><span class="line">    password: user.password,</span><br><span class="line">    name: user.name,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后再registerForm中导入，我们可以用这种语法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import * as userService from &quot;..&#x2F;services&#x2F;userService&quot;;</span><br></pre></td></tr></table></figure>
<p>这样的语法 ,会在registerForm中创建一个userServices对象，然后从userServices导入的所有函数都会成为他的方法<br>然后修改doSubmit方法,调用userService.register() 来注册</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">doSubmit = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> userService.register(<span class="keyword">this</span>.state.data);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们看到在前端输入信息提交之后，在dev-tools中可以看到这条注册信息，然后后端会在MongoDb上载入信息</p>
<p><img src="/2020/06/05/react%E5%9F%BA%E7%A1%804%E6%8E%88%E6%9D%83%E4%B8%8E%E9%83%A8%E7%BD%B2/3.png" style="zoom:67%;"></p>
<p><img src="/2020/06/05/react%E5%9F%BA%E7%A1%804%E6%8E%88%E6%9D%83%E4%B8%8E%E9%83%A8%E7%BD%B2/2.png" style="zoom:67%;"></p>
<p><img src="/2020/06/05/react%E5%9F%BA%E7%A1%804%E6%8E%88%E6%9D%83%E4%B8%8E%E9%83%A8%E7%BD%B2/4.png" style="zoom:80%;"></p>
<h3 id="Handling-Registration-Errors"><a href="#Handling-Registration-Errors" class="headerlink" title="Handling Registration Errors"></a>Handling Registration Errors</h3><p>现在来处理注册时出现的错误，利用try，catch</p>
<p>如果出现错误且错误码为400，那么就是说用户的操作出现了问题。我们需要在表单中提示一些错误的信息。</p>
<p>这里我们只能得到用户已经被注册了的错误。所以我们先克隆errors。然后让errors的username属性设置成ex.response.data，然后再实现更新。ex.response.data是服务器给我们报的错误</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">doSubmit = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> userService.register(<span class="keyword">this</span>.state.data);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ex.response &amp;&amp; ex.response.status === <span class="number">400</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> errors = &#123; ...this.state.errors &#125;;</span><br><span class="line">      errors.username = ex.response.data;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; errors &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/05/react%E5%9F%BA%E7%A1%804%E6%8E%88%E6%9D%83%E4%B8%8E%E9%83%A8%E7%BD%B2/5.png" style="zoom:80%;"></p>
<h3 id="Logging-in-a-User"><a href="#Logging-in-a-User" class="headerlink" title="Logging in a User"></a>Logging in a User</h3><p>我们先做登录页，登录页做好了我们做注册成功跳转页面这个功能。我们在postman中实现登录。发现返回了一堆代码，这其实是一种 ID card</p>
<p>实现逻辑是这样的：所以如果用户发送了合法的用户名和密码的组合给了服务器，服务器给用户一个认证卡。以后无论何时，用户都需要请求apiEndpoint，apiEndpoint需要认证这个用户，客户端会把这个token发给server，如果他是一个合法的token，服务器就会执行用户请求</p>
<p><img src="/2020/06/05/react%E5%9F%BA%E7%A1%804%E6%8E%88%E6%9D%83%E4%B8%8E%E9%83%A8%E7%BD%B2/6.png" style="zoom:80%;"></p>
<h3 id="Submitting-the-Login-Form"><a href="#Submitting-the-Login-Form" class="headerlink" title="Submitting the Login Form"></a>Submitting the Login Form</h3><p>首先新建一个authService.js 这里面封装了调用后端的post函数，并把promise返回</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">"./httpService"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; apiUrl &#125; <span class="keyword">from</span> <span class="string">"../config.json"</span>;</span><br><span class="line"><span class="keyword">const</span> apiEndpoint = apiUrl + <span class="string">"/auth"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params">email, password</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> http.post(apiEndpoint, &#123; email, password &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在loginForm.jsx中导入以后，我们重写doSubmit函数</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">doSubmit = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; data &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">    <span class="keyword">await</span> login(data.username, data.password);</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>那么我如果输入刚才登陆的账号密码，那么我们看到返回了一个token</p>
<p><img src="/2020/06/05/react%E5%9F%BA%E7%A1%804%E6%8E%88%E6%9D%83%E4%B8%8E%E9%83%A8%E7%BD%B2/7.png" style="zoom: 50%;"></p>
<h3 id="Handling-Login-Errors"><a href="#Handling-Login-Errors" class="headerlink" title="Handling Login Errors"></a>Handling Login Errors</h3><p>现在来处理登陆时发生的错误,利用try catch，逻辑和注册表单一样</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">doSubmit = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; data &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">    <span class="keyword">await</span> login(data.username, data.password);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ex.response &amp;&amp; ex.response.status === <span class="number">400</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> errors = &#123; ...this.state.errors &#125;;</span><br><span class="line">      errors.username = ex.response.data;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; errors &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/05/react%E5%9F%BA%E7%A1%804%E6%8E%88%E6%9D%83%E4%B8%8E%E9%83%A8%E7%BD%B2/8.png" style="zoom: 50%;"></p>
<h3 id="Storing-the-JWT-JSON-Token"><a href="#Storing-the-JWT-JSON-Token" class="headerlink" title="Storing the JWT(JSON Token)"></a>Storing the JWT(JSON Token)</h3><p> 我们得到了Token之后，现在我们应该把token保留在客户端。每个浏览器都有一个小型的本地数据库。这个数据库可以保存键值对</p>
<p>因为login函数（http.post）会返回一个promise对象，其中的data存放着返回的jwt，也就是我们想要的token，那么我们重命名它，然后存储到浏览器本地的小型数据库中。然后，点击提交的以后自动转回到首页</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> doSubmit = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; data &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">      <span class="keyword">const</span> &#123; <span class="attr">data</span>: jwt &#125; = <span class="keyword">await</span> login(data.username, data.password);</span><br><span class="line">      <span class="built_in">console</span>.log(jwt);</span><br><span class="line">      localStorage.setItem(<span class="string">"token"</span>, jwt);</span><br><span class="line">      <span class="keyword">this</span>.props.history.push(<span class="string">"/"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<h3 id="Logging-in-the-User-upon-Registration"><a href="#Logging-in-the-User-upon-Registration" class="headerlink" title="Logging in the User upon Registration"></a>Logging in the User upon Registration</h3><p>现在我们想从 Headers（服务器发给我的包的头部信息）中获取tokens，学会了这个就可以如何使用头部来传递信息了</p>
<p>为实现这个功能，我们对后端user.js进行修改</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">res</span><br><span class="line">   .header(<span class="string">"x-auth-token"</span>, token)</span><br><span class="line">   .header(<span class="string">"access-control-expose-headers"</span>, <span class="string">"x-auth-token"</span>)</span><br><span class="line">   .send(_.pick(user, [<span class="string">"_id"</span>, <span class="string">"name"</span>, <span class="string">"email"</span>]));</span><br></pre></td></tr></table></figure>
<p>我们修改registerForm.js中的doSubmit,让他从headers中获取token并且存入localStorage。最后跳转到首页</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">doSubmit = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> userService.register(<span class="keyword">this</span>.state.data);</span><br><span class="line">    <span class="built_in">console</span>.log(response);</span><br><span class="line">    localStorage.setItem(<span class="string">"token"</span>, response.headers[<span class="string">"x-auth-token"</span>]);</span><br><span class="line">    <span class="keyword">this</span>.props.history.push(<span class="string">'/'</span>)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ex.response &amp;&amp; ex.response.status === <span class="number">400</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> errors = &#123; ...this.state.errors &#125;;</span><br><span class="line">      errors.username = ex.response.data;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; errors &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>下面是console.log(response)打印出来的内容，我们就是从这个headers中获取token</p>
<p><img src="/2020/06/05/react%E5%9F%BA%E7%A1%804%E6%8E%88%E6%9D%83%E4%B8%8E%E9%83%A8%E7%BD%B2/11.png" style="zoom: 50%;"></p>
<h3 id="JSON-Web-Tokens-JWT"><a href="#JSON-Web-Tokens-JWT" class="headerlink" title="JSON Web Tokens (JWT)"></a>JSON Web Tokens (JWT)</h3><p><a href="https://jwt.io/" target="_blank" rel="noopener">https://jwt.io/</a></p>
<p>在这个网站我们可以验证我们得到的Token是否合法</p>
<p><img src="/2020/06/05/react%E5%9F%BA%E7%A1%804%E6%8E%88%E6%9D%83%E4%B8%8E%E9%83%A8%E7%BD%B2/12.png" style="zoom: 80%;"></p>
<p>我们看到和我注册的信息是一致的</p>
<p>这相当于一个JSON对象，利用Base64URL加密算法进行编码得到的结果。我们看到左边有刚刚的id，name，email，最后一行是创建的事件。这就是为什么JWT是一个ID card的原因了，他就像驾照活着护照。存放了很多用户的信息</p>
<p>蓝色部分只有服务器才有。除非服务器被hack了，他们是不能通过修改token来伪装的。</p>
<h3 id="Getting-the-Current-User"><a href="#Getting-the-Current-User" class="headerlink" title="Getting the Current User"></a>Getting the Current User</h3><p>下面我们来说说如何在本地得到token，解码它，然后读取装在信息，并且显示在导航栏上</p>
<p>npm i jwt-decode@2.2.0</p>
<p>在app.js中导入 jwt-decode</p>
<p>这样说吧，jwt-decode 导出了一个默认函数，然后我们把他叫做jwtDecode，我们随便叫他什么都可以。只要有辨识度即可</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwtDecode <span class="keyword">from</span> <span class="string">"jwt-decode"</span>;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123;&#125;;</span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> jwt = localStorage.getItem(<span class="string">"token"</span>);</span><br><span class="line">      <span class="keyword">const</span> user = jwtDecode(jwt);</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; user &#125;);</span><br><span class="line">    &#125;<span class="keyword">catch</span>(ex)&#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...同时，我们向NavBar中传递user信息</span></span><br><span class="line">    &lt;NavBar user=&#123;<span class="keyword">this</span>.state.user&#125; /&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/05/react%E5%9F%BA%E7%A1%804%E6%8E%88%E6%9D%83%E4%B8%8E%E9%83%A8%E7%BD%B2/13.png" style="zoom: 80%;"></p>
<h3 id="Displaying-the-Current-User-on-NavBar"><a href="#Displaying-the-Current-User-on-NavBar" class="headerlink" title="Displaying the Current User on NavBar"></a>Displaying the Current User on NavBar</h3><p>接下来我们实现：没有登陆就只显示Login和Register，登陆了就显示用户名和logout链接</p>
<p>首先我们在NavBar的()中把user解构出来，如果user非空，那么就显示user的名字和Logout按钮，否则就显示Login和Register</p>
<p>那我们就这样渲染，我们知道</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">          </span><br><span class="line"><span class="comment">//....</span></span><br><span class="line">		&#123;!user &amp;&amp; (</span><br><span class="line">            &lt;React.Fragment&gt;</span><br><span class="line">              &lt;NavLink className=<span class="string">"nav-item nav-link"</span> to=<span class="string">"/login"</span>&gt;</span><br><span class="line">                Login</span><br><span class="line">              &lt;<span class="regexp">/NavLink&gt;</span></span><br><span class="line"><span class="regexp">              &lt;NavLink className="nav-item nav-link" to="/</span>register<span class="string">"&gt;</span></span><br><span class="line"><span class="string">                Register</span></span><br><span class="line"><span class="string">              &lt;/NavLink&gt;</span></span><br><span class="line"><span class="string">            &lt;/React.Fragment&gt;</span></span><br><span class="line"><span class="string">          )&#125;</span></span><br><span class="line"><span class="string">          &#123;user &amp;&amp; (</span></span><br><span class="line"><span class="string">            &lt;React.Fragment&gt;</span></span><br><span class="line"><span class="string">              &lt;NavLink className="</span>nav-item nav-link<span class="string">" to="</span>/profile<span class="string">"&gt;</span></span><br><span class="line"><span class="string">                &#123;user.name&#125;</span></span><br><span class="line"><span class="string">              &lt;/NavLink&gt;</span></span><br><span class="line"><span class="string">              &lt;NavLink className="</span>nav-item nav-link<span class="string">" to="</span>/logout<span class="string">"&gt;</span></span><br><span class="line"><span class="string">                Logout</span></span><br><span class="line"><span class="string">              &lt;/NavLink&gt;</span></span><br><span class="line"><span class="string">            &lt;/React.Fragment&gt;</span></span><br><span class="line"><span class="string">          )&#125;</span></span><br><span class="line"><span class="string">//....</span></span><br></pre></td></tr></table></figure>
<p>但是这么做有个问题。我登陆以后返回首页，看到的还是login和register，只有当我重新刷新的时候，才会显示名字和logout。</p>
<p>这是因为在App组件当中，我们从本地获得JWT并且在cdm中解码了它，这个方法在程序的生命周期中只被调用了一次。为了解决这个问题，我们在登录和注册表单中，不要使用history的push方法来重定向</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.props.history.push(<span class="string">"/"</span>);</span><br></pre></td></tr></table></figure>
<p>我们要完全的重载应用.window.location强制重载。这样的结果就是App对象又会被Mount一次。这时候，我们的本地存储已经有JWT了，这样就可以解码它并且得到当前的user了</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.location = <span class="string">'/'</span>;</span><br></pre></td></tr></table></figure>
<h3 id="Logging-out-a-User"><a href="#Logging-out-a-User" class="headerlink" title="Logging out a User"></a>Logging out a User</h3><p>logging out 就是把本地的token删除。</p>
<p>首先我们注册这个路由，然后渲染一个logout组件。当这个组件被装载时，我们删掉本地的token，然后将用户重定向到主页</p>
<p>logout.jsx</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Logout</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    localStorage.removeItem(<span class="string">"token"</span>);</span><br><span class="line">      <span class="comment">//重定向</span></span><br><span class="line">    <span class="built_in">window</span>.location = <span class="string">"/"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Logout;</span><br></pre></td></tr></table></figure>
<p>然后注册路由之后。我们就可以正常退出了</p>
<h3 id="Refactoring"><a href="#Refactoring" class="headerlink" title="Refactoring"></a>Refactoring</h3><p>现在我们有很多的文件出现了token，以后我们如果想换其他键值，就会比较麻烦，所以我们只需要一个模块来完成授权工作，所有授权相关的都在那个模块当中。所以我们希望把保存和删除token的方法，放到authService当中。这样这个服务就是应用中唯一负责处理授权的地方。</p>
<p>authService.jsx</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">"./httpService"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; apiUrl &#125; <span class="keyword">from</span> <span class="string">"../config.json"</span>;</span><br><span class="line"><span class="keyword">import</span> jwtDecode <span class="keyword">from</span> <span class="string">"jwt-decode"</span>;</span><br><span class="line"><span class="keyword">const</span> apiEndpoint = apiUrl + <span class="string">"/auth"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params">email, password</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">data</span>: jwt &#125; = <span class="keyword">await</span> http.post(apiEndpoint, &#123; email, password &#125;);</span><br><span class="line">  localStorage.setItem(<span class="string">"token"</span>, jwt);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">loginWithJwt</span>(<span class="params">jwt</span>) </span>&#123;</span><br><span class="line">  localStorage.setItem(<span class="string">"token"</span>, jwt);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">logout</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  localStorage.removeItem(<span class="string">"token"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getCurrentUser</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> jwt = localStorage.getItem(<span class="string">"token"</span>);</span><br><span class="line">    <span class="keyword">return</span> jwtDecode(jwt);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  login,</span><br><span class="line">  logout,</span><br><span class="line">  getCurrenrUser,</span><br><span class="line">  loginWithJwt,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>App,loginForm,registerForm,logout中对于token的操作，都换成</p>
<p>import auth from “../services/authService”;  然后相对应引用auth.loginWithJwt, auth.login,  auth.logout, auth.getCurrentUser,…</p>
<p><strong>首先来看看App.js</strong>: 在cdm中调用getCurrentUser方法，从本地数据库中取出token并用user接受这个对象</p>
<p>然后更新user,如果当前没有token，那么就返回一个null值， user为null</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123;&#125;;</span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">const</span> user = auth.getCurrentUser();</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; user &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后来看loginForm：调用auth.login，authService会帮他提取出JWT并存储到本地数据库中</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//... </span></span><br><span class="line">doSubmit = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; data &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">      <span class="keyword">await</span> auth.login(data.username, data.password);</span><br><span class="line">      <span class="built_in">window</span>.location = <span class="string">"/"</span>;</span><br><span class="line"><span class="comment">//window.location 这和用户登录没关系，只是重定向可以调到主页也可以其他页，不管login的事</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">      <span class="keyword">if</span> (ex.response &amp;&amp; ex.response.status === <span class="number">400</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> errors = &#123; ...this.state.errors &#125;;</span><br><span class="line">        errors.username = ex.response.data;</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123; errors &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<p>registerForm:  调用loginWithJwt，authService接收headers中提取出来的JWT并存储到本地数据库中</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line">doSubmit = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> response = <span class="keyword">await</span> userService.register(<span class="keyword">this</span>.state.data);</span><br><span class="line">      <span class="built_in">console</span>.log(response);</span><br><span class="line">      auth.loginWithJwt(response.headers[<span class="string">"x-auth-token"</span>]);</span><br><span class="line">      <span class="built_in">window</span>.location = <span class="string">"/"</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<p>最后来看看logout: authService会删除本地的token</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line">componentDidMount() &#123;</span><br><span class="line">      auth.Logout();</span><br><span class="line">    <span class="built_in">window</span>.location = <span class="string">"/"</span>;<span class="comment">//同样不管logout函数的事情</span></span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<h3 id="Calling-Protected-API-Endpoints"><a href="#Calling-Protected-API-Endpoints" class="headerlink" title="Calling Protected API Endpoints"></a>Calling Protected API Endpoints</h3><p>受保护的终端要求用户认证或者登录，并且有明确的授权</p>
<p>后端 的config中的default.json中修改 “requiresAuth”: true 这样的话，如果是没有授权的用户就无法修改或者删除我后端数据库的内容了。</p>
<p>然后，我们需要给有token的用户授权。这个工作需要在httpServer中实现。因为这个模块的职责就是和终端进行http对话。现在我们添加一个配置一个信息，目的是让axios无论发送什么给服务器都带上这个头部</p>
<p>首先在authservice中写一个返回 JWT 的函数</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getJwt</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> localStorage.getItem(tokenKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后再httpService中添加以下配置，这样就实现了对注册用户的认证</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">axios.defaults.headers.common[<span class="string">'x-auth-token'</span>] = auth.getJwt();</span><br></pre></td></tr></table></figure>
<h3 id="Fixing-Bi-directional-Dependencies"><a href="#Fixing-Bi-directional-Dependencies" class="headerlink" title="Fixing Bi-directional Dependencies"></a>Fixing Bi-directional Dependencies</h3><p>我们在authService和httpService之间缔造了一个双向依赖关系，这是很危险的</p>
<p><img src="/2020/06/05/react%E5%9F%BA%E7%A1%804%E6%8E%88%E6%9D%83%E4%B8%8E%E9%83%A8%E7%BD%B2/14.png" style="zoom: 50%;"></p>
<p> 在这里，http更为重要，auth是建立在http之上的，所以我们既要在http中抹去对authService的依赖，又要在http中获取JWT。所以我们与其调用auth中的函数获取token，不如就直接跟auth说把token给我拿来，就像下面这张图</p>
<p><img src="/2020/06/05/react%E5%9F%BA%E7%A1%804%E6%8E%88%E6%9D%83%E4%B8%8E%E9%83%A8%E7%BD%B2/15.png" style="zoom: 50%;"></p>
<p>我们在httpService中写一个这个set函数，目的是获取到jwt并赋值给请求头</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setJwt</span>(<span class="params">jwt</span>)</span>&#123;</span><br><span class="line">  axios.defaults.headers.common[<span class="string">"x-auth-token"</span>] = jwt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后把这个函数导出</p>
<p>在authService中我们调用setJwt,把getJwt得到的结果来传入到这个函数。这样，httpService中就会得到我们的jwt了。解决了双向依赖</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.setJwt(getJwt);</span><br></pre></td></tr></table></figure>
<h3 id="Authorization"><a href="#Authorization" class="headerlink" title="Authorization"></a>Authorization</h3><p>在后端，我们实现了只有管理员才能删除电影的功能.这就相当于当后端收到一个删除电影的请求的时候，请确保用户被授权且是管理员，auth和admin是中间件函数</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">router.delete(<span class="string">"/:id"</span>, [auth, admin], <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> movie = <span class="keyword">await</span> Movie.findByIdAndRemove(req.params.id);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!movie)</span><br><span class="line">    <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">"The movie with the given ID was not found."</span>);</span><br><span class="line"></span><br><span class="line">  res.send(movie);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>auth函数的功能：首先他确认服务器的requiresAuth打开了没有，如果是关闭的，他会将控制权移交到下一个中间件函数，否则就读取头部信息中的 x-auth-token .如果没有token的话，我们就返回Access denied. No token provided。意思是没有办法验证。如果有token的话，就先验证这个token是不是合法，是就传递给另外一个，不是就返回Invalid token.</p>
<p>auth函数的实现如下</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">"jsonwebtoken"</span>);</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">"config"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!config.get(<span class="string">"requiresAuth"</span>)) <span class="keyword">return</span> next();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> token = req.header(<span class="string">"x-auth-token"</span>);</span><br><span class="line">  <span class="keyword">if</span> (!token) <span class="keyword">return</span> res.status(<span class="number">401</span>).send(<span class="string">"Access denied. No token provided."</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> decoded = jwt.verify(token, config.get(<span class="string">"jwtPrivateKey"</span>));</span><br><span class="line">    req.user = decoded;</span><br><span class="line">    next();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">    res.status(<span class="number">400</span>).send(<span class="string">"Invalid token."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>admin函数的其实要检测设置，如果配置关闭，就传递控制权，不做任何事情；否则就检测是否用户为管理员，如果不是管理员，那么就返回 Access denied</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">"config"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 401 Unauthorized</span></span><br><span class="line">  <span class="comment">// 403 Forbidden</span></span><br><span class="line">  <span class="keyword">if</span> (!config.get(<span class="string">"requiresAuth"</span>)) <span class="keyword">return</span> next();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!req.user.isAdmin) <span class="keyword">return</span> res.status(<span class="number">403</span>).send(<span class="string">"Access denied."</span>);</span><br><span class="line"></span><br><span class="line">  next();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>如果授权的话我们呢需要在数据库中修改</p>
<p><img src="/2020/06/05/react%E5%9F%BA%E7%A1%804%E6%8E%88%E6%9D%83%E4%B8%8E%E9%83%A8%E7%BD%B2/16.png" style="zoom: 80%;"></p>
<p>设置好后，重新登入，那么就可以删除movie了</p>
<h3 id="Showing-or-Hiding-Elements-based-on-the-User"><a href="#Showing-or-Hiding-Elements-based-on-the-User" class="headerlink" title="Showing or Hiding Elements based on the User"></a>Showing or Hiding Elements based on the User</h3><p>现在我们想让没有登陆的用户看不到Delete，New Movie 按钮</p>
<p>在App中设置movie的路由.我们不能直接传入user进去，为了给子组件传递属性，我们要用到render</p>
<p>我们用render替换component,用箭头函数传入props，返回Movies组件，在movies组件当中加入所有的props还有当前的user属性</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;Route</span><br><span class="line">  path=<span class="string">"/movies"</span></span><br><span class="line">  render=&#123;(props) =&gt; <span class="xml"><span class="tag">&lt;<span class="name">Movies</span> &#123;<span class="attr">...props</span>&#125; <span class="attr">user</span>=<span class="string">&#123;this.state.user&#125;</span> /&gt;</span></span>&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>
<p>然后在movies的 new movies中，我们这样修改（在上面已经解构了）.只有当user存在，我们才可以说把这个NewMovie渲染出来</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;user &amp;&amp; (</span><br><span class="line">   &lt;Link</span><br><span class="line">     to=<span class="string">"/movies/new"</span></span><br><span class="line">     className=<span class="string">"btn btn-primary"</span></span><br><span class="line">     style=&#123;&#123; <span class="attr">marginBottom</span>: <span class="number">20</span> &#125;&#125;</span><br><span class="line">   &gt;</span><br><span class="line">     New Movie</span><br><span class="line">   &lt;<span class="regexp">/Link&gt;</span></span><br><span class="line"><span class="regexp"> )&#125;</span></span><br></pre></td></tr></table></figure>
<p>同理，我们可以隐藏Delete</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">content: <span class="function"><span class="params">movie</span> =&gt;</span> (</span><br><span class="line">  <span class="keyword">this</span>.props.user&amp;&amp;(</span><br><span class="line">      &lt;button</span><br><span class="line">    onClick=&#123;() =&gt; <span class="keyword">this</span>.props.onDelete(movie)&#125;</span><br><span class="line">    className=<span class="string">"btn btn-danger btn-sm"</span></span><br><span class="line">	  &gt;</span><br><span class="line">    Delete</span><br><span class="line">  &lt;<span class="regexp">/button&gt;)</span></span><br><span class="line"><span class="regexp">)</span></span><br></pre></td></tr></table></figure>
<p>效果图</p>
<p><img src="/2020/06/05/react%E5%9F%BA%E7%A1%804%E6%8E%88%E6%9D%83%E4%B8%8E%E9%83%A8%E7%BD%B2/18.png" style="zoom: 80%;"></p>
<h3 id="Protecting-Routes"><a href="#Protecting-Routes" class="headerlink" title="Protecting Routes"></a>Protecting Routes</h3><p>但直接隐藏并不能阻止新建电影，因为可以直接通过输入网站来访问路由</p>
<p>所以我们来看看怎么保护这个路由(初步实现)，没有办法再每个route中都重复这个逻辑</p>
<p>逻辑和刚才的一样（我们在上面已经结构了user),传入props，判断是否存在user，如果不存在，那么就重定向为login页面，存在那么渲染 MovieForm组件</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;Route</span><br><span class="line">  path=<span class="string">"/movies/:id"</span></span><br><span class="line">  render=&#123;(props) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!user) <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Redirect</span> <span class="attr">to</span>=<span class="string">"/login"</span> /&gt;</span></span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">MovieForm</span> &#123;<span class="attr">...props</span>&#125; /&gt;</span></span>;</span><br><span class="line">  &#125;&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>
<h3 id="Extracting-PrivateRoute"><a href="#Extracting-PrivateRoute" class="headerlink" title="Extracting PrivateRoute"></a>Extracting PrivateRoute</h3><p>我们这里想把前面的逻辑封装成一个组件</p>
<p>PrivateRoute.jsx:返回一个标准的React Route。</p>
<p>原来的path现在已经囊括到{…rest}当中去了，render中我们要把!user 改成!auth.getCurrentUser()</p>
<p>除此之外，我们还需要判断当前的Component是否存在。因为在App.js当中，要么设置component要么设置render，所以如果有component，那么就返回继承了所有props的component，否则就继承所有props的render</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> auth <span class="keyword">from</span> <span class="string">"../services/authService"</span>;</span><br><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Route, Redirect &#125; <span class="keyword">from</span> <span class="string">"react-router-dom"</span>;</span><br><span class="line"><span class="keyword">const</span> PrivateRoute = <span class="function">(<span class="params">&#123;  component: Component, render, ...rest &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Route</span><br><span class="line">      &#123;...rest&#125;</span><br><span class="line">      render=&#123;(props) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (!auth.getCurrentUser()) <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Redirect</span> <span class="attr">to</span>=<span class="string">"/login"</span> /&gt;</span></span>;</span><br><span class="line">        <span class="keyword">return</span> Component ? <span class="xml"><span class="tag">&lt;<span class="name">Component</span> &#123;<span class="attr">...props</span>&#125; /&gt;</span></span> : render(props);</span><br><span class="line">      &#125;&#125;</span><br><span class="line">    /&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> PrivateRoute;</span><br></pre></td></tr></table></figure>
<p>然后我们在app.js中引入的时候，对之前的进行修改. </p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;PrivateRoute path=<span class="string">"/movies/:id"</span> component=&#123;MovieForm&#125; /&gt;</span><br></pre></td></tr></table></figure>
<p>现在如果我们点击movie的名字，那么我们不会跳到MovieForm表单，我们会跳到Login表单</p>
<h3 id="Redirecting-after-Login"><a href="#Redirecting-after-Login" class="headerlink" title="Redirecting after Login"></a>Redirecting after Login</h3><p>我们现在点击movie名字，登录好以后，不想再回到主页了，我想到这个movie的表单当中去，怎么办？</p>
<p>我们首先打印一下这个组件的props</p>
<p><img src="/2020/06/05/react%E5%9F%BA%E7%A1%804%E6%8E%88%E6%9D%83%E4%B8%8E%E9%83%A8%E7%BD%B2/19.png" style="zoom: 80%;"></p>
<p>我们发现在location中的pathname是有效的，我们就要重定向到这条路径。Redirect中我们把to设置成一个对象</p>
<p>我们首先传入一个pathname，这是默认的，我们也要设置state属性，这是用来传递附加数据的。我再这个state当中传入一个from属性把它设置为props.location 因为这个location对象保留了用户跳转前的 位置信息</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> (</span><br><span class="line">    &lt;Route</span><br><span class="line">      &#123;...rest&#125;</span><br><span class="line">      render=&#123;(props) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (!auth.getCurrentUser())</span><br><span class="line">          <span class="keyword">return</span> (</span><br><span class="line">            &lt;Redirect</span><br><span class="line">              to=&#123;&#123;</span><br><span class="line">                pathname: <span class="string">"/login"</span>,</span><br><span class="line">                state: &#123; <span class="attr">from</span>: props.location &#125;,</span><br><span class="line">              &#125;&#125;</span><br><span class="line">            /&gt;</span><br><span class="line">          );</span><br><span class="line">        <span class="keyword">return</span> Component ? <span class="xml"><span class="tag">&lt;<span class="name">Component</span> &#123;<span class="attr">...props</span>&#125; /&gt;</span></span> : render(props);</span><br><span class="line">      &#125;&#125;</span><br><span class="line">    /&gt;</span><br><span class="line">  );</span><br></pre></td></tr></table></figure>
<p>然后我们转到loginForm去看看是否state已经设置了，如果设置了我们就取location中的pathname；如果state没有被设置，那么就回到主页当中.</p>
<p><img src="/2020/06/05/react%E5%9F%BA%E7%A1%804%E6%8E%88%E6%9D%83%E4%B8%8E%E9%83%A8%E7%BD%B2/20.png" style="zoom: 80%;"></p>
<p>比如上图，我是直接点击login进入LoginForm的，那么这时候state就不会被设置，那么登陆过后就直接跳转主页</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">doSubmit = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;    </span><br><span class="line">    <span class="keyword">const</span> &#123; data &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">    <span class="keyword">await</span> auth.login(data.username, data.password);</span><br><span class="line">    <span class="keyword">const</span> &#123; state &#125; = <span class="keyword">this</span>.props.location</span><br><span class="line">    <span class="built_in">window</span>.location = state ? state.from.pathname : <span class="string">"/"</span>; </span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">  &#125;<span class="keyword">catch</span>(ex)&#123;<span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在还需要注意到，在登陆状态下如果我们直接输入login，还是会跳转到login表单。所以在login表单我们要做一个重定向</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (auth.getCurrentUser()) <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Redirect</span> <span class="attr">to</span>=<span class="string">"/"</span> /&gt;</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="Exercise"><a href="#Exercise" class="headerlink" title="Exercise"></a>Exercise</h3><p>现在我们要实现只有admin才能显示delete按钮（刚才是只要是用户就能显示）</p>
<h3 id="Hiding-the-Delete-Column"><a href="#Hiding-the-Delete-Column" class="headerlink" title="Hiding the Delete Column"></a>Hiding the Delete Column</h3><p>有几种方法隐藏这个Delete 列，一种方法是添加一个属性如visible或者hidden来动态控制它，这个方法需要修改好几个组件；还有一种方法是将这个Delete列直接删除，只在当前用户是管理员的情况下才添加进来，这个方法相对简单</p>
<p>我们为了不污染constructor，把delete列单独设置成了deleteColumn对象。然后写一个constructor，利用auth.getCurrentUser()获取当前的user</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">deleteColumn = &#123;</span><br><span class="line">   key: <span class="string">"delete"</span>,</span><br><span class="line">   content: <span class="function"><span class="params">movie</span> =&gt;</span> (</span><br><span class="line">     &lt;button</span><br><span class="line">       onClick=&#123;() =&gt; <span class="keyword">this</span>.props.onDelete(movie)&#125;</span><br><span class="line">       className=<span class="string">"btn btn-danger btn-sm"</span></span><br><span class="line">     &gt;</span><br><span class="line">       Delete</span><br><span class="line">     &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">   )</span></span><br><span class="line"><span class="regexp"> &#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp"> constructor() &#123;</span></span><br><span class="line"><span class="regexp">   super();</span></span><br><span class="line"><span class="regexp">   const user = auth.getCurrentUser();</span></span><br><span class="line"><span class="regexp">   if (user &amp;&amp; user.isAdmin) this.columns.push(this.deleteColumn);</span></span><br><span class="line"><span class="regexp"> &#125;</span></span><br></pre></td></tr></table></figure>
<p>我们设置mosh为管理员：再mongodb中添加 isAdmin: true </p>
<p><img src="/2020/06/05/react%E5%9F%BA%E7%A1%804%E6%8E%88%E6%9D%83%E4%B8%8E%E9%83%A8%E7%BD%B2/21.png" style="zoom: 80%;"></p>
<h2 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h2><h3 id="Introduction-1"><a href="#Introduction-1" class="headerlink" title="Introduction"></a>Introduction</h3><h3 id="Environment-Variables"><a href="#Environment-Variables" class="headerlink" title="Environment Variables"></a>Environment Variables</h3><h3 id="Production-Builds"><a href="#Production-Builds" class="headerlink" title="Production Builds"></a>Production Builds</h3><h3 id="Getting-Started-with-Heroku"><a href="#Getting-Started-with-Heroku" class="headerlink" title="Getting Started with Heroku"></a>Getting Started with Heroku</h3><h3 id="MongoDB-in-the-Cloud"><a href="#MongoDB-in-the-Cloud" class="headerlink" title="MongoDB in the Cloud"></a>MongoDB in the Cloud</h3><p>云数据库</p>
<h3 id="Adding-Code-to-a-Git-Repository"><a href="#Adding-Code-to-a-Git-Repository" class="headerlink" title="Adding Code to a Git Repository"></a>Adding Code to a Git Repository</h3><h3 id="Deploying-to-Heroku"><a href="#Deploying-to-Heroku" class="headerlink" title="Deploying to Heroku"></a>Deploying to Heroku</h3><h3 id="Viewing-Logs"><a href="#Viewing-Logs" class="headerlink" title="Viewing Logs"></a>Viewing Logs</h3><h3 id="Setting-Environment-Variables-on-Heroku"><a href="#Setting-Environment-Variables-on-Heroku" class="headerlink" title="Setting Environment Variables on Heroku"></a>Setting Environment Variables on Heroku</h3><h3 id="Preparing-the-Font-end-for-Deployment"><a href="#Preparing-the-Font-end-for-Deployment" class="headerlink" title="Preparing the Font-end for Deployment"></a>Preparing the Font-end for Deployment</h3><h3 id="Deploying-the-Front-end"><a href="#Deploying-the-Front-end" class="headerlink" title="Deploying the Front-end"></a>Deploying the Front-end</h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://jasonxqh.github.io/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason‘s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/" class="post-title-link" itemprop="url">离散数学之关系2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-05 11:31:09" itemprop="dateCreated datePublished" datetime="2020-06-05T11:31:09+08:00">2020-06-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-09-06 10:05:12" itemprop="dateModified" datetime="2020-09-06T10:05:12+08:00">2020-09-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="离散数学之关系2"><a href="#离散数学之关系2" class="headerlink" title="离散数学之关系2"></a>离散数学之关系2</h1><p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/1.png" style="zoom:80%;"></p>
<h2 id="Closures-of-Relations-闭包"><a href="#Closures-of-Relations-闭包" class="headerlink" title="Closures of Relations 闭包"></a>Closures of Relations 闭包</h2><p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/2.png" style="zoom:80%;"></p>
<p>设R是非空集合A上的关系，在关系R中，可能有或无性质P，如自反(r)，对称(s)，传递(t)，若存在包含R，满足性质P的关系S，使得S是所有包含R，满足P的关系的子集，那么称S是R关于P的闭包（有时这样的闭包不存在）</p>
<p>所以我原来R可能不是闭包，但是我可以往里面加点东西，让它变成一个闭包。加进去的东西和原来的R就构成了我们的S</p>
<h3 id="自反闭包"><a href="#自反闭包" class="headerlink" title="自反闭包"></a><strong>自反闭包</strong></h3><p>如果我们要满足自反性，那么(a,a) 一定要属于R，所以我们把小于改成小于等于即可</p>
<p>自反闭包在图中表现为自环。让我们补全要素称为自反闭包可以是集合形式也可以是图的形式。</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/3.png" style="zoom:80%;"></p>
<p>如果R是自反性的，那么 $R^{*}$ 也是自反的。因为\</p>
<p>$R\subseteq R^<em>,(a,a)\in R\Rightarrow (a,a)\in R^</em>$ </p>
<p>但是请注意，如果R是irreflexive的，也就是$(a,a)\notin R$ 但是 $R^2$ 却不一定是irreflexive的，比如说R对角线上全是0，然后其余部分都是1，也就是说如果$(a,b)\in R, (b,a)\in R$ 那么$(a,a)\in R\circ R = R^2,(b,b)\in R\circ R = R^2$</p>
<h3 id="对称闭包"><a href="#对称闭包" class="headerlink" title="对称闭包"></a>对称闭包</h3><p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/4.png" style="zoom:80%;"></p>
<p>那么在图上又如何展示对称闭包呢？因为(a,b)在关系内，(b,a)也一定要在关系内，所以在图中表现为只要两点直接又连线，那么这个连线一定要有两根，a指向b，b指向a</p>
<p>如果R是对称的，那么$R^*$ 也是对称的：</p>
<p>假设让$(a,b)\in R^<em>$, 那么a和b之间存在一组有序对$(s<em>0,s_1)\in R,(s_1,s_2)\in R,\cdots(s</em>{j-1},s<em>j)\in R$ ,起点是a，终点是b。那么因为$R$ 是对称的，所以必然有$(s_j,s</em>{j-1})\in R,(s<em>{j-1},s</em>{j-2})\in R,\cdots(s_2,s_1)\in R$<br>这就说明，从b到a也有一条path存在，于是 $(b,a)\in R^</em>$ ,得证。</p>
<h3 id="传递闭包"><a href="#传递闭包" class="headerlink" title="传递闭包"></a>传递闭包</h3><p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/5.png" style="zoom:80%;"></p>
<p>图G可以看作是一个关系，path可以看作是一条路径。$X_0$ 是起点， $X_n$ 是终点，一共走了n条边</p>
<p>$X<em>0,X_1…X</em>{n-1}$ 可以是一样的，是可能等于a的，也可能等于b，如果k出现了两次那么意味着先走到$X_k$绕了一圈又回到了$X_k$ 那么就说明这个路径中有一个环。如果a和b是同一个顶点，那么就是a出发绕了一圈回到了a，这就是个环。</p>
<p>path的长度为n，说明走了n步一定是可以到达目的地的，所以对应的位置上一定是1</p>
<h4 id="定理1："><a href="#定理1：" class="headerlink" title="定理1："></a>定理1：</h4><p>这就是说R的基础上构造了一个新的关系$R^n$。 R是集合A当中的一个关系。那么如果 有一条a到b之间长度为n的路径的话，那么 (a,b)就属于$R^n$ </p>
<p>可以用数学归纳法证明：</p>
<p>如果path长度为1，那么$(a,b)\in R$ 成立，假设当 n=k的时候成立，那么当n=k+1的时候，找一点c,把原来的路线拆成两段，$(a,c)\in R,(c,b)\in R^n$ 那么根据复合法则，$(a,b)\in R^{n+1}$</p>
<p>如果$(a,b)\in R^n$那么<strong>至少</strong>存在一个长度为n的path，从a点（起点）走到b点（终点）</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/6.png" style="zoom:80%;"></p>
<h4 id="connectivity-relation-连接关系"><a href="#connectivity-relation-连接关系" class="headerlink" title="connectivity relation 连接关系"></a>connectivity relation 连接关系</h4><p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/7.png" style="zoom:80%;"></p>
<p>这个$R^<em>$ 的意思是说这条路径可长可短(至少为1)，无法确定。R\</em> 包含的是a到b的可达，只要a走到b就可以了，走多长的路我不管。$R^*$ 是很难算的，因为这是1到无穷</p>
<p>下面这个例子：$R^n$ 的意思就是 a通过n-1 个人可以认识b,$R^*$ 则是a可以认识b，但是不知道要通过多少人</p>
<h4 id="定理2："><a href="#定理2：" class="headerlink" title="定理2："></a>定理2：</h4><p>$R$的传递闭包，就是$R^*$  </p>
<p>原来的R可能不满足传递性，但是我们可以通过往里面加点什么让他满足，这是闭包的定义</p>
<p>那么包含R，且<strong>满足传递性</strong>的<strong>最小的</strong>那个关系就叫做传递闭包。所谓最小的，就是任意拿一个包含R的传递关系过来都是R*的超集。</p>
<p>证明：</p>
<p>首先要证明R*具有传递性</p>
<p>其次要证明R*属于S</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/8.png" style="zoom:80%;"></p>
<p>证明  S 是具有传递关系的，那么 $S^n$ 也是具有传递关系的</p>
<p>现在我假设 $(x,y)\in S^n,(y,z)\in S^n$  我希望得到$(x,z)\in S^n$ 这个结论</p>
<p>因为$S^n \in S$ 所以 当n=1，2，3…的时候都满足。</p>
<p>现在 已经知道 x到y有n步，也就是说有n-1个内部节点。我们可以画出类似简图</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/26.png" style="zoom:80%;"></p>
<p>同样，从y到z也可以画出一个相应的草图，所以(x,z)可以先从x走n-1步走到y，然后再从y一步走到z，这样$(x,z)\in S^n=S^{n-1} o S$  就满足了 </p>
<h4 id="计算方法1"><a href="#计算方法1" class="headerlink" title="计算方法1"></a>计算方法1</h4><h5 id="引理1"><a href="#引理1" class="headerlink" title="引理1"></a>引理1</h5><p>A中有n个元素，那么如果有一条path从a走向b，那么这条path不会超过n</p>
<p>更进一步来说，如果a!=b的话，那么这条path长度不会超过n-1</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/9.png" style="zoom:80%;"></p>
<h5 id="定理3"><a href="#定理3" class="headerlink" title="定理3"></a>定理3</h5><p>从引理可以知道我们没有必要把$R<em>1,R_2,R</em>{\infty}$ 都并起来，我们只需要<strong>并到n即可求出传递闭包</strong>。因为最多往前走n步嘛</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/10.png" style="zoom:80%;"></p>
<p>例子：</p>
<p>如果我们要找3个顶点的传递闭包，我们只要算3个矩阵相并即可</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/11.png" style="zoom:80%;"></p>
<h5 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h5><p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/12.png" style="zoom:80%;"></p>
<p>这个复杂度很高，有$O(n^4)$ </p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/18.png" style="zoom:80%;"></p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/22.png" style="zoom:80%;"></p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/23.png" style="zoom:80%;"></p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/24.png" style="zoom:80%;"></p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/25.png" style="zoom:80%;"></p>
<h4 id="计算方法2"><a href="#计算方法2" class="headerlink" title="计算方法2"></a>计算方法2</h4><h5 id="内部顶点："><a href="#内部顶点：" class="headerlink" title="内部顶点："></a>内部顶点：</h5><p>位于起点和终点之间的节点都是内部节点</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/13.png" style="zoom:80%;"></p>
<p>我们定义一个01矩阵W，令$W<em>0= M_R$ ,那么 我们可以给出如上$W</em>{ij}^k$ 的定义</p>
<p>$W^1$也就是说如果$X<em>i,X_j$ 可以通过$v_1$连起来的，$W</em>{ij}$取1，或者$X_i,X_j$直接可以到达的，那也可以取1，否则取0.所以$W^1$只保留了$X_i$通过$v_1$到达$X_j$ 的 $v_1$相当于 它们之间的桥梁。 $W_2$就是以此类推，通过$v_1,v2$ ,$X_i$可以到达$X_j$</p>
<p>那么$W<em>n$ 的话，我们 的中间节点就有$V_1,V_2…V_n$ ，所以说$W^n</em>{ij}$当中当且仅当$X_i$到$X_j$存在path(内部顶点可以取$V_1,V_2…V_n$)的时候，取1,否则取0。</p>
<p>那么我们就可以说 $W^n$ 就是 R 的传递闭包。</p>
<p><strong>例子：</strong></p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/14.png" style="zoom:80%;"></p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/15.png" style="zoom:80%;"></p>
<h5 id="引理"><a href="#引理" class="headerlink" title="引理"></a>引理</h5><p>要么本来$V_i,V_j$就能连在一起，要么就是加入了k点之后能够连在一起</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/16.png" style="zoom:80%;"></p>
<h5 id="算法："><a href="#算法：" class="headerlink" title="算法："></a>算法：</h5><p>初始状态就是$M_R$ 然后一个节点一个结点得加进去，三重循环。比原来的$O(n^4)$降低了一个数量级、</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/17.png" style="zoom:80%;"></p>
<p><strong>例题：</strong></p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/45.png" style="zoom:80%;"></p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/46.png" style="zoom:80%;"></p>
<p>我们用第二个算法做题的格式：</p>
<p>1：列出 R 中的关系对 ，列出节点个数。</p>
<p>2：加入第一个节点，看关系对中有无以第一个节点结尾和开头的元素，将其连接。并在矩阵上标为1。以此类推。比如说上面这个例子，我加入第三个节点，那么我发现$(2,3)$是以3结尾的,$(3,1),(3,4)$是以3开头的，于是我们就可以连接$(2,1),(2,4)$ ; 同理在加入节点4的时候，我发现$(3,4)$是以4 结尾的,$(4,3)$ 是以4开头的，于是$(3,3)$可以在矩阵中标出。</p>
<p>注：有几个节点就加入几次，最后就可以得到传递闭包。</p>
<h2 id="Equivalence-relations"><a href="#Equivalence-relations" class="headerlink" title="Equivalence relations"></a>Equivalence relations</h2><p>如果一个关系同时满足自反性，对称性和传递性这三个性质，我们就把它叫做等价关系</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/27.png" style="zoom:90%;"></p>
<p>这样的关系有很多。比如等于号，同龄，相似，全等，来自于同一个城市等</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/29.png" style="zoom:90%;"></p>
<h3 id="Equivalence-Classes-等价类"><a href="#Equivalence-Classes-等价类" class="headerlink" title="Equivalence Classes 等价类"></a>Equivalence Classes 等价类</h3><p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/28.png" style="zoom:80%;"></p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/30.png" style="zoom:80%;"></p>
<h3 id="Equivalence-Classes-and-Partitions"><a href="#Equivalence-Classes-and-Partitions" class="headerlink" title="Equivalence Classes and Partitions"></a>Equivalence Classes and Partitions</h3><h4 id="Theorem"><a href="#Theorem" class="headerlink" title="Theorem"></a>Theorem</h4><p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/31.png" style="zoom:80%;"></p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/32.png" style="zoom:80%;"></p>
<p>这个定理说明了对所有a里面的元素的等价类都找出来然后求并集，一定等于A</p>
<p>两个等价类中要么没有公共的元素，只要有公共的元素，那么这两个等价类必然相等</p>
<p>这说明了另外一个概念。</p>
<h4 id="Partition"><a href="#Partition" class="headerlink" title="Partition"></a>Partition</h4><p><strong>Denition</strong></p>
<p>一个集合的partition就是由其中的不相交的子集构成的，如下图。</p>
<p>如果这些子集满足partition，那么一定满足以下三点条件 </p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/33.png"></p>
<p>实际上我们可以根据等价类对这个集合求partition</p>
<p>有了等价关系，就有了等价类，所有的等价类构成了集合A的partition</p>
<p>同样如果有一个partition，我们肯定可以导出一个等价类。下面是一个定理：</p>
<p>给定一个partition，有一个等价关系R，他以$A_i$作为等价类</p>
<p>证明其自反性，对称性和传递性即可</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/34.png"></p>
<p><strong>例一</strong></p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/35.png"></p>
<p><strong>例二</strong></p>
<p>有一个比特串组成的集合。</p>
<p>有关系$sR_nt$ ，要么s = t ,要么 前n个字符一样。</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/36.png"></p>
<h2 id="Partial-orderings-偏序关系"><a href="#Partial-orderings-偏序关系" class="headerlink" title="Partial orderings 偏序关系"></a>Partial orderings 偏序关系</h2><p>如果一个关系R满足自反性，反对称性，和传递性。那么R就是一个偏序关系</p>
<p>包含关系R的集合S被叫做偏序集，记作(S,R)</p>
<p>偏序关系中的元素满足一下三个条件</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/37.png"></p>
<p>A relation R on a set S is a partial ordering if the relation R is reflexice,antisymmetric,and transitive,then (S,R) is called a <strong>poset</strong> </p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/39.png"></p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/38.png"></p>
<p>这里定义了新的关系，叫做偏序关系，a小于等于b</p>
<p><strong>例题5：</strong> </p>
<p>Is （S，R) a poset if S is the set of all people  in the world and $(a,b)\in R$ ,where a and b are people,if a is not taller than b?</p>
<p>这里我们要区分人和他们的属性，a is not taller than b 确实可以让 a和b的身高相等，但是并不能让a=b，两个人的身高相同不意味着两个就是同一个人！</p>
<p>if  a and b do not have a common friend?</p>
<p>很明显这不符合自反性，(a,a) 带入就会自相矛盾。</p>
<p>所以我们判断一个关系是否为偏序关系，必须分清本体和属性的区别和三个性能是否满足。</p>
<h4 id="Comparable"><a href="#Comparable" class="headerlink" title="Comparable"></a>Comparable</h4><p>元素 a和b在这个偏序关系，如果a小于等于b或者b小于等于a，那么(a,b)就是可比较的。否则如果不知道哪个小于等于哪个，那么就是不可比较的</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/40.png" style="zoom:80%;"></p>
<p>比如说在正整数中的整除关系，拿出来两个数3，9 那么3小于等于9，说明这两个元素是可比较的。如果拿出来的是5和7那么它们不可比较的。</p>
<p>所以我们可以知道 正整数上的整除关系并不是一个全序集。全序集就是任意拿出来两个元素都可以比较的。</p>
<p>所以偏序集又可以分为全续集和非全序集</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/41.png" style="zoom:80%;"></p>
<p>现在我们来看一下字典顺序。我们假设有一个偏序关系是定义在正整数集和正整数集的笛卡尔集上面的，</p>
<p>(a1,a2)是集合中的一个元素。现在我们定义一个关系如下。</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/42.png" style="zoom:80%;"></p>
<p>我们称这个关系为字典顺序。为什么要叫字典顺序？因为这就像我们查字典一样，如果我们要查order，我们就直接看o，因为a，b这些开头的 都在o的前面。</p>
<p>这个集合也是一个良序集，良序集的意思就是存在最小的一个元素，这里是(1,1) 那么ZXZ这个笛卡尔集就不是了，因为整数的笛卡尔集不存在最小的元素</p>
<p>我们可以定义两个，也可以定义n个元素</p>
<h4 id="Totally-ordered-全序集"><a href="#Totally-ordered-全序集" class="headerlink" title="Totally ordered 全序集"></a>Totally ordered 全序集</h4><p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/43.png" style="zoom:100%;"></p>
<p>全序集 就是一个线性的偏序结构。任何两个元素都能够进行比较。因为我们总是可以知道谁在前谁在后，所以我们也可以把全续集叫做链</p>
<p>如果偏序关系，而且也是个全序集，又满足每一个非空的子集都可以找出来最小的元素，那么我们就可以把这个集合叫做良序集。良序集一定可以拿到第一个元素，找到一个开头的元素。</p>
<h4 id="The-principle-of-well-ordered-induction"><a href="#The-principle-of-well-ordered-induction" class="headerlink" title="The principle of well-ordered induction"></a>The principle of well-ordered induction</h4><p>良序集的应用：数学归纳法。</p>
<p>自然数集是一个良序集。这要这个集基于良序集，那么数学归纳法都是对的，所以我们可以定义<strong>字典序集</strong>上的数学归纳法。</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/44.png" style="zoom:100%;"></p>
<h3 id="Lexicographic-ordering"><a href="#Lexicographic-ordering" class="headerlink" title="Lexicographic ordering"></a>Lexicographic ordering</h3><p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/47.png" style="zoom: 80%;"></p>
<p>这里定义了一个整数和整数的笛卡尔集上的偏序关系，lexicographic就是词典顺序。</p>
<p>比如： Find the lexicographic ordering of these n-tuples:</p>
<p>a) (1,1,2) ,(1,2,1)  b)  (0,1,2,3) ,(0,1,3,2)   c) (1,0,1,0,1),(0,1,1,1,0)</p>
<p>这个方法我们就一个一个比，按照词典顺序排列：</p>
<p>对于a） 1=1 ，1&lt;2  所以 (1,1,2) &lt; (1,2,1)</p>
<p>b) 0=0,1=1,2&lt;3. 所以 (0,1,2,3)&lt; (0,1,3,2) </p>
<p>c) 1&gt;0 所以(1,0,1,0,1) &gt; (0,1,1,1,0)</p>
<h3 id="Hasse-diagrams"><a href="#Hasse-diagrams" class="headerlink" title="Hasse diagrams"></a>Hasse diagrams</h3><p>哈塞图是偏序关系的一种表达关系，而且更简洁</p>
<h4 id="Definition"><a href="#Definition" class="headerlink" title="Definition"></a>Definition</h4><p>偏序关系满足自反性，反对称性和传递性。所以一定是每个定点上都有自环。</p>
<p><strong>第一步</strong>就去掉所有的自环。</p>
<p><strong>第二步</strong>，如果两步可达的顶点，那么就要把<strong>一步可达</strong>的边给删掉。最后我们要把最小的放在下面，最大的放到上面，这样就可以去掉箭头了。</p>
<p>哈塞图一定是对于偏序关系来说的，上面的结点一定比下面的结点要大</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/48.png" style="zoom: 80%;"></p>
<h4 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h4><p>比如下面这一幅图，我们要把它变成哈塞图。第一步去掉所有的环。第二步所有两步并作一步走的边全部都去掉，最后去掉箭头。</p>
<p>Draw the Hasse diagram representing the partial ordering<br>${(a,b)|a divides b} on {1, 2, 3, 4, 6, 8, 12}$</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/1.jpg" style="zoom: 67%;"></p>
<h3 id="Maximal-and-minimal-elements"><a href="#Maximal-and-minimal-elements" class="headerlink" title="Maximal and minimal elements"></a>Maximal and minimal elements</h3><p>极大元和极小元的定义不是最大和最小的元素。还要看看能不能比较。看这里，12和20是不能比较的，所以定义是找不到一个比他更大的元素（找不到一个比它更小的）</p>
<p>这里12，20，25 是极大元，2，5是极小元。没有最大元和最小元</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/49.png" style="zoom: 80%;"></p>
<h3 id="Greatest-and-least-elements"><a href="#Greatest-and-least-elements" class="headerlink" title="Greatest and least elements"></a>Greatest and least elements</h3><p>最大元和最小元所有的元素都小于等于或大于等于该元素</p>
<p>下面四张哈塞图。</p>
<p>a是有最小元，但是没有最大元；</p>
<p>b没有最小元，也没有最大元；</p>
<p>c没有最小元，最大元是d；</p>
<p>d既有最小元又有最大元</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/50.png" style="zoom: 80%;"></p>
<h3 id="Upper-and-lower-bounds上界和下界"><a href="#Upper-and-lower-bounds上界和下界" class="headerlink" title="Upper and lower bounds上界和下界"></a>Upper and lower bounds上界和下界</h3><p>对于一个集合内每个元素都要大或等于的，就是它的上界；对于这个集合内每个元素都要小或等于的，就是他的下界</p>
<p>下面呢我们可以看到 </p>
<p>{a,b,c}的上界是 e,f,j,h （因为并没有这样一条 c-&gt;d,c-&gt;g的路）；下界是 a，因为；</p>
<p>{j,h} 没有上界，但是有下界a,b,c,d,e</p>
<p>{a,c,d,f} 的上界是 f、h、j，下界是a</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/51.png" style="zoom: 80%;"></p>
<h3 id="Least-upper-and-greatest-lower-bounds"><a href="#Least-upper-and-greatest-lower-bounds" class="headerlink" title="Least upper and greatest lower bounds"></a>Least upper and greatest lower bounds</h3><p>Least upper  bounds，就是在所有的上界中，它极小</p>
<p>greatest lower bounds,就是在所有的下界当中，它极大</p>
<p>下面这个例子， {b,d,g} 的极大下界就是 b；极小上界就是 g</p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/52.png" style="zoom: 80%;"></p>
<p>一个集合的极大下界和极小上界被称为 glb(A) 和 lub(A)</p>
<h3 id="Lattices-格"><a href="#Lattices-格" class="headerlink" title="Lattices 格"></a>Lattices 格</h3><p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/53.png"></p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/54.png"></p>
<h3 id="Topological-sorting-拓扑排序"><a href="#Topological-sorting-拓扑排序" class="headerlink" title="Topological sorting 拓扑排序"></a>Topological sorting 拓扑排序</h3><p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/55.png" style="zoom: 80%;"></p>
<p><img src="/2020/06/05/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB2/56.png" style="zoom: 80%;"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://jasonxqh.github.io/2020/06/04/react%E5%9F%BA%E7%A1%803/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason‘s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/04/react%E5%9F%BA%E7%A1%803/" class="post-title-link" itemprop="url">react基础3</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-04 00:40:25" itemprop="dateCreated datePublished" datetime="2020-06-04T00:40:25+08:00">2020-06-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-06-21 12:43:14" itemprop="dateModified" datetime="2020-06-21T12:43:14+08:00">2020-06-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/react/" itemprop="url" rel="index"><span itemprop="name">react</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="react基础3：表单和后端"><a href="#react基础3：表单和后端" class="headerlink" title="react基础3：表单和后端"></a>react基础3：表单和后端</h1><p>前两篇回顾</p>
<p><a href="https://jasonxqh.github.io/2020/05/30/react基础/#more">react基础组件+如何组合组件 </a></p>
<p><a href="https://jasonxqh.github.io/2020/06/02/react基础2/">react基础2分页排序搜索+路由</a></p>
<p>下一篇</p>
<p><a href="https://jasonxqh.github.io/2020/06/05/react基础4授权与部署/">react基础4授权与部署</a></p>
<h2 id="Forms-表单"><a href="#Forms-表单" class="headerlink" title="Forms   表单"></a>Forms   表单</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>登陆表单<img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/1.png" style="zoom:67%;"></p>
<p>添加电影信息的表单</p>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/2.png" style="zoom:67%;"></p>
<p>查询表单</p>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/3.png" style="zoom:67%;"></p>
<h3 id="Building-a-Bootstrap-Form"><a href="#Building-a-Bootstrap-Form" class="headerlink" title="Building a Bootstrap Form"></a>Building a Bootstrap Form</h3><p>我们先把表单添加到NavBar当中去</p>
<p>首先在NavBar中添加一个Login标签</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;li className=<span class="string">"nav-item"</span>&gt;</span><br><span class="line">  &lt;NavLink className=<span class="string">"nav-link"</span> to=<span class="string">"/login"</span>&gt;</span><br><span class="line">    Login</span><br><span class="line">  &lt;<span class="regexp">/NavLink&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>li&gt;</span><br></pre></td></tr></table></figure>
<p>其次我们在新建一个loginForm.jsx来存放我们的表单组件(表单格式在bootstrap上)</p>
<p>同时添加一个Login按钮</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginForm</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123;&#125;;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h1&gt;Login&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">        &lt;form&gt;</span></span><br><span class="line"><span class="regexp">          &lt;div className="form-group"&gt;</span></span><br><span class="line"><span class="regexp">            &lt;label htmlFor="username"&gt;Username&lt;/</span>label&gt;</span><br><span class="line">            &lt;input id=<span class="string">"username"</span> type=<span class="string">"text"</span> className=<span class="string">"form-control"</span> /&gt;</span><br><span class="line">          &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">          &lt;div className="form-group"&gt;</span></span><br><span class="line"><span class="regexp">            &lt;label htmlFor="password"&gt;Password&lt;/</span>label&gt;</span><br><span class="line">            &lt;input</span><br><span class="line">              type=<span class="string">"password"</span></span><br><span class="line">              <span class="class"><span class="keyword">class</span></span>=<span class="string">"form-control"</span></span><br><span class="line">              id=<span class="string">"exampleInputPassword1"</span></span><br><span class="line">              placeholder=<span class="string">"Password"</span></span><br><span class="line">            /&gt;</span><br><span class="line">          &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">          &lt;button className="btn btn-primary"&gt;Login&lt;/</span>button&gt;</span><br><span class="line">        &lt;<span class="regexp">/form&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> LoginForm;</span><br></pre></td></tr></table></figure>
<p>然后在App中注册路由</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Route path=<span class="string">"/login"</span> component=&#123;LoginForm&#125;&gt;&lt;<span class="regexp">/Route&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="Handling-Form-Submission-提交表单"><a href="#Handling-Form-Submission-提交表单" class="headerlink" title="Handling Form Submission 提交表单"></a>Handling Form Submission 提交表单</h3><p>我们不希望提交表单的时候重新下载页面。那么怎么办？</p>
<p>每个form元素又有一个onSubmit事件，然后我们要把它设置成一个句柄（handler），</p>
<p>在handler中我们需要用到一个preventDefult方法。它可以阻止事件的默认行为</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginForm</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    handleSubmit = <span class="function"><span class="params">e</span>=&gt;</span>&#123;</span><br><span class="line">        e.preventDefault();</span><br><span class="line">        <span class="comment">// Call the server</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Submitted'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h1&gt;Login&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">        &lt;form onSubmit=&#123;this.handleSubmit&#125; &gt; </span></span><br><span class="line"><span class="regexp">        /</span><span class="regexp">/....</span></span><br></pre></td></tr></table></figure>
<p>现在再次点击submit，页面没有被重载</p>
<h3 id="Refs"><a href="#Refs" class="headerlink" title="Refs"></a>Refs</h3><p>在平常的时候我们会从document中获得信息，但是在react中我们从不使用document对象。</p>
<p>所以为了获取Users和Password,我们需要给其一个引用（reference）。但这个也不是一个好方法，anyway，这个逻辑就是在组件中新建一个引用，然后在表单的input标签中通过 ref={this.引用} </p>
<p>这样我们就可以实时获取表单中的信息了</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> username = <span class="keyword">this</span>.username.current.value;</span><br></pre></td></tr></table></figure>
<p> 尽量不要过度使用 refs</p>
<p>现在我们希望在页面渲染完成之后，username输入获得光标</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginForm</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    username = React.createRef();</span><br><span class="line"><span class="comment">//利用hooks，在页面渲染完后focus on username</span></span><br><span class="line">    componentDidMount()&#123;</span><br><span class="line">        <span class="keyword">this</span>.username.current.focus();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  handleSubmit = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    <span class="keyword">const</span> username = <span class="keyword">this</span>.username.current.value;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Submitted"</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然我们也可以用 autofocus 属性，物品们把它放在input标签里去</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;input</span><br><span class="line">autoFocus</span><br><span class="line">  ref=&#123;<span class="keyword">this</span>.username&#125;</span><br><span class="line">  id=<span class="string">"username"</span></span><br><span class="line">  type=<span class="string">"text"</span></span><br><span class="line">  className=<span class="string">"form-control"</span></span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>
<p>和利用hooks是等价的</p>
<h3 id="Controlled-Elements"><a href="#Controlled-Elements" class="headerlink" title="Controlled Elements"></a>Controlled Elements</h3><p>接下来介绍更标准的输入域的方式。</p>
<p>我们在state中新建一个account对象，里面包含username和password两个属性</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">state = &#123;</span><br><span class="line">   account: &#123; <span class="attr">username</span>: <span class="string">""</span>, <span class="attr">password</span>: <span class="string">""</span> &#125;,</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>
<p>但这是不够的，因为表单组件中的input也具有自己的state，我们需要改变这一点，把表单变成一个受控元素，只接受来自props中的信息</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">         </span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">  handleChange = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> account = &#123; ...this.state.account &#125;;</span><br><span class="line">    account.username = e.currentTarget.value;<span class="comment">//获得最新的输入讯息</span></span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; account &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">		&lt;div className=<span class="string">"form-group"</span>&gt;</span><br><span class="line">            &lt;label htmlFor=<span class="string">"username"</span>&gt;Username&lt;<span class="regexp">/label&gt;</span></span><br><span class="line"><span class="regexp">            &lt;input</span></span><br><span class="line"><span class="regexp">              autoFocus</span></span><br><span class="line"><span class="regexp">              value=&#123;this.state.account.username&#125;/</span><span class="regexp">/从state中获取</span></span><br><span class="line"><span class="regexp">              onChange=&#123;this.handleChange&#125;/</span><span class="regexp">/若文本内容发生改变那么就调用handleChange</span></span><br><span class="line"><span class="regexp">              id="username"</span></span><br><span class="line"><span class="regexp">              type="text"</span></span><br><span class="line"><span class="regexp">              className="form-control"</span></span><br><span class="line"><span class="regexp">            /</span>&gt;</span><br><span class="line">          &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/...</span></span><br></pre></td></tr></table></figure>
<p>回到浏览器我们看到输入sss之后，username中也呈现了sss</p>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/4.png" style="zoom:67%;"></p>
<h3 id="Handling-Multiple-Inputs"><a href="#Handling-Multiple-Inputs" class="headerlink" title="Handling Multiple Inputs"></a>Handling Multiple Inputs</h3><p>我现在想动态设置这个属性（需要用到中括号操作符）</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginForm</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    account: &#123; <span class="attr">username</span>: <span class="string">""</span>, <span class="attr">password</span>: <span class="string">""</span> &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">  handleSubmit = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Submitted"</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//首先从事件e中析构出currentTarget，并把它称为input(更直观)</span></span><br><span class="line">  handleChange = <span class="function">(<span class="params">&#123;currentTarget:input&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> account = &#123; ...this.state.account &#125;;</span><br><span class="line">      <span class="comment">///在这里我们利用中括号访问！</span></span><br><span class="line">    account[input.name] = input.value;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; account &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">      <span class="comment">//先解构state，提取account</span></span><br><span class="line">      <span class="keyword">const</span> &#123;account &#125; = <span class="keyword">this</span>.state</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h1&gt;Login&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">        &lt;form onSubmit=&#123;this.handleSubmit&#125;&gt;</span></span><br><span class="line"><span class="regexp">          &lt;div className="form-group"&gt;</span></span><br><span class="line"><span class="regexp">            &lt;label htmlFor="username"&gt;Username&lt;/</span>label&gt;</span><br><span class="line">            &lt;input</span><br><span class="line">              autoFocus</span><br><span class="line">              value=&#123;account.username&#125;<span class="comment">//从account中获取username</span></span><br><span class="line">              onChange=&#123;<span class="keyword">this</span>.handleChange&#125;<span class="comment">//每当改变就发起</span></span><br><span class="line">              name=<span class="string">"username"</span><span class="comment">//设置name，以供handleChange访问</span></span><br><span class="line">              id=<span class="string">"username"</span></span><br><span class="line">              type=<span class="string">"text"</span></span><br><span class="line">              className=<span class="string">"form-control"</span></span><br><span class="line">            /&gt;</span><br><span class="line">          &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">          &lt;div className="form-group"&gt;</span></span><br><span class="line"><span class="regexp">            &lt;label htmlFor="password"&gt;Password&lt;/</span>label&gt;</span><br><span class="line">            &lt;input</span><br><span class="line">              type=<span class="string">"password"</span></span><br><span class="line">              onChange=&#123;<span class="keyword">this</span>.handleChange&#125;<span class="comment">//每当改变就发起</span></span><br><span class="line">              value=&#123;account.password&#125;</span><br><span class="line">              name=<span class="string">"password"</span></span><br><span class="line">              className=<span class="string">"form-control"</span></span><br><span class="line">              id=<span class="string">"password"</span></span><br><span class="line">              placeholder=<span class="string">"Password"</span></span><br><span class="line">            /&gt;</span><br><span class="line">          &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">          &lt;button className="btn btn-primary"&gt;Login&lt;/</span>button&gt;</span><br><span class="line">        &lt;<span class="regexp">/form&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> LoginForm;</span><br></pre></td></tr></table></figure>
<p>这样，username和password都成为了受控元素</p>
<h3 id="Common-Errors"><a href="#Common-Errors" class="headerlink" title="Common Errors"></a>Common Errors</h3><p>如果我删除了this.state.account.username ，那么我再试图访问account中的username的时候，会得到undefined，然而value={undefined}，虽然定了value，但这不是一个受控元素。 那么这个元素就会有自己的state和value。当我们输入a的时候，（会自动创建state.username) 并且想把这个username传递给表单，但是表单这时候已经不是一个受控元素了，所以说会报错。</p>
<p>这就是为什么我们必须创建一个password，username，并且把它命名为空串的原因（注意，这里千万不能写undefined或者null）。作为一个原则，当我们创建一个表单的时候，当我想创建state对象当中的属性的时候，我们一定要写空串或者从服务器获得数据</p>
<h3 id="Extracting-a-Reusable-Input"><a href="#Extracting-a-Reusable-Input" class="headerlink" title="Extracting a Reusable Input"></a>Extracting a Reusable Input</h3><p>我们可以把表单独立成一个可以公用的组件， 然后通过析构，从props中获得所有我想要的信息</p>
<p>input.jsx</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="comment">//从props中解构出name，label，value，onChange</span></span><br><span class="line"><span class="keyword">const</span> Input = <span class="function">(<span class="params">&#123;name,label,value,onChange&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line"> <span class="comment">//下面就是替换了，username 用 name替换，渲染部分用label替换，</span></span><br><span class="line"> <span class="comment">//this.account.username 用value替换，把原来的this.handleChange变为向上抛出一个event</span></span><br><span class="line">    &lt;div className=<span class="string">"form-group"</span>&gt;</span><br><span class="line">      &lt;label htmlFor=&#123;name&#125;&gt;&#123;label&#125;&lt;<span class="regexp">/label&gt;</span></span><br><span class="line"><span class="regexp">      &lt;input</span></span><br><span class="line"><span class="regexp">        autoFocus</span></span><br><span class="line"><span class="regexp">        value=&#123;value&#125;</span></span><br><span class="line"><span class="regexp">        onChange=&#123;onChange&#125;</span></span><br><span class="line"><span class="regexp">        name=&#123;name&#125;</span></span><br><span class="line"><span class="regexp">        id=&#123;name&#125;</span></span><br><span class="line"><span class="regexp">        type="text"</span></span><br><span class="line"><span class="regexp">        className="form-control"</span></span><br><span class="line"><span class="regexp">      /</span>&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default Input;</span></span><br></pre></td></tr></table></figure>
<p>然后回到login部分我们这样修改</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;h1&gt;Login&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">    &lt;form onSubmit=&#123;this.handleSubmit&#125;&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Input</span></span><br><span class="line"><span class="regexp">        name="username"</span></span><br><span class="line"><span class="regexp">        value=&#123;account.username&#125;</span></span><br><span class="line"><span class="regexp">        label="Username"</span></span><br><span class="line"><span class="regexp">        onChange=&#123;this.handleChange&#125;</span></span><br><span class="line"><span class="regexp">      /</span>&gt;</span><br><span class="line">      &lt;Input</span><br><span class="line">        name=<span class="string">"password"</span></span><br><span class="line">        value=&#123;account.password&#125;</span><br><span class="line">        label=<span class="string">"Password"</span></span><br><span class="line">        onChange=&#123;<span class="keyword">this</span>.handleChange&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;button className=<span class="string">"btn btn-primary"</span>&gt;Login&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>form&gt;</span><br><span class="line">  &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/...</span></span><br></pre></td></tr></table></figure>
<h3 id="Validation-验证"><a href="#Validation-验证" class="headerlink" title="Validation 验证"></a>Validation 验证</h3><p>几乎所有的表单域都需要值验证。下面我们为我们造的表单添加验证</p>
<p>我们在state中添加errors，然后在里面写上我们出现的错误类型.注意，这里用对象而不是用数组，因为对象的话更容易定位，直接用点即可</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">errors:&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们需要在handleChange方法中调用一个验证的函数</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">validate = <span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="attr">username</span>:<span class="string">'Username is required'</span>&#125;</span><br><span class="line">&#125;  </span><br><span class="line">handleSubmit = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  e.preventDefault();</span><br><span class="line">  <span class="keyword">const</span> errors = <span class="keyword">this</span>.validate();</span><br><span class="line">  <span class="keyword">this</span>.setState(&#123; errors &#125;);</span><br><span class="line">  <span class="keyword">if</span> (errors) <span class="keyword">return</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Submitted"</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="A-Basic-Validation-Implementation"><a href="#A-Basic-Validation-Implementation" class="headerlink" title="A Basic Validation Implementation"></a>A Basic Validation Implementation</h3><p>接下来实现上面声明的验证函数（基本功能）</p>
<p>实现的逻辑是这样的，当我们点击提交表单的时候，会调用handleSubmit方法，handleSubmit方法有会调用validate()方法。在 validate中，我们来判断是否存在errors，如果不存在返回null，那么console.log(errors)就不会打印，在最后打印Submitted如果存在errors，那么把errors对象返回，在handleSubmit中打印。然后是先更新。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">validate = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> errors = &#123;&#125;;</span><br><span class="line">  <span class="keyword">const</span> &#123; account &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">  <span class="keyword">if</span> (account.username.trim() === <span class="string">""</span>)</span><br><span class="line">    errors.username = <span class="string">"Username is required."</span>;</span><br><span class="line">  <span class="keyword">if</span> (account.password.trim() === <span class="string">""</span>)</span><br><span class="line">    errors.password = <span class="string">"Password is required."</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>.keys(errors).length === <span class="number">0</span> ? <span class="literal">null</span> : errors;</span><br><span class="line">&#125;;</span><br><span class="line">handleSubmit = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  e.preventDefault();</span><br><span class="line">  <span class="keyword">const</span> errors = <span class="keyword">this</span>.validate();</span><br><span class="line">  <span class="built_in">console</span>.log(errors);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.setState(&#123; errors &#125;);</span><br><span class="line">  <span class="keyword">if</span> (errors) <span class="keyword">return</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Submitted"</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/5.png" style="zoom:67%;"></p>
<h3 id="Displaying-Validation-Errors-显示验证错误信息"><a href="#Displaying-Validation-Errors-显示验证错误信息" class="headerlink" title="Displaying Validation Errors 显示验证错误信息"></a>Displaying Validation Errors 显示验证错误信息</h3><p>我们想要在输入错误的时候显示一个错误信息 div.alert.alert-danger</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Input = <span class="function">(<span class="params">&#123; name, label, value, error, onChange &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"form-group"</span>&gt;</span><br><span class="line">      &lt;label htmlFor=&#123;name&#125;&gt;&#123;label&#125;&lt;<span class="regexp">/label&gt;</span></span><br><span class="line"><span class="regexp">      &lt;input</span></span><br><span class="line"><span class="regexp">        value=&#123;value&#125;</span></span><br><span class="line"><span class="regexp">        onChange=&#123;onChange&#125;</span></span><br><span class="line"><span class="regexp">        name=&#123;name&#125;</span></span><br><span class="line"><span class="regexp">        id=&#123;name&#125;</span></span><br><span class="line"><span class="regexp">        type="text"</span></span><br><span class="line"><span class="regexp">        className="form-control"</span></span><br><span class="line"><span class="regexp">      /</span>&gt;</span><br><span class="line">&#123;<span class="comment">/*在原来的表单下面添加一个错误显示</span></span><br><span class="line"><span class="comment">只有当error非空才显示，显示内容是从props中解构的error*/</span>&#125;         </span><br><span class="line">      &#123;error &amp;&amp; <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"alert alert-danger"</span>&gt;</span>&#123;error&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>&#125;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure>
<p>然后再loginForm.jsx中，给两个表单添加error属性。注意，一个给的是username，一个给的是password</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;Input</span><br><span class="line">         name=<span class="string">"username"</span></span><br><span class="line">         value=&#123;account.username&#125;</span><br><span class="line">         label=<span class="string">"Username"</span></span><br><span class="line">         onChange=&#123;<span class="keyword">this</span>.handleChange&#125;</span><br><span class="line">         error=&#123;errors.username&#125;</span><br><span class="line">       /&gt;</span><br><span class="line">       &lt;Input</span><br><span class="line">         name=<span class="string">"password"</span></span><br><span class="line">         value=&#123;account.password&#125;</span><br><span class="line">         label=<span class="string">"Password"</span></span><br><span class="line">         onChange=&#123;<span class="keyword">this</span>.handleChange&#125;</span><br><span class="line">         error=&#123;errors.password&#125;</span><br><span class="line">       /&gt;</span><br></pre></td></tr></table></figure>
<p>实现逻辑是当我们提交空表单的时候我们更新了state中的错误，state把错误传递给Input，然后Input实现渲染更新</p>
<h3 id="Validation-on-Change-在值变更的时候验证"><a href="#Validation-on-Change-在值变更的时候验证" class="headerlink" title="Validation on Change 在值变更的时候验证"></a>Validation on Change 在值变更的时候验证</h3><p>刚才是在提交的时候显示错误，现在我们在输入值的时候就显示错误。那么我们就必须在handleChange的时候进行修改。首先拷贝errors对象，然后调用判断当前输入是否有错并赋给errorMessage。如果errorMessage非空的话，就把errorMessage装给errors，否则就删除该处信息。最后更新state当中的errors和account</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">validateProperty = <span class="function">(<span class="params">&#123; name, value &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (name === <span class="string">"username"</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (value.trim() === <span class="string">""</span>) <span class="keyword">return</span> <span class="string">"Username is required."</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (name === <span class="string">"password"</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (value.trim() === <span class="string">""</span>) <span class="keyword">return</span> <span class="string">"Password is required."</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">handleChange = <span class="function">(<span class="params">&#123; currentTarget: input &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> errors = &#123; ...this.state.errors &#125;;</span><br><span class="line">  <span class="keyword">const</span> errorMessage = <span class="keyword">this</span>.validateProperty(input);</span><br><span class="line">  <span class="keyword">if</span> (errorMessage) errors[input.name] = errorMessage;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">delete</span> errors[input.name];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> account = &#123; ...this.state.account &#125;;</span><br><span class="line">  account[input.name] = input.value;</span><br><span class="line">  <span class="keyword">this</span>.setState(&#123; account, errors &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="Joi"><a href="#Joi" class="headerlink" title="Joi"></a>Joi</h3><p>为了实现验证，我们需要用到一个非常强大的库Joi</p>
<p><a href="https://www.npmjs.com/package/joi" target="_blank" rel="noopener">https://www.npmjs.com/package/joi</a></p>
<p>example:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Joi = <span class="built_in">require</span>(<span class="string">'joi'</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> schema = Joi.object().keys(&#123;</span><br><span class="line">    username: Joi.string().alphanum().min(<span class="number">3</span>).max(<span class="number">30</span>).required(),</span><br><span class="line">    password: Joi.string().regex(<span class="regexp">/^[a-zA-Z0-9]&#123;3,30&#125;$/</span>),</span><br><span class="line">    access_token: [Joi.string(), Joi.number()],</span><br><span class="line">    birthyear: Joi.number().integer().min(<span class="number">1900</span>).max(<span class="number">2013</span>),</span><br><span class="line">    email: Joi.string().email(&#123; <span class="attr">minDomainAtoms</span>: <span class="number">2</span> &#125;)</span><br><span class="line">&#125;).with(<span class="string">'username'</span>, <span class="string">'birthyear'</span>).without(<span class="string">'password'</span>, <span class="string">'access_token'</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Return result.</span></span><br><span class="line"><span class="keyword">const</span> result = Joi.validate(&#123; <span class="attr">username</span>: <span class="string">'abc'</span>, <span class="attr">birthyear</span>: <span class="number">1994</span> &#125;, schema);</span><br><span class="line"><span class="comment">// result.error === null -&gt; valid</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// You can also pass a callback which will be called synchronously with the validation result.</span></span><br><span class="line">Joi.validate(&#123; <span class="attr">username</span>: <span class="string">'abc'</span>, <span class="attr">birthyear</span>: <span class="number">1994</span> &#125;, schema, <span class="function"><span class="keyword">function</span> (<span class="params">err, value</span>) </span>&#123; &#125;);  <span class="comment">// err === null -&gt; valid</span></span><br></pre></td></tr></table></figure>
<p>我们看到这样就方便很多， Joi.string()[一定要字符串形式].alpanum()[字母数字的组合].min(3).max(30)[3到30个字符串之间].required()[必须的]</p>
<p>还可以让string满足这个 正则表达式之类的</p>
<p>如何实现？</p>
<p>首先建一个schema对象，里面有我们需要检测的内容</p>
<p>用result 来接收Joi判断好的对象，其中第一个参数就是受测对象第二个参数就是上面定义的schema</p>
<p>{abortEarly: false,} 就是说让Joi全部检测完才返回，否则Joi检测到错误就不进行下去了</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">schema = &#123;</span><br><span class="line">    username: Joi.string().required(),</span><br><span class="line">    password: Joi.string().required(),</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  validate = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = Joi.validate(<span class="keyword">this</span>.state.account, <span class="keyword">this</span>.schema, &#123;</span><br><span class="line">      abortEarly: <span class="literal">false</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>那么我们就看到在error对象中的details中就由我们的报错信息</p>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/7.png" style="zoom:67%;"></p>
<h3 id="Validating-a-Form-Using-Joi"><a href="#Validating-a-Form-Using-Joi" class="headerlink" title="Validating a Form Using Joi"></a>Validating a Form Using Joi</h3><p>errors对象中有error属性，他只在问题出现的时候才会被创建。errors中有一个details数组，里面记录了我们的错误信息。我们的挑战就是把这个映射到我们的errors对象当中</p>
<p>我们对handleSubmit和validate进行修改。对于validate我们通过result接受了errors对象以后，判断是否为空，如果非空的话，我们就让遍历details数组，每次迭代一次就给errors对象添加一个新的属性，path中存放的就是 input.name,然后返回</p>
<p>在handleSubmit当中如果errors存在，那么就同步，否则就把errors置空</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> schema = &#123;</span><br><span class="line">     <span class="comment">//label在显示的时候提示Username而不是username</span></span><br><span class="line">   username: Joi.string().required().label(<span class="string">"Username"</span>),</span><br><span class="line">   password: Joi.string().required().label(<span class="string">"Password"</span>),</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line">validate = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">   <span class="keyword">const</span> options = &#123; <span class="attr">abortEarly</span>: <span class="literal">false</span> &#125;;</span><br><span class="line">    <span class="comment">//这里通过析构简化了代码</span></span><br><span class="line">   <span class="keyword">const</span> &#123; error &#125; = Joi.validate(<span class="keyword">this</span>.state.account, <span class="keyword">this</span>.schema, options);</span><br><span class="line">   <span class="keyword">if</span> (!error) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">   <span class="keyword">const</span> errors = &#123;&#125;;</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">let</span> item <span class="keyword">of</span> error.details) errors[item.path[<span class="number">0</span>]] = item.message;</span><br><span class="line">   <span class="keyword">return</span> errors;</span><br><span class="line"> &#125;;</span><br><span class="line"> handleSubmit = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">   e.preventDefault();</span><br><span class="line">   <span class="keyword">const</span> errors = <span class="keyword">this</span>.validate();</span><br><span class="line">   <span class="keyword">this</span>.setState(&#123; <span class="attr">errors</span>: errors || &#123;&#125; &#125;);</span><br><span class="line">   <span class="keyword">if</span> (errors) <span class="keyword">return</span>;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">"Submitted"</span>);</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>
<h3 id="Validating-a-Field-Using-Joi"><a href="#Validating-a-Field-Using-Joi" class="headerlink" title="Validating a Field Using Joi"></a>Validating a Field Using Joi</h3><p>这里调整一下 validateProperty</p>
<p>因为我希望在一个输入框中输入不符合格式的话，就报错，所以我们每次报错一个</p>
<p>我们首先从input中解构name，value</p>
<p>然后利用ES6的运算方法在中括号中写name，那么运行的时候name是什么，[name] 就是什么、</p>
<p>我们就用这个obj来替代this.state.account,因为这时候obj中只有当前表单，所以Joi.validate只会检测当前的表单中的错误。注意，这里不要用abortEarly:false 了，因为我们不希望他一下子把所有的错误提示出来，那样看着会很烦</p>
<p>因为Joi.validate()返回一个errors对象，所以我们要从中析构出error来</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">validateProperty = <span class="function">(<span class="params">&#123; name, value &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> obj = &#123; [name]: value &#125;;</span><br><span class="line">  <span class="keyword">const</span> schema = &#123; [name]: <span class="keyword">this</span>.schema[name] &#125;;</span><br><span class="line">  <span class="keyword">const</span> &#123; error &#125; = Joi.validate(obj, schema);</span><br><span class="line">  <span class="keyword">return</span> error ? error.details[<span class="number">0</span>].message : <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="Disabling-the-Submit-Button"><a href="#Disabling-the-Submit-Button" class="headerlink" title="Disabling the Submit Button"></a>Disabling the Submit Button</h3><p>我想禁用提交按钮，知道表单数据合法</p>
<p>这里我如果this.validate()存在，那么我们就把Login按钮变为红色，而且设置为不能提交</p>
<p>disabled={this.validate()}</p>
<p>那么如果检测到没有错误，那么我们就把Login变为蓝色，这时候才能够提交</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="keyword">this</span>.validate()&amp;&amp;<span class="xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">disabled</span>=<span class="string">&#123;this.validate()&#125;</span> <span class="attr">className</span>=<span class="string">"btn btn-danger"</span>&gt;</span></span></span><br><span class="line"><span class="xml">  Login</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span>&#125;</span><br><span class="line">&#123; !<span class="keyword">this</span>.validate()&amp;&amp;<span class="xml"><span class="tag">&lt;<span class="name">button</span>  <span class="attr">className</span>=<span class="string">"btn btn-primary"</span>&gt;</span></span></span><br><span class="line"><span class="xml">  Login</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span>&#125;</span><br></pre></td></tr></table></figure>
<p>每个表单都可能有自己的errors对象</p>
<h3 id="Extracting-a-Reusable-Form"><a href="#Extracting-a-Reusable-Form" class="headerlink" title="Extracting a Reusable Form"></a>Extracting a Reusable Form</h3><p>接下来我们把表单中可以重复利用的都抽象成方法或者子组件。</p>
<p>我们可以新建一个子组件，然后让我这个LoginForm 继承我们的Form组件，这样Form组件中就存放了一些验证、提交的方法，而这些方法对于所有表单都是可以用的。</p>
<p>在LoginForm中，需要保留state,schema 这些表特有的，还要保留render和doSubmit方法（当提交成功后显示的内容，如Submitted之类的）</p>
<p>form.jsx</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> Joi <span class="keyword">from</span> <span class="string">"joi-browser"</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Form</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="comment">//这里把form的信息统一命名为data，然后在loginform中还需要重定义</span></span><br><span class="line">  state = &#123;</span><br><span class="line">    data: &#123;&#125;,</span><br><span class="line">    errors: &#123;&#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">  validate = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> options = &#123; <span class="attr">abortEarly</span>: <span class="literal">false</span> &#125;;</span><br><span class="line">    <span class="keyword">const</span> &#123; error &#125; = Joi.validate(<span class="keyword">this</span>.state.account, <span class="keyword">this</span>.schema, options);</span><br><span class="line">    <span class="keyword">if</span> (!error) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">const</span> errors = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> item <span class="keyword">of</span> error.details) errors[item.path[<span class="number">0</span>]] = item.message;</span><br><span class="line">    <span class="keyword">return</span> errors;</span><br><span class="line">  &#125;;</span><br><span class="line">  validateProperty = <span class="function">(<span class="params">&#123; name, value &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> obj = &#123; [name]: value &#125;;</span><br><span class="line">    <span class="keyword">const</span> schema = &#123; [name]: <span class="keyword">this</span>.schema[name] &#125;;</span><br><span class="line">    <span class="keyword">const</span> &#123; error &#125; = Joi.validate(obj, schema);</span><br><span class="line">    <span class="keyword">return</span> error ? error.details[<span class="number">0</span>].message : <span class="literal">null</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">  handleSubmit = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    <span class="keyword">const</span> errors = <span class="keyword">this</span>.validate();</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">errors</span>: errors || &#123;&#125; &#125;);</span><br><span class="line">    <span class="keyword">if</span> (errors) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">this</span>.doSubmit();</span><br><span class="line">  &#125;;</span><br><span class="line">  handleChange = <span class="function">(<span class="params">&#123; currentTarget: input &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> errors = &#123; ...this.state.errors &#125;;</span><br><span class="line">    <span class="keyword">const</span> errorMessage = <span class="keyword">this</span>.validateProperty(input);</span><br><span class="line">    <span class="keyword">if</span> (errorMessage) errors[input.name] = errorMessage;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">delete</span> errors[input.name];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> account = &#123; ...this.state.account &#125;;</span><br><span class="line">    account[input.name] = input.value;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; account, errors &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Form;</span><br></pre></td></tr></table></figure>
<p>login.jsx</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> Input <span class="keyword">from</span> <span class="string">"./common/input"</span>;</span><br><span class="line"><span class="keyword">import</span> Joi <span class="keyword">from</span> <span class="string">"joi-browser"</span>;</span><br><span class="line"><span class="keyword">import</span> Form <span class="keyword">from</span> <span class="string">"./common/form"</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginForm</span> <span class="keyword">extends</span> <span class="title">Form</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    data: &#123; <span class="attr">username</span>: <span class="string">""</span>, <span class="attr">password</span>: <span class="string">""</span> &#125;,</span><br><span class="line">    errors: &#123;&#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  schema = &#123;</span><br><span class="line">    username: Joi.string().required().label(<span class="string">"Username"</span>),</span><br><span class="line">    password: Joi.string().required().label(<span class="string">"Password"</span>),</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  doSubmit = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Submitted"</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"> render()&#123;<span class="comment">/*...*/</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Extracting-Helper-Rendering-Methods"><a href="#Extracting-Helper-Rendering-Methods" class="headerlink" title="Extracting Helper Rendering Methods"></a>Extracting Helper Rendering Methods</h3><p>接下来我们来接化render<br>首先把按钮变成一个方法，通过调用渲染</p>
<p>在form.jsx中加上renderButton方法，同时在loginForm.jsx中调用这个方法，因为是直接继承自Form的，所以可以直接调用{this.renderButton(“Login”)}</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">renderButton(label) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;button disabled=&#123;<span class="keyword">this</span>.validate()&#125; className=<span class="string">"btn btn-primary"</span>&gt;</span><br><span class="line">      &#123;label&#125;</span><br><span class="line">    &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p> 我们也可以把输入域放到Form组件当中去,在form中加入renderInput方法</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Input <span class="keyword">from</span> <span class="string">"./input"</span>;</span><br><span class="line">renderInput(name, label, type = <span class="string">"text"</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; data, errors &#125; = <span class="keyword">this</span>.state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Input</span><br><span class="line">        type=&#123;type&#125;</span><br><span class="line">        name=&#123;name&#125;</span><br><span class="line">        value=&#123;data[name]&#125;</span><br><span class="line">        label=&#123;label&#125;</span><br><span class="line">        onChange=&#123;<span class="keyword">this</span>.handleChange&#125;</span><br><span class="line">        error=&#123;errors[name]&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>然后在LoginForm中的render中调用者两个方法</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="keyword">this</span>.renderInput(<span class="string">"username"</span>, <span class="string">"Username"</span>)&#125;<span class="comment">//这里不传入第三个参数，那么默认类型就是text</span></span><br><span class="line">&#123;<span class="keyword">this</span>.renderInput(<span class="string">"password"</span>, <span class="string">"Password"</span>, <span class="string">"password"</span>)&#125;<span class="comment">//传入password那么密码会被隐藏</span></span><br></pre></td></tr></table></figure>
<p>当然。input组件也需要修改</p>
<p>因为真正在每个表单中中改变的值只有name，label,error，剩下的我们不想一个一个析构。所以我们直接用…rest来代替，这样我们也不需要再每次添加新的属性进去了，所有的属性都会自动添加</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">const</span> Input = <span class="function">(<span class="params">&#123; name, label, error, ...rest &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"form-group"</span>&gt;</span><br><span class="line">      &lt;label htmlFor=&#123;name&#125;&gt;&#123;label&#125;&lt;<span class="regexp">/label&gt;</span></span><br><span class="line"><span class="regexp">      &lt;input</span></span><br><span class="line"><span class="regexp">        &#123;...rest&#125;</span></span><br><span class="line"><span class="regexp">        name=&#123;name&#125;</span></span><br><span class="line"><span class="regexp">        id=&#123;name&#125;</span></span><br><span class="line"><span class="regexp">        className="form-control"</span></span><br><span class="line"><span class="regexp">      /</span>&gt;</span><br><span class="line">      &#123;error &amp;&amp; <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"alert alert-danger"</span>&gt;</span>&#123;error&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>&#125;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default Input;</span></span><br></pre></td></tr></table></figure>
<h3 id="Exercise-1-Register-Form"><a href="#Exercise-1-Register-Form" class="headerlink" title="Exercise 1-Register Form"></a>Exercise 1-Register Form</h3><p>现在我们创建一个注册表单，就会灰常简单</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> Joi <span class="keyword">from</span> <span class="string">"joi-browser"</span>;</span><br><span class="line"><span class="keyword">import</span> Form <span class="keyword">from</span> <span class="string">"./common/form"</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterForm</span> <span class="keyword">extends</span> <span class="title">Form</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    data: &#123; <span class="attr">username</span>: <span class="string">""</span>, <span class="attr">password</span>: <span class="string">""</span>, <span class="attr">name</span>: <span class="string">""</span> &#125;,</span><br><span class="line">    errors: &#123;&#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  schema = &#123;</span><br><span class="line">      <span class="comment">//username必须是email格式的</span></span><br><span class="line">    username: Joi.string().required().email().label(<span class="string">"Username"</span>),</span><br><span class="line">      <span class="comment">//密码不小于5个字符，不大于10个字符</span></span><br><span class="line">    password: Joi.string().required().min(<span class="number">5</span>).max(<span class="number">10</span>).label(<span class="string">"Password"</span>),</span><br><span class="line">    name: Joi.string().required().label(<span class="string">"Name"</span>),</span><br><span class="line">  &#125;;</span><br><span class="line">  doSubmit = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Submitted"</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h1&gt;Login&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">        &lt;form onSubmit=&#123;this.handleSubmit&#125;&gt;</span></span><br><span class="line"><span class="regexp">          &#123;this.renderInput("username", "Username")&#125;</span></span><br><span class="line"><span class="regexp">          &#123;this.renderInput("password", "Password", "password")&#125;</span></span><br><span class="line"><span class="regexp">          &#123;this.renderInput("name", "Name")&#125;</span></span><br><span class="line"><span class="regexp">          &#123;this.renderButton("Register")&#125;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>form&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default RegisterForm;</span></span><br></pre></td></tr></table></figure>
<p>然后再App.js中注册路由，在navbar中添加，即可</p>
<h3 id="Exercise-2-Movie-Form"><a href="#Exercise-2-Movie-Form" class="headerlink" title="Exercise 2- Movie Form"></a>Exercise 2- Movie Form</h3><p>我们接下来做一个添加电影的表单，</p>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/9.png" style="zoom:67%;"></p>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/10.png" style="zoom:67%;"></p>
<p>那么我们首先做一个按钮。在Movies.jsx中</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...    </span></span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line">      &lt;div className=<span class="string">"row"</span>&gt;</span><br><span class="line">        &lt;div className=<span class="string">"col-3"</span>&gt;</span><br><span class="line">          &lt;ListGroup</span><br><span class="line">            items=&#123;<span class="keyword">this</span>.state.genres&#125;</span><br><span class="line">            selectedItem=&#123;<span class="keyword">this</span>.state.selectedGenre&#125;</span><br><span class="line">            onItemSelect=&#123;<span class="keyword">this</span>.handleGenreSelect&#125;</span><br><span class="line">          /&gt;</span><br><span class="line">        &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;div className="col"&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Link/</span><span class="regexp">/ 这里其实是一个链接，只是伪装成了按钮</span></span><br><span class="line"><span class="regexp">            to="/m</span>ovies/<span class="keyword">new</span><span class="string">"</span></span><br><span class="line"><span class="string">            className="</span>btn btn-primary<span class="string">"</span></span><br><span class="line"><span class="string">            style=&#123;&#123; marginBottom: 20 &#125;&#125;</span></span><br><span class="line"><span class="string">          &gt;</span></span><br><span class="line"><span class="string">            New Movie</span></span><br><span class="line"><span class="string">          &lt;/Link&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后我们重构MovieForm</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> Joi <span class="keyword">from</span> <span class="string">"joi-browser"</span>;</span><br><span class="line"><span class="keyword">import</span> Form <span class="keyword">from</span> <span class="string">"./common/form"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getMovie, saveMovie &#125; <span class="keyword">from</span> <span class="string">"../services/fakeMovieService"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getGenres &#125; <span class="keyword">from</span> <span class="string">"../services/fakeGenreService"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MovieForm</span> <span class="keyword">extends</span> <span class="title">Form</span> </span>&#123;</span><br><span class="line"> <span class="comment">/*在movieForm表单下拉类型的时候，我们在内部实现的其实是选择genreId而不是genre名称    </span></span><br><span class="line"><span class="comment"> data中的四个元素分别对应Title,Genre,Number in Stock,Rate</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">  state = &#123;</span><br><span class="line">    data: &#123;</span><br><span class="line">      title: <span class="string">""</span>,</span><br><span class="line">      genreId: <span class="string">""</span>,</span><br><span class="line">      numberInStock: <span class="string">""</span>,</span><br><span class="line">      dailyRentalRate: <span class="string">""</span></span><br><span class="line">    &#125;,</span><br><span class="line">    genres: [],</span><br><span class="line">    errors: &#123;&#125;</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">schema中设定了四个Input组件必须满足的条件。numberInStock 是数字类型的，从0-100</span></span><br><span class="line"><span class="comment">Rate从0-10</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">  schema = &#123;</span><br><span class="line">    _id: Joi.string(),</span><br><span class="line">    title: Joi.string()</span><br><span class="line">      .required()</span><br><span class="line">      .label(<span class="string">"Title"</span>),</span><br><span class="line">    genreId: Joi.string()</span><br><span class="line">      .required()</span><br><span class="line">      .label(<span class="string">"Genre"</span>),</span><br><span class="line">    numberInStock: Joi.number()</span><br><span class="line">      .required()</span><br><span class="line">      .min(<span class="number">0</span>)</span><br><span class="line">      .max(<span class="number">100</span>)</span><br><span class="line">      .label(<span class="string">"Number in Stock"</span>),</span><br><span class="line">    dailyRentalRate: Joi.number()</span><br><span class="line">      .required()</span><br><span class="line">      .min(<span class="number">0</span>)</span><br><span class="line">      .max(<span class="number">10</span>)</span><br><span class="line">      .label(<span class="string">"Daily Rental Rate"</span>)</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">现在来看看componentDidMount这个钩子中处理的内容</span></span><br><span class="line"><span class="comment">首先是从假想的服务器中获得genres字段，然后更新state</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">然后读取路由中的id参数，并赋值给一个movieID 如果检测到这是新电影</span></span><br><span class="line"><span class="comment">也就是我从按钮中点击进入的话。我就直接return掉，因为我们不需要生成一个已经有电影的表单。</span></span><br><span class="line"><span class="comment">反之，我们把数据给渲染上去。那么我们获取电影信息的方法就是 getMovie</span></span><br><span class="line"><span class="comment">export function getMovie(id) &#123;</span></span><br><span class="line"><span class="comment">  return movies.find((m) =&gt; m._id === id);</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">然后如果找不到的话，那么就返回not-found</span></span><br><span class="line"><span class="comment">找到了，那么就通过setState，和mapToViewModel方法把电影信息填到state当中，完成渲染</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">const</span> genres = getGenres();</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; genres &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> movieId = <span class="keyword">this</span>.props.match.params.id;</span><br><span class="line">    <span class="keyword">if</span> (movieId === <span class="string">"new"</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> movie = getMovie(movieId);</span><br><span class="line">    <span class="keyword">if</span> (!movie) <span class="keyword">return</span> <span class="keyword">this</span>.props.history.replace(<span class="string">"/not-found"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">data</span>: <span class="keyword">this</span>.mapToViewModel(movie) &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//这就是上面所说的mapToViewModel了，也就是返回一个state.data类型的对象，然后实现覆盖</span></span><br><span class="line">  mapToViewModel(movie) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      _id: movie._id,</span><br><span class="line">      title: movie.title,</span><br><span class="line">      genreId: movie.genre._id,</span><br><span class="line">      numberInStock: movie.numberInStock,</span><br><span class="line">      dailyRentalRate: movie.dailyRentalRate</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 然后处理doSubmit方法，如果提交成功的话，那就saveMovie，也就是在fakemovieSeries中的</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">如果movieInDb存在，那么就是在原来的基础上保存修改过后的内容，如果不存在，就是一个空对象</span></span><br><span class="line"><span class="comment">然后就把新建或者要更新的movie的信息都填到这个对象当中去</span></span><br><span class="line"><span class="comment">export function saveMovie(movie) &#123;</span></span><br><span class="line"><span class="comment">  let movieInDb = movies.find((m) =&gt; m._id === movie._id) || &#123;&#125;;</span></span><br><span class="line"><span class="comment">  movieInDb.name = movie.name;</span></span><br><span class="line"><span class="comment">  movieInDb.genre = genresAPI.genres.find((g) =&gt; g._id === movie.genreId);</span></span><br><span class="line"><span class="comment">  movieInDb.numberInStock = movie.numberInStock;</span></span><br><span class="line"><span class="comment">  movieInDb.dailyRentalRate = movie.dailyRentalRate;</span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">这里要注意要把Date.now()转换成string类型的，否则类型不同，无法保存</span></span><br><span class="line"><span class="comment">通过push来吧这个电影信息加到Db当中去</span></span><br><span class="line"><span class="comment">  if (!movieInDb._id) &#123;</span></span><br><span class="line"><span class="comment">    movieInDb._id = Date.now().toString();</span></span><br><span class="line"><span class="comment">    movies.push(movieInDb);</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  return movieInDb;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">  doSubmit = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    saveMovie(<span class="keyword">this</span>.state.data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.props.history.push(<span class="string">"/movies"</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="comment">//随后渲染这个表单。</span></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h1&gt;Movie Form&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">        &lt;form onSubmit=&#123;this.handleSubmit&#125;&gt;</span></span><br><span class="line"><span class="regexp">          &#123;this.renderInput("title", "Title")&#125;</span></span><br><span class="line"><span class="regexp">          &#123;this.renderSelect("genreId", "Genre", this.state.genres)&#125;</span></span><br><span class="line"><span class="regexp">          &#123;this.renderInput("numberInStock", "Number in Stock", "number")&#125;</span></span><br><span class="line"><span class="regexp">          &#123;this.renderInput("dailyRentalRate", "Rate")&#125;</span></span><br><span class="line"><span class="regexp">          &#123;this.renderButton("Save")&#125;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>form&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default MovieForm;</span></span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-Search-Movies-加入搜索功能"><a href="#Exercise-3-Search-Movies-加入搜索功能" class="headerlink" title="Exercise 3- Search Movies    加入搜索功能"></a>Exercise 3- Search Movies    加入搜索功能</h3><p>首先建一个SearchBox</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> SearchBox = <span class="function">(<span class="params">&#123; value, onChange &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;input</span><br><span class="line">      type=<span class="string">"text"</span></span><br><span class="line">      name=<span class="string">"query"</span></span><br><span class="line">      className=<span class="string">"form-control my-3"</span></span><br><span class="line">      placeholder=<span class="string">"Search..."</span></span><br><span class="line">      value=&#123;value&#125;</span><br><span class="line">        <span class="comment">//当我在表单输入的时候，我们调用onChange，然后从输入框中获取value值赋给handleSearch</span></span><br><span class="line">      onChange=&#123;e =&gt; onChange(e.currentTarget.value)&#125;</span><br><span class="line">    /&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> SearchBox;</span><br></pre></td></tr></table></figure>
<p>然后在Movies中添加这个组件和handleSearch方法</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//... </span></span><br><span class="line">state = &#123;</span><br><span class="line">    <span class="comment">//我们虽然可以不在这个state中声明赋值，因为直接state.属性也是可以访问的(只是没value)</span></span><br><span class="line">    <span class="comment">//但是呢我们一般还是要声明的，这样对自己和别人看代码更有帮助</span></span><br><span class="line">    movies: [],</span><br><span class="line">    genres: [],</span><br><span class="line">    currentPage: <span class="number">1</span>,</span><br><span class="line">    pageSize: <span class="number">4</span>,</span><br><span class="line">    searchQuery: <span class="string">""</span>,</span><br><span class="line">    selectedGenre: <span class="literal">null</span>,</span><br><span class="line">    sortColumn: &#123; <span class="attr">path</span>: <span class="string">"title"</span>, <span class="attr">order</span>: <span class="string">"asc"</span> &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="comment">/*这里拿到的是一个字符串，因为我们把Input放到了组件当中，当搜索框发生改变的时候，onChange</span></span><br><span class="line"><span class="comment">调用了handleSearch，然后handleSearch 实现了对state的更新，注意，这里要把currentPage</span></span><br><span class="line"><span class="comment">重置为1，因为我们当前可能不在第一页，那就看不到第一页的内容了！</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"> handleSearch = <span class="function">(<span class="params">query</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">searchQuery</span>: query, <span class="attr">selectedGenre</span>: <span class="literal">null</span>, <span class="attr">currentPage</span>: <span class="number">1</span> &#125;);</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"> </span><br><span class="line">&lt;SearchBox value=&#123;searchQuery&#125; onChange=&#123;<span class="keyword">this</span>.handleSearch&#125; /&gt;</span><br></pre></td></tr></table></figure>
<p> 此外我们还需要修改movies.jsx种getPageData方法 对原来的filter函数进行了修改</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> filtered = allMovies;</span><br><span class="line"><span class="comment">//如果searchQuery非空，那么我们就要选择电影名称以searchQuery开头的电影（这里没实现模糊查询）</span></span><br><span class="line"><span class="keyword">if</span> (searchQuery)</span><br><span class="line">  filtered = allMovies.filter(<span class="function">(<span class="params">m</span>) =&gt;</span></span><br><span class="line">    m.title.toLowerCase().startsWith(searchQuery.toLowerCase())</span><br><span class="line">  );</span><br><span class="line"><span class="comment">//否则就像之前一样，选择电影类型和selectedGenre一样的电影</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (selectedGenre &amp;&amp; selectedGenre._id)</span><br><span class="line">  filtered = allMovies.filter(<span class="function">(<span class="params">m</span>) =&gt;</span> m.genre._id === selectedGenre._id);</span><br><span class="line"><span class="comment">//如果都不满足，就说明现在是All Genres，且没有查询内容，那么不变 filtered = allMovies;</span></span><br></pre></td></tr></table></figure>
<h2 id="Calling-Backend-Services"><a href="#Calling-Backend-Services" class="headerlink" title="Calling Backend Services"></a>Calling Backend Services</h2><p>这一章开始我们来讲讲前后端链接</p>
<h3 id="JSON-Placeholder"><a href="#JSON-Placeholder" class="headerlink" title="JSON Placeholder"></a>JSON Placeholder</h3><p><a href="http://jsonplaceholder.typicode.com/posts" target="_blank" rel="noopener">http://jsonplaceholder.typicode.com/posts</a></p>
<p>Extension:JSONView </p>
<p>jsonplaceholder 给我们提供了一个API，这个API提供了诸如帖子等功能的一些终端</p>
<p>我们可以通过它来实现CRUD(增删改查)</p>
<h3 id="Http-Clients"><a href="#Http-Clients" class="headerlink" title="Http Clients"></a>Http Clients</h3><p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/11.png" style="zoom:80%;"></p>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/12.png" style="zoom:80%;"></p>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/13.png" style="zoom:80%;"></p>
<p>几种发送Http请求的方式</p>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/14.png" style="zoom:80%;"></p>
<p>这里先下载Axios</p>
<p>npm install axios@0.18</p>
<p>利用源码中的 <a href="https://www.filepicker.io/api/file/ZfFMGUER9OAWZWe4kkWk" target="_blank" rel="noopener">https://www.filepicker.io/api/file/ZfFMGUER9OAWZWe4kkWk</a></p>
<p>http-app ，npm install ，npm start 打开</p>
<h3 id="Getting-Data"><a href="#Getting-Data" class="headerlink" title="Getting Data"></a>Getting Data</h3><p>利用axios获取数据,在app.js中导入后，添加cdm，然后在里面请求刚才的页面</p>
<p>这里的promise是一个装载异步操作的对象，promise对象承诺保存异步操作的结果</p>
<p>当我声明promise的时候，它历即进入pending状态 pending&gt;resolved(success) OR rejected(failure)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">componentDidMount() &#123;</span><br><span class="line"> 	<span class="keyword">const</span> promise= axios.get(<span class="string">'http://jsonplaceholder.typicode.com/posts'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(promise);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/15.png" style="zoom:80%;"></p>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/16.png" style="zoom:50%;"></p>
<p>这些就是我们请求来的数据，但是我们真正想要的是Object中的部分，也就是config，data…..</p>
<p>我们只想获取具体的数据，所以我们做这样一步：利用ES6中的新型特性await，await和async总时成对出现，所以在这个Hook 前我们还要用async修饰</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> componentDidMount() &#123;</span><br><span class="line">  <span class="keyword">const</span> promise = axios.get(<span class="string">"http://jsonplaceholder.typicode.com/posts"</span>);</span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> promise;</span><br><span class="line">  <span class="built_in">console</span>.log(response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/17.png" style="zoom:70%;"></p>
<p>我们还有更简洁的写法</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> componentDidMount() &#123;</span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> axios.get(<span class="string">"http://jsonplaceholder.typicode.com/posts"</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进一步我们只想获取data，那么我们就用析构就好了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> componentDidMount() &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;<span class="attr">data</span>:posts&#125; = <span class="keyword">await</span> axios.get(<span class="string">"http://jsonplaceholder.typicode.com/posts"</span>);</span><br><span class="line">  <span class="keyword">this</span>.setState(&#123;posts&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>更新完成后，因为框架老师已经搭好了，所以我们就直接可以看到这些帖子了</p>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/18.png" style="zoom:70%;"></p>
<h3 id="Creating-Data"><a href="#Creating-Data" class="headerlink" title="Creating Data"></a>Creating Data</h3><p>如上图我们点击了Add以后，会得到一个表单，点击提交以后在现实情况下会形成一个对象，发送给后端，后端得到以后存储至数据库。现在我们来模拟一下</p>
<p>上面我用了get来请求数据，这里我用post来创建一条数据</p>
<p>创建有两方面，前端创建（表格上显示）和后端创建（数据库中存放）</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//值得注意的是，这里是一个方法属性，所以async要卸载handleAdd后面  </span></span><br><span class="line">handleAdd = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="comment">//假设我们想把 title为a，body为b的放到这个表格当中，那么我们就新建一个对象</span></span><br><span class="line">    <span class="keyword">const</span> obj = &#123; <span class="attr">title</span>: <span class="string">"a"</span>, <span class="attr">body</span>: <span class="string">"b"</span> &#125;;</span><br><span class="line">     <span class="comment">//然后利用post把这个对象给post到这个假的服务器上去，返回值我们解构出data并重命名post</span></span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="attr">data</span>: post &#125; = <span class="keyword">await</span> axios.post(apiEndpoint, obj);</span><br><span class="line">      <span class="comment">//打印</span></span><br><span class="line">    <span class="built_in">console</span>.log(post);</span><br><span class="line">      <span class="comment">//实现本地state的更新 把post放在其他的数据之前</span></span><br><span class="line">    <span class="keyword">const</span> posts = [post, ...this.state.posts];</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; posts &#125;);</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/19.png" style="zoom:70%;"></p>
<p>但是我们发现有id相同的信息，这是因为我们这不是一个真的服务器。</p>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/20.png" style="zoom:70%;"></p>
<h3 id="Lifecycle-of-a-Request"><a href="#Lifecycle-of-a-Request" class="headerlink" title="Lifecycle of a Request"></a>Lifecycle of a Request</h3><p>现在看看一个request的生命周期</p>
<p>先来看看第一张图，Request Method 是OPTIONS， 每个HTTP请求都有个叫做“Method”的属性来描述这个请求的目的（增删改查），通常的方式是get得到，post创建，put更新，delete删除</p>
<p>这里是个options请求，产生的原因是这个应用在本地运行，但是他的后端却在别的地方<a href="http://jsonplaceholder.typicode.com/posts" target="_blank" rel="noopener">jsonplaceholder</a></p>
<p>这是两个独立的域，从安全角度考虑，当一个应用向另一个域发起HTTP请求的时候，浏览器总会发出一个options请求，这就是为何这有OPTIONS了</p>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/22.png" style="zoom:70%;"></p>
<p>再来看看第二张，这里请求的地址一样，但实际Method确实Post。Post用于创建数据。状态码为201代表了这个已经成功创建了。</p>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/21.png" style="zoom:70%;"></p>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/23.png" style="zoom:70%;"></p>
<p>现在来看反馈标签，这里你可以看到网站服务器给我们的反馈。适合我们发给他的一样的。Axios将这个对象保存到了一个response对象当中。这个response是对象有一个data属性（我们解构出来的）。 这个response对象有其他属性，我们可以用来读取请求的状态以及请求头等等，这就是一个请求的生命周期</p>
<h3 id="Updating-Data"><a href="#Updating-Data" class="headerlink" title="Updating Data"></a>Updating Data</h3><p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/25.png" style="zoom:70%;"></p>
<p>我们看到如果要更新一条信息的话，必须在请求的时候在posts后面加上当前信息的id才可以。</p>
<p>所以我们用put方式实现更新，先来看看我们能不能正确的请求信息。</p>
<p>（更新有两种方法，一种是put，一种是patch，patch可以针对对象的特定属性实现更新，而put是对整个对象实现更新）这里用了put，所以在传入第二个参数的时候我把整个post全传进去了</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">handleUpdate = <span class="keyword">async</span> (post) =&gt; &#123;</span><br><span class="line">  post.title = <span class="string">"UPDATED"</span>;</span><br><span class="line">  <span class="keyword">const</span> &#123; data &#125; = axios.put(apiEndpoint + <span class="string">"/"</span> + post.id, post);</span><br><span class="line">  <span class="built_in">console</span>.log(data);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/26.png" style="zoom:50%;"></p>
<p>我们看到点击以后title就改成了UPDATED</p>
<p>为了更新一个对象(资源)，我们向后端发送了HTTP请求，这个后端有给定的id的资源，所以服务器得到了id，然后在response中返回了这个对象（资源）</p>
<p>好，现在我们实现更新。更新有两方面，前端更新（表格上更新）和后端更新（数据库更新）</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">handleUpdate = <span class="keyword">async</span> (post) =&gt; &#123;</span><br><span class="line">    post.title = <span class="string">"UPDATED"</span>;</span><br><span class="line">    <span class="keyword">await</span> axios.put(apiEndpoint + <span class="string">"/"</span> + post.id, post);<span class="comment">//到这里实现了后端更新，但前端未变</span></span><br><span class="line">    <span class="comment">//现在把整个state.posts拷贝下来</span></span><br><span class="line">    <span class="keyword">const</span> posts = [...this.state.posts];</span><br><span class="line">    <span class="comment">//现在得到要更新的那个对象的index</span></span><br><span class="line">    <span class="keyword">const</span> index = posts.indexOf(post);</span><br><span class="line">    <span class="comment">//现在用更新完毕的post去覆盖原来的post</span></span><br><span class="line">    posts[index] = &#123; ...post &#125;;</span><br><span class="line">    <span class="comment">//实现更新</span></span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; posts &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/27.png" style="zoom:50%;"></p>
<h3 id="Deleting-Data"><a href="#Deleting-Data" class="headerlink" title="Deleting Data"></a>Deleting Data</h3><p>同样的，删除数据也要从后端和前端同时删除</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">handleDelete = <span class="keyword">async</span> (post) =&gt; &#123;</span><br><span class="line">  axios.delete(apiEndpoint + <span class="string">"/"</span> + post.id);</span><br><span class="line">  <span class="keyword">const</span> posts = <span class="keyword">this</span>.state.posts.filter(<span class="function">(<span class="params">p</span>) =&gt;</span> p.id !== post.id);</span><br><span class="line">  <span class="keyword">this</span>.setState(&#123; posts &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>就不用我多说了</p>
<h3 id="Optimistic-vs-Pessimistic-Updates"><a href="#Optimistic-vs-Pessimistic-Updates" class="headerlink" title="Optimistic vs Pessimistic Updates"></a>Optimistic vs Pessimistic Updates</h3><p>但是我们在操作的时候，常常会有半秒到一秒钟的延迟。这是因为我们总是先请求服务器。然后再更新视图。使用这种方法实现的话，当请求服务器后端出现错误的时候，余下的代码将不会被执行。这就是我们说的Pessimistic Updates，因为我们不确定请求服务器后是否成功</p>
<p>Optimistic Updates：我们假设服务器大部分情况都是请求成功的，所以不妨先更新界面，再请求服务器。如果请求失败，我们再回滚至用户之前的界面</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">handleDelete = <span class="keyword">async</span> (post) =&gt; &#123;</span><br><span class="line">    <span class="comment">//首先我们先把原来的state保存下来</span></span><br><span class="line">  <span class="keyword">const</span> originalPosts = <span class="keyword">this</span>.state.posts;</span><br><span class="line">    <span class="comment">//实现界面的更新</span></span><br><span class="line">  <span class="keyword">const</span> posts = <span class="keyword">this</span>.state.posts.filter(<span class="function">(<span class="params">p</span>) =&gt;</span> p.id !== post.id);</span><br><span class="line">  <span class="keyword">this</span>.setState(&#123; posts &#125;);</span><br><span class="line">    <span class="comment">//然后请求服务器，如果发生错误（这里我为了测试手动抛出一个错误）</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    axios.delete(apiEndpoint + <span class="string">"/"</span> + post.id);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">''</span>)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ex) &#123;<span class="comment">//接收到错误后，再浏览器发出alert</span></span><br><span class="line">      <span class="comment">//然后回滚，就是把之前保存着的”备份“更新回去</span></span><br><span class="line">    alert(<span class="string">"Something failed while deleting a post!"</span>);</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">posts</span>: originalPosts &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="Expected-vs-Unexpected-Errors"><a href="#Expected-vs-Unexpected-Errors" class="headerlink" title="Expected vs Unexpected Errors"></a>Expected vs Unexpected Errors</h3><p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/28.png"></p>
<p>我们怎么判断这里获得的异常是一个可预见的错误呢</p>
<p>这里有两个异常对象的属性：</p>
<p>ex.request:这个属性在成功发送请求给服务器时被设置</p>
<p>ex.resposne:这个属性在服务器正常反馈的时候被设置为null</p>
<p>所以这个逻辑可以这么处理，当ex.response不为空（错误存在）且状态码为404的时候，我们就收到了一个Expected Errors，否则我们收到的就是Unexpected Errors</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">handleDelete = <span class="keyword">async</span> (post) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> originalPosts = <span class="keyword">this</span>.state.posts;</span><br><span class="line">  <span class="keyword">const</span> posts = <span class="keyword">this</span>.state.posts.filter(<span class="function">(<span class="params">p</span>) =&gt;</span> p.id !== post.id);</span><br><span class="line">  <span class="keyword">this</span>.setState(&#123; posts &#125;);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    axios.delete(apiEndpoint + <span class="string">"/"</span> + post.id);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ex.response &amp;&amp; ex.response.status === <span class="number">404</span>)</span><br><span class="line">      alert(<span class="string">"This post has already been deleted!"</span>);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Logging the error'</span>,ex);</span><br><span class="line">      alert(<span class="string">"An unexcepted error occurred!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">posts</span>: originalPosts &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="Handling-Unexpected-Errors-Globally"><a href="#Handling-Unexpected-Errors-Globally" class="headerlink" title="Handling Unexpected Errors Globally"></a>Handling Unexpected Errors Globally</h3><p>我们现在只是在handleDelete中做到了检查异常。但是我们需要在发帖，更新贴，读取贴的时候都实现。所以如果有个不可预期的错误，那么就需要记录日志，打印错误信息。但是我们不想再每个地方都这样重复相同的代码</p>
<p>这时候应该使用 Axios Interceptors。 我们在类外写这个方法。</p>
<p>axios.interceptors后可以有response也可以有request，传入的参数是两个函数。第一个函数是成功的时候调用的，第二个函数是失败的时候调用的。这里我们只写当发生错误的时候该怎么办，所以把第一个参数设置为null</p>
<p>为了让catch捕获异常，我们需要返回一个Promise.reject 这是一个对象，我们就把axios发现的错误放到这个对象当中。这样我们无论何时得到了一个错误，我们就会调用axios.interceptors，然后控制权交给catch处理</p>
<p> 现在，我们让axios.interceptors处理unexpectedError，那么我先过滤掉4开头的状态码，因为那些都是expectedError，如果还有错误，那就是unexpectedError，我们就记录日志，并且给一个alert。不管发现的是expected还是unexpected error，都需要返回一个Promise.reject</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">axios.interceptors.response.use(<span class="literal">null</span>, (error) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> expectedError =</span><br><span class="line">    error.response &amp;&amp;</span><br><span class="line">    error.response.status &gt;= <span class="number">400</span> &amp;&amp;</span><br><span class="line">    error.response.status &lt;= <span class="number">500</span>;</span><br><span class="line">  <span class="keyword">if</span> (!expectedError) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Logging the error"</span>, error);</span><br><span class="line">    alert(<span class="string">"An unexcepted error occurred!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>如果把id改成999，那么这就输入404的范畴，会显示 This post has already been deleted</p>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/30.png" style="zoom:50%;"></p>
<p>如果我们请求一个非法的网址，那么我们就会得到一个  unexpected error，那么就像这样</p>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/29.png" style="zoom:50%;"></p>
<p>这样，只有在我需要针对特定错误做什么的时候，我们才在下面的catch中写上错误的类型以及弹出的内容。其他的错误就交给axios.interceptors去解决</p>
<h3 id="Extracting-a-Reusable-Http-Service"><a href="#Extracting-a-Reusable-Http-Service" class="headerlink" title="Extracting a Reusable Http Service"></a>Extracting a Reusable Http Service</h3><p>使用axios.interceptors我们成功处理了不可预期的错误。但这不理想，他污染了App module，所以这些代码把App.js 复杂化了。另外一点是当某天我想要创建另外一个React应用的时候。我需要回来复制这段axios.interceptors到新的应用。我们可以把Http Service变成一个可以重复利用的module</p>
<p>我们新建一个service 文件夹，新建一个 httpService.js,然后把这些处理错误的代码放到httpService当中</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">"axios"</span>;</span><br><span class="line">axios.interceptors.response.use(<span class="literal">null</span>, (error) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> expectedError =</span><br><span class="line">    error.response &amp;&amp;</span><br><span class="line">    error.response.status &gt;= <span class="number">400</span> &amp;&amp;</span><br><span class="line">    error.response.status &lt;= <span class="number">500</span>;</span><br><span class="line">  <span class="keyword">if</span> (!expectedError) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Logging the error"</span>, error);</span><br><span class="line">    alert(<span class="string">"An unexcepted error occurred!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error);</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span>&#123;</span><br><span class="line">    <span class="keyword">get</span>:axios.<span class="keyword">get</span>,</span><br><span class="line">    post:axios.post,</span><br><span class="line">    put:axios.put,</span><br><span class="line">    delete:axios.delete,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在导入httpService后把App.js中所有的axios都换成http</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">"./services/httpService"</span>;</span><br></pre></td></tr></table></figure>
<p>这样，这个模块就不再使用axios模块了，我们把Axios服务隐藏在http模块了，之后我如果想换一个库替代axios，我们需只要改一个地方。也就是我的httpService.js 。只要这个模块能导出get，post，put，delete方法，应用中的其余部分都不会受到影响。App.js中我们并不关心使用了什么库来发送HTTP请求，这是封装一个http模块最主要的好处之一了。新建项目的话也会方便很多</p>
<h3 id="Extracting-a-Config-Module"><a href="#Extracting-a-Config-Module" class="headerlink" title="Extracting a Config Module"></a>Extracting a Config Module</h3><p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/31.png" style="zoom:80%;"></p>
<p>然后在App.js中引入的时候，把所有的apiEndpoint 都改成config</p>
<p>这样可以避免 hard coding</p>
<h3 id="Displaying-Toast-Notifications"><a href="#Displaying-Toast-Notifications" class="headerlink" title="Displaying Toast Notifications"></a>Displaying Toast Notifications</h3><p>我们把原来的alert弹窗改成这样的，会比原来更加美观</p>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/32.png" style="zoom:80%;"></p>
<p>npm i react-toastify@4.1</p>
<p>然后导入</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ToastContainer &#125; <span class="keyword">from</span> <span class="string">"react-toastify"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"react-toastify/dist/ReactToastify.css"</span>;</span><br></pre></td></tr></table></figure>
<p>在把httpService中的alert改成 toast.error(“An unexcepted error occurred!”);</p>
<p>toast还有其他的如success，warn等弹窗</p>
<p>当然也可以直接改成 toast (“An unexcepted error occurred!”); 颜色更好看</p>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/33.png" style="zoom:80%;"></p>
<h3 id="Logging-Errors"><a href="#Logging-Errors" class="headerlink" title="Logging Errors"></a>Logging Errors</h3><p>我们要把日志作为系统功能的一部分。这里使用Sentry.io</p>
<p>//..</p>
<h3 id="Extracting-a-Logger-Service"><a href="#Extracting-a-Logger-Service" class="headerlink" title="Extracting a Logger Service"></a>Extracting a Logger Service</h3><p>//…</p>
<h3 id="Vidly-Backend"><a href="#Vidly-Backend" class="headerlink" title="Vidly Backend"></a>Vidly Backend</h3><p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/34.png" style="zoom:80%;"></p>
<h3 id="Setting-Up-the-Node-Backend"><a href="#Setting-Up-the-Node-Backend" class="headerlink" title="Setting Up the Node Backend"></a>Setting Up the Node Backend</h3><p><a href="https://www.bilibili.com/video/BV1Sb411P79t?p=153" target="_blank" rel="noopener">https://www.bilibili.com/video/BV1Sb411P79t?p=153</a></p>
<p>有个坑。。需要先手动安装这个bcrypt否则一大堆错误</p>
<p>npm install bcrypt —unsafe-perm</p>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/35.png" style="zoom:80%;"></p>
<p>这就算成功了。</p>
<p>这个后端支持CRUD</p>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/36.png" style="zoom:80%;"></p>
<p>如果要修改数据，需要在config.json中修改设置</p>
<h3 id="Disabling-Authentication"><a href="#Disabling-Authentication" class="headerlink" title="Disabling Authentication"></a>Disabling Authentication</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"jwtPrivateKey"</span>: <span class="string">"unsecureKey"</span>,</span><br><span class="line">  <span class="attr">"db"</span>: <span class="string">"mongodb://localhost/vidly"</span>,</span><br><span class="line">  <span class="attr">"port"</span>: <span class="string">"3900"</span>,</span><br><span class="line">  <span class="attr">"requiresAuth"</span>: <span class="literal">false</span> <span class="comment">//修改成false，这样不需要授权认证即可修改</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-Connect-Movies-Page-to-the-Backend"><a href="#Exercise-Connect-Movies-Page-to-the-Backend" class="headerlink" title="Exercise- Connect Movies Page to the Backend"></a>Exercise- Connect Movies Page to the Backend</h3><p>把连接内存改为链接后端</p>
<h3 id="Adding-Http-and-Log-Services"><a href="#Adding-Http-and-Log-Services" class="headerlink" title="Adding Http and Log Services"></a>Adding Http and Log Services</h3><p>在service文件夹中导入 httpservice</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">"axios"</span>;</span><br><span class="line"><span class="keyword">import</span> logger <span class="keyword">from</span> <span class="string">"./logService"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; toast &#125; <span class="keyword">from</span> <span class="string">"react-toastify"</span>;</span><br><span class="line"></span><br><span class="line">axios.interceptors.response.use(<span class="literal">null</span>, error =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> expectedError =</span><br><span class="line">    error.response &amp;&amp;</span><br><span class="line">    error.response.status &gt;= <span class="number">400</span> &amp;&amp;</span><br><span class="line">    error.response.status &lt; <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!expectedError) &#123;</span><br><span class="line">    logger.log(error);</span><br><span class="line">    toast.error(<span class="string">"An unexpected error occurrred."</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="keyword">get</span>: axios.<span class="keyword">get</span>,</span><br><span class="line">  post: axios.post,</span><br><span class="line">  put: axios.put,</span><br><span class="line">  delete: axios.delete</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>logservice</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.error(error);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  init,</span><br><span class="line">  log</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>app中导入</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ToastContainer &#125; <span class="keyword">from</span> <span class="string">"react-toastify"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"react-toastify/dist/ReactToastify.css"</span>;</span><br></pre></td></tr></table></figure>
<p>添加<ToastContainer \></ToastContainer></p>
<h3 id="Replacing-FakeGenreService"><a href="#Replacing-FakeGenreService" class="headerlink" title="Replacing FakeGenreService"></a>Replacing FakeGenreService</h3><p>在service文件夹中新建genreService.js</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> apiUrl=<span class="string">"http://localhost:3900/api"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getGenres</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> http.get(apiUrl + <span class="string">"/genres"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在movies中修改</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">import</span> &#123; getGenres &#125; <span class="keyword">from</span> <span class="string">"../services/genreService"</span>;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">async</span> componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; data &#125; = <span class="keyword">await</span> getGenres();</span><br><span class="line">    <span class="keyword">const</span> genres = [&#123; <span class="attr">_id</span>: <span class="string">""</span>, <span class="attr">name</span>: <span class="string">"All Genres"</span> &#125;, ...data];</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="attr">data</span>: movies &#125; = <span class="keyword">await</span> getMovies();</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; movies, genres &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Replacing-FakeMovieService"><a href="#Replacing-FakeMovieService" class="headerlink" title="Replacing FakeMovieService"></a>Replacing FakeMovieService</h3><p>movieService.js</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">"./httpService"</span>;</span><br><span class="line">apiUrl=<span class="string">"http://localhost:3900/api"</span>;</span><br><span class="line"><span class="keyword">const</span> apiEndpoint = apiUrl + <span class="string">"/movies"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getMovies</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> http.get(apiEndpoint);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteMovie</span>(<span class="params">movieId</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> http.delete(apiEndpoint+<span class="string">"/"</span>+movieId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在movies中给对应的函数加上async 和await</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">async</span> componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; data &#125; = <span class="keyword">await</span> getGenres();</span><br><span class="line">    <span class="keyword">const</span> genres = [&#123; <span class="attr">_id</span>: <span class="string">""</span>, <span class="attr">name</span>: <span class="string">"All Genres"</span> &#125;, ...data];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="attr">data</span>: movies &#125; = <span class="keyword">await</span> getMovies();</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; movies, genres &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="comment">//我们这里实现optmistic  利用try-catch</span></span><br><span class="line">  handleDelete = <span class="keyword">async</span> movie =&gt; &#123;</span><br><span class="line">     <span class="keyword">const</span> originalMovies = <span class="keyword">this</span>.state.movies;</span><br><span class="line">    <span class="keyword">const</span> movies  = <span class="keyword">this</span>.state.movies.filter(<span class="function"><span class="params">m</span>=&gt;</span>m._id!=movie._id);</span><br><span class="line">      <span class="keyword">this</span>.setState (&#123;movies&#125;);</span><br><span class="line">      <span class="keyword">try</span>&#123;</span><br><span class="line">          <span class="keyword">await</span> deleteMovie(movie._id);</span><br><span class="line">      &#125;<span class="keyword">catch</span>(ex)&#123;</span><br><span class="line">          <span class="keyword">if</span>(ex.response&amp;&amp;ex.response.status===<span class="number">404</span>)</span><br><span class="line">              toast.error(<span class="string">'This movie has already been deleted'</span>);</span><br><span class="line">           <span class="keyword">this</span>.setState(&#123; <span class="attr">movies</span>: originalMovies &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>现在的表格就是以数据库数据构成的。现在删除的话，就是真的在数据库中删除了</p>
<h3 id="Extracting-a-Config-File-封装配置文件"><a href="#Extracting-a-Config-File-封装配置文件" class="headerlink" title="Extracting a Config File 封装配置文件"></a>Extracting a Config File 封装配置文件</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"apiUrl"</span>: <span class="string">"http://localhost:3900/api"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在logService和httpService中进行修改</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">"./httpService"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; apiUrl &#125; <span class="keyword">from</span> <span class="string">"../config.json"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getGenres</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> http.get(apiUrl + <span class="string">"/genres"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">"./httpService"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; apiUrl &#125; <span class="keyword">from</span> <span class="string">"../config.json"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> apiEndpoint = apiUrl + <span class="string">"/movies"</span>;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<h3 id="Exercise-Connect-Movie-Form-to-the-Backend"><a href="#Exercise-Connect-Movie-Form-to-the-Backend" class="headerlink" title="Exercise- Connect Movie Form to the Backend"></a>Exercise- Connect Movie Form to the Backend</h3><p>现在我们如果点击电影，会发现</p>
<p><img src="/2020/06/04/react%E5%9F%BA%E7%A1%803/37.png" style="zoom:80%;"></p>
<p>这是因为movieForm任然使用了fakeMovieService</p>
<p>我们现在来替换他</p>
<p>movieService.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">"./httpService"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; apiUrl &#125; <span class="keyword">from</span> <span class="string">"../config.json"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> apiEndpoint = apiUrl + <span class="string">"/movies"</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">为了不到处使用字符串拼接，我们把代码重构一下</span></span><br><span class="line"><span class="comment">这里使用Es6中的模板语法，$&#123;&#125;中的参数会实时计算</span></span><br><span class="line"><span class="comment">= return apiEndpoint+'/'+id;</span></span><br><span class="line"><span class="comment">然后把接下来的都替换掉</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">movieUrl</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;apiEndpoint&#125;</span>/<span class="subst">$&#123;id&#125;</span>`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getMovies</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> http.get(apiEndpoint);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">import &#123; getMovie, saveMovie &#125; from "../services/movieService";</span></span><br><span class="line"><span class="comment">因为movieServise没有这两个函数，所以我们写一下这两个函数</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getMovie</span>(<span class="params">movieId</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> http.get(movieUrl(movieId));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">这个save函数可以保存新建的电影信息，也可以更新已经有的电影信息。</span></span><br><span class="line"><span class="comment">如果movie._id存在的，那么我们就要用put(第一个参数是url,第二个参数是请求对象)</span></span><br><span class="line"><span class="comment">但是我们做的后端不喜欢请求体中有id。因为如果body中有id的话，那么前面也是id，后面也有id，</span></span><br><span class="line"><span class="comment">会产生混淆。</span></span><br><span class="line"><span class="comment">为了解决这个问题，我们就克隆这个movie的信息，然后删除这个id属性，在把这两个参数传入put</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">如果movie._id不存在，说明我们是新建电影信息，这样我们就用point</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">saveMovie</span>(<span class="params">movie</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (movie._id) &#123;</span><br><span class="line">    <span class="keyword">const</span> body = &#123; ...movie &#125;;</span><br><span class="line">    <span class="keyword">delete</span> body._id;</span><br><span class="line">    <span class="keyword">return</span> http.put(movieUrl(movie._id), body);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> http.post(apiEndpoint, movie);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteMovie</span>(<span class="params">movieId</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> http.delete(movieUrl(movieId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>movieForm.jsx</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> Joi <span class="keyword">from</span> <span class="string">"joi-browser"</span>;</span><br><span class="line"><span class="keyword">import</span> Form <span class="keyword">from</span> <span class="string">"./common/form"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getMovie, saveMovie &#125; <span class="keyword">from</span> <span class="string">"../services/movieService"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getGenres &#125; <span class="keyword">from</span> <span class="string">"../services/genreService"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MovieForm</span> <span class="keyword">extends</span> <span class="title">Form</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    data: &#123;</span><br><span class="line">      title: <span class="string">""</span>,</span><br><span class="line">      genreId: <span class="string">""</span>,</span><br><span class="line">      numberInStock: <span class="string">""</span>,</span><br><span class="line">      dailyRentalRate: <span class="string">""</span></span><br><span class="line">    &#125;,</span><br><span class="line">    genres: [],</span><br><span class="line">    errors: &#123;&#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  schema = &#123;</span><br><span class="line">    _id: Joi.string(),</span><br><span class="line">    title: Joi.string()</span><br><span class="line">      .required()</span><br><span class="line">      .label(<span class="string">"Title"</span>),</span><br><span class="line">    genreId: Joi.string()</span><br><span class="line">      .required()</span><br><span class="line">      .label(<span class="string">"Genre"</span>),</span><br><span class="line">    numberInStock: Joi.number()</span><br><span class="line">      .required()</span><br><span class="line">      .min(<span class="number">0</span>)</span><br><span class="line">      .max(<span class="number">100</span>)</span><br><span class="line">      .label(<span class="string">"Number in Stock"</span>),</span><br><span class="line">    dailyRentalRate: Joi.number()</span><br><span class="line">      .required()</span><br><span class="line">      .min(<span class="number">0</span>)</span><br><span class="line">      .max(<span class="number">10</span>)</span><br><span class="line">      .label(<span class="string">"Daily Rental Rate"</span>)</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> populateGenres() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="attr">data</span>: genres &#125; = <span class="keyword">await</span> getGenres();</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; genres &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">try catch 的作用就是当输入未存储的电影id的时候，我们就需要导向not-found，之前是通过</span></span><br><span class="line"><span class="comment">if(!movie) return this.props.history.replace("/not-found")实现的,但现在需要catch到异常才执行这一步;</span></span><br><span class="line"><span class="comment">try放在第一行，更加美观，反正不影响</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">  <span class="keyword">async</span> populateMovie() &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> movieId = <span class="keyword">this</span>.props.match.params.id;</span><br><span class="line">      <span class="keyword">if</span> (movieId === <span class="string">"new"</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> &#123; <span class="attr">data</span>: movie &#125; = <span class="keyword">await</span> getMovie(movieId);</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; <span class="attr">data</span>: <span class="keyword">this</span>.mapToViewModel(movie) &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">      <span class="keyword">if</span> (ex.response &amp;&amp; ex.response.status === <span class="number">404</span>)</span><br><span class="line">        <span class="keyword">this</span>.props.history.replace(<span class="string">"/not-found"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//这里代码重构一下，更具有可读性，否则堆起来很不好看。在render 这个hook结束之后，</span></span><br><span class="line"><span class="comment">//调用commponentDidMount 这个hook，然后他有会调用两个函数，把genre和movies都渲染上去</span></span><br><span class="line"><span class="comment">//componentDidMount 就不会被渲染</span></span><br><span class="line">  <span class="keyword">async</span> componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">this</span>.populateGenres();</span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">this</span>.populateMovie();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  mapToViewModel(movie) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      _id: movie._id,</span><br><span class="line">      title: movie.title,</span><br><span class="line">      genreId: movie.genre._id,</span><br><span class="line">      numberInStock: movie.numberInStock,</span><br><span class="line">      dailyRentalRate: movie.dailyRentalRate</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">这里用到了saveMovie所以要用 async和await</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">  doSubmit = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> saveMovie(<span class="keyword">this</span>.state.data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.props.history.push(<span class="string">"/movies"</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h1&gt;Movie Form&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">        &lt;form onSubmit=&#123;this.handleSubmit&#125;&gt;</span></span><br><span class="line"><span class="regexp">          &#123;this.renderInput("title", "Title")&#125;</span></span><br><span class="line"><span class="regexp">          &#123;this.renderSelect("genreId", "Genre", this.state.genres)&#125;</span></span><br><span class="line"><span class="regexp">          &#123;this.renderInput("numberInStock", "Number in Stock", "number")&#125;</span></span><br><span class="line"><span class="regexp">          &#123;this.renderInput("dailyRentalRate", "Rate")&#125;</span></span><br><span class="line"><span class="regexp">          &#123;this.renderButton("Save")&#125;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>form&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default MovieForm;</span></span><br></pre></td></tr></table></figure>
<p>现在，没有地方用到fakeservice了！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://jasonxqh.github.io/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason‘s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/" class="post-title-link" itemprop="url">离散数学之关系1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-02 13:44:32" itemprop="dateCreated datePublished" datetime="2020-06-02T13:44:32+08:00">2020-06-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-09-06 09:57:12" itemprop="dateModified" datetime="2020-09-06T09:57:12+08:00">2020-09-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="离散数学之关系1"><a href="#离散数学之关系1" class="headerlink" title="离散数学之关系1"></a>离散数学之关系1</h1><p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/0.png"></p>
<h2 id="Relation"><a href="#Relation" class="headerlink" title="Relation"></a>Relation</h2><h3 id="Binary-Relation"><a href="#Binary-Relation" class="headerlink" title="Binary Relation"></a>Binary Relation</h3><p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/1.png" style="zoom:80%;"></p>
<p>这样所有的二元运算符都可以成为一种关系，或者父子师生也可以成为一个关系</p>
<p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/2.png" style="zoom:80%;"></p>
<p>这个和我们的函数有点像，但是显然不是函数（一个x可以有多个指向），所以我们可以把关系看成一个函数的推广。函数本身就是个关系</p>
<h3 id="Function-as-relations"><a href="#Function-as-relations" class="headerlink" title="Function as relations"></a>Function as relations</h3><p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/3.png" style="zoom:80%;"></p>
<h3 id="Relations-on-a-set"><a href="#Relations-on-a-set" class="headerlink" title="Relations on a set"></a>Relations on a set</h3><p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/4.png" style="zoom:80%;"></p>
<ul>
<li>可以在一个集合中定义关系，比如说a能被b整除；或者a&lt;=b,a&gt;b等等</li>
</ul>
<h3 id="Representing-Relations"><a href="#Representing-Relations" class="headerlink" title="Representing Relations"></a>Representing Relations</h3><h4 id="Matrix-representing"><a href="#Matrix-representing" class="headerlink" title="Matrix representing"></a>Matrix representing</h4><p>也就是说如果$(a_i,b_j) $满足关系，那么这点上的数据就是1，否则就是0</p>
<p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/5.png" style="zoom:80%;"></p>
<h4 id="Digraph-definition"><a href="#Digraph-definition" class="headerlink" title="Digraph definition"></a>Digraph definition</h4><p>利用有向图来存储。如果a指向b，那么关系就是a在前，b在后</p>
<p>那么如果a到a有一条边，那么这就是一个自环</p>
<p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/6.png" style="zoom:80%;"></p>
<p><strong>Question:</strong> How many relations are there on a set with n elements?<br><strong>Solution:</strong><br>A relation on a set A is a subset of A X A. Because A X A has n^2^<br>elements when A has n elements. A set with m elements has 2^m^ subsets, there are $2^{m^2}$ subsets of AXA.<br>Thus, there are $2^{n^2}$ relations on a set with n elements.<br>For example, there are $2^{3^2} = 2^9 = 512$ relations on the set {a,b,c}</p>
<p>也就是说一个集合中的关系是非常非常复杂的</p>
<h2 id="Properties-of-Relations"><a href="#Properties-of-Relations" class="headerlink" title="Properties  of Relations"></a>Properties  of Relations</h2><h3 id="Reflexive-自反"><a href="#Reflexive-自反" class="headerlink" title="Reflexive 自反"></a>Reflexive 自反</h3><p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/7.png" style="zoom:80%;"></p>
<p>那么R1不是自反的，因为里面没有(3,3)</p>
<p>自反关系在图里面表示为一个自环，如果在矩阵上则是 对角线上都为1</p>
<p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/8.png" style="zoom:80%;"></p>
<h3 id="Symmetric-and-antisymmetric-对称和反对称"><a href="#Symmetric-and-antisymmetric-对称和反对称" class="headerlink" title="Symmetric and antisymmetric 对称和反对称"></a>Symmetric and antisymmetric 对称和反对称</h3><p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/9.png" style="zoom:80%;"></p>
<p>A relation R on a set A is called <strong>symmetric</strong> if $(b,a) \in R$ whenever $(a,b) \in R$, for all $ a,b  \in A$.   </p>
<p>对称的就是如果$(b,a) \in R$，那么必然 $(a,b) \in R$,  在矩阵中表示，就是非主对角线上的每一个1，对称点必然是1.</p>
<p>比如说我们的同学关系，相似关系，成比例关系，都是长头发，同一天生日，来自同一个地方，都是对称的。</p>
<p>A relation R on a set A such that for all $ a,b  \in A$.    if  $(a,b) \in R$, and $(b,a) \in R$, then a = b is called<br><strong>antisymmetric.</strong></p>
<p>反对称关系，也就是说对于非主对角线上的每一个1，对称点必然是0。 比如大于等于（a&gt;=b,b&gt;=a ,那么a=b）， a和b的整除(a能整除b，b能整除a，那么a=b)关系。</p>
<p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/10.png" style="zoom:80%;"></p>
<h3 id="Transive-传递性"><a href="#Transive-传递性" class="headerlink" title="Transive 传递性"></a>Transive 传递性</h3><p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/11.png" style="zoom:80%;"></p>
<p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/12.png" style="zoom:80%;"></p>
<p>我们看到只有R3是具有传递性的</p>
<p>R1:（3，4），（4，1） 但是没有（3，1）</p>
<p>R2:（4，1），（1，2） 但是没有（4，2）</p>
<p>传递性在图中的表现：、</p>
<p>A relation is transitive if and only if whenever there is an edge from a vertex x to a vertex y and an edge from a vertex y to a vertex z, there is an edge from x to z (completing a triangle where each side is a directed edge with the correct direction).</p>
<p>也就是说在图中具有传递性的话，三个点之间必然有一个三角形，且一条边的向量等于另外两条边的矢量和。<br>如下图。上面的那张是有传递性的，下面那张没有传递性。因为缺少了c->d，因为已经有c-&gt;a和a-&gt;d了，所以一定要满足三角形才具有传递性</p>
<p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/1.jpg" style="zoom: 33%;"></p>
<h3 id="Irreflexive-非自反性"><a href="#Irreflexive-非自反性" class="headerlink" title="Irreflexive 非自反性"></a>Irreflexive 非自反性</h3><p>Irreflexive代表了对角线上<strong>不能出现</strong> 1</p>
<h3 id="Asymmetric-非对称"><a href="#Asymmetric-非对称" class="headerlink" title="Asymmetric 非对称"></a>Asymmetric 非对称</h3><p>当$(a,b)\in R$时,$(b,a)\notin R$ ，也就是说对角线上必须全部为零且满足反对称</p>
<h2 id="n-ary-relations"><a href="#n-ary-relations" class="headerlink" title="n-ary relations"></a>n-ary relations</h2><p>n元关系：现在我有n个集合，现在n元关系就是这n个集合的笛卡尔集的子集。n称为它的度</p>
<p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/13.png" style="zoom:80%;"></p>
<p>比如说第一个3元关系，关系是a&lt;b&lt;c，那么很明显（1，2，3） 属于R，(2,4,3)就不如与R了</p>
<p>第二个三元关系：定义在整数集上面，(a,b,c)为等差数列</p>
<p>第三个三元关系：a与b是同模的，也就是a与b除以m余数相等</p>
<p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/14.png" style="zoom:80%;"></p>
<p>n元关系的应用就是数据库，数据库中每一个字段都可以成为一个集合，这张表就是这四个集合组成的笛卡尔集中的一部分，也就是一个n元关系。</p>
<p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/15.png" style="zoom:80%;"></p>
<h2 id="Relation-Operators"><a href="#Relation-Operators" class="headerlink" title="Relation Operators"></a>Relation Operators</h2><h3 id="Operations-on-Binary-Relations"><a href="#Operations-on-Binary-Relations" class="headerlink" title="Operations on Binary Relations"></a>Operations on Binary Relations</h3><h4 id="交、并、差、亦或"><a href="#交、并、差、亦或" class="headerlink" title="交、并、差、亦或"></a>交、并、差、亦或</h4><p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/16.png" style="zoom:80%;"></p>
<h4 id="复和-Composite"><a href="#复和-Composite" class="headerlink" title="复和 Composite"></a>复和 Composite</h4><p>也就是说R是A与B之间的关系，S是B和C之间的关系。那么R和S的复合定义如下</p>
<p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/17.png" style="zoom: 67%;"></p>
<p>也就是说设 R 为 X 到 Y 的关系，S为 Y 到 Z 的关系，则$R\circ S$称为R和S的复合关系  $S\circ R = {<x,z>|x\in X\land z\in Z\land(\exists y)(y\in Y: <x,y>\in R\land <y,z>\in S)}$ </y,z></x,y></x,z></p>
<p>至少存在一个b，也可以存在多个b</p>
<p>答题格式：</p>
<ol>
<li>$R_1\circ R_2{(a,c)\in R^2|\exists b \in R: (a,b) \in R_1 and (b,c) \in R_2 }$</li>
<li>将 $(a,b)$ 代入$R_1$, $(a,c)$带入$R_2$</li>
<li>得到$(a,c)$ 满足的关系式</li>
<li>因为结果是a和c的关系是，相对于b独立，我们可以将c重命名为b，转换成a和b的关系式</li>
</ol>
<p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/29.png" style="zoom: 167%;"></p>
<p>这一题能帮我们更好地理解这些运算。</p>
<p>a： $R_1\cup R_2$ 就是  a divides b or a is a multiple of a $\Rightarrow$  a divides b or b divides a</p>
<p>b:   $R_1\cap R_2$ 就是 a divides b and a is a multiple of a $\Rightarrow$ $a=\pm b$ 又因为a需要当分母，所以 $a\neq 0$ </p>
<p>c: $R_1 - R_2$ 就是 a divides b but a is not a multiple of b $\Rightarrow $ a divides b and $a\neq \pm b$ </p>
<p>d: $R_2-R_1$ 就是 b divides a but b is not a multiple of a $\Rightarrow $b divides a and   $a\neq \pm b$ </p>
<p>e: $R_1\oplus R_2$ 为异或： a divides b or a is a multiple of a but not both $\Rightarrow$ (a divides b or b divides a) and   $a\neq \pm b$ </p>
<h4 id="Power-幂运算"><a href="#Power-幂运算" class="headerlink" title="Power  幂运算"></a>Power  幂运算</h4><p>$R^{n+1}$相当于 $R^n$ 和R的附和</p>
<p>$R^1 $ 就是走一步能不能到，$R^2$ 就是走两步能不能到，$R^3$ 就是走三步能不能到（4-&gt;3-&gt;2-&gt;1)(2-&gt;1-&gt;1-&gt;1)，以此类推</p>
<p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/18.png" style="zoom: 67%;"></p>
<h4 id="Property-of-transitive"><a href="#Property-of-transitive" class="headerlink" title="Property of transitive"></a>Property of transitive</h4><p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/19.png" style="zoom: 67%;"></p>
<h4 id="用矩阵表示传递"><a href="#用矩阵表示传递" class="headerlink" title="用矩阵表示传递"></a>用矩阵表示传递</h4><p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/20.png" style="zoom: 67%;"></p>
<h4 id="矩阵运算"><a href="#矩阵运算" class="headerlink" title="矩阵运算"></a>矩阵运算</h4><p>矩阵的点乘，就是先做合取，再做析取</p>
<p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/21.png" style="zoom: 67%;"></p>
<p>Example：</p>
<p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/22.png" style="zoom: 67%;"></p>
<p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/23.png" style="zoom: 67%;"></p>
<p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/24.png" style="zoom: 67%;"></p>
<h3 id="Operations-on-n-ary-Relations"><a href="#Operations-on-n-ary-Relations" class="headerlink" title="Operations on n-ary Relations"></a>Operations on n-ary Relations</h3><h4 id="select"><a href="#select" class="headerlink" title="select"></a>select</h4><p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/25.png" style="zoom: 67%;"></p>
<h4 id="Projection"><a href="#Projection" class="headerlink" title="Projection"></a>Projection</h4><p>只看两个维度</p>
<p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/26.png" style="zoom: 67%;"></p>
<h4 id="Join"><a href="#Join" class="headerlink" title="Join"></a>Join</h4><p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/27.png" style="zoom: 67%;"></p>
<p>Join完了之后得到了一张新的表格</p>
<p><img src="/2020/06/02/%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6%E4%B9%8B%E5%85%B3%E7%B3%BB1/28.png" style="zoom: 67%;"></p>
<h3 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h3><p><a href="https://jasonxqh.github.io/2020/05/16/Mysql基础/">Mysql基础</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://jasonxqh.github.io/2020/06/02/react%E5%9F%BA%E7%A1%802/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason‘s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/02/react%E5%9F%BA%E7%A1%802/" class="post-title-link" itemprop="url">react基础2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-02 01:07:14" itemprop="dateCreated datePublished" datetime="2020-06-02T01:07:14+08:00">2020-06-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-06-21 12:43:12" itemprop="dateModified" datetime="2020-06-21T12:43:12+08:00">2020-06-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/react/" itemprop="url" rel="index"><span itemprop="name">react</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="react基础2（分页分类排序-路由）"><a href="#react基础2（分页分类排序-路由）" class="headerlink" title="react基础2（分页分类排序+路由）"></a>react基础2（分页分类排序+路由）</h1><p>这篇文章的教程</p>
<p><a href="https://www.bilibili.com/video/BV1Sb411P79t?p=23" target="_blank" rel="noopener">Mosh的react课程</a></p>
<p>从第5章开始</p>
<p>上一篇：<a href="https://jasonxqh.github.io/2020/05/30/react基础/#more">react基础1组件与组合</a></p>
<p>下一篇：<a href="https://jasonxqh.github.io/2020/06/04/react基础3/">react基础3表单与后端</a></p>
<p>下下篇： <a href="https://jasonxqh.github.io/2020/06/05/react基础4授权与部署/">react基础4授权与部署</a></p>
<h2 id="Pagination-Filtering-and-Sorting-分页过滤和排序"><a href="#Pagination-Filtering-and-Sorting-分页过滤和排序" class="headerlink" title="Pagination, Filtering, and Sorting 分页过滤和排序"></a>Pagination, Filtering, and Sorting 分页过滤和排序</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>我们的目标：分类+排序+分页</p>
<p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/1.png" style="zoom:80%;"></p>
<h3 id="Pagination-Component-Interface"><a href="#Pagination-Component-Interface" class="headerlink" title="Pagination- Component Interface"></a>Pagination- Component Interface</h3><p>首先我们来做分页按钮。因为分页按钮也可以重复使用所以我们把他新建到common文件夹当中</p>
<p>imr导入import React, { Component } from “react”;</p>
<p>sfc导入stateless functional component</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">const</span> Pagination = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Pagination;</span><br></pre></td></tr></table></figure>
<p>显然这个Pagination是Movies的一个受控组件，全部有props传递数据，所以我们在Movies中建一个\<Pagination></Pagination></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//新建一个handlePageChange接口，完成翻页操作 </span></span><br><span class="line">handlePageChange =<span class="function"><span class="params">()</span> =&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"page"</span>);</span><br><span class="line"></span><br><span class="line">  &#125; </span><br><span class="line">&lt;Pagination</span><br><span class="line">     <span class="comment">//   计算电影信息条数</span></span><br><span class="line">          itemsCount=&#123;count&#125;</span><br><span class="line">     <span class="comment">//	  这里state中放一个每页电影数目，我写的是25</span></span><br><span class="line">          pageSize=&#123;<span class="keyword">this</span>.state.pageSize&#125;</span><br><span class="line">     <span class="comment">//   翻页操作</span></span><br><span class="line">          onPageChange=&#123;<span class="keyword">this</span>.handlePageChange&#125;</span><br><span class="line"> /&gt;</span><br></pre></td></tr></table></figure>
<h3 id="Pagination-Displaying-Pages"><a href="#Pagination-Displaying-Pages" class="headerlink" title="Pagination- Displaying Pages"></a>Pagination- Displaying Pages</h3><p>利用bootstrap的文档，利用快捷键nav>ul.pagination&gt;li.page-item>a.page-link 生成翻页标签</p>
<p>然后我们要动态渲染页面。我们已经知道了props中传入了总信息条数，和每页包含的信息数量，那么我们就可以通过计算的方式得出有多少页码</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">"lodash"</span>;</span><br><span class="line"><span class="keyword">const</span> Pagination = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; itemsCount, pageSize &#125; = props;</span><br><span class="line">    <span class="comment">//计算得出有多少页码，这个计算结果是一个浮点数</span></span><br><span class="line">  <span class="keyword">const</span> pagesCount =  itemsCount / pageSize ;</span><br><span class="line">    <span class="comment">//利用lodash包中的方法，可以生成一个页码的列表</span></span><br><span class="line">  <span class="keyword">const</span> pages = _.range(<span class="number">1</span>, pagesCount + <span class="number">1</span>);</span><br><span class="line">    <span class="comment">//如果当前的总信息条数小于单页信息条数，我们就不用渲染翻页按钮了</span></span><br><span class="line">  <span class="keyword">if</span> (pagesCount &lt;= <span class="number">1</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;nav&gt;</span><br><span class="line">      &lt;ul className=<span class="string">"pagination"</span>&gt;</span><br><span class="line">          &#123;<span class="comment">/* 否则我们就渲染，利用map函数对每一个页码都生成一个翻页标签 */</span>&#125;</span><br><span class="line">        &#123;pages.map(<span class="function">(<span class="params">page</span>) =&gt;</span> (</span><br><span class="line">          &lt;li key=&#123;page&#125; className=<span class="string">"page-item"</span>&gt;</span><br><span class="line">            &lt;a className=<span class="string">"page-link"</span>&gt;&#123;page&#125;&lt;<span class="regexp">/a&gt;</span></span><br><span class="line"><span class="regexp">          &lt;/</span>li&gt;</span><br><span class="line">        ))&#125;</span><br><span class="line">      &lt;<span class="regexp">/ul&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>nav&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Pagination;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/2.png" style="zoom:80%;"></p>
<h3 id="Pagination-Handling-Page-Changes"><a href="#Pagination-Handling-Page-Changes" class="headerlink" title="Pagination- Handling Page Changes"></a>Pagination- Handling Page Changes</h3><p>接下来我们来实现当点击页码的时候，console会显示该页的页码，并且让其高亮。</p>
<p>那么我们就需要在点击页码的时候发起一个event，然后让父组件Movies去更新当前的页面，然后再通过props重新生成，传回给Pagination组件，实现页码更新+高亮</p>
<p>下面就是在pagination.jsx中修改的部分，我们首先解构props</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">const</span> &#123; itemsCount, pageSize, onPageChange, currentPage &#125; = props;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="comment">//  让当前的页码标签高亮</span></span><br><span class="line"> &lt;li</span><br><span class="line">     key=&#123;page&#125;</span><br><span class="line">     className=&#123;page === currentPage ? <span class="string">"page-item active"</span> : <span class="string">"page-item"</span>&#125;</span><br><span class="line"> &gt;</span><br><span class="line">    &#123;<span class="comment">/*再点击的时候，借助props发起一个onPageChange(page)事件，交给Movies去处理*/</span>&#125;</span><br><span class="line">    &lt;a className=<span class="string">"page-link"</span> onClick=&#123;() =&gt; onPageChange(page)&#125;&gt;</span><br><span class="line">      &#123;page&#125;</span><br><span class="line">    &lt;<span class="regexp">/a&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>li&gt;</span><br></pre></td></tr></table></figure>
<p>在movies.jsx中我们也有要改的</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Movies</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    movies: getMovies(),</span><br><span class="line">    pageSize: <span class="number">25</span>,</span><br><span class="line">    currentPage: <span class="number">1</span>,<span class="comment">//在这里新建一个currentPage的本地数据</span></span><br><span class="line">  &#125;;</span><br><span class="line"><span class="comment">// 新建一个handlePageChange来处理改变页码的功能，这里就是把state中currentPage改成当前page</span></span><br><span class="line">  handlePageChange = <span class="function">(<span class="params">page</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">currentPage</span>: page &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">render() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="attr">length</span>: count &#125; = <span class="keyword">this</span>.state.movies;</span><br><span class="line">    <span class="comment">//解构state，简化代码</span></span><br><span class="line">    <span class="keyword">const</span> &#123; pageSize, currentPage &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">     &lt;Pagination</span><br><span class="line">          itemsCount=&#123;count&#125;</span><br><span class="line">          currentPage=&#123;currentPage&#125;</span><br><span class="line">          pageSize=&#123;pageSize&#125;</span><br><span class="line">         <span class="comment">// 接受Pagination发起的event，交给handlePageChange处理</span></span><br><span class="line">          onPageChange=&#123;<span class="keyword">this</span>.handlePageChange&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">      &lt;<span class="regexp">/React.Fragment&gt;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/3.png" style="zoom:80%;"></p>
<p>这时候点击页码按钮，就会实现高亮</p>
<h3 id="Pagination-Paginating-Data"><a href="#Pagination-Paginating-Data" class="headerlink" title="Pagination- Paginating Data"></a>Pagination- Paginating Data</h3><p>接下来我们正式处理翻页，因为翻页功能可能在其他的app中也会有用，所以我们新建一个文件夹utils存放这类函数。我们在utils文件夹中 新建一个 paginate.js文件</p>
<p>现在我们要理解这段话的意思</p>
<p>slice(items,startIndex)这个方法，将从起始位置开始切割这个数组</p>
<p>take(pageSize) 这个方法 传入截取的信息条数</p>
<p>value() 就是把这个lodash wrapper转化成一个 常规的数组</p>
<p>然后把他return掉</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">"lodash"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">paginate</span>(<span class="params">items, pageNumber, pageSize</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//这就是计算每页起始位置的编号</span></span><br><span class="line">  <span class="keyword">const</span> startIndex = (pageNumber - <span class="number">1</span>) * pageSize;</span><br><span class="line">    <span class="comment">//进行切割</span></span><br><span class="line">  <span class="keyword">return</span> _(items).slice(startIndex).take(pageSize).value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在movies中引入import { paginate } from “../utils/paginate”;</p>
<p>接下来我们就需要在render渲染器中把原来的movies覆盖掉</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//length:count 是解构中的一个语法，就是说给movies中的length属性一个叫做count的别名</span></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="attr">length</span>: count &#125; = <span class="keyword">this</span>.state.movies;</span><br><span class="line"><span class="comment">//在这里我们需要给this.state.movies 一个别名，否则这里的movies会和下面的const movies冲突</span></span><br><span class="line"><span class="keyword">const</span> &#123; pageSize, currentPage, <span class="attr">movies</span>:allmovies &#125; = <span class="keyword">this</span>.state;</span><br><span class="line"><span class="keyword">if</span> (count === <span class="number">0</span>) <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>There are no movies in the database <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line"><span class="comment">//对原有的movies进行覆盖</span></span><br><span class="line"><span class="keyword">const</span> movies = paginate(allmovies, currentPage, pageSize);</span><br></pre></td></tr></table></figure>
<p>接下来就看看成效吧</p>
<p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/1.gif" style="zoom:80%;"></p>
<h3 id="Pagination-Type-Checking-with-PropTypes"><a href="#Pagination-Type-Checking-with-PropTypes" class="headerlink" title="Pagination- Type Checking with PropTypes"></a>Pagination- Type Checking with PropTypes</h3><p>我们如果向props中传入了invalid 的参数，那么虽然不会报错，却会产生很严重的bug</p>
<p>这时候我们需要引入一个外部的库，来帮我们检查是否出现了参数类型错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm i prop-types@15.6.2</span><br></pre></td></tr></table></figure>
<p>在pagination.jsx 中引入这个包，然后做检测</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">"prop-types"</span>;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="comment">//注意，下面的格式必须要对，Pagination是组件名称</span></span><br><span class="line">Pagination.PropTypes = &#123;</span><br><span class="line">    <span class="comment">//后面的参数类型是可以多种多样的：number,string,bool,array,object,func,symbol</span></span><br><span class="line">    <span class="comment">// isRequirement 代表了 这个参数必须传入，不传入为空也会报错</span></span><br><span class="line">  itemsCount: PropTypes.number.isRequired,</span><br><span class="line">  pageSize: PropTypes.number.isRequired,</span><br><span class="line">  onPageChange: PropTypes.number.isRequired,</span><br><span class="line">  currentPage: PropTypes.func.isRequired,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/4.png" style="zoom:80%;"></p>
<p>当我们给itemsCount传入一个字符串的时候，就会得到上面的Warning</p>
<h3 id="Exercise-ListGroup-Component"><a href="#Exercise-ListGroup-Component" class="headerlink" title="Exercise- ListGroup Component"></a>Exercise- ListGroup Component</h3><p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/5.png" style="zoom:80%;"></p>
<p>接下来我们要做一个旁边的类型筛选器来是先筛选操作。</p>
<h3 id="Filtering-Component-Interface-组件接口"><a href="#Filtering-Component-Interface-组件接口" class="headerlink" title="Filtering- Component Interface 组件接口"></a>Filtering- Component Interface 组件接口</h3><p>我们首先在common文件夹中新建一个listGroup.jsx</p>
<p>imrc,cc,新建一个ListGroup组件</p>
<p>我们看到上面的效果，是左面一列，右边一列，所以说在一个div当中我们要做两列，第一列放ListGroup，第二列来放我们刚才的表</p>
<p>那么修改Movies 的render() ，通过快捷键 div.col-2+div.col快捷键新建</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;div className=<span class="string">"col-2"</span>&gt;&#123;<span class="comment">/*存ListGroup*/</span>&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;div-col&gt;&#123;/</span>*存放电影的表格*<span class="regexp">/&#125;&lt;/</span>div-col&gt;</span><br></pre></td></tr></table></figure>
<p>然后在ListGroup中传入props</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;div className=<span class="string">"col-2"</span>&gt;</span><br><span class="line">  &lt;ListGroup</span><br><span class="line">      <span class="comment">//传入 items来传入电影的分类</span></span><br><span class="line">    items=&#123;<span class="keyword">this</span>.state.genres&#125;</span><br><span class="line">      <span class="comment">//传入 onItemSelect来处理ListGroup 发起的一个events</span></span><br><span class="line">    onItemSelect=&#123;<span class="keyword">this</span>.handleGenreSelect&#125;</span><br><span class="line">  /&gt;</span><br><span class="line">&lt;<span class="regexp">/div&gt;</span></span><br></pre></td></tr></table></figure>
<p>同时新建一个handleGenreSelect来处理</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">handleGenreSelect = <span class="function"><span class="params">genre</span> =&gt;</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(genre);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>对了，我们这里只是在本地调用一些数据，以后我们将调用数据库中的数据，那么在state中直接声明就变得不可行了，所以我们修改一下state中的movies和genres，先声明一个空数组，然后通过componentDidMount这个hook来赋值</p>
<p>movies.jsx:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">state = &#123;</span><br><span class="line">  movies: [],</span><br><span class="line">  genres: [],</span><br><span class="line">  pageSize: <span class="number">4</span>,</span><br><span class="line">  currentPage: <span class="number">1</span>,</span><br><span class="line">  selectedGenre:<span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">componentDidMount() &#123;</span><br><span class="line">  <span class="keyword">this</span>.setState(&#123; <span class="attr">movies</span>: getMovies(), <span class="attr">genres</span>: getGenres() &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Filtering-Displaying-Items"><a href="#Filtering-Displaying-Items" class="headerlink" title="Filtering- Displaying Items"></a>Filtering- Displaying Items</h3><p>通过快捷键 ul.list-group>li.list-group-item来新建，然后用我们的genre来动态渲染</p>
<p>通过解构pros简化代码，其中两个props textProperty=”name”      valueProperty=”_id” 是为了降低代码的耦合度即不那么依赖Object的属性。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">const</span> ListGroup = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; items ,textProperty,valueProperty &#125; = props;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;ul className=<span class="string">"list-group"</span>&gt;</span><br><span class="line">      &#123;items.map(<span class="function">(<span class="params">item</span>) =&gt;</span> (</span><br><span class="line">        &lt;li key=&#123;item[valueProperty]&#125; className=<span class="string">"list-group-item"</span>&gt;</span><br><span class="line">          &#123;item[textProperty]&#125;</span><br><span class="line">        &lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">      ))&#125;</span></span><br><span class="line"><span class="regexp">    &lt;/u</span>l&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> ListGroup;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/6.png" style="zoom: 67%;"></p>
<h3 id="Filtering-Default-Props"><a href="#Filtering-Default-Props" class="headerlink" title="Filtering- Default Props"></a>Filtering- Default Props</h3><p>这就涉及到代码简洁的问题了，当我们对一个组件的传入越少props，那么他就会好用，而我们对ListGroup组件传入了4个props，其中两个只是简单的字符串，那么我们就可以通过组件的defaultProps 进行对一些props设置默认值</p>
<p>我们在listGroup.jsx中加上这样一段代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ListGroup.defaultProps = &#123;</span><br><span class="line">  textProperty: <span class="string">"name"</span>,</span><br><span class="line">  valueProperty: <span class="string">"_id"</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这样Movies中ListGroup标签中的那两个props就可以删除了，因为他已经在defaultProps中定义了</p>
<h3 id="Filtering-Handling-Selection"><a href="#Filtering-Handling-Selection" class="headerlink" title="Filtering- Handling Selection"></a>Filtering- Handling Selection</h3><p>然后我们要处理的就是点击按钮，实现高亮，那么这应该怎么操作呢？</p>
<p>事实上和分页按钮是相似的。我们在Movies中实现props操作，在ListGroup中通过props判断当前的按钮是否应该被高亮</p>
<p>movie.jsx</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line">handleGenreSelect = <span class="function">(<span class="params">genre</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">selectedGenre</span>: genre &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//....</span></span><br><span class="line">&lt;ListGroup</span><br><span class="line">  items=&#123;<span class="keyword">this</span>.state.genres&#125;</span><br><span class="line">  <span class="comment">//当点击的时候，通过handleGenreSelect来更新当前的selectedGenre属性</span></span><br><span class="line">  onItemSelect=&#123;<span class="keyword">this</span>.handleGenreSelect&#125;</span><br><span class="line">  <span class="comment">//通过selectedItem 这个prop 将我们已经更行了的seletedGenre传回给ListGroup</span></span><br><span class="line">  selectedItem=&#123;<span class="keyword">this</span>.state.selectedGenre&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>
<h3 id="Filtering-Implementing-Filtering"><a href="#Filtering-Implementing-Filtering" class="headerlink" title="Filtering- Implementing Filtering"></a>Filtering- Implementing Filtering</h3><p>在movies组件的渲染器当中，我们通过 const movies = paginate(filtered, currentPage, pageSize);来进行分页操作。如果要实现分类，那么我们就需要在分页之前进行筛选才对</p>
<p>逻辑就是判断当前selectedGenre是否存在，如果存在，那么就筛选出_id和他相等的出来，如果不存在（我默认为null),那么我们就返回所有的电影</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> filtered =</span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">selectedGenre ? </span><br><span class="line">	allmovies.filter(<span class="function">(<span class="params">m</span>) =&gt;</span> m.genre._id === selectedGenre._id)  : allmovies;</span><br></pre></td></tr></table></figure>
<p>然后我们要对filter进行分页</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> movies = paginate(filtered, currentPage, pageSize);</span><br></pre></td></tr></table></figure>
<p>最后我们交给Pagination 的信息数量也要从count变成filtered.length</p>
<p>把 <em>&lt;</em>h2<em>&gt;</em>Showing {count} movies in the database<em>&lt;/</em>h2<em>&gt;</em> 中的count改成filtered.length</p>
<h3 id="Filtering-Adding-All-Genres"><a href="#Filtering-Adding-All-Genres" class="headerlink" title="Filtering- Adding All Genres"></a>Filtering- Adding All Genres</h3><p>我们现在要加一个All genre按钮,也就是说给genres多一个All genre对象</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">componentDidMount() &#123;</span><br><span class="line">  <span class="keyword">const</span> genres = [&#123; <span class="attr">_id</span>: <span class="string">""</span>, <span class="attr">name</span>: <span class="string">"All genre"</span> &#125;, ...getGenres()];</span><br><span class="line">  <span class="keyword">this</span>.setState(&#123; <span class="attr">movies</span>: getMovies(), genres &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是当我们再次回到All genre 标签的时候，发现并没筛选出来什么东西。这是因为我们在一开始的判定条件是 selectedGenre? 当我们点了Action之类的genre的时候，react已经把 selectedGenre从null更新称Action了，所以再次回到All genre的时候， selectedGenre其实不是null了，而任何电影信息的id都不等于空，所以就返回了0</p>
<p>解决这个，我们可以加一个判断条件,需要满足 selectedGenre &amp;&amp; selectedGenre._id 不为零才进行筛选，否则就全部返回。这样这个问题就完美解决了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> filtered = selectedGenre &amp;&amp; selectedGenre._id ?</span><br><span class="line">allmovies.filter(<span class="function">(<span class="params">m</span>) =&gt;</span> m.genre._id === selectedGenre._id): allmovies;</span><br></pre></td></tr></table></figure>
<p>别高兴得太早，我们还是有bug没有解决。</p>
<p>我们如果翻到第二页，再点击Triller的话，并不会显示任何得电影</p>
<p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/7.png" style="zoom: 67%;"></p>
<p>这是为什么呢？因为我们现在的页面其实停留在第2页，而第二页是没有得，电影信息都在第一页中。</p>
<p>所以我们无论何时改变分类，都应该重置页面回第一页</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">handleGenreSelect = <span class="function">(<span class="params">genre</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.setState(&#123; <span class="attr">selectedGenre</span>: genre, <span class="attr">currentPage</span>: <span class="number">1</span> &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>至此，我们已经完美解决了这个问题</p>
<p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/2.gif" alt></p>
<p>完整代码如下：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getMovies &#125; <span class="keyword">from</span> <span class="string">"../services/fakeMovieService"</span>;</span><br><span class="line"><span class="keyword">import</span> Like <span class="keyword">from</span> <span class="string">"./common/like"</span>;</span><br><span class="line"><span class="keyword">import</span> Pagination <span class="keyword">from</span> <span class="string">"./common/pagination"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; paginate &#125; <span class="keyword">from</span> <span class="string">"../utils/paginate"</span>;</span><br><span class="line"><span class="keyword">import</span> ListGroup <span class="keyword">from</span> <span class="string">"./common/listGroup"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getGenres &#125; <span class="keyword">from</span> <span class="string">"../services/fakeGenreService"</span>;</span><br><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">"lodash"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Movies</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    movies: [],</span><br><span class="line">    genres: [],</span><br><span class="line">    pageSize: <span class="number">4</span>,</span><br><span class="line">    currentPage: <span class="number">1</span>,</span><br><span class="line">    selectedGenre: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">const</span> genres = [&#123; <span class="attr">_id</span>: <span class="string">""</span>, <span class="attr">name</span>: <span class="string">"All genre"</span> &#125;, ...getGenres()];</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">movies</span>: getMovies(), genres &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  handleDelete = <span class="function">(<span class="params">movie</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> movies = <span class="keyword">this</span>.state.movies.filter(<span class="function">(<span class="params">m</span>) =&gt;</span> m._id !== movie._id);</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; movies &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  handleLike = <span class="function">(<span class="params">movie</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> movies = [...this.state.movies];</span><br><span class="line">    <span class="keyword">const</span> index = movies.indexOf(movie);</span><br><span class="line">    movies[index] = &#123; ...movies[index] &#125;;</span><br><span class="line">    movies[index].liked = !movies[index].liked;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; movies &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  handlePageChange = <span class="function">(<span class="params">page</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">currentPage</span>: page &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  handleGenreSelect = <span class="function">(<span class="params">genre</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">selectedGenre</span>: genre, <span class="attr">currentPage</span>: <span class="number">1</span> &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="attr">length</span>: count &#125; = <span class="keyword">this</span>.state.movies;</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      pageSize,</span><br><span class="line">      currentPage,</span><br><span class="line">      selectedGenre,</span><br><span class="line">      movies: allmovies,</span><br><span class="line">    &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">    <span class="keyword">if</span> (count === <span class="number">0</span>) <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>There are no movies in the database <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> filtered =</span><br><span class="line">      selectedGenre &amp;&amp; selectedGenre._id</span><br><span class="line">        ? allmovies.filter(<span class="function">(<span class="params">m</span>) =&gt;</span> m.genre._id === selectedGenre._id)</span><br><span class="line">        : allmovies;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> movies = paginate(filtered, currentPage, pageSize);</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div className=<span class="string">"row"</span>&gt;</span><br><span class="line">        &lt;div className=<span class="string">"col-3"</span>&gt;</span><br><span class="line">          &lt;ListGroup</span><br><span class="line">            items=&#123;<span class="keyword">this</span>.state.genres&#125;</span><br><span class="line">            selectedItem=&#123;<span class="keyword">this</span>.state.selectedGenre&#125;</span><br><span class="line">            onItemSelect=&#123;<span class="keyword">this</span>.handleGenreSelect&#125;</span><br><span class="line">          /&gt;</span><br><span class="line">        &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;div className="col"&gt;</span></span><br><span class="line"><span class="regexp">          &lt;h2&gt;Showing &#123;filtered.length&#125; movies in the database&lt;/</span>h2&gt;</span><br><span class="line">          &lt;table className=<span class="string">"table"</span>&gt;</span><br><span class="line">            &lt;thead&gt;</span><br><span class="line">              &lt;tr&gt;</span><br><span class="line">                &lt;th&gt;Title&lt;<span class="regexp">/th&gt;</span></span><br><span class="line"><span class="regexp">                &lt;th&gt;Genre&lt;/</span>th&gt;</span><br><span class="line">                &lt;th&gt;Stock&lt;<span class="regexp">/th&gt;</span></span><br><span class="line"><span class="regexp">                &lt;th&gt;Rate&lt;/</span>th&gt;</span><br><span class="line">                &lt;th&gt;Like&lt;<span class="regexp">/th&gt;</span></span><br><span class="line"><span class="regexp">                &lt;th&gt;Delete&lt;/</span>th&gt;</span><br><span class="line">              &lt;<span class="regexp">/tr&gt;</span></span><br><span class="line"><span class="regexp">            &lt;/</span>thead&gt;</span><br><span class="line">            &lt;tbody&gt;</span><br><span class="line">              &#123;movies.map(<span class="function">(<span class="params">movie</span>) =&gt;</span> (</span><br><span class="line">                &lt;tr key=&#123;movie._id&#125;&gt;</span><br><span class="line">                  &lt;td&gt;&#123;movie.title&#125;&lt;<span class="regexp">/td&gt;</span></span><br><span class="line"><span class="regexp">                  &lt;td&gt;&#123;movie.genre.name&#125;&lt;/</span>td&gt;</span><br><span class="line">                  &lt;td&gt;&#123;movie.numberInStock&#125;&lt;<span class="regexp">/td&gt;</span></span><br><span class="line"><span class="regexp">                  &lt;td&gt;&#123;movie.dailyRentalRate&#125;&lt;/</span>td&gt;</span><br><span class="line">                  &lt;td&gt;</span><br><span class="line">                    &lt;Like</span><br><span class="line">                      liked=&#123;movie.liked&#125;</span><br><span class="line">                      onClick=&#123;() =&gt; <span class="keyword">this</span>.handleLike(movie)&#125;</span><br><span class="line">                    /&gt;</span><br><span class="line">                  &lt;<span class="regexp">/td&gt;</span></span><br><span class="line"><span class="regexp">                  &lt;td&gt;</span></span><br><span class="line"><span class="regexp">                    &lt;button</span></span><br><span class="line"><span class="regexp">                      onClick=&#123;() =&gt; this.handleDelete(movie)&#125;</span></span><br><span class="line"><span class="regexp">                      className="btn btn-danger btn-sm"</span></span><br><span class="line"><span class="regexp">                    &gt;</span></span><br><span class="line"><span class="regexp">                      Delete</span></span><br><span class="line"><span class="regexp">                    &lt;/</span>button&gt;</span><br><span class="line">                  &lt;<span class="regexp">/td&gt;</span></span><br><span class="line"><span class="regexp">                &lt;/</span>tr&gt;</span><br><span class="line">              ))&#125;</span><br><span class="line">            &lt;<span class="regexp">/tbody&gt;</span></span><br><span class="line"><span class="regexp">          &lt;/</span>table&gt;</span><br><span class="line">          &lt;Pagination</span><br><span class="line">            itemsCount=&#123;filtered.length&#125;</span><br><span class="line">            currentPage=&#123;currentPage&#125;</span><br><span class="line">            pageSize=&#123;pageSize&#125;</span><br><span class="line">            onPageChange=&#123;<span class="keyword">this</span>.handlePageChange&#125;</span><br><span class="line">          /&gt;</span><br><span class="line">        &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Movies;</span><br></pre></td></tr></table></figure>
<p>listGroup.jsx</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">const</span> ListGroup = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    items,</span><br><span class="line">    textProperty,</span><br><span class="line">    valueProperty,</span><br><span class="line">    onItemSelect,</span><br><span class="line">    selectedItem,</span><br><span class="line">  &#125; = props;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;ul className=<span class="string">"list-group"</span>&gt;</span><br><span class="line">      &#123;items.map(<span class="function">(<span class="params">item</span>) =&gt;</span> (</span><br><span class="line">        &lt;li</span><br><span class="line">          key=&#123;item[valueProperty]&#125;</span><br><span class="line">          className=&#123;item===selectedItem?<span class="string">"list-group-item active"</span>:<span class="string">"list-group-item "</span>&#125;</span><br><span class="line">          onClick=&#123;() =&gt; onItemSelect(item)&#125;</span><br><span class="line">        &gt;</span><br><span class="line">          &#123;item[textProperty]&#125;</span><br><span class="line">        &lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">      ))&#125;</span></span><br><span class="line"><span class="regexp">    &lt;/u</span>l&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ListGroup.defaultProps = &#123;</span><br><span class="line">  textProperty: <span class="string">"name"</span>,</span><br><span class="line">  valueProperty: <span class="string">"_id"</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> ListGroup;</span><br></pre></td></tr></table></figure>
<h3 id="Sorting-Extracting-MoviesTable-封装MoviesTable"><a href="#Sorting-Extracting-MoviesTable-封装MoviesTable" class="headerlink" title="Sorting- Extracting MoviesTable 封装MoviesTable"></a>Sorting- Extracting MoviesTable 封装MoviesTable</h3><p>我们之前把表格直接卸载了Movies组件当中，但其实电压表，分页器，筛选器都是属于一个层面的组件，所以我们现在来封装MoviesTable组件</p>
<p>在component文件夹中新建moviesTable.jsx, imr.sfc构建一个stateless functional component，然后把Movies中得table标签全部移到moviesTable中去，并且把this.handleLike ，this.handleDelete 都变成events，也就是说再点击的时候发起onLike,onDelete{在创建的时候先解构props}。最后在Movies中加入Movies Table组件,传入props处理这些事件。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;MoviesTable</span><br><span class="line">      movies=&#123;movies&#125;</span><br><span class="line">      onLike=&#123;<span class="keyword">this</span>.handleLike&#125;</span><br><span class="line">      onDelete=&#123;<span class="keyword">this</span>.handleDelete&#125;</span><br><span class="line">    /&gt;</span><br></pre></td></tr></table></figure>
<h3 id="Sorting-Raising-the-Sort-Event"><a href="#Sorting-Raising-the-Sort-Event" class="headerlink" title="Sorting- Raising the Sort Event"></a>Sorting- Raising the Sort Event</h3><p>然后我们要在点击每一列的时候实现sort，那么必然要在moviesTable组件发起一个event，老样子</p>
<p>解构中加入onSort，每个tr标签加入onClick</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Movies</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    movies: [],</span><br><span class="line">    genres: [],</span><br><span class="line">    pageSize: <span class="number">10</span>,</span><br><span class="line">    currentPage: <span class="number">1</span>,</span><br><span class="line">    selectedGenre: <span class="literal">null</span>,</span><br><span class="line">    sortColumn: &#123; <span class="attr">path</span>: <span class="string">"range"</span>, <span class="attr">order</span>: <span class="string">"asc"</span> &#125;,<span class="comment">//默认</span></span><br><span class="line">  &#125;;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<p>然后在Movies的<moviesTable \> 中加入onSort = this.handleSort 的prop</moviesTable></p>
<p>接下来我们实现handleSort</p>
<h3 id="Sorting-Implementing-Sorting"><a href="#Sorting-Implementing-Sorting" class="headerlink" title="Sorting- Implementing Sorting"></a>Sorting- Implementing Sorting</h3><p>我们想实现的是默认正序，点击反序，再点击又回到正序这样的功能</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">"lodash"</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Movies</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    movies: [],</span><br><span class="line">    genres: [],</span><br><span class="line">    pageSize: <span class="number">10</span>,</span><br><span class="line">    currentPage: <span class="number">1</span>,</span><br><span class="line">    selectedGenre: <span class="literal">null</span>,</span><br><span class="line">    sortColumn: &#123; <span class="attr">path</span>: <span class="string">"range"</span>, <span class="attr">order</span>: <span class="string">"asc"</span> &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">  handleSort = <span class="function">(<span class="params">path</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//我们首先克隆sortColumn</span></span><br><span class="line">    <span class="keyword">const</span> sortColumn = &#123; ...this.state.sortColumn &#125;;</span><br><span class="line">      <span class="comment">//判断当前的列是否为排序列，如果是的话，再次点击就取反</span></span><br><span class="line">    <span class="keyword">if</span> (sortColumn.path === path)</span><br><span class="line">      sortColumn.order = sortColumn.order === <span class="string">"asc"</span> ? <span class="string">"desc"</span> : <span class="string">"asc"</span>;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//如果不是的话，那么就默认正序排列</span></span><br><span class="line">      sortColumn.path = path;</span><br><span class="line">      sortColumn.order = <span class="string">"asc"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">//实现setState更新</span></span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; sortColumn &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//那么我们真正用到排序的是这个地方</span></span><br><span class="line"><span class="comment">//这是一个lodash库，里面有orderBy函数</span></span><br><span class="line"><span class="comment">//第一个传进去的是筛选过的信息，第二个传入的是列，第三个参数是顺序</span></span><br><span class="line"> <span class="keyword">const</span> sorted = _.orderBy(filtered, [sortColumn.path], [sortColumn.order]);</span><br><span class="line"><span class="comment">//重新命名我们的movies为排序过后的信息</span></span><br><span class="line"><span class="keyword">const</span> movies = paginate(sorted, currentPage, pageSize);</span><br></pre></td></tr></table></figure>
<h3 id="Sorting-Moving-Responsibility"><a href="#Sorting-Moving-Responsibility" class="headerlink" title="Sorting- Moving Responsibility"></a>Sorting- Moving Responsibility</h3><p>但这样时显示有问题的，当在其他的地方使用这个moviestable实现排序的时候，我们需要把上面的handleSort放到新的程序当中，这样就变得麻烦起来了，所以我们还是选择把moviesTable变成一个class，在class中加一个raiseSort方法，把逻辑改成点击列的时候调用这个raiseSort方法，这个raiseSort方法处理好刚才的排序逻辑的以后，向Movies发起一个events，在Movies通过onSort 接收以后调用handleSort实现更新</p>
<p>moviesTable.jsx</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> Like <span class="keyword">from</span> <span class="string">"./common/like"</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MoviesTable</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="comment">//raiseSort 处理排序逻辑，然后向Movies发起event</span></span><br><span class="line">  raiseSort = <span class="function">(<span class="params">path</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> sortColumn = &#123; ...this.props.sortColumn &#125;;</span><br><span class="line">    <span class="keyword">if</span> (sortColumn.path === path)</span><br><span class="line">      sortColumn.order = sortColumn.order === <span class="string">"asc"</span> ? <span class="string">"desc"</span> : <span class="string">"asc"</span>;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      sortColumn.path = path;</span><br><span class="line">      sortColumn.order = <span class="string">"asc"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.props.onSort(sortColumn);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; movies, onDelete, onLike &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;table className=<span class="string">"table"</span>&gt;</span><br><span class="line">        &lt;thead&gt;</span><br><span class="line">          &lt;tr&gt;</span><br><span class="line">              &#123;<span class="comment">/*通过点击调用类中方法*/</span>&#125;</span><br><span class="line">            &lt;th onClick=&#123;() =&gt; <span class="keyword">this</span>.raiseSort(<span class="string">"title"</span>)&#125;&gt;Title&lt;<span class="regexp">/th&gt;</span></span><br><span class="line"><span class="regexp">            &lt;th onClick=&#123;() =&gt; this.raiseSort("director")&#125;&gt;Director&lt;/</span>th&gt;</span><br><span class="line">            &lt;th onClick=&#123;() =&gt; <span class="keyword">this</span>.raiseSort(<span class="string">"actor"</span>)&#125;&gt;Actors&lt;<span class="regexp">/th&gt;</span></span><br><span class="line"><span class="regexp">            &lt;th onClick=&#123;() =&gt; this.raiseSort("country")&#125;&gt;Country&lt;/</span>th&gt;</span><br><span class="line">            &lt;th onClick=&#123;() =&gt; <span class="keyword">this</span>.raiseSort(<span class="string">"index"</span>)&#125;&gt;Range&lt;<span class="regexp">/th&gt;</span></span><br><span class="line"><span class="regexp">            &lt;th onClick=&#123;() =&gt; this.raiseSort("score")&#125;&gt;Score&lt;/</span>th&gt;</span><br><span class="line">            &lt;th onClick=&#123;() =&gt; <span class="keyword">this</span>.raiseSort(<span class="string">"sort"</span>)&#125;&gt;Sort&lt;<span class="regexp">/th&gt;</span></span><br><span class="line"><span class="regexp">            &lt;th onClick=&#123;() =&gt; this.raiseSort("time")&#125;&gt;Time&lt;/</span>th&gt;</span><br><span class="line">            &lt;th&gt;like&lt;<span class="regexp">/th&gt;</span></span><br><span class="line"><span class="regexp">          &lt;/</span>tr&gt;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<p>然后在movie.jsx中只需要 一句简单的更新即可</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">handleSort = <span class="function">(<span class="params">sortColumn</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.setState(&#123; sortColumn &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="Sorting-Extracting-TableHeader封装表头"><a href="#Sorting-Extracting-TableHeader封装表头" class="headerlink" title="Sorting- Extracting TableHeader封装表头"></a>Sorting- Extracting TableHeader封装表头</h3><p>接下来我们要封装一个表头，也就是把这张表逐个拆解成几部分,在表头中实现排序逻辑，</p>
<p>表头的运行模式是</p>
<p>我们在common中新建一个tableHeader.jsx，tableHeader中的columns是从moviesTable给他的props中获得的，然后通过map渲染出表头来</p>
<p>tableHeader.jsx</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//columns:array</span></span><br><span class="line"><span class="comment">//sortColumn</span></span><br><span class="line"><span class="comment">//onSort：function</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TableHeader</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  raiseSort = <span class="function">(<span class="params">path</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> sortColumn = &#123; ...this.props.sortColumn &#125;;</span><br><span class="line">    <span class="keyword">if</span> (sortColumn.path === path)</span><br><span class="line">      sortColumn.order = sortColumn.order === <span class="string">"asc"</span> ? <span class="string">"desc"</span> : <span class="string">"asc"</span>;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      sortColumn.path = path;</span><br><span class="line">      sortColumn.order = <span class="string">"asc"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.props.onSort(sortColumn);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;thead&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">          &#123;<span class="keyword">this</span>.props.columns.map(<span class="function">(<span class="params">column</span>) =&gt;</span> (</span><br><span class="line">            &lt;th</span><br><span class="line">                <span class="comment">//每个标签都要有他的key值，那么需要排列的就取path，不需要的就取key</span></span><br><span class="line">              key=&#123;column.path || column.key&#125;</span><br><span class="line">                <span class="comment">//在点击的时候，调用raiseSort方法，raiseSort向Moviecolumn发起一个event</span></span><br><span class="line">              onClick=&#123;() =&gt; <span class="keyword">this</span>.raiseSort(column.path)&#125;</span><br><span class="line">            &gt;</span><br><span class="line">              &#123;column.label&#125;</span><br><span class="line">            &lt;<span class="regexp">/th&gt;</span></span><br><span class="line"><span class="regexp">          ))&#125;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>tr&gt;</span><br><span class="line">      &lt;<span class="regexp">/thead&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">export default TableHeader;</span></span><br></pre></td></tr></table></figure>
<p>在moviesTable中传入columns(不是state)</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> columns = [</span><br><span class="line">    &#123; <span class="attr">path</span>: <span class="string">"title"</span>, <span class="attr">label</span>: <span class="string">"Title"</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">path</span>: <span class="string">"director"</span>, <span class="attr">label</span>: <span class="string">"Director"</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">path</span>: <span class="string">"actor"</span>, <span class="attr">label</span>: <span class="string">"Actors"</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">path</span>: <span class="string">"country"</span>, <span class="attr">label</span>: <span class="string">"Country"</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">path</span>: <span class="string">"index"</span>, <span class="attr">label</span>: <span class="string">"Range"</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">path</span>: <span class="string">"sort"</span>, <span class="attr">label</span>: <span class="string">"Score"</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">path</span>: <span class="string">"time"</span>, <span class="attr">label</span>: <span class="string">"Time"</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">key</span>: <span class="string">"like"</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">key</span>: <span class="string">"Delete"</span> &#125;,</span><br><span class="line">  ];</span><br><span class="line"><span class="comment">//...在table中传入 &lt;TableHeader/&gt;,把columns,sortColumn，onSort传给表头组件</span></span><br><span class="line"><span class="comment">// columns在MovieTable中定义，sortColumn和onSort则在Movies传给MovieTable的props中</span></span><br><span class="line"><span class="comment">//等于说，表头raise一个event，表再把这个event向Movies抛，然后Movies组件来解决</span></span><br><span class="line">        &lt;TableHeader</span><br><span class="line">          columns=&#123;<span class="keyword">this</span>.columns&#125;</span><br><span class="line">          sortColumn=&#123;sortColumn&#125;</span><br><span class="line">          onSort=&#123;onSort&#125;</span><br><span class="line">        /&gt;</span><br></pre></td></tr></table></figure>
<p>封装好后，代码变得干净很多，表的重复利用的概率也大大提升</p>
<h3 id="Sorting-Extracting-TableBody"><a href="#Sorting-Extracting-TableBody" class="headerlink" title="Sorting- Extracting TableBody"></a>Sorting- Extracting TableBody</h3><p>如法炮制，我们要封装表体</p>
<p>在common文件夹中新建 tableBody.jsx</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TableBody</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">  render() &#123;</span><br><span class="line">      <span class="comment">//解构从moviestable传过来的props</span></span><br><span class="line">    <span class="keyword">const</span> &#123; data, columns &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="comment">//生成表体，这里的data代表了movies，然后对于每一个movie，生成一行</span></span><br><span class="line">        <span class="comment">//在每一行中用渲染出每一列对应的数据</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        相当于把这些渲染出来</span></span><br><span class="line"><span class="comment">              &lt;td&gt;&#123;movie.title&#125;&lt;/td&gt;</span></span><br><span class="line"><span class="comment">              &lt;td&gt;&#123;movie.director&#125;&lt;/td&gt;</span></span><br><span class="line"><span class="comment">              &lt;td&gt;&#123;movie.actor&#125;&lt;/td&gt;</span></span><br><span class="line"><span class="comment">              &lt;td&gt;&#123;movie.time&#125;&lt;/td&gt;</span></span><br><span class="line"><span class="comment">              //.....</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">      &lt;tbody&gt;</span><br><span class="line">        &#123;data.map(<span class="function">(<span class="params">item</span>) =&gt;</span> (</span><br><span class="line">          &lt;tr&gt;</span><br><span class="line">            &#123;columns.map(<span class="function"><span class="params">column</span>=&gt;</span><span class="xml"><span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span>)&#125;</span><br><span class="line">          &lt;<span class="regexp">/tr&gt;</span></span><br><span class="line"><span class="regexp">        ))&#125;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>tbody&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> TableBody;</span><br></pre></td></tr></table></figure>
<h3 id="Sorting-Rendering-Cell-Content"><a href="#Sorting-Rendering-Cell-Content" class="headerlink" title="Sorting- Rendering Cell Content"></a>Sorting- Rendering Cell Content</h3><p>现在我们对每一个<td\>标签渲染</td\></p>
<p>这里我们要用到lodash中的get方法_.get(item,column.path) 前面传入一个对象item，后面传入的目标属性是可以嵌套的，也就是说我们可以从item中提取出column.path来进行渲染</p>
<p>然后我们对moviesTable中的tbody进行修改,删除原来的行，并且把列和电影信息通过props传给表体</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;TableBody data=&#123;movies&#125; columns=&#123;<span class="keyword">this</span>.columns&#125; /&gt;</span><br></pre></td></tr></table></figure>
<p>但这样还是不够的，我们在上面定义的时候，like和delete两列只包含了key而没有具体的操作，如果我们盲目的把\<like \> 和 <button\> 标签删去，那么我们将失去这两个功能，所以我们要把这两个标签移动到columns数组中去。</button\></like></p>
<p>在这里需要理解一点，在jsx中编译的react元素实际上是JavaScript对象。比如说 const x=\<h1\><h1\> 那么这其实是一个对象，调用h1对象的jsx代码其实就是JavaScript对象。那么我们就可以对columns中的like和delete传入一个jsx表达式。实际上就是让渲染的时候，每一行都渲染出一个like对象和delete对象</h1\></h1\></p>
<p>那么问题又来了，我们如果直接复制到cotent后面，那么movie.liked中的movie实际上我们是没有定义的啊（本来是通过<em>movies.map((movie) =&gt; ()</em> 渲染的。所以我们还需要修改一下</p>
<p>我们把content设置成一个函数，传入movie，然后导出一个like对象和一个delete对象</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">columns = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">"title"</span>, <span class="attr">label</span>: <span class="string">"Title"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">"director"</span>, <span class="attr">label</span>: <span class="string">"Director"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">"actor"</span>, <span class="attr">label</span>: <span class="string">"Actors"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">"country"</span>, <span class="attr">label</span>: <span class="string">"Country"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">"index"</span>, <span class="attr">label</span>: <span class="string">"Range"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">"sort"</span>, <span class="attr">label</span>: <span class="string">"Score"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">"time"</span>, <span class="attr">label</span>: <span class="string">"Time"</span> &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    key: <span class="string">"like"</span>,</span><br><span class="line">    content: <span class="function"><span class="params">movie</span>=&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">Like</span> <span class="attr">liked</span>=<span class="string">&#123;movie.liked&#125;</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> this.props.onLike(movie)&#125; /&gt;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    key: <span class="string">"Delete"</span>,</span><br><span class="line">    content: <span class="function"><span class="params">movie</span>=&gt;</span>(</span><br><span class="line">      &lt;button onClick=&#123;() =&gt; <span class="keyword">this</span>.props.onDelete&#125; className=<span class="string">"btn btn-danger btn-sm"</span>&gt;</span><br><span class="line">        Delete</span><br><span class="line">      &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">    ),</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">];</span></span><br></pre></td></tr></table></figure>
<p>现在我们要回到tableBody处理我们的渲染</p>
<p>为了代码简洁，我们在这里写一个函数renderCell，在td标签中调用renderCell。</p>
<p>这个函数的处理逻辑是这样，传入当前的item（电影信息），和column（当前列），然后我们看看这个列的content存在与否（我们知道只有like和delete存在）。</p>
<p>如果存在的话，那么就传入当前movie，让这个content渲染一个对象出来。</p>
<p>那么如果content不存在，我们就返回当前电影信息中名称等于column.path的属性</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">"lodash"</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TableBody</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  renderCell = <span class="function">(<span class="params">item, column</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (column.content) <span class="keyword">return</span> column.content(item);</span><br><span class="line">    <span class="keyword">return</span> _.get(item, column.path);</span><br><span class="line">  &#125;;</span><br><span class="line">  state = &#123;&#125;;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; data, columns &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;tbody&gt;</span><br><span class="line">        &#123;data.map(<span class="function">(<span class="params">item</span>) =&gt;</span> (</span><br><span class="line">          &lt;tr&gt;</span><br><span class="line">            &#123;columns.map(<span class="function">(<span class="params">column</span>) =&gt;</span> (</span><br><span class="line">              &lt;td&gt;&#123;<span class="keyword">this</span>.renderCell(item, column)&#125;&lt;<span class="regexp">/td&gt;</span></span><br><span class="line"><span class="regexp">            ))&#125;</span></span><br><span class="line"><span class="regexp">          &lt;/</span>tr&gt;</span><br><span class="line">        ))&#125;</span><br><span class="line">      &lt;<span class="regexp">/tbody&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default TableBody;</span></span><br></pre></td></tr></table></figure>
<p>这就是我们的组件树了，代码的层次结构变得简单明了，这是我们始终追求的！</p>
<p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/8.png" style="zoom:80%;"></p>
<h3 id="Sorting-Unique-Keys-Final"><a href="#Sorting-Unique-Keys-Final" class="headerlink" title="Sorting- Unique Keys - Final"></a>Sorting- Unique Keys - Final</h3><p>给每个迭代的标签加上单独键值，不需要多说</p>
<h3 id="Sorting-Adding-the-Sort-Icon"><a href="#Sorting-Adding-the-Sort-Icon" class="headerlink" title="Sorting- Adding the Sort Icon"></a>Sorting- Adding the Sort Icon</h3><p>加入一个箭头表示表示当前排序顺序，源码来自fontawesome（前提得npm啊！）</p>
<p>加在表头上 tablehead.jsx</p>
<p>如果当前的列不是被筛选列，那么我们就什么都不显示</p>
<p>如果是筛选列，那么如果是正序（asc),那就对应\<i class="fa fa-sort-asc">&lt;/i>;<i class="fa fa-sort-asc"></i>;</i></p>
<p>如果是逆序，那么就对应\<i classname="fa fa-sort-desc" \>&lt;/i><i classname="fa fa-sort-desc"></i></i></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  renderSortIcon = <span class="function">(<span class="params">column</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; sortColumn &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> (column.path !== <span class="keyword">this</span>.props.sortColumn.path) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (sortColumn.order === <span class="string">"asc"</span>) <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-sort-asc"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">i</span> <span class="attr">className</span>=<span class="string">"fa fa-sort-desc"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></span><br><span class="line">  &#125;;</span><br><span class="line">render() &#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">            &lt;th</span><br><span class="line">              key=&#123;column.path || column.key&#125;</span><br><span class="line">              onClick=&#123;() =&gt; <span class="keyword">this</span>.raiseSort(column.path)&#125;</span><br><span class="line">            &gt;</span><br><span class="line">              &#123;column.label&#125;</span><br><span class="line">              &#123;<span class="keyword">this</span>.renderSortIcon(column)&#125;</span><br><span class="line">            &lt;<span class="regexp">/th&gt;</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/...</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/9.png" style="zoom:100%;"></p>
<h3 id="Sorting-Extracting-Table-封装表格组件"><a href="#Sorting-Extracting-Table-封装表格组件" class="headerlink" title="Sorting- Extracting Table    封装表格组件"></a>Sorting- Extracting Table    封装表格组件</h3><p>现在在我们的moviesTable组件当中，我们看到现在表中的组件</p>
<p>里面有一个表头组件，一个表体组件</p>
<p>我们可以再次优化，那就是吧这个表格抽象成一个组件，包含表头和表体</p>
<p>这样我们在movieTable中只要加入Table组件就可以了，movieTable用来做函数处理，剩下的结构都由子组件实现</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">render() &#123;</span><br><span class="line">   <span class="keyword">const</span> &#123; movies, onSort, sortColumn &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">   <span class="keyword">return</span> (</span><br><span class="line">     &lt;table className=<span class="string">"table"</span>&gt;</span><br><span class="line">       &lt;TableHeader</span><br><span class="line">         columns=&#123;<span class="keyword">this</span>.columns&#125;</span><br><span class="line">         sortColumn=&#123;sortColumn&#125;</span><br><span class="line">         onSort=&#123;onSort&#125;</span><br><span class="line">       /&gt;</span><br><span class="line">       &lt;TableBody data=&#123;movies&#125; columns=&#123;<span class="keyword">this</span>.columns&#125; /&gt;</span><br><span class="line">     &lt;<span class="regexp">/table&gt;</span></span><br><span class="line"><span class="regexp">   );</span></span><br><span class="line"><span class="regexp"> &#125;</span></span><br></pre></td></tr></table></figure>
<p>那么我们在common文件夹中新建一个table.jsx，把他创建成一个可以重复使用的表格组件</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> TableHeader <span class="keyword">from</span> <span class="string">"./tableHead"</span>;</span><br><span class="line"><span class="keyword">import</span> TableBody <span class="keyword">from</span> <span class="string">"./tableBody"</span>;</span><br><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">const</span> Table = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//解构props</span></span><br><span class="line">  <span class="keyword">const</span> &#123; columns, sortColum, onSort, data &#125; = props;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">      <span class="comment">//返回一张表所需要的部分：表头和表体</span></span><br><span class="line">    &lt;table className=<span class="string">"table"</span>&gt;</span><br><span class="line">      &lt;TableHeader</span><br><span class="line">        columns=&#123;columns&#125;</span><br><span class="line">        sortColumn=&#123;sortColumn&#125;</span><br><span class="line">        onSort=&#123;onSort&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;TableBody data=&#123;data&#125; columns=&#123;columns&#125; /&gt;</span><br><span class="line">    &lt;<span class="regexp">/table&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default Table;</span></span><br></pre></td></tr></table></figure>
<p>这样我们在moviesTable的render中只要这样就可以了</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">render() &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; movies, onSort, sortColumn &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">      <span class="comment">//像Table组件中传入他需要的props</span></span><br><span class="line">    &lt;Table</span><br><span class="line">      columns=&#123;<span class="keyword">this</span>.columns&#125;</span><br><span class="line">      data=&#123;movies&#125;</span><br><span class="line">      sortColumm=&#123;sortColumn&#125;</span><br><span class="line">      onSort=&#123;onSort&#125;</span><br><span class="line">    /&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>总结一下moviesTable组建的实现过程</p>
<p>这个组件定义了我们希望显示的列 columns，这个实现是针对电影的</p>
<p>在render中我渲染了一个Table组件，这个组件相当于一个Wrapper，他拥有这个表格所需要的所有数据</p>
<p>今后我如果想要渲染一个客户信息的表格，那么我需要做的只是重复利用这个表格组件，然后把我们想要渲染的列传进去就可以了</p>
<h3 id="Sorting-Extracting-a-Method"><a href="#Sorting-Extracting-a-Method" class="headerlink" title="Sorting- Extracting a Method"></a>Sorting- Extracting a Method</h3><p>我们现在的代码已经很简洁了，但是还是不完美在Movies组件中</p>
<p>因为我们写了很多行逻辑方法，filtered，sorted，movies=paginate(…) 那么我们现在把这些写成一个方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">getPagedData = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//先解构，重命名movies</span></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      pageSize,</span><br><span class="line">      currentPage,</span><br><span class="line">      sortColumn,</span><br><span class="line">      selectedGenre,</span><br><span class="line">      movies: allMovies,</span><br><span class="line">    &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">	<span class="comment">// 里面封装我选择、排序的逻辑</span></span><br><span class="line">    <span class="comment">//这个选择器和老师的不太一样，因为我的数据库是自己爬取下来的豆瓣Top250。</span></span><br><span class="line">    <span class="keyword">const</span> filtered =</span><br><span class="line">      selectedGenre &amp;&amp; selectedGenre._id</span><br><span class="line">        ? allMovies.filter(<span class="function">(<span class="params">movie</span>)=&gt;</span><span class="keyword">this</span>.inSort(movie, selectedGenre))</span><br><span class="line">        : allMovies;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sorted = _.orderBy(filtered, [sortColumn.path], [sortColumn.order]);</span><br><span class="line">    <span class="keyword">const</span> movies = paginate(sorted, currentPage, pageSize);</span><br><span class="line">	<span class="comment">// 把filtered.length当作totalCount，movies当作data，然后当成一个对象返回</span></span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">totalCount</span>: filtered.length, <span class="attr">data</span>: movies &#125;;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>在render中</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"> render() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="attr">length</span>: count &#125; = <span class="keyword">this</span>.state.movies;</span><br><span class="line">    <span class="keyword">const</span> &#123; pageSize, currentPage, sortColumn &#125; = <span class="keyword">this</span>.state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (count === <span class="number">0</span>) <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>There are no movies in the database.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line"><span class="comment">//用一个对象来接收getPageData 返回的数据，其中data还原成movies，为了直观</span></span><br><span class="line">    <span class="keyword">const</span> &#123; totalCount, <span class="attr">data</span>: movies &#125; = <span class="keyword">this</span>.getPagedData();</span><br><span class="line"><span class="comment">//把下面的filter.count 全部替换成totalCount，movies照常(因为我们把data有命名为movie)</span></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div className=<span class="string">"row"</span>&gt;</span><br><span class="line">        &lt;div className=<span class="string">"col-3"</span>&gt;</span><br><span class="line">          &lt;ListGroup</span><br><span class="line">            items=&#123;<span class="keyword">this</span>.state.genres&#125;</span><br><span class="line">            selectedItem=&#123;<span class="keyword">this</span>.state.selectedGenre&#125;</span><br><span class="line">            onItemSelect=&#123;<span class="keyword">this</span>.handleGenreSelect&#125;</span><br><span class="line">          /&gt;</span><br><span class="line">        &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;div className="col"&gt;</span></span><br><span class="line"><span class="regexp">          &lt;p&gt;Showing &#123;totalCount&#125; movies in the database.&lt;/</span>p&gt;</span><br><span class="line">          &lt;MoviesTable</span><br><span class="line">            movies=&#123;movies&#125;</span><br><span class="line">            sortColumn=&#123;sortColumn&#125;</span><br><span class="line">            onLike=&#123;<span class="keyword">this</span>.handleLike&#125;</span><br><span class="line">            onDelete=&#123;<span class="keyword">this</span>.handleDelete&#125;</span><br><span class="line">            onSort=&#123;<span class="keyword">this</span>.handleSort&#125;</span><br><span class="line">          /&gt;</span><br><span class="line">          &lt;Pagination</span><br><span class="line">            itemsCount=&#123;totalCount&#125;</span><br><span class="line">            pageSize=&#123;pageSize&#125;</span><br><span class="line">            currentPage=&#123;currentPage&#125;</span><br><span class="line">            onPageChange=&#123;<span class="keyword">this</span>.handlePageChange&#125;</span><br><span class="line">          /&gt;</span><br><span class="line">        &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Destructuring-Arguments"><a href="#Destructuring-Arguments" class="headerlink" title="Destructuring Arguments"></a>Destructuring Arguments</h3><p>common文件夹下面的都是受控组件，我们没有必要再另写一行代码解构props</p>
<p>我们可以这么做</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//直接把属性名称写在括号内，就相当于在参数props中挑出了这些属性，然后直接=&gt;&#123;&#125; 即可</span></span><br><span class="line"><span class="keyword">const</span> Table = <span class="function">(<span class="params">&#123; columns, sortColumn, onSort, data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>同样我们对其他的组件也相应改变</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">const</span> ListGroup = (&#123;</span><br><span class="line">  items,</span><br><span class="line">  textProperty,</span><br><span class="line">  valueProperty,</span><br><span class="line">  selectedItem,</span><br><span class="line">  onItemSelect</span><br><span class="line">&#125;) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>…</p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p> <img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/10.png" style="zoom:80%;"></p>
<h2 id="Routing"><a href="#Routing" class="headerlink" title="Routing"></a>Routing</h2><h3 id="Introduction-1"><a href="#Introduction-1" class="headerlink" title="Introduction"></a>Introduction</h3><p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/12.png" style="zoom:80%;"></p>
<p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/11.png" style="zoom:80%;"></p>
<h3 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h3><p><a href="https://www.bilibili.com/video/BV1Sb411P79t?p=91" target="_blank" rel="noopener">https://www.bilibili.com/video/BV1Sb411P79t?p=91</a></p>
<p>教程</p>
<p><a href="https://www.filepicker.io/api/file/zceY1kIhS66M1jfqd9Gu" target="_blank" rel="noopener">https://www.filepicker.io/api/file/zceY1kIhS66M1jfqd9Gu</a></p>
<p>下载</p>
<h3 id="Adding-Routing"><a href="#Adding-Routing" class="headerlink" title="Adding Routing"></a>Adding Routing</h3><p>添加插件：npm install react-router-dom@4.3.1</p>
<p>在index.js中做如下修改</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="comment">//引入BrowserRouter</span></span><br><span class="line"><span class="keyword">import</span> &#123; BrowserRouter &#125; <span class="keyword">from</span> <span class="string">"react-router-dom"</span>;</span><br><span class="line">ReactDOM.render(</span><br><span class="line">    <span class="comment">//用这个标签涵盖App，这样App中的组件就可以用路由了</span></span><br><span class="line">    <span class="comment">//BrewserRouter记录了浏览器的历史，并传入了各组件树的成员</span></span><br><span class="line">  &lt;BrowserRouter&gt;</span><br><span class="line">    &lt;App /&gt;</span><br><span class="line">  &lt;<span class="regexp">/BrowserRouter&gt;,</span></span><br><span class="line"><span class="regexp">  document.getElementById("root")</span></span><br><span class="line"><span class="regexp">);</span></span><br><span class="line"><span class="regexp">registerServiceWorker();</span></span><br></pre></td></tr></table></figure>
<p>然后再app.js中做如下修改</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//引入 Route</span></span><br><span class="line"><span class="keyword">import</span> &#123; Route &#125; <span class="keyword">from</span> <span class="string">"react-router-dom"</span>;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;NavBar /&gt;</span><br><span class="line">        &lt;div className=<span class="string">"content"</span>&gt;</span><br><span class="line">            &#123;<span class="comment">/*</span></span><br><span class="line"><span class="comment">            我想要根据现在的URL渲染 给定的组件。这就是我们使用路由组件的地方</span></span><br><span class="line"><span class="comment">            接下来我们就注册一些路由，这个路由很想我们之前创建的组件，这些属性将作为props传递</span></span><br><span class="line"><span class="comment">            path代表地址，component就是路由的组件</span></span><br><span class="line"><span class="comment">            如果网页匹配了这个地址，那么他就会渲染出这个组件</span></span><br><span class="line"><span class="comment">            */</span>&#125;</span><br><span class="line">          &lt;Route path=<span class="string">"/products"</span> component=&#123;Products&#125; /&gt;</span><br><span class="line">          &lt;Route path=<span class="string">"/posts"</span> component=&#123;Posts&#125; /&gt;</span><br><span class="line">          &lt;Route path=<span class="string">"/admin"</span> component=&#123;Dashboard&#125; /&gt;</span><br><span class="line">          &lt;Route path=<span class="string">"/"</span> component=&#123;Home&#125; /&gt;</span><br><span class="line">        &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/3.gif" style="zoom:80%;"></p>
<p>但是我们看到了当其他组件产生的时候，Home组件始终存在，这是为什么？</p>
<h3 id="Switch"><a href="#Switch" class="headerlink" title="Switch"></a>Switch</h3><p>router的检测算法，会检测当前的地址是否以给定的字符串开始，如果是，那么后面的组件就会被渲染。</p>
<p>也就是说 <a href="http://localhost:3000/products/news,这时候news，products，home会同时被渲染" target="_blank" rel="noopener">http://localhost:3000/products/news,这时候news，products，home会同时被渲染</a></p>
<p>要解决这方法，我们可以利用exact属性</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Route path=<span class="string">"/"</span> exact component=&#123;Home&#125; /&gt;</span><br></pre></td></tr></table></figure>
<p>h或者利用Switch组件,用Switch 标签囊括所有的Route</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Route,Switch &#125; <span class="keyword">from</span> <span class="string">"react-router-dom"</span>;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"> 		&lt;div className=<span class="string">"content"</span>&gt;</span><br><span class="line"> 		&lt;Switch&gt;</span><br><span class="line">          &lt;Route path=<span class="string">"/products"</span> component=&#123;Products&#125; /&gt;</span><br><span class="line">          &lt;Route path=<span class="string">"/posts"</span> component=&#123;Posts&#125; /&gt;</span><br><span class="line">          &lt;Route path=<span class="string">"/admin"</span> component=&#123;Dashboard&#125; /&gt;</span><br><span class="line">          &lt;Route path=<span class="string">"/"</span> component=&#123;Home&#125; /&gt;</span><br><span class="line">        &lt;<span class="regexp">/Switch&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>div&gt;</span><br></pre></td></tr></table></figure>
<p>现在，问题已经解决了</p>
<h3 id="Link"><a href="#Link" class="headerlink" title="Link"></a>Link</h3><p>现在的情况就是，当我们点击一个链接的时候，我们会把整个页面全部重载，但是这样在大型程序中这样会非常慢，所以我们需要在点击的时候只重载需要重载的部分而不是整个页面。这个叫做单一页面程序。</p>
<p>我们需要Link组件来达成这个功能</p>
<p>在navbar.js中，我们做了以下修改</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="comment">//导入 Link 组件</span></span><br><span class="line"><span class="comment">// 把下面的 a 标签全换成 Link，把href全换成to</span></span><br><span class="line"><span class="keyword">import</span> &#123; Link &#125; <span class="keyword">from</span> <span class="string">"react-router-dom"</span>;</span><br><span class="line"><span class="keyword">const</span> NavBar = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">      &lt;li&gt;</span><br><span class="line">        &lt;Link to=<span class="string">"/"</span>&gt;Home&lt;<span class="regexp">/Link&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>li&gt;</span><br><span class="line">      &lt;li&gt;</span><br><span class="line">        &lt;Link to=<span class="string">"/products"</span>&gt;Products&lt;<span class="regexp">/Link&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>li&gt;</span><br><span class="line">      &lt;li&gt;</span><br><span class="line">        &lt;Link to=<span class="string">"/posts/2018/06"</span>&gt;Posts&lt;<span class="regexp">/Link&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>li&gt;</span><br><span class="line">      &lt;li&gt;</span><br><span class="line">        &lt;Link to=<span class="string">"/admin"</span>&gt;Admin&lt;<span class="regexp">/Link&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>li&gt;</span><br><span class="line">    &lt;<span class="regexp">/ul&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default NavBar;</span></span><br></pre></td></tr></table></figure>
<p>然后，我们发现点击的时候并没有更新整个页面。因为这些页面的内容已经在一个叫做bundle的文件当中了</p>
<p>看到我们的Home组件，只是个简单的js函数而已。所有的组件都是bundle的一部分代码，在初始的 时候已经下载了，所以在用户更换页面的时候没有重新下载</p>
<h3 id="Route-Props"><a href="#Route-Props" class="headerlink" title="Route Props"></a>Route Props</h3><p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/13.png" style="zoom:80%;"></p>
<p>我们发现products有很多props，但是我们并没有传入这些props</p>
<p>这就是Route组件的功劳了，本质上Route组件时传入component属性组件的wrapper，所有在加载自身的props的时候，还会自动加上这三个props</p>
<p>history属性时浏览器的history对象，可以去往不同页面，location属性表示了现在在哪里，里面有很多属性</p>
<p>match则展现了我们的URL时如何匹配的，里面也有很多属性‘</p>
<p>通过阅读文档加以了解</p>
<p><a href="https://reacttraining.com/react-router/core/guides/philosophy" target="_blank" rel="noopener">https://reacttraining.com/react-router/core/guides/philosophy</a></p>
<h3 id="Passing-Props"><a href="#Passing-Props" class="headerlink" title="Passing Props"></a>Passing Props</h3><p>我们怎么传递其他的props呢？</p>
 <figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;Route</span><br><span class="line">  path=<span class="string">"/products"</span></span><br><span class="line">  render=&#123;() =&gt; <span class="xml"><span class="tag">&lt;<span class="name">Products</span> <span class="attr">sortBy</span>=<span class="string">"newest"</span> /&gt;</span></span>&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>
<p>我们可以改写成这样</p>
<p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/14.png" style="zoom:80%;"></p>
<p>但是这样的话那三个默认的属性就不见了。为了修正这个问题我们需要在箭头函数中加入props</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;Route</span><br><span class="line">  path=<span class="string">"/products"</span></span><br><span class="line">  render=&#123;(props) =&gt; <span class="xml"><span class="tag">&lt;<span class="name">Products</span> <span class="attr">sortBy</span>=<span class="string">"newest"</span> &#123;<span class="attr">...pros</span>&#125;/&gt;</span></span>&#125;</span><br><span class="line">    <span class="comment">//这里运用了特殊的jsx语法。通过spread，所有的props属性都会展开</span></span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/15.png" style="zoom:80%;"></p>
<h3 id="Route-Parameters"><a href="#Route-Parameters" class="headerlink" title="Route Parameters"></a>Route Parameters</h3><p>有时候我们需要给路由传递参数。比如说我们选择不同的商品，会在URL上显示不同的产品id；这就是路由参数</p>
<p><a href="http://localhost:3000/products/3" target="_blank" rel="noopener">http://localhost:3000/products/3</a></p>
<p><a href="http://localhost:3000/products/2" target="_blank" rel="noopener">http://localhost:3000/products/2</a></p>
<p><a href="http://localhost:3000/products/1" target="_blank" rel="noopener">http://localhost:3000/products/1</a></p>
<p>我们首先在App中定义一个新的产品详情页面/后面是可以加参数的地方，我们这里是:id。为了定义参数我们需要在参数面前加上冒号，然后这个组件属性写称ProductDetails</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Route path=<span class="string">"/products/:id"</span> component=&#123;ProductDetails&#125;/&gt;</span><br><span class="line"><span class="comment">//我们也可以定义多个参数</span></span><br><span class="line">&lt;Route path=<span class="string">"/posts/:year/:month"</span> component=&#123;Posts&#125; /&gt;</span><br></pre></td></tr></table></figure>
<p>productDetails.jsx</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductDetails</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  handleSave = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Navigate to /products</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">           &#123;<span class="comment">/* 动态渲染当前的id */</span>&#125;</span><br><span class="line">        &lt;h1&gt;Product Details -&#123;<span class="keyword">this</span>.props.match.params.id&#125; &lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">        &lt;button onClick=&#123;this.handleSave&#125;&gt;Save&lt;/</span>button&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default ProductDetails;</span></span><br></pre></td></tr></table></figure>
<h3 id="Optional-Parameters"><a href="#Optional-Parameters" class="headerlink" title="Optional Parameters"></a>Optional Parameters</h3><p>点击Posts的按钮显示的连接如下</p>
<p><a href="http://localhost:3000/posts/2018/06" target="_blank" rel="noopener">http://localhost:3000/posts/2018/06</a></p>
<p>如果只保留年，那么却显示home，这是为什么？</p>
<p><a href="http://localhost:3000/posts/2018" target="_blank" rel="noopener">http://localhost:3000/posts/2018</a></p>
<p>因为我们在定义路由的参数时默认情况时必须都要满足,这里我们年月都需要有才能匹配</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Route path=<span class="string">"/posts/:year/:month"</span> component=&#123;Posts&#125; /&gt;</span><br></pre></td></tr></table></figure>
<p>那么怎么才能让月份变得可选？那么我们就需要这样写</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Route path=<span class="string">"/posts/:year?/:month?"</span> component=&#123;Posts&#125; /&gt;</span><br></pre></td></tr></table></figure>
<p>这是JavaScript中的正则表达式，如果在这之前加入一个问号，那么这个参数就是可选的</p>
<p>回到post我们渲染这个年份和月份</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Posts = <span class="function">(<span class="params">&#123; match &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h1&gt;Posts&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      Year: &#123;match.params.year&#125;, Month:&#123;match.params.month&#125;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Posts;</span><br></pre></td></tr></table></figure>
<p>当url=<a href="http://localhost:3000/posts的时候" target="_blank" rel="noopener">http://localhost:3000/posts的时候</a></p>
<p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/16.png" style="zoom:80%;"></p>
<p>当url=<a href="http://localhost:3000/posts/2018的时候" target="_blank" rel="noopener">http://localhost:3000/posts/2018的时候</a></p>
<p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/17.png" style="zoom:80%;"></p>
<h3 id="Query-String-Parameters"><a href="#Query-String-Parameters" class="headerlink" title="Query String Parameters"></a>Query String Parameters</h3><p>我们说可选参数需要尽量避免。与其在路由中使用可选参数，不如在查询字符串当中使用</p>
<p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/18.png" style="zoom:80%;"></p>
<p>比如说我传入上面一个url，在react当中我们需要读取这个字符串的意思</p>
<p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/19.png" style="zoom:80%;"></p>
<p>也就是search 属性后面的字符串，我们需要下载插件来完成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install query-string@6.1.0</span><br></pre></td></tr></table></figure>
<p>然后我们在posts.jsx中做如下改动</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> queryString <span class="keyword">from</span> <span class="string">'query-string'</span></span><br><span class="line"><span class="comment">//解构 location,也就是上面那个props</span></span><br><span class="line"><span class="keyword">const</span> Posts = <span class="function">(<span class="params">&#123; match,location &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> result= queryString.parse( location.search);</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h1&gt;Posts&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      Year: &#123;match.params.year&#125;, Month:&#123;match.params.month&#125;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Posts;</span><br></pre></td></tr></table></figure>
<p>打印结果如下：</p>
<p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/20.png" style="zoom:80%;"></p>
<h3 id="Redirects-跳转"><a href="#Redirects-跳转" class="headerlink" title="Redirects 跳转"></a>Redirects 跳转</h3><p>我现在向让不存在的url跳转到404 Not Found 而不是Home页面，怎么办?</p>
<p>首先在home这个router中加入exact修饰</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Route path=<span class="string">"/"</span> exact component=&#123;Home&#125; /&gt;</span><br></pre></td></tr></table></figure>
<p>然后从react-router-dom 中解构Redirect</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Route, Switch ,Redirect&#125; <span class="keyword">from</span> <span class="string">"react-router-dom"</span>;</span><br></pre></td></tr></table></figure>
<p>然后对return的内容进行修改</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;NavBar /&gt;</span><br><span class="line">        &lt;div className=<span class="string">"content"</span>&gt;</span><br><span class="line">          &lt;Switch&gt;</span><br><span class="line">            &lt;Route path=<span class="string">"/products/:id"</span> component=&#123;ProductDetails&#125; /&gt;</span><br><span class="line">            &lt;Route</span><br><span class="line">              path=<span class="string">"/products"</span></span><br><span class="line">              render=&#123;(props) =&gt; <span class="xml"><span class="tag">&lt;<span class="name">Products</span> <span class="attr">sortBy</span>=<span class="string">"newest"</span> &#123;<span class="attr">...props</span>&#125; /&gt;</span></span>&#125;</span><br><span class="line">            /&gt;</span><br><span class="line">              &#123;<span class="comment">/* 首先加入一个not-found链接*/</span>&#125;</span><br><span class="line">            &lt;Route path=<span class="string">"/not-found"</span> component=&#123;NotFound&#125; /&gt;</span><br><span class="line">            &lt;Route path=<span class="string">"/posts/:year?/:month?"</span> component=&#123;Posts&#125; /&gt;</span><br><span class="line">            &lt;Route path=<span class="string">"/admin"</span> component=&#123;Dashboard&#125; /&gt;</span><br><span class="line">            &lt;Route path=<span class="string">"/"</span> exact component=&#123;Home&#125; /&gt;</span><br><span class="line">              &#123;<span class="comment">/*Redirect标签代表了如果都没有匹配到，那么就去to所代表的页面*/</span>&#125;</span><br><span class="line">            &lt;Redirect to=<span class="string">"/not-found"</span> /&gt;</span><br><span class="line">          &lt;<span class="regexp">/Switch&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>div&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br></pre></td></tr></table></figure>
<p>如果有时候我想把网页上的资源从一页转移到另外一页上去，我们用 Redirect from to实现。比如说我添加</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Redirect <span class="keyword">from</span>=<span class="string">"/messages"</span> to=<span class="string">"/posts"</span> /&gt;</span><br></pre></td></tr></table></figure>
<p>那么我们在浏览器输入messages的时候就会自动跳转到posts页面上去</p>
<h3 id="Programmatic-Navigation"><a href="#Programmatic-Navigation" class="headerlink" title="Programmatic Navigation"></a>Programmatic Navigation</h3><p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/21.png" style="zoom:80%;"></p>
<p>现在当我们点击保存按钮的时候，我们将用户转回列表页，这就是Programmatic Navigation。那么该如何操作？</p>
<p>这涉及到props.history中的连个属性：push 和 replace</p>
<p>这两个差别在于push会向浏览器添加历史地址，所以我可以通过后退按钮回到上一个页面。而replace是替换当前的页面，所以没有历史记录</p>
<p>如果在productsDetails.jsx中的handleSave方法中这样实现</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">handleSave = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// Navigate to /products</span></span><br><span class="line">  <span class="keyword">this</span>.props.history.push(<span class="string">"/products"</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>那么在浏览器中，我们点击save按钮，回到produts目录页面。如果点击浏览器的返回，那么仍然返回到save页面。</p>
<p>那么如果我这样实现</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">handleSave = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// Navigate to /products</span></span><br><span class="line">  <span class="keyword">this</span>.props.history.replace(<span class="string">"/products"</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>那么我们将无法返回。这就是很多登陆页面做的逻辑，我们一旦登陆后就无法回到登陆时候的页面了</p>
<h3 id="Nested-Routing-嵌套路由"><a href="#Nested-Routing-嵌套路由" class="headerlink" title="Nested Routing 嵌套路由"></a>Nested Routing 嵌套路由</h3><p>我们想要在点击Admin的时候在弹出两个链接，一个是posts，一个是users 这就是嵌套路由了</p>
<p>我们先进入到dashboard.jsx，里面引入一个sidebar.jsx</p>
<p>sidebar.jsx代码如下</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Link &#125; <span class="keyword">from</span> <span class="string">"react-router-dom"</span>;</span><br><span class="line"><span class="keyword">import</span> Users <span class="keyword">from</span> <span class="string">"./users"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> SideBar = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">      &lt;li&gt;</span><br><span class="line">        &lt;Link to=<span class="string">"/admin/posts"</span>&gt;Posts&lt;<span class="regexp">/Link&gt;&#123;/</span>*点击Posts进行跳转*<span class="regexp">/&#125;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>li&gt;</span><br><span class="line">      &lt;li&gt;</span><br><span class="line">        &lt;Link to=<span class="string">"/admin/users"</span>&gt;Users&lt;<span class="regexp">/Link&gt;&#123;/</span>*点击Users进行跳转*<span class="regexp">/&#125;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>li&gt;</span><br><span class="line">    &lt;<span class="regexp">/ul&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default SideBar;</span></span><br></pre></td></tr></table></figure>
<p>然后呢在dashboard.jsx中引入该引入的users,posts 文件</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">const</span> Dashboard = <span class="function">(<span class="params">&#123; match &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h1&gt;Admin Dashboard&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;SideBar /</span>&gt;</span><br><span class="line">          &#123;<span class="comment">/*引入Route组件，当链接为...时，渲染...组件*/</span>&#125;</span><br><span class="line">      &lt;Route path=<span class="string">"/admin/posts"</span> component=&#123;Posts&#125; /&gt;</span><br><span class="line">      &lt;Route path=<span class="string">"/admin/users"</span> component=&#123;Users&#125; /&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default Dashboard;</span></span><br></pre></td></tr></table></figure>
<h3 id="Exercises-NavBar-and-Routing"><a href="#Exercises-NavBar-and-Routing" class="headerlink" title="Exercises- NavBar and Routing"></a>Exercises- NavBar and Routing</h3><p>达到这个效果</p>
<p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/12.png" style="zoom:80%;"></p>
<h3 id="Adding-React-Router"><a href="#Adding-React-Router" class="headerlink" title="Adding React Router"></a>Adding React Router</h3><p>首先在vidly文件夹下安装rrd</p>
<p>在index.js中 引入，包裹……</p>
<p>现在新建了几个组件，Customers，MovieForm，Rentals，NotFound，格式如下</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">const</span> MovieForm = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>MovieForm<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> MovieForm</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/22.png" style="zoom:80%;"></p>
<h3 id="Adding-Routes"><a href="#Adding-Routes" class="headerlink" title="Adding Routes"></a>Adding Routes</h3><p>在App.jsx中这样写路由</p>
<p>默认显示movies页面，如果未匹配，那么就跳转到notFound``</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;main className=<span class="string">"container"</span>&gt;</span><br><span class="line">        &lt;Switch&gt;</span><br><span class="line">        &lt;Route path=<span class="string">"/movies"</span> component=&#123;Movies&#125;&gt;&lt;<span class="regexp">/Route&gt;</span></span><br><span class="line"><span class="regexp">        &lt;Route path="/</span>customers<span class="string">" component=&#123;Customers&#125;&gt;&lt;/Route&gt;</span></span><br><span class="line"><span class="string">        &lt;Route path="</span>/rentals<span class="string">" component=&#123;Rentals&#125;&gt;&lt;/Route&gt;</span></span><br><span class="line"><span class="string">        &lt;Route path="</span>/not-found<span class="string">" component=&#123;NotFound&#125;&gt;&lt;/Route&gt;</span></span><br><span class="line"><span class="string">        &lt;Redirect from="</span>/<span class="string">"exact to="</span>movies<span class="string">"/&gt;</span></span><br><span class="line"><span class="string">        &lt;Redirect to="</span>/not-found<span class="string">"/&gt;</span></span><br><span class="line"><span class="string">        &lt;/Switch&gt;</span></span><br><span class="line"><span class="string">      &lt;/main&gt;</span></span><br><span class="line"><span class="string">    );</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="Adding-the-NavBar"><a href="#Adding-the-NavBar" class="headerlink" title="Adding the NavBar"></a>Adding the NavBar</h3><p>从bootstrap上拷贝NavBar代码下来，新建一个NavBar 组件</p>
<p>把a全换成NavLink，除了第一个NavBar之外，这样标签就会自动调整样式，把href都换成 to，然后把地址，名称都渲染上去</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Link, NavLink &#125; <span class="keyword">from</span> <span class="string">"react-router-dom"</span>;</span><br><span class="line"><span class="keyword">import</span> Movies <span class="keyword">from</span> <span class="string">"./movies"</span>;</span><br><span class="line"><span class="keyword">import</span> Customers <span class="keyword">from</span> <span class="string">"./customers"</span>;</span><br><span class="line"><span class="keyword">import</span> Rentals <span class="keyword">from</span> <span class="string">"./rentals"</span>;</span><br><span class="line"><span class="keyword">const</span> NavBar = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;nav className=<span class="string">"navbar navbar-expand-lg navbar-light bg-light"</span>&gt;</span><br><span class="line">      &lt;Link className=<span class="string">"navbar-brand"</span> to=<span class="string">"#"</span>&gt;</span><br><span class="line">        Navbar</span><br><span class="line">      &lt;<span class="regexp">/Link&gt;</span></span><br><span class="line"><span class="regexp">      &lt;button</span></span><br><span class="line"><span class="regexp">        className="navbar-toggler"</span></span><br><span class="line"><span class="regexp">        type="button"</span></span><br><span class="line"><span class="regexp">        data-toggle="collapse"</span></span><br><span class="line"><span class="regexp">        data-target="#navbarNav"</span></span><br><span class="line"><span class="regexp">        aria-controls="navbarNav"</span></span><br><span class="line"><span class="regexp">        aria-expanded="false"</span></span><br><span class="line"><span class="regexp">        aria-label="Toggle navigation"</span></span><br><span class="line"><span class="regexp">      &gt;</span></span><br><span class="line"><span class="regexp">        &lt;span className="navbar-toggler-icon"&gt;&lt;/</span>span&gt;</span><br><span class="line">      &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div className="collapse navbar-collapse" id="navbarNav"&gt;</span></span><br><span class="line"><span class="regexp">        &lt;ul className="navbar-nav"&gt;</span></span><br><span class="line"><span class="regexp">          &lt;li className="nav-item "&gt;</span></span><br><span class="line"><span class="regexp">            &lt;NavLink className="nav-link" to="/m</span>ovies<span class="string">"&gt;</span></span><br><span class="line"><span class="string">              Movies &lt;span className="</span>sr-only<span class="string">"&gt;(current)&lt;/span&gt;</span></span><br><span class="line"><span class="string">            &lt;/NavLink&gt;</span></span><br><span class="line"><span class="string">          &lt;/li&gt;</span></span><br><span class="line"><span class="string">          &lt;li className="</span>nav-item<span class="string">"&gt;</span></span><br><span class="line"><span class="string">            &lt;NavLink className="</span>nav-link<span class="string">" to="</span>/customers<span class="string">"&gt;</span></span><br><span class="line"><span class="string">              Customers</span></span><br><span class="line"><span class="string">            &lt;/NavLink&gt;</span></span><br><span class="line"><span class="string">          &lt;/li&gt;</span></span><br><span class="line"><span class="string">          &lt;li className="</span>nav-item<span class="string">"&gt;</span></span><br><span class="line"><span class="string">            &lt;NavLink className="</span>nav-link<span class="string">" to="</span>/rentals<span class="string">"&gt;</span></span><br><span class="line"><span class="string">              Rentals</span></span><br><span class="line"><span class="string">            &lt;/NavLink&gt;</span></span><br><span class="line"><span class="string">          &lt;/li&gt;</span></span><br><span class="line"><span class="string">        &lt;/ul&gt;</span></span><br><span class="line"><span class="string">      &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/nav&gt;</span></span><br><span class="line"><span class="string">  );</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">export default NavBar;</span></span><br></pre></td></tr></table></figure>
<h3 id="Linking-to-the-MovieForm"><a href="#Linking-to-the-MovieForm" class="headerlink" title="Linking to the MovieForm"></a>Linking to the MovieForm</h3><p>连接到MovieForm，也就是给表格内容添加链接。</p>
<p>首先在MoviesTable的列中添加content内容,也就是说在渲染的时候，tableBody会渲染出一个Link组件。to属性就是我们渲染的文本模板，我们用它来动态添加字符</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// import&#123; Link &#125;from "react-router-dom";</span></span><br><span class="line">columns = [</span><br><span class="line">    &#123;</span><br><span class="line">      path: <span class="string">"title"</span>,</span><br><span class="line">      label: <span class="string">"Title"</span>,</span><br><span class="line">      content: <span class="function">(<span class="params">movie</span>) =&gt;</span> (</span><br><span class="line">        &lt;Link to=&#123;<span class="string">`/movies/<span class="subst">$&#123;movie._id&#125;</span>`</span>&#125;&gt;&#123;movie.title&#125;&lt;<span class="regexp">/Link&gt;</span></span><br><span class="line"><span class="regexp">      ),</span></span><br><span class="line"><span class="regexp">    &#125;,</span></span><br><span class="line"><span class="regexp">   /</span><span class="regexp">/...</span></span><br><span class="line"><span class="regexp">  ];</span></span><br></pre></td></tr></table></figure>
<p>现在只完成了第一步，就是当我们点击电影的时候，网页链接后面会显示该电影id</p>
<p>如 <a href="http://localhost:3000/movies/5b21ca3eeb7f6fbccd47181a" target="_blank" rel="noopener">http://localhost:3000/movies/5b21ca3eeb7f6fbccd47181a</a></p>
<p>现在我们需要在App.js中加一条Route</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Route path=<span class="string">"/movies/:id"</span> component=&#123;MovieForm&#125;&gt;&lt;<span class="regexp">/Route&gt;</span></span><br></pre></td></tr></table></figure>
<p>最后我们需要在MovieForm中动态渲染出当前电影的id,利用match属性中的id来渲染当前的电影id，再添加一个回退按钮，利用history.push 中记录着的历史记录来实现</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; saveMovie &#125; <span class="keyword">from</span> <span class="string">"./../services/fakeMovieService"</span>;</span><br><span class="line"><span class="keyword">const</span> MovieForm = <span class="function">(<span class="params">&#123; match, history &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h1&gt;MovieForm &#123;match.params.id&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;button</span></span><br><span class="line"><span class="regexp">        className="btn btn-primarty"</span></span><br><span class="line"><span class="regexp">        onClick=&#123;() =&gt; history.push("/m</span>ovies<span class="string">")&#125;</span></span><br><span class="line"><span class="string">      &gt;</span></span><br><span class="line"><span class="string">        saveMovie</span></span><br><span class="line"><span class="string">      &lt;/button&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  );</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">export default MovieForm;</span></span><br></pre></td></tr></table></figure>
<p>现在我把自己做的豆瓣表格也通过这种方式加入到了NavBar当中去了</p>
<p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/23.png" style="zoom:40%;"></p>
<h3 id="Summary-1"><a href="#Summary-1" class="headerlink" title="Summary"></a>Summary</h3><p><img src="/2020/06/02/react%E5%9F%BA%E7%A1%802/24.png" style="zoom:40%;"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://jasonxqh.github.io/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason‘s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/" class="post-title-link" itemprop="url">幂级数</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-05-31 23:16:00" itemprop="dateCreated datePublished" datetime="2020-05-31T23:16:00+08:00">2020-05-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-09-08 12:36:36" itemprop="dateModified" datetime="2020-09-08T12:36:36+08:00">2020-09-08</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="幂级数"><a href="#幂级数" class="headerlink" title="幂级数"></a>幂级数</h1><h2 id="函数项级数的概念"><a href="#函数项级数的概念" class="headerlink" title="函数项级数的概念"></a>函数项级数的概念</h2><p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/1.png" style="zoom: 60%;"></p>
<p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/2.png" style="zoom: 60%;"></p>
<h3 id="例子："><a href="#例子：" class="headerlink" title="例子："></a>例子：</h3><p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/3.png" style="zoom: 60%;"></p>
<h2 id="幂级数及其收敛性"><a href="#幂级数及其收敛性" class="headerlink" title="幂级数及其收敛性"></a>幂级数及其收敛性</h2><p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/4.png" style="zoom: 60%;"></p>
<h3 id="Abel-定理"><a href="#Abel-定理" class="headerlink" title="Abel 定理"></a>Abel 定理</h3><p>$a_n$ 没有限定！</p>
<p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/5.png" style="zoom: 60%;"></p>
<p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/6.png" style="zoom: 60%;"></p>
<p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/7.png" style="zoom: 60%;"></p>
<p>因为在 $|x|&lt;|x_0|$ 的时候，幂级数是绝对收敛的，所以说条件收敛的点只可能是端点！</p>
<h3 id="定理二"><a href="#定理二" class="headerlink" title="定理二"></a>定理二</h3><p>$\Sigma<em>{n=0}^\infty a_nx^n$ 的收敛半径为$R =  \lim\limits</em>{n\rightarrow \infty} |\frac{a<em>n}{a</em>{n+1}}|$ </p>
<h3 id="例题："><a href="#例题：" class="headerlink" title="例题："></a>例题：</h3><p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/10.png" style="zoom: 60%;"></p>
<p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/11.png" style="zoom: 60%;"></p>
<h3 id="非标准型"><a href="#非标准型" class="headerlink" title="非标准型"></a>非标准型</h3><p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/12.png" style="zoom: 60%;"></p>
<h2 id="幂级数的运算"><a href="#幂级数的运算" class="headerlink" title="幂级数的运算"></a>幂级数的运算</h2><p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/12.png" style="zoom: 60%;"></p>
<h3 id="定理3"><a href="#定理3" class="headerlink" title="定理3"></a>定理3</h3><p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/13.png" style="zoom: 60%;"></p>
<p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/14.png" style="zoom: 60%;"></p>
<h3 id="定理4"><a href="#定理4" class="headerlink" title="定理4"></a>定理4</h3><p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/15.png" style="zoom: 60%;"></p>
<p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/16.png" style="zoom: 60%;"></p>
<h2 id="题型"><a href="#题型" class="headerlink" title="题型"></a>题型</h2><h3 id="收敛区间问题"><a href="#收敛区间问题" class="headerlink" title="收敛区间问题"></a>收敛区间问题</h3><p>首先拿到题目看看他是标准型还是非标准型</p>
<h4 id="如果是标准型"><a href="#如果是标准型" class="headerlink" title="如果是标准型"></a>如果是标准型</h4><p>那么计算<img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/21.png" style="zoom: 160%;">其中$a_n$是系数</p>
<p>计算出了R的值以后，我们就得到了收敛半径。但是我们仍需要验证端点。</p>
<p><strong>验证方法</strong></p>
<p>把端点带入，因为左右端点导致的结果可能不相同，所以需要分类讨论</p>
<p>端点带入后得到一个常数项级数，然后利用定义(趋向无穷是否等于0)或者常数项级数审敛法来判断是否收敛。</p>
<p>如果收敛那么就取闭，否则取开。</p>
<h4 id="如果是非标准型"><a href="#如果是非标准型" class="headerlink" title="如果是非标准型"></a>如果是非标准型</h4><p>那么就回到常数项级数审敛法，判断该用哪个审敛法：</p>
<p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/20.png" style="zoom: 160%;"></p>
<p>用完以后我们会得到一个带着x的式子，一般是$x^2$ 然后我们需要求这个式子等于1 的解，为什么？ 因为利用比值审敛法和根值审敛法得到的$\rho$ 都需要和1进行判断。</p>
<p>然后我们就解出x，这时候x就是端点。然后我们需要对端点带入进行判断验证</p>
<p>端点代入后得到一个常数项级数，然后利用定义(趋向无穷是否等于0)或者常数项级数审敛法来判断是否收敛。</p>
<h4 id="变量代换"><a href="#变量代换" class="headerlink" title="变量代换"></a>变量代换</h4><p>当形式不是$x^n$ 而是 $(ax+b)^n$ 形的时候，需要用一个变量代换。然后再按照上面的步骤解题</p>
<h3 id="和函数问题"><a href="#和函数问题" class="headerlink" title="和函数问题"></a>和函数问题</h3><p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/26.png" style="zoom: 67%;"></p>
<p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/27.png" style="zoom: 67%;"></p>
<p><strong>两个新的级数对应的收敛半径与原级数相同</strong></p>
<h4 id="解题步骤："><a href="#解题步骤：" class="headerlink" title="解题步骤："></a>解题步骤：</h4><ol>
<li>先求收敛半径-&gt;求得收敛区间</li>
<li>求和函数<ol>
<li>求导</li>
<li>积分</li>
<li>列项</li>
<li>题除公因子</li>
<li>化为等比数列后求和/或者化成常见的泰勒展开后代换</li>
</ol>
</li>
</ol>
<p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/40.png" style="zoom: 80%;"></p>
<h4 id="注意事项："><a href="#注意事项：" class="headerlink" title="注意事项："></a>注意事项：</h4><p>每个求和都写几项，要清楚是从n=几开始的！！！</p>
<p>分母或者系数中有 几的n次方之类的，可以和x^n 合并，然后极限改成 $\lim\limits_{x-&gt;\lambda x}…$  在解出和函数后把x带换成 $\lambda x$ （比如例题5）</p>
<h5 id="例一"><a href="#例一" class="headerlink" title="例一"></a>例一</h5><p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/36.png" style="zoom: 80%;"></p>
<p> <img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/31.png" style="zoom: 80%;"></p>
<p>我们通过乘一个x或者除一个x，让幂次等于分母，这样就可以刚好消除。当然，提取出一个$\frac{1}{x}$ 之前首先要说明当x=0 的时候是什么情况，最后写成分类函数的形式</p>
<h5 id="例二"><a href="#例二" class="headerlink" title="例二"></a>例二</h5><p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/29.png" style="zoom: 80%;"></p>
<p>没有分数，<strong>系数和幂次相差1(这里是n和n-1) 或者我们可以通过先提出一个数把格式化成能够积分的样子，然后用先积分再求导来做</strong></p>
<h5 id="例三"><a href="#例三" class="headerlink" title="例三"></a>例三</h5><p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/32.png" style="zoom: 80%;"></p>
<p>分母有n，同样用求导来做</p>
<p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/33.png" style="zoom: 80%;"></p>
<p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/34.png" style="zoom: 80%;"></p>
<h5 id="例四"><a href="#例四" class="headerlink" title="例四"></a>例四</h5><p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/37.png"></p>
<p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/38.png" style="zoom: 120%;"></p>
<h5 id="例五"><a href="#例五" class="headerlink" title="例五"></a>例五</h5><p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/41.png" style="zoom: 150%;"></p>
<p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/39.png" style="zoom: 120%;"></p>
<h2 id="练习册选题："><a href="#练习册选题：" class="headerlink" title="练习册选题："></a>练习册选题：</h2><p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/18.png" style="zoom: 200%;"></p>
<p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/23.png" style="zoom:120%;"></p>
<p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/17.png" style="zoom: 200%;"></p>
<p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/24.png" style="zoom:120%;"></p>
<p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/19.png" style="zoom: 200%;"></p>
<p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/25.png" style="zoom: 67%;"></p>
<h2 id="书本练习"><a href="#书本练习" class="headerlink" title="书本练习"></a>书本练习</h2><p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/11.jpg" style="zoom: 67%;"></p>
<p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/22.jpg" style="zoom: 67%;"></p>
<p><img src="/2020/05/31/%E5%B9%82%E7%BA%A7%E6%95%B0/33.jpg" style="zoom: 67%;"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/25/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><span class="page-number current">26</span><a class="page-number" href="/page/27/">27</a><span class="space">&hellip;</span><a class="page-number" href="/page/44/">44</a><a class="extend next" rel="next" href="/page/27/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Jason</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">439</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">68</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jason</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

    

  

</body>
</html>
