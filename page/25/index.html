<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=">


  <link rel="mask-icon" href="/images/logo.svg?v=" color="#222">














<meta property="og:type" content="website">
<meta property="og:title" content="Jason‘s Blog">
<meta property="og:url" content="https://jasonxqh.github.io/page/25/index.html">
<meta property="og:site_name" content="Jason‘s Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Jason">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '',
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    fancybox: false,
    tabs: ,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: 'undefined',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>







  <title>Jason‘s Blog</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', '[object Object]', 'auto');
  ga('send', 'pageview');
</script>





<meta name="generator" content="Hexo 4.2.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">
  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>
<a href="https://github.com/JasonXQH/JasonXQH.github.io" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jason‘s Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/%20" rel="section">
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/%20" rel="section">
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/%20" rel="section">
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://jasonxqh.github.io/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/%5Bobject%20Object%5D">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/" itemprop="url">函数展开成幂级数及其应用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-10T00:33:26+08:00">
                2020-06-10
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2020-09-09T12:09:10+08:00">
                2020-09-09
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="函数展开成幂级数及其应用"><a href="#函数展开成幂级数及其应用" class="headerlink" title="函数展开成幂级数及其应用"></a>函数展开成幂级数及其应用</h1><p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/1.png" style="zoom:80%;"></p>
<h2 id="泰勒级数"><a href="#泰勒级数" class="headerlink" title="泰勒级数"></a>泰勒级数</h2><p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/2.png" style="zoom: 67%;"></p>
<p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/4.png" style="zoom: 67%;"></p>
<h3 id="定理1"><a href="#定理1" class="headerlink" title="定理1"></a>定理1</h3><p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/5.png" style="zoom: 67%;"></p>
<h3 id="定理2"><a href="#定理2" class="headerlink" title="定理2"></a>定理2</h3><p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/6.png" style="zoom: 67%;"> </p>
<h2 id="函数展开成幂级数"><a href="#函数展开成幂级数" class="headerlink" title="函数展开成幂级数"></a>函数展开成幂级数</h2><h3 id="直接展开法"><a href="#直接展开法" class="headerlink" title="直接展开法"></a>直接展开法</h3><p>由泰勒级数理论可知，函数f(x) 展开成幂级数的步骤如下：</p>
<ol>
<li>求函数及其各阶导数在x=0 处的值；</li>
<li>写出麦克劳林级数，并求出其收敛半径为R</li>
<li>判别在 收敛区间（-R,R) 内 $\lim\limits_{n-&gt;\infty}R_n(x) $（余项）是否为0</li>
</ol>
<p>展开为幂级数，也可以说是展开成麦克劳林级数 </p>
<h3 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h3><h4 id="1"><a href="#1" class="headerlink" title="1"></a>1</h4><p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/8.png" style="zoom: 50%;"></p>
<h4 id="2"><a href="#2" class="headerlink" title="2"></a>2</h4><p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/9.png" style="zoom: 50%;"></p>
<h4 id="3"><a href="#3" class="headerlink" title="3."></a>3.</h4><p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/10.png" style="zoom: 50%;"></p>
<p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/11.png" style="zoom: 50%;"></p>
<p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/12.png" style="zoom: 50%;"></p>
<p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/13.png" style="zoom: 80%;"></p>
<h4 id="4"><a href="#4" class="headerlink" title="4."></a>4.</h4><p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/20.png" style="zoom: 80%;"></p>
<h4 id="5"><a href="#5" class="headerlink" title="5."></a>5.</h4><p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/21.png" style="zoom: 80%;"></p>
<h3 id="间接展开法"><a href="#间接展开法" class="headerlink" title="间接展开法"></a>间接展开法</h3><p>利用一些已知函数的展开式和幂级数的运算性质，将所给函数展开成幂级数</p>
<p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/14.png" style="zoom: 80%;"></p>
<p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/15.png" style="zoom: 80%;"></p>
<p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/16.png" style="zoom: 80%;"></p>
<p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/17.png" style="zoom: 80%;"></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/18.png" style="zoom: 50%;"></p>
<p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/19.png" style="zoom: 50%;"></p>
<p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/28.png" style="zoom: 80%;"></p>
<p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/29.png" style="zoom: 80%;"></p>
<p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/31.png" style="zoom: 80%;"></p>
<p>我们可以利用这个拓展的二项式定理解决很多问题</p>
<p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/32.png" style="zoom:120%;"></p>
<p>又比如</p>
<p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/1.jpg" style="zoom: 80%;"></p>
<h3 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h3><h4 id="展开为幂级数"><a href="#展开为幂级数" class="headerlink" title="展开为幂级数"></a>展开为幂级数</h4><h5 id="低难度"><a href="#低难度" class="headerlink" title="低难度"></a>低难度</h5><p>如果是三角函数，那么通过降幂，转化等，化成 sin kx 的形式</p>
<p>如果是个复杂的分子式，我们需要因式分解，然后转化成  1/x+1 或者1/1-x 的形式</p>
<h5 id="高难度"><a href="#高难度" class="headerlink" title="高难度"></a>高难度</h5><p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/22.png" style="zoom: 150%;"></p>
<p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/23.png" style="zoom: 150%;"></p>
<p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/24.png" style="zoom: 150%;"></p>
<p>（9） $(1+x)ln(1+x)$  </p>
<h5 id="幂级数展开与和函数"><a href="#幂级数展开与和函数" class="headerlink" title="幂级数展开与和函数"></a>幂级数展开与和函数</h5><p> <img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/25.png" style="zoom: 67%;"></p>
<h4 id="展开为XXX的幂级数"><a href="#展开为XXX的幂级数" class="headerlink" title="展开为XXX的幂级数"></a>展开为XXX的幂级数</h4><p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/26.png" style="zoom: 120%;"></p>
<p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/27.png" style="zoom: 120%;"></p>
<p><img src="/2020/06/10/%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E6%88%90%E5%B9%82%E7%BA%A7%E6%95%B0%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/2.jpg" style="zoom: 120%;"></p>

          
        
      
    </div>
    
    
    
    <div>
      
    </div>
    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://jasonxqh.github.io/2020/06/10/%E6%B5%85%E8%B0%88redux2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/%5Bobject%20Object%5D">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/10/%E6%B5%85%E8%B0%88redux2/" itemprop="url">浅谈redux2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-10T00:19:09+08:00">
                2020-06-10
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2020-08-13T14:21:28+08:00">
                2020-08-13
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="浅谈redux2"><a href="#浅谈redux2" class="headerlink" title="浅谈redux2"></a>浅谈redux2</h1><h2 id="Debugging-Redux-Applications"><a href="#Debugging-Redux-Applications" class="headerlink" title="Debugging Redux Applications"></a>Debugging Redux Applications</h2><h3 id="Installing-Redux-DevTools"><a href="#Installing-Redux-DevTools" class="headerlink" title="Installing Redux DevTools"></a>Installing Redux DevTools</h3><h3 id="The-Basics"><a href="#The-Basics" class="headerlink" title="The Basics"></a>The Basics</h3><h3 id="Inspector-Monitor"><a href="#Inspector-Monitor" class="headerlink" title="Inspector Monitor"></a>Inspector Monitor</h3><h3 id="Tracing"><a href="#Tracing" class="headerlink" title="Tracing"></a>Tracing</h3><h3 id="Exporting-and-Importing"><a href="#Exporting-and-Importing" class="headerlink" title="Exporting and Importing"></a>Exporting and Importing</h3><h2 id="Writing-Clean-Redux-Code"><a href="#Writing-Clean-Redux-Code" class="headerlink" title="Writing Clean Redux Code"></a>Writing Clean Redux Code</h2><h3 id="Structuring-Files-and-Folders"><a href="#Structuring-Files-and-Folders" class="headerlink" title="Structuring Files and Folders"></a>Structuring Files and Folders</h3><h3 id="Ducks-Pattern"><a href="#Ducks-Pattern" class="headerlink" title="Ducks Pattern"></a>Ducks Pattern</h3><h3 id="Redux-Toolkit"><a href="#Redux-Toolkit" class="headerlink" title="Redux Toolkit"></a>Redux Toolkit</h3><h3 id="Creating-the-Store"><a href="#Creating-the-Store" class="headerlink" title="Creating the Store"></a>Creating the Store</h3><h3 id="Creating-Actions"><a href="#Creating-Actions" class="headerlink" title="Creating Actions"></a>Creating Actions</h3><h3 id="Creating-Reducers"><a href="#Creating-Reducers" class="headerlink" title="Creating Reducers"></a>Creating Reducers</h3><h3 id="Creating-Slices"><a href="#Creating-Slices" class="headerlink" title="Creating Slices"></a>Creating Slices</h3><h3 id="Exercise"><a href="#Exercise" class="headerlink" title="Exercise"></a>Exercise</h3><h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h3><h2 id="Designing-the-Store"><a href="#Designing-the-Store" class="headerlink" title="Designing the Store"></a>Designing the Store</h2><h3 id="Redux-State-vs-Local-State"><a href="#Redux-State-vs-Local-State" class="headerlink" title="Redux State vs Local State"></a>Redux State vs Local State</h3><h3 id="Structuring-a-Redux-Store"><a href="#Structuring-a-Redux-Store" class="headerlink" title="Structuring a Redux Store"></a>Structuring a Redux Store</h3><h3 id="Combining-Reducers"><a href="#Combining-Reducers" class="headerlink" title="Combining Reducers"></a>Combining Reducers</h3><h3 id="Normalization"><a href="#Normalization" class="headerlink" title="Normalization"></a>Normalization</h3><h3 id="Selectors"><a href="#Selectors" class="headerlink" title="Selectors"></a>Selectors</h3><h3 id="Memoizing-Selectors-with-Reselect"><a href="#Memoizing-Selectors-with-Reselect" class="headerlink" title="Memoizing Selectors with Reselect"></a>Memoizing Selectors with Reselect</h3><h3 id="Exercise-1"><a href="#Exercise-1" class="headerlink" title="Exercise"></a>Exercise</h3><h3 id="Solution-1"><a href="#Solution-1" class="headerlink" title="Solution"></a>Solution</h3><h2 id="Middleware"><a href="#Middleware" class="headerlink" title="Middleware"></a>Middleware</h2><h3 id="What-is-Middleware"><a href="#What-is-Middleware" class="headerlink" title="What is Middleware"></a>What is Middleware</h3><h3 id="Creating-Middleware"><a href="#Creating-Middleware" class="headerlink" title="Creating Middleware"></a>Creating Middleware</h3><h3 id="Parameterizing-Middleware"><a href="#Parameterizing-Middleware" class="headerlink" title="Parameterizing Middleware"></a>Parameterizing Middleware</h3><h3 id="Dispatching-Functions"><a href="#Dispatching-Functions" class="headerlink" title="Dispatching Functions"></a>Dispatching Functions</h3><h3 id="Exercise-2"><a href="#Exercise-2" class="headerlink" title="Exercise"></a>Exercise</h3><h3 id="Solution-2"><a href="#Solution-2" class="headerlink" title="Solution"></a>Solution</h3><h3 id="A-Quick-Note"><a href="#A-Quick-Note" class="headerlink" title="A Quick Note"></a>A Quick Note</h3><h2 id="Consuming-APIs"><a href="#Consuming-APIs" class="headerlink" title="Consuming APIs"></a>Consuming APIs</h2><h3 id="Setting-Up-the-Backend"><a href="#Setting-Up-the-Backend" class="headerlink" title="Setting Up the Backend"></a>Setting Up the Backend</h3><h3 id="The-Approach"><a href="#The-Approach" class="headerlink" title="The Approach"></a>The Approach</h3><h3 id="API-Middleware"><a href="#API-Middleware" class="headerlink" title="API Middleware"></a>API Middleware</h3><h3 id="Actions"><a href="#Actions" class="headerlink" title="Actions"></a>Actions</h3><h3 id="Restructuring-the-Store"><a href="#Restructuring-the-Store" class="headerlink" title="Restructuring the Store"></a>Restructuring the Store</h3><h3 id="Getting-Data-from-the-Server"><a href="#Getting-Data-from-the-Server" class="headerlink" title="Getting Data from the Server"></a>Getting Data from the Server</h3><h3 id="Loading-Indicators"><a href="#Loading-Indicators" class="headerlink" title="Loading Indicators"></a>Loading Indicators</h3><h3 id="Caching"><a href="#Caching" class="headerlink" title="Caching"></a>Caching</h3><h3 id="Saving-Data-to-the-Server"><a href="#Saving-Data-to-the-Server" class="headerlink" title="Saving Data to the Server"></a>Saving Data to the Server</h3><h3 id="Exercise-3"><a href="#Exercise-3" class="headerlink" title="Exercise"></a>Exercise</h3><h3 id="Solution-Resolving-Bugs"><a href="#Solution-Resolving-Bugs" class="headerlink" title="Solution- Resolving Bugs"></a>Solution- Resolving Bugs</h3><h3 id="Solution-Assigning-a-Bug-to-a-User"><a href="#Solution-Assigning-a-Bug-to-a-User" class="headerlink" title="Solution- Assigning a Bug to a User"></a>Solution- Assigning a Bug to a User</h3><h3 id="Reducing-Coupling"><a href="#Reducing-Coupling" class="headerlink" title="Reducing Coupling"></a>Reducing Coupling</h3><h3 id="Cohesion"><a href="#Cohesion" class="headerlink" title="Cohesion"></a>Cohesion</h3><h2 id="Testing-Redux-Applications"><a href="#Testing-Redux-Applications" class="headerlink" title="Testing Redux Applications"></a>Testing Redux Applications</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><h3 id="What-is-Automated-Testing"><a href="#What-is-Automated-Testing" class="headerlink" title="What is Automated Testing"></a>What is Automated Testing</h3><h3 id="Setting-Up-the-Testing-Environment"><a href="#Setting-Up-the-Testing-Environment" class="headerlink" title="Setting Up the Testing Environment"></a>Setting Up the Testing Environment</h3><h3 id="Your-First-Unit-Test"><a href="#Your-First-Unit-Test" class="headerlink" title="Your First Unit Test"></a>Your First Unit Test</h3><h3 id="Unit-Testing-Redux-Applications"><a href="#Unit-Testing-Redux-Applications" class="headerlink" title="Unit Testing Redux Applications"></a>Unit Testing Redux Applications</h3><h3 id="Solitary-Tests"><a href="#Solitary-Tests" class="headerlink" title="Solitary Tests"></a>Solitary Tests</h3><h3 id="Social-Tests"><a href="#Social-Tests" class="headerlink" title="Social Tests"></a>Social Tests</h3><h3 id="Mocking-HTTP-Calls"><a href="#Mocking-HTTP-Calls" class="headerlink" title="Mocking HTTP Calls"></a>Mocking HTTP Calls</h3><h3 id="Writing-Clean-Tests"><a href="#Writing-Clean-Tests" class="headerlink" title="Writing Clean Tests"></a>Writing Clean Tests</h3><h3 id="Test-Coverage"><a href="#Test-Coverage" class="headerlink" title="Test Coverage"></a>Test Coverage</h3><h3 id="Exercises"><a href="#Exercises" class="headerlink" title="Exercises"></a>Exercises</h3><h3 id="Solution-getUnresolvedBugs"><a href="#Solution-getUnresolvedBugs" class="headerlink" title="Solution- getUnresolvedBugs"></a>Solution- getUnresolvedBugs</h3><h3 id="Solution-resolveBug"><a href="#Solution-resolveBug" class="headerlink" title="Solution- resolveBug"></a>Solution- resolveBug</h3><h3 id="Solution-loadingBugs"><a href="#Solution-loadingBugs" class="headerlink" title="Solution- loadingBugs"></a>Solution- loadingBugs</h3><h3 id="A-Quick-Note-1"><a href="#A-Quick-Note-1" class="headerlink" title="A Quick Note"></a>A Quick Note</h3>
          
        
      
    </div>
    
    
    
    <div>
      
    </div>
    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://jasonxqh.github.io/2020/06/08/Express%E6%A1%86%E6%9E%B6%E5%9C%A8%E5%90%8E%E7%AB%AF%E7%9A%84%E5%BA%94%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/%5Bobject%20Object%5D">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/08/Express%E6%A1%86%E6%9E%B6%E5%9C%A8%E5%90%8E%E7%AB%AF%E7%9A%84%E5%BA%94%E7%94%A8/" itemprop="url">Express框架在后端的应用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-08T20:26:47+08:00">
                2020-06-08
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2020-06-30T10:38:54+08:00">
                2020-06-30
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Express框架在后端的应用"><a href="#Express框架在后端的应用" class="headerlink" title="Express框架在后端的应用"></a>Express框架在后端的应用</h1><p>在写后端的时候，时常要用到我的学习博客</p>
<p>考虑到基础博客的篇幅普遍过长，所以为了阅读的体验，本文所有链接点击即可跳转至相应章节</p>
<p><a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础1/#more">Nodejs基础1</a></p>
<p><a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础2/#more"> Nodejs基础2</a></p>
<p><a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础3/#more">Nodejs基础3</a></p>
<p><a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础4/#more">Nodejs基础4</a></p>
<h2 id="根目录"><a href="#根目录" class="headerlink" title="根目录"></a>根目录</h2><h3 id="server-js"><a href="#server-js" class="headerlink" title="server.js"></a><code>server.js</code></h3><p>server.js是最重要的一个文件了，他就像一棵树的树根，文件从它开始衍生开来</p>
<p>在<a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础1/#Middleware">Nodejs基础1的Middleware章节</a>中，我详细讲了 expresss.json(),express.urlencoded(),express.static(),morgan.helmet这些中间件。所以他们的作用我在这里不细讲了</p>
<p>cors包是用来跨域的，这点在<a href="https://jasonxqh.github.io/2020/06/07/React框架在作业当中的应用/#more">React框架在作业当中的应用</a> 中的setupProxy.js有提到，</p>
<p>bodyParser是当请求体解析之后，解析值会被放到req.body属性中，当内容为空时候，为一个空对象{}，json()—解析JSON格式 <a href="https://www.jianshu.com/p/cd3de110b4b6" target="_blank" rel="noopener">Express中间件body-parser</a></p>
<p>然后是一个登陆操作，我为了连接方便而且多电脑端都可以使用，所以把数据都上载到了云数据库当中。通过将useNewUrlParser设置为true来避免“不建议使用当前URL字符串解析器”警告</p>
<p>再后来就是把所有的路由接口全部导入，然后把前缀全改为/api，为了在apiRoutes中可以省略/api</p>
<p>最后导入一个检查错误的中间件。用来检查非法的路由和登陆错误</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>); </span><br><span class="line"><span class="keyword">const</span> cors = <span class="built_in">require</span>(<span class="string">'cors'</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> server = express();</span><br><span class="line"> </span><br><span class="line">server.use(cors());</span><br><span class="line">server.use(express.json());</span><br><span class="line">server.use(express.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">server.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);</span><br><span class="line">server.use(bodyParser.json());</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> helmet = <span class="built_in">require</span>(<span class="string">'helmet'</span>);</span><br><span class="line">server.use(helmet());</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> logger = <span class="built_in">require</span>(<span class="string">"morgan"</span>);</span><br><span class="line"><span class="comment">//这是在终端打印日志。</span></span><br><span class="line">server.use(logger(<span class="string">"dev"</span>));</span><br><span class="line"><span class="comment">//这是把日志写入文件以供参阅。</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"><span class="keyword">var</span> accessLog = fs.createWriteStream(<span class="string">"./access.csv"</span>, &#123; <span class="attr">flags</span>: <span class="string">"a"</span> &#125;);</span><br><span class="line">server.use(logger(<span class="string">"combined"</span>, &#123; <span class="attr">stream</span>: accessLog &#125;));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; connectionStr &#125; = <span class="built_in">require</span>(<span class="string">'./config'</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">为了读取方便，且能多人使用。我已经把本地的数据全部移动到了云数据库</span></span><br><span class="line"><span class="comment">https://cloud.mongodb.com/</span></span><br><span class="line"><span class="comment">然后只要获取登录链接即可：</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// Connect to the Mongo database</span></span><br><span class="line">mongoose.Promise = global.Promise;</span><br><span class="line">mongoose.connect(connectionStr, &#123; <span class="attr">useNewUrlParser</span>: <span class="literal">true</span> &#125;, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'MongoDB Connect Success!'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set up the routes</span></span><br><span class="line"><span class="keyword">const</span> apiRoutes = <span class="built_in">require</span>(<span class="string">'./src/routes/api-routes'</span>);</span><br><span class="line"></span><br><span class="line">server.use(<span class="string">'/api'</span>, apiRoutes);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Handle errors</span></span><br><span class="line"><span class="keyword">const</span> errorHandlers = <span class="built_in">require</span>(<span class="string">'./src/middleware/error-handlers'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Catch all invalid routes</span></span><br><span class="line">server.use(errorHandlers.invalidRoute);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Handle mongoose errors</span></span><br><span class="line">server.use(errorHandlers.validationErrors);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Export the server object</span></span><br><span class="line"><span class="built_in">module</span>.exports = server;</span><br></pre></td></tr></table></figure>
<h3 id="记录日志始末"><a href="#记录日志始末" class="headerlink" title="记录日志始末"></a>记录日志始末</h3><h4 id="阶段1"><a href="#阶段1" class="headerlink" title="阶段1"></a>阶段1</h4><p>一开始，我才用了morgan来记录日志</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> logger = <span class="built_in">require</span>(<span class="string">"morgan"</span>);</span><br><span class="line"><span class="comment">//这是在终端打印日志。</span></span><br><span class="line">server.use(logger(<span class="string">"dev"</span>));</span><br></pre></td></tr></table></figure>
<p>但这样只是打在终端里，显然我们是不满足的</p>
<h4 id="阶段2"><a href="#阶段2" class="headerlink" title="阶段2"></a>阶段2</h4><p>然后，我们向把日志记录在.csv 文件中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"><span class="keyword">var</span> accessLog = fs.createWriteStream(<span class="string">"./access.csv"</span>, &#123; <span class="attr">flags</span>: <span class="string">"a"</span> &#125;);</span><br><span class="line">server.use(logger(<span class="string">"combined"</span>, &#123; <span class="attr">stream</span>: accessLog &#125;));</span><br></pre></td></tr></table></figure>
<p>启动服务后，我们看到在根目录下的access.csv文件中记录下了日志</p>
<p><img src="/2020/06/08/Express%E6%A1%86%E6%9E%B6%E5%9C%A8%E5%90%8E%E7%AB%AF%E7%9A%84%E5%BA%94%E7%94%A8/1.png" style="zoom: 50%;"></p>
<p>这里我先导入到csv文件当中，然后再利用DataGrip定期导入这个access.csv文件来达到数据库存储的一个效果。（虽然这么做不是很正规。。。）</p>
<p><img src="/2020/06/08/Express%E6%A1%86%E6%9E%B6%E5%9C%A8%E5%90%8E%E7%AB%AF%E7%9A%84%E5%BA%94%E7%94%A8/2.png" style="zoom: 55%;"></p>
<h4 id="阶段3"><a href="#阶段3" class="headerlink" title="阶段3"></a>阶段3</h4><p>再然后，我们利用morgan把日志记录在 mongodb当中。</p>
<p>首先我们在models文件夹下新建log.js</p>
<p>为了方便起见，我就不掐头去尾了。直接记录整条日志</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// models/log.js</span></span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">"mongoose"</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; Schema, model &#125; = mongoose;</span><br><span class="line"><span class="keyword">let</span> Log = <span class="keyword">new</span> Schema(&#123;</span><br><span class="line">  line: &#123;</span><br><span class="line">    type: <span class="built_in">String</span>,</span><br><span class="line">    <span class="keyword">default</span>: <span class="string">""</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">module</span>.exports = mongoose.model(<span class="string">"Log"</span>, Log);</span><br></pre></td></tr></table></figure>
<p>然后我们在sever.js中引入</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> logger = <span class="built_in">require</span>(<span class="string">"morgan"</span>);</span><br><span class="line"><span class="keyword">const</span> Log = <span class="built_in">require</span>(<span class="string">'./../server/src/models/log'</span>)</span><br><span class="line"><span class="keyword">var</span> writeToDB = &#123;</span><br><span class="line">  write: <span class="function"><span class="keyword">function</span> (<span class="params">line</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ele = <span class="keyword">new</span> Log(&#123;</span><br><span class="line">       line: line</span><br><span class="line">    &#125;)</span><br><span class="line">    ele.save(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'err'</span>, err)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">server.use(logger(<span class="string">"combined"</span>, &#123;<span class="attr">stream</span>: writeToDB&#125;))</span><br></pre></td></tr></table></figure>
<p>这样，我们就在mongodb中记录下了日志了.</p>
<p><img src="/2020/06/08/Express%E6%A1%86%E6%9E%B6%E5%9C%A8%E5%90%8E%E7%AB%AF%E7%9A%84%E5%BA%94%E7%94%A8/3.png" style="zoom: 55%;"></p>
<h4 id="阶段4"><a href="#阶段4" class="headerlink" title="阶段4"></a>阶段4</h4><p>最后，学习了助教的代码之后，我们可以把这些日志记录在mysql当中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> logger = <span class="built_in">require</span>(<span class="string">"morgan"</span>);</span><br><span class="line"><span class="keyword">const</span> logDAO = <span class="built_in">require</span>(<span class="string">'./../server/src/models/logDAO'</span>)</span><br><span class="line"><span class="keyword">let</span> method = <span class="string">''</span>;</span><br><span class="line">server.use(logger(<span class="function"><span class="keyword">function</span> (<span class="params">tokens, req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> request_time = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">  <span class="keyword">var</span> request_method = tokens.method(req, res);</span><br><span class="line">  <span class="keyword">var</span> request_url = tokens.url(req, res);</span><br><span class="line">  <span class="keyword">var</span> status = tokens.status(req, res);</span><br><span class="line">  <span class="keyword">var</span> remote_addr = tokens[<span class="string">'remote-addr'</span>](req, res);</span><br><span class="line">  logDAO.userlog([request_time,request_method,request_url,status,remote_addr], <span class="function"><span class="keyword">function</span> (<span class="params">success</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'成功保存！'</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>
<p><code>logDao.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用于存放用户操作记录  日志</span></span><br><span class="line"><span class="comment">//该文件没有用，最后选择使用express中间件 morgan记录日志（app.js中）</span></span><br><span class="line"><span class="keyword">var</span> mysql = <span class="built_in">require</span>(<span class="string">'mysql'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> mysqlConf = &#123;</span><br><span class="line">    mysql: &#123;</span><br><span class="line">        host: <span class="string">'localhost'</span>,</span><br><span class="line">        user: <span class="string">'root'</span>,</span><br><span class="line">        password: <span class="string">'root'</span>,</span><br><span class="line">        database:<span class="string">'crawl'</span>,</span><br><span class="line">        <span class="comment">// 最大连接数，默认为10</span></span><br><span class="line">        connectionLimit: <span class="number">10</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> pool = mysql.createPool(mysqlConf.mysql);</span><br><span class="line"><span class="comment">// 使用了连接池，重复使用数据库连接，而不必每执行一次CRUD操作就获取、释放一次数据库连接，从而提高了对数据库操作的性能。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录用户操作</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    userlog :<span class="function"><span class="keyword">function</span> (<span class="params">useraction, callback</span>) </span>&#123;</span><br><span class="line">        pool.query(<span class="string">'insert into user_action(request_time,request_method,request_url,status,remote_addr) values(?,?,?,?,?)'</span>,</span><br><span class="line">            useraction, <span class="function"><span class="keyword">function</span> (<span class="params">error, result</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (error) <span class="keyword">throw</span> error;</span><br><span class="line">            callback(result.affectedRows &gt; <span class="number">0</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/08/Express%E6%A1%86%E6%9E%B6%E5%9C%A8%E5%90%8E%E7%AB%AF%E7%9A%84%E5%BA%94%E7%94%A8/4.png"></p>
<p>POST 是新建operas操作</p>
<h3 id="config-js"><a href="#config-js" class="headerlink" title="config.js"></a><code>config.js</code></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  scrects: <span class="string">'test1234'</span>,</span><br><span class="line">  connectionStr:</span><br><span class="line">    <span class="string">'mongodb+srv://test1:1qaz!QAZ@cluster0-2ysvp.mongodb.net/test?retryWrites=true&amp;w=majority'</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="routes目录"><a href="#routes目录" class="headerlink" title="routes目录"></a>routes目录</h2><h3 id="api-routes-js"><a href="#api-routes-js" class="headerlink" title="api-routes.js"></a><code>api-routes.js</code></h3><p>api-routes是所有的路由的集合，这里省区了/api/users前面的/api，因为在server.js中已经写了前缀/api</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> userRoutes = <span class="built_in">require</span>(<span class="string">'./user-routers'</span>);</span><br><span class="line"><span class="keyword">const</span> maoyanRoutes = <span class="built_in">require</span>(<span class="string">'./maoyan'</span>);</span><br><span class="line"><span class="keyword">const</span> doubanRoutes = <span class="built_in">require</span>(<span class="string">'./douban'</span>);</span><br><span class="line"><span class="keyword">const</span> operasRoutes = <span class="built_in">require</span>(<span class="string">'./operas'</span>);</span><br><span class="line"><span class="keyword">const</span> taobaoRoutes = <span class="built_in">require</span>(<span class="string">'./taobao'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"></span><br><span class="line">router.use(<span class="string">'/users'</span>, userRoutes);</span><br><span class="line">router.use(<span class="string">'/maoyan'</span>, maoyanRoutes);</span><br><span class="line">router.use(<span class="string">'/douban'</span>, doubanRoutes);</span><br><span class="line">router.use(<span class="string">'/operas'</span>, operasRoutes);</span><br><span class="line">router.use(<span class="string">'/taobao'</span>, taobaoRoutes);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<p>下面介绍user-router和以豆瓣为代表的douban.js，这个几个文件的作用主要是定义api接口，然后通过api-routes来集成</p>
<h3 id="user-router-js"><a href="#user-router-js" class="headerlink" title="user-router.js"></a><code>user-router.js</code></h3><p>user-router主要解决的是用户的登录和注册，管理员的删除用户操作。为了让文件的层次解构鲜明，具体的操作在controller中实现，这里只是解构了controller中的函数并引用。</p>
<p> 具体的api功能我在controller会详细解释</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"><span class="keyword">const</span> &#123; catchErrors &#125; = <span class="built_in">require</span>(<span class="string">'../middleware/error-handlers'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; authAdmin &#125; = <span class="built_in">require</span>(<span class="string">'../middleware/auth-handlers'</span>);</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">'express-jwt'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; scrects &#125; = <span class="built_in">require</span>(<span class="string">'../../config'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; register, login, findAll, getInfo, <span class="attr">delete</span>: del &#125; = <span class="built_in">require</span>(<span class="string">'../controllers/user'</span>);</span><br><span class="line"><span class="keyword">const</span> auth = jwt(&#123; <span class="attr">secret</span>: scrects &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// user api</span></span><br><span class="line">router.post(<span class="string">'/login'</span>, login); <span class="comment">// api/users/login</span></span><br><span class="line">router.post(<span class="string">'/register'</span>, catchErrors(register)); <span class="comment">//api/users/register</span></span><br><span class="line">router.get(<span class="string">'/info'</span>, auth, getInfo); <span class="comment">// api/users/info</span></span><br><span class="line"><span class="comment">// admin api</span></span><br><span class="line">router.get(<span class="string">'/list'</span>, auth, authAdmin, findAll); <span class="comment">//api/users/list</span></span><br><span class="line">router.post(<span class="string">'/:id/delete'</span>, auth, authAdmin, del);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<h3 id="douban-js"><a href="#douban-js" class="headerlink" title="douban.js"></a><code>douban.js</code></h3><p> 具体的api功能我在controller会详细解释</p>
<p>首先我们从controller中解构我们需要的函数，然后再路由触发的时候调用这些函数</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"><span class="keyword">const</span> &#123; findAll, insertMany, <span class="attr">delete</span>: del, getListByKey, getListByOr &#125; = <span class="built_in">require</span>(<span class="string">'../controllers/douban'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一次性插入多条数据，为了使用postMan插入多条数据</span></span><br><span class="line">router.post(<span class="string">'/add'</span>, insertMany);</span><br><span class="line">router.post(<span class="string">'/delete/:id'</span>, del);</span><br><span class="line">router.get(<span class="string">'/list'</span>, findAll);</span><br><span class="line">router.get(<span class="string">'/getlist'</span>, getListByKey)</span><br><span class="line">router.get(<span class="string">'/getListOr'</span>, getListByOr)</span><br><span class="line">router.get(<span class="string">'/getAll'</span>, getAll)</span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<h2 id="models目录"><a href="#models目录" class="headerlink" title="models目录"></a>models目录</h2><h3 id="schema"><a href="#schema" class="headerlink" title="schema"></a><code>schema</code></h3><p>就是表格，利用mongoose创建一张表格来存放从数据库中获得的信息。所以这里的表格要和数据库中的表格一样</p>
<h3 id="imestamps-true"><a href="#imestamps-true" class="headerlink" title="imestamps:true"></a><code>imestamps:true</code></h3><p><strong>timestamps</strong>选项会在创建文档时自动生成<strong>createAt</strong>和<strong>updateAt</strong>两个字段，值都为系统当前时间。并且在更新文档时自动更新<strong>updateAt</strong>字段的值为系统当前时间 .ture代表了使用默认的字段名</p>
<p>在Mongoose中，定义数据库model schemas时使用<strong>timestamps</strong>选项可以给我们带来许多便利。在创建文档时不用在代码中去指定<strong>createTime</strong>字段的值，在更新文档时也不用去修改<strong>updateTime</strong>字段的值。</p>
<p>参考<a href="https://mongoosejs.com/docs/guide.html#timestamps" target="_blank" rel="noopener">Mongoose文档</a></p>
<h3 id="Model"><a href="#Model" class="headerlink" title="Model"></a><code>Model</code></h3><p>是由Schema编译而成的假想（fancy）构造器，具有抽象属性和行为。Model的每一个实例（instance）就是一个document。document可以保存到数据库和对数据库进行操作。<br>也就是说，model是用来选择集合的。</p>
<p>也就是说，我在云端有一张数据表叫Users，我想把里面的数据申请到本地。所以我们在本地需要建一张一模一样的表格来用以存放。但是我在这张表格中所做的增删改查，都会在数据库中同步。这就是model的用法。</p>
<h3 id="user-js"><a href="#user-js" class="headerlink" title="user.js"></a><code>user.js</code></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; Schema, model &#125; = mongoose;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> usersSchema = <span class="keyword">new</span> Schema(</span><br><span class="line">  &#123;</span><br><span class="line">    __v: &#123; <span class="attr">type</span>: <span class="built_in">Number</span>, <span class="attr">select</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">    name: &#123; <span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    password: &#123; <span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">select</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">    auth: &#123; <span class="attr">type</span>: <span class="built_in">Number</span>, <span class="attr">required</span>: <span class="literal">false</span>, <span class="attr">default</span>: <span class="number">0</span> &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">timestamps</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = model(<span class="string">'Users'</span>, usersSchema);</span><br></pre></td></tr></table></figure>
<h3 id="douban-js-1"><a href="#douban-js-1" class="headerlink" title="douban.js"></a><code>douban.js</code></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; Schema, model &#125; = mongoose;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> doubantop250Schema = <span class="keyword">new</span> Schema(</span><br><span class="line">  &#123;</span><br><span class="line">    __v: &#123; <span class="attr">type</span>: <span class="built_in">Number</span>, <span class="attr">select</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">    actor: &#123; <span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    director: &#123; <span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">required</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">    other_title: &#123; <span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">required</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">    country: &#123; <span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">required</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">    sort: &#123; <span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">required</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">    quote: &#123; <span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">required</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">    image: &#123; <span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    index: &#123; <span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    score: &#123; <span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    time: &#123; <span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    title: &#123; <span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">timestamps</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = model(<span class="string">'doubantop250'</span>, doubantop250Schema);</span><br></pre></td></tr></table></figure>
<h2 id="controller目录"><a href="#controller目录" class="headerlink" title="controller目录"></a>controller目录</h2><p>想了解基本的CRUD操作 可以看我的博客 <a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础2/#CRUD-Operations-Using-Mongoose">Nodejs基础2中的CRUD Operations Using Mongoose</a></p>
<p>里面详细介绍了增删改查的各种model. 方法</p>
<h3 id="user-js-1"><a href="#user-js-1" class="headerlink" title="user.js"></a><code>user.js</code></h3><p>我从model/user中导入了这张在数据库中的User表格。现在我们就可以对他进行我需要的后端操作了。</p>
<h4 id="login"><a href="#login" class="headerlink" title="login"></a><code>login</code></h4><p>首先是登录。前端会发一个request过来，我把里面的req.body当作我的target到User表格中去寻找，然后把结果赋值给user.如果user不存在，说明表格中不存在这一号人物，那当然返回一条name or password incorrect的json格式的信息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jsonwebtoken = <span class="built_in">require</span>(<span class="string">'jsonwebtoken'</span>);</span><br><span class="line"><span class="keyword">const</span> User = <span class="built_in">require</span>(<span class="string">'../models/user'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; scrects &#125; = <span class="built_in">require</span>(<span class="string">'../../config'</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersCtl</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 登录</span></span><br><span class="line">  <span class="keyword">async</span> login(req, res) &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> User.findOne(req.body);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      res.status(<span class="number">404</span>).json(&#123; <span class="attr">msg</span>: <span class="string">'name or password incorrect'</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> &#123; _id, name &#125; = user;</span><br><span class="line">    <span class="keyword">const</span> token = jsonwebtoken.sign(&#123; _id, name &#125;, scrects, &#123; <span class="attr">expiresIn</span>: <span class="string">'1d'</span> &#125;);</span><br><span class="line">    res.status(<span class="number">201</span>).json(&#123; token, name &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="register"><a href="#register" class="headerlink" title="register"></a><code>register</code></h4><p>注册函数，就是我们从前端发来的<code>req.body</code>解构出name，然后我们查询一下User表格中是否存在这个人，如果存在，那么就返回一条<code>json</code>格式的user already exist。如果名字是<code>admin</code>的话，我们就向这个人的信息中添加auth=1 来证明他是管理员。其余的，我们就利用<code>model.create</code>方法来创建这条记录，然后返回一个user的信息</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册</span></span><br><span class="line"> <span class="keyword">async</span> register(req, res) &#123;</span><br><span class="line">   <span class="keyword">const</span> &#123; name &#125; = req.body;</span><br><span class="line">   <span class="keyword">const</span> repeatedUser = <span class="keyword">await</span> User.findOne(&#123; name &#125;);</span><br><span class="line">   <span class="keyword">if</span> (repeatedUser) &#123;</span><br><span class="line">     <span class="keyword">return</span> res.status(<span class="number">409</span>).json(&#123; <span class="attr">mas</span>: <span class="string">'user already exist'</span> &#125;);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (name === <span class="string">'admin'</span>) &#123; </span><br><span class="line">     req.body.auth = <span class="number">1</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">const</span> user = <span class="keyword">await</span> User.create(req.body);</span><br><span class="line">   res.status(<span class="number">201</span>).json(&#123; <span class="attr">data</span>: user &#125;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h4 id="getInfo"><a href="#getInfo" class="headerlink" title="getInfo"></a><code>getInfo</code></h4><p>获取user的信息。返回一条<code>json</code>格式的信息</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> getInfo(req, res) &#123;</span><br><span class="line">    res.status(<span class="number">201</span>).json(&#123; <span class="attr">data</span>: req.user &#125;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h4 id="findAll"><a href="#findAll" class="headerlink" title="findAll"></a><code>findAll</code></h4><p>把所有的user信息全部找到然后全部以<code>json</code>格式返回</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> findAll(req, res) &#123;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> User.find();</span><br><span class="line">  <span class="built_in">console</span>.log(data)</span><br><span class="line">  res.status(<span class="number">201</span>).json(&#123; data &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="delete"><a href="#delete" class="headerlink" title="delete"></a><code>delete</code></h4><p>删除操作，也就是管理员才能执行的删除用户的信息。</p>
<p>利用<code>model.findByIdAndRemove</code>方法来找到前端发来的request中的参数中的id信息，然后删除它并把删除的信息返回给一个result。再利用<code>json</code>的形式把result 映射data后传回</p>
<p> <a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础2/#Removing-Documents">Nodejs基础2 Removing Documents</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">delete</span>(req, res) &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> User.findByIdAndRemove(req.params.id);</span><br><span class="line">    res.status(<span class="number">201</span>).json(&#123; <span class="attr">data</span>: result &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="keyword">new</span> UsersCtl();</span><br></pre></td></tr></table></figure>
<h3 id="douban-js-2"><a href="#douban-js-2" class="headerlink" title="douban.js"></a><code>douban.js</code></h3><p>我从model/douban中导入了这张在数据库中的DouBan表格。现在我们就可以对他进行我需要的后端操作了。</p>
<h4 id="getAll"><a href="#getAll" class="headerlink" title="getAll"></a><code>getAll</code></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> getAll(req, res) &#123;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> DouBan.find();</span><br><span class="line">  res.status(<span class="number">201</span>).json(&#123; data &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="findAll-1"><a href="#findAll-1" class="headerlink" title="findAll"></a><code>findAll</code></h4><p>这是前端显示数据是会用到的一个api</p>
<p>首先我们从request中解析出传过来的per_page也就是每页显示的电影条数，和排序的种类（升序or降序or不排序）</p>
<p>如果不排序，那么请求中sort = undefined,那么我们就不进行.sort</p>
<p>否则，我们就进行排序， 1代表升序，-1代表降序</p>
<p><strong>（小插曲）：</strong>在爬取数据的时候，数字也是按照string类型存储的，导致我一开始都在做字符串排序，1111111是小于9 的，这就很烦。然后我通过了robo 3T对mongodb进行批量修改</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">'表格名字'</span>).find(&#123;<span class="string">'类型为string的字段'</span> : &#123; <span class="attr">$type</span> : <span class="number">2</span> &#125;&#125;).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">    x.类型为string的字段 = NumberInt(x.类型为string的字段);<span class="comment">//转换为整型</span></span><br><span class="line">    db.getCollection(<span class="string">'表格名字'</span>).save(x);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">'表格名字'</span>).find(&#123;<span class="string">'类型为string的字段'</span> : &#123; <span class="attr">$type</span> : <span class="number">2</span> &#125;&#125;).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">    x.类型为string的字段 = ParseInt(x.类型为string的字段);<span class="comment">//转换为小数</span></span><br><span class="line">    db.getCollection(<span class="string">'表格名字'</span>).save(x);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这样我们就完成了类型转换，从而可以对数字进行排序。</p>
<p>其次我们来计算per_page的多少，也就是至少为1条</p>
<p>然后我们计算表内总共的数据到底有几条并返回，这个在前端的<strong>分页器</strong>中需要用到，因为分页器得有总条数才能计算页数</p>
<p>最后我们在表中得到当前页面的信息，需要调过前面page*perpage条信息，然后取perpage条返回</p>
<p><a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础2/#Pagination">Nodejs基础2Pagination</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jsonwebtoken = <span class="built_in">require</span>(<span class="string">'jsonwebtoken'</span>);</span><br><span class="line"><span class="keyword">const</span> DouBan = <span class="built_in">require</span>(<span class="string">'../models/douban'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; scrects &#125; = <span class="built_in">require</span>(<span class="string">'../../config'</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DouBanCtl</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> findAll(req, res) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; per_page = <span class="number">10</span> &#125; = req.query;</span><br><span class="line">    <span class="keyword">const</span> page = <span class="built_in">Math</span>.max(req.query.page * <span class="number">1</span>, <span class="number">1</span>) - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> perPage = <span class="built_in">Math</span>.max(per_page * <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">const</span> sort = req.query.sort;</span><br><span class="line">    <span class="built_in">console</span>.log(sort);</span><br><span class="line">    <span class="keyword">const</span> total = <span class="keyword">await</span> DouBan.countDocuments();</span><br><span class="line">    <span class="keyword">if</span> (sort === <span class="string">"undefined"</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> data = <span class="keyword">await</span> DouBan.find()</span><br><span class="line">        .limit(perPage)</span><br><span class="line">        .skip(page * perPage);</span><br><span class="line">      res.status(<span class="number">201</span>).json(&#123; data, total &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> data = <span class="keyword">await</span> DouBan.find()</span><br><span class="line">        .sort(&#123; <span class="attr">score</span>: sort === <span class="string">"reverse"</span> ? <span class="number">1</span> : <span class="number">-1</span> &#125;)</span><br><span class="line">        .limit(perPage)</span><br><span class="line">        .skip(page * perPage);</span><br><span class="line">      res.status(<span class="number">201</span>).json(&#123; data, total &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="insertMany"><a href="#insertMany" class="headerlink" title="insertMany"></a><code>insertMany</code></h4><p>这是插入操作，是为了利用postman向云数据库插入信息，在前端并没有用到。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> insertMany(req, res) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; data &#125; = req.body;</span><br><span class="line">    <span class="keyword">await</span> DouBan.insertMany(data);</span><br><span class="line">    res.status(<span class="number">201</span>).json(&#123; <span class="attr">data</span>: <span class="string">'success'</span> &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="getListByKey"><a href="#getListByKey" class="headerlink" title="getListByKey"></a><code>getListByKey</code></h4><p>这是前端布尔查询中的 AND 查询，在这篇博客中<a href="https://jasonxqh.github.io/2020/06/07/React框架在作业当中的应用/">React框架在作业当中的应用</a>我已经介绍了我们把数据返回之后前端进行的渲染操作，现在我们来讲讲从前端发来请求后如何在后端获得我想要的信息。</p>
<p>在<a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础2/#Regular-Expressions">Nodejs基础2Regular Expressions</a>中我初步讲了正则表达式的使用方法。</p>
<p>首先来看看请求是什么   </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Api.get(<span class="string">`/douban/getList?<span class="subst">$&#123;keyWords&#125;</span>`</span>,&#123;...&#125;);</span><br></pre></td></tr></table></figure>
<p><code>Object.keys()</code>  方法会返回一个由一个给定对象的自身<strong>可枚举属性</strong>组成的数组，数组中属性名的排列顺序和正常循环遍历该对象时返回的顺序一致 。</p>
<p><strong>$regex  </strong> 为模糊查询的字符串提供正则表达式功能</p>
<p>首先我们建立一个params对象，这个对象中将存放寻找的条件。</p>
<p> 然后我们利用forEach循环，对req.query里面，也就是前端传回来的条件(2个条件)进行操作</p>
<p>eval() 函数可计算某个字符串，并执行其中的的 JavaScript 代码。</p>
<p> ${表达式du}用来输出或者计算一个表达式的内容值</p>
<p>比如 ${3+5}，那么便会在页面上输出8</p>
<p> 比如前端传来的是  <code>电影名字：的 AND 评分：7</code></p>
<p>这时候item就是这个query的可枚举属性，也就是电影名字和评分</p>
<p>所及操作好以后结果如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">params = &#123;</span><br><span class="line">	&#123;电影名字 : <span class="regexp">/的/ig</span> &#125;,</span><br><span class="line">	&#123;评分: <span class="regexp">/7/ig</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后用params作为查找条件到豆瓣这张表里去查</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> getListByKey(req, res) &#123;</span><br><span class="line">   <span class="keyword">const</span> params = &#123;&#125;;</span><br><span class="line">   <span class="built_in">Object</span>.keys(req.query).forEach(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">     params[item] = &#123; <span class="attr">$regex</span>: <span class="built_in">eval</span>(<span class="string">`/<span class="subst">$&#123;req.query[item]&#125;</span>/ig`</span>) &#125;;</span><br><span class="line">   &#125;);</span><br><span class="line">   <span class="built_in">console</span>.log(params);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">const</span> data = <span class="keyword">await</span> DouBan.find(params);</span><br><span class="line">   res.status(<span class="number">201</span>).json(&#123; data &#125;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h4 id="getListByOr"><a href="#getListByOr" class="headerlink" title="getListByOr"></a><code>getListByOr</code></h4><p>这是前端布尔查询中的 OR 查询，</p>
<p>在<a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础2/#Logical-Query-Operators">Nodejs基础2Logical Query Operators</a>中我已经讲了or操作的符是要传入一个对象数组的。所以这里我做的工作就是把上面已经求好的<code>params</code>转换成一个对象数组。</p>
<p>同样还是用到了<code>Object.keys</code>方法，我们把<code>params</code>对象转换成<code>params2</code>对象数组</p>
<p>最后就把这个传入到 $or 键值对后面即可</p>
<p>也可以 <code>DouBan.or(params2);</code></p>
<p>这样我们返回的数据就是择一满足的了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">params2=[</span><br><span class="line">	&#123;电影名字 : <span class="regexp">/的/ig</span> &#125;,</span><br><span class="line">	&#123;评分: <span class="regexp">/7/ig</span>&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">async</span> getListByOr(req, res) &#123;</span><br><span class="line">    <span class="keyword">const</span> params = &#123;&#125;;</span><br><span class="line">    <span class="built_in">Object</span>.keys(req.query).forEach(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">      params[item] = &#123; <span class="attr">$regex</span>: <span class="built_in">eval</span>(<span class="string">`/<span class="subst">$&#123;req.query[item]&#125;</span>/ig`</span>) &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> params2 = [];</span><br><span class="line">    <span class="built_in">Object</span>.keys(params).forEach(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line">      obj[item] = params[item];</span><br><span class="line">      params2.push(obj);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(params, params2);</span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> DouBan.find(&#123; <span class="attr">$or</span>: params2 &#125;);</span><br><span class="line">    res.status(<span class="number">201</span>).json(&#123; data &#125;);	</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="keyword">new</span> DouBanCtl();</span><br></pre></td></tr></table></figure>
<h3 id="operas-js"><a href="#operas-js" class="headerlink" title="operas.js"></a><code>operas.js</code></h3><p>因为已经完成基本操作了，现在我们就拓展一下内容，做一个新建operas 的操作（其实也hin简单）</p>
<p>前端实现请看 ，这里讲一下后端收到前端发来的表单请求该怎么把这条新建的信息插入到mongodb当中去？</p>
<p>我们知道所有的信息都藏在 req.body当中，那么我们只要用 . 把他们都提取出来，然后新建一个Operas对象即可</p>
<p>最后通过opera.save()来实现保存操作</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> create(req, res) &#123;</span><br><span class="line">   <span class="keyword">const</span> opera = <span class="keyword">new</span> Operas(&#123;</span><br><span class="line">       title: req.body.title,</span><br><span class="line">       actors: req.body.actors,</span><br><span class="line">       country: req.body.country,</span><br><span class="line">       type: req.body.type,</span><br><span class="line">       single: req.body.single,</span><br><span class="line">       first_date: req.body.first_date</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">const</span> result = <span class="keyword">await</span> opera.save();</span><br><span class="line">   <span class="built_in">console</span>.log(result)</span><br><span class="line">   res.status(<span class="number">201</span>).json(&#123; result &#125;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="middleware目录"><a href="#middleware目录" class="headerlink" title="middleware目录"></a><code>middleware</code>目录</h2><h3 id="auth-handlers"><a href="#auth-handlers" class="headerlink" title="auth-handlers"></a><code>auth-handlers</code></h3><p>这是用来认证的一个中间件，中间件的写法我在 <a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础1/#Middleware">Nodejs基础1的Middleware章节</a> 中详细说了，这里简单讲一下他的逻辑</p>
<p>就是判断请求体重user的名字是不是admin，如果是的话，什么也不做，把控制权交给下一个中间件或者函数</p>
<p>如果不是的话，那就返回一个状态码500</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> User = <span class="built_in">require</span>(<span class="string">'../models/user'</span>);</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">'jsonwebtoken'</span>);</span><br><span class="line"><span class="keyword">var</span> config = <span class="built_in">require</span>(<span class="string">'../../config'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">authAdmin</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(req.user.name !== <span class="string">'admin'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.status(<span class="number">500</span>).send(<span class="string">'no authority '</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  next()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  authAdmin,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="error-handlers"><a href="#error-handlers" class="headerlink" title="error-handlers"></a><code>error-handlers</code></h3><p>这是一个开源的检查错误的文档。里面集成了一些中间件</p>
<p><a href="https://github.com/wesbos/Learn-Node/blob/master/stepped-solutions/45%20-%20Finished%20App/handlers/errorHandlers.js" target="_blank" rel="noopener">https://github.com/wesbos/Learn-Node/blob/master/stepped-solutions/45%20-%20Finished%20App/handlers/errorHandlers.js</a></p>
<p>我们主要用它来检查 异步操作的问题，验证路由，和用户验证的问题</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  With async/await, you need some way to catch errors</span></span><br><span class="line"><span class="comment">  Instead of using try&#123;&#125; catch(e) &#123;&#125; in each controller, we wrap the function in</span></span><br><span class="line"><span class="comment">  catchErrors(), catch and errors they throw, and pass it along to our express </span></span><br><span class="line"><span class="comment">  middleware with next()</span></span><br><span class="line"><span class="comment"> * Handler to catch `async` operation errors.</span></span><br><span class="line"><span class="comment"> * Reduces having to write `try-catch` all the time.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">exports.catchErrors = <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    action(req, res).catch(next)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Handle any invalid routes.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">exports.invalidRoute = <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> err = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Invalid route: '</span> + req.method + <span class="string">':'</span> + req.route)</span><br><span class="line">  err.status = <span class="number">404</span></span><br><span class="line">  next(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Validation error handler for Mongo.</span></span><br><span class="line"><span class="comment"> * The client app should handle displaying the errors.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">exports.validationErrors = <span class="function">(<span class="params">err, req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// catch unique field error</span></span><br><span class="line">  <span class="keyword">if</span> (err.code &amp;&amp; err.code === <span class="number">11000</span>) &#123;</span><br><span class="line">    err.status = <span class="number">400</span></span><br><span class="line">    err.message = err.errmsg</span><br><span class="line">    <span class="keyword">return</span> next(err)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!err.errors) &#123;</span><br><span class="line">    <span class="keyword">return</span> next(err)</span><br><span class="line">  &#125;</span><br><span class="line">  res.status(<span class="number">400</span>).json(&#123;</span><br><span class="line">    status: <span class="number">400</span>,</span><br><span class="line">    error: err.errors,</span><br><span class="line">    data: &#123;&#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    
    <div>
      
    </div>
    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://jasonxqh.github.io/2020/06/08/%E6%B5%85%E8%B0%88redux1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/%5Bobject%20Object%5D">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/08/%E6%B5%85%E8%B0%88redux1/" itemprop="url">浅谈redux1</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-08T00:08:29+08:00">
                2020-06-08
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2020-06-10T00:18:22+08:00">
                2020-06-10
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="浅谈redux1"><a href="#浅谈redux1" class="headerlink" title="浅谈redux1"></a>浅谈redux1</h1><p>学习自阮一峰的博客</p>
<p><a href="http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_one_basic_usages.html" target="_blank" rel="noopener">阮一峰的技术博客1</a> </p>
<p><a href="http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_two_async_operations.html" target="_blank" rel="noopener">阮一峰的技术博客2</a></p>
<p><a href="http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_three_react-redux.html" target="_blank" rel="noopener">阮一峰的技术博客3</a></p>
<p>和<a href="https://www.bilibili.com/video/BV1K7411U7P5" target="_blank" rel="noopener">b站Mosh教程</a></p>
<h2 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h2><h3 id="What-is-Redux"><a href="#What-is-Redux" class="headerlink" title="What is Redux"></a>What is Redux</h3><p>Redu是JavaScript应用程序的状态管理库.我们可以在React,Angular,Vue甚至原生JS中都能用</p>
<p><img src="/2020/06/08/%E6%B5%85%E8%B0%88redux1/1.png" style="zoom: 50%;"></p>
<p>为什么需要Redux？ 如果我们曾经建立了一个带有复杂的用户界面的应用程序。我们需要保持不同部分UI显示上的同步。如果我们通过普通的数据流的方式，需要用很多代码，很复杂的逻辑，甚至进入一个死循环。所以我们需要一个状态管理库。</p>
<p>与其读取不同UI组件的状态变量，不如把他们都放到一个地方（store)</p>
<p>使用了这种架构，不同的ui将不再保存自己的状态，相反他们从仓库中得到状态信息。如果有必要更新某个数据，我们就从Store中去拿。这样能立刻解决不同UI的数据共享问题</p>
<p>Redux页很容易让我们理解应用程序的数据变化</p>
<p><img src="/2020/06/08/%E6%B5%85%E8%B0%88redux1/2.png" style="zoom: 50%;"></p>
<h3 id="Pros-and-Cons-of-Redux"><a href="#Pros-and-Cons-of-Redux" class="headerlink" title="Pros and Cons of Redux"></a>Pros and Cons of Redux</h3><p>这里有一个购物车式的软件。如果我们商品的数量增加了，那么Price也会随之增加，总计也会随之增加</p>
<p><img src="/2020/06/08/%E6%B5%85%E8%B0%88redux1/3.png" style="zoom: 50%;"></p>
<p>这是因为我们有一个单一的仓库，保存应用程序的所有状态</p>
<p><img src="/2020/06/08/%E6%B5%85%E8%B0%88redux1/4.png" style="zoom: 45%;"></p>
<p> Redux的优缺点</p>
<p><img src="/2020/06/08/%E6%B5%85%E8%B0%88redux1/5.png" style="zoom: 45%;"></p>
<h3 id="Is-Redux-for-You"><a href="#Is-Redux-for-You" class="headerlink" title="Is Redux for You"></a>Is Redux for You</h3><p><img src="/2020/06/08/%E6%B5%85%E8%B0%88redux1/6.png" style="zoom: 45%;"></p>
<p>webpack文件</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="comment">//Webpack会从这个文件开始，然后搜索出所有的js文件，把他们合并成app.js</span></span><br><span class="line">    <span class="comment">//他会重新保存在dist文件夹中</span></span><br><span class="line">  entry: <span class="string">"./src/index.js"</span>,</span><br><span class="line">  output: &#123;</span><br><span class="line">    filename: <span class="string">"app.js"</span>,</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">"dist"</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">    <span class="comment">//这是服务器的配置，我们告诉webpack 从这个文件夹加载应用程序，端口号为9000</span></span><br><span class="line">  devServer: &#123;</span><br><span class="line">    contentBase: path.join(__dirname, <span class="string">"dist"</span>),</span><br><span class="line">    port: <span class="number">9000</span></span><br><span class="line">  &#125;,</span><br><span class="line">  mode: <span class="string">"development"</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="Functional-Programming-in-JavaScript-函数式编程"><a href="#Functional-Programming-in-JavaScript-函数式编程" class="headerlink" title="Functional Programming in JavaScript  函数式编程"></a>Functional Programming in JavaScript  函数式编程</h2><h3 id="What-is-Functional-Programming"><a href="#What-is-Functional-Programming" class="headerlink" title="What is Functional Programming"></a>What is Functional Programming</h3><p>函数式编程是众多编程范式，或者说风格的一种：OOP，Functional，事件驱动…</p>
<p><img src="/2020/06/08/%E6%B5%85%E8%B0%88redux1/7.png" style="zoom: 60%;"></p>
<p>函数式编程，就是使用一些可以复用的函数组合来解决问题。这些函数接收输入并返回结果，他们不修改原始数据。有了这样的原则，我们可以将这些函数组合成更复杂的函数</p>
<p><img src="/2020/06/08/%E6%B5%85%E8%B0%88redux1/8.png" style="zoom: 60%;"></p>
<h3 id="Functions-as-First-class-Citizens"><a href="#Functions-as-First-class-Citizens" class="headerlink" title="Functions as First-class Citizens"></a>Functions as First-class Citizens</h3><p>函数式js中的一等公民，也就是说他们可以用在任何地方。我们可以把它赋值给变量，我们可以把它们当作参数传入，可以作为返回值</p>
<h3 id="Higher-order-Functions"><a href="#Higher-order-Functions" class="headerlink" title="Higher-order Functions"></a>Higher-order Functions</h3><p>Higher-order functions就是说吧函数作为一个参数，或者把函数作为一个返回值，或者两者都有的函数。不同于处理字符串，数字，他们以更高级的方式处理函数</p>
<p>比如说map函数，它接收一个函数作为它的参数</p>
<p>setTimeout()也是一个Higher-order function</p>
<h3 id="Function-Composition"><a href="#Function-Composition" class="headerlink" title="Function Composition"></a>Function Composition</h3><p>最理想的函数式编程，就是创造一些函数，将这些函数组合成更复杂的函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> input = <span class="string">"  javascript  "</span>;</span><br><span class="line"><span class="keyword">let</span> output = <span class="string">"&lt;div&gt;"</span> + input.trim()+<span class="string">"&lt;/div&gt;"</span></span><br></pre></td></tr></table></figure>
<p>我们通过函数式编程改写</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> trim = <span class="function"><span class="params">str</span>=&gt;</span>str.trim();</span><br><span class="line"><span class="keyword">const</span> wrapInDiv = <span class="function"><span class="params">str</span> =&gt;</span><span class="string">`&lt;div&gt;<span class="subst">$&#123;str&#125;</span>&lt;/div&gt;`</span></span><br><span class="line"><span class="keyword">const</span> toLowerCase = <span class="function"><span class="params">str</span>=&gt;</span>str.toLowerCase();</span><br><span class="line"><span class="keyword">const</span> result=wrapInDiv(toLowerCase(trim(input)))</span><br></pre></td></tr></table></figure>
<h3 id="Composing-and-Piping"><a href="#Composing-and-Piping" class="headerlink" title="Composing and Piping"></a>Composing and Piping</h3><p>但是随着函数的复杂性增加，这些小括号会越来越多。</p>
<p>借助<a href="https://lodash.com/docs/4.17.15" target="_blank" rel="noopener">loadash库</a>来简化,他包含了很多针对函数式编程的包</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;compose,pipe&#125; <span class="keyword">from</span> <span class="string">"lodash/fp"</span></span><br><span class="line"><span class="keyword">let</span> input = <span class="string">"  javascript  "</span>;</span><br><span class="line"><span class="keyword">const</span> trim = <span class="function"><span class="params">str</span>=&gt;</span>str.trim();</span><br><span class="line"><span class="keyword">const</span> wrapInDiv = <span class="function"><span class="params">str</span> =&gt;</span><span class="string">`&lt;div&gt;<span class="subst">$&#123;str&#125;</span>&lt;/div&gt;`</span></span><br><span class="line"><span class="keyword">const</span> toLowerCase = <span class="function"><span class="params">str</span>=&gt;</span>str.toLowerCase();</span><br><span class="line"><span class="keyword">const</span> transform = compose(wrapInDiv,toLowerCase,trim);</span><br><span class="line">transform(input)</span><br></pre></td></tr></table></figure>
<p>compose 也是一个 higer -order Functions,因为他传入了三个函数并返回了一个新的包含了这几个参数的函数。</p>
<p>但是特别要注意处理顺序，compose函数是要从右向左执行。</p>
<p>我们可以通过pipe函数来达到我们觉得舒服的从左向右执行</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> transform = pipe(trim,toLowerCase,wrapInDiv);</span><br><span class="line">transform(input)</span><br></pre></td></tr></table></figure>
<h3 id="Currying-curry化"><a href="#Currying-curry化" class="headerlink" title="Currying curry化"></a>Currying curry化</h3><p>我在原来的基础上再新建一个函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> wrapInSpan = <span class="function"><span class="params">str</span> =&gt;</span><span class="string">`&lt;span&gt;<span class="subst">$&#123;str&#125;</span>&lt;/span&gt;`</span></span><br></pre></td></tr></table></figure>
<p>但是因为这个和wrapInSpan长得很像，所以我们可以对两者模板化</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> wrap = <span class="function">(<span class="params">type,str</span>)=&gt;</span>&#123;<span class="string">`&lt;type&gt;<span class="subst">$&#123;str&#125;</span>&lt;/type&gt;`</span>&#125;</span><br></pre></td></tr></table></figure>
<p>但这样直接输出以后是\<javascript\>undefined\<javascript\></javascript\></javascript\></p>
<p>是因为wrap会把传入的JavaScript当成第一个type，我们同样也不能pipe(trim,toLowerCase,wrap(“div”));因为这实际上是调用了wrap并传入了div</p>
<p>这时候我们就需要curry化。curry化允许将多个参数传入，然后转化为只需要一个参数的函数.所以我们吧原来的返回一个字符串或者是数字的函数改成一个返回一个函数的函数.</p>
<p>在curry化之后，我们不是用逗号来分隔参数了，我们使用括号来分隔</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">a,b</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> a+b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>curry化之后</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">a</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">b</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> a+b;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">add(<span class="number">1</span>)(<span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<p>用箭头函数简化后</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> add2 = <span class="function"><span class="params">a</span>=&gt;</span><span class="function"><span class="params">b</span>=&gt;</span>a+b;</span><br></pre></td></tr></table></figure>
<p>所以我们对wrap函数进行改造</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> wrap = <span class="function">(<span class="params">type</span>) =&gt;</span> <span class="function">(<span class="params">str</span>) =&gt;</span> <span class="string">`&lt;<span class="subst">$&#123;type&#125;</span>&gt;<span class="subst">$&#123;str&#125;</span>&lt;/<span class="subst">$&#123;type&#125;</span>&gt;`</span>;</span><br></pre></td></tr></table></figure>
<p>现在，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> transform = pipe(trim,toLowerCase,wrap(<span class="string">"div"</span>));</span><br><span class="line"><span class="built_in">console</span>.log(transform(input))</span><br></pre></td></tr></table></figure>
<p>打印出来的就是 \<div\>javascript\&lt;/div> 现在想换成span标签，只要把div改成span即可</div\></p>
<h3 id="Pure-Functions"><a href="#Pure-Functions" class="headerlink" title="Pure Functions"></a>Pure Functions</h3><p>纯函数就是我每次传入相同的参数的话，他就返回一个相同的值。很多函数都是纯函数，但是随机函数就不是.如:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunction</span>(<span class="params">number</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> number * <span class="built_in">Math</span>.random();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/08/%E6%B5%85%E8%B0%88redux1/9.png" style="zoom: 60%;"></p>
<p>redux中reducer就是一个纯函数。纯函数中的参数不能够变化。</p>
<p><img src="/2020/06/08/%E6%B5%85%E8%B0%88redux1/10.png" style="zoom: 60%;"></p>
<p>自述性：因为所有的这个函数需要的东西在声明的时候已经都说清楚了</p>
<p>易测试:  因为我无需去设置某些全局状态用来测试这个函数</p>
<p>独立的：无需去设置某些全局状态</p>
<p>可缓存的：我们可以保留函数的运算结果</p>
<h3 id="Immutability"><a href="#Immutability" class="headerlink" title="Immutability"></a>Immutability</h3><p>一旦创建，无法改变，如果想修改对象，那么就要复制他，然后再修改它的样本。js中可以修改对象和数组，所以js不是严格意义上的函数式的编程语言。</p>
<p>js中为了达到函数式语言的特性，可以利用const ，const的作用是防止再次赋值，但是可以修改对象中的属性</p>
<p><strong>不可变的好处：</strong></p>
<p><strong>可预测性</strong>：减少了突发情况</p>
<p><strong>更快的感知变化</strong>: <img src="/2020/06/08/%E6%B5%85%E8%B0%88redux1/11.png" style="zoom: 60%;"></p>
<p><strong>并发性</strong>：如果我们知道函数不会修改对象本身，我们就知道实现多任务是安全的。不会因多重加载对象而造成整个系统的混乱。</p>
<p>但是不可变的对象也会带来一些问题：</p>
<p><strong>带来潜在的性能消耗</strong>：我们每次修改对象，所有原对象的字段都要复制到新的对象。可能会减慢速度</p>
<p><strong>内存消耗</strong>：</p>
<p><img src="/2020/06/08/%E6%B5%85%E8%B0%88redux1/12.png" style="zoom: 60%;"></p>
<h3 id="Updating-Objects"><a href="#Updating-Objects" class="headerlink" title="Updating Objects"></a>Updating Objects</h3><p>我们如果要更新对象的话 用spread运算符</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> person = &#123;<span class="attr">name</span>:<span class="string">"John"</span>&#125;;</span><br><span class="line"><span class="keyword">const</span> updated = &#123;...person&#125;;<span class="comment">// &#123;...person，name:"Bob"&#125;也可以加上别的信息</span></span><br></pre></td></tr></table></figure>
<p>注意，这里的拷贝都是浅拷贝，也就是把地址一摸一样的拷贝回来了，所以这样在修改数组的时候，两个地方都会修改，所以要利用深拷贝</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> person = &#123;</span><br><span class="line">	name:<span class="string">"John"</span>,</span><br><span class="line">	address:&#123;</span><br><span class="line">		country:<span class="string">"USA"</span>,</span><br><span class="line">		city:<span class="string">"San Francisco"</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> updated = &#123;</span><br><span class="line">	...person,</span><br><span class="line">	address:&#123;</span><br><span class="line">	...person.address,</span><br><span class="line">	city:<span class="string">"New York"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	name:<span class="string">"Bob"</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们可以看到这样随着嵌套的增多，深拷贝会变得很麻烦。所以我们需要专门实现不可能变性的库</p>
<h3 id="Updating-Arrays"><a href="#Updating-Arrays" class="headerlink" title="Updating Arrays"></a>Updating Arrays</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> numbers = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line"><span class="comment">//adding</span></span><br><span class="line"><span class="keyword">const</span> added = [...numbers,<span class="number">4</span>];</span><br><span class="line"><span class="comment">// particular position </span></span><br><span class="line"><span class="keyword">const</span> index = numbers.indexOf(<span class="number">2</span>);</span><br><span class="line"><span class="keyword">const</span> added2 = [...numbers.slice(<span class="number">0</span>,index),</span><br><span class="line">              <span class="number">4</span>,</span><br><span class="line">              ...numbers.slice(index)]</span><br><span class="line"><span class="built_in">console</span>.log(added2) <span class="comment">// 1,4,2,3</span></span><br><span class="line"><span class="comment">//remove</span></span><br><span class="line"><span class="keyword">const</span> removed = numbers.filter(<span class="function"><span class="params">n</span>=&gt;</span>n!==<span class="number">2</span>);</span><br><span class="line"><span class="comment">//Updating </span></span><br><span class="line"><span class="keyword">const</span> updated = numbers.map(<span class="function"><span class="params">n</span>=&gt;</span>n===<span class="number">2</span>?<span class="number">20</span>:n)</span><br></pre></td></tr></table></figure>
<h3 id="Enforcing-Immutability"><a href="#Enforcing-Immutability" class="headerlink" title="Enforcing Immutability"></a>Enforcing Immutability</h3><p>不变的库</p>
<p><strong>immutable</strong> 提供了很多不变的数据结构，因为我们不希望有可变的对象</p>
<p><strong>immer</strong></p>
<p><strong>mori</strong></p>
<h3 id="Immutable-js"><a href="#Immutable-js" class="headerlink" title="Immutable.js"></a>Immutable.js</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="built_in">Map</span> &#125; <span class="keyword">from</span> <span class="string">"immutable"</span>;</span><br><span class="line"><span class="keyword">let</span> book = <span class="built_in">Map</span>(&#123; <span class="attr">title</span>: <span class="string">"Harry Potter"</span> &#125;);</span><br><span class="line"><span class="built_in">console</span>.log(book);</span><br></pre></td></tr></table></figure>
<p>这样这个对象就是不可改变的了，但是获取对象内的属性变得有点困难，需要用get方法。而且如果要转化到原生js语言还需要toJS()比较烦</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="built_in">Map</span> &#125; <span class="keyword">from</span> <span class="string">"immutable"</span>;</span><br><span class="line"><span class="keyword">let</span> book = <span class="built_in">Map</span>(&#123; <span class="attr">title</span>: <span class="string">"Harry Potter"</span> &#125;);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">publish</span>(<span class="params">book</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> book.set(<span class="string">"isPublished"</span>,<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line">book = publish(book)</span><br><span class="line"><span class="built_in">console</span>.log(book.toJS());</span><br></pre></td></tr></table></figure>
<h3 id="Immer"><a href="#Immer" class="headerlink" title="Immer"></a>Immer</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; produce &#125; <span class="keyword">from</span> <span class="string">"immer"</span>;</span><br><span class="line"><span class="keyword">let</span> book = &#123; <span class="attr">title</span>: <span class="string">"Harry Potter"</span> &#125;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">publish</span>(<span class="params">book</span>) </span>&#123;</span><br><span class="line"><span class="comment">// draftBook只是复制了book对象然后在里面进行修改，我们返回的是修改过后的函数，这比spread方便</span></span><br><span class="line">  <span class="keyword">return</span> produce(book, (draftBook) =&gt; &#123;</span><br><span class="line">    draftBook.isPublished = <span class="literal">true</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> updated = publish(book);</span><br><span class="line"><span class="built_in">console</span>.log(book);</span><br><span class="line"><span class="built_in">console</span>.log(updated);</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/08/%E6%B5%85%E8%B0%88redux1/13.png" style="zoom:80%;"></p>
<h3 id="Quiz"><a href="#Quiz" class="headerlink" title="Quiz"></a>Quiz</h3><p><img src="/2020/06/08/%E6%B5%85%E8%B0%88redux1/14.png" style="zoom: 67%;"></p>
<p><img src="/2020/06/08/%E6%B5%85%E8%B0%88redux1/15.png" style="zoom: 67%;"></p>
<p><img src="/2020/06/08/%E6%B5%85%E8%B0%88redux1/16.png" style="zoom: 67%;"></p>
<h3 id="Coding-Challenges"><a href="#Coding-Challenges" class="headerlink" title="Coding Challenges"></a>Coding Challenges</h3><p><img src="/2020/06/08/%E6%B5%85%E8%B0%88redux1/17.png" style="zoom: 80%;"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; pipe &#125; <span class="keyword">from</span> <span class="string">"lodash/fp"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pickTag = <span class="function"><span class="params">obj</span> =&gt;</span> obj.tag;</span><br><span class="line"><span class="keyword">const</span> toLowerCase = <span class="function"><span class="params">str</span> =&gt;</span> str.toLowerCase();</span><br><span class="line"><span class="keyword">const</span> bracketify = <span class="function"><span class="params">str</span> =&gt;</span> <span class="string">`(<span class="subst">$&#123;str&#125;</span>)`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> transform = pipe(pickTag, toLowerCase, bracketify);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> output = transform(&#123; <span class="attr">tag</span>: <span class="string">"JAVASCRIPT"</span> &#125;);</span><br><span class="line"><span class="built_in">console</span>.log(output);</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> recipe = &#123;</span><br><span class="line">  name: <span class="string">"Spaghetti Bolognese"</span>,</span><br><span class="line">  ingredients: [<span class="string">"egg"</span>, <span class="string">"salt"</span>]</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add an ingredient</span></span><br><span class="line"><span class="keyword">const</span> added = &#123;</span><br><span class="line">  ...recipe,</span><br><span class="line">  ingredients: [...recipe.ingredients, <span class="string">"cream"</span>]</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Update an ingredient</span></span><br><span class="line"><span class="keyword">const</span> updated = &#123;</span><br><span class="line">  ...recipe,</span><br><span class="line">  ingredients: recipe.ingredients.map(<span class="function"><span class="params">ingredient</span> =&gt;</span></span><br><span class="line">    ingredient === <span class="string">"egg"</span> ? <span class="string">"egg white"</span> : ingredient</span><br><span class="line">  )</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Remove an ingredient</span></span><br><span class="line"><span class="keyword">const</span> removed = &#123;</span><br><span class="line">  ...recipe,</span><br><span class="line">  ingredients: recipe.ingredients.filter(<span class="function"><span class="params">ingredient</span> =&gt;</span> ingredient !== <span class="string">"egg"</span>)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="Redux-Fundamentals"><a href="#Redux-Fundamentals" class="headerlink" title="Redux Fundamentals"></a>Redux Fundamentals</h2><h3 id="Redux-Architecture"><a href="#Redux-Architecture" class="headerlink" title="Redux Architecture"></a>Redux Architecture</h3><p><img src="/2020/06/08/%E6%B5%85%E8%B0%88redux1/18.png" style="zoom: 67%;"></p>
<p>比如在一个 购物软件中有这样一个对象,对象中可以存放任何类型</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	categories:[],</span><br><span class="line">	products:[],</span><br><span class="line">	cart:&#123;&#125;,</span><br><span class="line">	user:&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们不能直接改变store，因为Redux是建立在函数式编程之上的。在函数式编程中不能改变对象。如果需要改变对象需要编写一个函数然后通过一些库或者…运算符在原对象基础上形成一个新的对象。那么这个函数就被称之为reducer.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">store</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">const</span> updated = &#123;...store&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>reducer从store中获取 current instance of store and return a data store。</p>
<p>现在问题来了，reducer是怎么知道store中的那些属性需要修改呢？这时候我们引入了action,action就是一个对象，它描述了刚刚发生了什么：用户登陆了，登出了，向购物车加了什么东西了之类的，也就是app中可能发生的事件。所以我们传入reducer还应该有第二个参数action</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">store,action</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">const</span> updated = &#123;...store&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下图截取自<a href="http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_one_basic_usages.html" target="_blank" rel="noopener">阮一峰的技术博客1</a> </p>
<p><img src="/2020/06/08/%E6%B5%85%E8%B0%88redux1/19.png" style="zoom: 67%;"></p>
<p>每一个reducer掌管一个store中的内容，在阮一峰的博客中写道：Reducer 函数负责生成 State。由于整个应用只有一个 State 对象，包含所有数据，对于大型应用来说，这个 State 必然十分庞大，导致 Reducer 函数也十分庞大。上面代码中，三种 Action 分别改变 State 的三个属性。</p>
<blockquote>
<ul>
<li>ADD_CHAT：<code>chatLog</code>属性</li>
<li>CHANGE_STATUS：<code>statusMessage</code>属性</li>
<li>CHANGE_USERNAME：<code>userName</code>属性</li>
</ul>
</blockquote>
<p>这三个属性之间没有联系，这提示我们可以把 Reducer 函数拆分。不同的函数负责处理不同属性，最终把它们合并成一个大的 Reducer 即可。</p>
<p>所以我们可以有多个reducer，也可以只有一个，取决于store中数据的多少</p>
<p>可以这样来理解：Action是event，Reducer是Event Handler。Reducer只是一个纯函数，他只是接收action然后返回更新过后的store中的值</p>
<p>现在我们用一个例子来描述一样redux的机制：</p>
<p>当我们向购物车里增加了一件商品的时候，我们创建了一个action然后dispatch(调遣)了它给<code>Store</code>, <code>Reducer</code> 函数不用手动调用，<code>store.dispatch</code>方法会触发 <code>Reducer</code> 的自动执行。为此，<code>Store</code> 需要知道 Reducer 函数Store 收到 Action 以后，必须给出一个新的 State，这样 UI 才会发生变化。</p>
<p><img src="/2020/06/08/%E6%B5%85%E8%B0%88redux1/20.png" style="zoom: 67%;"></p>
<h3 id="Your-First-Redux-App"><a href="#Your-First-Redux-App" class="headerlink" title="Your First Redux App"></a>Your First Redux App</h3><p>这是我们要建的redux应用</p>
<p><img src="/2020/06/08/%E6%B5%85%E8%B0%88redux1/21.png" style="zoom: 50%;"></p>
<p>这是我们构建redux的步骤</p>
<p><img src="/2020/06/08/%E6%B5%85%E8%B0%88redux1/22.png" style="zoom: 50%;"></p>
<p>npm i redux@4.0</p>
<h3 id="Designing-the-Store"><a href="#Designing-the-Store" class="headerlink" title="Designing the Store"></a>Designing the Store</h3><p>我们要建一个store，就要搞清楚Store要存放什么数据。分析一下上面的ui我们可以这样写一个结构</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">	&#123;</span><br><span class="line">		id:<span class="number">1</span>,</span><br><span class="line">		description:<span class="string">""</span>,</span><br><span class="line">		resolved: <span class="literal">false</span></span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;...&#125;,</span><br><span class="line">	&#123;...&#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>在real-world app中,我们可以这样写， this store has  two slices . 在没有登陆的时候currentUser为null，登陆了以后把它设置成一个包含了登录信息的对象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">	bugs:&#123;</span><br><span class="line">		id:<span class="number">1</span>,</span><br><span class="line">		description:<span class="string">""</span>,</span><br><span class="line">		resolved: <span class="literal">false</span></span><br><span class="line">	&#125;,</span><br><span class="line">	currentUser:&#123;&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h3 id="Defining-the-Actions"><a href="#Defining-the-Actions" class="headerlink" title="Defining the Actions"></a>Defining the Actions</h3><p>现在我们来定义一个Action，在这个app当中我们可以写这样几个actions,在 real-world app中我们会有更多其它的actions</p>
<p><img src="/2020/06/08/%E6%B5%85%E8%B0%88redux1/23.png" style="zoom: 50%;"></p>
<p>之前说了Action 是一个对象。其中的<code>type</code>属性是必须的，表示 Action 的名称。其他属性可以自由设置，社区有一个<a href="https://github.com/acdlite/flux-standard-action" target="_blank" rel="noopener">规范</a>可以参考。 </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	type:<span class="string">"ADD_BUG"</span>,</span><br><span class="line"> <span class="comment">// type:"bugAdded"</span></span><br><span class="line">	descriptionL:<span class="string">"..."</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	type:<span class="string">"ADD_BUG"</span>,</span><br><span class="line">    payload:&#123;</span><br><span class="line">    	id:<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Creating-a-Reducer"><a href="#Creating-a-Reducer" class="headerlink" title="Creating a Reducer"></a>Creating a Reducer</h3><h3 id="Creating-the-Store"><a href="#Creating-the-Store" class="headerlink" title="Creating the Store"></a>Creating the Store</h3><h3 id="Dispatching-Actions"><a href="#Dispatching-Actions" class="headerlink" title="Dispatching Actions"></a>Dispatching Actions</h3><h3 id="Subscribing-to-the-Store"><a href="#Subscribing-to-the-Store" class="headerlink" title="Subscribing to the Store"></a>Subscribing to the Store</h3><h3 id="Action-Types"><a href="#Action-Types" class="headerlink" title="Action Types"></a>Action Types</h3><h3 id="Action-Creators"><a href="#Action-Creators" class="headerlink" title="Action Creators"></a>Action Creators</h3><h3 id="Exercise"><a href="#Exercise" class="headerlink" title="Exercise"></a>Exercise</h3><h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h3><h2 id="Building-Redux-from-Scratch"><a href="#Building-Redux-from-Scratch" class="headerlink" title="Building Redux from Scratch"></a>Building Redux from Scratch</h2><h3 id="Redux-Store"><a href="#Redux-Store" class="headerlink" title="Redux Store"></a>Redux Store</h3><h3 id="Private-Properties"><a href="#Private-Properties" class="headerlink" title="Private Properties"></a>Private Properties</h3><h3 id="Dispatching-Actions-1"><a href="#Dispatching-Actions-1" class="headerlink" title="Dispatching Actions"></a>Dispatching Actions</h3><h3 id="Subscribing-to-the-Store-1"><a href="#Subscribing-to-the-Store-1" class="headerlink" title="Subscribing to the Store"></a>Subscribing to the Store</h3><h3 id="A-Quick-Note"><a href="#A-Quick-Note" class="headerlink" title="A Quick Note"></a>A Quick Note</h3>
          
        
      
    </div>
    
    
    
    <div>
      
    </div>
    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://jasonxqh.github.io/2020/06/07/React%E6%A1%86%E6%9E%B6%E5%9C%A8%E4%BD%9C%E4%B8%9A%E5%BD%93%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/%5Bobject%20Object%5D">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/07/React%E6%A1%86%E6%9E%B6%E5%9C%A8%E4%BD%9C%E4%B8%9A%E5%BD%93%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/" itemprop="url">React框架在作业当中的应用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-07T20:59:03+08:00">
                2020-06-07
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2020-06-29T21:42:12+08:00">
                2020-06-29
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/react/" itemprop="url" rel="index">
                    <span itemprop="name">react</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="React框架在作业当中的应用"><a href="#React框架在作业当中的应用" class="headerlink" title="React框架在作业当中的应用"></a>React框架在作业当中的应用</h1><p>本篇博客随时会引用这四篇博客中实现的功能与技术。</p>
<p>鉴于基础博客的篇幅都比较长，<strong>为了有良好的阅读体验</strong>，本文所有的链接点击即可<strong>跳转至相应章节</strong>。</p>
<p><a href="https://jasonxqh.github.io/2020/05/30/react基础/#more">react基础1组件与组合组件</a></p>
<p><a href="https://jasonxqh.github.io/2020/06/02/react基础2/">react基础2分页排序搜索+路由</a></p>
<p> <a href="https://jasonxqh.github.io/2020/06/04/react基础3/">react基础3表单与后端</a></p>
<p><a href="https://jasonxqh.github.io/2020/06/05/react基础4授权与部署/">react基础4授权与部署</a></p>
<h2 id="根目录"><a href="#根目录" class="headerlink" title="根目录"></a>根目录</h2><h3 id="index-js"><a href="#index-js" class="headerlink" title="index.js"></a><code>index.js</code></h3><p><code>index.js</code>加载了<code>App</code>，所以也要着重关注</p>
<p><a href="https://www.cnblogs.com/sameen/p/9182925.html" target="_blank" rel="noopener">关于react-redux中Provider、connect的解析</a></p>
<p>阮一峰的博客中也有对Provider的解释</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Provider &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="keyword">import</span> thunkMiddleware <span class="keyword">from</span> <span class="string">'redux-thunk'</span>;</span><br><span class="line"><span class="keyword">import</span> loggerMiddleware <span class="keyword">from</span> <span class="string">'./store/middleware/logger'</span>;</span><br><span class="line"><span class="keyword">import</span> rootReducer <span class="keyword">from</span> <span class="string">'./store'</span>;</span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./page/App.jsx'</span>;</span><br><span class="line"><span class="comment">//Store 就是保存数据的地方，你可以把它看成一个容器。整个应用只能有一个 Store。</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Provider是react-redux 提供的一个 React 组件</span></span><br><span class="line"><span class="comment">作用就是把 store 提供给其子组件</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> store = createStore(rootReducer, applyMiddleware(thunkMiddleware, loggerMiddleware));</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">    &lt;App /&gt;</span><br><span class="line">  &lt;<span class="regexp">/Provider&gt;,</span></span><br><span class="line"><span class="regexp">  document.getElementById('root'),</span></span><br><span class="line"><span class="regexp">);</span></span><br></pre></td></tr></table></figure>
<h3 id="setupProxy-js"><a href="#setupProxy-js" class="headerlink" title="setupProxy.js"></a><code>setupProxy.js</code></h3><p>这个文件的目的是设置一个代理。前端启动端口是3000，后端是8080，这样就会跨域，前端做一个代理，把所有api的接口请求都转发到8080端口。这样就能把所有的请求都转发到你起的后端的服务上了</p>
<p><a href="https://www.jianshu.com/p/a2a5163fefac" target="_blank" rel="noopener">参考react配置多个代理,跨域</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> proxy = <span class="built_in">require</span>(<span class="string">'http-proxy-middleware'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">app</span>) </span>&#123;</span><br><span class="line">  app.use(proxy(<span class="string">'/api'</span>, &#123; <span class="attr">target</span>: <span class="string">'http://localhost:8080/'</span> &#125;));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="服务"><a href="#服务" class="headerlink" title="服务"></a>服务</h2><h3 id="Api-js"><a href="#Api-js" class="headerlink" title="Api.js"></a><code>Api.js</code></h3><p>可以使用自定义配置新建一个 axios 实例,自定义实例默认值</p>
<p>比如后端接口的完整的路径是：<code>localhost:8080/api/users/list</code> ，我把所有的请求公共部分，<code>localhost:8080/api</code> 抽出来，放在axios的baseURL里面，这样在代码里面，就不用每次都写<code>localhost:8080/api</code>这样的开头了。降低了代码的耦合度</p>
<p>假如有一天，后端改了api的开头，改了端口号，都不用一个个在代码里面一个个改了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">'axios'</span>;</span><br><span class="line"><span class="keyword">const</span> Api = axios.create(&#123;</span><br><span class="line">  baseURL: <span class="string">'http://localhost:8080/api/'</span>,</span><br><span class="line">  <span class="comment">// timeout: ,</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Api;</span><br></pre></td></tr></table></figure>
<p><a href="http://www.axios-js.com/zh-cn/docs/#axios-create-config" target="_blank" rel="noopener">可以参照axios官方文档</a></p>
<h3 id="Util-js"><a href="#Util-js" class="headerlink" title="Util.js"></a><code>Util.js</code></h3><p>这相当于<a href="https://jasonxqh.github.io/2020/06/05/react基础4授权与部署/#Refactoring">react基础4授权与部署中的authService</a>中存取token的操作</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Util = &#123;</span><br><span class="line">  <span class="comment">// 登录后将token存到localStorage中</span></span><br><span class="line">  <span class="keyword">async</span> setToken(token) &#123;</span><br><span class="line">    <span class="keyword">await</span> localStorage.setItem(<span class="string">'token'</span>, token);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 取出localStorage中的token</span></span><br><span class="line">  getToken() &#123;</span><br><span class="line">    <span class="keyword">return</span> localStorage.getItem(<span class="string">'token'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Util;</span><br></pre></td></tr></table></figure>
<h2 id="store目录既Redux理解"><a href="#store目录既Redux理解" class="headerlink" title="store目录既Redux理解"></a>store目录既Redux理解</h2><p>学习了</p>
<p><a href="http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_one_basic_usages.html" target="_blank" rel="noopener">阮一峰的技术博客1</a> </p>
<p><a href="http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_two_async_operations.html" target="_blank" rel="noopener">阮一峰的技术博客2</a></p>
<p><a href="http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_three_react-redux.html" target="_blank" rel="noopener">阮一峰的技术博客3</a></p>
<p><a href="https://blog.csdn.net/weixin_38178584/article/details/82189351" target="_blank" rel="noopener">React-Redux流程中，mapStateToProps的理解</a> </p>
<p><a href="https://www.cnblogs.com/sameen/p/9182925.html" target="_blank" rel="noopener">关于react-redux中Provider、connect的解析</a><br>和 <a href="https://www.bilibili.com/video/BV1K7411U7P5" target="_blank" rel="noopener">b站Mosh教程</a></p>
<p>写下了一篇子博客  <a href="https://jasonxqh.github.io/2020/06/08/浅谈redux1/">浅谈redux1</a></p>
<p>对redux有了一些了解，于是我把他应用到处理登录这一部分</p>
<h3 id="处理登录目录"><a href="#处理登录目录" class="headerlink" title="处理登录目录"></a>处理登录目录</h3><h4 id="actions-js"><a href="#actions-js" class="headerlink" title="actions.js"></a><code>actions.js</code></h4><p>在<a href="https://jasonxqh.github.io/2020/06/08/浅谈redux1/">浅谈redux1</a> 中，引用阮一峰的文字也好，自己写下的理解也罢，对action的作用已经明白了，可以用下图来解释</p>
<p><img src="/2020/06/07/React%E6%A1%86%E6%9E%B6%E5%9C%A8%E4%BD%9C%E4%B8%9A%E5%BD%93%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/10.png" style="zoom: 67%;"></p>
<p>我这里有两个Actions，一个是关于用户登陆的，一个是关于获取用户信息的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; USER_LOGIN, GET_USER_INFO &#125; <span class="keyword">from</span> <span class="string">'./action-type'</span>;</span><br><span class="line"><span class="comment">/*action-type:</span></span><br><span class="line"><span class="comment">export const GET_USER_INFO = 'GET_USER_INFO';</span></span><br><span class="line"><span class="comment">export const USER_LOGIN = 'USER_LOGIN';</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">import</span> Util <span class="keyword">from</span> <span class="string">'../../js/Util'</span>;</span><br><span class="line"><span class="keyword">import</span> Api <span class="keyword">from</span> <span class="string">'../../js/Api'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> actionUserLoginCreator = <span class="function">(<span class="params">type, data</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; name &#125; = data;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type,</span><br><span class="line">    data: &#123;</span><br><span class="line">      isLogin: <span class="literal">true</span>, <span class="comment">// 是否登录</span></span><br><span class="line">      name,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">判断用户是否登陆成功的action，如果在登陆界面我点击登陆的化，表单中的信息(账号密码)会当作参数</span></span><br><span class="line"><span class="comment">传入，然后我们通过后端Api判断这个账号密码是否合法，合法的话我们就会得到一个response，</span></span><br><span class="line"><span class="comment">response中会有一个data对象</span></span><br><span class="line"><span class="comment">然后我们就把这个对象中的token存在本地storage当中，这样能让用户保持登陆状态。</span></span><br><span class="line"><span class="comment">最后我们发出一个action，让reducer按照我们的要求更新state，并返回给需要的组件。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> userLogin = <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Api.post(<span class="string">'/users/login'</span>, params).then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (res.data) &#123;</span><br><span class="line">        Util.setToken(res.data.token);</span><br><span class="line">        dispatch(actionUserLoginCreator(USER_LOGIN, &#123; <span class="attr">name</span>: res.data.name &#125;));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">获取用户信息的action</span></span><br><span class="line"><span class="comment">这个action就是说首先我从当前的storage中拿到token</span></span><br><span class="line"><span class="comment">然后如果token存在，那么调用Api.get获取到用户的信息，然后调用actionUserLoginCreator函数</span></span><br><span class="line"><span class="comment">dispatch出去，(这里为了让代码的结构更加明了，我把对象抽离出来新建了个函数。),其中：</span></span><br><span class="line"><span class="comment">type:GET_USER_INFO</span></span><br><span class="line"><span class="comment">data:&#123;</span></span><br><span class="line"><span class="comment">	name:当前用户信息</span></span><br><span class="line"><span class="comment">	isLogin:true 说明当前用户已经登陆。</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">那么如果token没有，说明当前没有用户登录，那么我们就dispatch一个action对象</span></span><br><span class="line"><span class="comment">type还是一样的，但是isLogin为false，而且因为没有登陆，所以没有名字。</span></span><br><span class="line"><span class="comment">type: GET_USER_INFO,</span></span><br><span class="line"><span class="comment">data: &#123;</span></span><br><span class="line"><span class="comment">  isLogin: false,</span></span><br><span class="line"><span class="comment">  name: null,</span></span><br><span class="line"><span class="comment">&#125;,</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getUserInfo = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> token = Util.getToken();</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (token) &#123;</span><br><span class="line">      <span class="keyword">return</span> Api.get(<span class="string">'/users/info'</span>, &#123;</span><br><span class="line">        headers: &#123; <span class="attr">Authorization</span>: <span class="string">`Bearer <span class="subst">$&#123;token&#125;</span>`</span> &#125;,</span><br><span class="line">      &#125;).then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (res.data.data.name) &#123;</span><br><span class="line">          dispatch(actionUserLoginCreator(GET_USER_INFO, &#123; <span class="attr">name</span>: res.data.data.name &#125;));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      dispatch(&#123;</span><br><span class="line">        type: GET_USER_INFO,</span><br><span class="line">        data: &#123;</span><br><span class="line">          isLogin: <span class="literal">false</span>,</span><br><span class="line">          name: <span class="literal">null</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="reducer"><a href="#reducer" class="headerlink" title="reducer"></a><code>reducer</code></h4><p>在<a href="https://jasonxqh.github.io/2020/06/08/浅谈redux1/">浅谈redux1</a> 中说过了reducer是一个纯函数。他只接收state和action然后返回对应的更新完毕的state</p>
<p>因为redux的store中保管了所有组件的state，所以需要state的组件会通过某种方式dispatch一个action过来，</p>
<p>reducer接收了以后更新state对象并返回给那个组件。</p>
<p>这个app中有两个actions，他们的名字分别是USER_LOGIN和GET_USER_INFO</p>
<p>因为actions不多，所以我没有必要去拆分reducer。做一个switchcase就可以了。</p>
<p>如果action的type=USER_LOGIN,那么我们就把用户的名字赋给state，并把isLogin设置为true，</p>
<p>GET_USER_INFO亦然</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; USER_LOGIN, GET_USER_INFO &#125; <span class="keyword">from</span> <span class="string">'./action-type'</span>;</span><br><span class="line"><span class="keyword">const</span> initState = &#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    isLogin: <span class="literal">false</span>, <span class="comment">// 是否登录</span></span><br><span class="line">    username: <span class="literal">null</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> reducer = <span class="function">(<span class="params">state = initState, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> USER_LOGIN:</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        data: action.data,</span><br><span class="line">      &#125;;</span><br><span class="line">    <span class="keyword">case</span> GET_USER_INFO:</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        data: action.data,</span><br><span class="line">      &#125;;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> reducer;</span><br></pre></td></tr></table></figure>
<h3 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h3><p>这里需要了解下函数式编程，我在  <a href="https://jasonxqh.github.io/2020/06/08/浅谈redux1/#Functional-Programming-in-JavaScript-函数式编程">浅谈redux1：函数式编程 </a>中已经有了初步的介绍</p>
<p>这个就是一个单纯的记录日志的中间件。对整个app用处不大</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> logger = <span class="function">(<span class="params">&#123; getState, dispatch &#125;</span>) =&gt;</span> <span class="function">(<span class="params">next</span>) =&gt;</span> <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.group(action.type);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'dispatching:'</span>, action);</span><br><span class="line">  <span class="keyword">const</span> result = next(action);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'next state:'</span>, getState());</span><br><span class="line">  <span class="built_in">console</span>.groupEnd();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> logger;</span><br></pre></td></tr></table></figure>
<h3 id="index-js-1"><a href="#index-js-1" class="headerlink" title="index.js"></a><code>index.js</code></h3><p><code>Redux</code> 提供了一个<code>combineReducers</code>方法，用于 Reducer 的拆分。你只要定义各个子 Reducer 函数，然后用这个方法，将它们合成一个大的 Reducer。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; combineReducers &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> userData <span class="keyword">from</span> <span class="string">'./login/reducer'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> combineReducers(&#123;</span><br><span class="line">  userData,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="mapStateToProps的理解"><a href="#mapStateToProps的理解" class="headerlink" title="mapStateToProps的理解"></a><code>mapStateToProps</code>的理解</h3><p>因为在代码中很多时候涉及到这两个函数，我就直接在这里解释一下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    userData: state.userData.data,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>mapStateToProps</code>方法就是容器组件向store声明需要的state的地方，因为我们的store是整个应用只有一份，根据<code>redux</code>的思想通过context可以保证每一个组件都可以从context中获取到store，不需要一级一级的从顶层传递下来。所以，一般容器组件上会有这个函数负责通过context获取到store中想要的state<strong>，即从store中获取到的state相当于容器组件从父组件拿到的props</strong>，因此，<code>mapStateToProps</code>函数一般只存在于容器组件（或顶层组件）中。</p>
<p>   由于，store中的所有state都由reducer来更新，所有一般<code>mapStateToProps</code>方法中需要定义所有的reducer，把所有的reducer的结果都要拿到，保证我们的store中能包含所有的state，也就是我们这个大应用需要的所有数据都能从顶层组件（或容器组件）获取，然后传递下去；</p>
<p> 这里，通过这个<code>mapStateToProps</code>，返回了一个本地的state，state中有<code>userData.data</code></p>
<p><code>userData.data</code>其实就是reducer中返回的对象中user的名字和登陆与否的状态</p>
<h3 id="mapDispatchToProps的理解"><a href="#mapDispatchToProps的理解" class="headerlink" title="mapDispatchToProps的理解"></a><code>mapDispatchToProps</code>的理解</h3><p><code>mapDispatchToProps</code></p>
<ul>
<li>dispatch是必须的参数</li>
<li><code>mapDispatchToProps</code>在组件constructor()中被执行，因而只执行一次</li>
<li><code>mapDispatchToProps</code>为组件提供了用于改变Store状态的方法，并将其定义为组件的prop</li>
</ul>
<p><code>mapDispatchToProps</code>用于建立组件跟<code>store.dispatch</code>的映射关系,可以是一个object，也可以传入函数<br>如果<code>mapDispatchToProps</code>是一个函数，它可以传入dispatch,ownProps, 定义UI组件如何发出action，实际上就是要调用dispatch这个方法<br>这两个例子</p>
<p>1.就是说如果我调用<code>getUserInfo</code>的话，我就会dispatch一个<code>getUserInfo</code>的action,这个action的作用是获取到用户的信息</p>
<p>2.如果我调用<code>getUserLogin</code>，那么我就会dispatch一个<code>userLogin</code>的action，里面包含了我传入的登录信息params</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function">(<span class="params">dispatch</span>) =&gt;</span> (&#123;</span><br><span class="line">  getUserInfo: <span class="function"><span class="params">()</span> =&gt;</span> dispatch(getUserInfo()),</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function">(<span class="params">dispatch</span>) =&gt;</span> (&#123;</span><br><span class="line">  getUserLogin: <span class="function">(<span class="params">params</span>) =&gt;</span> dispatch(userLogin(params)),</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="connect的理解"><a href="#connect的理解" class="headerlink" title="connect的理解"></a>connect的理解</h3><p> <code>mapStateToProps</code>,<code>mapDispatchToProps</code>函数是通过<code>redux</code>的connect函数与react联系在一起的，如connect（<code>mapStateToProps</code>，<code>mapDispatchToProps</code>）（xxxPages），<strong>connect返回的是一个函数</strong>，这个函数会调用子组件（傻瓜组件、木偶组件），完成容器组件与木偶组件的链接，而<code>mapStateToProps</code>,<code>mapDispatchToProps</code>的返回就是这个木偶组件的props，走这个木偶组件的更新过程 </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(</span><br><span class="line">  mapStateToProps,</span><br><span class="line">  mapDispatchToProps,</span><br><span class="line">)(wrappedLoginForm);</span><br></pre></td></tr></table></figure>
<h3 id="provider的理解"><a href="#provider的理解" class="headerlink" title="provider的理解"></a>provider的理解</h3><p>在index中，我们有这样一个provider标签</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">    &lt;App /&gt;</span><br><span class="line">  &lt;<span class="regexp">/Provider&gt;,</span></span><br><span class="line"><span class="regexp">  document.getElementById('root'),</span></span><br><span class="line"><span class="regexp">);</span></span><br></pre></td></tr></table></figure>
<h2 id="组件部分"><a href="#组件部分" class="headerlink" title="组件部分"></a>组件部分</h2><h3 id="NavBar"><a href="#NavBar" class="headerlink" title="NavBar"></a><code>NavBar</code></h3><h4 id="实现形式："><a href="#实现形式：" class="headerlink" title="实现形式："></a>实现形式：</h4><p>在<code>admin</code>当中</p>
<p><img src="/2020/06/07/React%E6%A1%86%E6%9E%B6%E5%9C%A8%E4%BD%9C%E4%B8%9A%E5%BD%93%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/1.png" style="zoom: 67%;"></p>
<p>在普通用户中<br><img src="/2020/06/07/React%E6%A1%86%E6%9E%B6%E5%9C%A8%E4%BD%9C%E4%B8%9A%E5%BD%93%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/2.png" style="zoom: 67%;"></p>
<p>在未登录界面</p>
<p><img src="/2020/06/07/React%E6%A1%86%E6%9E%B6%E5%9C%A8%E4%BD%9C%E4%B8%9A%E5%BD%93%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/3.png" style="zoom: 67%;"></p>
<h4 id="实现逻辑-代码分析"><a href="#实现逻辑-代码分析" class="headerlink" title="实现逻辑+代码分析"></a>实现逻辑+代码分析</h4><p>为了方便，我们对源码进行分割</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createHashHistory &#125; <span class="keyword">from</span> <span class="string">'history'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./style.scss'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Icon, Dropdown, Menu &#125; <span class="keyword">from</span> <span class="string">'antd'</span>;</span><br><span class="line"><span class="keyword">import</span> Util <span class="keyword">from</span> <span class="string">'../../../js/Util'</span>;</span><br><span class="line"><span class="keyword">const</span> history = createHashHistory();</span><br><span class="line"><span class="keyword">const</span> &#123; Fragment &#125; = React;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommonHeader</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">      <span class="comment">//在构造器中首先super</span></span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">      <span class="comment">//state中保存NavBar组件的默认信息，里面有isLogin，默认未登录;name默认为空串</span></span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      isLogin: <span class="literal">false</span>,</span><br><span class="line">      name: <span class="string">''</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//cdm为空</span></span><br><span class="line">  componentDidMount() &#123;&#125;</span><br></pre></td></tr></table></figure>
<h5 id="一些函数的实现"><a href="#一些函数的实现" class="headerlink" title="一些函数的实现"></a>一些函数的实现</h5><p>1.history.push()在上文<a href="https://jasonxqh.github.io/2020/06/02/react基础2/#Programmatic-Navigation">react基础2分页排序搜索+路由中的Programmatic Navigation</a>中的路由部分有详细提到。再次不必多说<br>2.NavBar中实现的路由跳转:<br>3.goSign: 跳转到/type其中这个语法是ES6的模板语法，${}中的元素会随着传入的不同而实时渲染，具体的实现功能就是路由跳转，我之所以写成这样是因为它既可以可以跳转到login，也可以跳register 跳到哪里完全看我传入什么type<br>4.goHome: 跳转到主页<br>5.logout: 删除当前的token(置空)跳转到主页.其中Util中封装了setToken和getToken两个函数，分别<br>是用来设置Token和获取Token的函数(也就是localStorage.setItem之类的，在<a href="https://jasonxqh.github.io/2020/06/05/react基础4授权与部署/#Storing-the-JWT-JSON-Token">react基础4授权中的Storing the JWT(JSON Token)章节</a>提及)<br>6.goManage:跳转到/manage也就是管理页面<br>7.goTarget:跳转到的地方随target决定</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">goSign(type) &#123;</span><br><span class="line">  history.push(<span class="string">`/<span class="subst">$&#123;type&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">goHome() &#123;</span><br><span class="line">  history.push(<span class="string">'/'</span>);</span><br><span class="line">&#125;</span><br><span class="line">logout() &#123;</span><br><span class="line">  Util.setToken(<span class="string">''</span>);</span><br><span class="line">  <span class="built_in">window</span>.location.reload(<span class="string">'/'</span>);</span><br><span class="line">&#125;</span><br><span class="line">goManage() &#123;</span><br><span class="line">  history.push(<span class="string">'/manage'</span>);</span><br><span class="line">&#125;</span><br><span class="line">goTarget(target) &#123;</span><br><span class="line">  history.push(<span class="string">`/<span class="subst">$&#123;target&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="render-渲染器部分"><a href="#render-渲染器部分" class="headerlink" title="render()渲染器部分"></a>render()渲染器部分</h5><p> <strong>render渲染器部分</strong>，首先析构userData<br> 然后从userData中析构名字和登陆状态<br> menu就是下拉表单，里面封装了一个按钮，也就是推出，点击退出会删除Token并回到首页</p>
<p><strong>render中返回的组件部分:</strong><br>1.一开始当然是个Navbar标签，点击它就会回到主页<br>2.随后是条件渲染，就是只有当用户是admin的时候，才会显示这个按钮，否则是不会显示的。点击这个按钮跳转到用户管理界面，具体界面的逻辑再次不细说。<br>3.然后是四个表单的条件渲染。就是只有isLogin= true的时候，才会显示这四个表单的按钮.点击这4个按钮会分别跳转到相应的展示页面<br>4.再然后是右边的部分，这个部分会根据是否登陆而变换。通过判断isLogin？如果未登录，那么就渲染登录和注册这两个按钮，点击后调用goSign传入我想取得地方(login或者register)这就体现了ES6模板化语言的好处，当然直接利用字符串拼接也可以; 如果已经注册，那么再有边显示一个下拉表单: 下拉表单中有上文const的menu对象，也就是退出。未显示下拉表单的时候右边是一个antd库的icon和用户的名字，<br>就如上文图片中展示的一样</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"> render() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; userData &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">const</span> &#123; name, isLogin &#125; = userData;</span><br><span class="line">    <span class="keyword">const</span> menu = (</span><br><span class="line">      &lt;Menu&gt;</span><br><span class="line">        &lt;Menu.Item key=<span class="string">"0"</span> onClick=&#123;() =&gt; <span class="keyword">this</span>.logout()&#125;&gt;</span><br><span class="line">          退出</span><br><span class="line">        &lt;<span class="regexp">/Menu.Item&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>Menu&gt;</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div className=<span class="string">"header-nav"</span>&gt;</span><br><span class="line">        &lt;div className=<span class="string">"home-logo"</span>&gt;</span><br><span class="line">          &lt;div className=<span class="string">"logo-text"</span> onClick=&#123;() =&gt; <span class="keyword">this</span>.goHome()&#125;&gt;</span><br><span class="line">            NavBar</span><br><span class="line">          &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">          &lt;div className="tab-bar"&gt;</span></span><br><span class="line"><span class="regexp">            &#123;name === 'admin' ? (</span></span><br><span class="line"><span class="regexp">              &lt;div className="bar-item" onClick=&#123;() =&gt; this.goManage()&#125;&gt;</span></span><br><span class="line"><span class="regexp">                用户管理</span></span><br><span class="line"><span class="regexp">              &lt;/</span>div&gt;</span><br><span class="line">            ) : <span class="literal">null</span>&#125;</span><br><span class="line">            &#123;isLogin &amp;&amp; (</span><br><span class="line">              &lt;div style=&#123;&#123; <span class="attr">display</span>: <span class="string">'flex'</span> &#125;&#125;&gt;</span><br><span class="line">                &lt;div className=<span class="string">"bar-item"</span> onClick=&#123;() =&gt; <span class="keyword">this</span>.goTarget(<span class="string">'douban'</span>)&#125;&gt;</span><br><span class="line">                  豆瓣Top250</span><br><span class="line">                &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">                &lt;div className="bar-item" onClick=&#123;() =&gt; this.goTarget('maoyan')&#125;&gt;</span></span><br><span class="line"><span class="regexp">                  猫眼Top100</span></span><br><span class="line"><span class="regexp">                &lt;/</span>div&gt;</span><br><span class="line">                &lt;div className=<span class="string">"bar-item"</span> onClick=&#123;() =&gt; <span class="keyword">this</span>.goTarget(<span class="string">'operas'</span>)&#125;&gt;</span><br><span class="line">                  剧集</span><br><span class="line">                &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">                &lt;div className="bar-item" onClick=&#123;() =&gt; this.goTarget('taobao')&#125;&gt;</span></span><br><span class="line"><span class="regexp">                  淘宝咖啡</span></span><br><span class="line"><span class="regexp">                &lt;/</span>div&gt;</span><br><span class="line">              &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">            )&#125;</span></span><br><span class="line"><span class="regexp">          &lt;/</span>div&gt;</span><br><span class="line">        &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;div className="nav-right"&gt;</span></span><br><span class="line"><span class="regexp">          &lt;div className="mine"&gt;</span></span><br><span class="line"><span class="regexp">            &#123;!isLogin ? (</span></span><br><span class="line"><span class="regexp">              &lt;Fragment&gt;</span></span><br><span class="line"><span class="regexp">                &lt;div className="sign" onClick=&#123;() =&gt; this.goSign('login')&#125;&gt;</span></span><br><span class="line"><span class="regexp">                  登录</span></span><br><span class="line"><span class="regexp">                &lt;/</span>div&gt;</span><br><span class="line">                &lt;div className=<span class="string">"split-line"</span>&gt;|&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">                &lt;div className="sign" onClick=&#123;() =&gt; this.goSign('register')&#125;&gt;</span></span><br><span class="line"><span class="regexp">                  注册</span></span><br><span class="line"><span class="regexp">                &lt;/</span>div&gt;</span><br><span class="line">              &lt;<span class="regexp">/Fragment&gt;</span></span><br><span class="line"><span class="regexp">            ) : (</span></span><br><span class="line"><span class="regexp">              &lt;Dropdown overlay=&#123;menu&#125;&gt;</span></span><br><span class="line"><span class="regexp">                &lt;div className="icon-header"&gt;</span></span><br><span class="line"><span class="regexp">                  &lt;Icon type="smile" className="icon-mine icon" theme="twoTone" /</span>&gt;</span><br><span class="line">                  &lt;span className=<span class="string">"user-name"</span>&gt;&#123;name&#125;&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">                  &lt;Icon type="caret-down" className="down icon" /</span>&gt;</span><br><span class="line">                &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">              &lt;/</span>Dropdown&gt;</span><br><span class="line">            )&#125;</span><br><span class="line">          &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>div&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"> </span></span><br><span class="line"><span class="regexp">const mapStateToProps = (state) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  return &#123;</span></span><br><span class="line"><span class="regexp">    userData: state.userData.data,</span></span><br><span class="line"><span class="regexp">  &#125;;</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default connect(mapStateToProps, null)(CommonHeader);</span></span><br></pre></td></tr></table></figure>
<h3 id="Layout"><a href="#Layout" class="headerlink" title="Layout"></a><code>Layout</code></h3><p>Layout组件就是大家的共享主页，也就是说在里面渲染了三个主要部分</p>
<p>1.NavBar</p>
<p>2.所有页面中的元素(继承props)</p>
<p>3.Footer（下图中最后一条暗带）</p>
<p>（忽略HelloWorld）这就是Layout组件的样子</p>
<p><img src="/2020/06/07/React%E6%A1%86%E6%9E%B6%E5%9C%A8%E4%BD%9C%E4%B8%9A%E5%BD%93%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/4.png" style="zoom: 67%;"></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./layout.scss'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Layout &#125; <span class="keyword">from</span> <span class="string">'antd'</span>;</span><br><span class="line"><span class="keyword">import</span> HeaderNav <span class="keyword">from</span> <span class="string">'../headerNav'</span>;</span><br><span class="line"><span class="comment">//Header,Footer,Content都是从 antd导入的Layout对象，就不用自己设计css了</span></span><br><span class="line"><span class="keyword">const</span> &#123; Header, Footer, Content &#125; = Layout;</span><br><span class="line">render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Layout className=<span class="string">"layout"</span>&gt;</span><br><span class="line">          &lt;Header className=<span class="string">"header"</span>&gt;</span><br><span class="line">            &lt;div className=<span class="string">"content-1200"</span>&gt;</span><br><span class="line">              &lt;HeaderNav /&gt;</span><br><span class="line">            &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">          &lt;/</span>Header&gt;</span><br><span class="line">          &lt;Content className=<span class="string">"main"</span>&gt;</span><br><span class="line">            &lt;div className=<span class="string">"content-1200"</span>&gt;</span><br><span class="line">              &#123;<span class="keyword">this</span>.props.children&#125;</span><br><span class="line">            &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">          &lt;/</span>Content&gt;</span><br><span class="line">          &lt;Footer className=<span class="string">"footer"</span>&gt;</span><br><span class="line">            &lt;div className=<span class="string">"content-1200"</span>&gt;</span><br><span class="line">              &lt;div className=<span class="string">"footer-content"</span> /&gt;</span><br><span class="line">            &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">          &lt;/</span>Footer&gt;</span><br><span class="line">        &lt;<span class="regexp">/Layout&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> CommonLayout;</span><br></pre></td></tr></table></figure>
<p>layout.scss表单在这里就不展示了。</p>
<h3 id="Loading"><a href="#Loading" class="headerlink" title="Loading"></a><code>Loading</code></h3><p>这就是一个当页面加载的时候转圈圈的组件，从antd导入即可</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Spin &#125; <span class="keyword">from</span> <span class="string">'antd'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Loading</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Spin /&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">export default Loading;</span></span><br></pre></td></tr></table></figure>
<h3 id="PrivateRoute"><a href="#PrivateRoute" class="headerlink" title="PrivateRoute"></a><code>PrivateRoute</code></h3><p>这就是一个私有路由，目的是<strong>不让未授权的用户得到我的展示页面</strong>。</p>
<p>实现逻辑在<a href="https://jasonxqh.github.io/2020/06/05/react基础4授权与部署/#Extracting-PrivateRoute">react基础4授权与部署的Extracting PrivateRoute</a>   章节中有详细说明。在这里仅仅展示代码，并不细说逻辑。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Route, Redirect &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getUserInfo &#125; <span class="keyword">from</span> <span class="string">'../../../store/login/actions'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrivateRoute</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">this</span>.props.getUserInfo();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="attr">component</span>: Component, userData, ...rest &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">const</span> &#123; isLogin &#125; = userData;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Route</span><br><span class="line">        &#123;...rest&#125;</span><br><span class="line">        render=&#123;(props) =&gt; &#123;</span><br><span class="line">          <span class="keyword">return</span> isLogin ? (</span><br><span class="line">            &lt;Component &#123;...props&#125; /&gt;</span><br><span class="line">          ) : (</span><br><span class="line">            &lt;Redirect</span><br><span class="line">              to=&#123;&#123;</span><br><span class="line">                pathname: <span class="string">'/login'</span>,</span><br><span class="line">                state: &#123; <span class="attr">from</span>: props.location &#125;,</span><br><span class="line">              &#125;&#125;</span><br><span class="line">            /&gt;</span><br><span class="line">          );</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function">(<span class="params">state, props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    userData: state.userData.data,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function">(<span class="params">dispatch</span>) =&gt;</span> (&#123;</span><br><span class="line">  getUserInfo: <span class="function"><span class="params">()</span> =&gt;</span> dispatch(getUserInfo()),</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps, mapDispatchToProps)(PrivateRoute);</span><br></pre></td></tr></table></figure>
<h2 id="页面部分"><a href="#页面部分" class="headerlink" title="页面部分"></a>页面部分</h2><h3 id="App-jsx"><a href="#App-jsx" class="headerlink" title="App.jsx"></a><code>App.jsx</code></h3><p>App组件是根组件所以我们单独讲。先上代码</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Suspense, lazy &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./style.scss'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; HashRouter <span class="keyword">as</span> Router, Route, Switch &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> PrivateRoute <span class="keyword">from</span> <span class="string">'./components/PrivateRoute'</span>;</span><br><span class="line"><span class="keyword">import</span> Loading <span class="keyword">from</span> <span class="string">'./components/loading'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Home = lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./home'</span>));</span><br><span class="line"><span class="keyword">const</span> Sign = lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./sign'</span>));</span><br><span class="line"><span class="keyword">const</span> Register = lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./register'</span>));</span><br><span class="line"><span class="keyword">const</span> Manage = lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./manage'</span>));</span><br><span class="line"><span class="keyword">const</span> Douban = lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./douban'</span>));</span><br><span class="line"><span class="keyword">const</span> Taobao = lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./taobao'</span>));</span><br><span class="line"><span class="keyword">const</span> Maoyan = lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./maoyan'</span>));</span><br><span class="line"><span class="keyword">const</span> Operas = lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./operas'</span>));</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Router&gt;</span><br><span class="line">        &lt;Suspense</span><br><span class="line">          fallback=&#123;<span class="comment">//这里如果等待的化，那么就加载上面所说的Loading组件</span></span><br><span class="line">            &lt;div className=<span class="string">"loading"</span>&gt;</span><br><span class="line">              &lt;Loading /&gt;</span><br><span class="line">            &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">          &#125;</span></span><br><span class="line"><span class="regexp">        &gt;</span></span><br><span class="line"><span class="regexp">          &lt;Switch&gt;</span></span><br><span class="line"><span class="regexp">            &lt;PrivateRoute exact path="/</span><span class="string">" component=&#123;Home&#125; /&gt;</span></span><br><span class="line"><span class="string">            &lt;PrivateRoute exact path="</span>/manage<span class="string">" component=&#123;Manage&#125; /&gt;</span></span><br><span class="line"><span class="string">            &lt;Route exact path="</span>/login<span class="string">" component=&#123;Sign&#125; /&gt;</span></span><br><span class="line"><span class="string">            &lt;Route exact path="</span>/register<span class="string">" component=&#123;Register&#125; /&gt;</span></span><br><span class="line"><span class="string">            &lt;PrivateRoute exact path="</span>/douban<span class="string">" component=&#123;Douban&#125; /&gt;</span></span><br><span class="line"><span class="string">            &lt;PrivateRoute exact path="</span>/taobao<span class="string">" component=&#123;Taobao&#125; /&gt;</span></span><br><span class="line"><span class="string">            &lt;PrivateRoute exact path="</span>/maoyan<span class="string">" component=&#123;Maoyan&#125; /&gt;</span></span><br><span class="line"><span class="string">            &lt;PrivateRoute exact path="</span>/operas<span class="string">" component=&#123;Operas&#125; /&gt;</span></span><br><span class="line"><span class="string">          &lt;/Switch&gt;</span></span><br><span class="line"><span class="string">        &lt;/Suspense&gt;</span></span><br><span class="line"><span class="string">      &lt;/Router&gt;</span></span><br><span class="line"><span class="string">    );</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">export default App;</span></span><br></pre></td></tr></table></figure>
<p><strong>这里需要讲几个问题：</strong></p>
<h4 id="lazy-Suspense-的作用"><a href="#lazy-Suspense-的作用" class="headerlink" title="lazy+Suspense 的作用"></a>lazy+Suspense 的作用</h4><p>在<a href="https://react.docschina.org/docs/code-splitting.html" target="_blank" rel="noopener">react官方文档</a>中我截取了一段</p>
<p><code>React.lazy</code> 函数能让你像渲染常规组件一样处理动态引入（的组件）。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> OtherComponent = React.lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./OtherComponent'</span>));</span><br></pre></td></tr></table></figure>
<p>此代码将会在组件首次渲染时，自动导入包含 <code>OtherComponent</code> 组件的包。</p>
<p><code>React.lazy</code> 接受一个函数，这个函数需要动态调用 <code>import()</code>。它必须返回一个 <code>Promise</code>，该 Promise 需要 resolve 一个 <code>default</code> export 的 React 组件。</p>
<p>然后应在 <code>Suspense</code> 组件中渲染 lazy 组件，如此使得我们可以使用在等待加载 lazy 组件时做优雅降级（如 loading 指示器等）。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Suspense &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> OtherComponent = React.lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./OtherComponent'</span>));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyComponent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;Suspense fallback=&#123;&lt;div&gt;Loading...&lt;<span class="regexp">/div&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">        &lt;OtherComponent /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>fallback</code> 属性接受任何在组件加载过程中你想展示的 React 元素。你可以将 <code>Suspense</code> 组件置于懒加载组件之上的任何位置。你甚至可以用一个 <code>Suspense</code> 组件包裹多个懒加载组件。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Suspense &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> OtherComponent = React.lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./OtherComponent'</span>));</span><br><span class="line"><span class="keyword">const</span> AnotherComponent = React.lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./AnotherComponent'</span>));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyComponent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;Suspense fallback=&#123;&lt;div&gt;Loading...&lt;<span class="regexp">/div&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">        &lt;section&gt;</span></span><br><span class="line"><span class="regexp">          &lt;OtherComponent /</span>&gt;</span><br><span class="line">          &lt;AnotherComponent /&gt;</span><br><span class="line">        &lt;<span class="regexp">/section&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>Suspense&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="Switch-exact"><a href="#Switch-exact" class="headerlink" title="Switch,exact"></a><code>Switch,exact</code></h4><p>在<a href="https://jasonxqh.github.io/2020/06/02/react基础2/#Switch">react基础2中的Switch</a>有详细提及</p>
<h4 id="PrivateRoute实现逻辑"><a href="#PrivateRoute实现逻辑" class="headerlink" title="PrivateRoute实现逻辑"></a><code>PrivateRoute</code>实现逻辑</h4><p>在<a href="https://jasonxqh.github.io/2020/06/05/react基础4授权与部署/#Protecting-Routes">react基础4授权与部署的Protecting Routes</a>中有详细提及</p>
<h3 id="登录页面与注册页面"><a href="#登录页面与注册页面" class="headerlink" title="登录页面与注册页面"></a>登录页面与注册页面</h3><p>登陆页面和注册页面的<strong>实现逻辑</strong>在<a href="https://jasonxqh.github.io/2020/06/05/react基础4授权与部署/">react基础4授权与部署</a> 中的花了<strong>大篇幅</strong>说明和实现(从<a href="https://jasonxqh.github.io/2020/06/05/react基础4授权与部署/#Registering-a-New-User">1.1.2. Registering a New User</a> 开始)。 </p>
<p><strong>不过还要插一嘴</strong>: 在博客中我们没有借助外部的库来实现提交表单，但这里我使用了antd中表单。具体学习博客可以参照</p>
<p><a href="https://www.jianshu.com/p/f8d3a8bcaf84" target="_blank" rel="noopener">antd中表单提交的基本使用</a></p>
<p>源码中用到的几个重要的api如下</p>
<h4 id="Form-create"><a href="#Form-create" class="headerlink" title="Form.create"></a><code>Form.create</code></h4><p>使用<code>Form.create({options})(Forgot)</code>包装组件，包装之后的组件会自动添加<code>this.props.form</code> 属性，该属性包含以下API：</p>
<ul>
<li><code>getFieldDecorator</code> ：用于和表单数据进行双向绑定，设置该表单类型为email，在<code>rules</code>中设置校验规则和提示信息。</li>
<li><code>validateFields</code>：获取输入域的数据和error，用于在提交前的判断。如果<code>!err</code>才可以提交。数据values就是<code>{email: a@qq.com}</code>这样的格式。传递给<code>handleConfirm</code>函数进行提交请求操作。</li>
</ul>
<h4 id="login-jsx"><a href="#login-jsx" class="headerlink" title="login.jsx"></a><code>login.jsx</code></h4><p> 为了讲解方便，我们把源代码拆成几个部分 </p>
<p><code>handleSubmit</code>部分</p>
<p>首先<code>e.preventDefault()</code>是阻止页面在提交表单的时候重新渲染</p>
<p>然后利用antd中的api，<code>form.validateFields</code>来进行验证，如果没有错的话，就发送一个dispatch一个 <strong>action</strong>给store，store再通过调用reducer，reducer把我们传入的登录信息渲染到state当中 然后返回，这样再login中就有本地的state信息了。（敲黑板的重点！）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Redirect &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; userLogin &#125; <span class="keyword">from</span> <span class="string">'../../store/login/actions'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Form, Icon, Input, Button &#125; <span class="keyword">from</span> <span class="string">'antd'</span>;</span><br><span class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">'../components/layout'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./style.scss'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginForm</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  componentDidMount() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  handleSubmit = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    <span class="keyword">this</span>.props.form.validateFields(<span class="function">(<span class="params">err, values</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">        <span class="keyword">this</span>.props.getUserLogin(values);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p><code>render</code>部分</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; getFieldDecorator &#125; = <span class="keyword">this</span>.props.form;</span><br><span class="line">    <span class="keyword">const</span> &#123; userData &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">const</span> &#123; isLogin &#125; = userData;</span><br><span class="line">    <span class="keyword">if</span> (isLogin) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Redirect</span> <span class="attr">to</span>=<span class="string">"/"</span> /&gt;</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> formItemLayout = &#123;</span><br><span class="line">      labelCol: &#123;</span><br><span class="line">        xs: &#123; <span class="attr">span</span>: <span class="number">24</span> &#125;,</span><br><span class="line">        sm: &#123; <span class="attr">span</span>: <span class="number">8</span> &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      wrapperCol: &#123;</span><br><span class="line">        xs: &#123; <span class="attr">span</span>: <span class="number">24</span> &#125;,</span><br><span class="line">        sm: &#123; <span class="attr">span</span>: <span class="number">16</span> &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> tailFormItemLayout = &#123;</span><br><span class="line">      wrapperCol: &#123;</span><br><span class="line">        xs: &#123;</span><br><span class="line">          span: <span class="number">24</span>,</span><br><span class="line">          offset: <span class="number">0</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        sm: &#123;</span><br><span class="line">          span: <span class="number">22</span>,</span><br><span class="line">          offset: <span class="number">2</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Layout&gt;</span><br><span class="line">        &lt;Form &#123;...formItemLayout&#125; onSubmit=&#123;<span class="keyword">this</span>.handleSubmit&#125; className=<span class="string">"login-form"</span>&gt;</span><br><span class="line">          &lt;Form.Item label=<span class="string">"用户名"</span> className=<span class="string">"item"</span>&gt;</span><br><span class="line">            &#123;getFieldDecorator(<span class="string">'name'</span>, &#123;</span><br><span class="line">              rules: [&#123; <span class="attr">required</span>: <span class="literal">true</span> &#125;],</span><br><span class="line">            &#125;)(</span><br><span class="line">              &lt;Input</span><br><span class="line">                size=<span class="string">"large"</span></span><br><span class="line">                prefix=&#123;&lt;Icon type=<span class="string">"user"</span> style=&#123;&#123; <span class="attr">color</span>: <span class="string">'rgba(0,0,0,.25)'</span> &#125;&#125; /&gt;&#125;</span><br><span class="line">                placeholder=<span class="string">"请输入用户名"</span></span><br><span class="line">              /&gt;,</span><br><span class="line">            )&#125;</span><br><span class="line">          &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Form.Item label="密码" className="item"&gt;</span></span><br><span class="line"><span class="regexp">            &#123;getFieldDecorator('password', &#123;</span></span><br><span class="line"><span class="regexp">              rules: [&#123; required: true &#125;],</span></span><br><span class="line"><span class="regexp">            &#125;)(</span></span><br><span class="line"><span class="regexp">              &lt;Input</span></span><br><span class="line"><span class="regexp">                size="large"</span></span><br><span class="line"><span class="regexp">                prefix=&#123;&lt;Icon type="lock" style=&#123;&#123; color: 'rgba(0,0,0,.25)' &#125;&#125; /</span>&gt;&#125;</span><br><span class="line">                type=<span class="string">"password"</span></span><br><span class="line">                placeholder=<span class="string">"请输入密码"</span></span><br><span class="line">              /&gt;,</span><br><span class="line">            )&#125;</span><br><span class="line">          &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Form.Item &#123;...tailFormItemLayout&#125; className="item"&gt;</span></span><br><span class="line"><span class="regexp">            &lt;Button size="large" type="primary" htmlType="submit" className="login-form-button"&gt;</span></span><br><span class="line"><span class="regexp">              登录</span></span><br><span class="line"><span class="regexp">            &lt;/</span>Button&gt;</span><br><span class="line">          &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>Form&gt;</span><br><span class="line">      &lt;<span class="regexp">/Layout&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const mapStateToProps = (state) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  return &#123;</span></span><br><span class="line"><span class="regexp">    userData: state.userData.data,</span></span><br><span class="line"><span class="regexp">  &#125;;</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp">const mapDispatchToProps = (dispatch) =&gt; (&#123;</span></span><br><span class="line"><span class="regexp">  getUserLogin: (params) =&gt; dispatch(userLogin(params)),</span></span><br><span class="line"><span class="regexp">&#125;);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const wrappedLoginForm = Form.create(&#123; name: 'login' &#125;)(LoginForm);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default connect(</span></span><br><span class="line"><span class="regexp">  mapStateToProps,</span></span><br><span class="line"><span class="regexp">  mapDispatchToProps,</span></span><br><span class="line"><span class="regexp">)(wrappedLoginForm);</span></span><br></pre></td></tr></table></figure>
<h4 id="register-jsx"><a href="#register-jsx" class="headerlink" title="register.jsx"></a><code>register.jsx</code></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Redirect &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createHashHistory &#125; <span class="keyword">from</span> <span class="string">'history'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Form, Icon, Input, Button, message &#125; <span class="keyword">from</span> <span class="string">'antd'</span>;</span><br><span class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">'../components/layout'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./style.scss'</span>;</span><br><span class="line"><span class="keyword">import</span> Api <span class="keyword">from</span> <span class="string">'../../js/Api'</span>;</span><br><span class="line"><span class="keyword">const</span> history = createHashHistory(&#123; <span class="attr">forceRefresh</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginForm</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  componentDidMount() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  handleSubmit = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    <span class="keyword">this</span>.props.form.validateFields(<span class="function">(<span class="params">err, values</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">        Api.post(<span class="string">'/users/register'</span>, values)</span><br><span class="line">          .then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (res.data) &#123;</span><br><span class="line">              message.success(<span class="string">'register success'</span>);</span><br><span class="line">              history.push(<span class="string">'/login'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">          .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(err);</span><br><span class="line">            message.error(err.message);</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p><code>render</code>部分：</p>
<p>表单渲染在上面也说了，这里就不再细讲了</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; getFieldDecorator &#125; = <span class="keyword">this</span>.props.form;</span><br><span class="line">    <span class="keyword">const</span> &#123; userData &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">const</span> &#123; isLogin &#125; = userData;</span><br><span class="line">    <span class="keyword">if</span> (isLogin) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Redirect</span> <span class="attr">to</span>=<span class="string">"/"</span> /&gt;</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> formItemLayout = &#123;</span><br><span class="line">      labelCol: &#123;</span><br><span class="line">        xs: &#123; <span class="attr">span</span>: <span class="number">24</span> &#125;,</span><br><span class="line">        sm: &#123; <span class="attr">span</span>: <span class="number">8</span> &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      wrapperCol: &#123;</span><br><span class="line">        xs: &#123; <span class="attr">span</span>: <span class="number">24</span> &#125;,</span><br><span class="line">        sm: &#123; <span class="attr">span</span>: <span class="number">16</span> &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> tailFormItemLayout = &#123;</span><br><span class="line">      wrapperCol: &#123;</span><br><span class="line">        xs: &#123;</span><br><span class="line">          span: <span class="number">24</span>,</span><br><span class="line">          offset: <span class="number">0</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        sm: &#123;</span><br><span class="line">          span: <span class="number">22</span>,</span><br><span class="line">          offset: <span class="number">2</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Layout&gt;</span><br><span class="line">        &lt;Form &#123;...formItemLayout&#125; onSubmit=&#123;<span class="keyword">this</span>.handleSubmit&#125; className=<span class="string">"login-form"</span>&gt;</span><br><span class="line">          &lt;Form.Item label=<span class="string">"用户名"</span> className=<span class="string">"item"</span>&gt;</span><br><span class="line">            &#123;getFieldDecorator(<span class="string">'name'</span>, &#123;</span><br><span class="line">              rules: [&#123; <span class="attr">required</span>: <span class="literal">true</span> &#125;],</span><br><span class="line">            &#125;)(</span><br><span class="line">              &lt;Input</span><br><span class="line">                size=<span class="string">"large"</span></span><br><span class="line">                prefix=&#123;&lt;Icon type=<span class="string">"user"</span> style=&#123;&#123; <span class="attr">color</span>: <span class="string">'rgba(0,0,0,.25)'</span> &#125;&#125; /&gt;&#125;</span><br><span class="line">                placeholder=<span class="string">"请输入用户名"</span></span><br><span class="line">              /&gt;,</span><br><span class="line">            )&#125;</span><br><span class="line">          &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Form.Item label="密码" className="item"&gt;</span></span><br><span class="line"><span class="regexp">            &#123;getFieldDecorator('password', &#123;</span></span><br><span class="line"><span class="regexp">              rules: [&#123; required: true &#125;],</span></span><br><span class="line"><span class="regexp">            &#125;)(</span></span><br><span class="line"><span class="regexp">              &lt;Input</span></span><br><span class="line"><span class="regexp">                size="large"</span></span><br><span class="line"><span class="regexp">                prefix=&#123;&lt;Icon type="lock" style=&#123;&#123; color: 'rgba(0,0,0,.25)' &#125;&#125; /</span>&gt;&#125;</span><br><span class="line">                type=<span class="string">"password"</span></span><br><span class="line">                placeholder=<span class="string">"请输入密码"</span></span><br><span class="line">              /&gt;,</span><br><span class="line">            )&#125;</span><br><span class="line">          &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Form.Item &#123;...tailFormItemLayout&#125; className="item"&gt;</span></span><br><span class="line"><span class="regexp">            &lt;Button size="large" type="primary" htmlType="submit" className="login-form-button"&gt;</span></span><br><span class="line"><span class="regexp">              注册</span></span><br><span class="line"><span class="regexp">            &lt;/</span>Button&gt;</span><br><span class="line">          &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>Form&gt;</span><br><span class="line">      &lt;<span class="regexp">/Layout&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const mapStateToProps = (state) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  return &#123;</span></span><br><span class="line"><span class="regexp">    userData: state.userData.data,</span></span><br><span class="line"><span class="regexp">  &#125;;</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const wrappedLoginForm = Form.create(&#123; name: 'login' &#125;)(LoginForm);</span></span><br><span class="line"><span class="regexp">export default connect(mapStateToProps, null)(wrappedLoginForm);</span></span><br></pre></td></tr></table></figure>
<h3 id="管理员的用户管理界面"><a href="#管理员的用户管理界面" class="headerlink" title="管理员的用户管理界面"></a>管理员的用户管理界面</h3><p>管理员界面和普通用户界面的区别就在于管理员多了一个用户管理页面可以删除别的用户的信息。这里我通过两个<code>jsx</code>文件实现，在主文件中存放<code>UserManage</code>组件，这样的写法让代码的层次更加分明简洁</p>
<p><code>index.jsx</code>,关于文件中Tabs的使用方法，参考<a href="https://ant-design.gitee.io/components/tabs-cn/" target="_blank" rel="noopener">antd的官方文档</a></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line">render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Layout&gt;</span><br><span class="line">        &lt;Tabs defaultActiveKey=<span class="string">"1"</span>&gt;</span><br><span class="line">          &lt;TabPane tab=<span class="string">"user management"</span> key=<span class="string">"1"</span>&gt;</span><br><span class="line">            &lt;UsersManage key=<span class="string">"user"</span> /&gt;</span><br><span class="line">          &lt;<span class="regexp">/TabPane&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>Tabs&gt;</span><br><span class="line">      &lt;<span class="regexp">/Layout&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/...</span></span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/07/React%E6%A1%86%E6%9E%B6%E5%9C%A8%E4%BD%9C%E4%B8%9A%E5%BD%93%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/5.png" style="zoom: 67%;"></p>
<h4 id="user-js"><a href="#user-js" class="headerlink" title="user.js"></a><code>user.js</code></h4><p>为了讲解方便我们把源码拆分成几个部分</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Table, Icon, Tooltip, message, Modal &#125; <span class="keyword">from</span> <span class="string">'antd'</span>;</span><br><span class="line"><span class="keyword">import</span> Util <span class="keyword">from</span> <span class="string">'../../js/Util'</span>;</span><br><span class="line"><span class="keyword">import</span> Api <span class="keyword">from</span> <span class="string">'../../js/Api'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./style.scss'</span>;</span><br><span class="line"><span class="keyword">const</span> &#123; confirm &#125; = Modal;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersManage</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      userListData: [],</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">this</span>.getUserList();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="getUserList实现逻辑"><a href="#getUserList实现逻辑" class="headerlink" title="getUserList实现逻辑:"></a><code>getUserList</code>实现逻辑:</h4><p>首先从获取token ，关于token是什么，在我的博客<a href="https://jasonxqh.github.io/2020/06/05/react基础4授权与部署/#Storing-the-JWT-JSON-Token">react基础4授权与部署的这个章节Storing the JWT(JSON Token)</a>以及后来的章节已经说的很清楚了，在此不赘述。</p>
<p>然后通过Api.get方法可参照 <a href="http://www.axios-js.com/zh-cn/docs/#axios-get-url-config-1" target="_blank" rel="noopener">axios官方文档</a> 。只有 <code>url</code> 是必需的。如果没有指定 <code>method</code>，请求将默认使用 <code>get</code> 方法。 <code>config</code> 是为请求提供的配置信息</p>
<p>在<a href="https://jasonxqh.github.io/2020/06/05/react基础4授权与部署/">react基础4授权与部署</a>中我们在头部传入一个token的方法是在后端进行修改，然后在头部中获得token然后存储到本地的。</p>
<p>这里我直接利用了axios.get,在请求头中加入token，也就是利用 headers: { Authorization: <code>Bearer ${token}</code> },只有当后端验证了这个token，他才肯把信息传过来嘛，是不是？</p>
<p>然后把response的内容，利用<code>setState</code>方法更新本地state，也就是现在，管理员就可以获得这个应用中用户的表单了</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">getUserList() &#123;</span><br><span class="line">  <span class="keyword">const</span> token = Util.getToken();</span><br><span class="line">  Api.get(<span class="string">'/users/list'</span>, &#123;</span><br><span class="line">    headers: &#123; <span class="attr">Authorization</span>: <span class="string">`Bearer <span class="subst">$&#123;token&#125;</span>`</span> &#125;,</span><br><span class="line">  &#125;).then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (res.data) &#123;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">        userListData: res.data.data,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="删除操作"><a href="#删除操作" class="headerlink" title="删除操作"></a>删除操作</h4><p>管理员利用删除操作可以删除用户信息。</p>
<p>这里我用了<a href="https://ant-design.gitee.io/components/modal-cn/" target="_blank" rel="noopener">antd库中的Modal对话框</a>中的确认对话框：<code>Modal.confirm</code></p>
<p>这里我截取了一段原文档</p>
<p><strong>何时使用？</strong></p>
<p>需要用户处理事务，又不希望跳转页面以致打断工作流程时，可以使用 <code>Modal</code> 在当前页面正中打开一个浮层，承载相应的操作。</p>
<p>另外当需要一个简洁的确认框询问用户时，可以使用 <code>Modal.confirm()</code> 等语法糖方法。</p>
<p>使用 <code>confirm()</code> 可以快捷地弹出确认框。<code>onCancel/onOk</code> 返回 promise 可以延迟关闭。</p>
<p><img src="/2020/06/07/React%E6%A1%86%E6%9E%B6%E5%9C%A8%E4%BD%9C%E4%B8%9A%E5%BD%93%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/7.png" style="zoom: 67%;"></p>
<p>通过观察confirm对话框，和对应的代码。我们可以清楚的看到<code>title</code>，<code>content</code>，<code>okText</code>,<code>okType</code>,<code>cancelText</code>分别对应了什么。我就不细说了。</p>
<p>那么我们如果点击cancel，那么相安无事。如果点击<code>onOk</code>，也就是confirm的话，那么就会有这样的操作：</p>
<p>首先获取到我这里管理员的token</p>
<p>其次获得一个url，通过这个url可以重置这个人的信息，把他所有的信息抹去。</p>
<p>利用<code>Api.post()</code>传入token，更新data,完成了删除用户的功能</p>
<p>然后判断返回的结果。这里涉及到后端</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">delete</span>(req, res) &#123;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> User.findByIdAndRemove(req.params.id);</span><br><span class="line">  res.status(<span class="number">201</span>).json(&#123; <span class="attr">data</span>: result &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果删除成功，那么就会返回201，附带一个<code>json</code>对象，我们前端通过判断有没有这个对象来判断是否删除成功</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除</span></span><br><span class="line">deleteUser = <span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> _this = <span class="keyword">this</span>;</span><br><span class="line">  confirm(&#123;</span><br><span class="line">    title: <span class="string">'Are you sure delete?'</span>,</span><br><span class="line">    content: <span class="string">'Hope you know what you are doing！'</span>,</span><br><span class="line">    okText: <span class="string">'confirm'</span>,</span><br><span class="line">    okType: <span class="string">'danger'</span>,</span><br><span class="line">    cancelText: <span class="string">'cancel'</span>,</span><br><span class="line">    onOk() &#123;</span><br><span class="line">      <span class="keyword">const</span> token = Util.getToken();</span><br><span class="line">      <span class="keyword">const</span> postUrl = <span class="string">`/users/<span class="subst">$&#123;item._id&#125;</span>/delete`</span>;</span><br><span class="line">      Api.post(</span><br><span class="line">        postUrl,</span><br><span class="line">        &#123;&#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          headers: &#123; <span class="attr">Authorization</span>: <span class="string">`Bearer <span class="subst">$&#123;token&#125;</span>`</span> &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      )</span><br><span class="line">        .then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(res);</span><br><span class="line">          <span class="keyword">if</span> (res.data) &#123;</span><br><span class="line">            message.success(<span class="string">'delete success'</span>);</span><br><span class="line">            _this.getUserList();</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            message.error(<span class="string">'fail'</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(err);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    onCancel() &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Cancel'</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="render渲染器部分"><a href="#render渲染器部分" class="headerlink" title="render渲染器部分"></a>render渲染器部分</h4><p><img src="/2020/06/07/React%E6%A1%86%E6%9E%B6%E5%9C%A8%E4%BD%9C%E4%B8%9A%E5%BD%93%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/8.png" style="zoom: 67%;"></p>
<p>搞懂了前面的函数逻辑，渲染器部分就很简单了。首先渲染初一张表格来，利用<a href="https://ant-design.gitee.io/components/table-cn/" target="_blank" rel="noopener">antd中的Table即可</a></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>bordered</th>
<th>是否展示外边框和列边框</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dataSource</code></td>
<td>数据数组</td>
</tr>
<tr>
<td><code>rowKey</code></td>
<td>表格行 key 的取值，可以是字符串或一个函数</td>
</tr>
<tr>
<td><code>columns</code></td>
<td>列描述数据对象，是 columns 中的一项，Column 使用相同的 <code>API</code>。</td>
</tr>
</tbody>
</table>
</div>
<p>注意最后一列，是一个条件渲染。如果<code>item.name</code> 是<code>admin</code>的话，渲染-- (因为<code>admin</code>不会自己删除自己) 否则就渲染一个删除icon，也是<code>antd</code>中引用过来的。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; userListData &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Table</span><br><span class="line">          bordered</span><br><span class="line">          dataSource=&#123;userListData&#125;</span><br><span class="line">          rowKey=&#123;(row) =&gt; row._id&#125;</span><br><span class="line">          columns=&#123;[</span><br><span class="line">            &#123;</span><br><span class="line">              title: <span class="string">'id'</span>,</span><br><span class="line">              dataIndex: <span class="string">'_id'</span>,</span><br><span class="line">              key: <span class="string">'_id'</span>,</span><br><span class="line">              align: <span class="string">'center'</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              title: <span class="string">'name'</span>,</span><br><span class="line">              dataIndex: <span class="string">'name'</span>,</span><br><span class="line">              key: <span class="string">'name'</span>,</span><br><span class="line">              align: <span class="string">'center'</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              title: <span class="string">'auth'</span>,</span><br><span class="line">              dataIndex: <span class="string">'auth'</span>,</span><br><span class="line">              key: <span class="string">'auth'</span>,</span><br><span class="line">              align: <span class="string">'center'</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              title: <span class="string">'handle'</span>,</span><br><span class="line">              key: <span class="string">'handle'</span>,</span><br><span class="line">              align: <span class="string">'center'</span>,</span><br><span class="line">              render: <span class="function">(<span class="params">row, item</span>) =&gt;</span> (</span><br><span class="line">                &lt;div className=<span class="string">"person-table-btn"</span>&gt;</span><br><span class="line">                  &#123;item.name !== <span class="string">'admin'</span> ? (</span><br><span class="line">                    &lt;Tooltip placement=<span class="string">"top"</span> title=&#123;<span class="string">'delete'</span>&#125;&gt;</span><br><span class="line">                      &lt;Icon</span><br><span class="line">                        type=<span class="string">"delete"</span></span><br><span class="line">                        theme=<span class="string">"twoTone"</span></span><br><span class="line">                        twoToneColor=<span class="string">"#eb2f96"</span></span><br><span class="line">                        className=<span class="string">"table-btn-item"</span></span><br><span class="line">                        onClick=&#123;() =&gt; <span class="keyword">this</span>.deleteUser(item)&#125;</span><br><span class="line">                      /&gt;</span><br><span class="line">                    &lt;<span class="regexp">/Tooltip&gt;</span></span><br><span class="line"><span class="regexp">                  ) : (</span></span><br><span class="line"><span class="regexp">                    '--'</span></span><br><span class="line"><span class="regexp">                  )&#125;</span></span><br><span class="line"><span class="regexp">                &lt;/</span>div&gt;</span><br><span class="line">              ),</span><br><span class="line">            &#125;,</span><br><span class="line">          ]&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">export default UsersManage;</span></span><br></pre></td></tr></table></figure>
<h3 id="以豆瓣为例的展示页面"><a href="#以豆瓣为例的展示页面" class="headerlink" title="以豆瓣为例的展示页面"></a>以豆瓣为例的展示页面</h3><p>因为4张表格只选择这一张作为我的例子，所以我打算详细讲一下内部逻辑.为了方便起见，我把源码拆分成几个部分分别讲解。</p>
<p><img src="/2020/06/07/React%E6%A1%86%E6%9E%B6%E5%9C%A8%E4%BD%9C%E4%B8%9A%E5%BD%93%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/6.png" style="zoom: 67%;"></p>
<p>需要了解<a href="http://www.axios-js.com/zh-cn/docs/#axios-get-url-config-1" target="_blank" rel="noopener">axios官方文档</a>中<code>axios.get</code></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="comment">//首先从antd中导入一些样式，表格，输入框，分页器，表单，按钮等等</span></span><br><span class="line"><span class="keyword">import</span> &#123; Table, Input, Button, Select, Pagination, Form, message &#125; <span class="keyword">from</span> <span class="string">'antd'</span>;</span><br><span class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">'../components/layout'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./style.scss'</span>;</span><br><span class="line"><span class="comment">//导入Api和Util Api是后端接出来的，我们前端只管调用就可以了</span></span><br><span class="line"><span class="keyword">import</span> Api <span class="keyword">from</span> <span class="string">'../../js/Api'</span>;</span><br><span class="line"><span class="keyword">import</span> Util <span class="keyword">from</span> <span class="string">'../../js/Util'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; Option &#125; = Select;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DouBan</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment"> state是这张表格本地的信息，current表示当前页面，total表示一张图标显示多少条信息</span></span><br><span class="line"><span class="comment"> label就是表头的信息，type就是搜索框的类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">      </span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      list: [],</span><br><span class="line">      current: <span class="number">1</span>,</span><br><span class="line">      total: <span class="number">10</span>,</span><br><span class="line">      label: [</span><br><span class="line">        &#123;</span><br><span class="line">          label: <span class="string">'电影名字'</span>,</span><br><span class="line">          value: <span class="string">'title'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          label: <span class="string">'评分'</span>,</span><br><span class="line">          value: <span class="string">'score'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          label: <span class="string">'国家'</span>,</span><br><span class="line">          value: <span class="string">'country'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          label: <span class="string">'标签'</span>,</span><br><span class="line">          value: <span class="string">'sort'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          label: <span class="string">'导演'</span>,</span><br><span class="line">          value: <span class="string">'director'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          label: <span class="string">'演员'</span>,</span><br><span class="line">          value: <span class="string">'actor'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          label: <span class="string">'上映时间'</span>,</span><br><span class="line">          value: <span class="string">'time'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">      type: [</span><br><span class="line">        &#123;</span><br><span class="line">          label: <span class="string">'AND'</span>,</span><br><span class="line">          value: <span class="string">'AND'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          label: <span class="string">'OR'</span>,</span><br><span class="line">          value: <span class="string">'OR'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="comment">//render()之后调用cdmhook来初始化表格</span></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">this</span>.initTableData();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="inimitable的逻辑"><a href="#inimitable的逻辑" class="headerlink" title="inimitable的逻辑"></a><code>inimitable</code>的逻辑</h4><p>首先获取到当前的token，然后通过请求头传递到后端去申请数据，后端调用的是<code>findAll</code>函数 (详见后端实现博客:<a href="https://jasonxqh.github.io/2020/06/08/Express框架在后端的应用/#getAll"> Express框架在后端的应用之getAll</a>，把返回的数据,也就是当前页的信息，对state进行更新。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">initTableData(current, sort) &#123;</span><br><span class="line">   <span class="keyword">const</span> token = Util.getToken();</span><br><span class="line">   Api.get(<span class="string">`/douban/list?page=<span class="subst">$&#123;current&#125;</span>&amp;sort=<span class="subst">$&#123;sort&#125;</span>`</span>, &#123;</span><br><span class="line">     headers: &#123; <span class="attr">Authorization</span>: <span class="string">`Bearer <span class="subst">$&#123;token&#125;</span>`</span> &#125;,</span><br><span class="line">   &#125;).then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="keyword">if</span> (res.data) &#123;</span><br><span class="line">       <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">         list: res.data.data,</span><br><span class="line">         total: res.data.total,</span><br><span class="line">       &#125;);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h4 id="onChange的逻辑"><a href="#onChange的逻辑" class="headerlink" title="onChange的逻辑"></a><code>onChange</code>的逻辑</h4><p>这个用在分页上。首先获得token，透过请求头进行传递。认证后将返回的data更新本地state，注意，因为分页了，所以还要更新current 为当前页</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">onChange = <span class="function">(<span class="params">page</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="keyword">const</span> token = Util.getToken();</span><br><span class="line">   Api.get(<span class="string">`/douban/list?page=<span class="subst">$&#123;page&#125;</span>`</span>, &#123; <span class="attr">headers</span>: &#123; <span class="attr">Authorization</span>: <span class="string">`Bearer <span class="subst">$&#123;token&#125;</span>`</span> &#125; &#125;).then(</span><br><span class="line">     (res) =&gt; &#123;</span><br><span class="line">       <span class="keyword">if</span> (res.data) &#123;</span><br><span class="line">         <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">           list: res.data.data,</span><br><span class="line">           total: res.data.total,</span><br><span class="line">           current: page,</span><br><span class="line">         &#125;);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">   );</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>
<h4 id="提交表单操作"><a href="#提交表单操作" class="headerlink" title="提交表单操作"></a>提交表单操作</h4><p>首先获取到token， <code>e.preventDefault()</code>;不让重新加载</p>
<p><code>validateFields</code>是验证表单的函数，这是antd提供的api ，是用于出发表单验证的</p>
<p>首先从values中解构初我们传入的信息</p>
<p><img src="/2020/06/07/React%E6%A1%86%E6%9E%B6%E5%9C%A8%E4%BD%9C%E4%B8%9A%E5%BD%93%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/9.png" style="zoom: 67%;"></p>
<p>也就是这五个框框。然后写我们的验证逻辑。</p>
<ol>
<li>label1 不能等于label2</li>
<li>如果type=AND，就说明两个条件都要满足，type=OR那么只满足一个条件即可.这里我不谈后端如何实现。因为有专门的博客<a href="https://jasonxqh.github.io/2020/06/08/Express框架在后端的应用/#more">Express框架在后端的应用</a>来介绍，然后把返回的结果更新到本地的state当中</li>
<li>如果是AND请求，那么我需要请求<code>/douban/getList</code> ，在这里后端会调用 <code>getListByKey</code>函数 ，在<a href="https://jasonxqh.github.io/2020/06/08/Express框架在后端的应用/#douban-js-2">Express框架在后端的应用douban.js中有所介绍</a>，返回两者皆满足的信息</li>
<li>如果是OR请求，那么我需要请求<code>/douban/getListOr</code>,在这里后端会调用<code>getListByOr</code>函数，在<a href="https://jasonxqh.github.io/2020/06/08/Express框架在后端的应用/#douban-js-2">Express框架在后端的应用douban.js中有所介绍</a>，返回两者择一满足的信息</li>
<li>同时，我们要满足选择的时候要排序这个功能，那么我们需要在req中加上sort的类型</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">handleSubmit = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; sort &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">  <span class="keyword">const</span> token = Util.getToken();</span><br><span class="line">  e.preventDefault();</span><br><span class="line">  <span class="keyword">this</span>.props.form.validateFields(<span class="function">(<span class="params">err, values</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; label1, value1, type, label2, value2 &#125; = values;</span><br><span class="line">      <span class="keyword">if</span> (label1 === label2) &#123;</span><br><span class="line">        message.error(<span class="string">'两个查询字段不可重复！'</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> keyWords = <span class="string">`<span class="subst">$&#123;label1&#125;</span>=<span class="subst">$&#123;value1&#125;</span>&amp;<span class="subst">$&#123;label2&#125;</span>=<span class="subst">$&#123;value2&#125;</span>`</span>;</span><br><span class="line">        <span class="keyword">if</span> (type === <span class="string">'AND'</span>) &#123;</span><br><span class="line">          Api.get(<span class="string">`/douban/getList?<span class="subst">$&#123;keyWords&#125;</span>&amp;sort=<span class="subst">$&#123;sort&#125;</span>`</span>, &#123;</span><br><span class="line">            headers: &#123; <span class="attr">Authorization</span>: <span class="string">`Bearer <span class="subst">$&#123;token&#125;</span>`</span> &#125;,</span><br><span class="line">          &#125;).then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (res.data) &#123;</span><br><span class="line">              <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">                list: res.data.data,</span><br><span class="line">                total: res.data.total,</span><br><span class="line">                current: <span class="number">1</span>,</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          Api.get(<span class="string">`/douban/getListOr?<span class="subst">$&#123;keyWords&#125;</span>`</span>, &#123;</span><br><span class="line">            headers: &#123; <span class="attr">Authorization</span>: <span class="string">`Bearer <span class="subst">$&#123;token&#125;</span>&amp;sort=<span class="subst">$&#123;sort&#125;</span>`</span> &#125;,</span><br><span class="line">          &#125;).then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (res.data) &#123;</span><br><span class="line">              <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">                list: res.data.data,</span><br><span class="line">                total: res.data.total,</span><br><span class="line">                current: <span class="number">1</span>,</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="重置操作"><a href="#重置操作" class="headerlink" title="重置操作"></a>重置操作</h4><p><code>resetFields</code> 会重置整个 Field，因而其子组件也会重新 mount<br>从而消除自定义组件可能存在的副作用（例如异步数据、状态等等）<br>然后调用<code>initTableData</code>函数初始化 </p>
<p>最后别忘了设置current=1，否则下面的分页器还停留在原来的位置，但是表格已经回到了首页</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">reset() &#123;</span><br><span class="line">  <span class="keyword">this</span>.props.form.resetFields();</span><br><span class="line">  <span class="keyword">this</span>.initTableData();</span><br><span class="line">  <span class="keyword">this</span>.state.current = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="排序操作"><a href="#排序操作" class="headerlink" title="排序操作"></a>排序操作</h4><p>后端排序和前端排序不太一样，前端排序的逻辑在<a href="https://jasonxqh.github.io/2020/06/02/react基础2/#Sorting-Extracting-MoviesTable-封装MoviesTable">react基础2中的sort</a>已经提到了</p>
<p>而后端排序则是前端发送一个request到后端，后端根据前端的sort种类来进行排序，再把数据返回</p>
<p>这里是一个更新State中sort种类的函数，默认sort为null，也就是不排序</p>
<p>后端排序的逻辑在这里实现: <a href="https://jasonxqh.github.io/2020/06/08/Express框架在后端的应用/#findAll-1">后端排序findAll</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sort(type) &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(</span><br><span class="line">      &#123;</span><br><span class="line">        sort: type,</span><br><span class="line">      &#125;,</span><br><span class="line">      () =&gt; &#123;</span><br><span class="line">        <span class="keyword">this</span>.initTableData(<span class="literal">null</span>, type);</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>随后，我们在<code>initTableData</code>函数当中发送我们的sort请求</p>
<p>在排序过程中出现了一些小插曲，一开始我是根据字符串大小排序的。但是修改了变量类型之后，问题解决了</p>
<p>我们看到排序过后，价格是按照数字排序的，而不是字符串大小排序的。</p>
<p><img src="/2020/06/07/React%E6%A1%86%E6%9E%B6%E5%9C%A8%E4%BD%9C%E4%B8%9A%E5%BD%93%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/11.png" style="zoom: 67%;"></p>
<h4 id="render渲染器"><a href="#render渲染器" class="headerlink" title="render渲染器"></a>render渲染器</h4><p>首先解构state和form(antd)</p>
<p>然后渲染选择框：</p>
<ol>
<li>第一个请选择查询字段的选择框：<code>getFieldDecorator</code>用户和表单进行双向绑定。 required: true是必须要填(如果想提交) ，然后就是一个选择框，默认占位符是请选择查询的字段。然后把label数组中信息的都渲染到下拉选择表单当中</li>
<li>第二个是输入框，也是必须要填的，也就是我们想搜索的内容</li>
<li>第三个框是选择查询类型，这里可以是AND，可以为OR，因为渲染的是type数组</li>
<li>第四第五个的逻辑和第一第二个一样</li>
<li>然后是查询和充值按钮，点击后分别触发<code>handleSubmit()</code>和<code>reset()</code></li>
<li>最后是一个分页器</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; getFieldDecorator &#125; = <span class="keyword">this</span>.props.form;</span><br><span class="line">    <span class="keyword">const</span> &#123; list, total, current, label, type &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">      </span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Layout&gt;</span><br><span class="line">&#123;<span class="comment">/*</span></span><br><span class="line"><span class="comment">导出部分分为两大组件，分别是搜索框和表格Tablebody部分</span></span><br><span class="line"><span class="comment">*/</span>&#125;          </span><br><span class="line">          &lt;div className=<span class="string">"search"</span>&gt;</span><br><span class="line">            &lt;Form layout=<span class="string">"inline"</span> onSubmit=&#123;<span class="keyword">this</span>.handleSubmit&#125;&gt;</span><br><span class="line">              &lt;Form.Item className=<span class="string">"item"</span>&gt;</span><br><span class="line">                &#123;getFieldDecorator(<span class="string">'label1'</span>, &#123;</span><br><span class="line">                  rules: [</span><br><span class="line">                    &#123;</span><br><span class="line">                      required: <span class="literal">true</span>,</span><br><span class="line">                    &#125;,</span><br><span class="line">                  ],</span><br><span class="line">                &#125;)(</span><br><span class="line">                  &lt;Select placeholder=<span class="string">"请选择查询的字段"</span> style=&#123;&#123; <span class="attr">width</span>: <span class="string">'200px'</span> &#125;&#125;&gt;</span><br><span class="line">                    &#123;label.map(<span class="function">(<span class="params">item</span>) =&gt;</span> (</span><br><span class="line">                      &lt;Option value=&#123;item.value&#125; key=&#123;item.label&#125; label=&#123;item.label&#125;&gt;</span><br><span class="line">                        &#123;item.label&#125;</span><br><span class="line">                      &lt;<span class="regexp">/Option&gt;</span></span><br><span class="line"><span class="regexp">                    ))&#125;</span></span><br><span class="line"><span class="regexp">                  &lt;/</span>Select&gt;,</span><br><span class="line">                )&#125;</span><br><span class="line">              &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">              &lt;Form.Item className="item"&gt;</span></span><br><span class="line"><span class="regexp">                &#123;getFieldDecorator('value1', &#123;</span></span><br><span class="line"><span class="regexp">                  rules: [&#123; required: true &#125;],</span></span><br><span class="line"><span class="regexp">                &#125;)(&lt;Input size="default" /</span>&gt;)&#125;</span><br><span class="line">              &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">              &lt;Form.Item className="item"&gt;</span></span><br><span class="line"><span class="regexp">                &#123;getFieldDecorator('type', &#123;</span></span><br><span class="line"><span class="regexp">                  rules: [</span></span><br><span class="line"><span class="regexp">                    &#123;</span></span><br><span class="line"><span class="regexp">                      required: true,</span></span><br><span class="line"><span class="regexp">                    &#125;,</span></span><br><span class="line"><span class="regexp">                  ],</span></span><br><span class="line"><span class="regexp">                &#125;)(</span></span><br><span class="line"><span class="regexp">                  &lt;Select placeholder="查询类型" style=&#123;&#123; width: '150px' &#125;&#125;&gt;</span></span><br><span class="line"><span class="regexp">                    &#123;type.map((item) =&gt; (</span></span><br><span class="line"><span class="regexp">                      &lt;Option value=&#123;item.value&#125; key=&#123;item.label&#125; label=&#123;item.label&#125;&gt;</span></span><br><span class="line"><span class="regexp">                        &#123;item.label&#125;</span></span><br><span class="line"><span class="regexp">                      &lt;/</span>Option&gt;</span><br><span class="line">                    ))&#125;</span><br><span class="line">                  &lt;<span class="regexp">/Select&gt;,</span></span><br><span class="line"><span class="regexp">                )&#125;</span></span><br><span class="line"><span class="regexp">              &lt;/</span>Form.Item&gt;</span><br><span class="line">              &lt;Form.Item className=<span class="string">"item"</span>&gt;</span><br><span class="line">                &#123;getFieldDecorator(<span class="string">'label2'</span>, &#123;</span><br><span class="line">                  rules: [</span><br><span class="line">                    &#123;</span><br><span class="line">                      required: <span class="literal">true</span>,</span><br><span class="line">                    &#125;,</span><br><span class="line">                  ],</span><br><span class="line">                &#125;)(</span><br><span class="line">                  &lt;Select placeholder=<span class="string">"请选择查询的字段"</span> style=&#123;&#123; <span class="attr">width</span>: <span class="string">'200px'</span> &#125;&#125;&gt;</span><br><span class="line">                    &#123;label.map(<span class="function">(<span class="params">item</span>) =&gt;</span> (</span><br><span class="line">                      &lt;Option value=&#123;item.value&#125; key=&#123;item.label&#125; label=&#123;item.label&#125;&gt;</span><br><span class="line">                        &#123;item.label&#125;</span><br><span class="line">                      &lt;<span class="regexp">/Option&gt;</span></span><br><span class="line"><span class="regexp">                    ))&#125;</span></span><br><span class="line"><span class="regexp">                  &lt;/</span>Select&gt;,</span><br><span class="line">                )&#125;</span><br><span class="line">              &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">              &lt;Form.Item className="item"&gt;</span></span><br><span class="line"><span class="regexp">                &#123;getFieldDecorator('value2', &#123;</span></span><br><span class="line"><span class="regexp">                  rules: [&#123; required: true &#125;],</span></span><br><span class="line"><span class="regexp">                &#125;)(&lt;Input size="default" /</span>&gt;)&#125;</span><br><span class="line">              &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">              &lt;Form.Item className="item"&gt;</span></span><br><span class="line"><span class="regexp">                &lt;Button size="default" type="primary" htmlType="submit"&gt;</span></span><br><span class="line"><span class="regexp">                  查询</span></span><br><span class="line"><span class="regexp">                &lt;/</span>Button&gt;</span><br><span class="line">                &lt;Button size=<span class="string">"default"</span> type=<span class="string">"primary"</span> onClick=&#123;() =&gt; <span class="keyword">this</span>.reset()&#125; style=&#123;&#123;<span class="attr">marginLeft</span>: <span class="string">'10px'</span>&#125;&#125;&gt;</span><br><span class="line">                  重置</span><br><span class="line">                &lt;<span class="regexp">/Button&gt;</span></span><br><span class="line"><span class="regexp">              &lt;/</span>Form.Item&gt;</span><br><span class="line">            &lt;<span class="regexp">/Form&gt;</span></span><br><span class="line"><span class="regexp">              &lt;Button</span></span><br><span class="line"><span class="regexp">              type=&#123;sort === "normal" ? "primary" : ""&#125;</span></span><br><span class="line"><span class="regexp">              style=&#123;&#123; marginRight: "10px" &#125;&#125;</span></span><br><span class="line"><span class="regexp">              onClick=&#123;() =&gt; this.sort("normal")&#125;</span></span><br><span class="line"><span class="regexp">            &gt;</span></span><br><span class="line"><span class="regexp">              分数从高到低</span></span><br><span class="line"><span class="regexp">            &lt;/</span>Button&gt;</span><br><span class="line">            &lt;Button</span><br><span class="line">              type=&#123;sort === <span class="string">"reverse"</span> ? <span class="string">"primary"</span> : <span class="string">""</span>&#125;</span><br><span class="line">              onClick=&#123;() =&gt; <span class="keyword">this</span>.sort(<span class="string">"reverse"</span>)&#125;</span><br><span class="line">              style=&#123;&#123; <span class="attr">marginRight</span>: <span class="string">"10px"</span> &#125;&#125;</span><br><span class="line">            &gt;</span><br><span class="line">              分数从低到高</span><br><span class="line">            &lt;<span class="regexp">/Button&gt;</span></span><br><span class="line"><span class="regexp">          &lt;/</span>div&gt;</span><br><span class="line"></span><br><span class="line">          &lt;div&gt;</span><br><span class="line">            &lt;div style=&#123;&#123; <span class="attr">display</span>: <span class="string">'flex'</span> &#125;&#125;&gt;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">            &lt;Table /</span><span class="regexp">/渲染表格</span></span><br><span class="line"><span class="regexp">              bordered</span></span><br><span class="line"><span class="regexp">              dataSource=&#123;list&#125;</span></span><br><span class="line"><span class="regexp">              rowKey=&#123;(row) =&gt; row._id&#125;</span></span><br><span class="line"><span class="regexp">              pagination=&#123;false&#125;</span></span><br><span class="line"><span class="regexp">                /</span><span class="regexp">/列</span></span><br><span class="line"><span class="regexp">              columns=&#123;[</span></span><br><span class="line"><span class="regexp">                &#123;</span></span><br><span class="line"><span class="regexp">                  title: '电影名字',</span></span><br><span class="line"><span class="regexp">                  dataIndex: 'title',</span></span><br><span class="line"><span class="regexp">                  key: 'title',</span></span><br><span class="line"><span class="regexp">                  align: 'center',</span></span><br><span class="line"><span class="regexp">                &#125;,</span></span><br><span class="line"><span class="regexp">                &#123;</span></span><br><span class="line"><span class="regexp">                  title: '导演',</span></span><br><span class="line"><span class="regexp">                  dataIndex: 'director',</span></span><br><span class="line"><span class="regexp">                  key: 'director',</span></span><br><span class="line"><span class="regexp">                  align: 'center',</span></span><br><span class="line"><span class="regexp">                &#125;,</span></span><br><span class="line"><span class="regexp">                &#123;</span></span><br><span class="line"><span class="regexp">                  title: '演员',</span></span><br><span class="line"><span class="regexp">                  dataIndex: 'actor',</span></span><br><span class="line"><span class="regexp">                  key: 'actor',</span></span><br><span class="line"><span class="regexp">                  align: 'center',</span></span><br><span class="line"><span class="regexp">                  // width: 600,</span></span><br><span class="line"><span class="regexp">                &#125;,</span></span><br><span class="line"><span class="regexp">                &#123;</span></span><br><span class="line"><span class="regexp">                  title: '国家',</span></span><br><span class="line"><span class="regexp">                  dataIndex: 'country',</span></span><br><span class="line"><span class="regexp">                  key: 'country',</span></span><br><span class="line"><span class="regexp">                  align: 'center',</span></span><br><span class="line"><span class="regexp">                  width: 100,</span></span><br><span class="line"><span class="regexp">                &#125;,</span></span><br><span class="line"><span class="regexp">                &#123;</span></span><br><span class="line"><span class="regexp">                  title: '标签',</span></span><br><span class="line"><span class="regexp">                  dataIndex: 'sort',</span></span><br><span class="line"><span class="regexp">                  key: 'sort',</span></span><br><span class="line"><span class="regexp">                  align: 'center',</span></span><br><span class="line"><span class="regexp">                  width: 200,</span></span><br><span class="line"><span class="regexp">                &#125;,</span></span><br><span class="line"><span class="regexp">                &#123;</span></span><br><span class="line"><span class="regexp">                  title: '评分',</span></span><br><span class="line"><span class="regexp">                  dataIndex: 'score',</span></span><br><span class="line"><span class="regexp">                  key: 'score',</span></span><br><span class="line"><span class="regexp">                  align: 'center',</span></span><br><span class="line"><span class="regexp">                &#125;,</span></span><br><span class="line"><span class="regexp">                &#123;</span></span><br><span class="line"><span class="regexp">                  title: '上映时间',</span></span><br><span class="line"><span class="regexp">                  dataIndex: 'time',</span></span><br><span class="line"><span class="regexp">                  key: 'time',</span></span><br><span class="line"><span class="regexp">                  align: 'center',</span></span><br><span class="line"><span class="regexp">                &#125;,</span></span><br><span class="line"><span class="regexp">              ]&#125;</span></span><br><span class="line"><span class="regexp">            /</span>&gt;</span><br><span class="line">            &lt;Pagination</span><br><span class="line">             <span class="comment">//分页器，在react基础2分页部分有具体实现，这里直接引用了antd中的分页器样式 </span></span><br><span class="line">              style=&#123;&#123; <span class="attr">marginTop</span>: <span class="string">'20px'</span> &#125;&#125;</span><br><span class="line">              defaultPageSize=&#123;<span class="number">10</span>&#125;</span><br><span class="line">              current=&#123;current&#125;</span><br><span class="line">              onChange=&#123;<span class="keyword">this</span>.onChange&#125;</span><br><span class="line">              total=&#123;total&#125;</span><br><span class="line">            /&gt;</span><br><span class="line">          &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>Layout&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const mapStateToProps = (state) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  return &#123;</span></span><br><span class="line"><span class="regexp">    userData: state.userData.data,</span></span><br><span class="line"><span class="regexp">  &#125;;</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const wrappedDouBanForm = Form.create(&#123; name: 'douban' &#125;)(DouBan);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default connect(mapStateToProps, null)(wrappedDouBanForm);</span></span><br></pre></td></tr></table></figure>
<h3 id="Operas-jsx-新建表单"><a href="#Operas-jsx-新建表单" class="headerlink" title="Operas.jsx 新建表单"></a><code>Operas.jsx</code> 新建表单</h3><p>剩下的三张表中，猫眼和淘宝咖啡都可以进行一些排序（分数，价格）。 但是Opera表格却没有什么可以排序的</p>
<p>所以我就在operas.jsx中新加入了一个创建新剧的功能</p>
<p><img src="/2020/06/07/React%E6%A1%86%E6%9E%B6%E5%9C%A8%E4%BD%9C%E4%B8%9A%E5%BD%93%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/12.png" style="zoom: 67%;"></p>
<p>点击新建按钮，我们会跳转一个表单</p>
<p><img src="/2020/06/07/React%E6%A1%86%E6%9E%B6%E5%9C%A8%E4%BD%9C%E4%B8%9A%E5%BD%93%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/13.png" style="zoom: 67%;"></p>
<p>然后我们输入我们想要创建的新电视剧</p>
<p>比如：</p>
<p><img src="/2020/06/07/React%E6%A1%86%E6%9E%B6%E5%9C%A8%E4%BD%9C%E4%B8%9A%E5%BD%93%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/14.png" style="zoom: 67%;"></p>
<p>因为单集片长可选填，所以这里就暂时不填</p>
<p>点击创建后，我们就可以在表中查询到这条电视剧信息啦！</p>
<p><img src="/2020/06/07/React%E6%A1%86%E6%9E%B6%E5%9C%A8%E4%BD%9C%E4%B8%9A%E5%BD%93%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/15.png" style="zoom: 67%;"></p>
<h4 id="实现逻辑"><a href="#实现逻辑" class="headerlink" title="实现逻辑"></a>实现逻辑</h4><p>后端逻辑请移步</p>
<p>首先新建一个operaform的表格，用于存放我们的表单</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Redirect &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createHashHistory &#125; <span class="keyword">from</span> <span class="string">'history'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Form, Icon, Input, Button, message &#125; <span class="keyword">from</span> <span class="string">'antd'</span>;</span><br><span class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">'../components/layout'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./style.scss'</span>;</span><br><span class="line"><span class="keyword">import</span> Api <span class="keyword">from</span> <span class="string">'../../js/Api'</span>;</span><br><span class="line"><span class="keyword">const</span> history = createHashHistory(&#123; <span class="attr">forceRefresh</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MovieForm</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  componentDidMount() &#123;&#125;</span><br><span class="line"><span class="comment">// 提交表单操作，我们利用post这个api新建一条信息，然后如果新建成功的话就跳转到operas界面</span></span><br><span class="line">  handleSubmit = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    <span class="keyword">this</span>.props.form.validateFields(<span class="function">(<span class="params">err, values</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">        Api.post(<span class="string">'/operas/create'</span>, values)</span><br><span class="line">          .then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (res.data) &#123;</span><br><span class="line">              message.success(<span class="string">'create successfully'</span>);</span><br><span class="line">              history.push(<span class="string">'/operas'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">          .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(err);</span><br><span class="line">            message.error(err.message);</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; getFieldDecorator &#125; = <span class="keyword">this</span>.props.form;</span><br><span class="line">    <span class="keyword">const</span> &#123; userData &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">const</span> &#123; isLogin &#125; = userData;</span><br><span class="line">    <span class="keyword">const</span> formItemLayout = &#123;</span><br><span class="line">      labelCol: &#123;</span><br><span class="line">        xs: &#123; <span class="attr">span</span>: <span class="number">24</span> &#125;,</span><br><span class="line">        sm: &#123; <span class="attr">span</span>: <span class="number">8</span> &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      wrapperCol: &#123;</span><br><span class="line">        xs: &#123; <span class="attr">span</span>: <span class="number">24</span> &#125;,</span><br><span class="line">        sm: &#123; <span class="attr">span</span>: <span class="number">16</span> &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> tailFormItemLayout = &#123;</span><br><span class="line">      wrapperCol: &#123;</span><br><span class="line">        xs: &#123;</span><br><span class="line">          span: <span class="number">24</span>,</span><br><span class="line">          offset: <span class="number">0</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        sm: &#123;</span><br><span class="line">          span: <span class="number">22</span>,</span><br><span class="line">          offset: <span class="number">2</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Layout&gt;</span><br><span class="line">        &lt;h1 className=<span class="string">"title"</span>&gt;快来创建最新的电视剧吧！&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">        &lt;Form &#123;...formItemLayout&#125; onSubmit=&#123;this.handleSubmit&#125; className="login-form"&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Form.Item label="剧集名字" className="item"&gt;</span></span><br><span class="line"><span class="regexp">            &#123;getFieldDecorator('title', &#123;</span></span><br><span class="line"><span class="regexp">              rules: [&#123; required: true &#125;],</span></span><br><span class="line"><span class="regexp">            &#125;)(</span></span><br><span class="line"><span class="regexp">              &lt;Input</span></span><br><span class="line"><span class="regexp">                size="large"</span></span><br><span class="line"><span class="regexp">                placeholder="剧集名字"</span></span><br><span class="line"><span class="regexp">              /</span>&gt;,</span><br><span class="line">            )&#125;</span><br><span class="line">          &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Form.Item label="演员" className="item"&gt;</span></span><br><span class="line"><span class="regexp">            &#123;getFieldDecorator('actors', &#123;</span></span><br><span class="line"><span class="regexp">              rules: [&#123; required: true &#125;],</span></span><br><span class="line"><span class="regexp">            &#125;)(</span></span><br><span class="line"><span class="regexp">              &lt;Input</span></span><br><span class="line"><span class="regexp">                size="large"</span></span><br><span class="line"><span class="regexp">                placeholder="演员"</span></span><br><span class="line"><span class="regexp">              /</span>&gt;,</span><br><span class="line">            )&#125;</span><br><span class="line">          &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Form.Item label="国家" className="item"&gt;</span></span><br><span class="line"><span class="regexp">            &#123;getFieldDecorator('country', &#123;</span></span><br><span class="line"><span class="regexp">              rules: [&#123; required: true &#125;],</span></span><br><span class="line"><span class="regexp">            &#125;)(</span></span><br><span class="line"><span class="regexp">              &lt;Input</span></span><br><span class="line"><span class="regexp">                size="large"</span></span><br><span class="line"><span class="regexp">                placeholder="国家"</span></span><br><span class="line"><span class="regexp">              /</span>&gt;,</span><br><span class="line">            )&#125;</span><br><span class="line">          &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Form.Item label="类型" className="item"&gt;</span></span><br><span class="line"><span class="regexp">            &#123;getFieldDecorator('type', &#123;</span></span><br><span class="line"><span class="regexp">              rules: [&#123; required: true &#125;],</span></span><br><span class="line"><span class="regexp">            &#125;)(</span></span><br><span class="line"><span class="regexp">              &lt;Input</span></span><br><span class="line"><span class="regexp">                size="large"</span></span><br><span class="line"><span class="regexp">                placeholder="类型:"</span></span><br><span class="line"><span class="regexp">              /</span>&gt;,</span><br><span class="line">            )&#125;</span><br><span class="line">          &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Form.Item label="单集片长" className="item"&gt;</span></span><br><span class="line"><span class="regexp">            &#123;getFieldDecorator('single', &#123;</span></span><br><span class="line"><span class="regexp">              rules: [&#123; required: false &#125;],</span></span><br><span class="line"><span class="regexp">            &#125;)(</span></span><br><span class="line"><span class="regexp">              &lt;Input</span></span><br><span class="line"><span class="regexp">                size="large"</span></span><br><span class="line"><span class="regexp">                placeholder="单集片长:"</span></span><br><span class="line"><span class="regexp">              /</span>&gt;,</span><br><span class="line">            )&#125;</span><br><span class="line">          &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Form.Item label="首播时间" className="item"&gt;</span></span><br><span class="line"><span class="regexp">            &#123;getFieldDecorator('first_date', &#123;</span></span><br><span class="line"><span class="regexp">              rules: [&#123; required: false &#125;],</span></span><br><span class="line"><span class="regexp">            &#125;)(</span></span><br><span class="line"><span class="regexp">              &lt;Input</span></span><br><span class="line"><span class="regexp">                size="large"</span></span><br><span class="line"><span class="regexp">                placeholder="首播时间:"</span></span><br><span class="line"><span class="regexp">              /</span>&gt;,</span><br><span class="line">            )&#125;</span><br><span class="line">          &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Form.Item &#123;...tailFormItemLayout&#125; className="item"&gt;</span></span><br><span class="line"><span class="regexp">            &lt;Button size="large" type="primary" htmlType="submit" className="login-form-button"&gt;</span></span><br><span class="line"><span class="regexp">              创建</span></span><br><span class="line"><span class="regexp">            &lt;/</span>Button&gt;</span><br><span class="line">          &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>Form&gt;</span><br><span class="line">      &lt;<span class="regexp">/Layout&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const mapStateToProps = (state) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  return &#123;</span></span><br><span class="line"><span class="regexp">    userData: state.userData.data,</span></span><br><span class="line"><span class="regexp">  &#125;;</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const wrappedMovieForm = Form.create(&#123; name: 'MovieForm' &#125;)(MovieForm);</span></span><br><span class="line"><span class="regexp">export default connect(mapStateToProps, null)(wrappedMovieForm);</span></span><br></pre></td></tr></table></figure>
<p>其次在<code>operas.jsx</code>中新建一个button，用于跳转</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">//...</span></span><br><span class="line">  createForm() &#123;</span><br><span class="line">    history.push(<span class="string">"/operas/create"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&lt;Button</span><br><span class="line">  size=<span class="string">"default"</span></span><br><span class="line">  type=<span class="string">"primary"</span></span><br><span class="line">  onClick=&#123;() =&gt; <span class="keyword">this</span>.createForm()&#125;</span><br><span class="line">  style=&#123;&#123; <span class="attr">marginLeft</span>: <span class="string">"10px"</span> &#125;&#125;</span><br><span class="line">&gt;</span><br><span class="line">  新建</span><br><span class="line">&lt;<span class="regexp">/Button&gt;</span></span><br></pre></td></tr></table></figure>
<p>最后<code>app.jsx</code>中申请路由。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> OperaForm = lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">"./operaform"</span>));</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&lt;PrivateRoute exact path=<span class="string">"/operas/create"</span> component=&#123;OperaForm&#125; /&gt;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<p>有新建，必定有删除鸭</p>
<p>实现逻辑和admin删除user一样。这里就不多讲了</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//... </span></span><br><span class="line">deleteOperas = <span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> _this = <span class="keyword">this</span>;</span><br><span class="line">    confirm(&#123;</span><br><span class="line">      title: <span class="string">"Are you sure delete?"</span>,</span><br><span class="line">      content: <span class="string">"Hope you know what you are doing！"</span>,</span><br><span class="line">      okText: <span class="string">"confirm"</span>,</span><br><span class="line">      okType: <span class="string">"danger"</span>,</span><br><span class="line">      cancelText: <span class="string">"cancel"</span>,</span><br><span class="line">      onOk() &#123;</span><br><span class="line">        <span class="keyword">const</span> token = Util.getToken();</span><br><span class="line">        Api.post( <span class="string">`/operas/<span class="subst">$&#123;item._id&#125;</span>/delete`</span>,&#123;</span><br><span class="line">          headers: &#123; <span class="attr">Authorization</span>: <span class="string">`Bearer <span class="subst">$&#123;token&#125;</span>`</span> &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">          .then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(res);</span><br><span class="line">            <span class="keyword">if</span> (res.data) &#123;</span><br><span class="line">              message.success(<span class="string">"delete success"</span>);</span><br><span class="line">              _this.getUserList();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              message.error(<span class="string">"fail"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">          .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(err);</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">      onCancel() &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Cancel"</span>);</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">  &#123;</span><br><span class="line">    title: <span class="string">"delete"</span>,</span><br><span class="line">    key: <span class="string">"delete"</span>,</span><br><span class="line">    align: <span class="string">"center"</span>,</span><br><span class="line">    render: <span class="function">(<span class="params">row, item</span>) =&gt;</span> (</span><br><span class="line">      &lt;div className=<span class="string">"person-table-btn"</span>&gt;</span><br><span class="line">        &#123;</span><br><span class="line">          &lt;Tooltip placement=<span class="string">"top"</span> title=&#123;<span class="string">"delete"</span>&#125;&gt;</span><br><span class="line">            &lt;Icon</span><br><span class="line">              type=<span class="string">"delete"</span></span><br><span class="line">              theme=<span class="string">"twoTone"</span></span><br><span class="line">              twoToneColor=<span class="string">"#eb2f96"</span></span><br><span class="line">              className=<span class="string">"table-btn-item"</span></span><br><span class="line">              onClick=&#123;() =&gt; <span class="keyword">this</span>.deleteOperas(item)&#125;</span><br><span class="line">            /&gt;</span><br><span class="line">          &lt;<span class="regexp">/Tooltip&gt;</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt; </span><br><span class="line">     ),</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/07/React%E6%A1%86%E6%9E%B6%E5%9C%A8%E4%BD%9C%E4%B8%9A%E5%BD%93%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/16.png" style="zoom: 67%;"></p>
<h3 id="实现收藏功能"><a href="#实现收藏功能" class="headerlink" title="实现收藏功能"></a>实现收藏功能</h3><p>我想，能不能加入一个收藏夹的功能，让用户能够把他中意的美剧放在收藏夹当中呢？</p>
<p>我的实现逻辑：首先新建一张schema，来存放我收藏夹中的信息，让然后在opera表格当中新添加一列 Like列，里面有一个点赞按钮，当点击后这个美剧就被添加到我们的收藏夹当中了。</p>
<p>在收藏夹中，我也以表格形式展示，可以删除收藏夹中的信息。还有返回按钮返回展示页面</p>
<p>因代码和展示页面类似，所以这里就不再展示了。</p>
<p><img src="/2020/06/07/React%E6%A1%86%E6%9E%B6%E5%9C%A8%E4%BD%9C%E4%B8%9A%E5%BD%93%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/17.png" style="zoom: 67%;"></p>
<h3 id="实现具体信息展示"><a href="#实现具体信息展示" class="headerlink" title="实现具体信息展示"></a>实现具体信息展示</h3><p>这个功能在学习博客：<a href="https://jasonxqh.github.io/2020/06/04/react基础3/#Exercise-1-Register-Form">Register Form</a> 中，我把他运用到了这个项目当中</p>
<p>简单的来说，就是在展示界面的title列，渲染一个链接，让它指向一个网页，这个网页会在进行<code>componentDidMount</code>时自动把从后端请求过来的detailed message 渲染到表单当中。但是美中不足的时这个表单暂时不支持修改。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">"react-redux"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createHashHistory &#125; <span class="keyword">from</span> <span class="string">"history"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Form, Input, Button  &#125; <span class="keyword">from</span> <span class="string">"antd"</span>;</span><br><span class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">"../components/layout"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"./style.scss"</span>;</span><br><span class="line"><span class="keyword">import</span> Api <span class="keyword">from</span> <span class="string">"../../js/Api"</span>;</span><br><span class="line"><span class="keyword">const</span> history = createHashHistory(&#123; <span class="attr">forceRefresh</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MovieForm</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;&#125;;</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      _id: <span class="literal">null</span>,</span><br><span class="line">      actors: <span class="literal">null</span>,</span><br><span class="line">      country: <span class="literal">null</span>,</span><br><span class="line">      first_date: <span class="literal">null</span>,</span><br><span class="line">      now: <span class="literal">null</span>,</span><br><span class="line">      other_name: <span class="literal">null</span>,</span><br><span class="line">      single: <span class="literal">null</span>,</span><br><span class="line">      station: <span class="literal">null</span>,</span><br><span class="line">      title: <span class="literal">null</span>,</span><br><span class="line">      type: <span class="literal">null</span>,</span><br><span class="line">      url: <span class="literal">null</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">this</span>.populateOpera();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> populateOpera() &#123;</span><br><span class="line">    <span class="keyword">const</span> operaname = <span class="keyword">this</span>.props.match.params.id; <span class="comment">//获取url参数</span></span><br><span class="line">    <span class="keyword">const</span> opera = Api.get(<span class="string">`/operas/<span class="subst">$&#123;operaname&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">const</span> details = (<span class="keyword">await</span> opera).data;</span><br><span class="line">    <span class="keyword">const</span> infos = details.targetOpera[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      _id,</span><br><span class="line">      actors,</span><br><span class="line">      country,</span><br><span class="line">      first_date,</span><br><span class="line">      now,</span><br><span class="line">      other_name,</span><br><span class="line">      single,</span><br><span class="line">      station,</span><br><span class="line">      title,</span><br><span class="line">      type,</span><br><span class="line">      url,</span><br><span class="line">    &#125; = infos;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">      _id,</span><br><span class="line">      actors,</span><br><span class="line">      country,</span><br><span class="line">      first_date,</span><br><span class="line">      now,</span><br><span class="line">      other_name,</span><br><span class="line">      single,</span><br><span class="line">      station,</span><br><span class="line">      title,</span><br><span class="line">      type,</span><br><span class="line">      url,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// console.log(actors)</span></span><br><span class="line">  &#125;</span><br><span class="line">  back() &#123;</span><br><span class="line">    history.push(<span class="string">'/operas'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      _id,</span><br><span class="line">      actors,</span><br><span class="line">      country,</span><br><span class="line">      first_date,</span><br><span class="line">      now,</span><br><span class="line">      other_name,</span><br><span class="line">      single,</span><br><span class="line">      station,</span><br><span class="line">      title,</span><br><span class="line">      type,</span><br><span class="line">      url,</span><br><span class="line">    &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">    <span class="built_in">console</span>.log(actors);</span><br><span class="line">    <span class="keyword">const</span> &#123; getFieldDecorator &#125; = <span class="keyword">this</span>.props.form;</span><br><span class="line">    <span class="keyword">const</span> &#123; userData &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">const</span> &#123; name, isLogin &#125; = userData;</span><br><span class="line">    <span class="keyword">const</span> formItemLayout = &#123;</span><br><span class="line">      labelCol: &#123; <span class="attr">span</span>: <span class="number">50</span> &#125;,</span><br><span class="line">      wrapperCol: &#123; <span class="attr">span</span>: <span class="number">60</span> &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> tailFormItemLayout = &#123;</span><br><span class="line">      wrapperCol: &#123;</span><br><span class="line">        xs: &#123;</span><br><span class="line">          span: <span class="number">24</span>,</span><br><span class="line">          offset: <span class="number">0</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        sm: &#123;</span><br><span class="line">          span: <span class="number">22</span>,</span><br><span class="line">          offset: <span class="number">2</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Layout&gt;</span><br><span class="line">        &lt;strong className=<span class="string">"title"</span>&gt;DetailedInformation&lt;<span class="regexp">/strong&gt;</span></span><br><span class="line"><span class="regexp">        &lt;Form</span></span><br><span class="line"><span class="regexp">          &#123;...formItemLayout&#125;</span></span><br><span class="line"><span class="regexp">          onSubmit=&#123;this.handleSubmit&#125;</span></span><br><span class="line"><span class="regexp">          className="login-form"</span></span><br><span class="line"><span class="regexp">        &gt;</span></span><br><span class="line"><span class="regexp">          &lt;Form.Item label="剧集名字" className="item"&gt;</span></span><br><span class="line"><span class="regexp">            &lt;Input size="large" value=&#123;title&#125; /</span>&gt;</span><br><span class="line">          &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Form.Item label="演员" className="item"&gt;</span></span><br><span class="line"><span class="regexp">            &lt;Input.TextArea rows=&#123;4&#125; size="large" value=&#123;actors&#125; /</span>&gt;</span><br><span class="line">          &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Form.Item label="国家" className="item"&gt;</span></span><br><span class="line"><span class="regexp">            &lt;Input size="large" value=&#123;country&#125; /</span>&gt;</span><br><span class="line">          &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Form.Item label="类型" className="item"&gt;</span></span><br><span class="line"><span class="regexp">            &lt;Input size="large" value=&#123;type&#125; /</span>&gt;</span><br><span class="line">          &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Form.Item label="单集片长" className="item"&gt;</span></span><br><span class="line"><span class="regexp">            &lt;Input size="large" value=&#123;single&#125; /</span>&gt;</span><br><span class="line">          &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Form.Item label="首播时间" className="item"&gt;</span></span><br><span class="line"><span class="regexp">            &lt;Input size="large" value=&#123;first_date&#125; /</span>&gt;</span><br><span class="line">          &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Form.Item label="更新至" className="item"&gt;</span></span><br><span class="line"><span class="regexp">            &lt;Input size="large" value=&#123;now&#125; /</span>&gt;</span><br><span class="line">          &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Form.Item label="别名" className="item"&gt;</span></span><br><span class="line"><span class="regexp">            &lt;Input size="large" value=&#123;other_name&#125; /</span>&gt;</span><br><span class="line">          &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Form.Item label="电视台" className="item"&gt;</span></span><br><span class="line"><span class="regexp">            &lt;Input size="large" value=&#123;station&#125; /</span>&gt;</span><br><span class="line">          &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Form.Item label="url" className="item"&gt;</span></span><br><span class="line"><span class="regexp">            &lt;Input size="large" value=&#123;url&#125; /</span>&gt;</span><br><span class="line">          &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Form.Item &#123;...tailFormItemLayout&#125; className="item"&gt;</span></span><br><span class="line"><span class="regexp">            &lt;Button</span></span><br><span class="line"><span class="regexp">              size="large"</span></span><br><span class="line"><span class="regexp">              type="primary"</span></span><br><span class="line"><span class="regexp">              onClick=&#123;() =&gt; this.back()&#125;</span></span><br><span class="line"><span class="regexp">              className="login-form-button"</span></span><br><span class="line"><span class="regexp">            &gt;</span></span><br><span class="line"><span class="regexp">              返回</span></span><br><span class="line"><span class="regexp">            &lt;/</span>Button&gt;</span><br><span class="line">          &lt;<span class="regexp">/Form.Item&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>Form&gt;</span><br><span class="line">      &lt;<span class="regexp">/Layout&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const mapStateToProps = (state) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  return &#123;</span></span><br><span class="line"><span class="regexp">    userData: state.userData.data,</span></span><br><span class="line"><span class="regexp">  &#125;;</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const wrappedMovieForm = Form.create(&#123; name: "MovieForm" &#125;)(MovieForm);</span></span><br><span class="line"><span class="regexp">export default connect(mapStateToProps, null)(wrappedMovieForm);</span></span><br></pre></td></tr></table></figure>
<h2 id="App-js"><a href="#App-js" class="headerlink" title="App.js"></a><code>App.js</code></h2><p>App组件是根组件所以我们单独讲。先上代码</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Suspense, lazy &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./style.scss'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; HashRouter <span class="keyword">as</span> Router, Route, Switch &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> PrivateRoute <span class="keyword">from</span> <span class="string">'./components/PrivateRoute'</span>;</span><br><span class="line"><span class="keyword">import</span> Loading <span class="keyword">from</span> <span class="string">'./components/loading'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Home = lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./home'</span>));</span><br><span class="line"><span class="keyword">const</span> Sign = lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./sign'</span>));</span><br><span class="line"><span class="keyword">const</span> Register = lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./register'</span>));</span><br><span class="line"><span class="keyword">const</span> Manage = lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./manage'</span>));</span><br><span class="line"><span class="keyword">const</span> Douban = lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./douban'</span>));</span><br><span class="line"><span class="keyword">const</span> Taobao = lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./taobao'</span>));</span><br><span class="line"><span class="keyword">const</span> Maoyan = lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./maoyan'</span>));</span><br><span class="line"><span class="keyword">const</span> Operas = lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./operas'</span>));</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Router&gt;</span><br><span class="line">        &lt;Suspense</span><br><span class="line">          fallback=&#123;<span class="comment">//这里如果等待的化，那么就加载上面所说的Loading组件</span></span><br><span class="line">            &lt;div className=<span class="string">"loading"</span>&gt;</span><br><span class="line">              &lt;Loading /&gt;</span><br><span class="line">            &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">          &#125;</span></span><br><span class="line"><span class="regexp">        &gt;</span></span><br><span class="line"><span class="regexp">          &lt;Switch&gt;</span></span><br><span class="line"><span class="regexp">            &lt;PrivateRoute exact path="/</span><span class="string">" component=&#123;Home&#125; /&gt;</span></span><br><span class="line"><span class="string">            &lt;PrivateRoute exact path="</span>/manage<span class="string">" component=&#123;Manage&#125; /&gt;</span></span><br><span class="line"><span class="string">            &lt;Route exact path="</span>/login<span class="string">" component=&#123;Sign&#125; /&gt;</span></span><br><span class="line"><span class="string">            &lt;Route exact path="</span>/register<span class="string">" component=&#123;Register&#125; /&gt;</span></span><br><span class="line"><span class="string">            &lt;PrivateRoute exact path="</span>/douban<span class="string">" component=&#123;Douban&#125; /&gt;</span></span><br><span class="line"><span class="string">            &lt;PrivateRoute exact path="</span>/taobao<span class="string">" component=&#123;Taobao&#125; /&gt;</span></span><br><span class="line"><span class="string">            &lt;PrivateRoute exact path="</span>/maoyan<span class="string">" component=&#123;Maoyan&#125; /&gt;</span></span><br><span class="line"><span class="string">            &lt;PrivateRoute exact path="</span>/operas<span class="string">" component=&#123;Operas&#125; /&gt;</span></span><br><span class="line"><span class="string">          &lt;/Switch&gt;</span></span><br><span class="line"><span class="string">        &lt;/Suspense&gt;</span></span><br><span class="line"><span class="string">      &lt;/Router&gt;</span></span><br><span class="line"><span class="string">    );</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">export default App;</span></span><br></pre></td></tr></table></figure>
<p><strong>这里需要讲几个问题：</strong></p>
<h3 id="lazy-Suspense-的作用-1"><a href="#lazy-Suspense-的作用-1" class="headerlink" title="lazy+Suspense 的作用"></a><code>lazy+Suspense</code> 的作用</h3><p>在<a href="https://react.docschina.org/docs/code-splitting.html" target="_blank" rel="noopener">react官方文档</a>中我截取了一段</p>
<p><code>React.lazy</code> 函数能让你像渲染常规组件一样处理动态引入（的组件）。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> OtherComponent = React.lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./OtherComponent'</span>));</span><br></pre></td></tr></table></figure>
<p>此代码将会在组件首次渲染时，自动导入包含 <code>OtherComponent</code> 组件的包。</p>
<p><code>React.lazy</code> 接受一个函数，这个函数需要动态调用 <code>import()</code>。它必须返回一个 <code>Promise</code>，该 Promise 需要 resolve 一个 <code>default</code> export 的 React 组件。</p>
<p>然后应在 <code>Suspense</code> 组件中渲染 lazy 组件，如此使得我们可以使用在等待加载 lazy 组件时做优雅降级（如 loading 指示器等）。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Suspense &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> OtherComponent = React.lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./OtherComponent'</span>));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyComponent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;Suspense fallback=&#123;&lt;div&gt;Loading...&lt;<span class="regexp">/div&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">        &lt;OtherComponent /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>fallback</code> 属性接受任何在组件加载过程中你想展示的 React 元素。你可以将 <code>Suspense</code> 组件置于懒加载组件之上的任何位置。你甚至可以用一个 <code>Suspense</code> 组件包裹多个懒加载组件。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Suspense &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> OtherComponent = React.lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./OtherComponent'</span>));</span><br><span class="line"><span class="keyword">const</span> AnotherComponent = React.lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./AnotherComponent'</span>));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyComponent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;Suspense fallback=&#123;&lt;div&gt;Loading...&lt;<span class="regexp">/div&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">        &lt;section&gt;</span></span><br><span class="line"><span class="regexp">          &lt;OtherComponent /</span>&gt;</span><br><span class="line">          &lt;AnotherComponent /&gt;</span><br><span class="line">        &lt;<span class="regexp">/section&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>Suspense&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    
    <div>
      
    </div>
    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://jasonxqh.github.io/2020/06/07/Nodejs%E5%9F%BA%E7%A1%804/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/%5Bobject%20Object%5D">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%804/" itemprop="url">Nodejs基础4</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-07T20:54:01+08:00">
                2020-06-07
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2020-06-30T10:38:46+08:00">
                2020-06-30
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/node/" itemprop="url" rel="index">
                    <span itemprop="name">node</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Authentication-and-Authorization"><a href="#Authentication-and-Authorization" class="headerlink" title="Authentication and Authorization"></a>Authentication and Authorization</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><h3 id="Creating-the-User-Model"><a href="#Creating-the-User-Model" class="headerlink" title="Creating the User Model"></a>Creating the User Model</h3><h3 id="Registering-Users"><a href="#Registering-Users" class="headerlink" title="Registering Users"></a>Registering Users</h3><h3 id="Using-Lodash"><a href="#Using-Lodash" class="headerlink" title="Using Lodash"></a>Using Lodash</h3><h3 id="Hashing-Passwords"><a href="#Hashing-Passwords" class="headerlink" title="Hashing Passwords"></a>Hashing Passwords</h3><h3 id="Authenticating-Users"><a href="#Authenticating-Users" class="headerlink" title="Authenticating Users"></a>Authenticating Users</h3><h3 id="Testing-the-Authentication"><a href="#Testing-the-Authentication" class="headerlink" title="Testing the Authentication"></a>Testing the Authentication</h3><h3 id="JSON-Web-Tokens"><a href="#JSON-Web-Tokens" class="headerlink" title="JSON Web Tokens"></a>JSON Web Tokens</h3><h3 id="Generating-Authentication-Tokens"><a href="#Generating-Authentication-Tokens" class="headerlink" title="Generating Authentication Tokens"></a>Generating Authentication Tokens</h3><h3 id="Storing-Secrets-in-Environment-Variables"><a href="#Storing-Secrets-in-Environment-Variables" class="headerlink" title="Storing Secrets in Environment Variables"></a>Storing Secrets in Environment Variables</h3><h3 id="Setting-Response-Headers"><a href="#Setting-Response-Headers" class="headerlink" title="Setting Response Headers"></a>Setting Response Headers</h3><h3 id="Encapsulating-Logic-in-Mongoose-Models"><a href="#Encapsulating-Logic-in-Mongoose-Models" class="headerlink" title="Encapsulating Logic in Mongoose Models"></a>Encapsulating Logic in Mongoose Models</h3><h3 id="Authorization-Middleware"><a href="#Authorization-Middleware" class="headerlink" title="Authorization Middleware"></a>Authorization Middleware</h3><h3 id="Protecting-Routes"><a href="#Protecting-Routes" class="headerlink" title="Protecting Routes"></a>Protecting Routes</h3><h3 id="Getting-the-Current-User"><a href="#Getting-the-Current-User" class="headerlink" title="Getting the Current User"></a>Getting the Current User</h3><h3 id="Logging-Out-Users"><a href="#Logging-Out-Users" class="headerlink" title="Logging Out Users"></a>Logging Out Users</h3><h3 id="Role-based-Authorization"><a href="#Role-based-Authorization" class="headerlink" title="Role-based Authorization"></a>Role-based Authorization</h3><h3 id="Testing-the-Authorization"><a href="#Testing-the-Authorization" class="headerlink" title="Testing the Authorization"></a>Testing the Authorization</h3><h3 id="Authentication-and-Authorization-Recap"><a href="#Authentication-and-Authorization-Recap" class="headerlink" title="Authentication and Authorization Recap"></a>Authentication and Authorization Recap</h3><h2 id="Handling-and-Logging-Errors"><a href="#Handling-and-Logging-Errors" class="headerlink" title="Handling and Logging Errors"></a>Handling and Logging Errors</h2><h3 id="Introduction-1"><a href="#Introduction-1" class="headerlink" title="Introduction"></a>Introduction</h3><p>现在我们假设我们的应用没有发生什么错误，但是 too young too simple.现实生活中会有很多意外。</p>
<p>所以我们最好能处理这些意外，并向客户端发送一个反馈，并把错误记录在日志里。</p>
<p>比如mongodb宕机了1分钟，现在我们的app无法应对这种中断，也不会向客户端提供任何服务，甚至再恢复也不行</p>
<h3 id="Handling-Rejected-Promises"><a href="#Handling-Rejected-Promises" class="headerlink" title="Handling Rejected Promises"></a>Handling Rejected Promises</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">"/"</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> genres = <span class="keyword">await</span> Genre.find().sort(<span class="string">"name"</span>);</span><br><span class="line">    res.send(genres);</span><br><span class="line">  &#125;<span class="keyword">catch</span>(ex)&#123;</span><br><span class="line">    <span class="comment">//log errors</span></span><br><span class="line">    res.status(<span class="number">500</span>).send(<span class="string">"Something failed"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>现在mongodb再宕机的时候，就看不到 unhandled promise rejection了</p>
<h3 id="Express-Error-Middleware"><a href="#Express-Error-Middleware" class="headerlink" title="Express Error Middleware"></a>Express Error Middleware</h3><p>但是，我们如果向修改记录日志的方式活着修改返回的信息，我们需要到处找try catch句块改，非常麻烦</p>
<p>我们希望把所有的逻辑都集中起来，这样就只需要修改一个地方即可。</p>
<p>还记得我们之前提到的中间件吗？现在我们就做一个发现异常的中间件</p>
<p>middleware文件夹中新建一个error.js，然后处理我们的逻辑</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">err, req, res, next</span>) </span>&#123;</span><br><span class="line">  res.status(<span class="number">500</span>).send(<span class="string">"Something failed"</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>index.js中我们引入这个中间键模块,然后在api之下写这个引用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(error);</span><br></pre></td></tr></table></figure>
<p>最后修改genre.js  当我们catch到错误的时候，我们把控制权交给下一个中间件，也就是上面所说的error.js去处理</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">"/"</span>, <span class="keyword">async</span> (req, res,next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> genres = <span class="keyword">await</span> Genre.find().sort(<span class="string">"name"</span>);</span><br><span class="line">    res.send(genres);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">    next(ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Removing-Try-Catch-Blocks"><a href="#Removing-Try-Catch-Blocks" class="headerlink" title="Removing Try Catch Blocks"></a>Removing Try Catch Blocks</h3><p>我们对上面的代码仍然不太满意，因为我们每次都要catch。next 太麻烦了</p>
<p>新建一个 async中间件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">asyncMiddleware</span>(<span class="params">handler</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> handler(req, res);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">      next(ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在genre中引入后</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">router.get(</span><br><span class="line">  <span class="string">"/"</span>,</span><br><span class="line">  asyncMiddleware(<span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> genres = <span class="keyword">await</span> Genre.find().sort(<span class="string">"name"</span>);</span><br><span class="line">    res.send(genres);</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="Express-Async-Errors"><a href="#Express-Async-Errors" class="headerlink" title="Express Async Errors"></a>Express Async Errors</h3><p>我们来介绍一下一个模块，这样就不用每次写asyncMiddleWare了。这个模块会将路由句柄包裹在类似的代码当中npm i express-async-errors</p>
<p>index中，我们直接引入即可require(‘express-async-errors’) </p>
<p>genre.js中我们保持原样，也不需要引入<em>const asyncMiddleware = require(“../middleware/async”);</em> 了</p>
<p>但是这个模块仍然把我们的控制权自动转到了错误控制的模块</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">"/"</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> genres = <span class="keyword">await</span> Genre.find().sort(<span class="string">"name"</span>);</span><br><span class="line">  res.send(genres);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Logging-Errors"><a href="#Logging-Errors" class="headerlink" title="Logging Errors"></a>Logging Errors</h3><p>我们需要在某处记录日志。在react基础课程中，我们使用了一morgan来记录日志，这里我们是用Winston</p>
<p>npm i winston之后，我们引入</p>
<p>const winston = require(‘winston’)</p>
<p>这个winston是这个模块中默认的日志模块，我们可以自定义记录器。但这已经足够了</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%804/1.png" style="zoom:80%;"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> winston = <span class="built_in">require</span>(<span class="string">'winston'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>)</span>&#123;</span><br><span class="line">  winston.error(err.message, err);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// error</span></span><br><span class="line">  <span class="comment">// warn</span></span><br><span class="line">  <span class="comment">// info</span></span><br><span class="line">  <span class="comment">// verbose</span></span><br><span class="line">  <span class="comment">// debug </span></span><br><span class="line">  <span class="comment">// silly</span></span><br><span class="line"></span><br><span class="line">  res.status(<span class="number">500</span>).send(<span class="string">'Something failed.'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Logging-to-MongoDB"><a href="#Logging-to-MongoDB" class="headerlink" title="Logging to MongoDB"></a>Logging to MongoDB</h3><p>安装winston-mongodb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">require(&#39;winston-mongodb&#39;);</span><br><span class="line">&#x2F;&#x2F;...</span><br><span class="line">winston.add(winston.transports.MongoDB,&#123;db:&#39;mongodb:&#x2F;&#x2F;localhost&#x2F;vidly&#39;&#125;);</span><br></pre></td></tr></table></figure>
<p>我们还可以为存储到mongodb设置等级：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">winston.add(winston.transports.MongoDB,&#123;</span><br><span class="line">		db:&#39;mongodb:&#x2F;&#x2F;localhost&#x2F;vidly&#39;,</span><br><span class="line">		level:&#39;info&#39;&#x2F;&#x2F;info是第三等级，包含error和warn</span><br><span class="line">		</span><br><span class="line">		&#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="Uncaught-Exceptions"><a href="#Uncaught-Exceptions" class="headerlink" title="Uncaught Exceptions"></a>Uncaught Exceptions</h3><h3 id="Unhandled-Promise-Rejections"><a href="#Unhandled-Promise-Rejections" class="headerlink" title="Unhandled Promise Rejections"></a>Unhandled Promise Rejections</h3><h3 id="Error-Handling-Recap"><a href="#Error-Handling-Recap" class="headerlink" title="Error Handling Recap"></a>Error Handling Recap</h3><h3 id="Extracting-Routes"><a href="#Extracting-Routes" class="headerlink" title="Extracting Routes"></a>Extracting Routes</h3><h3 id="Extracting-the-Db-Logic"><a href="#Extracting-the-Db-Logic" class="headerlink" title="Extracting the Db Logic"></a>Extracting the Db Logic</h3><h3 id="Extracting-the-Logging-Logic"><a href="#Extracting-the-Logging-Logic" class="headerlink" title="Extracting the Logging Logic"></a>Extracting the Logging Logic</h3><h3 id="Extracting-the-Config-Logic"><a href="#Extracting-the-Config-Logic" class="headerlink" title="Extracting the Config Logic"></a>Extracting the Config Logic</h3><h3 id="Extracting-the-Validation-Logic"><a href="#Extracting-the-Validation-Logic" class="headerlink" title="Extracting the Validation Logic"></a>Extracting the Validation Logic</h3><h3 id="Showing-Unhandled-Exceptions-on-the-Console"><a href="#Showing-Unhandled-Exceptions-on-the-Console" class="headerlink" title="Showing Unhandled Exceptions on the Console"></a>Showing Unhandled Exceptions on the Console</h3><h3 id="Handling-and-Logging-Errors-Recap"><a href="#Handling-and-Logging-Errors-Recap" class="headerlink" title="Handling and Logging Errors Recap"></a>Handling and Logging Errors Recap</h3>
          
        
      
    </div>
    
    
    
    <div>
      
    </div>
    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://jasonxqh.github.io/2020/06/07/Nodejs%E5%9F%BA%E7%A1%803/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/%5Bobject%20Object%5D">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%803/" itemprop="url">Nodejs基础3</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-07T20:53:52+08:00">
                2020-06-07
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2020-06-30T10:38:32+08:00">
                2020-06-30
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/node/" itemprop="url" rel="index">
                    <span itemprop="name">node</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Mongo-Data-Validation"><a href="#Mongo-Data-Validation" class="headerlink" title="Mongo - Data Validation"></a>Mongo - Data Validation</h2><h3 id="Validation"><a href="#Validation" class="headerlink" title="Validation"></a>Validation</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> courseSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">  name: <span class="built_in">String</span>,</span><br><span class="line">  author: <span class="built_in">String</span>, </span><br><span class="line">  tags: [ <span class="built_in">String</span> ],</span><br><span class="line">  date: <span class="built_in">Date</span>, </span><br><span class="line">  isPublished: <span class="built_in">Boolean</span>,</span><br><span class="line">  price: <span class="built_in">Number</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>之前我们对于表的定义是这样的，所以当我创建一个空对象也是可以通过验证的。MongoDB不会在意我们的课程是否有单价。所以我们需要required验证器</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> courseSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">  name: &#123;<span class="attr">type</span>: <span class="built_in">String</span>,<span class="attr">required</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">  author: <span class="built_in">String</span>, </span><br><span class="line">  tags: [ <span class="built_in">String</span> ],</span><br><span class="line">  date: <span class="built_in">Date</span>, </span><br><span class="line">  isPublished: <span class="built_in">Boolean</span>,</span><br><span class="line">  price: <span class="built_in">Number</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> course.save();</span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(ex.message);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<p>这时候当我们去掉name信息之后，运行createCourse()函数，catch会捕捉到下面的报错</p>
<p>Course validation failed: name: Path <code>name</code> is required.</p>
<p>我们也可以手工处理验证</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> course.validate();</span><br></pre></td></tr></table></figure>
<p>不想Mysql，mongodb是没有必须填写这种验证的。所以验证只有写在mongoose里面才会起作用。当我们尝试写入数据库时，mongoose会做验证，不通过就不会向数据库写入</p>
<p>当然我们可以使用Joi来验证字符串，一般在RESTful API种使用Joi. Mongoose在写入数据库之前验证数据是否合法</p>
<p>因为可能客户端将合法的数据写在了请求当中，但是当我们在创建http 服务的course对象的时候，也许我们忘记把name属性从req.body.name中读取出来了。所以利用mongoose可以确保数据库中不会出现不合法的数据文档</p>
<h3 id="Built-in-Validators"><a href="#Built-in-Validators" class="headerlink" title="Built-in Validators"></a>Built-in Validators</h3><p>我们现在假设，price只有当isPublished为true得时候才是必需的。现在我们来写这个验证器</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> courseSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">  name: &#123;<span class="attr">type</span>: <span class="built_in">String</span>,<span class="attr">required</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">  author: <span class="built_in">String</span>, </span><br><span class="line">  tags: [ <span class="built_in">String</span> ],</span><br><span class="line">  date: <span class="built_in">Date</span>, </span><br><span class="line">  isPublished: <span class="built_in">Boolean</span>,</span><br><span class="line">  price: &#123;</span><br><span class="line">      type:<span class="built_in">Number</span>,</span><br><span class="line">      required: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>.isPublished;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> Course = mongoose.model(<span class="string">"Course"</span>, courseSchema);</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">createCourse</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> course = <span class="keyword">new</span> Course(&#123;</span><br><span class="line">    <span class="comment">// name: "Node.js Course,</span></span><br><span class="line">    author: <span class="string">"Mosh"</span>,</span><br><span class="line">    tags: [<span class="string">"node"</span>, <span class="string">"backend"</span>],</span><br><span class="line">    isPublished: <span class="literal">true</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> course.save();</span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(ex.message);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意，在这个特定的地方是不能用箭头函数的，因为箭头函数没有this，它使用的this是继承而来的。所以箭头函数中的this指的是courseSchema。</p>
<p>运行后，我们发现</p>
<p>Course validation failed: price: Path <code>price</code> is required., name: Path <code>name</code> is required.</p>
<p>所以验证既可以是一个简单的值，也可以是一个验证条件的函数</p>
<p>当然我们也可以有附加的验证器</p>
<p>比如，在string类型中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">name: &#123;</span><br><span class="line">	type: <span class="built_in">String</span>,</span><br><span class="line">	required: <span class="literal">true</span>,</span><br><span class="line">	minlenght: <span class="number">5</span>,</span><br><span class="line">	maxlenght: <span class="number">255</span>,</span><br><span class="line">	match: <span class="regexp">/pattern/</span> <span class="comment">//写正则表达式</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>我们还可以用enum属性(python中的数组).也就是说，我们添加的新的内容，必须在enum给出的范围之内</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">category:&#123;</span><br><span class="line">	type: <span class="built_in">String</span>,</span><br><span class="line">	required: <span class="literal">true</span>,</span><br><span class="line">	enum: [<span class="string">'web'</span>,<span class="string">'mobile'</span>,<span class="string">'network'</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于数字，我们可以有min 和max</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">price: &#123;</span><br><span class="line">    type:<span class="built_in">Number</span>,</span><br><span class="line">    required: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>.isPublished;&#125;</span><br><span class="line">    min: <span class="number">10</span>,</span><br><span class="line">    max: <span class="number">200</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Custom-Validators"><a href="#Custom-Validators" class="headerlink" title="Custom Validators"></a>Custom Validators</h3><p>有时候内建的验证器并不能满足我们的需求</p>
<p>例如tags属性，他是一个字符串数组，假设我们要求每个课程必须有一个tag，那么我们在这里无法使用required。因为当使用了required，传入一个空数组，mongoose也会认为这是合法的。所以我们要自定义验证器了</p>
<p>我们设置validate属性是一个对象，这个对象中有个属性是validator，这是一个函数，函数里面写验证逻辑</p>
<p>此外还需要一条提示信息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tags:&#123;</span><br><span class="line">	type: <span class="built_in">Array</span>,</span><br><span class="line">	validate:&#123;</span><br><span class="line">		validator: <span class="function"><span class="keyword">function</span>(<span class="params">v</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> v&amp;&amp;v.length&gt;<span class="number">0</span>;</span><br><span class="line">		&#125;,</span><br><span class="line">		message:<span class="string">"A course must have one tag"</span> <span class="comment">//提示信息是可选的</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在当tags数组为空，tags: null 或者不传入tags的时候，就会出现以下报错：</p>
<p>Course validation failed: price: Path <code>price</code> is required., name: Path <code>name</code> is required., tags: A course must have one tag</p>
<h3 id="Async-Validators"><a href="#Async-Validators" class="headerlink" title="Async Validators"></a>Async Validators</h3><p>验证有时候需要读取数据库或者远端的http服务，我们不能直接得到结论。这时候需要异步验证</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">tags:&#123;</span><br><span class="line">	type: <span class="built_in">Array</span>,</span><br><span class="line">	validate:&#123;</span><br><span class="line">		isAsync: <span class="literal">true</span>,</span><br><span class="line">		validator: <span class="function"><span class="keyword">function</span>(<span class="params">v,callback</span>)</span>&#123;</span><br><span class="line">			setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">				<span class="keyword">const</span> result = v&amp;&amp;v.length&gt;<span class="number">0</span>;</span><br><span class="line">				callback(result);</span><br><span class="line">			&#125;,<span class="number">4000</span>);</span><br><span class="line">		&#125;,</span><br><span class="line">		message:<span class="string">"A course must have one tag"</span> </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先设置isAsync 属性为true，其次这一个回调函数。这里用setTimeout()代替</p>
<p>现实项目当中这个结果可能来自于对文件系统，数据库或者远端服务返回值的计算</p>
<h3 id="Validation-Errors"><a href="#Validation-Errors" class="headerlink" title="Validation Errors"></a>Validation Errors</h3><p>现在我们来扩展Error对象的细节</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> course.save();</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">  <span class="keyword">for</span>(field <span class="keyword">in</span> ex.errors)</span><br><span class="line">  	<span class="built_in">console</span>.log(ex.errors[field]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%803/1.png" style="zoom:80%;"></p>
<p>我们可以看到这里 一开始是验证错误的对象，然后是错误信息的提示。然后是堆栈的追踪信息。</p>
<h3 id="SchemaType-Options"><a href="#SchemaType-Options" class="headerlink" title="SchemaType Options"></a>SchemaType Options</h3><p>当定义schema的时候，可以直接定义属性的类型，也可以使用对象：type,required,enum等等属性。</p>
<p>现在我们再来了解几个有用的schema对象的属性</p>
<p>lowercase: 当lowercase is true时，mongoose会自动将字符串转为小写</p>
<p>uppercase: 当uppercase is true时，mongoose会自动将字符串转为大写</p>
<p>自定义get，set。比如我想要对price数值四舍五入小数部分。</p>
<p>这样当写入price的时候，set属性会自动四舍五入</p>
<p>get的作用是在数据库中取得浮点数的时候会自动<strong>以四舍五入的方式呈现</strong>（数据库中没有改变）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">price:&#123;</span><br><span class="line">	<span class="keyword">get</span>: v=&gt;Math.round(v),</span><br><span class="line">	<span class="keyword">set</span>: v=&gt;Math.round(v)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Project-Add-Persistence-to-Genres-API"><a href="#Project-Add-Persistence-to-Genres-API" class="headerlink" title="Project- Add Persistence to Genres API"></a>Project- Add Persistence to Genres API</h3><p>genre.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Joi = <span class="built_in">require</span>(<span class="string">"joi"</span>);</span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">"mongoose"</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Genre = mongoose.model(</span><br><span class="line">  <span class="string">"Genre"</span>,</span><br><span class="line">  <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">    name: &#123;</span><br><span class="line">      type: <span class="built_in">String</span>,</span><br><span class="line">      required: <span class="literal">true</span>,</span><br><span class="line">      minlength: <span class="number">5</span>,</span><br><span class="line">      maxlength: <span class="number">50</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">"/"</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> genres = <span class="keyword">await</span> Genre.find().sort(<span class="string">"name"</span>);</span><br><span class="line">  res.send(genres);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">"/"</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; error &#125; = validateGenre(req.body);</span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">return</span> res.status(<span class="number">400</span>).send(error.details[<span class="number">0</span>].message);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> genre = <span class="keyword">new</span> Genre(&#123; <span class="attr">name</span>: req.body.name &#125;);</span><br><span class="line">  genre = <span class="keyword">await</span> genre.save();</span><br><span class="line"></span><br><span class="line">  res.send(genre);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.put(<span class="string">"/:id"</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; error &#125; = validateGenre(req.body);</span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">return</span> res.status(<span class="number">400</span>).send(error.details[<span class="number">0</span>].message);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> genre = <span class="keyword">await</span> Genre.findByIdAndUpdate(</span><br><span class="line">    req.params.id,</span><br><span class="line">    &#123; <span class="attr">name</span>: req.body.name &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">new</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!genre)</span><br><span class="line">    <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">"The genre with the given ID was not found."</span>);</span><br><span class="line"></span><br><span class="line">  res.send(genre);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.delete(<span class="string">"/:id"</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> genre = <span class="keyword">await</span> Genre.findByIdAndRemove(req.params.id);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!genre)</span><br><span class="line">    <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">"The genre with the given ID was not found."</span>);</span><br><span class="line"></span><br><span class="line">  res.send(genre);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">"/:id"</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> genre = <span class="keyword">await</span> Genre.findById(req.params.id);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!genre)</span><br><span class="line">    <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">"The genre with the given ID was not found."</span>);</span><br><span class="line"></span><br><span class="line">  res.send(genre);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateGenre</span>(<span class="params">genre</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> schema = &#123;</span><br><span class="line">    name: Joi.string().min(<span class="number">3</span>).required(),</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Joi.validate(genre, schema);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<p>index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>)</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"><span class="keyword">const</span> genres = <span class="built_in">require</span>(<span class="string">"./routes/genres"</span>);</span><br><span class="line">app.use(express.json());</span><br><span class="line">mongoose.connect(<span class="string">'mongodb://localhost/vidly'</span>)</span><br><span class="line">    .then(<span class="function"><span class="params">()</span>=&gt;</span><span class="built_in">console</span>.log(<span class="string">"Connected to MongoDB"</span>))</span><br><span class="line">    .catch(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.error(<span class="string">'Could not connect to MongoDB'</span>))</span><br><span class="line">app.use(<span class="string">"/api/genres"</span>, genres);</span><br><span class="line"><span class="keyword">const</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line">app.listen(port, () =&gt; <span class="built_in">console</span>.log(<span class="string">`Listening on port <span class="subst">$&#123;port&#125;</span>...`</span>));</span><br></pre></td></tr></table></figure>
<h3 id="Project-Build-the-Customers-API"><a href="#Project-Build-the-Customers-API" class="headerlink" title="Project- Build the Customers API"></a>Project- Build the Customers API</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Joi = <span class="built_in">require</span>(<span class="string">'joi'</span>);</span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Customer = mongoose.model(<span class="string">'Customer'</span>, <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">  name: &#123;</span><br><span class="line">    type: <span class="built_in">String</span>,</span><br><span class="line">    required: <span class="literal">true</span>,</span><br><span class="line">    minlength: <span class="number">5</span>,</span><br><span class="line">    maxlength: <span class="number">50</span></span><br><span class="line">  &#125;,</span><br><span class="line">  isGold: &#123;</span><br><span class="line">    type: <span class="built_in">Boolean</span>,</span><br><span class="line">    <span class="keyword">default</span>: <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  phone: &#123;</span><br><span class="line">    type: <span class="built_in">String</span>,</span><br><span class="line">    required: <span class="literal">true</span>,</span><br><span class="line">    minlength: <span class="number">5</span>,</span><br><span class="line">    maxlength: <span class="number">50</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/'</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> customers = <span class="keyword">await</span> Customer.find().sort(<span class="string">'name'</span>);</span><br><span class="line">  res.send(customers);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">'/'</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; error &#125; = validateCustomer(req.body); </span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">return</span> res.status(<span class="number">400</span>).send(error.details[<span class="number">0</span>].message);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> customer = <span class="keyword">new</span> Customer(&#123; </span><br><span class="line">    name: req.body.name,</span><br><span class="line">    isGold: req.body.isGold,</span><br><span class="line">    phone: req.body.phone</span><br><span class="line">  &#125;);</span><br><span class="line">  customer = <span class="keyword">await</span> customer.save();</span><br><span class="line">  </span><br><span class="line">  res.send(customer);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.put(<span class="string">'/:id'</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; error &#125; = validateCustomer(req.body); </span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">return</span> res.status(<span class="number">400</span>).send(error.details[<span class="number">0</span>].message);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> customer = <span class="keyword">await</span> Customer.findByIdAndUpdate(req.params.id,</span><br><span class="line">    &#123; </span><br><span class="line">      name: req.body.name,</span><br><span class="line">      isGold: req.body.isGold,</span><br><span class="line">      phone: req.body.phone</span><br><span class="line">    &#125;, &#123; <span class="attr">new</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!customer) <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">'The customer with the given ID was not found.'</span>);</span><br><span class="line">  </span><br><span class="line">  res.send(customer);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.delete(<span class="string">'/:id'</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> customer = <span class="keyword">await</span> Customer.findByIdAndRemove(req.params.id);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!customer) <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">'The customer with the given ID was not found.'</span>);</span><br><span class="line"></span><br><span class="line">  res.send(customer);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/:id'</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> customer = <span class="keyword">await</span> Customer.findById(req.params.id);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!customer) <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">'The customer with the given ID was not found.'</span>);</span><br><span class="line"></span><br><span class="line">  res.send(customer);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateCustomer</span>(<span class="params">customer</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> schema = &#123;</span><br><span class="line">    name: Joi.string().min(<span class="number">5</span>).max(<span class="number">50</span>).required(),</span><br><span class="line">    phone: Joi.string().min(<span class="number">5</span>).max(<span class="number">50</span>).required(),</span><br><span class="line">    isGold: Joi.boolean()</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Joi.validate(customer, schema);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<h3 id="Restructuring-the-Project"><a href="#Restructuring-the-Project" class="headerlink" title="Restructuring the Project"></a>Restructuring the Project</h3><p>现在一个js文件虽然只有80多行，但以后肯定时很庞大的，所以我们要进行代码重构。</p>
<p>所以我们把一些对象都放到models文件夹中，routes专心处理api</p>
<p>在models中我们新建一个customer.js存放</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">"mongoose"</span>);</span><br><span class="line"><span class="keyword">const</span> Joi = <span class="built_in">require</span>(<span class="string">"joi"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Customer = mongoose.model(</span><br><span class="line">  <span class="string">"Customer"</span>,</span><br><span class="line">  <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">    name: &#123;</span><br><span class="line">      type: <span class="built_in">String</span>,</span><br><span class="line">      required: <span class="literal">true</span>,</span><br><span class="line">      minlength: <span class="number">5</span>,</span><br><span class="line">      maxlength: <span class="number">50</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    isGold: &#123;</span><br><span class="line">      type: <span class="built_in">Boolean</span>,</span><br><span class="line">      <span class="keyword">default</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    phone: &#123;</span><br><span class="line">      type: <span class="built_in">String</span>,</span><br><span class="line">      required: <span class="literal">true</span>,</span><br><span class="line">      minlength: <span class="number">5</span>,</span><br><span class="line">      maxlength: <span class="number">50</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateCustomer</span>(<span class="params">customer</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> schema = &#123;</span><br><span class="line">    name: Joi.string().min(<span class="number">5</span>).max(<span class="number">50</span>).required(),</span><br><span class="line">    phone: Joi.string().min(<span class="number">5</span>).max(<span class="number">50</span>).required(),</span><br><span class="line">    isGold: Joi.boolean(),</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Joi.validate(customer, schema);</span><br><span class="line">&#125;</span><br><span class="line">exports.Customer = Customer;</span><br><span class="line">exports.valudate = validateCustomer;</span><br></pre></td></tr></table></figure>
<p>这样我们实现了 single responsibility principle</p>
<p>在customer model中，我们实现了对customer对象的定义和验证。也就是定义了在node中一个customer对象应该长什么样子</p>
<p>routes 中的customer.js 就是全部处理关于customer的路由逻辑</p>
<p>在最后我们导出，并在routes中接收。注意，我们这里用析构而不直接定义，是因为我们不想这样写：customer.Customer，太难看了</p>
<p>const {Customer,validate}= require(‘../model/customer’);</p>
<p>同样的我们对genre.js进行重构</p>
<h3 id="Mongoose-Validation-Recap"><a href="#Mongoose-Validation-Recap" class="headerlink" title="Mongoose Validation Recap"></a>Mongoose Validation Recap</h3><p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%803/2.png"></p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%803/2.png"></p>
<h2 id="Mongoose-Modeling-Relationships-between-Connected-Data"><a href="#Mongoose-Modeling-Relationships-between-Connected-Data" class="headerlink" title="Mongoose- Modeling Relationships between Connected Data"></a>Mongoose- Modeling Relationships between Connected Data</h2><h3 id="Modelling-Relationships"><a href="#Modelling-Relationships" class="headerlink" title="Modelling Relationships"></a>Modelling Relationships</h3><h3 id="Referencing-Documents"><a href="#Referencing-Documents" class="headerlink" title="Referencing Documents"></a>Referencing Documents</h3><h3 id="Population"><a href="#Population" class="headerlink" title="Population"></a>Population</h3><h3 id="Embedding-Documents"><a href="#Embedding-Documents" class="headerlink" title="Embedding Documents"></a>Embedding Documents</h3><h3 id="Using-an-Array-of-Sub-documents"><a href="#Using-an-Array-of-Sub-documents" class="headerlink" title="Using an Array of Sub-documents"></a>Using an Array of Sub-documents</h3><h3 id="Project-Build-the-Movies-API"><a href="#Project-Build-the-Movies-API" class="headerlink" title="Project- Build the Movies API"></a>Project- Build the Movies API</h3><h3 id="Project-Build-the-Rentals-API"><a href="#Project-Build-the-Rentals-API" class="headerlink" title="Project- Build the Rentals API"></a>Project- Build the Rentals API</h3><h3 id="Mongoose-Modelling-Relationships-between-Connected-Data-Recap"><a href="#Mongoose-Modelling-Relationships-between-Connected-Data-Recap" class="headerlink" title="Mongoose- Modelling Relationships between Connected Data Recap"></a>Mongoose- Modelling Relationships between Connected Data Recap</h3>
          
        
      
    </div>
    
    
    
    <div>
      
    </div>
    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://jasonxqh.github.io/2020/06/07/Nodejs%E5%9F%BA%E7%A1%802/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/%5Bobject%20Object%5D">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%802/" itemprop="url">Nodejs基础2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-07T20:53:41+08:00">
                2020-06-07
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2020-06-30T10:38:30+08:00">
                2020-06-30
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/node/" itemprop="url" rel="index">
                    <span itemprop="name">node</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Nodejs基础2"><a href="#Nodejs基础2" class="headerlink" title="Nodejs基础2"></a>Nodejs基础2</h1><p><a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础1/#more">Nodejs基础1</a></p>
<p><a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础2/#more"> Nodejs基础2</a></p>
<p><a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础3/#more">Nodejs基础3</a></p>
<p><a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础4/#more">Nodejs基础4</a></p>
<h2 id="Asynchronous-JavaScript"><a href="#Asynchronous-JavaScript" class="headerlink" title="Asynchronous JavaScript"></a>Asynchronous JavaScript</h2><h3 id="Synchronous-vs-Asynchronous-Code"><a href="#Synchronous-vs-Asynchronous-Code" class="headerlink" title="Synchronous vs Asynchronous Code"></a>Synchronous vs Asynchronous Code</h3><p>在现实中我们更多的是使用数据库而非数组。在我们讨论Node链接mongodb之前我们先要了解一下异步编程</p>
<p>首先新建一个async文件夹</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"Before"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"After"</span>);</span><br></pre></td></tr></table></figure>
<p>这是一个同步编程（阻塞机制) 的演示。在这种机制之下，第一行执行的时候，程序会暂停，第二行需要第一行结束之后才会执行</p>
<p>相反的，我们有异步编程</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"Before"</span>);</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Reading a user from a database...."</span>);</span><br><span class="line">&#125;, <span class="number">2000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"After"</span>);</span><br></pre></td></tr></table></figure>
<p>比如说这个函数，我们用setTimeout函数来模仿从数据库中读取数据需要2秒种的时间。那么这时候还是先Before再等两秒输出”Reading a user from a database….”，最后After吗？不是的，打印结果如下</p>
<p>Before<br>After<br>Reading a user from a database….</p>
<p>我们立即打印了Before和after，但是等了两秒之后才显示了读取的信息</p>
<p>这就是异步机制。异步机制不是多线程，在这个例子中只有一个线程。</p>
<p>相当于饭店中的服务员不会只服务你一个人，在厨师准备你的餐点的时候，他会取招待其他的顾客。</p>
<h3 id="Patterns-for-Dealing-with-Asynchronous-Code"><a href="#Patterns-for-Dealing-with-Asynchronous-Code" class="headerlink" title="Patterns for Dealing with Asynchronous Code"></a>Patterns for Dealing with Asynchronous Code</h3><p>当我们标记一个异步函数的时候不能这样写</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"Before"</span>);</span><br><span class="line"><span class="keyword">const</span> user = getUser(<span class="number">1</span>);</span><br><span class="line"><span class="built_in">console</span>.log(user)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"After"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Reading a user from a database...."</span>);</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="attr">id</span>: id,<span class="attr">gitHubname</span>:<span class="string">'Jason'</span>&#125;</span><br><span class="line">  &#125;, <span class="number">2000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样写 我们会得到user是undefined的</p>
<h3 id="Callbacks"><a href="#Callbacks" class="headerlink" title="Callbacks"></a>Callbacks</h3><p>我们可以给getUser传入一callback参数，它是再异步操作完毕后调用的参数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"Before"</span>);</span><br><span class="line"><span class="keyword">const</span> user = getUser(<span class="number">1</span>, <span class="function"><span class="keyword">function</span> (<span class="params">user</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"User"</span>, user);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"After"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params">id, callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Reading a user from a database...."</span>);</span><br><span class="line">    callback(&#123; <span class="attr">id</span>: id, <span class="attr">gitHubname</span>: <span class="string">"Jason"</span> &#125;);</span><br><span class="line">  &#125;, <span class="number">2000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Before<br>After<br>Reading a user from a database….<br>User { id: 1, gitHubname: ‘Jason’ }</p>
<p>当一个异步操作的结果 is ready，callback函数就会被调用并传入下面返回结果</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"Before"</span>);</span><br><span class="line"><span class="keyword">const</span> user = getUser(<span class="number">1</span>, <span class="function"><span class="keyword">function</span> (<span class="params">user</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//get the repositories;</span></span><br><span class="line">  getRepositories(user.gitHubname, (repos) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Repos"</span>, repos);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"After"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params">id, callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Reading a user from a database...."</span>);</span><br><span class="line">    callback(&#123; <span class="attr">id</span>: id, <span class="attr">gitHubname</span>: <span class="string">"Jason"</span> &#125;);</span><br><span class="line">  &#125;, <span class="number">2000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRepositories</span>(<span class="params">username, callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Calling GitHub Api..."</span>);</span><br><span class="line">    callback([<span class="string">"repo1"</span>, <span class="string">"repo2"</span>, <span class="string">"repo3"</span>]);</span><br><span class="line">  &#125;, <span class="number">2000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Before<br>After</p>
<p>//两秒之后</p>
<p>Reading a user from a database….</p>
<p>//两秒之后</p>
<p>Calling GitHub Api…<br>Repos [ ‘repo1’, ‘repo2’, ‘repo3’ ]</p>
<h3 id="Callback-Hell"><a href="#Callback-Hell" class="headerlink" title="Callback Hell"></a>Callback Hell</h3><p>我们真实的代码可能远远比这个复杂。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"Before"</span>);</span><br><span class="line"><span class="keyword">const</span> user = getUser(<span class="number">1</span>, <span class="function"><span class="keyword">function</span> (<span class="params">user</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//get the repositories;</span></span><br><span class="line">  getRepositories(user.gitHubname, (repos) =&gt; &#123;</span><br><span class="line">    getCommits(repo,(commits)=&gt;&#123;</span><br><span class="line">    	<span class="comment">//get...</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"After"</span>);</span><br></pre></td></tr></table></figure>
<p>如果所有的异步代码都这样那还得了？全是很深的嵌套解构</p>
<p>我们把它叫做回调陷阱/回调地狱</p>
<h3 id="Named-Functions-to-Rescue"><a href="#Named-Functions-to-Rescue" class="headerlink" title="Named Functions to Rescue"></a>Named Functions to Rescue</h3><p>我们用 这种方式，用引用的方式调用函数。</p>
<p>调用getRepositories ,那么就再getRespositories中调用getCommits </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"Before"</span>);</span><br><span class="line"><span class="keyword">const</span> user = getUser(<span class="number">1</span>,getRepositories);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"After"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">displayUser</span>(<span class="params">user</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(user);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRespositories</span>(<span class="params">user</span>)</span>&#123;</span><br><span class="line">    getRepositories(user.gitHubUsername,getCommits);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCommits</span>(<span class="params">repos</span>)</span>&#123;</span><br><span class="line">    getCommits(repos,displayCommits);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<h3 id="Promises"><a href="#Promises" class="headerlink" title="Promises"></a>Promises</h3><p>promise就是一个用于保存异步操作结果的容器。当一个异步操作结束后，<strong>要么保存了值</strong>，要么<strong>保存了错误信息</strong>。promise就保证给你一个异步操作的结果。这个对象有三个states</p>
<p>1.当我创建了promise对象的时候，它处于Pending阶段。</p>
<p>2.当结果准备好，promise将被履行，也就是说异步操作成功完成，这样就得到一个值。进入Fulfiled阶段</p>
<p>3.否则如果在执行异步操作的过程当中出现了问题，promise进入Reject阶段</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%802/1.png" style="zoom:80%;"></p>
<p>我们用下面这个例子来模拟异步操作成功了. resolve就代表了如果异步操作成功返回的值</p>
<p>然后p.then 就代表了成功以后进行的操作。运行以后我们看到两秒钟之后打印了Result 1</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// Kick off some async work</span></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">      resolve(<span class="number">1</span>);</span><br><span class="line">  &#125;,<span class="number">2000</span>);  </span><br><span class="line">  <span class="comment">//   reject(new Error("message"));</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">p.then(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Result"</span>, result);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>下面这个例子模仿了失败的异步操作,如果有错误，我们需要 p.catch来捕获这个错误，然后进行错误之后的动作</p>
<p>两秒之后我们得到了 Error message的打印信息</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// Kick off some async work</span></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// resolve(1);</span></span><br><span class="line">   reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"message"</span>));</span><br><span class="line">  &#125;, <span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">p.then(<span class="function">(<span class="params">result</span>) =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"Result"</span>, result))</span><br><span class="line"> .catch(<span class="function">(<span class="params">err</span>) =&gt;</span><span class="built_in">console</span>.log(<span class="string">"Error"</span>, err.message));</span><br></pre></td></tr></table></figure>
<h3 id="Replacing-Callbacks-with-Promises"><a href="#Replacing-Callbacks-with-Promises" class="headerlink" title="Replacing Callbacks with Promises"></a>Replacing Callbacks with Promises</h3><p>现在我们用promise来取代callbacks</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Reading a user from a database...."</span>);</span><br><span class="line">      resolve(&#123; <span class="attr">id</span>: id, <span class="attr">gitHubname</span>: <span class="string">"Jason"</span> &#125;);</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRepositories</span>(<span class="params">username</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Calling GitHub Api..."</span>);</span><br><span class="line">      resolve([<span class="string">"repo1"</span>, <span class="string">"repo2"</span>, <span class="string">"repo3"</span>]);</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCommits</span>(<span class="params">repo</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Calling GitHub Api..."</span>);</span><br><span class="line">      resolve([<span class="string">"commit"</span>]);</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Consuming-Promises"><a href="#Consuming-Promises" class="headerlink" title="Consuming Promises"></a>Consuming Promises</h3><p>我们可以链式处理复杂的异步请求，也就是完成了第一步，then第二步，then第三步</p>
<p>但是不论何时使用Promise都需要我们捕捉错误</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'Before'</span>);</span><br><span class="line">getUser(<span class="number">1</span>)</span><br><span class="line">	.then(<span class="function"><span class="params">user</span>=&gt;</span>getRespositories(user.getHubUsername))</span><br><span class="line">	.then(<span class="function"><span class="params">repos</span>=&gt;</span>getCommits(repos[<span class="number">0</span>]))</span><br><span class="line">	.then(<span class="function"><span class="params">commits</span>=&gt;</span><span class="built_in">console</span>.log(<span class="string">'Commits'</span>),commits)</span><br><span class="line">	.catch(<span class="function"><span class="params">err</span>=&gt;</span><span class="built_in">console</span>.log(<span class="string">'Error'</span>),err.message);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Reading a user from a database...."</span>);</span><br><span class="line">      resolve(&#123; <span class="attr">id</span>: id, <span class="attr">gitHubname</span>: <span class="string">"Jason"</span> &#125;);</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRepositories</span>(<span class="params">username</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Calling GitHub Api..."</span>);</span><br><span class="line">      resolve([<span class="string">"repo1"</span>, <span class="string">"repo2"</span>, <span class="string">"repo3"</span>]);</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCommits</span>(<span class="params">repo</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Calling GitHub Api..."</span>);</span><br><span class="line">      resolve([<span class="string">"commit"</span>]);</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Creating-Settled-Promises"><a href="#Creating-Settled-Promises" class="headerlink" title="Creating Settled Promises"></a>Creating Settled Promises</h3><p>有时候需要创建一个already resolved 的 promise 这在单元测试中比较常见</p>
<p>现在我们模仿一个请求服务器的异步请求成功完成，在单元测试中我们需要创建一个已经实现的Promise</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="built_in">Promise</span>.resolve(&#123;<span class="attr">id</span>:<span class="number">1</span>&#125;);</span><br><span class="line">p.then(<span class="function"><span class="params">result</span>=&gt;</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>有时候我们需要创建一个 already  reject的promise，那么我们需要返回一个Error对象，因为里面包含了堆栈错误信息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="built_in">Promise</span>.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'reason for rejection...'</span>));</span><br><span class="line">p.catch(<span class="function"><span class="params">error</span>=&gt;</span><span class="built_in">console</span>.log(error))</span><br></pre></td></tr></table></figure>
<h3 id="Running-Promises-in-Parallel"><a href="#Running-Promises-in-Parallel" class="headerlink" title="Running Promises in Parallel"></a>Running Promises in Parallel</h3><h4 id="all"><a href="#all" class="headerlink" title="all"></a>all</h4><p>我这里有俩Promise对象，现在我想同时操作这两个Promises，当他们都做完了以后我们再去做我们想要的东西。所以我们调用Promise.all传入一个Promise数组。这里将返回一个新的Promise，他将在所有Promise对象全部resolve了以后才resolve</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p1 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Async operation 1.."</span>);</span><br><span class="line">    resolve(<span class="number">1</span>);</span><br><span class="line">  &#125;, <span class="number">2000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> p2 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Async operation 2.."</span>);</span><br><span class="line">    resolve(<span class="number">2</span>);</span><br><span class="line">  &#125;, <span class="number">2000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">Promise</span>.all([p1,p2]).then(<span class="function">(<span class="params">result</span>) =&gt;</span> <span class="built_in">console</span>.log(result));</span><br><span class="line">.catch(<span class="function"><span class="params">err</span>=&gt;</span><span class="built_in">console</span>.log(err.message));</span><br></pre></td></tr></table></figure>
<p>Async operation 1..<br>Async operation 2..<br>[ 1, 2 ]</p>
<p>2s之后打印出这样的信息</p>
<p>注意，这个不是并发操作，这仍然是单线程，单线程几乎是同时进行两个 异步操作的。但这并不是真的同时。</p>
<p>当我们其中一个异步操作产生结果的时候，会把resolve的值存放在数组当中</p>
<p>注意，我们这里没有些error，但是如果Promise.all捕捉到了一个error的话（只要其中一个Promise出错了），全部Promise就没有最终返回值了</p>
<h4 id="race"><a href="#race" class="headerlink" title="race"></a>race</h4><p>但是有时候,我们并不想让这些Promises全部都满足才进行下一步操作，我们可以让一个promise完成后就进行下一步操作。这时候我们需要用到race</p>
<p>这时候 Promise数组中的一个promise is resolved 整个Promise.race就被认为是resolved 了.这时候，返回的结果不再是一个数组了，而是最快实现Promise的旅行值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.race([p1,p2]).then(<span class="function">(<span class="params">result</span>) =&gt;</span> <span class="built_in">console</span>.log(result));</span><br><span class="line">.catch(<span class="function"><span class="params">err</span>=&gt;</span><span class="built_in">console</span>.log(err.message));</span><br></pre></td></tr></table></figure>
<h3 id="Async-and-Await"><a href="#Async-and-Await" class="headerlink" title="Async and Await"></a>Async and Await</h3><p>之前我们学习了用callback函数来处理异步请求。然后用Promise来重写了。但是我们可以用js的新特性。</p>
<p>async和await.它可以让我们像写同步操作一样写异步操作</p>
<p>但是我们还是需要有一个捕获错误的功能，这时候就需要 try和catch了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"Before"</span>);</span><br><span class="line"><span class="comment">// getUser(1)</span></span><br><span class="line"><span class="comment">// 	.then(user=&gt;getRespositories(user.getHubUsername))</span></span><br><span class="line"><span class="comment">// 	.then(repos=&gt;getCommits(repos[0]))</span></span><br><span class="line"><span class="comment">// 	.then(commits=&gt;console.log('Commits'),commits)</span></span><br><span class="line"><span class="comment">// 	.catch(err=&gt;console.log('Error'),err.message);</span></span><br><span class="line"><span class="comment">//上面和下面两段代码表达的意思是一样的，但是风格不一样。</span></span><br><span class="line"><span class="comment">//下面的代码虽然写的像同步代码</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">displayCommits</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> getUser(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">const</span> repos = <span class="keyword">await</span> getRepositories(user.gitHubname);</span><br><span class="line">    <span class="keyword">const</span> commits = <span class="keyword">await</span> getCommits(repos[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">console</span>.log(commits);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Error"</span>, err.message);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">displayCommits();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"after"</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Reading a user from a database...."</span>);</span><br><span class="line">      resolve(&#123; <span class="attr">id</span>: id, <span class="attr">gitHubname</span>: <span class="string">"Jason"</span> &#125;);</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRepositories</span>(<span class="params">username</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Calling GitHub Api..."</span>);</span><br><span class="line">      resolve([<span class="string">"repo1"</span>, <span class="string">"repo2"</span>, <span class="string">"repo3"</span>]);</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCommits</span>(<span class="params">repo</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Calling GitHub Api..."</span>);</span><br><span class="line">      resolve([<span class="string">"commit"</span>]);</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Before<br>after<br>Reading a user from a database….<br>Calling GitHub Api…<br>Calling GitHub Api…<br>[ ‘commit’ ]</p>
<h3 id="Exercise"><a href="#Exercise" class="headerlink" title="Exercise"></a>Exercise</h3><p>用async和await改造这段代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">getCustomer(<span class="number">1</span>, (customer) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Customer: '</span>, customer);</span><br><span class="line">  <span class="keyword">if</span> (customer.isGold) &#123;</span><br><span class="line">    getTopMovies(<span class="function">(<span class="params">movies</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Top movies: '</span>, movies);</span><br><span class="line">      sendEmail(customer.email, movies, () =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Email sent...'</span>)</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCustomer</span>(<span class="params">id, callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    callback(&#123; </span><br><span class="line">      id: <span class="number">1</span>, </span><br><span class="line">      name: <span class="string">'Mosh Hamedani'</span>, </span><br><span class="line">      isGold: <span class="literal">true</span>, </span><br><span class="line">      email: <span class="string">'email'</span> </span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;, <span class="number">4000</span>);  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTopMovies</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    callback([<span class="string">'movie1'</span>, <span class="string">'movie2'</span>]);</span><br><span class="line">  &#125;, <span class="number">4000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendEmail</span>(<span class="params">email, movies, callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    callback();</span><br><span class="line">  &#125;, <span class="number">4000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>答：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">notifyCustomer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> customer = <span class="keyword">await</span> getCustomer(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Customer"</span>, customer);</span><br><span class="line">    <span class="keyword">if</span> (customer.isGold) &#123;</span><br><span class="line">      <span class="keyword">const</span> movies = getTopMovies();</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Top movies:"</span>, movies);</span><br><span class="line">      sendEmail(customer.email, movies);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Email sent..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">notifyCustomer();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCustomer</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      resolve(&#123;</span><br><span class="line">        id: <span class="number">1</span>,</span><br><span class="line">        name: <span class="string">"Mosh Hamedani"</span>,</span><br><span class="line">        isGold: <span class="literal">true</span>,</span><br><span class="line">        email: <span class="string">"email"</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;, <span class="number">4000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTopMovies</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      resolve([<span class="string">"movie1"</span>, <span class="string">"movie2"</span>]);</span><br><span class="line">    &#125;, <span class="number">4000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendEmail</span>(<span class="params">email, movies</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      resolve();</span><br><span class="line">    &#125;, <span class="number">4000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Customer { id: 1, name: &#39;Mosh Hamedani&#39;, isGold: true, email: &#39;email&#39; }</code><br><code>Top movies: Promise { &lt;pending&gt; }</code><br><code>Email sent...</code></p>
<h2 id="CRUD-Operations-Using-Mongoose"><a href="#CRUD-Operations-Using-Mongoose" class="headerlink" title="CRUD Operations Using Mongoose"></a>CRUD Operations Using Mongoose</h2><p>express 可以使用很多的数据库，这里我们用MongoDB。而且在node和express中经常使用</p>
<h3 id="Connecting-to-MongoDB"><a href="#Connecting-to-MongoDB" class="headerlink" title="Connecting to MongoDB"></a>Connecting to MongoDB</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">"mongoose"</span>);</span><br><span class="line">mongoose</span><br><span class="line">  .connect(<span class="string">"mongodb://localhost/playground"</span>)</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"Connected to MongoDB"</span>))</span><br><span class="line">  .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"Could not connect to MongoDB..."</span>));</span><br></pre></td></tr></table></figure>
<p>Connected to MongoDB</p>
<h3 id="Schemas"><a href="#Schemas" class="headerlink" title="Schemas"></a>Schemas</h3><p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%802/2.png" style="zoom:80%;"></p>
<p>这里 collection就是一张表，document就是列。信息是由键值对保存的</p>
<p>我们用schema来设计符合MongoDB集合的文档结构</p>
<p>我们新建张表格，在创建的时候我们创建一个对象，然后传入我们需要传入文档的键值对</p>
<p>这里又name：string类型，auther:string类型 ,tags:string 类型的数组(保存后是一个键值对数组 0:basic,1:advanced)之类的，date：一个对象，对象类型是日期，默认值是当前日期。 isPublished：布尔类型</p>
<p>Schema Types: String,Number,Date,Buffer(字节格式的数据),Boolean,ObjectID,Array</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">"mongoose"</span>);</span><br><span class="line">mongoose</span><br><span class="line">  .connect(<span class="string">"mongodb://localhost/playground"</span>)</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"Connected to MongoDB"</span>))</span><br><span class="line">  .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"Could not connect to MongoDB..."</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> courseSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">  name: <span class="built_in">String</span>,</span><br><span class="line">  auther: <span class="built_in">String</span>,</span><br><span class="line">  tags: [<span class="built_in">String</span>],</span><br><span class="line">  date: &#123; <span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">default</span>: <span class="built_in">Date</span>.now &#125;,</span><br><span class="line">  isPublish:<span class="built_in">Boolean</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Models"><a href="#Models" class="headerlink" title="Models"></a>Models</h3><p>我们用courseSchema来定义数据库中course的文档结构，现在我们要把它弄成一个Model(模型)</p>
<p>在这里我们有一个Course，我们就可以创建一个类对象nodeCourse,然后我们就可以把nodeCourse保存到数据库当中。为了创建一个Course，我们可以把courseSchema变成Model</p>
<p>mongoose.model有两个参数，第一个参数是目标集合（单数）名称，也就是数据库中的collection集合；第二个参数是这个集合所需要的schema结构。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">"mongoose"</span>);</span><br><span class="line">mongoose</span><br><span class="line">  .connect(<span class="string">"mongodb://localhost/playground"</span>)</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"Connected to MongoDB"</span>))</span><br><span class="line">  .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"Could not connect to MongoDB..."</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> courseSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">  name: <span class="built_in">String</span>,</span><br><span class="line">  auther: <span class="built_in">String</span>,</span><br><span class="line">  tags: [<span class="built_in">String</span>],</span><br><span class="line">  date: &#123; <span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">default</span>: <span class="built_in">Date</span>.now &#125;,</span><br><span class="line">  isPublish:<span class="built_in">Boolean</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> Course = mongoose.model(<span class="string">'Course'</span>,courseSchema);<span class="comment">//类</span></span><br><span class="line"><span class="comment">//新建一个对象</span></span><br><span class="line"><span class="keyword">const</span> course = <span class="keyword">new</span> Course(&#123;</span><br><span class="line">	name: <span class="string">'Node.js Course'</span>,</span><br><span class="line">	author:<span class="string">'Mosh'</span>,</span><br><span class="line">	tags:[<span class="string">'node'</span>,<span class="string">'backend'</span>]	,</span><br><span class="line">	<span class="comment">//date是有默认值的</span></span><br><span class="line">	isPublished: <span class="literal">true</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="Saving-a-Document"><a href="#Saving-a-Document" class="headerlink" title="Saving a Document"></a>Saving a Document</h3><p>保存到数据库是一个异步操作。因为保存到数据库得花点时间。因为我们要访问文件系统。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">"mongoose"</span>);</span><br><span class="line">mongoose</span><br><span class="line">  .connect(<span class="string">"mongodb://localhost/playground"</span>)</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"Connected to MongoDB"</span>))</span><br><span class="line">  .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"Could not connect to MongoDB..."</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> courseSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">  name: <span class="built_in">String</span>,</span><br><span class="line">  auther: <span class="built_in">String</span>,</span><br><span class="line">  tags: [<span class="built_in">String</span>],</span><br><span class="line">  date: &#123; <span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">default</span>: <span class="built_in">Date</span>.now &#125;,</span><br><span class="line">  isPublish: <span class="built_in">Boolean</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> Course = mongoose.model(<span class="string">"Course"</span>, courseSchema);</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">createCourse</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="comment">//我们新建一个对象，然后利用model.save方法来把他保存到数据库当中。这个方法返回一个对象。我们打印</span></span><br><span class="line">  <span class="keyword">const</span> course = <span class="keyword">new</span> Course(&#123;</span><br><span class="line">    name: <span class="string">"Node.js Course"</span>,</span><br><span class="line">    author: <span class="string">"Mosh"</span>,</span><br><span class="line">    tags: [<span class="string">"node"</span>, <span class="string">"backend"</span>],</span><br><span class="line">    <span class="comment">//date是有默认值的</span></span><br><span class="line">    isPublished: <span class="literal">true</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> course.save();</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;</span><br><span class="line">createCourse();</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%802/3.png" style="zoom:80%;"></p>
<p>不像关系型数据库，我们不用创建表格，设计表格我们只要创建文档然后存进去就可以了。</p>
<p>现在我们多建几个信息</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%802/4.png" style="zoom:80%;"></p>
<h3 id="Querying-Documents"><a href="#Querying-Documents" class="headerlink" title="Querying Documents"></a>Querying Documents</h3><p>现在我们来查询信息：</p>
<p><code>model.find()</code>我可以得到一个文档的列表</p>
<p><code>model.findById()</code>根据id找</p>
<p><code>model.findOne()</code>返回一个单一的文档</p>
<p>我们也可以 <code>model.find().then()</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourses</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> courses = <span class="keyword">await</span> Course.find();</span><br><span class="line">  <span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line">getCourses();</span><br></pre></td></tr></table></figure>
<p>这样我们就得到了两门课程</p>
<p>我们也可以加上一个过滤器，比如我们可以这样</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourses</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> courses = <span class="keyword">await</span> Course.find(&#123;<span class="attr">author</span>:<span class="string">'Mosh'</span>,<span class="attr">isPublished</span>:<span class="literal">true</span>&#125;);</span><br><span class="line">  <span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line">getCourses();</span><br></pre></td></tr></table></figure>
<p>我们也可以</p>
<p>显示信息的数目，在括号中的数值</p>
<p>对数据进行排序，传入一个对象，里面的键值对用来进行排序。升序写1，降序写-1</p>
<p>对返回的列进行选择，传入一个对象 ，想得到name和tags 那么就写1，代表选中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourses</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> courses = <span class="keyword">await</span> Course.find(&#123; <span class="attr">author</span>: <span class="string">"Mosh"</span>&#125;)</span><br><span class="line">    .limit(<span class="number">10</span>)</span><br><span class="line">    .sort(&#123; <span class="attr">name</span>: <span class="number">1</span> &#125;)</span><br><span class="line">    .select(&#123; <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">tags</span>: <span class="number">1</span> &#125;);</span><br><span class="line">  <span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line">getCourses();</span><br></pre></td></tr></table></figure>
<h3 id="Comparison-Query-Operators比较操作符"><a href="#Comparison-Query-Operators比较操作符" class="headerlink" title="Comparison Query Operators比较操作符"></a>Comparison Query Operators比较操作符</h3><p>在mongo中我们有很多操作符用来做值得比较。这些mongodb使用的操作符在mongoose中同样有效。</p>
<p><code>eq (equal)</code></p>
<p><code>ne (not equal)</code></p>
<p><code>gt(greater than)</code></p>
<p><code>gte (greter than or equal to)</code></p>
<p><code>lt (less than)</code></p>
<p><code>lte (less than or equal to )</code></p>
<p><code>in</code></p>
<p><code>nin (not in )</code></p>
<p>比如我们想找出价格大于10dollar的课程</p>
<p>在<a href="https://jasonxqh.github.io/2020/05/16/Mysql基础/">Mysql基础</a>当中，我们知道了可以直接用大于小于符号来选择，如果是in的话可以这样写IN (‘VA’,’FL’,’GA’)</p>
<p>我们怎么在json对象中描述呢？</p>
<p>我们用一个对象来代替数字，对象中是一个键值对$ 代表这是一个运算符，我们用gt来表示greater than 冒号后面的是数字。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const courses &#x3D; await Course</span><br><span class="line">	.find(&#123; price:&#123;$gt : 10&#125; &#125;)</span><br><span class="line"> console.log(courses);</span><br></pre></td></tr></table></figure>
<p>那么我们如果想找出大于10 小于20 的课程呢？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> courses = <span class="keyword">await</span> Course</span><br><span class="line">	.find(&#123; <span class="attr">price</span>:&#123;<span class="attr">$gt</span> : <span class="number">10</span>,<span class="attr">$lte</span>:<span class="number">20</span> &#125; &#125;)</span><br><span class="line"> <span class="built_in">console</span>.log(courses);</span><br></pre></td></tr></table></figure>
<p>那么我如果想找10，15 或者20 dollar的课程呢? 我们利用数组</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> courses = <span class="keyword">await</span> Course</span><br><span class="line">	.find(&#123; <span class="attr">price</span>:&#123;<span class="attr">$in</span>:[<span class="number">10</span>,<span class="number">15</span>,<span class="number">20</span>] &#125; &#125;)</span><br><span class="line"> <span class="built_in">console</span>.log(courses);</span><br></pre></td></tr></table></figure>
<h3 id="Logical-Query-Operators逻辑运算符"><a href="#Logical-Query-Operators逻辑运算符" class="headerlink" title="Logical Query Operators逻辑运算符"></a>Logical Query Operators逻辑运算符</h3><p><code>Course.find({author:&#39;Mosh&#39;,isPublished:true});</code> 表示的是and，如果我们想要表示or 有应该怎么写呢？ </p>
<p>我们可以先find()也就是全部找到</p>
<p>然后用.and 和 .or 来表达内部的逻辑是and还是or,传入的参数是一个对象数组，里面存放我们需要查找的对象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> courses = <span class="keyword">await</span> Course</span><br><span class="line">	.find()</span><br><span class="line">	.or([&#123;<span class="attr">author</span>:<span class="string">'Mosh'</span>&#125;,&#123;<span class="attr">isPublished</span>:<span class="literal">true</span>&#125;])</span><br><span class="line">	.and([])</span><br></pre></td></tr></table></figure>
<h3 id="Regular-Expressions"><a href="#Regular-Expressions" class="headerlink" title="Regular Expressions"></a>Regular Expressions</h3><p>到现在为止我们得到的都是确定的字符串，但是我们想模糊查询，怎么办呢？</p>
<p>比如我想得到<strong>以Mosh开头</strong>的课程，我们可以这样写</p>
<p>\^ 是表示开头， $表示结尾 。如果<strong>不区分大小写 </strong></p>
<p><strong>/i (忽略大小写)<br>/g (全文查找出现的所有匹配字符)<br>/m (多行查找)<br>/gi(全文查找、忽略大小写)<br>/ig(全文查找、忽略大小写)</strong></p>
<p>如果我们只是想找出包含mosh的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> courses = <span class="keyword">await</span> Course</span><br><span class="line">	.find(&#123;<span class="attr">author</span>: <span class="regexp">/^Mosh/</span> &#125;);</span><br><span class="line">	.find(&#123;<span class="attr">author</span>:<span class="regexp">/Hamedani$/i</span>&#125;)</span><br><span class="line">	.find(&#123;<span class="attr">author</span>:<span class="regexp">/.*Mosh.*/i</span>&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="Counting"><a href="#Counting" class="headerlink" title="Counting"></a>Counting</h3><p>我们如果比较关心数量而不是对象本身，我们可以这样写</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> courses = <span class="keyword">await</span> Course</span><br><span class="line">	.find()</span><br><span class="line">	.count()</span><br></pre></td></tr></table></figure>
<h3 id="Pagination"><a href="#Pagination" class="headerlink" title="Pagination"></a>Pagination</h3><p>与limit方法如影随形的是skip方法，常常用在分页器当中使用</p>
<p>为了实现分页，我们需要调过前面一页的所有文档。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourses</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> pageNumber = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">const</span> pageSize = <span class="number">10</span>;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    在这里硬编码纯粹是为了简化，在现实中我们通过RESTful API 的查询字符串来输入这两个值</span></span><br><span class="line"><span class="comment">    如果我们有一个获取课程列表的API</span></span><br><span class="line"><span class="comment">    /api/course？pageNumber=2&amp;pageSize=10</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> courses = <span class="keyword">await</span> Course</span><br><span class="line">    	.find(&#123;<span class="attr">auther</span>:<span class="string">"MOsh"</span>&#125;)</span><br><span class="line">    	.skip((pageNumber<span class="number">-1</span>)*pageSize)</span><br><span class="line">    	.limit(<span class="number">10</span>);</span><br><span class="line">    	.sort(&#123;<span class="attr">name</span>:<span class="number">1</span>&#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-1"><a href="#Exercise-1" class="headerlink" title="Exercise 1"></a>Exercise 1</h3><p>导入数据后。我们要达到这个目标</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%802/5.png" style="zoom:80%;"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"></span><br><span class="line">mongoose.connect(<span class="string">'mongodb://localhost/mongo-exercises'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> courseSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">  name: <span class="built_in">String</span>,</span><br><span class="line">  author: <span class="built_in">String</span>, </span><br><span class="line">  tags: [ <span class="built_in">String</span> ],</span><br><span class="line">  date: <span class="built_in">Date</span>, </span><br><span class="line">  isPublished: <span class="built_in">Boolean</span>,</span><br><span class="line">  price: <span class="built_in">Number</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Course = mongoose.model(<span class="string">'Course'</span>, courseSchema);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourses</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> Course</span><br><span class="line">  .find(&#123; <span class="attr">isPublished</span>: <span class="literal">true</span>, <span class="attr">tags</span>: <span class="string">'backend'</span> &#125;)</span><br><span class="line">  .sort(&#123; <span class="attr">name</span>: <span class="number">1</span> &#125;)</span><br><span class="line">  .select(&#123; <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">author</span>: <span class="number">1</span> &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> courses = <span class="keyword">await</span> getCourses();</span><br><span class="line">  <span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run();</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-2"><a href="#Exercise-2" class="headerlink" title="Exercise 2"></a>Exercise 2</h3><p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%802/6.png" style="zoom:80%;"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"></span><br><span class="line">mongoose.connect(<span class="string">'mongodb://localhost/mongo-exercises'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> courseSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">  name: <span class="built_in">String</span>,</span><br><span class="line">  author: <span class="built_in">String</span>, </span><br><span class="line">  tags: [ <span class="built_in">String</span> ],</span><br><span class="line">  date: <span class="built_in">Date</span>, </span><br><span class="line">  isPublished: <span class="built_in">Boolean</span>,</span><br><span class="line">  price: <span class="built_in">Number</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Course = mongoose.model(<span class="string">'Course'</span>, courseSchema);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourses</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> Course</span><br><span class="line">  .find(&#123; <span class="attr">isPublished</span>: <span class="literal">true</span>&#125;,&#123;<span class="attr">tags</span>:&#123;<span class="attr">$in</span>:[<span class="string">'frontend'</span>,<span class="string">'backend'</span>]&#125;&#125;)</span><br><span class="line">  .sort(<span class="string">'-price'</span>)<span class="comment">//不传入一个对象，我们也可以用字符串来代替</span></span><br><span class="line">  .select(<span class="string">'name author'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//或者用or .or([&#123;tags:'frontend'&#125;,&#123;tags:'backend'&#125;]) 效果是一样的</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> courses = <span class="keyword">await</span> getCourses();</span><br><span class="line">  <span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run();</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3"><a href="#Exercise-3" class="headerlink" title="Exercise 3"></a>Exercise 3</h3><p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%802/7.png" style="zoom:80%;"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"></span><br><span class="line">mongoose.connect(<span class="string">'mongodb://localhost/mongo-exercises'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> courseSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">  name: <span class="built_in">String</span>,</span><br><span class="line">  author: <span class="built_in">String</span>, </span><br><span class="line">  tags: [ <span class="built_in">String</span> ],</span><br><span class="line">  date: <span class="built_in">Date</span>, </span><br><span class="line">  isPublished: <span class="built_in">Boolean</span>,</span><br><span class="line">  price: <span class="built_in">Number</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Course = mongoose.model(<span class="string">'Course'</span>, courseSchema);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourses</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> Course</span><br><span class="line">  .find()</span><br><span class="line">  .or([</span><br><span class="line">      &#123;<span class="attr">author</span>:<span class="regexp">/.*by.*/i</span>&#125;,</span><br><span class="line">      &#123;<span class="attr">price</span>:&#123;<span class="attr">$gte</span>:<span class="number">15</span>&#125;&#125;</span><br><span class="line">  ])</span><br><span class="line">  .select(<span class="string">'name author'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//或者用or .or([&#123;tags:'frontend'&#125;,&#123;tags:'backend'&#125;]) 效果是一样的</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> courses = <span class="keyword">await</span> getCourses();</span><br><span class="line">  <span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run();</span><br></pre></td></tr></table></figure>
<h3 id="Updating-a-Document-Query-First"><a href="#Updating-a-Document-Query-First" class="headerlink" title="Updating a Document- Query First"></a>Updating a Document- Query First</h3><p>比如我有个ispublished=true的话，author不允许被修改的规则，那么我们可以这样修改<code>if(course.isPublished) return ;</code></p>
<p>如何来更新数据库文档?</p>
<p>先来介绍 Query First 也就是先查询再更新</p>
<p><code>Approach:Update first</code></p>
<p><code>findById</code></p>
<p><code>Modify its properties</code></p>
<p><code>save()</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">updateCourse</span>(<span class="params">id</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">const</span> course=<span class="keyword">await</span> Course.findById(id);</span><br><span class="line">	<span class="keyword">if</span>(!course) <span class="keyword">return</span> ;</span><br><span class="line">	course.isPublished = <span class="literal">true</span>;</span><br><span class="line">	course.auther = <span class="string">'Another Author'</span></span><br><span class="line">	<span class="keyword">const</span> result = <span class="keyword">await</span> course.save();</span><br><span class="line">	<span class="built_in">console</span>.log(result)</span><br><span class="line">&#125;</span><br><span class="line">updateCourse(<span class="string">'5a68fdd7bee8ea64649c2777'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Updating-a-Document-Update-First"><a href="#Updating-a-Document-Update-First" class="headerlink" title="Updating a Document- Update First"></a>Updating a Document- Update First</h3><p>我们也可以直接接入数据库修改文档</p>
<p><code>Approach:Update first</code></p>
<p><code>Update directly</code></p>
<p><code>Optionally: get the updated document</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">updateCourse</span>(<span class="params">id</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//update()的第一个参数是一个filter，可以一次更新很多文档！</span></span><br><span class="line">	<span class="keyword">const</span> result=<span class="keyword">await</span> Course.update(&#123;<span class="attr">_id</span>:id&#125;,&#123;</span><br><span class="line"><span class="comment">//这是实现更新操作的结果而非复合的文档,也就是说我们把满足条件的信息都进行修改</span></span><br><span class="line">	 $<span class="keyword">set</span>:&#123;</span><br><span class="line">	 	author: <span class="string">'Mosh'</span>,</span><br><span class="line">	 	isPublished:<span class="literal">false</span></span><br><span class="line">	 &#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	<span class="built_in">console</span>.log(result)</span><br><span class="line">&#125;</span><br><span class="line">updateCourse(<span class="string">'5a68fdd7bee8ea64649c2777'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Removing-Documents"><a href="#Removing-Documents" class="headerlink" title="Removing Documents"></a>Removing Documents</h3><p>怎么删除文档呢？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">removeCourse</span>(<span class="params">id</span>)</span>&#123;</span><br><span class="line"><span class="comment">//deleteOne()是删除一条信息，参数是一个过滤器,他将找到第一个符合对象的并且删除</span></span><br><span class="line">	<span class="keyword">const</span> result = <span class="keyword">await</span> Course.deleteOne(&#123;<span class="attr">_id</span>:id&#125;)</span><br><span class="line"><span class="comment">//deleteMany()删除符合条件的所有信息</span></span><br><span class="line">	<span class="keyword">const</span> result = <span class="keyword">await</span> Course.deleteMany(&#123;<span class="attr">_id</span>:id&#125;)</span><br><span class="line"><span class="comment">//如果我想得到被删除的文档，我可以使用findByIdAndRemove方法,如果给定的id不存在，就会返回null</span></span><br><span class="line">	<span class="keyword">const</span> course = <span class="keyword">await</span> Course.findByIdAndRemove(&#123;<span class="attr">_id</span>:id&#125;)</span><br><span class="line">	<span class="built_in">console</span>.log(course);</span><br><span class="line">&#125;</span><br><span class="line">removeCourse(<span class="string">'5a68fdd7bee8ea64649c2777'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="CRUD-Operations-with-Mongoose-and-MongoDB-Recap"><a href="#CRUD-Operations-with-Mongoose-and-MongoDB-Recap" class="headerlink" title="CRUD Operations with Mongoose and MongoDB Recap"></a>CRUD Operations with Mongoose and MongoDB Recap</h3><p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%802/8.png"></p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%802/9.png"></p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%802/10.png"></p>

          
        
      
    </div>
    
    
    
    <div>
      
    </div>
    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://jasonxqh.github.io/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/%5Bobject%20Object%5D">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/" itemprop="url">Nodejs基础1</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-07T20:53:15+08:00">
                2020-06-07
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2020-06-30T10:38:26+08:00">
                2020-06-30
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/node/" itemprop="url" rel="index">
                    <span itemprop="name">node</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Nodejs基础1"><a href="#Nodejs基础1" class="headerlink" title="Nodejs基础1"></a>Nodejs基础1</h1><p>在 <a href="https://jasonxqh.github.io/2020/06/02/react基础2/">react基础2</a>  <a href="https://jasonxqh.github.io/2020/06/04/react基础3/">react基础3表单与后端</a>  <a href="https://jasonxqh.github.io/2020/06/05/react基础4授权与部署/">react基础4授权与部署</a></p>
<p>这三篇博客中，我们讨论了vidly(一个电影展示项目)的客户端，但是我们在博客中仅仅调用了后端的api，对后端如何构建并没有提及。而Nodejs构造的后端是期末大作业中必不可少的一部分，所以这个系列让我们来谈谈如何用Nodejs+express+mongodb来构建一个vidly后端。</p>
<h2 id="Building-RESTful-API’s-Using-Express"><a href="#Building-RESTful-API’s-Using-Express" class="headerlink" title="Building RESTful API’s Using Express"></a>Building RESTful API’s Using Express</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>下面利用express框架搭建后端</p>
<h3 id="RESTful-Services"><a href="#RESTful-Services" class="headerlink" title="RESTful Services"></a>RESTful Services</h3><p>大多数的网站结构如下：</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/1.png" style="zoom:80%;"></p>
<p>RESTful 就是 Representational State Transfer 的缩写，是用来创建这些规范的HTTP服务的。我们利用简单的Http语言来进行增删改查，也就是CRUD operations</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/2.png" style="zoom:80%;"></p>
<p>大多数的网站url如下</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/3.png" style="zoom:80%;"></p>
<p>我们常常在.com后看到/api，这不是必要的规定，但是可以见到很多公司都遵循这个范式。customer代表了应用中用户的集合。在RESTful中我们把它看成是一种资源。我们可以把诸如用户，电影，租金或者各种资源都开放出去。所以可以是/rentals，/movies 不同的后缀代表操纵不同的用户资源。这个/customer可以对用户资源进行操作比如说创建用户，更新用户信息。</p>
<p>所有的HTTP请求都有所谓的动作或者方法，取决于他们的类型和目的</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/4.png" style="zoom:80%;"></p>
<p>每个动作的模型如下</p>
<p>GET：获取到所有的用户的信息，返回一个列表。如果想单独得到一个用户的信息，需要这么写</p>
<p>/api/customers/1,这样就只返回一个用户的信息</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/5.png" style="zoom: 67%;"></p>
<p>PUT：用户更新</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/6.png" style="zoom: 67%;"></p>
<p>DELETE：删除操作</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/7.png" style="zoom: 67%;"></p>
<p>POST：新建操作</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/8.png" style="zoom: 67%;"></p>
<p>接下来我们把关注点集中在创建http服务上面。因此不适用数据库，就使用简单的数组在内存中保存数据</p>
<h3 id="Introducing-Express"><a href="#Introducing-Express" class="headerlink" title="Introducing Express"></a>Introducing Express</h3><p><a href="http://expressjs.com/en/4x/api.html" target="_blank" rel="noopener">express官方文档</a></p>
<p>express可以更方便的帮助我们管理路由</p>
<p>Express框架可以在良好维护性的前提下创建很多路由规则</p>
<p>新建一个express-demo文件夹，npm init —yes 新建package-json</p>
<p>npm install express</p>
<h3 id="Building-Your-First-Web-Server"><a href="#Building-Your-First-Web-Server" class="headerlink" title="Building Your First Web Server"></a>Building Your First Web Server</h3><p>这里说一嘴 require和import的区别</p>
<p><strong>import和require都是被模块化使用</strong></p>
<ol>
<li><p><strong>a.</strong>  require是CommonJs的语法（AMD规范引入方式），CommonJs的模块是对象。<br> <strong>b.</strong>  import是es6的一个语法标准（浏览器不支持，本质是使用node中的babel将es6转码为es5再执行，import会被转码为require），es6模块不是对象</p>
</li>
<li><p><strong>a. </strong>  require是运行时加载整个模块（即模块中所有方法），生成一个对象，再从对象上读取它的方法（只有运行时才能得到这        个对象,不能在编译时做到静态化），理论上可以用在代码的任何地方<br><strong>b.</strong> import是编译时调用，确定模块的依赖关系，输入变量（es6模块不是对象，而是通过export命令指定输出代码，再通过         import输入，只加载import中导的方法，其他方法不加载），import具有提升效果，会提升到模块的头部（编译时执行）<br> export和import可以位于模块中的任何位置，但是必须是在模块顶层，如果在其他作用域内，会报错<br> es6这样的设计可以提高编译器效率，但没法实现运行时加载</p>
</li>
<li><p><strong>a.  </strong>require是赋值过程，把require的结果（对象，数字，函数等），默认是export的一个对象，赋给某个变量（复制或浅拷贝）<br><strong>b. </strong> import是解构过程（需要谁，加载谁）</p>
</li>
</ol>
<p><a href="https://www.cnblogs.com/suneil/p/11289884.html" target="_blank" rel="noopener">引用于此</a></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//我们首先引入express</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="comment">//然后为了方便我们保存在app中，这个app就代表了我们的应用</span></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">1.我们现在只用app.get() 这需要两个参数，第一个参数是路径，也就是URL;第二个参数是一个回调函数</span></span><br><span class="line"><span class="comment">2.回调函数在给定端口使用get方法时被调用。回调函数有两个函数，request和response，用req，res代替</span></span><br><span class="line"><span class="comment">3.然后是函数体的代码块。request参数给了我们很多请求的属性，可以参考exprss文档</span></span><br><span class="line"><span class="comment">4.我们这里申请了两个路由，一个返回helloworld，一个返回一个数组</span></span><br><span class="line"><span class="comment">5.最后我们要监听特定的端口，我们调用app.listen方法，给他一个端口号，然后给他一个回调函数，来显示</span></span><br><span class="line"><span class="comment">成功以后显示的文字</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">"/"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(<span class="string">"Hello World"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.get(<span class="string">"/api/courses"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line">&#125;);</span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; <span class="built_in">console</span>.log(<span class="string">"Listening on port 3000.."</span>));</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/9.png" style="zoom: 67%;"><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/10.png" style="zoom: 67%;"></p>
<h3 id="Nodemon"><a href="#Nodemon" class="headerlink" title="Nodemon"></a>Nodemon</h3><p>Nodemon可以实时监控后端更改的内容并更新服务器。所以就不用每次修改以后重启服务器了</p>
<p>npm install -g nodemon</p>
<p>nodemon index.js 让nodemon检测该文件夹中所有文件、任何文件名和任何扩展名的改动</p>
<p><a href="https://blog.csdn.net/awsl_666/article/details/103043827" target="_blank" rel="noopener">如果报错看这里</a></p>
<h3 id="Environment-Variables"><a href="#Environment-Variables" class="headerlink" title="Environment Variables"></a>Environment Variables</h3><p>我们现在是规定了在3000端口，但是可能会产生端口冲突，为了解决这个问题我们可以使用环境变量</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">"/"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(<span class="string">"Hello World!!!"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.get(<span class="string">"/api/courses"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//port </span></span><br><span class="line"><span class="keyword">const</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line">app.listen(port, () =&gt; <span class="built_in">console</span>.log(<span class="string">`Listening on port <span class="subst">$&#123;port&#125;</span>..`</span>));</span><br></pre></td></tr></table></figure>
<p>然后设置 set PORT=5000，那么就有两种选择了</p>
<h3 id="Route-Parameters"><a href="#Route-Parameters" class="headerlink" title="Route Parameters"></a>Route Parameters</h3><p>我们现在想获得单一课程的信息也就是 /api/courses/1 </p>
<p>我们在 <a href="https://jasonxqh.github.io/2020/06/02/react基础2/">react基础2</a>  的路由部分有所提及 路由变量</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">"/api/courses/:id"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(req.params.id);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/11.png" style="zoom: 67%;"></p>
<p>也可以有多个变量</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">"/api/posts/:year/:month"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(req.params );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>当我们传入这个的时候，<a href="http://localhost:3000/api/posts/2020/6" target="_blank" rel="noopener">http://localhost:3000/api/posts/2020/6</a> 会显示如下对象</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/12.png" style="zoom: 67%;"></p>
<p>使用这种表达式也可以读取查询字符串。也就是在url后面的参数</p>
<p><a href="http://localhost:3000/api/posts/2020/6?sortBy=name" target="_blank" rel="noopener">http://localhost:3000/api/posts/2020/6?sortBy=name</a> </p>
<p>这个表达式的意思获取所有2020年6 月的帖子，然后根据名字来排序。sortBy=name  是查询字符串。我们使用它来向后端服务传递额外的参数。</p>
<p>所以我们用路由参数提供路由必须的数据与值，使用查询字符串传递附加的内容。</p>
<p>后端可以这么来读取查询字符串</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">"/api/posts/:year/:month"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(req.query);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/13.png" style="zoom: 67%;"></p>
<h3 id="Handling-HTTP-GET-Requests"><a href="#Handling-HTTP-GET-Requests" class="headerlink" title="Handling HTTP GET Requests"></a>Handling HTTP GET Requests</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="comment">//首先定义一个数组</span></span><br><span class="line"><span class="keyword">const</span> courses = [</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">"course1"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">"course2"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">3</span>, <span class="attr">name</span>: <span class="string">"course3"</span> &#125;,</span><br><span class="line">];</span><br><span class="line"><span class="comment">//如果没有路由参数，那么把所有的都返回</span></span><br><span class="line">app.get(<span class="string">"/api/courses"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(courses);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//如果有参数，那么在数组中选择数组元素对象中id等于路由参数id的，返回(注意,req.params.id需要转换)</span></span><br><span class="line">app.get(<span class="string">"/api/courses/:id"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> course = courses.find(<span class="function">(<span class="params">c</span>) =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">  <span class="keyword">if</span> (!course)<span class="comment">//那么如果这个id不存在的话，我们就需要返回404</span></span><br><span class="line">    res.status(<span class="number">404</span>).send(<span class="string">"The course with the given ID was not found "</span>);</span><br><span class="line">  res.send(course);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>入读，我们id=1，匹配到，那么就返回这个对象。否则返回 The course with the given ID was not found</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/14.png" style="zoom: 67%;"></p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/15.png" style="zoom: 67%;"></p>
<h3 id="Handling-HTTP-POST-Requests"><a href="#Handling-HTTP-POST-Requests" class="headerlink" title="Handling HTTP POST Requests"></a>Handling HTTP POST Requests</h3><p>现在我们利用post请求创建新的课程</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">为了能让这个put正常工作，我们需要打开Express获取请求体中JSON对象的功能，我们需要手动设置</span></span><br><span class="line"><span class="comment">这里我们做的其实是添加了一个中间件。当我们调用express.json的时候这个方法返回了一个中间件</span></span><br><span class="line"><span class="comment">然后我们用use方法在处理请求流程中使用这个中间件</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">app.use(express.json());</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">app.post(<span class="string">"/api/courses"</span>, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    	在handler中我们需要新建一个课程信息，然后把他添加到课程数组当中去</span></span><br><span class="line"><span class="comment">    因为没有数据库所以我们要手动设置ID，之后用了数据库ID就会由数据库自动生成</span></span><br><span class="line"><span class="comment">    	这里假设在request中有一个对象，对象中包含了一个name属性。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="keyword">const</span> course = &#123;</span><br><span class="line">    id: courses.length + <span class="number">1</span>,</span><br><span class="line">    name: req.body.name,</span><br><span class="line">  &#125;;</span><br><span class="line">  courses.push(course);<span class="comment">//利用push把这个对象加入到courses数组中</span></span><br><span class="line"><span class="comment">//最后作为惯例，当我们让服务器创建了新的对象或者资源的时候，我们应返回</span></span><br><span class="line">    <span class="comment">//因为客户端可能需要用到这个新创建的值</span></span><br><span class="line">  res.send(course);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Calling-Endpoints-Using-Postman"><a href="#Calling-Endpoints-Using-Postman" class="headerlink" title="Calling Endpoints Using Postman"></a>Calling Endpoints Using Postman</h3><p>我们利用google插件postman，在<a href="https://jasonxqh.github.io/2020/06/04/react基础3/">react基础3表单与后端</a> 中有所介绍</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/17.png" style="zoom: 80%;"></p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/16.png" style="zoom: 100%;"></p>
<p>这就是如何使用postman测试http终端。在实现过程中我们假设请求体中包含一个name属性的对象。</p>
<h3 id="Input-Validation"><a href="#Input-Validation" class="headerlink" title="Input Validation"></a>Input Validation</h3><p>但是如果用户传入了不合法的数据，那么我们需要对其验证。</p>
<p>从安全角度，我们永远不要相信客户输入的内容，所以我们要永远验证输入的内容</p>
<p>在这里我们可以简单写一个验证逻辑</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">app.post(<span class="string">"/api/courses"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (!req.body.name || req.body.name.length &lt; <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="comment">//400 Bad Request</span></span><br><span class="line">    res.status(<span class="number">400</span>).send(<span class="string">"Name is required and should be minimum 3 characters"</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> course = &#123;</span><br><span class="line">    id: courses.length + <span class="number">1</span>,</span><br><span class="line">    name: req.body.name,</span><br><span class="line">  &#125;;</span><br><span class="line">  courses.push(course);</span><br><span class="line">  res.send(course);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>如果不想写复杂的逻辑，我们可以导入一个包 在<a href="https://jasonxqh.github.io/2020/06/04/react基础3/">react基础3表单与后端</a> 中有提到Joi。在后端也可以使用</p>
<p>npm i joi@13.1.0</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">app.post(<span class="string">"/api/courses"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> schema = &#123;</span><br><span class="line">    name: Joi.string().min(<span class="number">3</span>).required(),</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> result = Joi.validate(req.body, schema);</span><br><span class="line">  <span class="keyword">if</span> (result.error) &#123;</span><br><span class="line">    <span class="comment">//400 Bad Request</span></span><br><span class="line">      <span class="built_in">console</span>.log(result);</span><br><span class="line">    res.status(<span class="number">400</span>).send(result.error.details[<span class="number">0</span>].message);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>如果正确，那么我们就打印出来的是一个对象，对象中error属性为null</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/18.png" style="zoom: 100%;"></p>
<p>反之我们对象中就有一个错误了</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/19.png" style="zoom: 100%;"></p>
<p>我们如果res.status(400).send(result.error);会显示一个比较复杂的对象，我们整整需要的是details中的message</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/20.png" style="zoom: 100%;"></p>
<p>所以我们改成这样res.status(400).send(result.error.details[0].message);当再次发送空的name或者name.length&lt;3 的话，在postman中我们得到这两个报错</p>
<p>“name” is required</p>
<p>“name” length must be at least 3 characters long</p>
<h3 id="Handling-HTTP-PUT-Requests"><a href="#Handling-HTTP-PUT-Requests" class="headerlink" title="Handling HTTP PUT Requests"></a>Handling HTTP PUT Requests</h3><p>这里重构了一下，把验证单独抽离出来成为一个函数。</p>
<p>逻辑是这样的，先验证是否存在这个id，再验证要修改的内容是否合法，最后进行更新和返回</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateCourse</span>(<span class="params">course</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> schema = &#123;</span><br><span class="line">    name: Joi.string().min(<span class="number">3</span>).required(),</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> Joi.validate(course, schema);</span><br><span class="line">&#125;</span><br><span class="line">app.put(<span class="string">"/api/courses/:id"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="comment">// Look up the course</span></span><br><span class="line">  <span class="comment">//If not existing ,return 404</span></span><br><span class="line">  <span class="keyword">const</span> course = courses.find(<span class="function">(<span class="params">c</span>) =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">  <span class="keyword">if</span> (!course)</span><br><span class="line">    res.status(<span class="number">404</span>).send(<span class="string">"The course with the given ID was not found "</span>);</span><br><span class="line">  <span class="comment">//Validate</span></span><br><span class="line">  <span class="comment">//If invalid,return 400-Bad request</span></span><br><span class="line">  <span class="keyword">const</span> &#123; error &#125; = validateCourse(req.body);</span><br><span class="line">  <span class="keyword">if</span> (error) &#123;</span><br><span class="line">    <span class="comment">//400 Bad Request</span></span><br><span class="line">    res.status(<span class="number">400</span>).send(error.details[<span class="number">0</span>].message);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//Update course</span></span><br><span class="line">  course.name = req.body.name;</span><br><span class="line">  <span class="comment">//Return the updated course</span></span><br><span class="line">  res.send(course);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/22.png" style="zoom: 100%;"></p>
<h3 id="Handling-HTTP-Delete-Requests"><a href="#Handling-HTTP-Delete-Requests" class="headerlink" title="Handling HTTP Delete Requests"></a>Handling HTTP Delete Requests</h3><p>删除的逻辑：首先找到movie.id，找不到返回404，找到了我们就取这个课程的id。通过splice函数删除</p>
<p>splice(从第几个元素开始,删除几个元素)</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">app.delete(<span class="string">"/api/courses/:id"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="comment">//look up the course</span></span><br><span class="line">  <span class="comment">//Not existing ,return 404</span></span><br><span class="line">  <span class="keyword">const</span> course = courses.find(<span class="function">(<span class="params">c</span>) =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">  <span class="keyword">if</span> (!course)</span><br><span class="line">    res.status(<span class="number">404</span>).send(<span class="string">"The course with the given ID was not found "</span>);</span><br><span class="line">  <span class="comment">//Delete</span></span><br><span class="line">  <span class="keyword">const</span> index = courses.indexOf(course);</span><br><span class="line">  courses.splice(index, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Return the same course</span></span><br><span class="line">  res.send(course);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>如果传入<a href="http://localhost:3000/api/courses/10" target="_blank" rel="noopener">http://localhost:3000/api/courses/10</a></p>
<p>得到 The course with the given ID was not found</p>
<p>我们先来删除，再获取，发现已经找不到courses/1了</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/24.png" style="zoom: 80%;"></p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/23.png" style="zoom: 100%;"></p>
<p>代码还需要做一个小改进，就是当发现错误的时候，立即return</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> Joi = <span class="built_in">require</span>(<span class="string">"joi"</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line">app.use(express.json());</span><br><span class="line"><span class="keyword">const</span> courses = [</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">"course1"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">"course2"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">3</span>, <span class="attr">name</span>: <span class="string">"course3"</span> &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">"/"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(<span class="string">"Hello World!!!"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.get(<span class="string">"/api/courses"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(courses);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">"/api/courses/:id"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> course = courses.find(<span class="function">(<span class="params">c</span>) =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">  <span class="keyword">if</span> (!course)</span><br><span class="line">    <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">"The course with the given ID was not found "</span>);</span><br><span class="line">  res.send(course);</span><br><span class="line">&#125;);</span><br><span class="line">app.get(<span class="string">"/api/posts/:year/:month"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(req.query);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateCourse</span>(<span class="params">course</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> schema = &#123;</span><br><span class="line">    name: Joi.string().min(<span class="number">3</span>).required(),</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> Joi.validate(course, schema);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">"/api/courses"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; error &#125; = validateCourse(req.body);</span><br><span class="line">  <span class="keyword">if</span> (error)</span><br><span class="line">    <span class="comment">//400 Bad Request</span></span><br><span class="line">    <span class="keyword">return</span> res.status(<span class="number">400</span>).send(error.details[<span class="number">0</span>].message);</span><br><span class="line">  <span class="keyword">const</span> course = &#123;</span><br><span class="line">    id: courses.length + <span class="number">1</span>,</span><br><span class="line">    name: req.body.name,</span><br><span class="line">  &#125;;</span><br><span class="line">  courses.push(course);</span><br><span class="line">  res.send(course);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.put(<span class="string">"/api/courses/:id"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="comment">// Look up the course</span></span><br><span class="line">  <span class="comment">//If not existing ,return 404</span></span><br><span class="line">  <span class="keyword">const</span> course = courses.find(<span class="function">(<span class="params">c</span>) =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">  <span class="keyword">if</span> (!course)</span><br><span class="line">    <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">"The course with the given ID was not found "</span>);</span><br><span class="line">  <span class="comment">//Validate</span></span><br><span class="line">  <span class="comment">//If invalid,return 400-Bad request</span></span><br><span class="line">  <span class="keyword">const</span> &#123; error &#125; = validateCourse(req.body);</span><br><span class="line">  <span class="keyword">if</span> (error)</span><br><span class="line">    <span class="comment">//400 Bad Request</span></span><br><span class="line">    <span class="keyword">return</span> res.status(<span class="number">400</span>).send(error.details[<span class="number">0</span>].message);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Update course</span></span><br><span class="line">  course.name = req.body.name;</span><br><span class="line">  <span class="comment">//Return the updated course</span></span><br><span class="line">  res.send(course);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.delete(<span class="string">"/api/courses/:id"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="comment">//look up the course</span></span><br><span class="line">  <span class="comment">//Not existing ,return 404</span></span><br><span class="line">  <span class="keyword">const</span> course = courses.find(<span class="function">(<span class="params">c</span>) =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">  <span class="keyword">if</span> (!course)</span><br><span class="line">    <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">"The course with the given ID was not found "</span>);</span><br><span class="line">  <span class="comment">//Delete</span></span><br><span class="line">  <span class="keyword">const</span> index = courses.indexOf(course);</span><br><span class="line">  courses.splice(index, <span class="number">1</span>);</span><br><span class="line">  res.send(course);</span><br><span class="line">  <span class="comment">// Return the same course</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//port</span></span><br><span class="line"><span class="keyword">const</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line">app.listen(port, () =&gt; <span class="built_in">console</span>.log(<span class="string">`Listening on port <span class="subst">$&#123;port&#125;</span>..`</span>));</span><br></pre></td></tr></table></figure>
<h3 id="Project-Build-the-Genres-API"><a href="#Project-Build-the-Genres-API" class="headerlink" title="Project- Build the Genres API"></a>Project- Build the Genres API</h3><p>现在我们来船舰vidly应用的后端</p>
<p>首先我们创建一个管理电影分类的终端。每个电影都有自己的分类</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Joi = <span class="built_in">require</span>(<span class="string">'joi'</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app.use(express.json());</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> genres = [</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">'Action'</span> &#125;,  </span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">'Horror'</span> &#125;,  </span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">3</span>, <span class="attr">name</span>: <span class="string">'Romance'</span> &#125;,  </span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/api/genres'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(genres);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/api/genres'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; error &#125; = validateGenre(req.body); </span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">return</span> res.status(<span class="number">400</span>).send(error.details[<span class="number">0</span>].message);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> genre = &#123;</span><br><span class="line">    id: genres.length + <span class="number">1</span>,</span><br><span class="line">    name: req.body.name</span><br><span class="line">  &#125;;</span><br><span class="line">  genres.push(genre);</span><br><span class="line">  res.send(genre);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.put(<span class="string">'/api/genres/:id'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> genre = genres.find(<span class="function"><span class="params">c</span> =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">  <span class="keyword">if</span> (!genre) <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">'The genre with the given ID was not found.'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; error &#125; = validateGenre(req.body); </span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">return</span> res.status(<span class="number">400</span>).send(error.details[<span class="number">0</span>].message);</span><br><span class="line">  </span><br><span class="line">  genre.name = req.body.name; </span><br><span class="line">  res.send(genre);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.delete(<span class="string">'/api/genres/:id'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> genre = genres.find(<span class="function"><span class="params">c</span> =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">  <span class="keyword">if</span> (!genre) <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">'The genre with the given ID was not found.'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> index = genres.indexOf(genre);</span><br><span class="line">  genres.splice(index, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  res.send(genre);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/api/genres/:id'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> genre = genres.find(<span class="function"><span class="params">c</span> =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">  <span class="keyword">if</span> (!genre) <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">'The genre with the given ID was not found.'</span>);</span><br><span class="line">  res.send(genre);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateGenre</span>(<span class="params">genre</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> schema = &#123;</span><br><span class="line">    name: Joi.string().min(<span class="number">3</span>).required()</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Joi.validate(genre, schema);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line">app.listen(port, () =&gt; <span class="built_in">console</span>.log(<span class="string">`Listening on port <span class="subst">$&#123;port&#125;</span>...`</span>));</span><br></pre></td></tr></table></figure>
<h3 id="A-Quick-Note"><a href="#A-Quick-Note" class="headerlink" title="A Quick Note"></a>A Quick Note</h3><p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/25.png" style="zoom: 80%;"></p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/26.png" style="zoom: 80%;"></p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/27.png" style="zoom: 80%;"></p>
<h2 id="Express-Advanced-Topics"><a href="#Express-Advanced-Topics" class="headerlink" title="Express- Advanced Topics"></a>Express- Advanced Topics</h2><h3 id="Introduction-1"><a href="#Introduction-1" class="headerlink" title="Introduction"></a>Introduction</h3><p>在这章节我们会学Middleware,Configuration,Debugging,Template Engines</p>
<h3 id="Middleware"><a href="#Middleware" class="headerlink" title="Middleware"></a>Middleware</h3><p>express中的一个核心概念就是中间件（中间件函数） 。一个中间件技术上说就是：我们得到一个请求对象，要么返回客户端，要么传递给一个中间件。</p>
<p>在Express当中，所有route handler都是中间件：因为它需要传入一个请求对象，并且在这里向客户端返回数据。 express.json() 这个函数返回一个中间件。这个函数的作用就是读取请求，如果请求体是一个JSON格式的对象。他就会格式化这个JSON对象并以此设置req.body属性</p>
<p>处理模型大致是这样的。当服务器收到一个请求，请求就进入一个管道，我们将这个管道成为请求处理管道(Request Processing Pipeline) 管道之中由一个或者多个中间件。每个中间件要么根据请求向客户端返回数据，要么将控制权交给其他的中间件</p>
<p>之前的代码中这个 RPP中由两个中间件，一个是把请求转化成一个JSON格式对象，它并没有终结Request Response Circle,所以他把控制权交给了下一个中间件，也就是route handler 。route handler中 req.body属性已经设置好了，这样就可以进行一些操作了。 最后向客户端发送反馈来终结 Request Response Circle</p>
<p>Express中有内部中间件函数，我们同样也可以在RPP中添加自定义的中间件函数</p>
<p>使用自定义的中间件，我们可以创建 Crosscutting Concerns，比如实现登录验证等功能。</p>
<h3 id="Creating-Custom-Middleware"><a href="#Creating-Custom-Middleware" class="headerlink" title="Creating Custom Middleware"></a>Creating Custom Middleware</h3><p>我们通过调用use方法在RPP中安插一个中间件。传入一个函数，里面有三个参数。next表示管道中下一个中间件的引用。这里写了两个中间件。注意，一定要写next()把控制权交给下一个中间件，否则的话我们没有闭合 Request Response Circle，那么就一直显示Loading… </p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/28.png" style="zoom: 67%;"></p>
<p>中间件是按照顺序调用的，首先调用logging函数，其次调用 Authenticating函数</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/29.png" style="zoom: 80%;"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'logging...'</span>);</span><br><span class="line">    next();</span><br><span class="line">&#125;)</span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Authenticating...'</span>);</span><br><span class="line">    next();</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>为了让代码变得更加简明，当我们创建中间件的时候我们不要写在index中。我们要把每个中间件放在各自独立的文件当中</p>
<p>新建一个logger.js存放我们的中间件</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"logging..."</span>);</span><br><span class="line">  next();</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = log;</span><br></pre></td></tr></table></figure>
<p>在index中导入</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> logger = <span class="built_in">require</span>(<span class="string">"./logger"</span>);</span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(logger);</span><br></pre></td></tr></table></figure>
<p>现在理解了express.json()的意思了吧。当我们调用它时，他返回了一个需要三个参数的函数。req，res，next</p>
<p>他格式化了请求体，如果是一个JSON对象他就设置为req.body属性</p>
<h3 id="Built-in-Middleware"><a href="#Built-in-Middleware" class="headerlink" title="Built-in Middleware"></a>Built-in Middleware</h3><p>Express有很多Built-in 中间件，比如 express.json()</p>
<p>还有类似的中间件app.use(express.urlencode());</p>
<p>app.use(express.static(’public‘)); 我们可以把所有静态文件（css，图片等）放到这里去，static中间件是从根目录开始起作用的</p>
<p>这样就可以通过url访问这些文件了</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/30.png" style="zoom: 80%;"></p>
<h3 id="Third-party-Middleware-第三方中间件"><a href="#Third-party-Middleware-第三方中间件" class="headerlink" title="Third-party Middleware 第三方中间件"></a>Third-party Middleware 第三方中间件</h3><p><a href="http://expressjs.com/en/resources/middleware.html" target="_blank" rel="noopener">官方文档</a>中有很多中间件</p>
<p>这里我们使用helmet 中间件，Helps secure your apps by setting various HTTP headers</p>
<p>npm i helmet</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> helmet = <span class="built_in">require</span>(<span class="string">"helmet"</span>);</span><br><span class="line">app.use(helmet);</span><br></pre></td></tr></table></figure>
<p>另一个有用的中间件是Morgan，我们利用它来进行HTTP请求的日志记录.这里是用最简单的格式，tiny</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> morgan = <span class="built_in">require</span>(<span class="string">"morgan"</span>);</span><br><span class="line">app.use(morgan(<span class="string">"tiny"</span>));</span><br></pre></td></tr></table></figure>
<p>使用了Morgan以后，我们再进行操作的话，后端就会出现日志</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/31.png" style="zoom: 80%;"></p>
<p>顺便说，Morgan默认请求实在控制台记录日志。同样也可以设置它写在日志文件当中。我可以有一个配置文件，在某些特定的场景下可以短时间开启这个功能。（开启后对运行效率有影响）</p>
<h3 id="Environments"><a href="#Environments" class="headerlink" title="Environments"></a>Environments</h3><p>也许我们想依照环境类型决定是否开关某功能。例如我们只想再开发环境当中开启对HTTP请求的日志记录</p>
<p>我们利用process对象，他是node的全局对象，通过它可以访问当前的进程，这个process对象有一个env属性</p>
<p>它提供我们环境变量的值。有一个标准的环境变量是NODE_ENV。 这个值返回当前node所在环境的值。如果他没有被设置，那么他就会返回未定义。同样我们可以在外部设置它，把它设置为production,testing等等</p>
<p>还有一种方法可以获得默认环境，是app的一个方法app.get(“env”),这其实默认调用了NODE_ENV，但是当NODE_ENV未定义的时候，这个方法默认返回开发环境的值</p>
<p>我们来打印一下默认的环境</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">`NODE_ENV:<span class="subst">$&#123;process.env.NODE_ENV&#125;</span>`</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`app:<span class="subst">$&#123;app.get(<span class="string">"env"</span>)&#125;</span>`</span>);</span><br></pre></td></tr></table></figure>
<p>NODE_ENV:undefined<br>app:development<br>在这个例子当中我们只想在开发环境使用日志。我们就可以这么写代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(app.get(<span class="string">'env'</span>)===<span class="string">'development'</span>)&#123;</span><br><span class="line">    app.use(morgan(<span class="string">'tiny'</span>));</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Morgan enabled'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是我们如果把环境设为生产，Morgan就不会起作用了</p>
<p>在Windows通过set命令来设置环境变量</p>
<p>set NODE_ENV = production</p>
<h3 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h3><p>现在来讨论如何保存应用的配置数据。并且在不同的环境中复写对应配置</p>
<p>比如在测试环境，我可以需要使用一个不同的数据库或者邮件服务器。</p>
<p>我们可以利用 rc 包</p>
<p><a href="https://www.npmjs.com/package/rc" target="_blank" rel="noopener">https://www.npmjs.com/package/rc</a></p>
<p>也可以使用 config包</p>
<p><a href="https://www.npmjs.com/package/config" target="_blank" rel="noopener">https://www.npmjs.com/package/config</a></p>
<p>npm i config</p>
<p>我们先在根目录下新建一个config文件夹</p>
<p>里面有三个JSON文件：default，development，production</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"name"</span>:<span class="string">"My Express App"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"My Express App =Development"</span>,</span><br><span class="line">  <span class="attr">"mail"</span>: &#123;</span><br><span class="line">    <span class="attr">"host"</span>: <span class="string">"dev-mail-server"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"My Express App =Development"</span>,</span><br><span class="line">  <span class="attr">"mail"</span>: &#123;</span><br><span class="line">    <span class="attr">"host"</span>: <span class="string">"prod-mail-server"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后再index.js中导入这个包。利用get方法就会自动根据当前的环境变量找到相应的文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">"config"</span>);</span><br><span class="line"><span class="comment">//configuration</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Application Name:"</span> + config.get(<span class="string">"name"</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Maile Server Name:"</span> + config.get(<span class="string">"mail.host"</span>));</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<p>Application Name:My Express App =Development<br>Maile Server Name:dev-mail-server</p>
<p>利用这个模块我们可以轻松的设置不同的环境的配置</p>
<p>但是不能把密码等机密放在json文件夹当中。因为这样很不安全，每个人都能看见。。</p>
<p>我们应该把他们保存在环境变量当中。我们来设置一下</p>
<p>终端中输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set app_password&#x3D;1234</span><br></pre></td></tr></table></figure>
<p>然后我们新建一个 custom-environment-variables （名字一定要写对） </p>
<p>在这个文件只有映射关系，映射环境变量和应用配置的关系</p>
<p>在这里只有password 到app_password 的映射关系</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"mail"</span>: &#123;</span><br><span class="line">      <span class="attr">"password"</span>:<span class="string">"app_password"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Debugging"><a href="#Debugging" class="headerlink" title="Debugging"></a>Debugging</h3><p>如果用console.log()来调试，会很麻烦，改来改去。所以更好的在控制台调试的方式是使用node的debug模块</p>
<p>也就是说用debug函数替换所有的console.log 这样就不需要注释掉他们，可以通过在外部修改环境变量实现</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> startupDebugger = <span class="built_in">require</span>(<span class="string">"debug"</span>)(<span class="string">"app:startup"</span>);</span><br><span class="line"><span class="keyword">const</span> dbDebugger = <span class="built_in">require</span>(<span class="string">"debug"</span>)(<span class="string">"app:db"</span>);</span><br></pre></td></tr></table></figure>
<p>然后通过</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> DEBUG=app:startup</span><br></pre></td></tr></table></figure>
<p>查看Debug信息</p>
<h3 id="Templating-Engines"><a href="#Templating-Engines" class="headerlink" title="Templating Engines"></a>Templating Engines</h3><p>有时候我们需要返回HTML标记语言文本到客户端而不是JSON文件，那么我们就需要模板引擎了</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/32.png" style="zoom: 80%;"></p>
<p>那么我们新建一个views文件夹，然后在里面新建一个index.pug文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">html</span><br><span class="line">    head</span><br><span class="line">        title&#x3D;title</span><br><span class="line">    body</span><br><span class="line">        h1&#x3D;message</span><br></pre></td></tr></table></figure>
<p>在index.js中配置</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app.set(<span class="string">"view engine"</span>, <span class="string">"pug"</span>);</span><br><span class="line">app.set(<span class="string">"views"</span>, <span class="string">"./views"</span>); <span class="comment">//optional</span></span><br></pre></td></tr></table></figure>
<p>虽有这样修改，可以看到Helloworld已经被渲染出来了</p>
<p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/33.png" style="zoom: 80%;"></p>
<p>但是我们后端不需要什么视图引擎或者模板引擎</p>
<h3 id="Database-Integration"><a href="#Database-Integration" class="headerlink" title="Database Integration"></a>Database Integration</h3><p><img src="/2020/06/07/Nodejs%E5%9F%BA%E7%A1%801/34.png" style="zoom: 80%;"></p>
<h3 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h3><p>Express没有验证功能</p>
<h3 id="Structuring-Express-Applications"><a href="#Structuring-Express-Applications" class="headerlink" title="Structuring Express Applications"></a>Structuring Express Applications</h3><p>在现实开发中我们肯定不会把所有的东西放到index.js当中去。所以我们要正确的结构化我的应用</p>
<p>第一件事就是清理所有设计courses的接口，并且把它放到一个独立的文件当中去。换句话说，每个独立的api终端的逻辑代码，都要转为一个独立的文件或者模块。所有的coureses的路由都要丢到一个courses.js文件当中去</p>
<p>我们在根目录新建一个新的routes文件夹里面有文件courses.js。把所有包含courses.js的文件全部放到courses.js中</p>
<p>courses.js的配置 把app都换成router</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<p>同样的，把home.js 抽离出来</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line">router.get(<span class="string">"/"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.render(<span class="string">"index"</span>, &#123; <span class="attr">title</span>: <span class="string">"My Express App"</span>, <span class="attr">message</span>: <span class="string">"Helloworld"</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<p>最后，把logger放到middleware文件夹当中</p>
<p>…</p>
<p>index.js中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> startupDebugger = <span class="built_in">require</span>(<span class="string">"debug"</span>)(<span class="string">"app:startup"</span>);</span><br><span class="line"><span class="keyword">const</span> dbDebugger = <span class="built_in">require</span>(<span class="string">"debug"</span>)(<span class="string">"app:db"</span>);</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">"config"</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"><span class="keyword">const</span> logger = <span class="built_in">require</span>(<span class="string">"./middleware/logger"</span>);</span><br><span class="line"><span class="keyword">const</span> helmet = <span class="built_in">require</span>(<span class="string">"helmet"</span>);</span><br><span class="line"><span class="keyword">const</span> morgan = <span class="built_in">require</span>(<span class="string">"morgan"</span>);</span><br><span class="line"><span class="keyword">const</span> courses = <span class="built_in">require</span>(<span class="string">"./routes/courses"</span>);</span><br><span class="line"><span class="keyword">const</span> home = <span class="built_in">require</span>(<span class="string">"./routes/home"</span>);</span><br><span class="line">app.set(<span class="string">"view engine"</span>, <span class="string">"pug"</span>);</span><br><span class="line">app.set(<span class="string">"views"</span>, <span class="string">"./views"</span>); <span class="comment">//optional</span></span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(express.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">true</span> &#125;));</span><br><span class="line">app.use(logger);</span><br><span class="line">app.use(helmet());</span><br><span class="line"><span class="comment">// route全部以/api/courses开头，那么courses.js中就可以把所有的/api/courses都去掉了，只留下:id。</span></span><br><span class="line">app.use(<span class="string">"/api/courses"</span>, courses);</span><br><span class="line">app.use(<span class="string">"/"</span>, home);</span><br><span class="line"><span class="comment">//configuration</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Application Name:"</span> + config.get(<span class="string">"name"</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Mail  Server Name:"</span> + config.get(<span class="string">"mail.host"</span>));</span><br><span class="line"><span class="comment">// console.log("Maile Server Password:" + config.get("mail.password"));</span></span><br><span class="line"><span class="keyword">if</span> (app.get(<span class="string">"env"</span>) === <span class="string">"development"</span>) &#123;</span><br><span class="line">  app.use(morgan(<span class="string">"tiny"</span>));</span><br><span class="line">  startupDebugger(<span class="string">"Morgan enabled"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Db work</span></span><br><span class="line">dbDebugger(<span class="string">"Connected to the database"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//port</span></span><br><span class="line"><span class="keyword">const</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line">app.listen(port, () =&gt; <span class="built_in">console</span>.log(<span class="string">`Listening on port <span class="subst">$&#123;port&#125;</span>..`</span>));</span><br></pre></td></tr></table></figure>
<h3 id="Project-Restructure-the-App"><a href="#Project-Restructure-the-App" class="headerlink" title="Project- Restructure the App"></a>Project- Restructure the App</h3><p>现在我们重构之前的vidly项目，</p>
<p>index.js</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Joi = <span class="built_in">require</span>(<span class="string">"joi"</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"><span class="keyword">const</span> genres = <span class="built_in">require</span>(<span class="string">"./routes/genres"</span>);</span><br><span class="line">app.use(express.json());</span><br><span class="line"></span><br><span class="line">app.use(<span class="string">"/api/genres"</span>, genres);</span><br><span class="line"><span class="keyword">const</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line">app.listen(port, () =&gt; <span class="built_in">console</span>.log(<span class="string">`Listening on port <span class="subst">$&#123;port&#125;</span>...`</span>));</span><br></pre></td></tr></table></figure>
<p>genres.js 替换app为route, 替换/api/genres为/</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Joi = <span class="built_in">require</span>(<span class="string">"joi"</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    
    <div>
      
    </div>
    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://jasonxqh.github.io/2020/06/07/web%E6%9C%9F%E6%9C%AB%E5%A4%A7%E4%BD%9C%E4%B8%9A-%E4%B8%BB%E5%8D%9A%E5%AE%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/%5Bobject%20Object%5D">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/07/web%E6%9C%9F%E6%9C%AB%E5%A4%A7%E4%BD%9C%E4%B8%9A-%E4%B8%BB%E5%8D%9A%E5%AE%A2/" itemprop="url">web期末大作业-主博客</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-07T12:10:31+08:00">
                2020-06-07
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2020-06-17T15:53:58+08:00">
                2020-06-17
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="web期末大作业-主博客"><a href="#web期末大作业-主博客" class="headerlink" title="web期末大作业-主博客"></a>web期末大作业-主博客</h1><h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>这次的期末大作业我选择第一个</p>
<p><img src="/2020/06/07/web%E6%9C%9F%E6%9C%AB%E5%A4%A7%E4%BD%9C%E4%B8%9A-%E4%B8%BB%E5%8D%9A%E5%AE%A2/1.png" style="zoom:80%;"></p>
<p>​        我接触web开发仅仅只有短短半学期时间，能兼顾前后端并把原理说得很明白是很难做到的。作业实现的代码中也有相当一部分在学习相关知识之后还迷迷糊糊未曾深究。加上我的表达能力着实有限，实在无法简洁明了，简单扼要得把整个作业项目庖丁解牛式得展现，有时候不得不借鉴他人的博客。但是我会尽力做到把能够说明白的说清楚。</p>
<p>​        这篇博客是主博客,因为实在无法在一篇博客中写太多的字数，对我和读者都有莫大的挑战，所以我把这篇博客当作索引，分为了大约10篇子博客，具体的博客树大概是这样的。</p>
<p><img src="/2020/06/07/web%E6%9C%9F%E6%9C%AB%E5%A4%A7%E4%BD%9C%E4%B8%9A-%E4%B8%BB%E5%8D%9A%E5%AE%A2/8.png" style="zoom: 50%;"></p>
<p>从上图可知，我做的这个project 是一个标准的 MERN stack，也就是 MongoDB，Express，React 和 Nodejs</p>
<h2 id="需求分析："><a href="#需求分析：" class="headerlink" title="需求分析："></a>需求分析：</h2><ol>
<li><strong>用户可注册登录网站，非注册用户不可登陆查看数据</strong>：这就要求前后端配合，数据库中存储用户信息，前端通过api调用实现认证</li>
<li><strong>用户实现注册，登录，查询等操作记录数据库中的日志</strong>：同样需要前后端配合</li>
<li><strong>实现查询词支持布尔表达式</strong>：需要后端编写查询函数，通过api接口提供给前端</li>
<li><strong>爬虫数据查询结果列表支持分页和排序</strong>：前端通过api接口获得数据库中的信息之后进行排序</li>
<li><strong>用Echarts或者D3实现数据分析图标展示在网站中</strong>： 利用数据可视化工具展示图表</li>
</ol>
<h2 id="网站架构"><a href="#网站架构" class="headerlink" title="网站架构"></a>网站架构</h2><p>前端方面: 利用React框架构造前端</p>
<p>后端方面: 利用MongoDb+Express+Nodejs 构造后端</p>
<h3 id="页面概览"><a href="#页面概览" class="headerlink" title="页面概览"></a>页面概览</h3><ul>
<li>登陆页面</li>
<li>展示页面</li>
<li><p>管理员界面</p>
<ul>
<li>普通用户界面</li>
<li>在界面中可以实现AND和OR的布尔查询</li>
<li>只有登陆了才能看到展示页面。退出以后回到登陆页面。</li>
</ul>
</li>
</ul>
<h2 id="数据源"><a href="#数据源" class="headerlink" title="数据源"></a>数据源</h2><p><a href="https://jasonxqh.github.io/2020/04/30/从-1开始的python爬虫/">从-1开始的python爬虫</a></p>
<p>里面详细介绍了我如歌编写python爬虫并存储数据的。我认为比JavaScript更有效率</p>
<p>在这里，我选择了4张表格来当作我的数据源。</p>
<p>分别是猫眼电影Top100</p>
<p>豆瓣电影Top250</p>
<p>淘宝咖啡商品</p>
<p>美剧天堂的所有剧集。</p>
<p>通过python编写爬虫并存储至MongoDb当中</p>
<h2 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h2><p>前端的话我选择了Facebook开源的React框架。囊括了基本的组件构造、分页排序、路由、登录等功能。接下来我的作业也会沿用这些技术。在作业中的前端中我还用到了以下技术：scss，简单的redux 和基础的中间件，antd样式库.我把需要的知识都写成了学习博客，以供老师和自己今后的项目开发做参考。</p>
<p>下面是我的学习博客，也是期末作业的一部分，总长 4万字左右。</p>
<p><a href="https://jasonxqh.github.io/2020/05/26/OOP-in-JavaScript/">面向对象的Javascript</a></p>
<p><a href="https://jasonxqh.github.io/2020/05/30/react基础/#more">react基础1组件与组合组件</a></p>
<p><a href="https://jasonxqh.github.io/2020/06/02/react基础2/">react基础2分页排序搜索+路由</a></p>
<p> <a href="https://jasonxqh.github.io/2020/06/04/react基础3/">react基础3表单与后端</a></p>
<p><a href="https://jasonxqh.github.io/2020/06/05/react基础4授权与部署/">react基础4授权与部署</a></p>
<p>那么我这个项目需要多少前端页面，又需要编写多少组件呢？在这里，组件如何编写我就不详细阐释了（代码有需求的展示）。因为在react的四篇长文中已经有极其详细的介绍了。我将把重点放到一些疑难困惑地的解决当中去</p>
<h3 id="前端架构"><a href="#前端架构" class="headerlink" title="前端架构"></a>前端架构</h3><p><strong>根目录部分</strong>我们需要写：index.js 主文件和 代理文件</p>
<p><strong>页面部分</strong>我们需要写：登录页面，注册页面，管理员的用户管理页面，4张表格的展示页面。</p>
<p><strong>组件部分</strong>我们需要写：NavBar(导航栏组件)，包含了NavBar的基本界面Layout组件，为了页面美观我们编写的loading组件，和为了登录而写的 private组件。</p>
<p>具体的应用实现，请移步子博文</p>
<p><a href="https://jasonxqh.github.io/2020/06/07/React框架在作业当中的应用/">React框架在作业当中的应用</a></p>
<h2 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h2><p>后端的话我选择了Express框架，一是以前就接触过，虽不是很深入了解但也有点印象。二是我只会这个框架。。。所以在写之前我还是系统学习了一下nodejs和express</p>
<p><a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础1/#more">Nodejs基础1Express和RESTful</a></p>
<p><a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础2/#more"> Nodejs基础2异步操作与CRUD</a></p>
<h3 id="后端架构"><a href="#后端架构" class="headerlink" title="后端架构"></a>后端架构</h3><p> 在博客<a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础1/#more">Nodejs基础1</a>中已经初步建立起了一个后端的框架来了，当然那个只是简易的框架。在作业中，沿用了RESTful法则分为下面几个文件夹</p>
<p>在<a href="https://jasonxqh.github.io/2020/06/07/Nodejs基础2/#more"> Nodejs基础2异步操作与CRUD</a> 中主要介绍了异步操作和链接mongodb之后的CRUD，为作业打好基础。</p>
<p><strong>根目录</strong>: config.js, server.js(app.js)</p>
<p><strong>routes目录</strong>： routes部分就是接出来路由嘛，但是因为这个程序比较复杂，所以我通过routes调用controller来增加代码的层次性</p>
<p><strong>models目录</strong>：存放数据表格式</p>
<p><strong>controller目录</strong>： 具体的后端操作都在这里了</p>
<p><strong>middleware中间件目录</strong>：用来登录认证和错误判断</p>
<p>具体的应用实现，请移步子博文</p>
<p><a href="https://jasonxqh.github.io/2020/06/08/Express框架在后端的应用/">Express框架在后端的应用</a></p>
<h2 id="数据可视化"><a href="#数据可视化" class="headerlink" title="数据可视化"></a>数据可视化</h2><p>数据可视化的工具也学习了几个了，从最开始利用  <a href="https://jasonxqh.github.io/2020/05/13/python数据分析/">pandas </a>和  <a href="https://jasonxqh.github.io/2020/05/14/python数据可视化之matplotlib/">matplotlib</a>入门开始，再到对<a href="https://jasonxqh.github.io/2020/04/29/matlab基础/">matlab基础</a>的学习，都只是在本地画图，但是如果我们想要在dom里画图，就必须使用JavaScript的画图工具 D3 和 Echarts，这里我选择了D3来做</p>
<p>D3的学习和应用，请移步子博文。</p>
<p><a href="https://jasonxqh.github.io/2020/06/12/JavaScript数据可视化之D3/">JavaScript数据可视化之D3</a></p>
<p><a href="https://jasonxqh.github.io/2020/06/16/数据可视化在作业当中的应用/">数据可视化在作业当中的应用</a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>​    这次的作业如果要完成基本操作确实不难。但是我把大量的时间花在了基础知识的学习当中。正所谓万丈高楼平地起。没有基础知识的作业，也只是空中楼阁罢了。</p>
<p>​    所以为了学习基础知识我对比了大量的网络课程，翻阅了大量的文档，最终形成了这些博客。从5月26日写下第一篇  面向对象的Javascript 之后，我平均每天会花上4-5个小时写博客+写代码，双休日更是从早到晚，几乎没有喘息的时间。所以当最后一篇文章更新完毕的时候，从我身体中迸发出来的成就感是不可言说的。对于这门课来说，这只是一个大作业；但对于我来说，这更是一条难忘的学习旅程：从信息收集到后端，从后端到前端，我初步掌握了全栈开发的要领，这个作业也将成为将来一些项目的模板。</p>
<p>​    虽然老师要求的一些拓展功能我还没有办法实现。但这并不影响我今后继续探索的兴趣和信心。随着经验的丰富，我相信这些问题都会迎刃而解。</p>

          
        
      
    </div>
    
    
    
    <div>
      
    </div>
    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/24/">&lt;i class&#x3D;&quot;fa fa-angle-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><span class="page-number current">25</span><a class="page-number" href="/page/26/">26</a><span class="space">&hellip;</span><a class="page-number" href="/page/44/">44</a><a class="extend next" rel="next" href="/page/26/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/%5Bobject%20Object%5D"
                alt="Jason" />
            
              <p class="site-author-name" itemprop="name">Jason</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20fa%20fa-archive">
              
                  <span class="site-state-item-count">435</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">61</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart" aria-hidden="true"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jason</span>
 <!--
  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>







-->
        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>




















  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v="></script>

  <script type="text/javascript" src="/js/src/motion.js?v="></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v="></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
