<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="y0-26jFM_8wn6Slpy1ahkB8ndR7w0OOGyAU6IaXjLUI" />














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Mysql," />










<meta name="description" content="mysql基础下承接上文：https:&#x2F;&#x2F;jasonxqh.github.io&#x2F;2020&#x2F;05&#x2F;16&#x2F;Mysql%E5%9F%BA%E7%A1%80&#x2F; Stored ProdedureWhat are Stored Procedures假设我们在开发一个应用，应用中有一个数据库。那么我们在哪里写SQL语句呢？我们总不能把sql语句和java，C#这种的语句混合着写吧，那么维护起来就很麻烦。另外，一">
<meta property="og:type" content="article">
<meta property="og:title" content="mysql基础下">
<meta property="og:url" content="https://jasonxqh.github.io/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/index.html">
<meta property="og:site_name" content="Jason‘s Blog">
<meta property="og:description" content="mysql基础下承接上文：https:&#x2F;&#x2F;jasonxqh.github.io&#x2F;2020&#x2F;05&#x2F;16&#x2F;Mysql%E5%9F%BA%E7%A1%80&#x2F; Stored ProdedureWhat are Stored Procedures假设我们在开发一个应用，应用中有一个数据库。那么我们在哪里写SQL语句呢？我们总不能把sql语句和java，C#这种的语句混合着写吧，那么维护起来就很麻烦。另外，一">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://jasonxqh.github.io/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/1.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/2.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/3.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/4.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/5.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/6.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/7.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/9.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/10.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/11.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/12.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/14.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/13.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/15.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/16.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/17.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/18.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/19.png">
<meta property="article:published_time" content="2020-06-26T14:14:56.000Z">
<meta property="article:modified_time" content="2022-08-22T03:14:36.000Z">
<meta property="article:author" content="Jason">
<meta property="article:tag" content="Mysql">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jasonxqh.github.io/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://jasonxqh.github.io/2020/06/26/mysql基础下/"/>





  <title>mysql基础下 | Jason‘s Blog</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-170027658-1', 'auto');
  ga('send', 'pageview');
</script>





<meta name="generator" content="Hexo 4.2.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">
  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
<a href="https://github.com/JasonXQH/JasonXQH.github.io" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jason‘s Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            Sitemap
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://jasonxqh.github.io/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">mysql基础下</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-26T22:14:56+08:00">
                2020-06-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  8.3k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  32
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="mysql基础下"><a href="#mysql基础下" class="headerlink" title="mysql基础下"></a>mysql基础下</h1><p>承接上文：<a href="https://jasonxqh.github.io/2020/05/16/Mysql%E5%9F%BA%E7%A1%80/">https://jasonxqh.github.io/2020/05/16/Mysql%E5%9F%BA%E7%A1%80/</a></p>
<h2 id="Stored-Prodedure"><a href="#Stored-Prodedure" class="headerlink" title="Stored Prodedure"></a>Stored Prodedure</h2><h3 id="What-are-Stored-Procedures"><a href="#What-are-Stored-Procedures" class="headerlink" title="What are Stored Procedures"></a>What are Stored Procedures</h3><p>假设我们在开发一个应用，应用中有一个数据库。那么我们在哪里写SQL语句呢？我们总不能把sql语句和java，C#这种的语句混合着写吧，那么维护起来就很麻烦。另外，一些C# Java的编程语言需要编译工作。如果我们在应用中写这sql语句，那么当我想修改查询语句的时候，会发现需要重新编译，甚至重新部署。所以我们需要把SQL代码和应用的代码分开。把SQL代码存储在它应属的数据库里 ：那就是 Stored Prodedure</p>
<p> Stored Prodedure 是一个包含一堆SQL代码的数据库对象。在我们的应用代码里，我们调用这些过程来获取或者保存数据</p>
<p>他还能让查询变得更快。并且它能像View一样，加强数据的安全性.比如我们可以取消所有的表的直接访问权限。让插入、更新、删除数据由存储过程来完成。然后我们指定一个能进行此操作的人。这样可以防止一些用户删除我们的数据。</p>
<p><img src="/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/1.png" style="zoom:67%;"></p>
<h3 id="Creating-a-Stored-Procedure"><a href="#Creating-a-Stored-Procedure" class="headerlink" title="Creating a Stored Procedure"></a>Creating a Stored Procedure</h3><p>首先我们想让MYSQL 为这一个这个整体创建一个存储过程叫做 get_clients。我么不想单独执行<code>SELECT * FROM clients</code>，那么我们必须把默认分隔符从分号改成$$(国际公约)然后在END后写两个$ 这相当于告诉mysql这是一个新的分隔符，把这些CREATE PROCEDURE语句看成一个整体。</p>
<p>最后我们需要把默认分隔符改回来： DELIMITER ; 运行后，我么发现他已经成为了一个存储过程了。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> get_clients()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> clients;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<p>在query中，我们可以使用CALL语句来调用存储过程： CALL get_clients()</p>
<p>在应用中我们会用python，Java等语言来调用</p>
<h4 id="小练习："><a href="#小练习：" class="headerlink" title="小练习："></a>小练习：</h4><blockquote>
<p>Create a stored procedure called</p>
<ul>
<li>get_invoices_with_balance</li>
<li>to return all the invoices with a balance&gt;0 返回所有结余大于0 的发票</li>
</ul>
</blockquote>
<p>之前我们创建了 invoices_with_balance 的view视图，所以我们直接从这里找，更直观。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> get_invoices_with_balance()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">SELECT</span> *</span><br><span class="line">    <span class="keyword">FROM</span> invoices_with_balance</span><br><span class="line">    <span class="keyword">WHERE</span> balance &gt; <span class="number">0</span>;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<p>通过： <code>call sql_invoicing.get_invoices_with_balance()</code>调用</p>
<h3 id="Creating-Procedures-Using-MySQLWorkbench"><a href="#Creating-Procedures-Using-MySQLWorkbench" class="headerlink" title="Creating Procedures Using MySQLWorkbench"></a>Creating Procedures Using MySQLWorkbench</h3><p><img src="/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/2.png" style="zoom:%;"></p>
<p>当然我们可以直接右键点击 Stored Procedures  ，点击 Create Stored Procedure 然后我们只需要专注于我们的sql语句了。到时候，只要点击下面的apply，workbench就会自动帮我们生成存储过程</p>
<p><img src="/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/3.png" style="zoom:%;"></p>
<h3 id="Dropping-Stored-Procedures"><a href="#Dropping-Stored-Procedures" class="headerlink" title="Dropping Stored Procedures"></a>Dropping Stored Procedures</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> get_clients;</span><br></pre></td></tr></table></figure>
<p>我们最好把删除和创建每一个存储过程的代码存储在不同的sql文件当中。并把文件放在Git 中，这样就能和组员共享了。任何人都能可以用他们电脑上的所有相关视图和存储过程来再建这个数据库。</p>
<p>我们建立了一个 存储过程之后可以保存为 一个sql文件，保存在新建的存储视图文件夹之下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DROP PROCEDURE IF EXISTS get_clients;</span><br><span class="line">DELIMITER $$</span><br><span class="line">CREATE PROCEDURE get_clients()</span><br><span class="line">BEGIN</span><br><span class="line">    SELECT *</span><br><span class="line">    FROM invoices_with_balance</span><br><span class="line">    WHERE balance &gt; 0;</span><br><span class="line">END$$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h3 id="Parameters"><a href="#Parameters" class="headerlink" title="Parameters"></a>Parameters</h3><p>现在我们来在存储过程中添加参数。我们一般使用参数为存储过程传递值，我们也可以使用参数为调用程序赋值。</p>
<p>参数写在() 之内。 在这里，我们令state 这个字段名 是一个 长度为2的字符串。注意，如果类型是CHAR， 它只能是长度为特定值，如果我们想要长度可变的值，那么我们需要用VARCHAR </p>
<p>因为我们不能直接 选择 <code>WHERE state = state</code> 所以我们给clients一个别名 c， 这样我们就可以写成 <code>WHERE state = c.state</code> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DROP PROCEDURE IF EXISTS get_clients_by_state;</span><br><span class="line">DELIMITER $$</span><br><span class="line">CREATE PROCEDURE get_clients_by_state</span><br><span class="line">(</span><br><span class="line">	state CHAR(2) --CA&#x2F;NY</span><br><span class="line">)</span><br><span class="line">BEGIN</span><br><span class="line">  	SELECT * FROM clients c</span><br><span class="line">    WHERE c.state &#x3D; state;</span><br><span class="line">END$$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h4 id="小练习：-1"><a href="#小练习：-1" class="headerlink" title="小练习："></a>小练习：</h4><blockquote>
<p>Write a stored procedure to return invoices</p>
<p>for a given client </p>
<p>get_invoice_by_client</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> get_invoices_by_client</span><br><span class="line">(</span><br><span class="line">	client_id <span class="built_in">INT</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  	<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> invoices i</span><br><span class="line">    <span class="keyword">WHERE</span> i.client_id = client_id</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h3 id="Parameters-with-Default-Value"><a href="#Parameters-with-Default-Value" class="headerlink" title="Parameters with Default Value"></a>Parameters with Default Value</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> get_clients_by_state;</span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> get_clients_by_state</span><br><span class="line">(</span><br><span class="line">	state <span class="built_in">CHAR</span>(<span class="number">2</span>) <span class="comment">--CA/NY</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">IF</span> state <span class="keyword">IS</span> <span class="literal">NULL</span> <span class="keyword">THEN</span></span><br><span class="line">		<span class="keyword">SET</span> state = <span class="string">'CA'</span>;</span><br><span class="line">	ENDIF;</span><br><span class="line">  	<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> clients c</span><br><span class="line">    <span class="keyword">WHERE</span> c.state = state;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CALL</span> get_clients_by_state(<span class="literal">NULL</span>)</span><br></pre></td></tr></table></figure>
<p>注意，这里我们还是要传入空的参数NULL，否则mysql会报错</p>
<p>当然，我们也可以默认返回所有客户：我们只需要在IF中写语句即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line">CREATE PROCEDURE get_clients_by_state</span><br><span class="line">(</span><br><span class="line">	state CHAR(2) --CA&#x2F;NY</span><br><span class="line">)</span><br><span class="line">BEGIN</span><br><span class="line">	IF state IS NULL THEN</span><br><span class="line">		SELECT * FROM clients;</span><br><span class="line">	ELSE</span><br><span class="line">	  	SELECT * FROM clients c</span><br><span class="line">    	WHERE c.state &#x3D; state;</span><br><span class="line">    ENDIF;</span><br><span class="line">END$$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<p>或者我们可以把两段查询合并成一段：</p>
<p>运用IFNULL 函数，如果第一个值是控制，那个就会返回c.state，也就是把所有的客户都返回</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line">CREATE PROCEDURE get_clients_by_state</span><br><span class="line">(</span><br><span class="line">	state CHAR(2) -- CA&#x2F;NY</span><br><span class="line">)</span><br><span class="line">BEGIN</span><br><span class="line">	  	SELECT * FROM clients c</span><br><span class="line">    	WHERE c.state &#x3D; IFNULL(state,c.state);</span><br><span class="line">END$$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h4 id="小练习：-2"><a href="#小练习：-2" class="headerlink" title="小练习："></a>小练习：</h4><blockquote>
<p>Write a stored procedure called get_payments</p>
<p>with two parameters</p>
<p>client_id =&gt; INT    //4字节 ，存储更大的数字</p>
<p>payment_method_id =&gt; TINYINT //1字节，存储0-255的数字</p>
<p>如果这两个系数都传递NULL，那么返回数据库里的所有<strong>付款记录​</strong></p>
<p>如果提供client_id 那么返回<strong>这个客户的所有付款</strong></p>
<p>如果client_id 和 payment_method_id 返回<strong>指定客户使用指定付款方式支付的所有付款记录</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line">CREATE PROCEDURE get_payments</span><br><span class="line">(</span><br><span class="line">	client_id INT,</span><br><span class="line">	payment_method_id TINYINT</span><br><span class="line">)</span><br><span class="line">BEGIN</span><br><span class="line">	  	SELECT * FROM payments p</span><br><span class="line">    	WHERE</span><br><span class="line">    		p.client_id &#x3D; IFNULL(client_id,p.client_id) AND</span><br><span class="line">    		p.payment_method &#x3D; IFNULL(payment_method_id,p.payment_id);</span><br><span class="line">END$$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h3 id="Parameter-Validation"><a href="#Parameter-Validation" class="headerlink" title="Parameter Validation"></a>Parameter Validation</h3><p>我们也可以用存储过程来存储、删除、更新数据库当中的信息。在这之前，我们需要进行数据验证。确保我们不会意外存入坏的数据。</p>
<p>那么运用 IF END IF 语句我们可以对输入的数值进行判断。 </p>
<p>如果payment_amount &lt;= 0 那么就 SIGNAL （类似于抛出一个异常，try except） 出一个状态码：</p>
<p>状态码详解： <a href="https://blog.csdn.net/u014653854/article/details/78986780" target="_blank" rel="noopener">https://blog.csdn.net/u014653854/article/details/78986780</a></p>
<p>并抛出 一个MESSAGE ： Invalid payment amount</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">CREATE DEFINER&#x3D;&#96;root&#96;@&#96;localhost&#96; PROCEDURE &#96;make_payment&#96;(</span><br><span class="line">   invoice_id INT,</span><br><span class="line">    payment_amount DECIMAL(9,2),-- DECIMAL是最大可以存储9位数，且保留两位小数的数字</span><br><span class="line">    payment_date DATE</span><br><span class="line">)</span><br><span class="line">BEGIN</span><br><span class="line">   IF payment_amount &lt;&#x3D; 0 THEN</span><br><span class="line">      SIGNAL SQLSTATE &#39;22003&#39;</span><br><span class="line">         SET MESSAGE_TEXT &#x3D; &#39;Invalid payment amount&#39;;</span><br><span class="line">    END IF;</span><br><span class="line">   UPDATE invoices i</span><br><span class="line">    SET</span><br><span class="line">      i.payment_total &#x3D; payment_amount,</span><br><span class="line">        i.payment_date &#x3D; payment_date</span><br><span class="line">   WHERE i.invoice_id &#x3D; invoice_id;</span><br><span class="line">END</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/4.png" style="zoom:%;"></p>
<p>当我们运行这个存储过程并尝试输入一个负值的时候，会出现报错</p>
<h3 id="Output-Parameters"><a href="#Output-Parameters" class="headerlink" title="Output Parameters"></a>Output Parameters</h3><p>我们可以用参数向过程调用者返回数据</p>
<p>一般的，我们在括号中输入的参数都是INPUT variables，意思是我们只能通过它们向存储过程提供数据。我们用OUT来标记需要传出来的参数。这样就约定这些参数是要输出的参数</p>
<p>然后，我们在主体重用invoices_count和invoices)total来接收传递出来的数据，用INTO关键字</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CREATE DEFINER&#x3D;&#96;root&#96;@&#96;localhost&#96; PROCEDURE &#96;get_unpaid_invoices_for_client&#96;(</span><br><span class="line">	client_id INT,</span><br><span class="line">    OUT invoices_count INT,</span><br><span class="line">    OUT invoices_total DECIMAL(9,2)</span><br><span class="line">)</span><br><span class="line">BEGIN</span><br><span class="line">	SELECT COUNT(*), SUM(invoice_total)</span><br><span class="line">    INTO invoices_count,invoices_total</span><br><span class="line">    FROM invoices i </span><br><span class="line">    WHERE i.client_id &#x3D; client_id</span><br><span class="line">		AND payment_total &#x3D; 0;</span><br><span class="line">END</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/5.png" style="zoom:%;"></p>
<p>调用后我们有了这样的代码： 首先我们定义了两个变量： invoices_count 和invoices_total 这就是我们说的用户定义变量，这种变量就是可以把数据保存在内存当中的量。定义变量之前需要用@修饰。</p>
<p>然后调用存储过程，并传入三个变量。第一个是传入的，后两个是传出的。 最后我们选择传出的两个变量，显示在表格当中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set @invoices_count &#x3D; 0;</span><br><span class="line">set @invoices_total &#x3D; 0;</span><br><span class="line">call sql_invoicing.get_unpaid_invoices_for_client</span><br><span class="line">(3, @invoices_count, @invoices_total);</span><br><span class="line">select @invoices_count, @invoices_total;</span><br></pre></td></tr></table></figure>
<p>比较麻烦，不建议使用</p>
<h3 id="Variables"><a href="#Variables" class="headerlink" title="Variables"></a>Variables</h3><p>上面我们定义了User variables，这些变量时使用SET 语句来定义的，并且用@前缀修饰的。这种变量常常出现在有输出变量的存储过程当中.这些变量在整个客户端session周期中都存储在内存当中。当客户端终止与数据库的连接时，那么这些变量就会被释放。</p>
<p>还有一种变量叫做本地变量。这是在存储过程或者函数当中定义的变量。本地变量是不会再session周期保存在内存当中的。只要存储过程运行结束，这些变量就会被释放。大多数时候这些变量用作存储过程中的运算。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CREATE DEFINER&#x3D;&#96;root&#96;@&#96;localhost&#96; PROCEDURE &#96;get_rist_factor&#96;()</span><br><span class="line">BEGIN</span><br><span class="line">	DECLARE risk_factor DECIMAL(9,2) DEFAULT 0;</span><br><span class="line">    DECLARE invoices_total DECIMAL(9,2);</span><br><span class="line">    DECLARE invoices_count INT;</span><br><span class="line">    </span><br><span class="line">    SELECT COUNT(*),SUM(invoice_total)</span><br><span class="line">    INTO invoices_count, invoices_total</span><br><span class="line">    FROM invoices;</span><br><span class="line">    </span><br><span class="line">    SET risk_factor &#x3D; invoices_total&#x2F;invoices_count*5;</span><br><span class="line">    SELECT risk_factor;</span><br><span class="line">END</span><br></pre></td></tr></table></figure>
<h3 id="Functions"><a href="#Functions" class="headerlink" title="Functions"></a>Functions</h3><p>我们已经知道了很多built-in 函数了。我们现在可以自己创建函数。但是函数和存储过程是不一样的，因为函数不能返回有行有列的结果集，函数只能返回单一的值。所以如果我们想要得到单一的值，那么可以使用函数。一个比较好的例子就是上面我们得到的 risk_factor.我们现在为每一个用户得到一个risk_factor</p>
<p><img src="/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/6.png" style="zoom: 100%;"></p>
<p>创建函数的语法和创建存储过程的非常类似</p>
<p>首先是取一个名字，括号里面定义参数，然后是RETURNS INTEGER 意思就是返回一个整数。</p>
<p>在RETURNS语句的下面，我们需要设置函数的特性：</p>
<p>DETEMINISTIC：这是说如果给函数同样的设置值，他就总返回相同的值（输入一样，输出也一样）。这在不依赖于数据库数据计算返回值的时候就会很有用，因为数据库中的数据是变化的。就比如计算运费或者税金就可以用DETEMINISTIC。因为其中都是根据一些公式来进行计算，相同的参数一定得到相同的值。</p>
<p>READS SQL DATA：这个意思就是在函数主体当中我们需要用SELECT 语句从数据库中获得信息</p>
<p>MODIFIES SQL DATA：对数据库进行增删改查的时候就会用到这个特性。</p>
<p>在这个函数，我们要计算顾客的风险指数，这是会随着顾客支付他的订单而变化的，所以不需要DETEMINISTIC,而且这个函数也不需要对数据库进行CRUD操作，仅仅是计算。所以我们用READS SQL DATA 特性</p>
<p>然后我们把刚才的语句复制过来。并做一些修改： WHERE i.client_id = client_id;</p>
<p>并且，如果风险指数为NULL的话，我们通过IFNULL 将其设置为0。</p>
<p>APPLY 应用之后，我们可以对其进行运行了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">CREATE DEFINER&#x3D;&#96;root&#96;@&#96;localhost&#96; FUNCTION &#96;get_risk_factor_for_client&#96;(</span><br><span class="line">	client_id INT</span><br><span class="line">) RETURNS int(11)</span><br><span class="line">    READS SQL DATA</span><br><span class="line">BEGIN</span><br><span class="line">	DECLARE risk_factor DECIMAL(9,2) DEFAULT 0;</span><br><span class="line">    DECLARE invoices_total DECIMAL(9,2);</span><br><span class="line">    DECLARE invoices_count INT;</span><br><span class="line">    </span><br><span class="line">    SELECT COUNT(*), SUM(invoice_total)</span><br><span class="line">    INTO invoices_count,invoices_total </span><br><span class="line">    FROM invoices i </span><br><span class="line">    WHERE i.client_id &#x3D; client_id;</span><br><span class="line">    </span><br><span class="line">   SET risk_factor &#x3D; invoices_total&#x2F;invoices_count*5;</span><br><span class="line">   </span><br><span class="line">RETURN IFNULL(risk_factor,0);</span><br><span class="line">END</span><br></pre></td></tr></table></figure>
<p>新建了函数之后，我们在sql语句当中可以使用内建函数一样使用自定义函数了：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    client_id,</span><br><span class="line">    <span class="keyword">name</span>,</span><br><span class="line">    get_risk_factor_for_client(client_id)</span><br><span class="line"><span class="keyword">FROM</span> clients;</span><br></pre></td></tr></table></figure>
<p>我们看到结果，如果这个人没有任何账单，那么根据计算出来的结果，再使用IFNULL函数之后，他们的风险指数就是0了</p>
<p><img src="/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/7.png" style="zoom: 100%;"></p>
<p>不同的人，使用函数的时候有着不同的习惯。比如命名时喜欢驼峰命名法，或者像刚才那样下划线命名法。不同的人也会有不同的分隔符号，有些人喜欢$$ 有些人喜欢 // </p>
<h2 id="触发器和事件"><a href="#触发器和事件" class="headerlink" title="触发器和事件"></a>触发器和事件</h2><h3 id="Triggers"><a href="#Triggers" class="headerlink" title="Triggers"></a>Triggers</h3><p>Trigger is a block of SQL code that automatically gets executed befor or after an insert ,update or delete statement.</p>
<p>通常触发器用来维持数据的连贯性。比如在sql中，给定的发票可以有多个支付记录。有一列 payment_total 是专门用来统计了现在已经支付了多少金钱了。所以，当我们想支付记录表中添加了一条记录，我们需要保证发票表中的 payment_total  需要实时更新。这就需要 Trigger</p>
<p>这是创建一个基本触发器的语法。首先我们要切换分隔符为$$</p>
<p>其次我们 CREATE TRIGGER + 触发器的名字。触发器的命名也有一定的规矩。payments是数据表的名字，after或者before代表了这个触发器是在行为之后运行还是在之前运行。这里是在插入了payments之后，触发Trigger，第三个代表触发这个Trigger的命令类型。所以这个触发器的意思是在payments表中插入信息之后触发。</p>
<p>下面是触发器的命令。可以是AFTER也可以选BEFORE,INSERT 也可以是DELETE，FOR EACH ROW代表了每次插入都会修改。如果一次插入了5行，那么就会修改5行</p>
<p>然后是BEGIN和END代码块,其中可以输入任何为了保持表格连续性所需的代码。可以直接写语句或者调用存储过程。我们这里要更新payment_total这列的值，所以使用UPDATE invoices表格，然后设置  payment_total = payment_total+NEW.amount，注意这里改变调用的是刚刚插入的amount信息，所以我们要用NEW修饰。</p>
<p>最后我们需要设定那些是需要更新的，是invoice_id和我们插入的invoice_id相匹配的信息才需要更新，用WHERE来描述</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line">CREATE TRIGGER payments_after_insert</span><br><span class="line">    AFTER INSERT ON payments</span><br><span class="line">    FOR EACH ROW</span><br><span class="line">BEGIN</span><br><span class="line">    UPDATE invoices</span><br><span class="line">    SET payment_total &#x3D; payment_total+NEW.amount</span><br><span class="line">    WHERE invoice_id &#x3D; NEW.invoice_id;</span><br><span class="line">END $$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<p>运行后，我们插入一条信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> payments</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="keyword">DEFAULT</span>,<span class="number">5</span>,<span class="number">3</span>,<span class="string">'2019-01-01'</span>,<span class="number">10</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>然后5号信息的payment_total已经更新为10了</p>
<h4 id="小练习"><a href="#小练习" class="headerlink" title="小练习"></a>小练习</h4><p>Create a trigger that gets fired when we delete a payment</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line">CREATE TRIGGER payments_after_delete</span><br><span class="line">    AFTER DELETE ON payments</span><br><span class="line">    FOR EACH ROW</span><br><span class="line">BEGIN</span><br><span class="line">    UPDATE invoices</span><br><span class="line">    SET payment_total &#x3D; payment_total-OLD.amount</span><br><span class="line">    WHERE invoice_id &#x3D; OLD.invoice_id;</span><br><span class="line">end $$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<p>这是用来当我们删除一条payment之后，会自动更新payment_total的值的trigger</p>
<h3 id="Viewing-Triggers"><a href="#Viewing-Triggers" class="headerlink" title="Viewing Triggers"></a>Viewing Triggers</h3><p>我们没有办法在mysql workbench 查看触发器。我们可以使用SQL语句显示TRIGGER</p>
<p>运行 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">TRIGGERS</span></span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/9.png" style="zoom: 100%;"></p>
<p>如果我只想看特定的触发器，我们可以这样</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW TRIGGERS LIKE <span class="string">'payments%'</span></span><br></pre></td></tr></table></figure>
<h3 id="Dropping-Triggers"><a href="#Dropping-Triggers" class="headerlink" title="Dropping Triggers"></a>Dropping Triggers</h3><p>删除Trigger和删除存储过程差不多。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> payments_after_insert;</span><br></pre></td></tr></table></figure>
<h3 id="Using-Triggers-for-Auditing"><a href="#Using-Triggers-for-Auditing" class="headerlink" title="Using Triggers for Auditing"></a>Using Triggers for Auditing</h3><p>还有一种触发器的应用场景，就是记录对数据库的修改。比如，某人插入或者删除了某个记录，我们可以在某处记录下来，这样可以在今后回头检查。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">USE sql_invoicing;</span><br><span class="line">CREATE TABLE payments_audit</span><br><span class="line">(</span><br><span class="line">    client_id INT NOT NULL ,</span><br><span class="line">    date DATE NOT NULL ,</span><br><span class="line">    amount DECIMAL(9,2) NOT NULL ,</span><br><span class="line">    action_type VARCHAR(50) NOT NULL ,</span><br><span class="line">    action_date DATETIME NOT NULL</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>我们先新建一张表用来保存日志。然后我们在BEGIN和END之间的代码块新建INSERT INTO 语句，也就是当我们插入一条信息的时候，同时会向payments_audit表格中插入一条日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line">DROP TRIGGER IF EXISTS payments_after_insert;</span><br><span class="line">CREATE TRIGGER payments_after_insert</span><br><span class="line">    AFTER INSERT ON payments</span><br><span class="line">    FOR EACH ROW</span><br><span class="line">BEGIN</span><br><span class="line">    UPDATE invoices</span><br><span class="line">    SET payment_total &#x3D; payment_total+NEW.amount</span><br><span class="line">    WHERE invoice_id &#x3D; NEW.invoice_id;</span><br><span class="line"></span><br><span class="line">    INSERT INTO payments_audit</span><br><span class="line">    VALUES(NEW.client_id,NEW.date,NEW.amount,&#39;Insert&#39;,NOW());</span><br><span class="line"></span><br><span class="line">END $$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<p>但是这样比较麻烦，因为我们如果需要系统地记录日志，就必须对每张表都创建一个TRIGGER。在后面我们可以创建通用审计日志来达成这个目的。</p>
<h3 id="Events"><a href="#Events" class="headerlink" title="Events"></a>Events</h3><p>Event is a task (or block of SQL code) that gets executed according to a schedule </p>
<p>我们可以设置event 每天进行几次，每个几个小时进行。利用event我们可以简化数据库维护工作。比如删除状态数据，将数据从一个表拷贝到另一个表，或者把数据聚合起来生成报告。</p>
<p>在mysql中，有一个event_schedule 功能，这个功能默认是打开的，只有当这个功能打开的时候，event才能发挥它定时运作的功能，如果不想打开，可以 利用代码 关闭</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL event_scheduler &#x3D; OFF</span><br></pre></td></tr></table></figure>
<p>现在来看看怎么创建一个 Event</p>
<p>首先切换分隔符为$$ </p>
<ol>
<li><p>利用CREATE EVENT来创建一个事件，我们需要给事件创建一个一目了然的名字。</p>
</li>
<li><p>按时间间隔来给时间命名是一个好习惯。第一个可以实daily，hourly，once之类的。这样我们可以很容易找到某种事件的时间间隔。</p>
</li>
<li><p>接着用ON SCHEDULE 给这个事件创造一个时间计划：多长时间执行一次，是一次性的还是固定时刻的。如果只进行一次，那么用AT + ‘YYYY-MM-DD’ ,如果想要按找特定的事件进行，那么EVERY 1 YEAR/2 DAY ，如果想要规定开始时间和终止时间，只要在后面加上 STARTS ‘YYYY-MM-DD’ ENDS ‘YYYY-MM-DD’ 即可</p>
</li>
<li>在DO BEGIN中加入EVENT想要执行的操作。这里是删除距今超过1年的action_date 信息。我们也可以利用DATESUB(NOW(),INTERVAL 1 YEAR) 来表达相同的意思。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line">CREATE EVENT yearly_delete_stale_audit_rows</span><br><span class="line">ON SCHEDULE</span><br><span class="line">    -- AT &#39;2020-08-08&#39;</span><br><span class="line">    EVERY 1 YEAR STARTS &#39;2020-08-20&#39; ENDS &#39;2029-01-01&#39;</span><br><span class="line">DO BEGIN</span><br><span class="line">    DELETE FROM payments_audit</span><br><span class="line">    WHERE action_date&lt;NOW()-INTERVAL 1 YEAR ;</span><br><span class="line"></span><br><span class="line">END $$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h3 id="Viewing-Dropping-and-Altering-Events"><a href="#Viewing-Dropping-and-Altering-Events" class="headerlink" title="Viewing, Dropping and Altering Events"></a>Viewing, Dropping and Altering Events</h3><p>我们可以用 SHOW EVENTS语句 来显示当前的EVENT</p>
<p>利用 DROP EVENT IF EXISTS + 名字 来删除事件</p>
<p>利用 ALTER来修改事件，只需要把 CREATE EVENT 改成 ALTER EVENT 即可，利用ALTER 我们可以临时启动或者关闭一个事件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER EVENT yearly_delete_stale_audit_rows ENABLE;</span><br><span class="line">ALTER EVENT yearly_delete_stale_audit_rows DISABLE;</span><br></pre></td></tr></table></figure>
<h2 id="事务和并发"><a href="#事务和并发" class="headerlink" title="事务和并发"></a>事务和并发</h2><h3 id="Transactions"><a href="#Transactions" class="headerlink" title="Transactions"></a>Transactions</h3><p>Transaction is a group of sql statements that represent a single unit of work</p>
<p>我们是在需要对数据库进行多处修改的场景使用Transaction，所有的语句必须成功执行，否则Transaction就会失败。</p>
<p>我们不想要一些插入语句进行到一半的时候程序崩了，导致信息半生不熟的情况，这时候就要使用Transaction，也就是如果出现错误，整个语句块都作废。</p>
<p>Transaction有几个特性：</p>
<p>第一个是Atomicity，也就是不可分割的，一个事务不管其包含多少语句都是一个完整的整体。除非事务中所有的语句都成功执行，Transaction才算执行成功，否则所有修改都会回滚。</p>
<p>第二个特性是Consistency，也就是说我们使用了Transaction之后，我们的数据库永远保持一致。我们不会保存没有商品的订单记录。</p>
<p>第三个特性是Isolation。也就是说 Transaction之间是相互隔离的，特别是他们要修改同一个数据的时候。他们之间不受影响。如果多个Transaction要修改同一个数据，这条记录就会被锁定，每次只能有一个Transaction有权修改。其他的Transaction需要等待这个Transaction执行完毕</p>
<p>最后一个是Durability, 意思是一但一个Transaction被提交，它的修改就是永久性的，任何崩溃的情况（停电、宕机),也不会影响数据的修改</p>
<p>我们称这四个属性为 ACID</p>
<h3 id="Creating-Transactions"><a href="#Creating-Transactions" class="headerlink" title="Creating Transactions"></a>Creating Transactions</h3><p>我们利用 <strong>START TRANSACTION</strong> 标志着创建一个Transaction，然后在里面进行我们想要的操作，比如插入、删除信息。最后用<strong>COMMIT </strong>代表提交 Transaction 。如果在执行到第一个INSERT INTO 之后与Mysql断开连接，那么这第一条信息将不会出现在表中，因为回滚了。</p>
<p>有时候我们会手工创建Transaction 回滚来进行某些测试。这时候可以使用ROLLBACK代替COMMIT</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">USE sql_store;</span><br><span class="line">START TRANSACTION ;</span><br><span class="line"></span><br><span class="line">INSERT INTO orders (customer_id,order_date,status)</span><br><span class="line">VALUES (1,&#39;2019-01-01&#39;,1);</span><br><span class="line"></span><br><span class="line">INSERT INTO order_items</span><br><span class="line">VALUES (LAST_INSERT_ID(),1,1,1);</span><br><span class="line"></span><br><span class="line">COMMIT</span><br></pre></td></tr></table></figure>
<p>事实上，当我们在对数据库执行UPDATE ,DELETE 等操作的时候，Mysql会自动把他包裹上Transaction 的外衣并自动提交。这个功能通过全局环境变量 Autocommit : ON 来控制</p>
<h3 id="Concurrency-and-Locking"><a href="#Concurrency-and-Locking" class="headerlink" title="Concurrency and Locking"></a>Concurrency and Locking</h3><p>迄今为止，我们的数据库只有一个用户。但现实中可能是同一个数据库同时被好几个用户同时访问。这就是我们说的并发(Concurrency )。</p>
<p>比如，我们对一个数据库同时开两个连接。并对同一条信息执行一模一样的Transaction，这v时，当第一个Transaction在执行的时候，这条信息就会上锁，第二个Transaction只有在第一个结束之后，才能继续运行。</p>
<h3 id="Concurrency-Problems"><a href="#Concurrency-Problems" class="headerlink" title="Concurrency Problems"></a>Concurrency Problems</h3><h4 id="Lost-Updates"><a href="#Lost-Updates" class="headerlink" title="Lost Updates"></a>Lost Updates</h4><p>在特殊情况下，当两个事务试图更新相同的数据而我们不使用锁的时候，会发生 Lost Updates</p>
<p><img src="/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/10.png" style="zoom: 80%;"></p>
<p>我们对一条数据进行两次更新，一次更改洲名，一次更改积分，但是这样一来，如果B是后更新的，那么B中的数据会覆盖掉A中更新的数据，造成更新丢失。我们这时候就需要Locks来规避这种情况的发生，默认情况下，Mysql使用了锁定机制以防止两个事务同时更新相同的数据，他们在一个队列中，按照顺序进行。</p>
<h4 id="Dirty-Reads"><a href="#Dirty-Reads" class="headerlink" title="Dirty Reads"></a>Dirty Reads</h4><p>Dirty Reads 发生在事务读取还没有提交的数据时，比如下图。事务A想把顾客的分设置为20，在还没有提交的时候，事务B读取了表中更新过后的数据。如果每一分代表优惠一元，那么这位顾客可以优惠20元。但是事务A在提交前发生回滚。这时候事务B还没结束，所以事务B读取的数据是非法的。也就是说，在这种情况下，白给了顾客20元的优惠，因为事务B中读取了未提交的数据 。这就是 Dirty Reads，很形象。因为我们读取了污染的数据。 </p>
<p><img src="/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/11.png" style="zoom: 80%;"></p>
<p>为了解决这个问题，我们需要围绕事务提供一定程度的隔离度。所以事务修改的数据并不会立刻被其他事务读取到。之前我们提到的，实现Recovery Schedule的话，就不会发生这种问题了</p>
<h4 id="Non-repeating-Reads"><a href="#Non-repeating-Reads" class="headerlink" title="Non-repeating Reads"></a>Non-repeating Reads</h4><p> 如果在事务进行过程中，我们读取了两次、得到了不一样的结果怎么办.比如下图。事务A中选择了数据表中一条值为10的信息，但是这时候，B把这条信息的数据改成了0，现在A中的子查询又想读取这条信息，发现这时候其值已经变成0了。对于这种不重复读取问题，我们可以声明，任何时候都以最新的数据作为计算依据</p>
<p><img src="/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/12.png" style="zoom: 80%;"></p>
<h4 id="Phantom-Reads"><a href="#Phantom-Reads" class="headerlink" title="Phantom Reads"></a>Phantom Reads</h4><p>假设有个事务A，我们查询了所有积分大于10的客户，发给他们额外的打折券。这时候，一个事务B修改了一位顾客甲，把他的分修改到了20。但这时候事务A已经完成查询，甲并不在查询结果当中。这就是我们说的Phantom Read，数据有时候会像幽灵一样突然冒出来。是否解决这个问题要看我们的业务、以及把这个客户纳入我们的事务中的重要性。</p>
<h3 id="Isolation-Levels"><a href="#Isolation-Levels" class="headerlink" title="Isolation Levels"></a>Isolation Levels</h3><h4 id="Read-Uncommitted"><a href="#Read-Uncommitted" class="headerlink" title="Read Uncommitted"></a>Read Uncommitted</h4><p> 是最低级别的隔离等级。它什么都不会做，漏洞最多。会出现上面所说的所有问题。因为事务之间没有互相隔离，他们可以读取互相做出的未提交修改。</p>
<h4 id="Read-Committed"><a href="#Read-Committed" class="headerlink" title="Read Committed"></a>Read Committed</h4><p>当我们使用这个隔离级别时，事务只能读取已经提交了的数据。如果我们需要在事务中进行商务上的计算，我们的决定是基于有效的、已经提交的数据。事务运行之后有数据发生了变化，事务也不会去关注这个问题。这个隔离级别可以避免Dirty Read这个问题</p>
<h4 id="Repeatable-Read："><a href="#Repeatable-Read：" class="headerlink" title="Repeatable Read："></a>Repeatable Read：</h4><p>在这种级别下，读取的内容是可重复的，就算是数据被其他的事务修改了也没事。我们看到的只是第一次读取时就生成的快照。这个级别可以避免 Lost Updates, Dirty Reads 和 Non-repeating Reads这三个问题</p>
<p><img src="/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/14.png"></p>
<h4 id="Serializable"><a href="#Serializable" class="headerlink" title="Serializable"></a>Serializable</h4><p>出现Phantom Reads的时候，我们可以将这个事务的隔离级别设置为<strong>Serializable</strong>.这将保证事务会知道其他事务正在对数据进行修改。如果这时候其他事务正在对数据进行修改的画，那么设置为<strong>Serializable</strong>的事务就需要等待，直到其他事务完成才能进行查询等操作。这是应用于事务的最高级别的隔离，可以规避所有的问题。但是当修改的事务越来越多，我们的系统会变得越来越慢，所以这种隔离等级牺牲了性能和扩展性。因此，我们应该谨慎使用，只有在绝对关键并且一定要有防止Phantom Read的情况下。</p>
<h3 id="Transaction-Isolation-Levels"><a href="#Transaction-Isolation-Levels" class="headerlink" title="Transaction Isolation Levels"></a>Transaction Isolation Levels</h3><p>下面这张图是一个很好的归纳。功能越强大的隔离等级，性能和扩展性越差。但是越低的隔离等级，性能越好。这样能让更多的用户同时访问数据库。</p>
<p><img src="/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/13.png" style="zoom: 80%;"></p>
<p>Mysql中默认分的隔离等级是 Repeatable Read,这在大部分场景下都很好用。性能表现很好并解决了大部分问题(除了 Phantom Reads) .如果我们想规避Phantom Reads，我们可以把隔离等级设置为Serialization。对于剩下两个等级，我们可以在不需要精确的一致性的情况下使用，如批量报告(这时候数据肯定是更新好的，我需要的是更好的性能)</p>
<p>用这行代码可以显示当前的隔离等级</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW VARIABLES LIKE &#39;transaction_isolation&#39;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/15.png" style="zoom: 80%;"></p>
<p>我们使用下面这句话可以修改隔离等级</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET TRANSACTION ISOLATION LEVEL SERIALIZABLE ;</span><br></pre></td></tr></table></figure>
<p>执行后，会在下一次事务执行时修改隔离等级。我们也可以在当前的session或者connection中设置隔离等级。我们在前面加SESSION关键字，只要我们的这个连接任务还打开着，所有的事务都会被设置。当然我们也可以把SESSION换成GLOBAL。</p>
<p>当我们的程序中有个执行某些事务的函数，那么当运行的时候，我们使用SESSION即可，因为我们只需要为这个Session或者connection修改等级，步骤是：连接到库，修改等级，执行事务，关闭连接。这种操作并不会影响到其他的事物</p>
<h3 id="Deadlocks"><a href="#Deadlocks" class="headerlink" title="Deadlocks"></a>Deadlocks</h3><p>死锁发生在不同的事务都无法完成的情况下，因为每个事务都持有另一个事务需要的锁，所以事务都会上对方等待而不会释放自己的锁</p>
<h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>在mysql中有几种数据类型的分类。</p>
<p><img src="/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/16.png" style="zoom: 80%;"></p>
<h3 id="String-Types"><a href="#String-Types" class="headerlink" title="String Types"></a>String Types</h3><p>String Types 分为 好几种</p>
<p>Char字符用来存放固定长度的字符，比如世界各个国家的缩写，美国各个州的缩写。Varchar是用来保存可变长度的字符，比如用户名、密码、Email地址等。String类型也可以用来保存数字类型的数据，比如邮政编码、电话号码，因为这些数字并不是用来计算的。另外，这样的数据也会包含短横线或者括号。这也是另一个要用字符串保存着类数据的理由。</p>
<p>我们需要有良好的习惯。给一些特定类别的数据类型固定字符串规则。比如</p>
<p>VARCHAR(50) for short strings</p>
<p>VARCHAR(255) for medium-length strings </p>
<p>如果VARCHAR不够用了，我们可以用MEDIUMTEXT ，其可存储16MB的数据，非常适合存储JSON对象，CS视图字符串以及短至中型的文章。</p>
<p>当然LONGTEXT可以存储4GB的内存，可以存储日志等。</p>
<p>还有TINYTEXT和TEXT，各自有各自的存储空间</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>类型</th>
<th>容量及描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>CHAR(x)</td>
<td>fixed-length</td>
</tr>
<tr>
<td>VARCHAR(x)</td>
<td>max: 65535 characters(~64kb)</td>
</tr>
<tr>
<td>MEDIUMTEXT</td>
<td>max:16MB</td>
</tr>
<tr>
<td>LONGTEXT</td>
<td>max:4GB</td>
</tr>
<tr>
<td>TINYTEXT</td>
<td>max: 255bytes</td>
</tr>
<tr>
<td>TEXT</td>
<td>max:64kb</td>
</tr>
</tbody>
</table>
</div>
<p>比起TEXT最好使用VARCHAR，因为VARCHAR是可以作为索引的。索引可以加快查询数据。</p>
<p>英文字母占1字节；欧洲和中东文字占2字节；亚洲文字(中文、日文)占3字节</p>
<h3 id="Integer-Types"><a href="#Integer-Types" class="headerlink" title="Integer Types"></a>Integer Types</h3><p>我们使用整数来保存并没有小数位的数字，比如1234，mysql有5中整数类型，各自能存储的容量不同。</p>
<p>TINYINTY 短整数，只占用1个字节。取值[-128,127]</p>
<p>UNSIGNED TINYINT 无符号短整数，取值[0,255]用来存储人类年龄很合适，可以防止意外输入赋值的问题。</p>
<p>SMALLINT 2byte 取值[-32k,32k] </p>
<p>MEDIUMINT 3byte 取值[-8M，8M]</p>
<p>INT 4byte 取值[-2B,2B]</p>
<p>BIGINT 8byte  取值[-9Z,9Z]</p>
<p>除了UNSIGNED，数字类型还有一个属性，就是ZEROFILL,这种情况用0填充虚位。比如 0001，0003</p>
<p>最好永远选择适合我的最小数据类型。</p>
<h3 id="Fixed-point-and-Floating-point-Types"><a href="#Fixed-point-and-Floating-point-Types" class="headerlink" title="Fixed-point and Floating-point Types"></a>Fixed-point and Floating-point Types</h3><p>mysql中有3种保存小数的类型。</p>
<p>DECIMAL(p,s) 这种类型的数字，小数点后面的位数是固定的。当使用DECIMAL类型时，需要指定小数位数。p代表整数的维数，可以选择1到65。s代表保留小数位数。比如DECIMAL(9,2) =&gt;1234567.89</p>
<p>DECIMAL可以用DEC, NUMERIC,FIXED</p>
<p>第二种是FLOAT ，4b</p>
<p>第三种是DOUBLE, 8b</p>
<p>但是FLOAT和DOUBLE不能精确的记录数字，所以我们如果想要精确的记录数字就必须要用DECIMAL，但是如果我需要做科学计算中使用很大或者很小的数，那么可以用FLOAT或者 DOUBLE</p>
<h3 id="Boolean-Types"><a href="#Boolean-Types" class="headerlink" title="Boolean Types"></a>Boolean Types</h3><p>布尔值实际上就是短整数的另外一个形态。 数值类型可以是BOOL或者BOOLEAN</p>
<p>TRUE代表1，FALSE代表0</p>
<h3 id="Enum-and-Set-Types"><a href="#Enum-and-Set-Types" class="headerlink" title="Enum and Set Types"></a>Enum and Set Types</h3><p>有时候我们需要某个字段的取值是有限的若干字符串。比如，有个列只能插入 small，medium，big三种。那么在表格中我们可以这样设置其数据类型</p>
<p>ENUM(‘small’,’medium’,’big’ )</p>
<p>这时候，只能三选一，任何其他的值都会让mysql报错。</p>
<p>但是ENUM类型的效率不是很好，当我们想增加一种选项的时候我们必须重新设计表格。</p>
<p>更好的方式是新建一张叫做Size的表，这个表中既可以保存大小，又可以保存其精确值。这样我们就可以重复利用这张表格了。如果想列出所有的大小，只需要写一局查询语句即可，这种表格叫做查询表。比如：</p>
<p><img src="/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/17.png" style="zoom: 80%;"></p>
<p>mysql中还有一种类似的数据类型为SET，它让我们在列中可以保存SET提供的多个数据。但也不建议使用</p>
<h3 id="Date-and-Time-Types"><a href="#Date-and-Time-Types" class="headerlink" title="Date and Time Types"></a>Date and Time Types</h3><p>mysql中有几种保存日期时间的类型。</p>
<p>DATE 用于保存日期，但是没有时间部分</p>
<p>TIME 用来保存时间</p>
<p>DATETIME 8b </p>
<p>TIMESTAMP  4b 我们经常使用TIMESTAMP时间戳来记录数据插入和最后修改的时间，最大年份是2038年。超过2038年只能使用DATETIME来保存。</p>
<p>YEAR</p>
<h3 id="Blob-Types"><a href="#Blob-Types" class="headerlink" title="Blob Types"></a>Blob Types</h3><p>Blob用来保存大的二进制数据，如图像、视频、PDF、几乎任何二进制文件。mysql有四种BLOB类型</p>
<p>TINYBLOB 255b</p>
<p>BLOB 65KB</p>
<p>MEDIUMBLOB 16MB</p>
<p>LONGBLOB 4GB</p>
<p>通常来说，我们应该将文件放到数据库外面。因为关系型数据库是用来处理结构化数据的，而不是二进制数据。如果将文件保存到库当中，库的大小将会增长非常快、备份起来非常慢、性能上出现严重问题(从库中读取图片的速度永远慢于直接从文件系统读取。最后，我们还需要单独编写文件的存储代码</p>
<h3 id="JSON-Type"><a href="#JSON-Type" class="headerlink" title="JSON Type"></a>JSON Type</h3><p>mysql也可以存储JSON文件。</p>
<p><img src="/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/18.png" style="zoom: 50%;"></p>
<p>在设计了一列数据类型为JSON之后，我们可以这样插入一条JSON信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">UPDATE products</span><br><span class="line">SET properties &#x3D;</span><br><span class="line">&#39;&#123;</span><br><span class="line">  &quot;dimentions&quot;:[1,2,3],</span><br><span class="line">  &quot;weight&quot;:10,</span><br><span class="line">  &quot;manufacturer&quot;: &#123;&quot;name&quot;: &quot;sony&quot; &#125;</span><br><span class="line">&#125;&#39;</span><br><span class="line">WHERE product_id &#x3D; 1;</span><br></pre></td></tr></table></figure>
<p>此外，我们还可以看看另一个创建JSON对象的方法：使用特定的哈数来创建JSON对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">UPDATE products</span><br><span class="line">SET properties =JSON_OBJECT(</span><br><span class="line">    <span class="string">'weight'</span>,<span class="string">'10'</span>,</span><br><span class="line">    <span class="string">'dimensions'</span>,JSON_ARRAY(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>),</span><br><span class="line">    <span class="string">'manufacturer'</span>,JSON_OBJECT(<span class="string">'name'</span>,<span class="string">'sony'</span>)</span><br><span class="line">    )</span><br><span class="line">WHERE product_id = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>对于JSON类型，我们可以检索特定的键值对，这比VARCHAR的优势更大，因为String类通常不能对字符串进行分割</p>
<p>比如用这样的mysql语句进行查询. $ 代表了JSON对象，用点运算符连接对象中的KEY</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT product_id,JSON_EXTRACT(properties,&#39;$.weight&#39;) AS weight</span><br><span class="line">FROM products</span><br><span class="line">WHERE product_id &#x3D; 1;</span><br></pre></td></tr></table></figure>
<p>但是我们还有更简单的写法。我们可以用路径指示符，也就是箭头符号来执行查询。这里，dimentions是一个数组，所以我们可以通过用中括号的方法来获取数组中某个特定的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT product_id,properties -&gt; &#39;$.dimentions[1]&#39;</span><br><span class="line">FROM products</span><br><span class="line">WHERE product_id &#x3D;1;</span><br></pre></td></tr></table></figure>
<p>又比如，-&gt;&gt; 是为了让manufacturer的name属性 sony没有引号出现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT product_id,properties -&gt;&gt; &#39;$.manufacturer.name&#39;</span><br><span class="line">FROM products</span><br><span class="line">WHERE product_id &#x3D;1;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/19.png"></p>
<p>还有一些可以更新JSON数据的方法。比如我想修改weight对应的键值，怎么办？我们可以使用JSON_SET方法。它不仅可以修改键值，还可以增加键</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">UPDATE products</span><br><span class="line">SET properties &#x3D; JSON_SET(</span><br><span class="line">    properties,</span><br><span class="line">    &#39;$.weight&#39;,20,</span><br><span class="line">    &#39;$.age&#39;,10 # age原本不存在</span><br><span class="line">    )</span><br><span class="line">WHERE product_id &#x3D; 1;</span><br></pre></td></tr></table></figure>
<p>现在我们可以使用JSON_REMOVE来意出我们不需要的键</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">UPDATE products</span><br><span class="line">SET properties &#x3D; JSON_REMOVE(</span><br><span class="line">    properties,</span><br><span class="line">    &#39;$.age&#39;</span><br><span class="line">    )</span><br><span class="line">WHERE product_id &#x3D; 1;</span><br></pre></td></tr></table></figure>
<h2 id="设计数据库"><a href="#设计数据库" class="headerlink" title="设计数据库"></a>设计数据库</h2><h3 id="Introduction-1"><a href="#Introduction-1" class="headerlink" title="Introduction"></a>Introduction</h3><h3 id="Data-Modelling"><a href="#Data-Modelling" class="headerlink" title="Data Modelling"></a>Data Modelling</h3><h3 id="Conceptual-Models"><a href="#Conceptual-Models" class="headerlink" title="Conceptual Models"></a>Conceptual Models</h3><h3 id="Logical-Models"><a href="#Logical-Models" class="headerlink" title="Logical Models"></a>Logical Models</h3><h3 id="Physical-Models"><a href="#Physical-Models" class="headerlink" title="Physical Models"></a>Physical Models</h3><h3 id="Primary-Keys"><a href="#Primary-Keys" class="headerlink" title="Primary Keys"></a>Primary Keys</h3><h3 id="Foreign-Keys"><a href="#Foreign-Keys" class="headerlink" title="Foreign Keys"></a>Foreign Keys</h3><h3 id="Foreign-Key-Constraints"><a href="#Foreign-Key-Constraints" class="headerlink" title="Foreign Key Constraints"></a>Foreign Key Constraints</h3><h3 id="Normalization"><a href="#Normalization" class="headerlink" title="Normalization"></a>Normalization</h3><h3 id="1NF-First-Normal-Form"><a href="#1NF-First-Normal-Form" class="headerlink" title="1NF- First Normal Form"></a>1NF- First Normal Form</h3><h3 id="Link-Tables"><a href="#Link-Tables" class="headerlink" title="Link Tables"></a>Link Tables</h3><h3 id="2NF-Second-Normal-Form"><a href="#2NF-Second-Normal-Form" class="headerlink" title="2NF- Second Normal Form"></a>2NF- Second Normal Form</h3><h3 id="3NF-Third-Normal-Form"><a href="#3NF-Third-Normal-Form" class="headerlink" title="3NF- Third Normal Form"></a>3NF- Third Normal Form</h3><h3 id="My-Pragmatic-Advice"><a href="#My-Pragmatic-Advice" class="headerlink" title="My Pragmatic Advice"></a>My Pragmatic Advice</h3><h3 id="Don’t-Model-the-Universe"><a href="#Don’t-Model-the-Universe" class="headerlink" title="Don’t Model the Universe"></a>Don’t Model the Universe</h3><h3 id="Forward-Engineering-a-Model"><a href="#Forward-Engineering-a-Model" class="headerlink" title="Forward Engineering a Model"></a>Forward Engineering a Model</h3><h3 id="Synchronizing-a-Model-with-a-Database"><a href="#Synchronizing-a-Model-with-a-Database" class="headerlink" title="Synchronizing a Model with a Database"></a>Synchronizing a Model with a Database</h3><h3 id="Reverse-Engineering-a-Database"><a href="#Reverse-Engineering-a-Database" class="headerlink" title="Reverse Engineering a Database"></a>Reverse Engineering a Database</h3><h3 id="Project-Flight-Booking-System"><a href="#Project-Flight-Booking-System" class="headerlink" title="Project- Flight Booking System"></a>Project- Flight Booking System</h3><h3 id="Solution-Conceptual-Model"><a href="#Solution-Conceptual-Model" class="headerlink" title="Solution- Conceptual Model"></a>Solution- Conceptual Model</h3><h3 id="Solution-Logical-Model"><a href="#Solution-Logical-Model" class="headerlink" title="Solution- Logical Model"></a>Solution- Logical Model</h3><h3 id="Project-Video-Rental-Application"><a href="#Project-Video-Rental-Application" class="headerlink" title="Project - Video Rental Application"></a>Project - Video Rental Application</h3><h3 id="Solution-Conceptual-Model-1"><a href="#Solution-Conceptual-Model-1" class="headerlink" title="Solution- Conceptual Model"></a>Solution- Conceptual Model</h3><h3 id="Solution-Logical-Model-1"><a href="#Solution-Logical-Model-1" class="headerlink" title="Solution- Logical Model"></a>Solution- Logical Model</h3><h3 id="Creating-and-Dropping-Databases"><a href="#Creating-and-Dropping-Databases" class="headerlink" title="Creating and Dropping Databases"></a>Creating and Dropping Databases</h3><h3 id="Creating-Tables"><a href="#Creating-Tables" class="headerlink" title="Creating Tables"></a>Creating Tables</h3><h3 id="Altering-Tables"><a href="#Altering-Tables" class="headerlink" title="Altering Tables"></a>Altering Tables</h3><h3 id="Creating-Relationships"><a href="#Creating-Relationships" class="headerlink" title="Creating Relationships"></a>Creating Relationships</h3><h3 id="Altering-Primary-and-Foreign-Key-Constraints"><a href="#Altering-Primary-and-Foreign-Key-Constraints" class="headerlink" title="Altering Primary and Foreign Key Constraints"></a>Altering Primary and Foreign Key Constraints</h3><h3 id="Character-Sets-and-Collations"><a href="#Character-Sets-and-Collations" class="headerlink" title="Character Sets and Collations"></a>Character Sets and Collations</h3><h3 id="Storage-Engines"><a href="#Storage-Engines" class="headerlink" title="Storage Engines"></a>Storage Engines</h3><h3 id="A-Quick-Note"><a href="#A-Quick-Note" class="headerlink" title="A Quick Note"></a>A Quick Note</h3><h2 id="高效的索引"><a href="#高效的索引" class="headerlink" title="高效的索引"></a>高效的索引</h2><h3 id="Introduction-2"><a href="#Introduction-2" class="headerlink" title="Introduction"></a>Introduction</h3><h3 id="Indexes"><a href="#Indexes" class="headerlink" title="Indexes"></a>Indexes</h3><h3 id="Creating-Indexes"><a href="#Creating-Indexes" class="headerlink" title="Creating Indexes"></a>Creating Indexes</h3><h3 id="Viewing-Indexes"><a href="#Viewing-Indexes" class="headerlink" title="Viewing Indexes"></a>Viewing Indexes</h3><h3 id="Prefix-Indexes"><a href="#Prefix-Indexes" class="headerlink" title="Prefix Indexes"></a>Prefix Indexes</h3><h3 id="Full-text-Indexes"><a href="#Full-text-Indexes" class="headerlink" title="Full-text Indexes"></a>Full-text Indexes</h3><h3 id="Composite-Indexes"><a href="#Composite-Indexes" class="headerlink" title="Composite Indexes"></a>Composite Indexes</h3><h3 id="Order-of-Columns-in-Composite-Indexes"><a href="#Order-of-Columns-in-Composite-Indexes" class="headerlink" title="Order of Columns in Composite Indexes"></a>Order of Columns in Composite Indexes</h3><h3 id="When-Indexes-are-Ignored"><a href="#When-Indexes-are-Ignored" class="headerlink" title="When Indexes are Ignored"></a>When Indexes are Ignored</h3><h3 id="Using-Indexes-for-Sorting"><a href="#Using-Indexes-for-Sorting" class="headerlink" title="Using Indexes for Sorting"></a>Using Indexes for Sorting</h3><h3 id="Covering-Indexese"><a href="#Covering-Indexese" class="headerlink" title="Covering Indexese"></a>Covering Indexese</h3><h3 id="Index-Maintenance"><a href="#Index-Maintenance" class="headerlink" title="Index Maintenance"></a>Index Maintenance</h3><h3 id="Performance-Best-Practices"><a href="#Performance-Best-Practices" class="headerlink" title="Performance Best Practices"></a>Performance Best Practices</h3><h2 id="保护数据库"><a href="#保护数据库" class="headerlink" title="保护数据库"></a>保护数据库</h2><h3 id="Introduction-3"><a href="#Introduction-3" class="headerlink" title="Introduction"></a>Introduction</h3><h3 id="Creating-a-User"><a href="#Creating-a-User" class="headerlink" title="Creating a User"></a>Creating a User</h3><h3 id="Viewing-Users"><a href="#Viewing-Users" class="headerlink" title="Viewing Users"></a>Viewing Users</h3><h3 id="Dropping-Users"><a href="#Dropping-Users" class="headerlink" title="Dropping Users"></a>Dropping Users</h3><h3 id="Changing-Passwords"><a href="#Changing-Passwords" class="headerlink" title="Changing Passwords"></a>Changing Passwords</h3><h3 id="Granting-Privileges"><a href="#Granting-Privileges" class="headerlink" title="Granting Privileges"></a>Granting Privileges</h3><h3 id="Viewing-Privileges"><a href="#Viewing-Privileges" class="headerlink" title="Viewing Privileges"></a>Viewing Privileges</h3><h3 id="Revoking-Privileges"><a href="#Revoking-Privileges" class="headerlink" title="Revoking Privileges"></a>Revoking Privileges</h3><h3 id="Wrap-Up"><a href="#Wrap-Up" class="headerlink" title="Wrap Up"></a>Wrap Up</h3>
      
    </div>
    
    
    
    <div>
      
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束，感谢您的阅读-------------</div>
    
</div>

      
    </div>
    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:</strong>
    Jason
  </li>
  <li class="post-copyright-link">
    <strong>Post link:</strong>
    <a href="https://jasonxqh.github.io/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/" title="mysql基础下">https://jasonxqh.github.io/2020/06/26/mysql%E5%9F%BA%E7%A1%80%E4%B8%8B/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice: </strong>
    All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> unless stating additionally.
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Mysql/" rel="tag"><i class="fa fa-tag"></i> Mysql</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/06/26/PostgreSql%E5%9F%BA%E7%A1%80/" rel="next" title="PostgreSql基础">
                <i class="fa fa-chevron-left"></i> PostgreSql基础
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/06/28/php%E5%9F%BA%E7%A1%80/" rel="prev" title="php基础">
                php基础 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80OTgyMC8yNjMxMQ=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Jason</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives%7C%7C%20archive">
              
                  <span class="site-state-item-count">426</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">60</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/JasonXQH" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:10195501423@stu.ecnu.edu.cn" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://yanghong.tech/" title="友链:杨弘的博客" target="_blank">友链:杨弘的博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://ankate.github.io/" title="友链:赵奕轲的博客" target="_blank">友链:赵奕轲的博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://github.com/JasonXQH/JasonXQH.github.io" title="Like it, STAR ME" target="_blank">Like it, STAR ME</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#mysql基础下"><span class="nav-number">1.</span> <span class="nav-text">mysql基础下</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Stored-Prodedure"><span class="nav-number">1.1.</span> <span class="nav-text">Stored Prodedure</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#What-are-Stored-Procedures"><span class="nav-number">1.1.1.</span> <span class="nav-text">What are Stored Procedures</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Creating-a-Stored-Procedure"><span class="nav-number">1.1.2.</span> <span class="nav-text">Creating a Stored Procedure</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#小练习："><span class="nav-number">1.1.2.1.</span> <span class="nav-text">小练习：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Creating-Procedures-Using-MySQLWorkbench"><span class="nav-number">1.1.3.</span> <span class="nav-text">Creating Procedures Using MySQLWorkbench</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dropping-Stored-Procedures"><span class="nav-number">1.1.4.</span> <span class="nav-text">Dropping Stored Procedures</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Parameters"><span class="nav-number">1.1.5.</span> <span class="nav-text">Parameters</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#小练习：-1"><span class="nav-number">1.1.5.1.</span> <span class="nav-text">小练习：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Parameters-with-Default-Value"><span class="nav-number">1.1.6.</span> <span class="nav-text">Parameters with Default Value</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#小练习：-2"><span class="nav-number">1.1.6.1.</span> <span class="nav-text">小练习：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Parameter-Validation"><span class="nav-number">1.1.7.</span> <span class="nav-text">Parameter Validation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Output-Parameters"><span class="nav-number">1.1.8.</span> <span class="nav-text">Output Parameters</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Variables"><span class="nav-number">1.1.9.</span> <span class="nav-text">Variables</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Functions"><span class="nav-number">1.1.10.</span> <span class="nav-text">Functions</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#触发器和事件"><span class="nav-number">1.2.</span> <span class="nav-text">触发器和事件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Triggers"><span class="nav-number">1.2.1.</span> <span class="nav-text">Triggers</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#小练习"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">小练习</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Viewing-Triggers"><span class="nav-number">1.2.2.</span> <span class="nav-text">Viewing Triggers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dropping-Triggers"><span class="nav-number">1.2.3.</span> <span class="nav-text">Dropping Triggers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Using-Triggers-for-Auditing"><span class="nav-number">1.2.4.</span> <span class="nav-text">Using Triggers for Auditing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Events"><span class="nav-number">1.2.5.</span> <span class="nav-text">Events</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Viewing-Dropping-and-Altering-Events"><span class="nav-number">1.2.6.</span> <span class="nav-text">Viewing, Dropping and Altering Events</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#事务和并发"><span class="nav-number">1.3.</span> <span class="nav-text">事务和并发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Transactions"><span class="nav-number">1.3.1.</span> <span class="nav-text">Transactions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Creating-Transactions"><span class="nav-number">1.3.2.</span> <span class="nav-text">Creating Transactions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Concurrency-and-Locking"><span class="nav-number">1.3.3.</span> <span class="nav-text">Concurrency and Locking</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Concurrency-Problems"><span class="nav-number">1.3.4.</span> <span class="nav-text">Concurrency Problems</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Lost-Updates"><span class="nav-number">1.3.4.1.</span> <span class="nav-text">Lost Updates</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Dirty-Reads"><span class="nav-number">1.3.4.2.</span> <span class="nav-text">Dirty Reads</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Non-repeating-Reads"><span class="nav-number">1.3.4.3.</span> <span class="nav-text">Non-repeating Reads</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Phantom-Reads"><span class="nav-number">1.3.4.4.</span> <span class="nav-text">Phantom Reads</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Isolation-Levels"><span class="nav-number">1.3.5.</span> <span class="nav-text">Isolation Levels</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Read-Uncommitted"><span class="nav-number">1.3.5.1.</span> <span class="nav-text">Read Uncommitted</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Read-Committed"><span class="nav-number">1.3.5.2.</span> <span class="nav-text">Read Committed</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Repeatable-Read："><span class="nav-number">1.3.5.3.</span> <span class="nav-text">Repeatable Read：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Serializable"><span class="nav-number">1.3.5.4.</span> <span class="nav-text">Serializable</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Transaction-Isolation-Levels"><span class="nav-number">1.3.6.</span> <span class="nav-text">Transaction Isolation Levels</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Deadlocks"><span class="nav-number">1.3.7.</span> <span class="nav-text">Deadlocks</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据类型"><span class="nav-number">1.4.</span> <span class="nav-text">数据类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Introduction"><span class="nav-number">1.4.1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#String-Types"><span class="nav-number">1.4.2.</span> <span class="nav-text">String Types</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Integer-Types"><span class="nav-number">1.4.3.</span> <span class="nav-text">Integer Types</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Fixed-point-and-Floating-point-Types"><span class="nav-number">1.4.4.</span> <span class="nav-text">Fixed-point and Floating-point Types</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Boolean-Types"><span class="nav-number">1.4.5.</span> <span class="nav-text">Boolean Types</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Enum-and-Set-Types"><span class="nav-number">1.4.6.</span> <span class="nav-text">Enum and Set Types</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Date-and-Time-Types"><span class="nav-number">1.4.7.</span> <span class="nav-text">Date and Time Types</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Blob-Types"><span class="nav-number">1.4.8.</span> <span class="nav-text">Blob Types</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JSON-Type"><span class="nav-number">1.4.9.</span> <span class="nav-text">JSON Type</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#设计数据库"><span class="nav-number">1.5.</span> <span class="nav-text">设计数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Introduction-1"><span class="nav-number">1.5.1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Data-Modelling"><span class="nav-number">1.5.2.</span> <span class="nav-text">Data Modelling</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Conceptual-Models"><span class="nav-number">1.5.3.</span> <span class="nav-text">Conceptual Models</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Logical-Models"><span class="nav-number">1.5.4.</span> <span class="nav-text">Logical Models</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Physical-Models"><span class="nav-number">1.5.5.</span> <span class="nav-text">Physical Models</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Primary-Keys"><span class="nav-number">1.5.6.</span> <span class="nav-text">Primary Keys</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Foreign-Keys"><span class="nav-number">1.5.7.</span> <span class="nav-text">Foreign Keys</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Foreign-Key-Constraints"><span class="nav-number">1.5.8.</span> <span class="nav-text">Foreign Key Constraints</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Normalization"><span class="nav-number">1.5.9.</span> <span class="nav-text">Normalization</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1NF-First-Normal-Form"><span class="nav-number">1.5.10.</span> <span class="nav-text">1NF- First Normal Form</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Link-Tables"><span class="nav-number">1.5.11.</span> <span class="nav-text">Link Tables</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2NF-Second-Normal-Form"><span class="nav-number">1.5.12.</span> <span class="nav-text">2NF- Second Normal Form</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3NF-Third-Normal-Form"><span class="nav-number">1.5.13.</span> <span class="nav-text">3NF- Third Normal Form</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#My-Pragmatic-Advice"><span class="nav-number">1.5.14.</span> <span class="nav-text">My Pragmatic Advice</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Don’t-Model-the-Universe"><span class="nav-number">1.5.15.</span> <span class="nav-text">Don’t Model the Universe</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Forward-Engineering-a-Model"><span class="nav-number">1.5.16.</span> <span class="nav-text">Forward Engineering a Model</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Synchronizing-a-Model-with-a-Database"><span class="nav-number">1.5.17.</span> <span class="nav-text">Synchronizing a Model with a Database</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reverse-Engineering-a-Database"><span class="nav-number">1.5.18.</span> <span class="nav-text">Reverse Engineering a Database</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Project-Flight-Booking-System"><span class="nav-number">1.5.19.</span> <span class="nav-text">Project- Flight Booking System</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Solution-Conceptual-Model"><span class="nav-number">1.5.20.</span> <span class="nav-text">Solution- Conceptual Model</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Solution-Logical-Model"><span class="nav-number">1.5.21.</span> <span class="nav-text">Solution- Logical Model</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Project-Video-Rental-Application"><span class="nav-number">1.5.22.</span> <span class="nav-text">Project - Video Rental Application</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Solution-Conceptual-Model-1"><span class="nav-number">1.5.23.</span> <span class="nav-text">Solution- Conceptual Model</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Solution-Logical-Model-1"><span class="nav-number">1.5.24.</span> <span class="nav-text">Solution- Logical Model</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Creating-and-Dropping-Databases"><span class="nav-number">1.5.25.</span> <span class="nav-text">Creating and Dropping Databases</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Creating-Tables"><span class="nav-number">1.5.26.</span> <span class="nav-text">Creating Tables</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Altering-Tables"><span class="nav-number">1.5.27.</span> <span class="nav-text">Altering Tables</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Creating-Relationships"><span class="nav-number">1.5.28.</span> <span class="nav-text">Creating Relationships</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Altering-Primary-and-Foreign-Key-Constraints"><span class="nav-number">1.5.29.</span> <span class="nav-text">Altering Primary and Foreign Key Constraints</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Character-Sets-and-Collations"><span class="nav-number">1.5.30.</span> <span class="nav-text">Character Sets and Collations</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Storage-Engines"><span class="nav-number">1.5.31.</span> <span class="nav-text">Storage Engines</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#A-Quick-Note"><span class="nav-number">1.5.32.</span> <span class="nav-text">A Quick Note</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#高效的索引"><span class="nav-number">1.6.</span> <span class="nav-text">高效的索引</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Introduction-2"><span class="nav-number">1.6.1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Indexes"><span class="nav-number">1.6.2.</span> <span class="nav-text">Indexes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Creating-Indexes"><span class="nav-number">1.6.3.</span> <span class="nav-text">Creating Indexes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Viewing-Indexes"><span class="nav-number">1.6.4.</span> <span class="nav-text">Viewing Indexes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Prefix-Indexes"><span class="nav-number">1.6.5.</span> <span class="nav-text">Prefix Indexes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Full-text-Indexes"><span class="nav-number">1.6.6.</span> <span class="nav-text">Full-text Indexes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Composite-Indexes"><span class="nav-number">1.6.7.</span> <span class="nav-text">Composite Indexes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Order-of-Columns-in-Composite-Indexes"><span class="nav-number">1.6.8.</span> <span class="nav-text">Order of Columns in Composite Indexes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#When-Indexes-are-Ignored"><span class="nav-number">1.6.9.</span> <span class="nav-text">When Indexes are Ignored</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Using-Indexes-for-Sorting"><span class="nav-number">1.6.10.</span> <span class="nav-text">Using Indexes for Sorting</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Covering-Indexese"><span class="nav-number">1.6.11.</span> <span class="nav-text">Covering Indexese</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Index-Maintenance"><span class="nav-number">1.6.12.</span> <span class="nav-text">Index Maintenance</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Performance-Best-Practices"><span class="nav-number">1.6.13.</span> <span class="nav-text">Performance Best Practices</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#保护数据库"><span class="nav-number">1.7.</span> <span class="nav-text">保护数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Introduction-3"><span class="nav-number">1.7.1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Creating-a-User"><span class="nav-number">1.7.2.</span> <span class="nav-text">Creating a User</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Viewing-Users"><span class="nav-number">1.7.3.</span> <span class="nav-text">Viewing Users</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dropping-Users"><span class="nav-number">1.7.4.</span> <span class="nav-text">Dropping Users</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Changing-Passwords"><span class="nav-number">1.7.5.</span> <span class="nav-text">Changing Passwords</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Granting-Privileges"><span class="nav-number">1.7.6.</span> <span class="nav-text">Granting Privileges</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Viewing-Privileges"><span class="nav-number">1.7.7.</span> <span class="nav-text">Viewing Privileges</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Revoking-Privileges"><span class="nav-number">1.7.8.</span> <span class="nav-text">Revoking Privileges</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Wrap-Up"><span class="nav-number">1.7.9.</span> <span class="nav-text">Wrap Up</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart" aria-hidden="true"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jason</span>
 <!--
  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">1238.8k</span>
  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>



-->
        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('-1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->


  
  

  
  


  

  

</body>
</html>
