<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="y0-26jFM_8wn6Slpy1ahkB8ndR7w0OOGyAU6IaXjLUI" />














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="CSAPP," />










<meta name="description" content="CSAPP程序的机器级表示3数组的分配和访问基本原则我们首先来看看数组的声明 T A[N]  其中T是数据类型，N是整形常数。 这个声明有两个效果  在内存中分配了一个 $L\cdot N$ 字节的连续区域，这里L是数据类型T的大小（单位为字节）。 引入了标识符A，可以用A来做指向数组开头的指针，记为 $x_A$。然后可以用 $0\sim {N-1}$ 的整数索引来范根该数组元素。数组元素i会被存">
<meta property="og:type" content="article">
<meta property="og:title" content="CSAPP程序的机器级表示3">
<meta property="og:url" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/index.html">
<meta property="og:site_name" content="Jason‘s Blog">
<meta property="og:description" content="CSAPP程序的机器级表示3数组的分配和访问基本原则我们首先来看看数组的声明 T A[N]  其中T是数据类型，N是整形常数。 这个声明有两个效果  在内存中分配了一个 $L\cdot N$ 字节的连续区域，这里L是数据类型T的大小（单位为字节）。 引入了标识符A，可以用A来做指向数组开头的指针，记为 $x_A$。然后可以用 $0\sim {N-1}$ 的整数索引来范根该数组元素。数组元素i会被存">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/1.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/2.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/3.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/4.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/5.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/6.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/7.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/9.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/10.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/11.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/12.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/13.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/14.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/15.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/16.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/1.jpg">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/2.jpg">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/17.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/18.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/19.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/20.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/21.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/23.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/24.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/25.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/26.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/27.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/28.png">
<meta property="og:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/29.png">
<meta property="article:published_time" content="2020-10-20T08:55:46.000Z">
<meta property="article:modified_time" content="2020-10-28T03:02:44.000Z">
<meta property="article:author" content="Jason">
<meta property="article:tag" content="CSAPP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://jasonxqh.github.io/2020/10/20/CSAPP程序的机器级表示3/"/>





  <title>CSAPP程序的机器级表示3 | Jason‘s Blog</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-170027658-1', 'auto');
  ga('send', 'pageview');
</script>





<meta name="generator" content="Hexo 4.2.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">
  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
<a href="https://github.com/JasonXQH/JasonXQH.github.io" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jason‘s Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            Sitemap
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">CSAPP程序的机器级表示3</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-10-20T16:55:46+08:00">
                2020-10-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  5k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  20
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="CSAPP程序的机器级表示3"><a href="#CSAPP程序的机器级表示3" class="headerlink" title="CSAPP程序的机器级表示3"></a>CSAPP程序的机器级表示3</h1><h2 id="数组的分配和访问"><a href="#数组的分配和访问" class="headerlink" title="数组的分配和访问"></a>数组的分配和访问</h2><h3 id="基本原则"><a href="#基本原则" class="headerlink" title="基本原则"></a>基本原则</h3><p>我们首先来看看数组的声明</p>
<p><strong>T A[N]</strong> </p>
<p>其中T是数据类型，N是整形常数。</p>
<p>这个声明有两个效果</p>
<ul>
<li>在内存中分配了一个 $L\cdot N$ 字节的连续区域，这里L是数据类型T的大小（单位为字节）。</li>
<li>引入了标识符A，可以用A来做指向数组开头的指针，记为 $x_A$。然后可以用 $0\sim {N-1}$ 的整数索引来范根该数组元素。数组元素i会被存放在地址为 $x_A+L\cdot i$ 的地方</li>
</ul>
<p>下面申请了几个数组，我们可以看到数组成员在地址上的位置</p>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/1.png"></p>
<p>假如 E 是一个int型的数组，而我们想计算 $E[i]$ ，在此，E的地址存放在寄存器 $\%rdx$ 中，而 i 存放在寄存器 $\%rcx$ 中。然后再指令 </p>
<p>$movl~~(\%rdx,\%rcx,4),\%eax$   会执行计算 $x_E+4i$  读取这个内存位置的值，并将结果存放到寄存器 $\%eax$ 中。允许的伸缩因子 1、2、4、8 刚好能覆盖了所有基本简单数据类型的大小。 </p>
<h3 id="访问数组"><a href="#访问数组" class="headerlink" title="访问数组"></a>访问数组</h3><p>访问数组的形式非常多样</p>
<p>C语言允许对指针进行运算，而计算出来的值会<strong>根据该指针引用的数据类型大小进行伸缩</strong>。也就是说如果 p 是一个指向 类型为T 的数据的指针，那么表达式 p+i 就等于 $x_p+L\cdot i$ </p>
<div class="table-container">
<table>
<thead>
<tr>
<th>表达式</th>
<th>类型</th>
<th>值</th>
<th>汇编代码</th>
</tr>
</thead>
<tbody>
<tr>
<td>E</td>
<td>int *</td>
<td>$x_E$</td>
<td>movq %rdx,%rax</td>
</tr>
<tr>
<td>E[0]</td>
<td>int</td>
<td>$M[x_E]$ //在$x_E$ 地址上的值</td>
<td>movl (%rdx),%rax</td>
</tr>
<tr>
<td>E[i]</td>
<td>int</td>
<td>$M[x_E+4i]$</td>
<td>movl (%rdx,%rcx,4) ,%eax</td>
</tr>
<tr>
<td>&amp;E[2]</td>
<td>int*</td>
<td>$x_E+8$</td>
<td>leaq 8(%rdx),%rax</td>
</tr>
<tr>
<td>E+i-1</td>
<td>int*</td>
<td>$x_E+4i-4$</td>
<td>leaq -4(%rdx,%rcx,4) ,%rax</td>
</tr>
<tr>
<td>*(E+i-3)</td>
<td>int</td>
<td>$M[x_E+4i-12]$</td>
<td>movl -12(%rdx,%rcx,4),%eax</td>
</tr>
<tr>
<td>&amp;E[i]-E</td>
<td>long</td>
<td>i</td>
<td>movq %rcx,%rax</td>
</tr>
</tbody>
</table>
</div>
<p>最后一个例子是两个指针之差，结果的数据类型为long</p>
<h4 id="Array-Loop-Example"><a href="#Array-Loop-Example" class="headerlink" title="Array Loop Example"></a>Array Loop Example</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">zincr</span><span class="params">(zip_dig z)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">    z[i]++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个 函数的汇编代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># %rdi &#x3D; z</span><br><span class="line">	movl 	$0, %eax 			# i &#x3D; 0</span><br><span class="line">	jmp 	.L3 				# goto middle</span><br><span class="line">.L4: 							# loop:</span><br><span class="line">	addl 	$1, (%rdi,%rax,4) 	# z[i]++</span><br><span class="line">	addq 	$1, %rax 			# i++</span><br><span class="line">.L3: 							# middle</span><br><span class="line">	cmpq 	$4, %rax 			# i:4</span><br><span class="line">	jbe 	.L4 				# if &lt;&#x3D;, goto loop	</span><br><span class="line">	rep; ret</span><br></pre></td></tr></table></figure>
<p>.L3 中，需要用 i 和 4相比，如果小于等于4，那么就跳转到 .L4</p>
<p>现在我们举几个数组和指针的例子</p>
<p>Comp: Compiles (Y/N)<br>Bad:     Possible bad pointer reference (Y/N)<br>Size:     Value returned by sizeof</p>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/2.png"></p>
<ul>
<li>首先 $A1[3]$  和 $*A2$ 都是 可以通过编译的，而且指针都不是非法的。</li>
<li>因为A1有3个int，所以数组大小是 12个字节，*A2 是指针，长度为8个字节</li>
<li>对于 *A1和 *A2,它们都是能通过编译的，但是对A1来说，在声明之初已经申请了地址了，只是没有初始化，所以*A1 是任意一个值，而 *A2则没有为其分配内存，输出*A2 就会出错，而对于*A1 和 *A2,声明之初是int，所以Size为4个字节</li>
</ul>
<p>现在来看看更加复杂的问题： </p>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/3.png"></p>
<ul>
<li>A1[3]是一维数组, *A2[3]是指针数组 ,也就是用来存放指针的数组，这些指针会指向 int 类型的数据。  (*A3)[3]是一个数组指针，也就是指向长度为3的数组的指针 这三者都能通过编译。</li>
<li>对于 (*A3)[3] 来说，*An就是它指向的地方也就是数组，数组有3个int数据，大小为 12 size 。但这个数组的内存尚未分配，所以是 Bad Reference。对于 *A2[3] 来说，*An 就是指针数组中的指针，是分配过内存的，大小为8size</li>
<li>对于A1[3]来说 **An 不存在这种定义。对 *A2[3] 来说，<em>\</em>An 是指针指向的区域，但因为这些区域没有分配内存，所以是非法的。对(*A3)[3] 来说，** An 是数组中存放的数据，大小为4byte，但是因为没有分配内存，所以也是Bad Reference</li>
</ul>
<h3 id="嵌套数组-Nested"><a href="#嵌套数组-Nested" class="headerlink" title="嵌套数组(Nested)"></a>嵌套数组(Nested)</h3><p>嵌套数组这样声明：</p>
<p>T A[R][C]:</p>
<p>这是一个二维数组：数据类型为T，R行C列</p>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/4.png"></p>
<p>Array的大小就是 $R\cdot C\cdot sizeof(T)$ bytes</p>
<p>嵌套数组是以行为主导顺序分配内存的：Row-Major</p>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/5.png" style="zoom:90%;"></p>
<p>这是嵌套数组的另外一种定义方式：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PCOUNT 4</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> zip_dig[<span class="number">5</span>];</span><br><span class="line">zip_dig pgh[PCOUNT] =</span><br><span class="line">    &#123;&#123;<span class="number">1</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">6</span>&#125;,</span><br><span class="line">    &#123;<span class="number">1</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span> &#125;,</span><br><span class="line">    &#123;<span class="number">1</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">7</span> &#125;,</span><br><span class="line">    &#123;<span class="number">1</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span> &#125;&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/6.png" style="zoom:90%;"></p>
<h4 id="Nested-Array-Row-access"><a href="#Nested-Array-Row-access" class="headerlink" title="Nested Array Row access"></a>Nested Array Row access</h4><p>对于 嵌套数组 A[R][C] 那么我们要访问一个数组中的一行，我们该怎么办：</p>
<p>行向量的开始地址是 ：$A+i\cdot (C\cdot sizeof(T))$ </p>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/7.png" style="zoom:90%;"></p>
<h4 id="Nested-Array-Element-access"><a href="#Nested-Array-Element-access" class="headerlink" title="Nested Array Element access"></a>Nested Array Element access</h4><p>A[i][j]  是一个类型为T的数据,设T有K个字节，那么其地址可以这样来写 ： $A+i\cdot(C\cdot K)+j\cdot K=A+(i\cdot C+j)\cdot K$ </p>
<p>具体用 int 举例我们可以这样表示：</p>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/9.png" style="zoom:90%;"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_pgh_digit</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> dig)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> pgh[index][dig];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其汇编代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">leaq 	(%rdi,%rdi,4), %rax 	# 5*index</span><br><span class="line">addl 	%rax, %rsi 				# 5*index+dig</span><br><span class="line">movl 	pgh(,%rsi,4), %eax 		# M[pgh + 4*(5*index+dig)]</span><br></pre></td></tr></table></figure>
<p>Address:  pgh + 20*index + 4*dig = pgh + 4*(5*index + dig)</p>
<h3 id="Multi-Level-Array"><a href="#Multi-Level-Array" class="headerlink" title="Multi-Level Array"></a>Multi-Level Array</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">zip_dig cmu = &#123; <span class="number">1</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span> &#125;;</span><br><span class="line">zip_dig mit = &#123; <span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">9</span> &#125;;</span><br><span class="line">zip_dig ucb = &#123; <span class="number">9</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UCOUNT 3</span></span><br><span class="line"><span class="keyword">int</span> *univ[UCOUNT] = &#123;mit, cmu, ucb&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/10.png" style="zoom:90%;"></p>
<p>获得一个具体位置的数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_univ_digit</span><span class="params">(<span class="keyword">size_t</span> index, <span class="keyword">size_t</span> digit)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> univ[index][digit];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面是函数的汇编代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">salq 	$2, %rsi 			# 4*digit</span><br><span class="line">addq 	univ(,%rdi,8), %rsi # p &#x3D; univ[index] + 4*digit</span><br><span class="line">movl 	(%rsi), %eax 		# return *p</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>
<p>Element access Mem[Mem[univ+8*index]+4*digit]</p>
<p>对二维数组的两种存储方法(Nested array和 Multi-level array) ，我们可以做一个对比：</p>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/11.png" style="zoom:90%;"></p>
<h2 id="异质的数据结构"><a href="#异质的数据结构" class="headerlink" title="异质的数据结构"></a>异质的数据结构</h2><p>C语言中有 structure(结构)，用struct声明，将多个对象集合到一个单位中</p>
<p>union(联合)，用关键字union来声明，允许用几种不同类型来引用一个对象。</p>
<h3 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h3><p>struct结构类似于数组的实现，它将所有组成部分都存放在内存中一段连续的区域内，而只想结构的指针就是结构第一个字节的地址。</p>
<p>比如下面这个例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rec</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> a[<span class="number">4</span>];</span><br><span class="line">	<span class="keyword">size_t</span> i;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rec</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/12.png" style="zoom:90%;"></p>
<p>我们看到首先声明的是 一个int类型的数组，占用 4x4 =16 个字节。然后是size_t ，在64位机器下是8个字节。 next是一个指针，至下关下一个struct，所以占用8个byte。 可以观察到 数组 a 是嵌入到这个结构当中的。</p>
<hr>
<p>现在我想计算出指向a中某个数据的指针，我们应该如何操作？</p>
<p>代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> *<span class="title">get_ap</span> <span class="params">(struct rec *r, <span class="keyword">size_t</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;r-&gt;a[idx];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在汇编代码中，编译器会这么处理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># r in %rdi, idx in %rsi</span><br><span class="line">leaq 	(%rdi,%rsi,4), %rax</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>
<hr>
<p>现在我想计算一条链表中的长度,我们可以写一个这样的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">length</span><span class="params">(struct rec*r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> len = <span class="number">0L</span>;</span><br><span class="line">    <span class="keyword">while</span> (r) &#123;</span><br><span class="line">        len ++;</span><br><span class="line">        r = r-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其汇编代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.L11: 						# loop:</span><br><span class="line">    addq 	$1, %rax 		# len ++</span><br><span class="line">    movq 	24(%rdi), %rdi	# r &#x3D; Mem[r+24]</span><br><span class="line">    testq 	%rdi, %rdi 		# Test r</span><br><span class="line">    jne 	.L11 			# If !&#x3D; 0, goto loop</span><br></pre></td></tr></table></figure>
<p>因为一个struct占用的空间为32byte，但是最后8byte指向的是下一个struct 开始的地址，所以我们只要读出 在 r+24处的地址并判断其是否为空即可判断链表是否已经到达尾端</p>
<p>r+24 是 next的地址，next地址上的值 = 下一个struct的开头地址</p>
<hr>
<p>再来看看下面这个可能会出现问题的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_val</span> <span class="params">(struct rec *r, <span class="keyword">int</span> val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">while</span> (r) &#123;</span><br><span class="line">        <span class="keyword">size_t</span> i = r-&gt;i;</span><br><span class="line">        r-&gt;a[i] = val;</span><br><span class="line">        r = r-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先把 i 命令成 struct里面的 i，然后将 val的值赋给 a[i] ,然后再指向下一个struct</p>
<p>其汇编代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.L11: 							# loop:</span><br><span class="line">    movq   16(%rdi), %rax	 	# i &#x3D; Mem[r+16]</span><br><span class="line">    movl   %esi, (%rdi,%rax,4) 	# Mem[r+4*i] &#x3D; val</span><br><span class="line">    movq   24(%rdi), %rdi 		# r &#x3D; Mem[r+24]</span><br><span class="line">    testq  %rdi, %rdi 			# Test r</span><br><span class="line">    jne    .L11 				# if !&#x3D;0 goto loop</span><br></pre></td></tr></table></figure>
<p>先取出 r+16 地址上的值赋给 i，然后再将$r+4\cdot i $地址上的值赋值给 $val$</p>
<p>但是这样写会出现意想不到的结果，因为a只有4个位置，如果 struct 中的 $i\geq 4$ 的话，事实上 r-&gt;a[i] = val 实际上改动的是 r-&gt;i =val甚至报错 因为struct是在内存上连续存储的，C语言也不会检查数组是否会越界。于是 a[4] 其实修改的是 r-&gt;i 的值，而如果 i继续增大的话，到了没有分配内存的区域，C语言就会报错。</p>
<h3 id="联合"><a href="#联合" class="headerlink" title="联合"></a>联合</h3><h3 id="数据对齐"><a href="#数据对齐" class="headerlink" title="数据对齐"></a>数据对齐</h3><p>在struct中，我们要进行数据对齐。</p>
<p>对于一个 struct 例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">S1</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> c;</span><br><span class="line">    <span class="keyword">int</span> i[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">double</span> v;</span><br><span class="line">&#125; *p;</span><br></pre></td></tr></table></figure>
<p>在真实的内存当中，它其实是这么存储的：</p>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/13.png" style="zoom:90%;"></p>
<p>对于一个数据类型，它在内存里的起始位置必须是它大小的倍数：</p>
<p>对于一个 character来说，它在哪里存储都可以，因为其长度只有1byte</p>
<p>对于一个 int 来说，他的起始位置必须是4的倍数</p>
<p>对以一个double来说，它的起始位置必须是8的倍数。</p>
<p>这就造成了中间空出来的空间。虽然一个struct只要17个字节，但是像这样写C语言，存储的时候却需要24的字节</p>
<p>为什么要对齐？</p>
<p>因为数据不一定放在内存里，而放在cache里面，从 cache里面取数据会比内存里取快很多。cache是很小的，一个cache line是64个byte。我们希望当取一个struct的时候，我们希望这个数据项不要跨两个cache，而放在一个 cache line里面。如果一个结构跨cache line存储，那么取了一条cache line，还有一条在外面：这样就导致即没有让速度变快，又浪费了cache line。这种情况叫做 miss,会极大的影响机器的性能。</p>
<p>所以对于struct来说，我们宁可空出一段内存，也要让cache的命中率增加，从而提升整个程序的运算速度。</p>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/14.png" style="zoom:90%;"></p>
<p>对于一个结构数组，我们发现，即使是把最大的数据放在前面，满打满算用完17个字节，在存储的时候仍然要在最后补上空白的一些空间。这是因为要将整个struct大小补全到8的倍数，这里是24个字节。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">short <span class="title">get_j</span><span class="params">(<span class="keyword">int</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> a[idx].j;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># %rdi &#x3D; idx</span><br><span class="line">leaq 	(%rdi,%rdi,2),%rax 	# 3*idx</span><br><span class="line">movzwl 	a+8(,%rax,4),%eax</span><br></pre></td></tr></table></figure>
<p>在某种情况下，我们可以节省空间：</p>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/15.png" style="zoom:90%;"></p>
<h2 id="在机器及程序中将控制和数据结合起来"><a href="#在机器及程序中将控制和数据结合起来" class="headerlink" title="在机器及程序中将控制和数据结合起来"></a>在机器及程序中将控制和数据结合起来</h2><h3 id="Memory-Layout"><a href="#Memory-Layout" class="headerlink" title="Memory Layout"></a>Memory Layout</h3><p>在CSAPP的第一篇文章中我就讲过一个程序中不同的变量等在内存中的分布。现在我们在来复习一下。</p>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/16.png" style="zoom:90%;"></p>
<p>这里所说的Memory是 address space之意，是虚拟内存</p>
<p>首先我们来看 Shared Libraries，这里存放的是一些库函数、头文件之类的。即不是我们自己写的代码</p>
<p>然后我们看看Stack，stack有8M的内存空间，朝着低地址伸展。Stack中主要存放的是局部变量等数据</p>
<p>Heap和Stack不同，它是向上生长的。主要存放的是动态分配出来的内存，比如C++中new出来的、C中malloc() 出来的地址空间</p>
<p>然后是Data区域，Data主要存放的是静态变量和全局变量。这里我们要再声明一下静态变量和全局变量的区别：</p>
<p>1、全局变量在整个工程文件内都有效；</p>
<p>2、静态全局变量 只在定义它的文件内有效；</p>
<p>3、<strong>静态局部变量只在定义它的函数内有效，且程序仅分配一次内存</strong>，函数返回后，该变量不会消失；局部变量在定义它的函数内有效，但是函数返回后失效。<br>4、<strong>全局变量</strong>和静态变量如果没有手工初始化，则由编译器初始化为0。局部变量的值不可知。</p>
<p>5、<strong>静态局部变量</strong>与<strong>全局变量</strong>共享全局数据区，<strong>但静态局部变量只在定义它的函数中可见</strong>。静态局部变量与局部变量在存储位置上不同，使得其存在的时限也不同，导致对这两者操作 的运行结果也不同。</p>
<p>最后一个Text区域是代码区，里面存放着我们写的这个文件的代码。</p>
<p>我们来看一个具体的例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> big_array[<span class="number">1L</span>&lt;&lt;<span class="number">24</span>]; <span class="comment">/* 16 MB */</span></span><br><span class="line"><span class="keyword">char</span> huge_array[<span class="number">1L</span>&lt;&lt;<span class="number">31</span>]; <span class="comment">/* 2 GB */</span></span><br><span class="line"><span class="keyword">int</span> global = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">useless</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *phuge1, *psmall2, *phuge3, *psmall4;</span><br><span class="line">    <span class="keyword">int</span> local = <span class="number">0</span>;</span><br><span class="line">    phuge1 = <span class="built_in">malloc</span>(<span class="number">1L</span> &lt;&lt; <span class="number">28</span>); <span class="comment">/* 256 MB */</span></span><br><span class="line">    psmall2 = <span class="built_in">malloc</span>(<span class="number">1L</span> &lt;&lt; <span class="number">8</span>); <span class="comment">/* 256 B */</span></span><br><span class="line">    phuge3 = <span class="built_in">malloc</span>(<span class="number">1L</span> &lt;&lt; <span class="number">32</span>); <span class="comment">/* 4 GB */</span></span><br><span class="line">    psmall4 = <span class="built_in">malloc</span>(<span class="number">1L</span> &lt;&lt; <span class="number">8</span>); <span class="comment">/* 256 B */</span></span><br><span class="line">    <span class="comment">/* Some print statements ... */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">not</span> drawn to scale</span><br></pre></td></tr></table></figure>
<p>big_array 和 huge_array,global 是全局变量，应该放到Data当中</p>
<p>useless() 是一个函数，属于我们写的代码，所以放到Text当中</p>
<p>local 是局部变量，放到栈中</p>
<p>phuge1，psmall2,phuge3,psmall4 是malloc盛情的指针。所以它们会放到Heap中去</p>
<p>下面是一个让栈溢出的例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">recurse</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> a[<span class="number">1</span>&lt;&lt;<span class="number">15</span>]; <span class="comment">// 4*2^15 = 128 KiB</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"x = %d. a at %p\n"</span>, x, a);</span><br><span class="line">    a[<span class="number">0</span>] = (<span class="number">1</span>&lt;&lt;<span class="number">14</span>)<span class="number">-1</span>;</span><br><span class="line">    a[a[<span class="number">0</span>]] = x<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (a[a[<span class="number">0</span>]] == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> recurse(a[a[<span class="number">0</span>]]) - <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每次递归，函数都会开一个大小为128KB的数组。</p>
<p>最后的运行结果如下，如果x等于67输入，到最后一次分配内存的时候，数组会撑满8M的栈空间。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;runaway 67</span><br><span class="line">x &#x3D; 67. a at 0x7ffd18aba930</span><br><span class="line">x &#x3D; 66. a at 0x7ffd18a9a920</span><br><span class="line">x &#x3D; 65. a at 0x7ffd18a7a910</span><br><span class="line">x &#x3D; 64. a at 0x7ffd18a5a900</span><br><span class="line">. . .</span><br><span class="line">x &#x3D; 4. a at 0x7ffd182da540</span><br><span class="line">x &#x3D; 3. a at 0x7ffd182ba530</span><br><span class="line">x &#x3D; 2. a at 0x7ffd1829a520</span><br></pre></td></tr></table></figure>
<h3 id="Buffer-Overflow"><a href="#Buffer-Overflow" class="headerlink" title="Buffer Overflow"></a>Buffer Overflow</h3><p>我们现在来看一个向上溢出的例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> a[<span class="number">2</span>];</span><br><span class="line">	<span class="keyword">double</span> d;	</span><br><span class="line">&#125; <span class="keyword">struct_t</span>;</span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">fun</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">struct_t</span> s;</span><br><span class="line">	s.d = <span class="number">3.14</span>;</span><br><span class="line">	s.a[i] = <span class="number">1073741824</span>; <span class="comment">/* Possibly out of bounds */</span></span><br><span class="line">	<span class="keyword">return</span> s.d;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先，这个struct s是放在栈里面的，我们之前说栈里面的元素是按照低地址到高地址排列的，画出来就是从下到上排列的。示意图如下 ：</p>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/1.jpg" style="zoom:90%;"></p>
<p>现在我们调用fun(8),会出现segmentation fault,因为a[8] 已经向上冲出这个结构趋于了，因此我们将这个现象叫做 stack overflow</p>
<p>如果调用 fun(0) 或者 fun(1),返回值是3.14，很正常。</p>
<p>但是如果调用 fun(2) 返回值变成了：3.1399998665 为什么是这个答案？</p>
<p>这就要考虑到double 这个浮点数在栈里面是怎么放的：如下图</p>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/2.jpg" style="zoom:90%;"></p>
<p>当我们调用fun(2)，其结果就是将double d中的部分M修改成了 1073741824。也就是说我们对这个浮点数的小数部分进行了修改，但是并没有修改其符号和阶码。因此我们看到结果是仅仅影响了一些精度，并没有影响很大。</p>
<p>当我们调用 fun(3),那么就是对上面的S、E、M都进行了修改，但是如果运气足够好，事实上和原来的值相差也不是很大。这李调用fun(3) 返回的值是 2.0000006104</p>
<p>fun(4)到fun(7)我们看到栈里面放的是Critical State,这时候还不会立马报segmentation fault，而是会提醒我们 Stack smashing detected</p>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/17.png" style="zoom:90%;"></p>
<p>还有一种情况，是这样的:</p>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/18.png" style="zoom:90%;"></p>
<p>我们调用fun(8),结果反而又对了，这就好比一开始我们撞墙了(segmentation fault) ，那么我们干脆直接写到墙的另外一端去，反而对结构内的数据不影响了。</p>
<p>如果出现这样的问题，通常我们将其称为 buffer overflow。我们通过调试是很难发现的。这种错误是非常微小但在某些情况下是非常致命的。</p>
<p>接下来我们通过几个例子来看看如何攻击一个不安全的代码和如何来保护我们的代码不受他人攻击</p>
<h3 id="Vulnerability-弱点"><a href="#Vulnerability-弱点" class="headerlink" title="Vulnerability 弱点"></a>Vulnerability 弱点</h3><p>我们先举几个例子：</p>
<p>C语言标准库里有一个gets函数，这个函数的写法如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Get string from stdin */</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">gets</span><span class="params">(<span class="keyword">char</span> *dest)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> c = getchar();</span><br><span class="line">    <span class="keyword">char</span> *p = dest;</span><br><span class="line">    <span class="keyword">while</span> (c != EOF &amp;&amp; c != <span class="string">'\n'</span>) &#123;</span><br><span class="line">    	*p++ = c;	</span><br><span class="line">    	c = getchar();</span><br><span class="line">	&#125;</span><br><span class="line">	*p = <span class="string">'\0'</span>;</span><br><span class="line">	<span class="keyword">return</span> dest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数是说，如果没有结束或者回车的话，gets会一直读入字符。看起来没有问题，但是这个函数<strong>没有检查</strong>这个指针 *dest  指向的地址以及地址之后的一段地址是合法的还是非法的。</p>
<p>正确的应该是我们应该malloc一段地址来存放string，如果输入的string大于malloc的大小，函数就会报越界。</p>
<p>同样的：</p>
<p>strcpy, strcat: Copy strings of arbitrary length<br>scanf, fscanf, sscanf, when given %s conversion specification</p>
<p>这些函数都存在着一些问题。</p>
<p>在实际的例子中，比如这个函数，按照设想来说我们只开了一个 4个byte的字符数组。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Echo Line */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">4</span>]; <span class="comment">/* Way too small! */</span></span><br><span class="line">    gets(buf);</span><br><span class="line">    <span class="built_in">puts</span>(buf);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">call_echo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	echo();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是，我们这样输入，却不会报错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unix&gt;.&#x2F;bufdemo-nsp</span><br><span class="line">Type a string:01234567890123456789012</span><br><span class="line">01234567890123456789012</span><br></pre></td></tr></table></figure>
<p>而再多输入一个字符，函数就会报segmentation fault</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">unix&gt;.&#x2F;bufdemo-nsp</span><br><span class="line">Type a string:012345678901234567890123</span><br><span class="line">012345678901234567890123</span><br><span class="line">Segmentation Fault</span><br></pre></td></tr></table></figure>
<p>前面不报错的原因是地址上可能有一部分原来就是合法的，那你读取的话也无伤大雅，关键是我们不知道程序什么时候会报segmentation fault</p>
<p>现在我们来看看这个程序运行的机制：</p>
<p>首先我们将其反编译：</p>
<p><strong>echo</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">000000000040069c &lt;echo&gt;:</span><br><span class="line">40069c: 48 83 ec 18 		sub 		$0x18,%rsp</span><br><span class="line">4006a0: 48 89 e7 			mov 		%rsp,%rdi</span><br><span class="line">4006a3: e8 a5 ff ff ff 		callq 		40064d &lt;gets&gt;</span><br><span class="line">4006a8: 48 89 e7 			mov 		%rsp,%rdi</span><br><span class="line">4006ab: e8 50 fe ff ff 		callq		400500 &lt;puts@plt&gt;</span><br><span class="line">4006b0: 48 83 c4 18 		add 		$0x18,%rsp</span><br><span class="line">4006b4: c3 					retq</span><br></pre></td></tr></table></figure>
<p><strong>call_echo</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">4006b5: 48 83 ec 08 		sub 		$0x8,%rsp</span><br><span class="line">4006b9: b8 00 00 00 00 		mov 		$0x0,%eax</span><br><span class="line">4006be: e8 d9 ff ff ff 		callq 		40069c &lt;echo&gt;</span><br><span class="line">4006c3: 48 83 c4 08 		add 		$0x8,%rsp</span><br><span class="line">4006c7: c3 					retq</span><br></pre></td></tr></table></figure>
<p>再调用gets之前，这个echo函数栈帧如下：最上面的是caller也就是call_echo的栈帧。接下来是一段return address也就是返回的地址。然后是20个未被使用但是合法的bytes(这也是为什么我们之前输入了23个数字仍然没有报错的原因了) ，最后是我们申请的 buf 数组。</p>
<p>像之前我们输入了23个数字，加上\0刚好将unused 部分和buf数组全部填满。这时候是不会报错的。但是如果我输入24个数字，那么有一个数字就会冲出合法的数组，将返回地址改写。但是返回地址的内容是会收到保护的，于是整个程序就会崩溃，报return地址出错。</p>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/19.png" style="zoom:90%;"></p>
<p>从上面的汇编语言可以得出，call_echo在0x4006be处调用了echo，所以echo的返回地址是 0x4006c3</p>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/20.png" style="zoom:90%;"></p>
<p>这是我输入23个数字后，栈帧的结构，我们发现除了buf数组被填满了，20个未被使用的buf也被填满了。</p>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/21.png" style="zoom:90%;"></p>
<p>如果我输入了24个数进去，我们就会发现返回地址中的低位被修改了。结果就是返回到了一个非法的地址上去，程序崩溃。</p>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/23.png" style="zoom:90%;"></p>
<p>由此我们可以得出，如果有些别有用心的人通过查看你的代码，计算你的栈帧并将你的返回地址修改成某段他希望跳转到的地址，这样你的程序就会变得非常不安全。之后的attacklab就要求我们去攻击那些不是非常安全的代码。而在我们写程序的时候，我们要做的就是对我们的程序进行一个保护。</p>
<h3 id="Protection"><a href="#Protection" class="headerlink" title="Protection"></a>Protection</h3><h4 id="Avoid-overflow-vulnerabilities"><a href="#Avoid-overflow-vulnerabilities" class="headerlink" title="Avoid overflow vulnerabilities"></a>Avoid overflow vulnerabilities</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Echo Line */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">4</span>];</span><br><span class="line">    fgets(buf, <span class="number">4</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="built_in">puts</span>(buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>For example, use library routines that limit string lengths</p>
<ul>
<li>fgets instead of gets</li>
<li>strncpy instead of strcpy</li>
<li>Don’t use scanf with %s conversion specification<ul>
<li>Use fgets to read the string</li>
<li>Or use %ns where n is a suitable integer</li>
</ul>
</li>
</ul>
<h4 id="Employ-system-level-protections"><a href="#Employ-system-level-protections" class="headerlink" title="Employ system-level protections"></a>Employ system-level protections</h4><p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/24.png" style="zoom:90%;"></p>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/25.png" style="zoom:90%;"></p>
<h4 id="Have-compiler-use-“stack-canaries”"><a href="#Have-compiler-use-“stack-canaries”" class="headerlink" title="Have compiler use “stack canaries”"></a>Have compiler use “stack canaries”</h4><p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/26.png" style="zoom:90%;"></p>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/27.png" style="zoom:90%;"></p>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/28.png" style="zoom:90%;"></p>
<p><img src="/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/29.png" style="zoom:90%;"></p>
<h2 id="浮点代码"><a href="#浮点代码" class="headerlink" title="浮点代码"></a>浮点代码</h2>
      
    </div>
    
    
    
    <div>
      
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束，感谢您的阅读-------------</div>
    
</div>

      
    </div>
    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:</strong>
    Jason
  </li>
  <li class="post-copyright-link">
    <strong>Post link:</strong>
    <a href="https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/" title="CSAPP程序的机器级表示3">https://jasonxqh.github.io/2020/10/20/CSAPP%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA3/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice: </strong>
    All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> unless stating additionally.
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/CSAPP/" rel="tag"><i class="fa fa-tag"></i> CSAPP</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/10/15/Naive-Bayes/" rel="next" title="Naive_Bayes">
                <i class="fa fa-chevron-left"></i> Naive_Bayes
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/10/21/%E6%9C%B4%E7%B4%A0%E8%B4%9D%E5%8F%B6%E6%96%AF/" rel="prev" title="朴素贝叶斯">
                朴素贝叶斯 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80OTgyMC8yNjMxMQ=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Jason</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives%7C%7C%20archive">
              
                  <span class="site-state-item-count">426</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">60</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/JasonXQH" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:10195501423@stu.ecnu.edu.cn" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://yanghong.tech/" title="友链:杨弘的博客" target="_blank">友链:杨弘的博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://ankate.github.io/" title="友链:赵奕轲的博客" target="_blank">友链:赵奕轲的博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://github.com/JasonXQH/JasonXQH.github.io" title="Like it, STAR ME" target="_blank">Like it, STAR ME</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#CSAPP程序的机器级表示3"><span class="nav-number">1.</span> <span class="nav-text">CSAPP程序的机器级表示3</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#数组的分配和访问"><span class="nav-number">1.1.</span> <span class="nav-text">数组的分配和访问</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基本原则"><span class="nav-number">1.1.1.</span> <span class="nav-text">基本原则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#访问数组"><span class="nav-number">1.1.2.</span> <span class="nav-text">访问数组</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Array-Loop-Example"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">Array Loop Example</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#嵌套数组-Nested"><span class="nav-number">1.1.3.</span> <span class="nav-text">嵌套数组(Nested)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Nested-Array-Row-access"><span class="nav-number">1.1.3.1.</span> <span class="nav-text">Nested Array Row access</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Nested-Array-Element-access"><span class="nav-number">1.1.3.2.</span> <span class="nav-text">Nested Array Element access</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Multi-Level-Array"><span class="nav-number">1.1.4.</span> <span class="nav-text">Multi-Level Array</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#异质的数据结构"><span class="nav-number">1.2.</span> <span class="nav-text">异质的数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#结构"><span class="nav-number">1.2.1.</span> <span class="nav-text">结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#联合"><span class="nav-number">1.2.2.</span> <span class="nav-text">联合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据对齐"><span class="nav-number">1.2.3.</span> <span class="nav-text">数据对齐</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在机器及程序中将控制和数据结合起来"><span class="nav-number">1.3.</span> <span class="nav-text">在机器及程序中将控制和数据结合起来</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Memory-Layout"><span class="nav-number">1.3.1.</span> <span class="nav-text">Memory Layout</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Buffer-Overflow"><span class="nav-number">1.3.2.</span> <span class="nav-text">Buffer Overflow</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Vulnerability-弱点"><span class="nav-number">1.3.3.</span> <span class="nav-text">Vulnerability 弱点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Protection"><span class="nav-number">1.3.4.</span> <span class="nav-text">Protection</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Avoid-overflow-vulnerabilities"><span class="nav-number">1.3.4.1.</span> <span class="nav-text">Avoid overflow vulnerabilities</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Employ-system-level-protections"><span class="nav-number">1.3.4.2.</span> <span class="nav-text">Employ system-level protections</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Have-compiler-use-“stack-canaries”"><span class="nav-number">1.3.4.3.</span> <span class="nav-text">Have compiler use “stack canaries”</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#浮点代码"><span class="nav-number">1.4.</span> <span class="nav-text">浮点代码</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart" aria-hidden="true"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jason</span>
 <!--
  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">1248.9k</span>
  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>



-->
        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('-1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  


  

  

</body>
</html>
