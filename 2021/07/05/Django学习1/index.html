<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="y0-26jFM_8wn6Slpy1ahkB8ndR7w0OOGyAU6IaXjLUI" />














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="python," />










<meta name="description" content="Django学习1FundamentalsDjango 是一个用来做Web开发的、基于python的开源框架。YouTube、Instergram等网页就是用Django制作的。 Django的好处有很多，比如说它直接提供了一个 admin site，也就是后台帮我们监控流量、处理用户信息等，帮我们减少了很多编程的时间。以及 Object-related mapper(ORM)，这可以让我们少些很">
<meta property="og:type" content="article">
<meta property="og:title" content="Django学习1">
<meta property="og:url" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/index.html">
<meta property="og:site_name" content="Jason‘s Blog">
<meta property="og:description" content="Django学习1FundamentalsDjango 是一个用来做Web开发的、基于python的开源框架。YouTube、Instergram等网页就是用Django制作的。 Django的好处有很多，比如说它直接提供了一个 admin site，也就是后台帮我们监控流量、处理用户信息等，帮我们减少了很多编程的时间。以及 Object-related mapper(ORM)，这可以让我们少些很">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/1.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/2.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/4.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/3.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/5.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/6.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/8.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/9.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/7.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/10.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/11.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/12.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/13.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/18.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/15.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/14.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/16.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/17.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/18.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/19.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/20.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/21.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/22.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/23.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/24.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/25.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/26.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/27.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/28.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/29.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/30.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/31.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/32.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/33.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/34.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/35.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/36.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/37.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/38.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/39.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/40.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/41.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/42.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/44.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/45.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/46.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/47.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/48.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/49.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/50.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/51.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/52.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/53.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/54.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/55.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/56.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/57.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/58.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/59.gif">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/60.gif">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/61.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/62.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/63.gif">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/64.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/65.gif">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/66.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/67.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/68.gif">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/69.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/70.gif">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/71.gif">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/74.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/75.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/72.gif">
<meta property="og:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/73.png">
<meta property="article:published_time" content="2021-07-05T10:52:44.000Z">
<meta property="article:modified_time" content="2021-12-01T06:06:24.000Z">
<meta property="article:author" content="Jason">
<meta property="article:tag" content="python">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://jasonxqh.github.io/2021/07/05/Django学习1/"/>





  <title>Django学习1 | Jason‘s Blog</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-170027658-1', 'auto');
  ga('send', 'pageview');
</script>





<meta name="generator" content="Hexo 4.2.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">
  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
<a href="https://github.com/JasonXQH/JasonXQH.github.io" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jason‘s Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            Sitemap
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Django学习1</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-07-05T18:52:44+08:00">
                2021-07-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  16.2k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  66
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Django学习1"><a href="#Django学习1" class="headerlink" title="Django学习1"></a>Django学习1</h1><h2 id="Fundamentals"><a href="#Fundamentals" class="headerlink" title="Fundamentals"></a>Fundamentals</h2><p>Django 是一个用来做Web开发的、基于python的开源框架。YouTube、Instergram等网页就是用Django制作的。</p>
<p>Django的好处有很多，比如说它直接提供了一个 <code>admin site</code>，也就是后台帮我们监控流量、处理用户信息等，帮我们减少了很多编程的时间。以及 <code>Object-related mapper(ORM)</code>，这可以让我们少些很多SQL语句。此外还有Authentication以及提供了Cache 等优点。</p>
<p>我们之前已经学过了一些前端和后端，前端有 React 后端有 Express。那其实Django是一个Web后端，当浏览器向后端发送HTTP请求的时候，后端就会通过查询、计算等步骤返回给前端一些数据(不返回网页是因为效率太低)，然后前段负责渲染这些数据。</p>
<blockquote>
<p>我们使用的环境</p>
<p>python3.9<br>pip3 install pipenv<br>vscode</p>
</blockquote>
<p>现在我们在文件夹中新建一个Django项目：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir storefront                           </span><br><span class="line">cd storefront</span><br><span class="line">pipenv install django</span><br></pre></td></tr></table></figure>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/1.png" style="zoom:67%;"></p>
<p>输入<code>pipenv install django</code> 之后，会给这个Django项目新建一个虚拟的python环境。然后，python会在这个虚拟环境中下载Django。与此同时，python还为我们生成了两个文件： <code>Pipfile</code> 和 <code>Pipfile.lock</code>, 这两个文件存放着一些关于虚拟环境的信息：<code>Pipfile</code>如下，我们可以看到虚拟环境的python版本以及已经安装的package，这里暂且只有django 。其中<code>django = &quot;*&quot;</code> 代表可以兼容Django之前的版本。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[[source]]</span><br><span class="line">url &#x3D; &quot;https:&#x2F;&#x2F;pypi.org&#x2F;simple&quot;</span><br><span class="line">verify_ssl &#x3D; true</span><br><span class="line">name &#x3D; &quot;pypi&quot;</span><br><span class="line"></span><br><span class="line">[packages]</span><br><span class="line">django &#x3D; &quot;*&quot;</span><br><span class="line"></span><br><span class="line">[dev-packages]</span><br><span class="line"></span><br><span class="line">[requires]</span><br><span class="line">python_version &#x3D; &quot;3.8&quot;</span><br></pre></td></tr></table></figure>
<p>接下来用<code>pipenv shell</code>来启动虚拟环境，并用<code>django-admin startproject storefront .</code> 来新建一个名叫<code>storefront</code> 的Django项目(之所以这里要加一个 <code>.</code> 是因为要把当前文件夹作为根目录，否则目录层级太多了，管理起来不方便)。创建好后如下图所示</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/2.png" style="zoom:67%;"></p>
<blockquote>
<p>在 <code>frontstore</code>子文件夹中有这些文件：</p>
<p><code>__init__.py</code> 是用来定义的</p>
<p><code>asgi.py,wsgi.py</code> 是用来发布项目的</p>
<p><code>setting.py</code> 是Django 项目的配置文件。如果你想知道这个文件是如何工作的，请查看<a href="https://docs.djangoproject.com/zh-hans/2.1/topics/settings/" target="_blank" rel="noopener">https://docs.djangoproject.com/zh-hans/2.1/topics/settings/</a></p>
<p><code>urls.py</code> 是用来保存路由网址的</p>
<p>在根目录下还有 <code>manage.py</code> ，是一个让你用各种方式管理 Django 项目的命令行工具。 </p>
</blockquote>
<p>现在如果我们直接运行 <code>django-admin runserver</code> 是不能启动这个Django项目的，会告诉我们还没有配置好。因此我们需要先运行：<code>python manage.py runserver 9000</code></p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/4.png" style="zoom:67%;"></p>
<p>打开<code>http://127.0.0.1:9000/</code> 可以看到如下页面：</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/3.png" style="zoom:67%;"></p>
<p>要在vscode中打开Terminal并使用python环境，首先可以通过快捷键<code>shift+command+p</code>打开配置栏并修改<code>python interpreter</code>为我们刚刚创建的虚拟环境。然后再通过 <strong>ctrl+` </strong> 或者  <strong>view&gt;terminal</strong>打开终端。</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/5.png" style="zoom:67%;"></p>
<h3 id="Creating-Your-First-App"><a href="#Creating-Your-First-App" class="headerlink" title="Creating Your First App"></a>Creating Your First App</h3><p>Django可以看成是一些组件的集合，其中每个组件负责不同的功能。在 <code>settings.py</code> 中，我们可以看到Django中已经默认安装的APP，我们也可以写自己的APP</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Application definition</span></span><br><span class="line"></span><br><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">'django.contrib.admin'</span>,</span><br><span class="line">    <span class="string">'django.contrib.auth'</span>,</span><br><span class="line">    <span class="string">'django.contrib.contenttypes'</span>,</span><br><span class="line">    <span class="string">'django.contrib.sessions'</span>,</span><br><span class="line">    <span class="string">'django.contrib.messages'</span>,</span><br><span class="line">    <span class="string">'django.contrib.staticfiles'</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>创建的语句如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py startapp playground</span><br></pre></td></tr></table></figure>
<p>也就是创建一个名为 playground 的APP，结构如下</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/6.png" style="zoom:67%;"></p>
<blockquote>
<p>migration     文件夹是用来生成数据表的</p>
<p>admin.py      是用来写这个app的用户界面的</p>
<p>apps.py        是用来配置这个app的</p>
<p>models.py     是用来和“接收”数据库的信息的</p>
<p>tests.py        是用来单元测试的</p>
<p>views.py     视图，用来接受 Web 请求并且返回 Web 响应。</p>
</blockquote>
<p>创建完之后，我们需要在 <code>setting.py</code> 中加入这个APP</p>
<h3 id="Writing-Views"><a href="#Writing-Views" class="headerlink" title="Writing Views"></a>Writing Views</h3><p>View相当于一个句柄，收到了来自web前端发来的请求之后就返回一个Response。我们可以在里面写视图函数，视图函数的名字是任意的，比如下面这个 <code>say_hello</code>函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="comment"># Create your views here.</span></span><br><span class="line"><span class="comment"># request -&gt; response</span></span><br><span class="line"><span class="comment"># request handler</span></span><br><span class="line"><span class="comment"># action</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hello</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">'Hello World'</span>)</span><br></pre></td></tr></table></figure>
<p>因此Django中的view用视图去理解是非常抽象的，我们将其理解为句柄即可。</p>
<p>这个意思是说，当解析得到了<code>playground/</code> 之后，交给<code>playground.urls</code>这个文件去处理/后面的内容。</p>
<p>写好了 视图，现在就要通过网页来访问后台了，于是我们要把urls注册进去。我们的目标是希望请求 <code>http://localhost:9000/playground/hello/</code>  时在前端显示 Hello World。</p>
<p>Django中的url是可以分层级注册的。比如说我在<code>frontstore</code>这个主应用文件夹下的<code>urls.py</code>中注册第一层的url :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">'admin/'</span>, admin.site.urls),</span><br><span class="line">    path(<span class="string">'playground/'</span>, include(<span class="string">'playground.urls'</span>))</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>现在我们编写<code>playground</code>中的<code>urls.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">'hello/'</span>, views.say_hello),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>这是第二层的url了，由于一开始<code>playground</code>交给上层解析掉了，现在我们只需要负责解析<code>hello/</code>即可。</p>
<blockquote>
<p>注意要点：</p>
<ul>
<li>url的每一部分必须以<code>/</code>为结尾</li>
<li>注意path的用法，调用函数的时候(如say_hello)不需要加双引号</li>
<li>注意include的用法，在调用文件的时候需要用双引号。</li>
</ul>
</blockquote>
<h3 id="Using-Templates"><a href="#Using-Templates" class="headerlink" title="Using Templates"></a>Using Templates</h3><p>Template字面意义是模板，在Django系统中，后端生成的数据会套用在模板中，然后发给前端。比如说：</p>
<p><code>views.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hello</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'hello.html'</span>)</span><br></pre></td></tr></table></figure>
<p><code>hello.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello World<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在这个很简单的例子中，当handler收到request之后，会调用渲染器<code>render()</code>将这个<code>HttpRequest</code> 放到<code>hello.html</code>这个模板中去处理。这里无论收到什么请求都会返回 <code>Hello World</code></p>
<h4 id="传入dictionary"><a href="#传入dictionary" class="headerlink" title="传入dictionary"></a>传入dictionary</h4><p>在使用 render函数时，还可像函数一样传入想要的参数，也可以写一些简单的逻辑，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def say_hello(request):</span><br><span class="line">    return render(request,&#39;hello.html&#39;,&#123;&#39;name&#39;:&#39;Jason&#39;&#125;)</span><br></pre></td></tr></table></figure>
<p>这里我传入了一个 <code>name</code>参数，<code>name</code>的值为<code>Jason</code>,那么在 <code>hello.html</code>中我就可以这样修改：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if name %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello &#123;&#123; name &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">&#123;% else %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello World<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码的逻辑是，如果传入的参数中有 name，那么就做一个渲染，否则直接传回<code>Hello World</code></p>
<blockquote>
<p>小细节</p>
<ul>
<li>结尾要写 endif 注意是连起来的</li>
<li>引用参数的时候要注意使用两对大括号</li>
</ul>
</blockquote>
<p>其实，现在Template的应用场景已经比较少了，现在流行的模式都是后端返回数据，前端渲染网页，而使用template的话就等于在后端就渲染好网页然后传给前端了。</p>
<h3 id="Debugging-Django-Applications-in-VSCode"><a href="#Debugging-Django-Applications-in-VSCode" class="headerlink" title="Debugging Django Applications in VSCode"></a>Debugging Django Applications in VSCode</h3><p>现在我们来讲讲如何调试Django项目，这里介绍两种方法：在VSCode中调试和使用Debug Toolbar进行调试。首先讲讲VSCode。</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/8.png" style="zoom:67%;"></p>
<p>首先点击右边的debug按钮，然后新建一个针对python&gt;Django的 <code>launch.json</code>文件，内容如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Use IntelliSense to learn about possible attributes.</span></span><br><span class="line">    <span class="comment">// Hover to view descriptions of existing attributes.</span></span><br><span class="line">    <span class="comment">// For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387</span></span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"0.2.0"</span>,</span><br><span class="line">    <span class="attr">"configurations"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"Python: Django"</span>,</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"python"</span>,</span><br><span class="line">            <span class="attr">"request"</span>: <span class="string">"launch"</span>,</span><br><span class="line">            <span class="attr">"program"</span>: <span class="string">"$&#123;workspaceFolder&#125;/manage.py"</span>,</span><br><span class="line">          <span class="comment">// 传入两个参数，启动参数和调试端口</span></span><br><span class="line">            <span class="attr">"args"</span>: [</span><br><span class="line">                <span class="string">"runserver"</span>，</span><br><span class="line">              	<span class="string">"9876"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"django"</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们就在调试界面点击 Run 即可正常调试, 设间断点然后一步一步运行</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/9.png" style="zoom:67%;"></p>
<p>这边有几个符号，从左到右依次是：</p>
<ol>
<li>continue 2.Step over 3. Step into 4. Step out 5. Disconnect </li>
</ol>
<blockquote>
<p>注意点</p>
<ul>
<li><p>调试端口要和运行着程序的端口错开 </p>
</li>
<li><p>每次调试结束后，要删除间断点</p>
</li>
</ul>
</blockquote>
<h3 id="Using-Django-Debug-Toolbar"><a href="#Using-Django-Debug-Toolbar" class="headerlink" title="Using Django Debug Toolbar"></a>Using Django Debug Toolbar</h3><p>Django Debug Toolbar 是一个package，我们需要下载一下：教程在这里</p>
<p><a href="https://django-debug-toolbar.readthedocs.io/en/latest/installation.html" target="_blank" rel="noopener">https://django-debug-toolbar.readthedocs.io/en/latest/installation.html</a></p>
<blockquote>
<p>注意了，因为我们用的是虚拟环境，因此下载的时候需要用 <code>pipenv install django-debug-toolbar</code> 其余步骤和教程一致</p>
</blockquote>
<p>和VSCode不同，使用 toolbar 作为调试工具，需要传回一个HTML页面，因此我们需要对<code>hello.html</code>进行修改。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        &#123;% if name %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello &#123;&#123; name &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        &#123;% else %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello World<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        &#123;% endif %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>结果如下，还是比较炫酷的。</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/7.png" style="zoom:67%;"></p>
<h2 id="Build-a-Data-Model"><a href="#Build-a-Data-Model" class="headerlink" title="Build a Data Model"></a>Build a Data Model</h2><p>在Django这种后端框架中，是通过Model类来操作数据库的，程序员不需要关注SQL语句和数据库的类型(无论数据库是MySql、Sqlite，还是其它类型)，Django自动生成相应数据库类型的SQL语句，来完成对数据库数据的操作。</p>
<h3 id="Introduction-to-Data-Modeling"><a href="#Introduction-to-Data-Modeling" class="headerlink" title="Introduction to Data Modeling"></a>Introduction to Data Modeling</h3><p>进行Django开发的第一步是弄明白，我们要存储那些数据，这些数据之间有什么关系。比如说，商城中最重要的就是产品(Product)的信息：一个产品可以有名称、描述、价格、库存等信息。此外，不同的商品会分为不同的类型，因此我们还需要一个 类别(Collection)，这个类别也有自己的名称。</p>
<p>那么产品和类别之间是否有联系呢？ 肯定是有的。我们希望点击一个类别可以获取到其下面所有的产品，那么这是一个 <code>1对多</code> 的关系。如下图所示：</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/10.png" style="zoom:67%;"></p>
<p>数据与数据的关系还有<code>1对1</code>、<code>多对多</code></p>
<blockquote>
<p>注意点：</p>
<p>我们不需要考虑ID信息，Django会自动为我们生成。</p>
<p>要根据需求出发确定关系，不要天马行空</p>
</blockquote>
<h3 id="Building-an-E-commerce-Data-Model"><a href="#Building-an-E-commerce-Data-Model" class="headerlink" title="Building an E-commerce Data Model"></a>Building an E-commerce Data Model</h3><p>现在我们再来说几个数据模型：</p>
<p>比如说商品和购物车之间的关系</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/11.png" style="zoom:67%;"></p>
<p>还要客户、订单和商品之间的关系</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/12.png" style="zoom:67%;"></p>
<p>商品和标签之间的关系</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/13.png" style="zoom:67%;"></p>
<p>此外还有这样的关系：</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/18.png" style="zoom:67%;"></p>
<p><code>0..1</code> 表示一个集合中一个对象可以对应另一个集合中的0个或者1个对象</p>
<p>此外，还有：</p>
<p><code>0..*</code>表示一个集合中的一个对象对应另一个集合中的0个或多个对象。（ <strong>可以不对应</strong>）<br><code>1..*</code>表示一个集合中的一个对象对应另一个集合中的一个或多个对象。（ <strong>至少对应一个</strong>）</p>
<h3 id="Organizing-Models-in-Apps"><a href="#Organizing-Models-in-Apps" class="headerlink" title="Organizing Models in Apps"></a>Organizing Models in Apps</h3><p>之前我们说了Django是多个APP的合集，每个APP有属于自己的Data Model. 因此我们现在来看看怎么在APP中管理Data Model。</p>
<p>这里提供了三种模式，我们一次分析其利弊：</p>
<p>第一种就是把所有的字段都集成在一个 Model中，这样能让model迁移时更加方便，但是随着项目的扩大，会难以管理，如下图所示：</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/15.png" style="zoom: 50%;"></p>
<p>另一种就是交给不同的Model来管理，这种做法更加不可取，你可能认为这样很方便，但事实上这些字段之间是相互联系的，这样分开反而会导致耦合度、代码量大大提升：</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/14.png" style="zoom:67%;"></p>
<p>最后一种是最优解，也就是让不同的Model “各司其职”，只管好自己的事情。比如说Store中就没必要把<code>Tag,TaggedItem</code>加进来，因为这两个字段在其他场景下也可以使用，比如说社交网站上，朋友圈上都可以用；因此可以将其分开。</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/16.png" style="zoom: 33%;"></p>
<blockquote>
<p>归化数据模型的两个准则</p>
<ol>
<li>使得model之间的耦合度最小</li>
<li>使得每个model的内部凝聚性尽可能高</li>
</ol>
</blockquote>
<p>上面规划了两个Data Model，那么我们就创建两个APP来装下它们。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python manage.py startapp store </span><br><span class="line">python manage.py startapp tags</span><br></pre></td></tr></table></figure>
<p>创建完之后，别忘了在<code>settings.py</code>中添加这两个app</p>
<h3 id="Creating-Models"><a href="#Creating-Models" class="headerlink" title="Creating Models"></a>Creating Models</h3><p>理清楚各个App之间的关系之后，现在我们开始编写 APP 文件夹中的 <code>models.py</code>  </p>
<p>对于 <code>store</code>文件夹下的<code>models.py</code> ,之前我们说一个Store需包含商品、顾客、购物车、订单等元素，现在我们来一一实现。</p>
<p>首先我们创建一个 Product类，用来存放关于产品的相关信息，我们需要Model Field来Cover住这些信息，关于每个field都有这些通用的options参数可以写。</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/17.png" style="zoom: 50%;"></p>
<p>更多的Field我们可以参考Django的文档：</p>
<p><a href="https://docs.djangoproject.com/en/3.2/ref/models/fields/" target="_blank" rel="noopener">https://docs.djangoproject.com/en/3.2/ref/models/fields/</a></p>
<p>Class 格式如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">255</span>) </span><br><span class="line">    description = models.TextField()</span><br><span class="line">    price = models.                                             (max_digits=<span class="number">6</span>,decimal_places=<span class="number">2</span>)</span><br><span class="line">    inventory = models.IntegerField()</span><br><span class="line">    last_update = models.DateTimeField(auto_now=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>首先最重要的是商品的名称，我们用<code>CharField</code> 来cover它，选择用CharField 的好处是可以限定最长的字符串，这里我设置为255</p>
<p>其次是商品的描述，因为可能会很长，因此我们用<code>TextField()</code>来Cover，这是不限字数的</p>
<p>再来是商品的价格，因为价格包含整数和小数，这里使用<code>DecimalField</code>来Cover，需要设定最大长度和小数点后几位，比如说这个商场里最高价格只能标注为9999.99,那么就要设置<code>max_digits=6,decimal_places=2</code></p>
<p>在后面是商品的库存，因为不可能有半件商品，所以这里用<code>IntegerField()</code>来Cover就可以了。</p>
<p>最后是最后更新时间了，Django中提供了专门适用的时间格式 <code>DateTimeField(auto_now=True)</code> </p>
</blockquote>
<p>同样的我们依葫芦画瓢可以写出 Customer Class:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Customer</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    first_name = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    last_name = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    email  = models.EmailField(unique=<span class="literal">True</span>)</span><br><span class="line">    phone = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    birth_date = models.DateField(null=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里要注意的是，每个客户的email都必须是独一无二的，因此在填写EmailField的时候要写 <code>unique=True</code></p>
<p>此外，在一开始创建客户的birth_date 的时候，是空白的(可以理解为客户可以自己完善信息)，因此要写 <code>null=True</code></p>
</blockquote>
<h3 id="Choice-Fields"><a href="#Choice-Fields" class="headerlink" title="Choice Fields"></a>Choice Fields</h3><p>设想有一个字段，他代表了你会员的等级，有金银铜三个等级，那么我们该如何创建字段，这时候就可以用 choice Fields来实现：</p>
<p>在Django文档中，给了我们这样一个示例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">YEAR_IN_SCHOOL_CHOICES = [</span><br><span class="line">    (<span class="string">'FR'</span>, <span class="string">'Freshman'</span>),</span><br><span class="line">    (<span class="string">'SO'</span>, <span class="string">'Sophomore'</span>),</span><br><span class="line">    (<span class="string">'JR'</span>, <span class="string">'Junior'</span>),</span><br><span class="line">    (<span class="string">'SR'</span>, <span class="string">'Senior'</span>),</span><br><span class="line">    (<span class="string">'GR'</span>, <span class="string">'Graduate'</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>这是一个 Choice Field, 表现形式是一个元组列表，每个元组中，前者是存放在数据库当中的信息，后者是易于用户理解的信息。按照这个形式，我们可以写出会员等级，如下：</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Customer</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    MEMBERSHIP_BRONZE = <span class="string">'B'</span></span><br><span class="line">    MEMBERSHIP_SILVER = <span class="string">'S'</span></span><br><span class="line">    MEMBERSHIP_GOLD = <span class="string">'G'</span></span><br><span class="line">    MEMBERSHIP_CHOICES = [</span><br><span class="line">        (MEMBERSHIP_BRONZE,<span class="string">'Bronze'</span>),</span><br><span class="line">        (MEMBERSHIP_SILVER,<span class="string">'Silver'</span>),</span><br><span class="line">        (MEMBERSHIP_GOLD,<span class="string">'Gold'</span>),</span><br><span class="line">    ]</span><br><span class="line">    membership = models.CharField(max_length=<span class="number">1</span>, choices=MEMBERSHIP_CHOICES, default=MEMBERSHIP_BRONZE)</span><br><span class="line">    <span class="comment">#....</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>那么这里我们为什么又要将 存放在数据库当中的字段单独赋值呢？</p>
<p>这是为了降低耦合度，如果未来’B’ 替换成别的字，按照之前的方法，就需要修改两个地方，不方便管理，现在就变得很清楚明了了。</p>
</blockquote>
<p>同样的，我们可以对 Order类中的 payment_status字段设置为 Choice Field</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Order</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    PAYMENT_PENDING = <span class="string">'P'</span></span><br><span class="line">    PAYMENT_COMPLETE = <span class="string">'C'</span></span><br><span class="line">    PAYMENT_FAILD = <span class="string">'F'</span></span><br><span class="line">    PAYMENT_CHOICES= [</span><br><span class="line">        (PAYMENT_PENDING,<span class="string">'Pending'</span>),</span><br><span class="line">        (PAYMENT_COMPLETE,<span class="string">'Complete'</span>),</span><br><span class="line">        (PAYMENT_FAILD,<span class="string">'Faild'</span>)</span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    place_at = models.DateTimeField(auto_now_add=<span class="literal">True</span>)</span><br><span class="line">    payment_status =  models.CharField(max_length=<span class="number">1</span>,choices=PAYMENT_CHOICES,default = PAYMENT_PENDING)</span><br></pre></td></tr></table></figure>
<h3 id="Defining-One-to-one-Relationships"><a href="#Defining-One-to-one-Relationships" class="headerlink" title="Defining One-to-one Relationships"></a>Defining One-to-one Relationships</h3><p>现在我们将两个class之间建立一对一的联系。首先要明白哪个是Parent，哪个是Child，比如说我要在Customer和Address 之间建立联系，那么显然Customer是Parent，Address 是Child.</p>
<blockquote>
<p>需要在child model 中联系 parent model，如下：</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Address</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    street = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    city = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    customer = models.OneToOneField(Customer,on_delete=models.CASCADE)</span><br></pre></td></tr></table></figure>
<p><code>OneToOneField</code> 的第一个参数是 parent model 的类型，这里是<code>Customer</code> , 第二个参数比较有意思，是说当 parent model 中的一条信息删除时，对应的child model的操作。</p>
<blockquote>
<p>CASCADE  代表这条对应的信息也一并删除</p>
<p>SET_NULL 代表这条对应的信息中的字段(这里是street和city)将被置为 NULL</p>
<p>SET_DEFAULT 顾名思义就是当信息删除时，字段恢复默认值</p>
<p>PROTECT 是一种保护机制，即必须先删除 child 再删除 parent</p>
</blockquote>
<p>此外我们还需要设置 <code>primary_key = True</code>,也就是将Address设置为主键，也就是客户必须要设置这个参数，且具有唯一性，我们可以用主键来定位一条信息。</p>
<blockquote>
<p>为什么要在这里设其为主键，因为只有这样才能保证 One to One 关系，否则django会默认生成一个ID字段并设其为主键，这样会导致多个Address 对应一个 Customer</p>
</blockquote>
<h3 id="Defining-a-One-to-many-Relationship"><a href="#Defining-a-One-to-many-Relationship" class="headerlink" title="Defining a One-to-many Relationship"></a>Defining a One-to-many Relationship</h3><p>刚才说的一个用户对应一个地址显然是不符合现实的，因此现在我们在它们之间定义 一对多关系。</p>
<p>语法： <code>bid = models.ForeignKey(&quot;要关联的模型类名称&quot;)</code> ，<strong>子关联父</strong></p>
<p>方法很简单，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Address</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    street = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    city = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    customer = models.ForeignKey(Customer,on_delete=models.CASCADE)</span><br></pre></td></tr></table></figure>
<p>这里我们就要引入主键和外键的关系和区别了。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th>主键</th>
<th>外键</th>
<th><strong>索引</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>定义：</td>
<td>唯一标识一条记录，不能有重复的，不允许为空</td>
<td>表的外键是另一表的主键, 外键可以有重复的, 可以是空值</td>
<td>该字段没有重复值，但可以有一个空值</td>
</tr>
<tr>
<td>作用：</td>
<td>用来保证数据完整性</td>
<td>用来和其他表建立联系用的</td>
<td>是提高查询排序的速度</td>
</tr>
<tr>
<td>个数：</td>
<td>主键只能有一个</td>
<td>一个表可以有多个外键</td>
<td>一个表可以有多个唯一索引</td>
</tr>
</tbody>
</table>
</div>
<p>Address是Customer的外键，说明一个Customer可以有多个Address. 定义了一个外键字段，那么在该字段生成数据表之后会变为这样的形式： <code>外键字段名_id</code>， 比如这里就会变成 <code>customer_id</code>, 如果多个Address关联到一个Customer，那么它们的<code>customer_id</code> 是一样的。</p>
<p>新加入的如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Collection</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">		<span class="comment">#...</span></span><br><span class="line">    collection = models.ForeignKey(Collection,on_delete=models.PROTECT)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Customer</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="comment">#...</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Order</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="comment">#...</span></span><br><span class="line">    customer = models.ForeignKey(Customer,on_delete=models.PROTECT)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderItem</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    order = models.ForeignKey(Order,on_delete=models.PROTECT)</span><br><span class="line">    product =  models.ForeignKey(Product,on_delete=models.PROTECT)</span><br><span class="line">    quantity = models.PositiveSmallIntegerField()</span><br><span class="line">    unit_price = models.DecimalField(max_digits=<span class="number">6</span>,decimal_places=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Address</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    street = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    city = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    customer = models.ForeignKey(Customer,on_delete=models.CASCADE)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cart</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    created_at = models.DateTimeField(auto_now_add=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CartItem</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    cart = models.ForeignKey(Cart,on_delete=models.CASCADE)</span><br><span class="line">    product = models.ForeignKey(Product,on_delete=models.CASCADE)</span><br><span class="line">    quantity = models.PositiveSmallIntegerField()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里要注意，有些 <code>on_delete</code>属性我们选择的是PROTECT，为什么呢？</p>
<p>比如说 Order和Customer 之间的关系，我们希望Customer被删除后，还能保留其之前下的订单(完以数据分析有用)</p>
<p>而有些关系比如说 Cart 和CartItem 之间，删除了购物车之后，想必不需要留下购物车中的物品了。</p>
</blockquote>
<h3 id="Defining-Many-to-many-Relationships"><a href="#Defining-Many-to-many-Relationships" class="headerlink" title="Defining Many-to-many Relationships"></a>Defining Many-to-many Relationships</h3><p>现在我们来定义多对多关系, 比如说商场里面商品和促销活动之间的关系。一个商品可以同时参加多个促销活动，同时一个促销活动也可以涵盖多个商品</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Promotion</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    description = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    discount = models.FloatField()</span><br><span class="line">    <span class="comment"># product_set</span></span><br><span class="line">     </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    promotion = models.ManyToManyField(Promotion)</span><br></pre></td></tr></table></figure>
<p>这里我们在 Product 类中建立与 promotion 的多对多关系</p>
<h3 id="Resolving-Circular-Relationships"><a href="#Resolving-Circular-Relationships" class="headerlink" title="Resolving Circular Relationships"></a>Resolving Circular Relationships</h3><p>在 Store 中我们还会碰到这种问题：两个 model 是互相依赖的, 构建出了一个环形的关系(Circular Relationships) 如下所示：</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/18.png" style="zoom:67%;"></p>
<ul>
<li>一个 Collection 中可以有多个 Product，这代表 Product 依赖于 Collection</li>
<li>同时，特定的Product可以作为Collection的封面、代表 之类的，这说明Collection 反过来在依赖Product</li>
</ul>
<p>在 python 中，我若把 Collection 放在 Product 之前，会识别不出 Product，如下：</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/19.png" style="zoom:67%;"></p>
<p>为了解决这个问题，需要用引号将 Product 引起来,但这也是不够的，会报这样的错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Reverse query name for &#39;store.Collection.featured_product&#39; clashes with field name &#39;store.Product.collection&#39;.</span><br><span class="line">HINT: Rename field &#39;store.Product.collection&#39;, or add&#x2F;change a related_name argument to the definition for field &#39;store.Collection.featured_product&#39;.</span><br></pre></td></tr></table></figure>
<p>这是因为在 <code>Collection</code> 中有一个字段叫 <code>featured_product</code> ，Django 会自动生成 Reverse Relationship ，也就是反向查找在 models.py 中是否有 <code>Product</code> 的类，如果有就会和其建立反向联系。但是现在的情况是 ，Product 中已经有一个名叫<code>collection</code> 的字段了，因此出现了名字上的冲突。</p>
<p>因此需要用到 <code>ForeignKey.related_name</code> 这个属性。<br>我不想让Django创建一个反向关联，因此我将其设为<code>+</code> 即可。这样一来， Collection可以找到Product，但又不会和Product创建反向关联，因此可以实现环形关系。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Collection</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    featured_product = models.ForeignKey(<span class="string">'Product'</span>,on_delete=SET_NULL,null=<span class="literal">True</span> , related_name=<span class="string">'+'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Generic-Relationships"><a href="#Generic-Relationships" class="headerlink" title="Generic Relationships"></a>Generic Relationships</h3><p>之前我们说了对于 Tag、Likes 这样的 model，我们是希望其能在不同的情况下使用的， 比如说对于Like，允许用户在文章评论视频下方点赞，Tag可以再不同的场所打上标签。</p>
<p>那么对于这么多要点赞的类型，都需要创建1对多的关系，很显然代码量以及管理起来都比较繁琐。虽然Likes这个类是一对多关系里的“多”这一侧，但实际上他的模型字段也是广义上的“一”，因为他的外键字段和所连接的模型都是“一对一”建立连接的。</p>
<p>Django里面的ContentType其实就是起到一个自动一对多的作用，和任何模型都能连接起来，保证了代码的干净。</p>
<p>现在我们再来了解一下 <code>GenericForeignKey</code>, 普通的Foreignkey，只能“指向”单一的模型，而ContentType则可以允许和任意的模型进行连接，非常灵活。设立这种外键，你需要3个字段</p>
<blockquote>
<p>1：设定一个普通外键，连接于ContentType，一般名字叫“content_type”。<br> 这个字段实际上是代码你在Likes这个点赞里面，是给哪个对应的模型在点赞，是文章/评论/视频，或是其他。</p>
<p>2：设立一个PostiveIntegerField的字段，一般名字叫做“object_id”。<br> 以记录所对应的模型的实例的id号，比如我们给一篇文章点赞，这篇文章是Post类里的id为10的文章，那么这个object_id就是这个10。<br> 其实看到这里，应该清楚了，当你有了模型的名字，也告诉了你这个模型的实例的id号，你就可以找出这个实例了。</p>
<p>3：第三个也是最后一个，就是设定这个GenericForeignkey外键了，这个外键需要传入两个参数，就是上面的1和2，如果你为上面2个字段取的名字就是content_type和object_id的话，你可以不需要输入，因为这个字段默认会读取这2个名字。如果你自定义过了，那就需要你手动添加。</p>
</blockquote>
<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><p>回头我们所需要的应用场景上来，我创建了一个 tags 模型，里面设计两个 Class， Tag 和 TaggedItem ，前者可以看做是标签的实例，后者则是一个广泛的标签概念，可以打在不同的物品类型上面</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tag</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    label = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaggedItem</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    tag = models.ForeignKey(Tag,on_delete= models.CASCADE)</span><br><span class="line">    content_type = models.ForeignKey(ContentType,on_delete= models.CASCADE)</span><br><span class="line">    object_id = models.PositiveIntegerField()</span><br><span class="line">    content_object = GenericForeignKey()</span><br></pre></td></tr></table></figure>
<p>同样的，我们可以创建 <code>LikedItem</code> 类，用来给不同类型的物品点赞：其中，user就是用来定义是谁点的赞。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> django.contrib.contenttypes.models <span class="keyword">import</span> ContentType</span><br><span class="line"><span class="keyword">from</span> django.contrib.contenttypes.fields <span class="keyword">import</span> GenericForeignKey</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LikedItem</span> <span class="params">(models.Model)</span>:</span></span><br><span class="line">    user = models.ForeignKey(User,on_delete=models.CASCADE)</span><br><span class="line">    content_type = models.ForeignKey(ContentType,on_delete=models.CASCADE)</span><br><span class="line">    object_id = models.PositiveIntegerField()</span><br><span class="line">    content_object = GenericForeignKey()</span><br></pre></td></tr></table></figure>
<h2 id="Setting-Up-the-Database"><a href="#Setting-Up-the-Database" class="headerlink" title="Setting Up the Database"></a>Setting Up the Database</h2><p>我们首先来了解一下 SQLite,然后会使用Mysql数据库</p>
<h3 id="Creating-Migrations"><a href="#Creating-Migrations" class="headerlink" title="Creating Migrations"></a>Creating Migrations</h3><p>在Django项目中，我们并不会手动来创建数据库，Django会自动帮我们生成。</p>
<p>运行：<code>python manage.py makemigrations</code>  可以生成很多迁移文件：</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/20.png" style="zoom:67%;"></p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/21.png" style="zoom:67%;"></p>
<h4 id="更新与修改"><a href="#更新与修改" class="headerlink" title="更新与修改"></a>更新与修改</h4><p>如果我们要更新 migration文件，只需要修改完model 然后重新运行<code>python manage.py makemigrations</code>即可.比如说我要修改 class Product中的price字段，将其改名为unit_price, 然后运行。</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/22.png" style="zoom:67%;"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Generated by Django 3.2.5 on 2021-07-25 05:56</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> migrations</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Migration</span><span class="params">(migrations.Migration)</span>:</span></span><br><span class="line"></span><br><span class="line">    dependencies = [</span><br><span class="line">        (<span class="string">'store'</span>, <span class="string">'0001_initial'</span>),</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    operations = [</span><br><span class="line">        migrations.RenameField(</span><br><span class="line">            model_name=<span class="string">'product'</span>,</span><br><span class="line">            old_name=<span class="string">'price'</span>,</span><br><span class="line">            new_name=<span class="string">'unit_price'</span>,</span><br><span class="line">        ),</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>需要注意的是，我们在修改model的时候，之前一定要先将该app添加到<code>settings.py</code>当中去，否则Django是检测不出是否修改的。</p>
</blockquote>
<p>比如说现在我要给Product再添加一条字段：slug, slug可以帮助数据库更快的找到商品信息，比如说：<code>https://stackoverflow.com/questions/12099315/design-1-or-2-tables-for-a-1-to-0-1-relationship-with-sql-server</code>中的 <code>design-1-or-2-tables-for-a-1-to-0-1-relationship-with-sql-server</code> 就是这个页面的slug</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">slug = models.SlugField(default=<span class="string">'-'</span>)</span><br><span class="line"><span class="comment">#或者</span></span><br><span class="line">slug = models.SlugField(null=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意到，在0002号migration文件中，有一个dependencies列表，里面是0001号migration文件，说明后者是在前者的基础上进行修改的。因此，如果我们要重命名前面的 文件，就需要修改对应的dependeny</p>
</blockquote>
<h3 id="Running-Migrations"><a href="#Running-Migrations" class="headerlink" title="Running Migrations"></a>Running Migrations</h3><p>现在我们来运行上面创建的migration文件，用他们来生成数据表</p>
<p>运行： <code>python manage.py migrate</code> 即可</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/23.png" style="zoom:67%;"></p>
<p>我们发现Django是对所有的app中的migration文件进行迁移。</p>
<p>那么这些生成的数据表存放到哪里了呢？是存放到Django项目自带的sqllite数据库当中了。我们可以下载VSCode中的SQLite插件然后用这个插件打开数据库</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/24.png" style="zoom:67%;"></p>
<p>可以再导航栏的最下面发现SQLITE EXPLORER，里面就是生成的数据库。其中<code>django_migrations</code>数据表中就存放着每个app于其对应的migration的信息。</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/25.png" style="zoom:67%;"></p>
<p>如果我们要运行一个特定的migration文件，可以这样来写：</p>
<p><code>python manage.py sqlmigrate store 0003</code> Django就会运行至store app中的0003号文件，后面的文件不运行下去了</p>
<h4 id="小测试"><a href="#小测试" class="headerlink" title="小测试"></a>小测试</h4><blockquote>
<ol>
<li>Add zip to Address</li>
<li>Create a migration</li>
<li>Run it</li>
<li>Inspect the migrations table</li>
</ol>
</blockquote>
<h3 id="Customizing-Database-Schema"><a href="#Customizing-Database-Schema" class="headerlink" title="Customizing Database Schema"></a>Customizing Database Schema</h3><p>有些时候我们希望对数据标进行定制化，比如说修改索引，或者修改表名等. 为了实现这个效果，我们可以使用 元数据(Metadata)。</p>
<p>元数据可以用来描述一类事务，比如说对于人，我们可以从年龄、身高、相貌、性格来描述；对于数码图片，我们有作者、型号、光圈、曝光时间等。这都是元数据。</p>
<p>Django中我们也可以对Model 设置元数据：</p>
<p><a href="https://docs.djangoproject.com/en/3.2/ref/models/options/" target="_blank" rel="noopener">https://docs.djangoproject.com/en/3.2/ref/models/options/</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Customer</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    MEMBERSHIP_BRONZE = <span class="string">'B'</span></span><br><span class="line">    MEMBERSHIP_SILVER = <span class="string">'S'</span></span><br><span class="line">    MEMBERSHIP_GOLD = <span class="string">'G'</span></span><br><span class="line">    MEMBERSHIP_CHOICES = [</span><br><span class="line">        (MEMBERSHIP_BRONZE,<span class="string">'Bronze'</span>),</span><br><span class="line">        (MEMBERSHIP_SILVER,<span class="string">'Silver'</span>),</span><br><span class="line">        (MEMBERSHIP_GOLD,<span class="string">'Gold'</span>),</span><br><span class="line">    ]</span><br><span class="line">    first_name = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    last_name = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    email  = models.EmailField(unique=<span class="literal">True</span>)</span><br><span class="line">    phone = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    birth_date = models.DateField(null=<span class="literal">True</span>)</span><br><span class="line">    membership = models.CharField(max_length=<span class="number">1</span>, choices=MEMBERSHIP_CHOICES, default=MEMBERSHIP_BRONZE)</span><br><span class="line">    <span class="comment"># Metadata 要写在Model里面</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'store_customers'</span></span><br><span class="line">        indexes = [</span><br><span class="line">            models.Index(fields = [<span class="string">'last_name'</span>,<span class="string">'first_name'</span>])</span><br><span class="line">        ]</span><br></pre></td></tr></table></figure>
<p>这边我设置了两个元数据，一个是数据表的名字，另一个是数据表的索引，我改成了两个。</p>
<p>运行<code>python manage.py makemigration</code> 之后，因为修改了两个点，新生成的 migration文件命名为 auto </p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/26.png" style="zoom:67%;"></p>
<blockquote>
<p>Django能帮助我们快速创建一个APP因此对每个model都设置元数据是没有必要的</p>
<p>生成migration文件的时候，最好一次只修改一个地方，这样自动命名会比较直观 </p>
</blockquote>
<h3 id="Reverting-Migrations"><a href="#Reverting-Migrations" class="headerlink" title="Reverting Migrations"></a>Reverting Migrations</h3><p>假设我现在发现运行的Migration文件有错误，怎么回滚呢？</p>
<p>如果我们只想回退一步，那么只要在model中修改然后重新生成一个migration文件即可。 但假如一个migration里面有很多步骤，我想将其全部删除，又该怎么做呢？</p>
<p>上面我们讲到，用<code>python manage.py migrate XXXX</code> 可以精确运行到某一migration文件，因此我们如果要抹除0005，可以这么写：<code>python manage.py migrate store 0004</code>, 结果如下：</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/27.png" style="zoom:67%;"></p>
<p>但现在还是不行，因为0005文件仍然存在，若我再次运行<code>python manage.py migrate</code> ,还是会回到之前的版本，因此要删去这个文件以及在model中对应的代码。</p>
<p>虽然说这样也可行，但是最好的办法还是使用版本控制软件如 git，但是每次migrate之后注意commit </p>
<h3 id="Using-MySQL-in-Django"><a href="#Using-MySQL-in-Django" class="headerlink" title="Using MySQL in Django"></a>Using MySQL in Django</h3><p>要在Django框架下连接mysql，首先需要安装<code>pymysql</code> 和 <code>mysqlclient</code></p>
<p>然后在 <code>settings.py</code> 中修改 DATABASES 一项：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">        <span class="string">'NAME'</span>: <span class="string">'storefront'</span>,</span><br><span class="line">        <span class="string">'HOST'</span>:<span class="string">'localhost'</span>,</span><br><span class="line">        <span class="string">'USER'</span>:<span class="string">'root'</span>,</span><br><span class="line">        <span class="string">'PASSWORD'</span>:<span class="string">'你的数据库密码'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一开始我发现仅仅安装mysqlclient 的话，启动程序时会出错：<code>NameError: name ‘_mysql‘ is not defined</code></p>
<p>这是因为django一开始调用MYSQLdb，与python3.x起了冲突。解决办法是在配置文件目录下的<code>__init__.py</code>文件下加入以下代码来用pymysql替代MySQLdb：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line">pymysql.install_as_MySQLdb()</span><br></pre></td></tr></table></figure>
<p>Django现在已经成功连接Mysql了，现在在Mysql中创建frontstore的DATABASE，然后调用<code>python manage.py migrate</code> ，就可以将数据全部载入mysql了：</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/28.png" style="zoom: 50%;"></p>
<h3 id="Running-Custom-SQL"><a href="#Running-Custom-SQL" class="headerlink" title="Running Custom SQL"></a>Running Custom SQL</h3><p>有时我们想要自己运行一些SQL语句来修改数据库，怎么实现？</p>
<p>首先，运行 <code>python manage.py makemigrations store --empty</code> 创建一个属于store app的空的migration文件。</p>
<p>我们要写的就是operation里面的SQL 语句，格式是：<code>migration.RunSQL()</code> 我们需要写两段SQL语句，第一段是修改的，第二段则是删除修改的，如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">from</span> django.db <span class="keyword">import</span> migrations</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Migration</span><span class="params">(migrations.Migration)</span>:</span></span><br><span class="line"></span><br><span class="line">    dependencies = [</span><br><span class="line">        (<span class="string">'store'</span>, <span class="string">'0004_address_zip'</span>),</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    operations = [</span><br><span class="line">        migrations.RunSQL(<span class="string">"""</span></span><br><span class="line"><span class="string">            INSERT INTO store_collection (title)</span></span><br><span class="line"><span class="string">            VALUES ('collection1')</span></span><br><span class="line"><span class="string">        """</span>,<span class="string">"""</span></span><br><span class="line"><span class="string">            DELETE FROM store_collection</span></span><br><span class="line"><span class="string">            WHERE title = 'collection1'</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        )</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure>
<p>如果不写第二段SQL语句的话，当我们想回滚时会发生报错： <code>... is not reversible</code> ，因此为了便于维护，还是需要写一下的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">django.db.migrations.exceptions.IrreversibleError: </span><br><span class="line">Operation &lt;RunSQL &quot;INSERT INTO store_collection (title) VALUES (&#39;collection1&#39;)&quot;&gt;</span><br><span class="line">in store.0005_auto_20210731_0052 is not reversible</span><br></pre></td></tr></table></figure>
<h3 id="Generating-Dummy-Data"><a href="#Generating-Dummy-Data" class="headerlink" title="Generating Dummy Data"></a>Generating Dummy Data</h3><p>创建一些无意义的数据，便于我们接下来的程序开发</p>
<p><a href="https://mockaroo.com/" target="_blank" rel="noopener">https://mockaroo.com/</a> 我们需要用这个网站帮我们生成数据</p>
<p>详见我的一篇博客：</p>
<p><a href="https://jasonxqh.github.io/2020/06/26/PostgreSql基础/#Generate-1000-Rows-with-Mockaroo">1.0.11. Generate 1000 Rows with Mockaroo</a></p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/29.png" style="zoom: 50%;"></p>
<p>下载好SQL语句文件之后，拖到Datagrip中运行即可。</p>
<h2 id="Django-ORM"><a href="#Django-ORM" class="headerlink" title="Django ORM"></a>Django ORM</h2><h3 id="Django-ORM-1"><a href="#Django-ORM-1" class="headerlink" title="Django ORM"></a>Django ORM</h3><p>ORM (<strong>Object Relational Mapping</strong>) 也就是对相关系映射，用于实现面向对象编程语言里不同类型系统的数据之间的转换。通俗得说，就是当我们要用程序将数据库中的表格拉出进行操作室，需要用一个对象去接收它</p>
<p>使用Python的Django模型的话，一般都会用它自带的ORM（Object-relational mapping）模型。这个ORM模型的设计比较简单，学起来不会特别花时间。不过，Django的ORM模型有自己的一套语法，有时候会觉得别扭。 </p>
<p>其实，之前我们写的migration以及model文件，也是通过ORM来转换成sql语句的。但这也并不意味着我们不再需要了解SQL语句，当处理一些复杂问题时，还是需要我们自己写sql的.</p>
<h3 id="Managers-and-QuerySets"><a href="#Managers-and-QuerySets" class="headerlink" title="Managers and QuerySets"></a>Managers and QuerySets</h3><p>关于Django ORM首先我们要明白 manager和queryset的概念。</p>
<p>manager 可以理解为一个数据库的接口，它可以管理、调用数据库中的信息。比如说下面这段代码，首先从models 中引入Product类， <code>Product.objects</code> 就是一个manager，它可以实现很多功能。比如说<code>all()</code> 可以获取数据表中的所有行，<code>get()</code>可以获得一个单一的对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="keyword">from</span> store.models <span class="keyword">import</span> Product</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hello</span><span class="params">(request)</span>:</span></span><br><span class="line">    Product.objects.all()</span><br></pre></td></tr></table></figure>
<p>manager 返回的数据叫做 quertset,类似于 list，里面放的是一个个模型类的对象，可用索引下标取出模型类的对象。比如下面，可以通过切片来打印对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hello</span><span class="params">(request)</span>:</span></span><br><span class="line">    query_set = Product.objects.all()</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    print(query_set[<span class="number">0</span>:<span class="number">5</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'hello.html'</span>,&#123;<span class="string">'name'</span>:<span class="string">'Jason'</span>&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/30.png" style="zoom:67%;"></p>
<p>在 Django Toolbar中，我们也可以看到Django向数据库发送的SQL语句：</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/31.png" style="zoom:67%;"></p>
<p>此外还有<code>filter()</code> 用于查询符合条件的数据，<code>order_by()</code>用于对查询结果进行排序，<code>reverse()</code>用于对查询结果进行反转，<code>count()</code>用于对查询结果计数等操作，</p>
<p>详见：<a href="https://www.runoob.com/django/django-orm-1.html" target="_blank" rel="noopener">https://www.runoob.com/django/django-orm-1.html</a></p>
<h3 id="Retrieving-Objects"><a href="#Retrieving-Objects" class="headerlink" title="Retrieving Objects"></a>Retrieving Objects</h3><p>现在要说怎么检索对象。</p>
<ul>
<li>all</li>
</ul>
<p><code>all</code>方法是获得所有对象的方法，<code>queryset =  Product.objects.all()</code></p>
<ul>
<li>get</li>
</ul>
<p><code>get</code> 方法则是获得特定的一个对象的方法，里面的参数 <code>pk=?</code>便是对象的位置。比如：<code>product = Product.objects.get(pk=1)</code></p>
<p>注意，序号时从1开始算起的，所以如果写了 <code>pk=0</code>,Django会报错。为了解决这个问题，我们可以使用 <code>try-catch</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    product = Product.objects.get(pk=<span class="number">1</span>)</span><br><span class="line"><span class="keyword">except</span> ObjectDoesNotExist:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>但是在这么简单的语句中使用try-catch 有点不太美观，因此我们还可以这样写：</p>
<p><code>Product.objects.filter(pk=0).first()</code></p>
<p>首先<code>filter</code> 会进行筛选，如果条件是 <code>pk = 0</code>，那么筛选结果就是空，然后再返回<code>first()</code>, 结果就是 null，用这种方法也不会报错</p>
<ul>
<li>exists()</li>
</ul>
<p>如果想单纯判断某一个对象是否存在，可以使用<code>exists()</code></p>
<p>比如：<code>Product.objects.filter(pk=0).exists()</code></p>
<h3 id="Filtering-Objects"><a href="#Filtering-Objects" class="headerlink" title="Filtering Objects"></a>Filtering Objects</h3><p>在使用 <code>filter()</code> 时，需要传入一个 <code>key-value</code>值，因此如果我们想筛选单价大于20元的商品时，是不能输入 <code>filter(unit_price&gt;20)</code> 的</p>
<p>为了解决这个问题，Django有自己的一套语言:<a href="https://docs.djangoproject.com/en/3.2/ref/models/querysets/" target="_blank" rel="noopener">https://docs.djangoproject.com/en/3.2/ref/models/querysets/</a></p>
<p>要表达 <code>unit_price&gt;20</code> ，可以用<code>unit_price__gt=20</code> ，同样的，大于等于可以用<code>__gte</code>, 此外还有<code>lt</code>,<code>lte</code>等</p>
<p>要表达一个范围，可以用<code>__range()</code> 比如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hello</span><span class="params">(request)</span>:</span></span><br><span class="line">    query_set = Product.objects.filter(unit_price__range=(<span class="number">20</span>,<span class="number">30</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'hello.html'</span>,&#123;<span class="string">'name'</span>:<span class="string">'Jason'</span>,<span class="string">'products'</span>:list(query_set)&#125;)</span><br></pre></td></tr></table></figure>
<p>再通过html的修改，我们可以将筛选出的结果显示在网页上</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/32.png" style="zoom:67%;"></p>
<ul>
<li>找出包含某些特定字符的信息</li>
</ul>
<p>可以使用 contains， 比如：<code>title__icontains = &#39;coffee&#39;</code> 注意，默认是区分大小写的，如果要求不区分大小写，可以在contains前面加 <code>i</code>.</p>
<p>类似的还有 <code>__startswith</code>,<code>__endswith</code></p>
<ul>
<li>筛选日期</li>
</ul>
<p>有一个字段是 <code>last_update</code>，类型是日期，可以用<code>__year</code>来筛选特定的年份，同样还有<code>__month</code>,<code>__day</code></p>
<p>比如说`Product.objects.filter(last_update__year  = 2021) </p>
<ul>
<li>判断是否为空</li>
</ul>
<p><code>__isnull</code> 是用来判断是否为空的，比如<code>Products.objects.filter(description__isnull = True)</code> 就会筛选处description字段为空的信息</p>
<ul>
<li><h3 id="小练习"><a href="#小练习" class="headerlink" title="小练习"></a>小练习</h3></li>
<li><p>Customers with .com accounts </p>
</li>
</ul>
<p><code>query_set = Customer.objects.filter(email__icontains = &#39;.com&#39;)</code></p>
<ul>
<li>Collections that don’t have a featured product</li>
</ul>
<p><code>query_set = Collection.objects.filter(featured_product__isnull = True)</code></p>
<ul>
<li>Products with low inventory (less than 10)</li>
</ul>
<p><code>query_set = Product.objects.filter(inventory__lt= 10)</code> </p>
<ul>
<li>Orders placed by customer with id = 1</li>
</ul>
<p>这道题要我们选择id=1的顾客下的订单，首先要明白customer和order是由一对多关系的. 注意，这里需要使用两个下划线：<code>__</code></p>
<p><code>query_set = Order.objects.filter(customer__id= 1)</code></p>
<ul>
<li>Order items for products in collection 3</li>
</ul>
<p>这道题还是比较难的，转了两个弯，要门选择出orderitem这张表中，属于 collection 3的商品。首先，product是orderitem的外键，而collection又是product的外键所以要<code>product__collection__3</code></p>
<p><code>query_set = OrderItem.objects.filter(product__collection__id =3)</code></p>
<h3 id="Complex-Lookups-Using-Q-Objects"><a href="#Complex-Lookups-Using-Q-Objects" class="headerlink" title="Complex Lookups Using Q Objects"></a>Complex Lookups Using Q Objects</h3><p>如果我想多条件查询，又该怎么办？</p>
<ul>
<li>实现 AND</li>
</ul>
<p>其中一种是用逗号分割查询条件：</p>
<p><code>queryset = Product.objects.filter(inventory__lt = 10,unit_price__lt = 20)</code></p>
<p>此外还有一种链式的filter写法，比如说：</p>
<p><code>queryset = Product.objects.filter(inventory__lt = 10).filter(unit_price__lt = 20)</code></p>
<ul>
<li>实现 OR</li>
</ul>
<p>要实现或查询(Q也可以用于与查询)，那么需要使用Q object，首先要引入 <code>from django.db.models import Q</code></p>
<p>Q()对象就是为了将这些条件组合起来。当我们在查询的条件中需要组合条件时(例如两个条件“且”或者“或”)时。我们可以使用Q()查询对象。 比如说：</p>
<p><code>query_set = Product.objects.filter(Q(inventory__lt=10)| Q(unit_price__lt=20))</code></p>
<p>这时候，我们可以用<code>&amp;、|、~</code> 这些符号来筛选符合条件的数据了。</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/33.png" style="zoom:67%;"></p>
<h3 id="Referencing-Fields-using-F-Objects"><a href="#Referencing-Fields-using-F-Objects" class="headerlink" title="Referencing Fields using F Objects"></a>Referencing Fields using F Objects</h3><p>F对象主要用于模型类的 A 字段属性与 B 字段属性两者的比较，即操作数据库中某一列的值。通常是对数据库中的字段值在不获取的情况下进行操作。F 对象内置在数据包<code>django.db.models</code>中，所以使用时需要提前导入。如下所示：<code>from django.db.models import F</code></p>
<p>在使用F对象进行查询的时候需要注意：一个 F() 对象代表了一个 Model 的字段的值；F 对象可以在没有实际访问数据库获取数据值的情况下对字段的值进行引用。</p>
<p>比如说我要对单列的所有制进行操作，统统加上20，可以这么写：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> F</span><br><span class="line"><span class="keyword">from</span> index.models <span class="keyword">import</span> Book </span><br><span class="line"><span class="comment">#给Book所有实例价格（retail_price）涨价20元 </span></span><br><span class="line">Book.objects.all().update(retail_price=F(<span class="string">'retail_price'</span>)+<span class="number">20</span>) <span class="comment">#获取该列所有值并加20</span></span><br><span class="line"><span class="comment">#利用传统的方法实现涨价20元</span></span><br><span class="line">books = models.Book.objects.all() </span><br><span class="line"><span class="keyword">for</span> book <span class="keyword">in</span> books:     </span><br><span class="line">    book.update(retail_price=book.retail_price+<span class="number">20</span>)     </span><br><span class="line">    book.save()</span><br></pre></td></tr></table></figure>
<p>此外F对象还可以实现两个字段值(两列)之间的比较，比如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#对数据库中两个字段的值进行比较，列出哪儿些书的零售价高于定价 </span></span><br><span class="line">books = Book.objects.filter(retail_price__gt=F(<span class="string">'price'</span>)) </span><br><span class="line"><span class="keyword">for</span> book <span class="keyword">in</span> books: </span><br><span class="line">    print(book.title, <span class="string">'定价:'</span>, book.price, <span class="string">'现价:'</span>, book.retail_price)</span><br></pre></td></tr></table></figure>
<h3 id="Sorting"><a href="#Sorting" class="headerlink" title="Sorting"></a>Sorting</h3><ul>
<li>要对筛选出的结果进行排序，需要用到 <code>order_by</code> ，比如说：</li>
</ul>
<p><code>queryset = Product.objects.order_by(&#39;title&#39;)</code>  就会按照字母表顺序进行排列。来看看Django自动生成的SQL语句：</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/34.png" style="zoom:67%;"></p>
<ul>
<li><p>如果要倒排的话，只要在参数前面加一个 负号即可 <code>-</code> ，如：<code>queryset = Product.objects.order_by(&#39;-title&#39;)</code>  </p>
<ul>
<li>还有一种倒排的方法，就是在正常排序后加上<code>.reverse()</code>即可</li>
</ul>
</li>
<li><p>也可以设置多个排列参数，按照优先级在括号内依次传入多个参数即可。如：<code>queryset = Product.objects.order_by(&#39;unit_price&#39;,&#39;-title&#39;)</code>  </p>
</li>
</ul>
<blockquote>
<p>需要注意，<code>order_by()</code> 和<code>filter()</code>一样，返回的是一个 queryset，是可以被索引被迭代的</p>
<p>因此，我们可以用 <code>Product.objects.order_by(&#39;unit_price&#39;)[0]</code> 来获得第一个对象。其实，有一种更简单的方法，即<code>Product.objects.earliest(&#39;unit_price&#39;)</code> 也会返回单价最低的一个对象；当然，也有<code>latest()</code> 来获取单价最高的对象。</p>
</blockquote>
<h3 id="Limiting-Results"><a href="#Limiting-Results" class="headerlink" title="Limiting Results"></a>Limiting Results</h3><p>比如一个页面中最多显示5条信息，那么我们怎么对其进行限制呢？其实在python语法中这很简单：</p>
<p><code>queryset = Products.objects.all()[:5]</code> 是返回表中前五条信息</p>
<p><code>queryset = Products.objects.all()[5:10]</code> 是返回表中第6-10条信息</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/35.png" style="zoom:67%;"></p>
<h3 id="Selecting-Fields-to-Query"><a href="#Selecting-Fields-to-Query" class="headerlink" title="Selecting Fields to Query"></a>Selecting Fields to Query</h3><p>对于Product表格，我们想返回其title和description，那么用什么来选中特定的字段呢？<code>value()</code> ，这个方法会以字典的形式返回字段名和值。如下所示：</p>
<p><code>query_set = Product.objects.values(&#39;title&#39;,&#39;description&#39;)</code></p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/36.png" style="zoom:67%;"></p>
<p>此外，还可以显示关联表的字段，比如 collection是product 的外键，要筛选collection中的title字段可以这样写</p>
<p><code>query_set = Product.objects.values(&#39;title&#39;,&#39;collection__title&#39;)</code></p>
<p>sql语句如下：</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/37.png" style="zoom:67%;"></p>
<p>将html修改成打印整个product对象后，如下图所示</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/38.png" style="zoom:67%;"></p>
<p>如果我将<code>value()</code>换成<code>value_list()</code>，则会返回元组形式的对象，如下：</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/39.png" style="zoom:67%;"></p>
<blockquote>
<p>注意，value或者value list，会返回字段的值，只是表现的形式不同；</p>
<p>filter,order_by 则是对所有字段进行筛选并返回对象实例</p>
</blockquote>
<p>小测验：</p>
<ul>
<li>Select products  that have been ordered and sort them by title</li>
</ul>
<p>首先，订单中订购的产品都在 <code>OrderItem</code>表格中，里面的<code>product_id</code>就是订购的商品的编号。我们要将其筛选出来。订单可能有重复的商品，因此要用 <code>.distinct</code></p>
<p><code>OrderItem.objects.values(&#39;product__id&#39;).distinct()</code></p>
<p>然后，我们要用这些id找到product的名字：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Product.objects.filter(</span><br><span class="line">	 id__in = OrderItem.objects.values(<span class="string">'product__id'</span>).distinct()</span><br><span class="line">).order_by(<span class="string">'title'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Only-And-Defer"><a href="#Only-And-Defer" class="headerlink" title="Only() And Defer()"></a>Only() And Defer()</h3><p>那么有没有办法即返回对象，有能够对特定的列进行筛选呢？ 这种方法就是<code>only()</code></p>
<p>比如： <code>query_set = Product.objects.only(&#39;id&#39;,&#39;title&#39;)</code></p>
<p>特别要注意的是， 如果用到only在循环取值是最好是选择only中的列，否则将会再执行一次查询，效率很差 </p>
<p>比如我在 html中这么渲染：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">      &#123;% for product in products %&#125;</span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;&#123; product.title &#125;&#125; $&#123;&#123; product.unit_price&#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      &#123;% endfor %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>unit_price</code> 并没有在only中出现过，因此当要渲染<code></code>时，django会再次去mysql中查询，导致渲染一条信息就要多查一次，非常非常慢。</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/40.png" style="zoom:67%;"></p>
<blockquote>
<p>所以在渲染时一定要选中only中出现的列！</p>
</blockquote>
<p>和<code>only()</code>恰恰相反的是<code>defer()</code>， <code>defer()</code>中的字段名在sql查询时会被排除，只选择剩下的列。所以当我们在渲染时出现defer中的字段时，效率也会非常的差。</p>
<h3 id="Selecting-Related-Objects"><a href="#Selecting-Related-Objects" class="headerlink" title="Selecting Related Objects"></a>Selecting Related Objects</h3><p>有些时候我们不仅仅只引入一张表的内容，我们想要搜寻出与其相关的表的内容。 </p>
<p>比如说：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># view.py</span><br><span class="line">query_set &#x3D; Product.objects.all()</span><br><span class="line"></span><br><span class="line"># hello.html</span><br><span class="line">&#123;% for product in products %&#125;</span><br><span class="line">&lt;li&gt;&#123;&#123; product.title &#125;&#125;-&#123;&#123;product.collection.title&#125;&#125;&lt;&#x2F;li&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>
<p>但如果这么写，会导致对于每一条数据，django都会去数据库中搜寻信息，效率会非常慢。怎么解决呢？</p>
<p>对于1对多的关系，比如说product只能属于一个collection，我们可以用<code>select_related</code>，它帮你直接连表操作、查询数据,括号内只能放外键字段。比如上面这个例子中要引用相关的collection数据表，则可以写如下代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">queryset = Product.objects.selected_related(<span class="string">'collection'</span>).all()</span><br></pre></td></tr></table></figure>
<p>等于说现在这行代码就把两张表都预载了。</p>
<p>那么对于多对多字段，你不能使用select_related方法，这样做是为了避免对多对多字段执行JOIN操作从而造成最后的表非常大。Django提供了prefect_related方法来解决这个问题。prefect_related可用于<strong>多对多</strong>关系字段，也可用于反向外键关系(related_name)。 </p>
<p>比如说 product 和 promotion之间的关系是多对多的，在定义model时，对promotions使用的是<code>ManyToManyField()</code> </p>
<p>prefetch_related使用方法如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query_set = Product.objects.prefetch_related(<span class="string">'promotions'</span>).all()</span><br></pre></td></tr></table></figure>
<p>sql执行结果如下：</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/41.png" style="zoom:67%;"></p>
<p>此外，select_related 和 prefetch_related 可以连用，用来连接多张表格。比如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">query_set = Product.objects</span><br><span class="line">						.prefetch_related(<span class="string">'promotions'</span>)</span><br><span class="line">						.select_related(<span class="string">'collection'</span>).all()</span><br></pre></td></tr></table></figure>
<h4 id="小练习-1"><a href="#小练习-1" class="headerlink" title="小练习"></a>小练习</h4><p>Get the last 5 orders with their customer and items(including product)</p>
<p>列出最后下单的5个订单以及对应的客户和商品</p>
<p>首先，我们要了解model，customer是Order中的外键，而order又是OrderItem的外键，要筛选出订单对应的顾客很简单，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query_set = Order.objects.select_related(<span class="string">'customer'</span>).order_by(<span class="string">'-placed_at'</span>)[:<span class="number">5</span>]</span><br></pre></td></tr></table></figure>
<p>但是要“反向使用外键”就比较困难，我们要知道，当我们设order为OrderItem的外键时，同时也设置了一个反向外键名为<code>orderitem_set</code> ,如果我们觉得这个名字不好，可以再定外键的时候额外使用<code>related_name</code>属性修改。然后使用<code>prefetch_related()</code>如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">query_set = Order.objects</span><br><span class="line">            .select_related(<span class="string">'customer'</span>)</span><br><span class="line">            .prefetch_related(<span class="string">'orderitem_set__product'</span>)</span><br><span class="line">            .order_by(<span class="string">'-placed_at'</span>)[:<span class="number">5</span>]</span><br></pre></td></tr></table></figure>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/42.png" style="zoom:67%;"></p>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>当你查询单个主对象或主对象列表并需要在模板或其它地方中使用到每个对象的关联对象信息时，请一定记住使用select_related和prefetch_related一次性获取所有对象信息，从而提升数据库查询效率，避免重复查询。如果不确定是否有重复查询，可使用django-debug-toolbar查看。</p>
<p>对与单对单或单对多外键ForeignKey字段，使用select_related方法</p>
<p>对于多对多字段和反向外键关系，使用prefetch_related方法</p>
<p>两种方法均支持双下划线指定需要查询的关联对象的字段名</p>
<p>使用Prefetch方法可以给prefetch_related方法额外添加额外条件和属性。 </p>
<h3 id="Aggregating-Objects"><a href="#Aggregating-Objects" class="headerlink" title="Aggregating Objects"></a>Aggregating Objects</h3><p>现在我们想要计算一列值中的最大值或者平均值，就需要用到聚合函数了</p>
<p><code>aggregate()</code>中有很多“子函数”</p>
<p>首先可以导入：</p>
<p><code>from django.db.models.aggregates import *</code></p>
<ul>
<li>Count() </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = Product.objects.aggregate(Count(<span class="string">'id'</span>))</span><br></pre></td></tr></table></figure>
<p>如果要命名计算得到的列，可以这么写：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = Product.objects.aggregate(count = Count(<span class="string">'id'</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>Min()</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = Product.objects.aggregate(min_price = Min(<span class="string">'unit_price'</span>))</span><br></pre></td></tr></table></figure>
<p>此外还可以与<code>filter()</code>联合使用，能聚合某一范围的信息。</p>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><p>Write code to answer the following questions: </p>
<ul>
<li>How many orders do we have?</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = Order.objects.aggregate(Count(<span class="string">'id'</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>How many units of product 1 have we sold?</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = OrderItem.objects.filter(product__id=<span class="number">1</span>).aggregate(units_sold = Sum(<span class="string">'quantity'</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li><p>How many orders has customer 1 placed?</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = Order.objects.filter(customer__id=<span class="number">1</span>).aggregate(total_order = Count(<span class="string">'id'</span>))</span><br></pre></td></tr></table></figure>
</li>
<li><p>What is the min, max and average price of the products in collection 3?</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">result = Product.objects</span><br><span class="line">					.filter(collection__id = <span class="number">3</span>)</span><br><span class="line">  				.aggregate(min_price = Min(<span class="string">'unit_price'</span>),</span><br><span class="line">                     max_price = Max(<span class="string">'unit_price'</span>),</span><br><span class="line">                     avg_price = Avg(<span class="string">'unit_price'</span>))</span><br></pre></td></tr></table></figure>
<h3 id="Annotating-Objects"><a href="#Annotating-Objects" class="headerlink" title="Annotating Objects"></a>Annotating Objects</h3><p>我们之前学了Java中的 annotation,其实在Django中我们也可以用某种方法给对象打标签，如：</p>
<ul>
<li>```python<br>from django.db.models import Value<br>queryset = Customer.objects.annotate(is_new = Value(True))<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt; 我们不能直接传入布尔值，而要传入一个表达式, 因此要用&#96;Value(True)&#96;</span><br><span class="line"></span><br><span class="line">我们看到数据库中已经有新的列(is_new)了</span><br><span class="line"></span><br><span class="line">&lt;img src&#x3D;&quot;.&#x2F;Django学习1&#x2F;43.png&quot; style&#x3D;&quot;zoom:67%;&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">需要注意的是，这只是”暂时”的修改，数据库中并没有改动。</span><br><span class="line"></span><br><span class="line">+</span><br></pre></td></tr></table></figure>
from django.db.models import F<br>queryset = Customer.objects.annotate(is_new = F(‘id’))<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">同样的，可以用 F object 来创造一个与现有列一模一样的新列</span><br><span class="line"></span><br><span class="line">+ &#96;&#96;&#96;python</span><br><span class="line">  queryset &#x3D; Customer.objects.annotate(is_new &#x3D; F(&#39;id&#39;)+1)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>还可以对新列进行数值上的运算之类的操作。</p>
<h3 id="Calling-Database-Functions"><a href="#Calling-Database-Functions" class="headerlink" title="Calling Database Functions"></a>Calling Database Functions</h3><p>现在我们来介绍一下怎么在Django里面调用 mysql 提供的一些数据库函数，比如 Concat(字段连接)，Trunc(字段截取)等</p>
<p>我们在view中可以这样写，一共两种方法：</p>
<ol>
<li>第一种方法是导入Func类，然后在函数内部定义要调用的数据库函数类型，这里使用的是Concat(拼接函数)。要注意，两类拼接如果中间需要用空格隔开的话，需要使用<code>Value(&#39; &#39;)</code>,不能直接用<code>(&#39; &#39;)</code></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Value, F, Func</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hello</span><span class="params">(request)</span>:</span></span><br><span class="line">    query = Customer.objects.annotate(</span><br><span class="line">        <span class="comment"># CONCAT</span></span><br><span class="line">        full_name=Func(F(<span class="string">'first_name'</span>), Value(</span><br><span class="line">            <span class="string">' '</span>), F(<span class="string">'last_name'</span>), function=<span class="string">'CONCAT'</span>)</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/44.png" style="zoom:67%;"></p>
<ol>
<li>第二种方法更加简单，在导入时就导入Concat函数，不需要在函数使用时确定函数类型</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models.functions <span class="keyword">import</span> Concat</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hello</span><span class="params">(request)</span>:</span></span><br><span class="line">    queryset = Customer.objects.annotate(</span><br><span class="line">        <span class="comment"># CONCAT</span></span><br><span class="line">        full_name=Concat(<span class="string">'first_name'</span>, Value(<span class="string">' '</span>), <span class="string">'last_name'</span>)</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'hello.html'</span>, &#123;<span class="string">'name'</span>: <span class="string">'Jason'</span>, <span class="string">'queryset'</span>: list(queryset)&#125;)</span><br></pre></td></tr></table></figure>
<p>更多Database Funtion可以参考Django官方文档：</p>
<p><a href="https://docs.djangoproject.com/en/3.2/ref/models/database-functions/" target="_blank" rel="noopener">https://docs.djangoproject.com/en/3.2/ref/models/database-functions/</a></p>
<h3 id="Grouping-Data"><a href="#Grouping-Data" class="headerlink" title="Grouping Data"></a>Grouping Data</h3><p>现在我们要计算一下每个人下的订单数量，该怎么办？</p>
<p>我们知道 Customer和Order是一对多的关系，customer是order的外键。这时候虽然数据库里Customer表格没有Order这个字段，但是Django models已经为我们创建了一个反向关系，我们使用Count函数就可以直接计算Order的数量：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hello</span><span class="params">(request)</span>:</span></span><br><span class="line">    queryset = Customer.objects.annotate(</span><br><span class="line">        orders_count=Count(<span class="string">'order'</span>)</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'hello.html'</span>, &#123;<span class="string">'name'</span>: <span class="string">'Jason'</span>, <span class="string">'queryset'</span>: list(queryset)&#125;)</span><br></pre></td></tr></table></figure>
<p>通过Django生成的SQL语句，发现可以自动将customer和order两张表做连接</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/45.png" style="zoom:67%;"></p>
<h3 id="Working-with-Expression-Wrappers"><a href="#Working-with-Expression-Wrappers" class="headerlink" title="Working with Expression Wrappers"></a>Working with Expression Wrappers</h3><p>现在我们已经学习了Django中的 Value(表达布尔值、字符串等)、F(多列操作)、Func(数据库函数)，Aggregate(聚合函数)，它们都属于Expression类</p>
<p>现在我们来介绍另一种函数：ExpressionWrappers</p>
<p>当我们使用到一些复杂的表达式的时候，可能会涉及到数据格式的问题.比如说，我要新建一列：</p>
<p><code>queryset = Customer.objects.annotate(discount_price= F(&#39;unit_price&#39;)*0.8)</code> </p>
<p>这在Django系统中是会报错的，因为这个表达式中包含了多种类型的数据：unit_price是DecimalField而0.8是FloatField，这时候就需要用ExpressionWrappers来规定一下<code>output_field</code>来让输出结果统一了，一般我们要表示小数的时候都会选择<code>DecimalField()</code>，因其更准确</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hello</span><span class="params">(request)</span>:</span></span><br><span class="line">    discount_price = ExpressionWrapper(</span><br><span class="line">        F(<span class="string">'unit_price'</span>)*<span class="number">0.8</span>, output_field=DecimalField())</span><br><span class="line">    queryset = Customer.objects.annotate(discount_price=discount_price)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'hello.html'</span>, &#123;<span class="string">'name'</span>: <span class="string">'Jason'</span>, <span class="string">'queryset'</span>: list(queryset)&#125;)</span><br></pre></td></tr></table></figure>
<p>生成的URL如下：</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/46.png" style="zoom:67%;"></p>
<h3 id="Annotating-Exercises"><a href="#Annotating-Exercises" class="headerlink" title="Annotating Exercises"></a>Annotating Exercises</h3><p>Write code to get: </p>
<ul>
<li>Customers with their last order ID</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = Customer.objects.annotate(last_order_ID = Max(<span class="string">'order__id'</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>Collections and count of their products </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">result = Collection.objects.annotate(</span><br><span class="line">	products_count = Count(<span class="string">'product'</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ul>
<li>Customers with more than 5 orders </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">result = Customer.objects\</span><br><span class="line">.annotate(</span><br><span class="line">	orders_count = Count(<span class="string">'product'</span>)</span><br><span class="line">)</span><br><span class="line">.filter(orders_count__gt=<span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>Customers and the total amount they’ve spent </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">result = Customer.objects.annotate(</span><br><span class="line">	total_spent = Sum(</span><br><span class="line">		F(<span class="string">'order__orderitem__unit_price'</span>)*</span><br><span class="line">		F(<span class="string">'order__orderitem__quantity'</span>)</span><br><span class="line">	)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ul>
<li>Top 5 best-selling products and their total sales Solutions are on the next page. </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">result = Customer.objects\</span><br><span class="line">.annotate(</span><br><span class="line">	total_spent = Sum(</span><br><span class="line">		F(<span class="string">'order__orderitem__unit_price'</span>)*</span><br><span class="line">		F(<span class="string">'order__orderitem__quantity'</span>)</span><br><span class="line">	)</span><br><span class="line">)</span><br><span class="line">.order_by(<span class="string">'-total_spent'</span>)[:<span class="number">5</span>]</span><br></pre></td></tr></table></figure>
<h3 id="Querying-Generic-Relationships"><a href="#Querying-Generic-Relationships" class="headerlink" title="Querying Generic Relationships"></a>Querying Generic Relationships</h3><h3 id="Custom-Managers"><a href="#Custom-Managers" class="headerlink" title="Custom Managers"></a>Custom Managers</h3><h3 id="Understanding-QuerySet-Cache"><a href="#Understanding-QuerySet-Cache" class="headerlink" title="Understanding QuerySet Cache"></a>Understanding QuerySet Cache</h3><p>我们要善用 QuertSet Cache，这可以大大节省去数据库访问的时间。比如说：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hello</span><span class="params">(request)</span>:</span></span><br><span class="line">    queryset = Product.objects.all()</span><br><span class="line">    list(queryset)</span><br><span class="line">    list(queryset)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'hello.html'</span>, &#123;<span class="string">'name'</span>: <span class="string">'Jason'</span>, <span class="string">'queryset'</span>: list(queryset)&#125;)</span><br></pre></td></tr></table></figure>
<p>就相当于我们把数据库的数据都放在queryset这个缓存中了，之后用就不需要再去数据库查询了。</p>
<p>但是我们也要注意在某些情况下并不会访问缓存：</p>
<ul>
<li>重复获取queryset中一个特定的索引，将每次都查询数据库</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">queryset = Entry.objects.all()</span><br><span class="line"><span class="keyword">print</span> queryset[<span class="number">5</span>] <span class="comment"># Queries the database</span></span><br><span class="line"><span class="keyword">print</span> queryset[<span class="number">5</span>] <span class="comment"># Queries the database again</span></span><br></pre></td></tr></table></figure>
<ul>
<li>简单地打印查询集不会填充缓存</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">queryResult=models.Article.objects.all()</span><br><span class="line">print(queryResult) <span class="comment">#  hits database</span></span><br><span class="line">print(queryResult)</span><br></pre></td></tr></table></figure>
<h3 id="Creating-Objects"><a href="#Creating-Objects" class="headerlink" title="Creating Objects"></a>Creating Objects</h3><p>上面所说的都是对数据库的查询操作，现在我们来学习如何向数据库插入(增)数据</p>
<p>首先我们新创建一个 Collection对象，然后依次设定其字段</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hello</span><span class="params">(request)</span>:</span></span><br><span class="line">    collection = Collection()</span><br><span class="line">    collection.title = <span class="string">'Video Games'</span></span><br><span class="line">    collection.featured_product = Product(pk=<span class="number">1</span>)</span><br><span class="line">    collection.save()</span><br></pre></td></tr></table></figure>
<p>还有另外一种方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">collection = Collection.objects.create(title = <span class="string">'a'</span>,featured_product_id=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>但是这样的方法虽然简单但并不推荐，因为可以用<code>.</code>来轻易获得一个model对象中的属性，而用<code>create</code>是无法实现的，不太方便</p>
<p>执行效果如下：</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/47.png"></p>
<h3 id="Updating-Objects"><a href="#Updating-Objects" class="headerlink" title="Updating Objects"></a>Updating Objects</h3><p>对数数据库中一行的更新，我们一个很朴素的想法就是先筛选出来，再修改想要的字段值</p>
<p>但是我们不能这么写：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hello</span><span class="params">(request)</span>:</span></span><br><span class="line">    collection = Collection(pk=<span class="number">12</span>)</span><br><span class="line">    collection.featured_product = <span class="literal">None</span></span><br><span class="line">    collection.save()</span><br></pre></td></tr></table></figure>
<p>因为这样Django会误认为你是对所有的字段都要进行修改。我们这里不想修改title，但是Django会认为我们是想将其置为空字符串。</p>
<p>因此，我们要用<code>get</code>函数先获取到目标对象：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hello</span><span class="params">(request)</span>:</span></span><br><span class="line">    collection = Collection.objects.get(pk=<span class="number">12</span>)</span><br><span class="line">    collection.featured_product = <span class="literal">None</span></span><br><span class="line">    collection.save()</span><br></pre></td></tr></table></figure>
<p>还可以使用这种方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">collection.objects</span><br><span class="line">	.filter(pk=<span class="number">11</span>)</span><br><span class="line">  .update(featured_product=<span class="literal">None</span>)</span><br></pre></td></tr></table></figure>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/48.png"></p>
<h3 id="Deleting-Objects"><a href="#Deleting-Objects" class="headerlink" title="Deleting Objects"></a>Deleting Objects</h3><p>删除数据是比较简单的，也有两种方法：</p>
<p>第一种：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hello</span><span class="params">(request)</span>:</span></span><br><span class="line">    collection = Collection.get(pk=<span class="number">12</span>)</span><br><span class="line">    collection.delete()</span><br></pre></td></tr></table></figure>
<p>第二种：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Collection.objects.filter(id__gt=<span class="number">5</span>).delete()</span><br></pre></td></tr></table></figure>
<h3 id="Transactions"><a href="#Transactions" class="headerlink" title="Transactions"></a>Transactions</h3><p>现在我们来用Django来创建事务。也就是如果不能执行成功，就需要回滚到未执行的状态。</p>
<p>要让一段代码称为一个事务，我们可以用<code>with transaction.atomic()</code>来包裹：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> transaction</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hello</span><span class="params">(request)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> transaction.atomic():</span><br><span class="line">        order = Order()</span><br><span class="line">        order.customer_id = <span class="number">1</span></span><br><span class="line">        order.save()</span><br><span class="line"></span><br><span class="line">        item = OrderItem()</span><br><span class="line">        item.order = order</span><br><span class="line">        item.product_id = <span class="number">1</span></span><br><span class="line">        item.quantity = <span class="number">1</span></span><br><span class="line">        item.unit_price = <span class="number">10</span></span><br><span class="line">        item.save()</span><br></pre></td></tr></table></figure>
<p>当然如果我们要对整个view function进行事务级别的包裹，我们可以使用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@transaction.atomic()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hello</span><span class="params">(request)</span>:</span></span><br><span class="line">	<span class="comment">#....</span></span><br></pre></td></tr></table></figure>
<h3 id="Executing-Raw-SQL-Queries"><a href="#Executing-Raw-SQL-Queries" class="headerlink" title="Executing Raw SQL Queries"></a>Executing Raw SQL Queries</h3><p>最后，我们来学习如何在Django中执行原生SQL查询</p>
<p>一种是使用raw函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hello</span><span class="params">(request)</span>:</span></span><br><span class="line">    queryset = Product.objects.raw(<span class="string">'SELECT * FROM store_product'</span>)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'hello.html'</span>, &#123;<span class="string">'name'</span>: <span class="string">'Jason'</span>, <span class="string">'result'</span>: list(queryset)&#125;)</span><br></pre></td></tr></table></figure>
<p>还有一种是使用<code>cursor</code>对象来执行任意sql语句</p>
<p>因为在使用cursor之后，需要手动用<code>close()</code>函数关闭连接，因此我们可以用<code>with connection.cursor()</code>来包裹住要执行的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> connection</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hello</span><span class="params">(request)</span>:</span></span><br><span class="line">		<span class="keyword">with</span> connection.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">			cursor.execute(<span class="string">'something'</span>)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> render(request, <span class="string">'hello.html'</span>, &#123;<span class="string">'name'</span>: <span class="string">'Jason'</span>, <span class="string">'result'</span>: list(queryset)&#125;)</span><br></pre></td></tr></table></figure>
<p>此外，还可以用<code>cursor.callproc()</code>来执行mysql中已经存在的procedure</p>
<p>但是我们没有必要使用原生SQL进行查询，只有当原生查询比ORM中的函数更加简单的时候，才建议使用。</p>
<h2 id="The-Admin-Site"><a href="#The-Admin-Site" class="headerlink" title="The Admin Site"></a>The Admin Site</h2><h3 id="Setting-Up-the-Admin-Site"><a href="#Setting-Up-the-Admin-Site" class="headerlink" title="Setting Up the Admin Site"></a>Setting Up the Admin Site</h3><p>首先我们要在 settings中的 INSTALLED_APPS中添加sessions 应用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">		<span class="comment">#	...</span></span><br><span class="line">    <span class="string">'django.contrib.sessions'</span>,</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>添加以后，需要进行migrate</p>
<p>然后我们要在终端设置管理员信息，用<code>python manage.py createsuperuser</code>来创建：</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/49.png"></p>
<p>保存后，我们可以通过<code>http://localhost:9000/admin/</code> 进入管理后台</p>
<p>如果要修改密码，可以使用<code>python manage.py changepassword admin</code>修改</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/50.png"></p>
<p>此外，我们还可以修改<code>Django administration</code>和<code>Site administration</code>这两个字段值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin.site.site_header = <span class="string">'Storefront Admin'</span></span><br><span class="line">admin.site.index_title = <span class="string">'Admin'</span></span><br></pre></td></tr></table></figure>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/51.png"></p>
<h3 id="Registering-Models"><a href="#Registering-Models" class="headerlink" title="Registering Models"></a>Registering Models</h3><p>我们可以在admin后台直接查看 model 的相关信息。</p>
<p>在每一个 app 中有一个<code>admin.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> models</span><br><span class="line"><span class="comment"># Register your models here.</span></span><br><span class="line">admin.site.register(models.Collection)</span><br></pre></td></tr></table></figure>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/52.png"></p>
<p>但是，我们只能看到每个collection的编号，一个理想的状态是我们可以直接看到每个collection的title是什么，否则不太直观，我们需要做如下改动</p>
<p>我们要对<code>__str__</code>这个函数进行一个重写，起作用就是一个对象到字符串的映射，默认的是 <code>return  super().__str__()</code>  也就是上面看到的<code>Collection object(i)</code>,现在我让其返回<code>self.title</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Collection</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    featured_product = models.ForeignKey(</span><br><span class="line">        <span class="string">'Product'</span>, on_delete=models.SET_NULL, null=<span class="literal">True</span>, related_name=<span class="string">'+'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span> -&gt; str:</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/53.png"></p>
<p>还有，我们发现这10个Collection是杂乱无章的排序的，我们可以用Meta类来排序</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Collection</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    featured_product = models.ForeignKey(</span><br><span class="line">        <span class="string">'Product'</span>, on_delete=models.SET_NULL, null=<span class="literal">True</span>, related_name=<span class="string">'+'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span> -&gt; str:</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        ordering = [<span class="string">'title'</span>]</span><br></pre></td></tr></table></figure>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/54.png"></p>
<h3 id="Customizing-the-List-Page"><a href="#Customizing-the-List-Page" class="headerlink" title="Customizing the List Page"></a>Customizing the List Page</h3><p>现在我们想给上面显示出来的表格多添加几列。</p>
<p>一种简单的方法就是创建一个<code>ProductAdmin</code>类，并在里面确定<code>list_display</code>属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class ProductAdmin(admin.ModelAdmin):</span><br><span class="line">    list_display &#x3D; [&#39;title&#39;,&#39;unit_price&#39;]</span><br><span class="line"></span><br><span class="line">admin.site.register(models.Product,ProductAdmin)</span><br></pre></td></tr></table></figure>
<p>当然，我们也可以使用 @ 来修饰：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@admin.register(models.Product)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'title'</span>,<span class="string">'unit_price'</span>]</span><br></pre></td></tr></table></figure>
<p>这种方式更简单，还不需要我们再注册，因为已经在@中注册了</p>
<p>此外，我们还可以对列开启修改功能, 也就是定义<code>list_editable</code>属性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@admin.register(models.Product)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'title'</span>,<span class="string">'unit_price'</span>]</span><br><span class="line">    list_editable = [<span class="string">'unit_price'</span>]</span><br></pre></td></tr></table></figure>
<p>规定每页的行数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@admin.register(models.Product)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'title'</span>,<span class="string">'unit_price'</span>]</span><br><span class="line">    list_editable = [<span class="string">'unit_price'</span>]</span><br><span class="line">    list_per_page = <span class="number">10</span></span><br></pre></td></tr></table></figure>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/55.png" style="zoom: 50%;"></p>
<p>也可以在这里定义排序字段：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@admin.register(models.Product)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'title'</span>,<span class="string">'unit_price'</span>]</span><br><span class="line">    ordering = [<span class="string">'title'</span>]</span><br><span class="line">    list_editable = [<span class="string">'unit_price'</span>]</span><br><span class="line">    list_per_page = <span class="number">10</span></span><br></pre></td></tr></table></figure>
<h3 id="Adding-Computed-Columns"><a href="#Adding-Computed-Columns" class="headerlink" title="Adding Computed Columns"></a>Adding Computed Columns</h3><p>现在我们要在products中添加一列Inventory，即库存。但是我们又不想直接显示库存的多少，而希望用low,ok来表示。怎么办？</p>
<p>我们可以自己创建一列，然后用一个mapper渲染上去，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@admin.register(models.Product)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'title'</span>,<span class="string">'unit_price'</span>,<span class="string">'inventory_status'</span>]</span><br><span class="line">    list_editable = [<span class="string">'unit_price'</span>]</span><br><span class="line">    list_per_page = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @admin.display(ordering='inventory')</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inventory_status</span><span class="params">(self,product)</span>:</span></span><br><span class="line">        <span class="keyword">if</span>(product.inventory&lt;<span class="number">10</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'Low'</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'OK'</span></span><br></pre></td></tr></table></figure>
<p>在这里，我新建了一个<code>inventory_status</code> 的列，然后在下面我们创建一个函数来对该列进行一个映射：</p>
<p>因为这不是数据库内原生的列，因此如果我们设定排序字段的话Django是不会提供排序接口的。因此我们要在这个函数前面加上修饰<code>@admin.display(ordering=&#39;inventory&#39;)</code>,也就是说这列是根据inventory的大小排序的</p>
<h3 id="Selecting-Related-Objects-1"><a href="#Selecting-Related-Objects-1" class="headerlink" title="Selecting Related Objects"></a>Selecting Related Objects</h3><p>如果我要把该表的外键字段加进来，又该怎么解决呢?</p>
<p>比如说我想在Product表格中把它属于的Collection加进来，我们可以新建一列<code>collection_title</code>然后为其创建mapper，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'title'</span>,<span class="string">'unit_price'</span>,<span class="string">'inventory_status'</span>,<span class="string">'collection_title'</span>]</span><br><span class="line">    list_per_page = <span class="number">10</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">collection_title</span><span class="params">(self,product)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> product.collection.title</span><br></pre></td></tr></table></figure>
<p>但是这样会导致查询性能低的情况：</p>
<p>因为Django会为表中每行数据创建一条SQL查询语句</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/56.png" style="zoom: 50%;"></p>
<p>我们可以用这样一行代码来规避这些冗余的查询：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'title'</span>,<span class="string">'unit_price'</span>,<span class="string">'inventory_status'</span>,<span class="string">'collection_title'</span>]</span><br><span class="line">    list_per_page = <span class="number">10</span></span><br><span class="line">    list_select_related = [<span class="string">'collection'</span>]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">collection_title</span><span class="params">(self,product)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> product.collection.title</span><br></pre></td></tr></table></figure>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/57.png" style="zoom: 50%;"></p>
<p>这样，只需要执行一条SQL查询即可</p>
<p>当然，我们也可以直接在<code>list_display</code>中直接写外键相关的表的名字,比如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@admin.register(models.Order)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    list_per_page = <span class="number">10</span></span><br><span class="line">    list_display = [<span class="string">'id'</span>,<span class="string">'placed_at'</span>,<span class="string">'customer'</span>]</span><br></pre></td></tr></table></figure>
<p>但是，我们还是要重写<code>__str__</code> 函数，让其返回客户的全名：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f'<span class="subst">&#123;self.first_name&#125;</span> <span class="subst">&#123;self.last_name&#125;</span>'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">    ordering = [<span class="string">'first_name'</span>,<span class="string">'last_name'</span>]</span><br></pre></td></tr></table></figure>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/58.png" style="zoom: 50%;"></p>
<h3 id="Overriding-the-Base-QuerySet"><a href="#Overriding-the-Base-QuerySet" class="headerlink" title="Overriding the Base QuerySet"></a>Overriding the Base QuerySet</h3><p>现在我们要在Collection表格中新建一列，用来查询每个Collection一共有多少件Products</p>
<p>Collection和Products相当于一对多的关系, 有外键相连，因此可以通过Count来计算各个类别中的产品数量</p>
<p>首先新建一列<code>products_count</code>,然后创建一个函数让其返回<code>collection.products_count</code></p>
<p>但是我们知道Collection表格中并没有这一列，因此用默认的sql是查询不到结果的，因此我们要重写默认查询。使用到的工具就是<code>get_queryset</code>函数。在这个函数中，我们首先继承默认的<code>get_queryset</code>函数，然后将其返回的<code>products_count</code>改为对product数量的查询，也就是<code>Count(product)</code></p>
<p>最后，还要定义一下排序索引，即<code>@admin.display(ordering=&#39;products_count&#39;)</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@admin.register(models.Collection)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CollectionAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'title'</span>,<span class="string">'products_count'</span>]</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @admin.display(ordering='products_count')</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">products_count</span><span class="params">(self,collection)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> collection.products_count</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> super().get_queryset(request).annotate(</span><br><span class="line">            products_count = Count(<span class="string">'product'</span>)</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<p>注意，这个<code>@admin.display(ordering=&#39;&#39;)</code> 一定要修饰和列名一样的哪个函数，否则会不起作用。这里，要修饰<code>products_count</code></p>
<h3 id="Providing-Links-to-Other-Pages"><a href="#Providing-Links-to-Other-Pages" class="headerlink" title="Providing Links to Other Pages"></a>Providing Links to Other Pages</h3><p>现在我想点击 Collection中的<code>products_count</code>列，就跳到Product页面,并筛选出这个Collection中的产品信息。</p>
<p>我们一步一步来，首先要将<code>products_count</code> 中的字符串信息转换为链接，如下：</p>
<p>我们需要用到<code>format_html</code>函数，其中，占位符中的数字就是每个collection中的产品数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.html <span class="keyword">import</span> format_html</span><br><span class="line"><span class="meta">@admin.register(models.Collection)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CollectionAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">   <span class="comment">#...</span></span><br><span class="line"><span class="meta">    @admin.display(ordering='products_count')</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">products_count</span><span class="params">(self,collection)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> format_html(<span class="string">'&lt;a href="http://google.com"&gt;&#123;&#125;&lt;/a&gt;'</span>,collection.products_count)</span><br><span class="line">	 <span class="comment">#...</span></span><br></pre></td></tr></table></figure>
<p>然后，我们要把这边的google.com换成Products页面，如下：</p>
<p>我们需要用到 reverse函数，来帮助我们找到product页面的url，格式如下：<code>admin:app_model_page</code>。这里，app是<code>store</code>,model是<code>product</code>,page是<code>changelist</code> .</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.html <span class="keyword">import</span> format_html</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> reverse</span><br><span class="line"><span class="meta">@admin.register(models.Collection)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CollectionAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">   <span class="comment">#...</span></span><br><span class="line"><span class="meta">    @admin.display(ordering='products_count')</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">products_count</span><span class="params">(self,collection)</span>:</span></span><br><span class="line">        url = reverse(<span class="string">'admin:store_product_changelist'</span>) </span><br><span class="line">        <span class="keyword">return</span> format_html(<span class="string">'&lt;a href="&#123;&#125;"&gt;&#123;&#125;&lt;/a&gt;'</span>,url,collection.products_count)</span><br><span class="line">	 <span class="comment">#...</span></span><br></pre></td></tr></table></figure>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/59.gif"></p>
<p>但这样只是跳转到了product页面，并没有筛选出对应collection的产品，因此我们需要对url进行完善。也就是在url中带上对collection的查询。比如说：<code>http://localhost:9000/admin/store/product/?collection__id=3</code></p>
<p>因此我们要对url后面加上 <code>?collection__id=*</code> 这样的格式</p>
<p>为了实现这个功能，我们需要引入一个<code>urlencode</code>函数，在里面可以做参数的映射，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.html <span class="keyword">import</span> format_html,urlencode</span><br><span class="line"><span class="meta">@admin.register(models.Collection)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CollectionAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">		<span class="comment">#...</span></span><br><span class="line"><span class="meta">    @admin.display(ordering='products_count')</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">products_count</span><span class="params">(self,collection)</span>:</span></span><br><span class="line">        url = (</span><br><span class="line">            reverse(<span class="string">'admin:store_product_changelist'</span>)</span><br><span class="line">            + <span class="string">'?'</span></span><br><span class="line">            + urlencode(&#123;</span><br><span class="line">                <span class="string">'collection__id'</span>: str(collection.id)</span><br><span class="line">            &#125;)</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> format_html(<span class="string">'&lt;a href="&#123;&#125;"&gt;&#123;&#125;&lt;/a&gt;'</span>,url,collection.products_count)</span><br><span class="line">   	<span class="comment">#...</span></span><br></pre></td></tr></table></figure>
<p>最终效果如下：</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/60.gif"></p>
<h3 id="Adding-Search-to-the-List-Page"><a href="#Adding-Search-to-the-List-Page" class="headerlink" title="Adding Search to the List Page"></a>Adding Search to the List Page</h3><p>如果我们要对某一字段查询，可以在类中添加<code>search_fields</code>字段：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@admin.register(models.Customer)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomerAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'first_name'</span>,<span class="string">'last_name'</span>,<span class="string">'membership'</span>]</span><br><span class="line">    list_editable = [<span class="string">'membership'</span>]</span><br><span class="line">    ordering = [<span class="string">'first_name'</span>,<span class="string">'last_name'</span>]</span><br><span class="line">    search_fields = [<span class="string">'first_name'</span>,<span class="string">'last_name'</span>]</span><br><span class="line">    list_per_page = <span class="number">10</span></span><br></pre></td></tr></table></figure>
<p>但这样是搜索名字里有m的顾客，和我们想要搜索以m开头的顾客名不太一样，因此我们可以这么写：</p>
<p><code>search_fields = [&#39;first_name__startswith&#39;,&#39;last_name__startswith&#39;]</code></p>
<p>结果如下，</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/61.png"></p>
<p>但是这个搜索条件是大小写敏感的，如果我搜索的是<code>g</code>，是搜不到任何东西的。要让Django对搜索不敏感，可以这么写：</p>
<p><code>search_fields = [&#39;first_name__istartswith&#39;,&#39;last_name__istartswith&#39;]</code></p>
<h3 id="Adding-Filtering-to-the-List-Page"><a href="#Adding-Filtering-to-the-List-Page" class="headerlink" title="Adding Filtering to the List Page"></a>Adding Filtering to the List Page</h3><p>如果我们想在页面中加入筛选栏，只需要定义<code>list_filter</code>属性即可：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@admin.register(models.Product)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line"><span class="comment">#...</span></span><br><span class="line">    list_filter = [<span class="string">'collection'</span>,<span class="string">'last_update'</span>]</span><br><span class="line"><span class="comment">#...</span></span><br></pre></td></tr></table></figure>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/62.png"></p>
<p>那么我们可以不可以自己创建一个筛选器呢？比如说对库存进行一个分类筛选，比如筛选出状态为Low的产品。</p>
<p>首先，我们要创建一个筛选器类，继承自<code>admin.SimpleListFilter</code>, 就叫其<code>InventoryFilter</code>就好</p>
<p>然后，我们要确认两个必要的参数：title和parameter_name，其中 title就是这个分类器的名字，也就是筛选栏顶部By后面的字符串；而parameter_name则用于url中作为查询的参数，也就是<code>http://localhost:9000/admin/store/product/?inventory=&lt;10</code>中?后面的字符串<code>inventory</code>。 </p>
<p>接着我们重写<code>lookups</code>函数.用来确定filter中的类别。这个函数要返回一个元组列表，每一个元组就代表filter中的一类元组第一个值代表url中的筛选条件,(也就是上面url最后的<code>&lt;10</code>),第二个值就是这类的名字。这里我们只要选出<code>low</code>的库存，因此我们只要写一个元组<code>(&lt;10,low)</code>即可：</p>
<p>但这样只是做了一个 &lt;10和low的映射，我们还需要写一下如果小于10的内部逻辑——也就是queryset函数：告诉它，如果url中的参数是<code>&lt;10</code>,应该做什么样的查询。</p>
<p>最后，我们要把这个类添加到<code>list_filter</code>中去</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InventoryFilter</span><span class="params">(admin.SimpleListFilter)</span>:</span></span><br><span class="line">    title = <span class="string">'inventory'</span></span><br><span class="line">    parameter_name = <span class="string">'inventory'</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lookups</span><span class="params">(self, request, model_admin)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            (<span class="string">'&lt;10'</span>,<span class="string">'Low'</span>)</span><br><span class="line">        ]</span><br><span class="line"><span class="comment"># 这里给queryset加上了注解，让其等于QuerySet类，目的是让python给出更多的代码提示</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">queryset</span><span class="params">(self, request, queryset: QuerySet)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.value() == <span class="string">'&lt;10'</span>:</span><br><span class="line">            <span class="keyword">return</span> queryset.filter(inventory__lt = <span class="number">10</span>)</span><br><span class="line">          </span><br><span class="line">          </span><br><span class="line"><span class="meta">@admin.register(models.Product)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line"><span class="comment">#...</span></span><br><span class="line">    list_filter = [<span class="string">'collection'</span>,<span class="string">'last_update'</span>,InventoryFilter]</span><br><span class="line"><span class="comment">#...</span></span><br></pre></td></tr></table></figure>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/63.gif"></p>
<h3 id="Creating-Custom-Actions"><a href="#Creating-Custom-Actions" class="headerlink" title="Creating Custom Actions"></a>Creating Custom Actions</h3><p>我们知道在admin中，有Action表单，在里面可以删除选中的对象。那么我们可不可以自定义Action呢？</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/64.png"></p>
<p>比如说，我想自定义一个操作，每次点击会让选中的对象的库存清零。</p>
<p>首先，我们要新建一个函数，叫什么都行，尽量能表达出action的作用。注意，函数需要有三个参数：self,request和queryset</p>
<p>在这个函数中要写我们自定义操作的逻辑，这里我们就是把选中的对象的<code>inventory</code>属性清零。</p>
<p>此外我们还要定义<code>self.message_user</code>属性，用来确定返回给用户的信息，里面有必写的两个参数：</p>
<ul>
<li>第一个参数是request,直接写就好</li>
<li>第二个参数是信息的具体内种，这里用了一个带参数的字符串，<code>updated_count</code>即被更新的条目数量</li>
</ul>
<p><code>message_user</code>中的第三个参数是可选的，也就是确定信息的类型，这里选择的是<code>message.ERROR</code>，因此成功后的信息为红色警示</p>
<p>最后把这个函数加入到actions中去，注意要用字符串的形式。(函数用字符串的形式，类则不用)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@admin.register(models.Product)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">		<span class="comment">#...</span></span><br><span class="line">    actions = [<span class="string">'clear_inventory'</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">    @admin.action(description='Clear inventory')</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clear_inventory</span><span class="params">(self,request,queryset)</span>:</span></span><br><span class="line">        updated_count = queryset.update(inventory=<span class="number">0</span>)</span><br><span class="line">        self.message_user(</span><br><span class="line">            request,</span><br><span class="line">            <span class="string">f'<span class="subst">&#123;updated_count&#125;</span> products were successfully updated'</span>,</span><br><span class="line">            messages.ERROR</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/65.gif"></p>
<h3 id="Customizing-Forms"><a href="#Customizing-Forms" class="headerlink" title="Customizing Forms"></a>Customizing Forms</h3><p>我们在products界面的右上角的ADD PRODUCT, 就会有一张现成的表单，现在我们想自定义这张表单。</p>
<h4 id="限制字段"><a href="#限制字段" class="headerlink" title="限制字段"></a>限制字段</h4><p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/66.png"></p>
<p>比如说我对于一个新的product，我只想开放title和slug这两个属性，其他属性都是默认值，那么可以这么写：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@admin.register(models.Product)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    fields = [<span class="string">'title'</span>,<span class="string">'slug'</span>]</span><br><span class="line">    <span class="comment">#...</span></span><br></pre></td></tr></table></figure>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/67.png"></p>
<h4 id="字段同步更新"><a href="#字段同步更新" class="headerlink" title="字段同步更新"></a>字段同步更新</h4><p>因为slug的内容和Title一样，是出现在url中的一个参数，因此，可以用定义<code>prepopulated_fields</code> 属性来让slug和Title保持一致，如下：</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/68.gif"></p>
<p>但是注意了，我们修改Title，slug会跟着一起变，但是我们如果在slug写了点东西，是不会和Title中的内容同步的，并且再回到Title中修改，slug也不会同步 </p>
<h4 id="下拉表单优化"><a href="#下拉表单优化" class="headerlink" title="下拉表单优化"></a>下拉表单优化</h4><p>对于离散的数据，Django会提供一个下拉表单供我们选择，但是如果离散值很多(比如选择省市)，那么下拉表单太长会很不方便，因此我们可以在下拉表单中添加一个搜索框。</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/69.png" style="zoom:67%;"></p>
<p>我们要修改两个地方，第一个地方是在<code>ProductAdmin</code>类中定义<code>autocomplete_fields</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@admin.register(models.Product)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    autocomplete_fields = [<span class="string">'collection'</span>]</span><br><span class="line">    prepopulated_fields = &#123;</span><br><span class="line">        <span class="string">'slug'</span>:[<span class="string">'title'</span>]</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>此外我们还要在 <code>CollectionAdmin</code>中定义<code>search_fields</code>属性，否则相当于没开权限，没报错</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@admin.register(models.Collection)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CollectionAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    search_fields = [<span class="string">'title'</span>]</span><br><span class="line">    <span class="comment">#...</span></span><br></pre></td></tr></table></figure>
<p>结果如下:</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/70.gif"></p>
<p>同样的，我们可以给order表单中的Customer字段添加搜索框</p>
<h4 id="auto-now-add-True对表单的影响"><a href="#auto-now-add-True对表单的影响" class="headerlink" title="auto_now_add=True对表单的影响"></a>auto_now_add=True对表单的影响</h4><p>如果在定义model的时候设立<code>placed_at</code> 为 <code>auto_now_add=True</code>，那么新建Order表单中是不会有<code>placed_at</code>的,因为系统会自动生成，此时如果删去<code>auto_now_add=True</code>就会出现<code>Placed at</code>字段,如下：</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/71.gif"></p>
<p>更多的自定义操作，可以看Django官方文档：</p>
<p><a href="https://docs.djangoproject.com/en/3.2/ref/contrib/admin/#modeladmin-options" target="_blank" rel="noopener">https://docs.djangoproject.com/en/3.2/ref/contrib/admin/#modeladmin-options</a></p>
<h3 id="Adding-Data-Validation"><a href="#Adding-Data-Validation" class="headerlink" title="Adding Data Validation"></a>Adding Data Validation</h3><p>我们新建一个Product，如果什么都不写就提交，Django会告诉你必写的字段还未填写内容。</p>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/74.png" style="zoom:50%;"></p>
<p>但是，在创建model的时候，如果我们设置属性是<code>null=True</code>的话，Django就不会给我们这种提示</p>
<p>此外，比如说对于<code>unit price</code>字段，我们知道需要填一个正数，但是现在Django只要求你填写数字，不要求正负。因此我们要通过代码把这个验证功能加上：</p>
<p>我们需要用到 <code>django.core.validators</code> 这个类。这里我们要规定价格的最小值，因此要用到<code>MinValueValidator</code>这个类，传入的1就代表最小值。第二个参数是可选的，即可以自定义不满足要求所返回的信息比如：<code>validators = [MinValueValidator(1,message=&quot;No No No&quot;)]</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.core.validators <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    unit_price = models.DecimalField(</span><br><span class="line">        max_digits=<span class="number">6</span>, </span><br><span class="line">        decimal_places=<span class="number">2</span>,</span><br><span class="line">        validators =[MinValueValidator(<span class="number">1</span>)]</span><br><span class="line">        )</span><br><span class="line">    <span class="comment">#...</span></span><br></pre></td></tr></table></figure>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/75.png" style="zoom:50%;"></p>
<p><a href="https://docs.djangoproject.com/en/3.2/ref/validators/" target="_blank" rel="noopener">https://docs.djangoproject.com/en/3.2/ref/validators/</a></p>
<h3 id="Editing-Children-Using-Inlines"><a href="#Editing-Children-Using-Inlines" class="headerlink" title="Editing Children Using Inlines"></a>Editing Children Using Inlines</h3><p>我们现在可以新创建一个订单，但是没有办法在创建订单的时候确定订单中的产品。这时候就需要把子对象<code>OrderItem</code>添加进来,可以使用inlines属性：</p>
<p>首先我们要创建一个类，叫<code>OrderItemInline</code>, 它可以继承自<code>admin.TabularInline</code>也可以继承自<code>admin.StackedInline</code></p>
<p>我们想添加的是 OrderItem类型，因此要确定model属性<br>其中有字段product，我们要为其添加搜索框。<br>我们希望订单最少订购一件商品，最多10件，因此规定<code>min_num</code>和<code>max_num</code><br>如果我们不设定<code>min_num</code>和<code>max_num</code>，那么默认是3个，上不封顶。如果我们希望默认是0个，可以用<code>extra=0</code> ；否则，当我们设定<code>min_num=1</code>的时，默认就有4个Products了</p>
<p>最后，我们要在父类OrderAdmin中定义<code>inline</code>属性，把<code>OrderItemInline</code>传入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderItemInline</span><span class="params">(admin.TabularInline)</span>:</span></span><br><span class="line">    model = models.OrderItem</span><br><span class="line">    autocomplete_fields=[<span class="string">'product'</span>]</span><br><span class="line">    min_num = <span class="number">1</span></span><br><span class="line">    max_num = <span class="number">10</span></span><br><span class="line">    extra = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@admin.register(models.Order)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">  	inlines = [OrderItemInline]</span><br><span class="line">    autocomplete_fields = [<span class="string">'customer'</span>]</span><br><span class="line">    list_per_page = <span class="number">10</span></span><br><span class="line">    list_display = [<span class="string">'id'</span>,<span class="string">'placed_at'</span>,<span class="string">'customer'</span>]</span><br></pre></td></tr></table></figure>
<p><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/72.gif"></p>
<p><code>TabularInline</code>和<code>StackedInline</code> 的差别就在于排版方式，<code>StackedInline</code>是按列排版的，如下<br><img src="/2021/07/05/Django%E5%AD%A6%E4%B9%A01/73.png"></p>
<h3 id="Using-Generic-Relations"><a href="#Using-Generic-Relations" class="headerlink" title="Using Generic Relations"></a>Using Generic Relations</h3><p>现在，我们要把Tag以inline的形式加入到新建Product表单里面</p>
<p>首先，我们要把Tag界面加到Admin主页中去：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Tag</span><br><span class="line"><span class="comment"># Register your models here.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@admin.register(Tag)  </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TagAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    search_fields = [<span class="string">'label'</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.contenttypes.admin <span class="keyword">import</span> GenericTabularInline</span><br><span class="line"><span class="keyword">from</span> tags.models <span class="keyword">import</span> TaggedItem</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TagInline</span> <span class="params">(GenericTabularInline)</span>:</span></span><br><span class="line">    model = TaggedItem</span><br><span class="line"><span class="meta">@admin.register(models.Product)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    inline = [TagInline]</span><br><span class="line">    <span class="comment">#...</span></span><br></pre></td></tr></table></figure>
<h3 id="Extending-Pluggable-Apps"><a href="#Extending-Pluggable-Apps" class="headerlink" title="Extending Pluggable Apps"></a>Extending Pluggable Apps</h3>
      
    </div>
    
    
    
    <div>
      
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束，感谢您的阅读-------------</div>
    
</div>

      
    </div>
    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:</strong>
    Jason
  </li>
  <li class="post-copyright-link">
    <strong>Post link:</strong>
    <a href="https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/" title="Django学习1">https://jasonxqh.github.io/2021/07/05/Django%E5%AD%A6%E4%B9%A01/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice: </strong>
    All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> unless stating additionally.
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/python/" rel="tag"><i class="fa fa-tag"></i> python</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/06/28/%E6%A6%82%E7%8E%87%E8%AE%BA-%E5%81%87%E8%AE%BE%E6%A3%80%E9%AA%8C/" rel="next" title="概率论-假设检验">
                <i class="fa fa-chevron-left"></i> 概率论-假设检验
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/07/16/%E5%90%B4%E6%81%A9%E8%BE%BE-%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A01/" rel="prev" title="吴恩达-机器学习1">
                吴恩达-机器学习1 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80OTgyMC8yNjMxMQ=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Jason</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives%7C%7C%20archive">
              
                  <span class="site-state-item-count">437</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">61</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/JasonXQH" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:10195501423@stu.ecnu.edu.cn" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://yanghong.tech/" title="友链:杨弘的博客" target="_blank">友链:杨弘的博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://ankate.github.io/" title="友链:赵奕轲的博客" target="_blank">友链:赵奕轲的博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://github.com/JasonXQH/JasonXQH.github.io" title="Like it, STAR ME" target="_blank">Like it, STAR ME</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Django学习1"><span class="nav-number">1.</span> <span class="nav-text">Django学习1</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Fundamentals"><span class="nav-number">1.1.</span> <span class="nav-text">Fundamentals</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Creating-Your-First-App"><span class="nav-number">1.1.1.</span> <span class="nav-text">Creating Your First App</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Writing-Views"><span class="nav-number">1.1.2.</span> <span class="nav-text">Writing Views</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Using-Templates"><span class="nav-number">1.1.3.</span> <span class="nav-text">Using Templates</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#传入dictionary"><span class="nav-number">1.1.3.1.</span> <span class="nav-text">传入dictionary</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Debugging-Django-Applications-in-VSCode"><span class="nav-number">1.1.4.</span> <span class="nav-text">Debugging Django Applications in VSCode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Using-Django-Debug-Toolbar"><span class="nav-number">1.1.5.</span> <span class="nav-text">Using Django Debug Toolbar</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Build-a-Data-Model"><span class="nav-number">1.2.</span> <span class="nav-text">Build a Data Model</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Introduction-to-Data-Modeling"><span class="nav-number">1.2.1.</span> <span class="nav-text">Introduction to Data Modeling</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Building-an-E-commerce-Data-Model"><span class="nav-number">1.2.2.</span> <span class="nav-text">Building an E-commerce Data Model</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Organizing-Models-in-Apps"><span class="nav-number">1.2.3.</span> <span class="nav-text">Organizing Models in Apps</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Creating-Models"><span class="nav-number">1.2.4.</span> <span class="nav-text">Creating Models</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Choice-Fields"><span class="nav-number">1.2.5.</span> <span class="nav-text">Choice Fields</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Defining-One-to-one-Relationships"><span class="nav-number">1.2.6.</span> <span class="nav-text">Defining One-to-one Relationships</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Defining-a-One-to-many-Relationship"><span class="nav-number">1.2.7.</span> <span class="nav-text">Defining a One-to-many Relationship</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Defining-Many-to-many-Relationships"><span class="nav-number">1.2.8.</span> <span class="nav-text">Defining Many-to-many Relationships</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Resolving-Circular-Relationships"><span class="nav-number">1.2.9.</span> <span class="nav-text">Resolving Circular Relationships</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Generic-Relationships"><span class="nav-number">1.2.10.</span> <span class="nav-text">Generic Relationships</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#实例"><span class="nav-number">1.2.10.1.</span> <span class="nav-text">实例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Setting-Up-the-Database"><span class="nav-number">1.3.</span> <span class="nav-text">Setting Up the Database</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Creating-Migrations"><span class="nav-number">1.3.1.</span> <span class="nav-text">Creating Migrations</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#更新与修改"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">更新与修改</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Running-Migrations"><span class="nav-number">1.3.2.</span> <span class="nav-text">Running Migrations</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#小测试"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">小测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Customizing-Database-Schema"><span class="nav-number">1.3.3.</span> <span class="nav-text">Customizing Database Schema</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reverting-Migrations"><span class="nav-number">1.3.4.</span> <span class="nav-text">Reverting Migrations</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Using-MySQL-in-Django"><span class="nav-number">1.3.5.</span> <span class="nav-text">Using MySQL in Django</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Running-Custom-SQL"><span class="nav-number">1.3.6.</span> <span class="nav-text">Running Custom SQL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Generating-Dummy-Data"><span class="nav-number">1.3.7.</span> <span class="nav-text">Generating Dummy Data</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Django-ORM"><span class="nav-number">1.4.</span> <span class="nav-text">Django ORM</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Django-ORM-1"><span class="nav-number">1.4.1.</span> <span class="nav-text">Django ORM</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Managers-and-QuerySets"><span class="nav-number">1.4.2.</span> <span class="nav-text">Managers and QuerySets</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Retrieving-Objects"><span class="nav-number">1.4.3.</span> <span class="nav-text">Retrieving Objects</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Filtering-Objects"><span class="nav-number">1.4.4.</span> <span class="nav-text">Filtering Objects</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小练习"><span class="nav-number">1.4.5.</span> <span class="nav-text">小练习</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Complex-Lookups-Using-Q-Objects"><span class="nav-number">1.4.6.</span> <span class="nav-text">Complex Lookups Using Q Objects</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Referencing-Fields-using-F-Objects"><span class="nav-number">1.4.7.</span> <span class="nav-text">Referencing Fields using F Objects</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sorting"><span class="nav-number">1.4.8.</span> <span class="nav-text">Sorting</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Limiting-Results"><span class="nav-number">1.4.9.</span> <span class="nav-text">Limiting Results</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Selecting-Fields-to-Query"><span class="nav-number">1.4.10.</span> <span class="nav-text">Selecting Fields to Query</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Only-And-Defer"><span class="nav-number">1.4.11.</span> <span class="nav-text">Only() And Defer()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Selecting-Related-Objects"><span class="nav-number">1.4.12.</span> <span class="nav-text">Selecting Related Objects</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#小练习-1"><span class="nav-number">1.4.12.1.</span> <span class="nav-text">小练习</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#小结"><span class="nav-number">1.4.12.2.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Aggregating-Objects"><span class="nav-number">1.4.13.</span> <span class="nav-text">Aggregating Objects</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#练习"><span class="nav-number">1.4.14.</span> <span class="nav-text">练习</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Annotating-Objects"><span class="nav-number">1.4.15.</span> <span class="nav-text">Annotating Objects</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Calling-Database-Functions"><span class="nav-number">1.4.16.</span> <span class="nav-text">Calling Database Functions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Grouping-Data"><span class="nav-number">1.4.17.</span> <span class="nav-text">Grouping Data</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Working-with-Expression-Wrappers"><span class="nav-number">1.4.18.</span> <span class="nav-text">Working with Expression Wrappers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Annotating-Exercises"><span class="nav-number">1.4.19.</span> <span class="nav-text">Annotating Exercises</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Querying-Generic-Relationships"><span class="nav-number">1.4.20.</span> <span class="nav-text">Querying Generic Relationships</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Custom-Managers"><span class="nav-number">1.4.21.</span> <span class="nav-text">Custom Managers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Understanding-QuerySet-Cache"><span class="nav-number">1.4.22.</span> <span class="nav-text">Understanding QuerySet Cache</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Creating-Objects"><span class="nav-number">1.4.23.</span> <span class="nav-text">Creating Objects</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Updating-Objects"><span class="nav-number">1.4.24.</span> <span class="nav-text">Updating Objects</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Deleting-Objects"><span class="nav-number">1.4.25.</span> <span class="nav-text">Deleting Objects</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Transactions"><span class="nav-number">1.4.26.</span> <span class="nav-text">Transactions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Executing-Raw-SQL-Queries"><span class="nav-number">1.4.27.</span> <span class="nav-text">Executing Raw SQL Queries</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#The-Admin-Site"><span class="nav-number">1.5.</span> <span class="nav-text">The Admin Site</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Setting-Up-the-Admin-Site"><span class="nav-number">1.5.1.</span> <span class="nav-text">Setting Up the Admin Site</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Registering-Models"><span class="nav-number">1.5.2.</span> <span class="nav-text">Registering Models</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Customizing-the-List-Page"><span class="nav-number">1.5.3.</span> <span class="nav-text">Customizing the List Page</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Adding-Computed-Columns"><span class="nav-number">1.5.4.</span> <span class="nav-text">Adding Computed Columns</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Selecting-Related-Objects-1"><span class="nav-number">1.5.5.</span> <span class="nav-text">Selecting Related Objects</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Overriding-the-Base-QuerySet"><span class="nav-number">1.5.6.</span> <span class="nav-text">Overriding the Base QuerySet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Providing-Links-to-Other-Pages"><span class="nav-number">1.5.7.</span> <span class="nav-text">Providing Links to Other Pages</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Adding-Search-to-the-List-Page"><span class="nav-number">1.5.8.</span> <span class="nav-text">Adding Search to the List Page</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Adding-Filtering-to-the-List-Page"><span class="nav-number">1.5.9.</span> <span class="nav-text">Adding Filtering to the List Page</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Creating-Custom-Actions"><span class="nav-number">1.5.10.</span> <span class="nav-text">Creating Custom Actions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Customizing-Forms"><span class="nav-number">1.5.11.</span> <span class="nav-text">Customizing Forms</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#限制字段"><span class="nav-number">1.5.11.1.</span> <span class="nav-text">限制字段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#字段同步更新"><span class="nav-number">1.5.11.2.</span> <span class="nav-text">字段同步更新</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#下拉表单优化"><span class="nav-number">1.5.11.3.</span> <span class="nav-text">下拉表单优化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#auto-now-add-True对表单的影响"><span class="nav-number">1.5.11.4.</span> <span class="nav-text">auto_now_add&#x3D;True对表单的影响</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Adding-Data-Validation"><span class="nav-number">1.5.12.</span> <span class="nav-text">Adding Data Validation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Editing-Children-Using-Inlines"><span class="nav-number">1.5.13.</span> <span class="nav-text">Editing Children Using Inlines</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Using-Generic-Relations"><span class="nav-number">1.5.14.</span> <span class="nav-text">Using Generic Relations</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Extending-Pluggable-Apps"><span class="nav-number">1.5.15.</span> <span class="nav-text">Extending Pluggable Apps</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart" aria-hidden="true"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jason</span>
 <!--
  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">1297.9k</span>
  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>



-->
        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('-1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->


  
  

  
  


  

  

</body>
</html>
