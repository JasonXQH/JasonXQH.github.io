<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="y0-26jFM_8wn6Slpy1ahkB8ndR7w0OOGyAU6IaXjLUI" />














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="docker," />










<meta name="description" content="docker基础1Linux基础因为我在博客：Linux基础 中详细介绍了一些基本命令，因此这里只展示summary的内容。 在docker中运行 ubuntu: docker run ubuntu ，会自动监测是否存在 ubuntu 容器，没有的话会去 docker hub 拉去该容器。 然后我们还要运行 docker run -it ubuntu 才能启动。 Managing packages">
<meta property="og:type" content="article">
<meta property="og:title" content="docker基础1">
<meta property="og:url" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/index.html">
<meta property="og:site_name" content="Jason‘s Blog">
<meta property="og:description" content="docker基础1Linux基础因为我在博客：Linux基础 中详细介绍了一些基本命令，因此这里只展示summary的内容。 在docker中运行 ubuntu: docker run ubuntu ，会自动监测是否存在 ubuntu 容器，没有的话会去 docker hub 拉去该容器。 然后我们还要运行 docker run -it ubuntu 才能启动。 Managing packages">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/1.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/2.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/3.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/4.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/5.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/6.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/7.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/8.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/9.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/11.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/12.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/10.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/13.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/14.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/15.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/16.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/17.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/18.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/19.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/20.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/21.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/22.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/23.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/24.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/25.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/26.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/27.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/29.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/30.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/31.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/32.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/34.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/35.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/36.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/37.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/38.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/39.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/40.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/41.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/42.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/43.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/44.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/45.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/46.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/47.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/48.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/49.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/50.png">
<meta property="og:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/51.png">
<meta property="article:published_time" content="2021-04-07T06:12:52.000Z">
<meta property="article:modified_time" content="2022-05-08T07:46:36.000Z">
<meta property="article:author" content="Jason">
<meta property="article:tag" content="docker">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://jasonxqh.github.io/2021/04/07/docker基础1/"/>





  <title>docker基础1 | Jason‘s Blog</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-170027658-1', 'auto');
  ga('send', 'pageview');
</script>





<meta name="generator" content="Hexo 4.2.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">
  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
<a href="https://github.com/JasonXQH/JasonXQH.github.io" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jason‘s Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            Sitemap
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">docker基础1</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-04-07T14:12:52+08:00">
                2021-04-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  9.2k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  36
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="docker基础1"><a href="#docker基础1" class="headerlink" title="docker基础1"></a>docker基础1</h1><h2 id="Linux基础"><a href="#Linux基础" class="headerlink" title="Linux基础"></a>Linux基础</h2><p>因为我在博客：<a href="https://jasonxqh.github.io/2020/06/30/Linux基础/">Linux基础</a> 中详细介绍了一些基本命令，因此这里只展示summary的内容。</p>
<p>在docker中运行 ubuntu:</p>
<p><code>docker run ubuntu</code> ，会自动监测是否存在 ubuntu 容器，没有的话会去 docker hub 拉去该容器。</p>
<p>然后我们还要运行 <code>docker run -it ubuntu</code> 才能启动。</p>
<h3 id="Managing-packages"><a href="#Managing-packages" class="headerlink" title="Managing packages"></a>Managing packages</h3><ul>
<li>apt update</li>
<li>apt list</li>
<li>apt install nano</li>
<li>apt remove nano<h3 id="Navigating-the-file-system"><a href="#Navigating-the-file-system" class="headerlink" title="Navigating the file system"></a>Navigating the file system</h3></li>
</ul>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/1.png" style="zoom:100%;"></p>
<h3 id="Manipulating-files-and-directories"><a href="#Manipulating-files-and-directories" class="headerlink" title="Manipulating files and directories"></a>Manipulating files and directories</h3><p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/2.png" style="zoom:100%;"></p>
<h3 id="Editing-and-viewing-files"><a href="#Editing-and-viewing-files" class="headerlink" title="Editing and viewing files"></a>Editing and viewing files</h3><p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/3.png" style="zoom:100%;"></p>
<h3 id="Searching-for-text"><a href="#Searching-for-text" class="headerlink" title="Searching for text"></a>Searching for text</h3><p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/4.png" style="zoom:100%;"></p>
<h3 id="Finding-files-and-directories"><a href="#Finding-files-and-directories" class="headerlink" title="Finding files and directories"></a>Finding files and directories</h3><p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/5.png" style="zoom:100%;"></p>
<h3 id="Managing-environment-variables"><a href="#Managing-environment-variables" class="headerlink" title="Managing environment variables"></a>Managing environment variables</h3><p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/6.png" style="zoom:100%;"></p>
<h3 id="Managing-processes"><a href="#Managing-processes" class="headerlink" title="Managing processes"></a>Managing processes</h3><p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/7.png" style="zoom:100%;"></p>
<h3 id="Managing-users-and-groups"><a href="#Managing-users-and-groups" class="headerlink" title="Managing users and groups"></a>Managing users and groups</h3><p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/8.png" style="zoom:100%;"></p>
<h3 id="File-permissions"><a href="#File-permissions" class="headerlink" title="File permissions"></a>File permissions</h3><p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/9.png" style="zoom:100%;"></p>
<h2 id="Building-Images"><a href="#Building-Images" class="headerlink" title="Building Images"></a>Building Images</h2><p>在这一章，我们要学习</p>
<ul>
<li>创建 Docker文件</li>
<li>对images 进行版本控制</li>
<li>共享 images</li>
<li>保存、加载images</li>
</ul>
<h3 id="Images-and-Containers"><a href="#Images-and-Containers" class="headerlink" title="Images and Containers"></a>Images and Containers</h3><p>学习博客：<a href="https://www.jianshu.com/p/2a0aaf76734a?utm_campaign=hugo" target="_blank" rel="noopener">https://www.jianshu.com/p/2a0aaf76734a?utm_campaign=hugo</a></p>
<p>首先我们要了解 Images 和 Containers的区别。</p>
<h4 id="Image"><a href="#Image" class="headerlink" title="Image"></a>Image</h4><p>镜像（Image）就是一堆<strong>只读层</strong>（read-only layer）的统一视角，下面的这张图能够帮助读者理解镜像的定义。</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/11.png" style="zoom:100%;"></p>
<p>它包含了：</p>
<ul>
<li>A cut-down OS</li>
<li>Third-party libraries</li>
<li>Application files</li>
<li>Environment variables</li>
</ul>
<p>从左边我们看到了多个只读层，它们重叠在一起。除了最下面一层，其它层都会有一个指针指向下一层。这些层是Docker内部的实现细节，并且能够 在主机（运行Docker的机器）的文件系统上访问到。统一文件系统（union file system）技术能够将不同的层整合成一个文件系统，为这些层提供了一个统一的视角，这样就隐藏了多层的存在，在用户的角度看来，只存在一个文件系统。 我们可以在图片的右边看到这个视角的形式。</p>
<h4 id="Container"><a href="#Container" class="headerlink" title="Container"></a>Container</h4><p>容器（container）的定义和镜像（image）几乎一模一样，也是一堆层的统一视角，唯一区别在于容器的最上面那一层是可读可写的。</p>
<p>Container(容器)则像是我们开的虚拟机一样，它提供了：</p>
<ul>
<li>An isolated environment</li>
<li>Can be stopped &amp; restart</li>
<li>Container只是一个进程！但是它是一个特殊的进程，因为他有Image提供的自己的文件系统</li>
</ul>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/12.png" style="zoom:100%;"></p>
<p><strong>要点：容器 = 镜像 + 可读层。并且容器的定义并没有提及是否要运行容器</strong></p>
<p>综上我们可以这样来画出 Container和Images 的示意图：</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/10.png" style="zoom:100%;"></p>
<p>如果我们在两个终端分别运行 ubuntu，会发现他们的ID是不一样的，而且它们所属的文件系统(容器)也是不一样的。因此它们互相独立，不能访问对方的文件</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/13.png" style="zoom:100%;"></p>
<p>可以这样理解：容器是运行着的镜像</p>
<h3 id="Sample-Web-Application"><a href="#Sample-Web-Application" class="headerlink" title="Sample Web Application"></a>Sample Web Application</h3><p>我们拿到一个React项目，要在一台电脑上运行，需要三步</p>
<ul>
<li>Install Node 下载 Node.js</li>
<li>npm install 下载该项目的依赖</li>
<li>npm start 启动该项目</li>
</ul>
<h3 id="Dockerfile-Instructions"><a href="#Dockerfile-Instructions" class="headerlink" title="Dockerfile Instructions"></a>Dockerfile Instructions</h3><p>启动一个Docker项目，首先就是要创建一个 Dockerfile， Dockerfile 包含了创建一个镜像的所有指令。</p>
<p>一个 Dockerfile 主要包含下面几种指令：</p>
<ul>
<li>FROM        说明 base image，从基础镜像开始搭建</li>
<li>WORKDIR    项目工作的文件夹</li>
<li>COPY and ADD      # to copy files/directories</li>
<li>RUN                       # to run commands</li>
<li>ENV                        # to set environment variable</li>
<li>EXPOSE                # to document the port the container is listen</li>
<li>USER                   # to set the user running the app</li>
<li>CMD                   # to set the default command/pro</li>
<li>ENTRYPOINT        # to set the default command/prog</li>
</ul>
<h3 id="Choosing-the-Right-Base-Image"><a href="#Choosing-the-Right-Base-Image" class="headerlink" title="Choosing the Right Base Image"></a>Choosing the Right Base Image</h3><p>在mac在某个文件夹打开终端可以用 alfred 中的  open iterm 命令。然后输入 <code>code .</code>  就可以使用vscode 打开此文件夹，这种工作流是比较快的。</p>
<p>我们在根目录下创建 Dockerfile 文件。</p>
<p>首先我们要确定该项目的 base image，选择一个正确的docker image 十分重要。</p>
<p>关于什么技术栈使用什么base image，我们可以上  <a href="https://docs.docker.com/samples/" target="_blank" rel="noopener">https://docs.docker.com/samples/</a> 上找(我更喜欢dash 配合 alfred直接搜索) </p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/14.png" style="zoom:100%;"></p>
<p>比如说我想写一个关于 ASP.NET Core 的项目，我就可以点进第三个查看 ,里面有示例代码。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> mcr.microsoft.com/dotnet/core/sdk:<span class="number">3.1</span> AS build-<span class="keyword">env</span></span><br><span class="line"><span class="comment"># 注意，这里的代码网址可能一直在更新，因此我们要自己去找去问</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy csproj and restore as distinct layers</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> *.csproj ./</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> dotnet restore</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy everything else and build</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . ./</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> dotnet publish -c Release -o out</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Build runtime image</span></span><br><span class="line"><span class="keyword">FROM</span> mcr.microsoft.com/dotnet/core/aspnet:<span class="number">3.1</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=build-env /app/out .</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"dotnet"</span>, <span class="string">"aspnetapp.dll"</span>]</span></span><br></pre></td></tr></table></figure>
<p>在这个ReactJS 项目中，我们自然使用node，但是使用哪个版本的node十分重要，我们<strong>不要这样写</strong>： <code>FROM node:latest</code>  因为这样会导致随时间推移版本号不一致，导致维护项目变得十分困难。</p>
<p>我们在dockerhub 上可以找到很多node image：</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/15.png" style="zoom:100%;"></p>
<p>在中间一列，分别是操作系统和CPU架构。我们要选择当前CPU架构的版本进行下载。但事实上当我要下载这个image的时候，docker会自动帮我选择适合我电脑CPU的镜像版本。</p>
<p>为了能让我们的项目编译的更快，我们这里使用 alpine版本的node，因为只要几十M。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:<span class="number">14.16</span>.<span class="number">0</span>-alpine3.<span class="number">13</span></span><br></pre></td></tr></table></figure>
<p>选择好 base image之后，我么可以编译项目了：</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/16.png" style="zoom:100%;"></p>
<p>接下来，我们使用 <code>docker run -it react-app</code> 运行该项目，发现我们进入了node当中，可以直接运行js代码的那种。但这并不是我们想要的，我们希望的是进入一个shell或者bash，同时又有该node环境。为了实现这个效果我们可以将命令这样写：</p>
<p><code>docker run -it react-app sh</code>代表进入shell，注意了这里不能将sh 替换成bash，因为alpine很小，没有bash。</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/17.png" style="zoom:100%;"></p>
<h3 id="Copying-Files-and-Directories"><a href="#Copying-Files-and-Directories" class="headerlink" title="Copying Files and Directories"></a>Copying Files and Directories</h3><p><code>COPY</code> 和 <code>ADD</code> 的作用基本相同，只不过 <code>ADD</code> 相较于<code>COPY</code>多了一些功能：</p>
<p>当我们执行<code>docker build -t react-app .</code>命令的时候，docker客户端就会把这些内容交给docker engine去构建。docker engine 会一一执行 Dockerfile中的命令。但是Docker Engine 是没有权限访问当前文件下的其他文件的。因此我们要使用 COPY和ADD 指令。</p>
<p>COPY 顾名思义，就是将当前文件夹中的文件复制到我们创建的镜像当中去；ADD 则是将文件添加到镜像当中。</p>
<p>我们可以一一加入文件夹中的文件： <code>COPY package.json /app/</code>  ,其中 <code>/app/</code> 是复制到的目的地,<strong>需要绝对路径</strong>。</p>
<p>注意，如果要添加多个文件，需要注意大小写，且 <code>/app/</code><strong>后面的斜杠一定要加</strong>的</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:<span class="number">14.16</span>.<span class="number">0</span>-alpine3.<span class="number">13</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> package.json README.md /app/</span></span><br></pre></td></tr></table></figure>
<p>当然也可以使用相对路径，这时候我们就要先用<code>WORKDIR</code> 来规定工作区域： 这里我规定 WORKDIR 是<code>/app</code> 那么接下来我使用命令 <code>COPY . .</code> 第一个 <code>.</code> 代表将文件夹下的所有内容都复制。第二个<code>.</code> 是目的地，即代表当前的文件夹<code>/app</code></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:<span class="number">14.16</span>.<span class="number">0</span>-alpine3.<span class="number">13</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . .</span></span><br></pre></td></tr></table></figure>
<p>此外，还可以用列表的形式来写 COPY 命令，但是不常用：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:<span class="number">14.16</span>.<span class="number">0</span>-alpine3.<span class="number">13</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> [<span class="string">"hello world.txt"</span>,<span class="string">"."</span>]</span></span><br></pre></td></tr></table></figure>
<h4 id="ADD-特有功能"><a href="#ADD-特有功能" class="headerlink" title="ADD 特有功能"></a>ADD 特有功能</h4><ol>
<li>ADD 可以加入URL</li>
</ol>
<p>比如说我有一个json文件是放在网络服务器上的，因此我就可以通过 <code>ADD  http://.../file.json .</code>  将这个文件添加到镜像当中。</p>
<ol>
<li>ADD 可以添加压缩文件</li>
</ol>
<p><code>ADD file.zip .</code> 使用这个命令后，docker会自动解压这个压缩文件，并将其中的内容加到镜像文件当中</p>
<h4 id="构建："><a href="#构建：" class="headerlink" title="构建："></a>构建：</h4><p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/18.png" style="zoom:100%;"></p>
<p>我们看到这个镜像一下子从二十多MB跳到一百多MB了，这是因为我们<code>npm install</code> 下载了大量node modules</p>
<h3 id="Excluding-Files-and-Directories"><a href="#Excluding-Files-and-Directories" class="headerlink" title="Excluding Files and Directories"></a>Excluding Files and Directories</h3><p>问题出现了，当我们的项目越做越大的时候，如果按照之前的方法，就要把几百兆的modules传给一个虚拟化的Linux机器，这样性能很低。 而且，这些依赖都已经记录在 <code>package.json</code> 中。因此我们没有必要将 node_moduls 拷贝到镜像当中，而是在linux中自己使用<code>npm install</code>安装</p>
<p>这样做的方法有两个好处：</p>
<ol>
<li>可以大大缩小 build context 的体积</li>
<li>镜像构建速度也能提升很多。 </li>
</ol>
<p>那么怎么才能将特定的文件排除在外呢？ 我们想到，在git中我们可以使用 <code>.gitignore</code>文件来屏蔽一些文件，那么在docker中，也有这样一个 <code>.dockerignore</code>的文件，用来屏蔽不需要添加到镜像中的文件。</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/19.png" style="zoom:100%;"></p>
<p>我们看到，屏蔽了node_modules之后，构建镜像的速度变得很快，在app文件夹中也没有 <code>node_modules</code>文件夹了。</p>
<h3 id="Running-Commands"><a href="#Running-Commands" class="headerlink" title="Running Commands"></a>Running Commands</h3><p>现在我们要在 dockerfile中添加RUN 命令，以便在构建的时候下载项目所需要的依赖。这样就不用构建完之后再手动<code>npm install</code> 了。</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/20.png" style="zoom:100%;"></p>
<h3 id="Setting-Environment-Variables"><a href="#Setting-Environment-Variables" class="headerlink" title="Setting Environment Variables"></a>Setting Environment Variables</h3><p>现在我们来设置 环境变量。比如说，当我们用前端和后端沟通的时候，使用环境变量可以为我们节省很多代码。</p>
<p>语法格式： <code>ENV API_URL=http://api.myapp.com/</code></p>
<p>在启动镜像之后，首先我们可以用<code>printenv</code>来打印所有的环境变量</p>
<p>然后我们可以通过两种方法查询特定的环境变量</p>
<p><code>printenv API_URL</code> 或者 <code>echo $API_URL</code> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;app # printenv API_URL</span><br><span class="line">http:&#x2F;&#x2F;api.myapp.com&#x2F;</span><br><span class="line">&#x2F;app # echo $API_URL</span><br><span class="line">http:&#x2F;&#x2F;api.myapp.com&#x2F;</span><br></pre></td></tr></table></figure>
<h3 id="Exposing-Ports"><a href="#Exposing-Ports" class="headerlink" title="Exposing Ports"></a>Exposing Ports</h3><p>我们需要为运行的程序设置一个端口，在Dockerfile中可以这么写：<code>EXPOSE 3000</code></p>
<p>但是注意了，这只是将程序挂载到 container 中的3000端口，并不是我本地电脑的3000端口，虽然都是localhost</p>
<h3 id="Setting-the-User"><a href="#Setting-the-User" class="headerlink" title="Setting the User"></a>Setting the User</h3><p>在默认情况下，Docker会以root用户来运行程序。虽然说root用户的权限最高，但是也会存在不少安全漏洞。因此，为了运行这个项目，我们需要创建一个普通用户，其权限比较低。</p>
<p>首先我们要创建一个组，<code>addgroup app</code> </p>
<p>然后我们创建一个 system user 并将其加入刚刚创建的组中 <code>adduser -S -G app app</code> ,这句命令的意思就是创建一个叫做app的user，并把它加入到名叫 app的组中。</p>
<p>我们还可以把这两个命令放在一个命令中： <code>addgroup app &amp;&amp; adduser -S -G app app</code></p>
<p>在<code>Dockerfile</code>中，我们可以这样写创建用户、切换用户：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="bash"> addgroup app &amp;&amp; adduser -S -G app app</span></span><br><span class="line"><span class="keyword">USER</span> app</span><br></pre></td></tr></table></figure>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/21.png" style="zoom:100%;"></p>
<p>我们重新编译之后，输入 <code>whoami</code> ,这时候用户已经切成了app. </p>
<p>用<code>ls -l</code> 可以列出根目录下的一些文件信息，我们发现它们的所有者都是root，app用户是没有权限修改这些文件的，这就消除一些人修改文件的想法，增加了项目的安全性。</p>
<h3 id="Defining-Entrypoints"><a href="#Defining-Entrypoints" class="headerlink" title="Defining Entrypoints"></a>Defining Entrypoints</h3><h4 id="在terminal中直接启动项目"><a href="#在terminal中直接启动项目" class="headerlink" title="在terminal中直接启动项目"></a>在terminal中直接启动项目</h4><p>现在我们要不进入interactive模式，直接启动react-app，可以使用<code>docker run react-app npm start</code> ，其中跟在后面的 <code>npm start</code> 是启动后我们要在shell中输入的指令。</p>
<p>结果如下，我们发现我们并没有权限创建一个名为 <code>.cache</code>的文件。</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/22.png" style="zoom:100%;"></p>
<p>这是因为在Dockerfile中，我设置和切换用户写在最后两行，但是前面的指令都是root来执行的，因此我们没有权限在root创建的文件夹中进行操作。要解决这个问题，修改Dockerfile的顺序即可：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:<span class="number">14.16</span>.<span class="number">0</span>-alpine3.<span class="number">13</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> addgroup app &amp;&amp; adduser -S -G app app</span></span><br><span class="line"><span class="keyword">USER</span> app</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> npm install</span></span><br><span class="line"><span class="keyword">ENV</span> API_URL=http://api.myapp.com/</span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">3000</span></span><br></pre></td></tr></table></figure>
<h4 id="在dockerfile中启动项目"><a href="#在dockerfile中启动项目" class="headerlink" title="在dockerfile中启动项目"></a>在dockerfile中启动项目</h4><p>在dockerfile通过命令启动项目有两种方式，一种是 CMD，另外一种是ENTRYPOINT。</p>
<p><strong>CMD</strong></p>
<p>支持三种格式:</p>
<ul>
<li><code>CMD [&quot;executable&quot;,&quot;param1&quot;,&quot;param2&quot;]</code>使用 exec 执行，<strong>推荐方式</strong>；</li>
<li><code>CMD command param1 param2</code> 在 <code>/bin/sh</code> 中执行，提供给需要交互的应用；</li>
<li><code>CMD [&quot;param1&quot;,&quot;param2&quot;]</code> 提供给 ENTRYPOINT 的默认参数；</li>
</ul>
<p>指定启动容器时执行的命令，每个 Dockerfile 只能有一条 CMD 命令。如果指定了多条命令，只有最后一条会被执行。如果用户启动容器时候<strong>指定了运行的命令，则会覆盖掉 CMD 指定的命令</strong>。</p>
<p><strong>ENTRYPOINT</strong></p>
<p>两种格式：</p>
<p><code>ENTRYPOINT [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;]</code> ,<strong>推荐方式</strong></p>
<p> <code>ENTRYPOINT command param1 param2</code>（shell中执行）。</p>
<p>配置容器启动后执行的命令，并且<strong>不可被 docker run 提供的参数覆盖</strong>。</p>
<p>每个 Dockerfile 中只能有一个 ENTRYPOINT，当指定多个时，只有<strong>最后一个起效</strong>。</p>
<p>因此，当命令一定会被执行的时候，推荐使用ENTRYPOINT，因为其不会被覆盖。</p>
<h3 id="Speeding-Up-Builds"><a href="#Speeding-Up-Builds" class="headerlink" title="Speeding Up Builds"></a>Speeding Up Builds</h3><p>我们看到对于这个小项目，m1的mac mini每次编译运行都要大概三四十秒的时间，还是比较慢的。这和docker的镜像机制有关。当Docker在编译一个项目的时候，每次执行一条指令就会新建一个只读层，这个只读层包含了这条指令修改了的文件。</p>
<p>因此我们要优化它。首先我们用<code>docker history react-app</code>来看一下image的各层：</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/23.png" style="zoom:100%;"></p>
<p>我们看到下面没有COMMENT的半部分是 Base Image，也就是 我们创建的 <code>node:14.16.0-alpine3.13</code> ，这几层创建的时间都是十几天前，说明创建一次之后，若没有改变就不用再创建了</p>
<p>然后，执行<code>RUN addgroup app &amp;&amp; adduser -S -G app app</code> 命令后， image又加了一层，文件系统多了几个文件。但是新建过后，就不需要再改变了，我们看到这个修改时间是四个小时之前了。</p>
<p>接下来执行的是 <code>USER app</code> 和<code>WORKDIR /app</code>  ，它们没有添加也没有减少文件，因此这层layer的大小是0B</p>
<p>但是<code>COPY . .</code>  每次都会将本地文件夹中的内容放到镜像中，因此每执行一次build，这一层就会新建一次。并且，当里面的一层只读层重建的话，建立在其上面的只读层都必须重建。因此在<code>COPY</code> 之后的指令都会创建一个新的镜像。</p>
<p>现在技巧性的东西来了，我们希望 <code>npm install</code> 这一步不要经常改变，因为每次下载node_modules需要非常多的时间，而且依赖并不是经常会修改的。因此我们可以先将 <code>pakage.json</code>文件加入镜像并执行<code>npm install</code>,然后再把其他的文件加入镜像。这样以后执行起来就会跳过 <code>RUN  npm install</code> 这条指令。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:<span class="number">14.16</span>.<span class="number">0</span>-alpine3.<span class="number">13</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> addgroup app &amp;&amp; adduser -S -G app app</span></span><br><span class="line"><span class="keyword">USER</span> app</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> package*.json .	<span class="comment"># 先把依赖文件加进去</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> npm install				<span class="comment"># 安装依赖，没有修改就跳过 </span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . .							<span class="comment"># 再将其他的文件加入，从这里开始，每次都新建</span></span></span><br><span class="line"><span class="keyword">ENV</span> API_URL=http://api.myapp.com/</span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">3000</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"npm"</span>,<span class="string">"start"</span>]</span></span><br></pre></td></tr></table></figure>
<p>在第一次执行的时候，build需要执行38.2s,但是在修改了文件而不修改依赖的情况下再次build只需要4.9s，这是因为<code>npm install</code>的那一层并不需要重新再建一次，而是在缓存中了。</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/24.png" style="zoom:100%;"></p>
<h3 id="Removing-Images"><a href="#Removing-Images" class="headerlink" title="Removing Images"></a>Removing Images</h3><p>我们用<code>docker images</code>查看，会发现很多没有名字，也没有Tag的镜像文件：</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/25.png" style="zoom:100%;"></p>
<p>这些镜像文可能是临时镜像，没有最终build为一个最终的镜像，删掉即可。</p>
<p>我们可以使用：<code>docker container prune</code> 来删除已经停止多余的容器.</p>
<p>然后运行<code>docker image prune</code>来删除多余的镜像</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/26.png" style="zoom:100%;"></p>
<p>删除了之后，我们再打开镜像列表，发现只有两个我们在使用的镜像了。</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/27.png" style="zoom:100%;"></p>
<p>当我们想删除特定容器或者对象的时候，可以这样：</p>
<p>首先用<code>docker ps -a</code> 列出当前容器，然后：</p>
<p><code>docker rm -f &lt;?containerid&gt;</code> 来删除特定ID的容器或者镜像</p>
<p>或者用 <code>docker image rm &lt;name&gt;</code> 来制定删除特定名字的镜像或者容器</p>
<h3 id="Tagging-Images"><a href="#Tagging-Images" class="headerlink" title="Tagging Images"></a>Tagging Images</h3><p>为了项目维护方便，我们要养成给 Images打标签的习惯，否则每个项目的标签都是latest，比较难区分。比如说 testing, staging 之类的</p>
<p>举例： <code>docker build -t react-app:3.1.5</code>  也就是创建image的时候就给他打一个标签。其中，repository的名字是react-app, 该image的tag是冒号后面的 3.1.5</p>
<p>删除tag： <code>docker image remove react-app:1</code> </p>
<p>这和git中的tag有些类似，我们要时刻更新latest 这个tag</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/29.png" style="zoom:100%;"></p>
<p>比如现在我要将 lastest从上一个版本切换到现在tag为2的版本</p>
<p>可以用： <code>docker image tag 94e react-app:latest</code>  其中，945是Image ID的前三位</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/30.png" style="zoom:100%;"></p>
<h3 id="Sharing-Images"><a href="#Sharing-Images" class="headerlink" title="Sharing Images"></a>Sharing Images</h3><p>我们在dockerhub上</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/31.png" style="zoom:100%;"></p>
<p>然后我们把本地的image push上去, 首先为了管理方便我们再给第二版的项目打一个标签。</p>
<p><code>docker image tag 94e jasonxqh/react-app :2</code></p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/32.png" style="zoom:100%;"></p>
<p>然后利用<code>docker push jasonxqh/react-app:2</code>将第二版本的项目推送到docker hub上 ，推送之前记得先登录docker hub</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/34.png" style="zoom:100%;"></p>
<h3 id="Saving-and-Loading-Images"><a href="#Saving-and-Loading-Images" class="headerlink" title="Saving and Loading Images"></a>Saving and Loading Images</h3><p>如果我们不通过dockerhub，而是通过压缩文件的方法来保存images： <code>docker image save -o react-app.tar jasonxqh/react-app:3</code>  其中，前面的<code>react-app.tar</code>是压缩文件包的名字，后面的 <code>jasonxqh/react-app:3</code>是这个image的reference。</p>
<p>打开 <code>.tar</code>文件，里面保存的是一层一层的只读层</p>
<p>当我们在另一台电脑上要加载这个镜像的时候，可以：</p>
<p><code>docker image load -i react-app.tar</code></p>
<p>这样就把这个镜像加入进去了。</p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/35.png" style="zoom:100%;"></p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/36.png" style="zoom:100%;"></p>
<h2 id="Working-with-Containers"><a href="#Working-with-Containers" class="headerlink" title="Working with Containers"></a>Working with Containers</h2><h3 id="Starting-Containers"><a href="#Starting-Containers" class="headerlink" title="Starting Containers"></a>Starting Containers</h3><p><code>docker run react-app</code> 可以让docker容器在前台运行：</p>
<p><code>docker run -d react-app</code> 可以让docker容器在后台运行。</p>
<p><code>docker run -d --name blue-sky react-app</code> 启动名为 <code>react-app</code>的docker镜像，并命名为 <code>blue-sky</code> </p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/37.png" style="zoom:100%;"></p>
<h3 id="Viewing-the-Logs"><a href="#Viewing-the-Logs" class="headerlink" title="Viewing the Logs"></a>Viewing the Logs</h3><p>现在我们在后台启动了这个容器，但是这对于我们来说相当于一个黑匣子，我并不清楚其中的运行信息。因此我们需要查看日志。</p>
<p>利用命令 <code>docker logs &lt;DockerID&gt;</code> 就可以查看该进程在后台打印的信息了：</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/38.png" style="zoom:100%;"></p>
<p>此外，通过查询 <code>docker logs --help</code> 可以查询更多操作：</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/39.png" style="zoom:100%;"></p>
<p>比如说：</p>
<p><code>dash logs -f ID</code> 可以<strong>实时监控</strong>后台的打印信息，可以通过 Ctrl+C 来退出该模式</p>
<p><code>dash logs -n 5 ID</code> 可以看到最后n条日志信息，这里是5条</p>
<p><code>dash logs -t ID</code> 可查看各条日志信息的时间戳</p>
<h3 id="Publishing-Ports"><a href="#Publishing-Ports" class="headerlink" title="Publishing Ports"></a>Publishing Ports</h3><p>之前我们说过，启动了container 之后，在本地访问<code>localhost:3000</code> 是没有效果的。因为在 Dockerfile 中，<code>Exposing 3000</code>只是在container所在的虚拟机中暴露3000端口。</p>
<p>为了做端口映射，我们可以用这条指令：</p>
<p><code>docker run -d -p 80:3000 --name c1  jasonxqh/react-app:3</code> </p>
<p>其中， -d 代表detach；-p 代表 port, 这里将container中的3000端口和本地的80端口做映射； —name是启动的container的名字； 最后一个参数是要启动的镜像</p>
<p>  <img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/40.png" style="zoom:100%;"></p>
<h3 id="Executing-Commands-in-Running-Containers"><a href="#Executing-Commands-in-Running-Containers" class="headerlink" title="Executing Commands in Running Containers"></a>Executing Commands in Running Containers</h3><p>之前我们学了在dockerfile中利用CMD执行命令。现在我们要来看怎么在一个正在运行的容器中执行命令</p>
<p>可以利用 <code>docker exec -it c1 sh</code>   来对一个正在运作的容器执行命令：</p>
<p>其中 <code>-it</code> 代表 interactive (交互)， c1是容器的名字， sh则是我们要打开的shell。</p>
<p>操作完之后，我们可以输入<code>exit</code> 退出shell，但是并不会使运行中的容器退出。</p>
<h3 id="Stopping-and-Starting-Containers"><a href="#Stopping-and-Starting-Containers" class="headerlink" title="Stopping and Starting Containers"></a>Stopping and Starting Containers</h3><p>使用<code>docker stop c1</code> 和<code>docker start c1</code>来结束或者开始一个容器。</p>
<p><code>docker run</code> 和 <code>docker start</code> 的区别就是前者是创建一个新的容器出来，后者是启动现有的容器</p>
<h3 id="Removing-Containers"><a href="#Removing-Containers" class="headerlink" title="Removing Containers"></a>Removing Containers</h3><p>我们用<code>docker rm c1</code> 是没有办法删除一个正在运行中的容器的，如果我们强制移除：<code>docker rm -f c1</code></p>
<h3 id="Containers-File-System"><a href="#Containers-File-System" class="headerlink" title="Containers File System"></a>Containers File System</h3><p>每一个容器都有独立的文件系统，在一个容器中创建的文件在另一个容器是访问不到的。</p>
<h3 id="Persisting-Data-using-Volumes"><a href="#Persisting-Data-using-Volumes" class="headerlink" title="Persisting Data using Volumes"></a>Persisting Data using Volumes</h3><p>Volume是 在container之外的一片存储空间。是绕过container的文件系统，直接将数据写到host机器上，只是volume是被docker管理的，docker下所有的volume都在host机器上的指定目录下/var/lib/docker/volumes。</p>
<p><code>docker volume create app-data</code> 是创建一个名叫app-data volume.</p>
<p><code>docker volume inspect app-data</code> 是查看这个volume的基本信息，我们看到这个volume是放在 <code>/var/lib/docker/volumes/app-data/_data</code>  文件夹下的</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/41.png" style="zoom:100%;"></p>
<p>接下来我们要把这个volume挂载到container中：</p>
<p><code>docker run -d -p 4000:3000 -v app-data:/app/data  jasonxqh/react-app:3</code></p>
<p>如果volume是空的而container中的目录有内容，那么docker会将container目录中的内容拷贝到volume中，但是如果volume中已经有内容，则会将container中的目录覆盖</p>
<p>也就是说现在我们往container中的<code>/app/data</code>目录写文件是会保存在本地电脑上的。</p>
<p>但是，现在我们直接 <code>echo something &gt; sth.data</code> ，是没有权限的，因为现在的用户是app,但是data的所有者是root。为此，我们要在dockerfile中事先以app用户的名义创建好data文件夹。</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/42.png" style="zoom:100%;"></p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/43.png" style="zoom:100%;"></p>
<p>现在，权限问题解决了。</p>
<h3 id="Copying-Files-between-the-Host-and-Containers"><a href="#Copying-Files-between-the-Host-and-Containers" class="headerlink" title="Copying Files between the Host and Containers"></a>Copying Files between the Host and Containers</h3><p>现在我们要把container中的文件拷贝到本地，或者把本地的文件拷贝到容器中去。</p>
<p><code>docker cp 776:/app/log.txt .</code> 其中<code>776:/app/log.txt</code> 是ID为776的container<code>/app</code>文件夹下的目标文件， <code>.</code> 是复制到的目的地。这里是把容器中的log.txt拷贝到本地当前文件夹。</p>
<p>同样的，<code>docker cp secret.txt 776:/app</code> 就是把本地的 <code>secret.txt</code>文件拷贝到container中去。</p>
<h3 id="Sharing-the-Source-Code-with-a-Container"><a href="#Sharing-the-Source-Code-with-a-Container" class="headerlink" title="Sharing the Source Code with a Container"></a>Sharing the Source Code with a Container</h3><p>当我们正式开始写项目的时候，我们不希望修改一点点东西就要新创建一个image，新开一个container，才能在网页上显示改变。这样太浪费时间了。</p>
<p>因此我们要做一个映射，就是在本地项目文件夹和docker的工作文件夹之间建立一个映射</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/44.png" style="zoom:100%;"></p>
<p>我们可以用这条命令来启动，首先我们做端口映射，然后 <code>-v</code> 代表挂载外接盘，这里我们把 <code>${PWD}</code> 和<code>/app</code> 做一个映射，也就是当我修改 当前目录文件夹的文件时，容器中的<code>/app</code>文件也会同步。 </p>
<p>注意 PWD 代表当前的目录，这里一定要<strong>使用大写 </strong>，否则是非法的。</p>
<p><code>docker run -d -p 5005:3000 -v ${PWD}:/app  react-app</code></p>
<h2 id="Running-Multi-container-Applications"><a href="#Running-Multi-container-Applications" class="headerlink" title="Running Multi-container Applications"></a>Running Multi-container Applications</h2><h3 id="Installing-Docker-Compose"><a href="#Installing-Docker-Compose" class="headerlink" title="Installing Docker Compose"></a>Installing Docker Compose</h3><p>前面我们使用 Docker 的时候，定义 Dockerfile 文件，然后使用 docker build、docker run 等命令操作容器。然而微服务架构的应用系统一般包含若干个微服务，每个微服务一般都会部署多个实例，如果每个微服务都要手动启停，那么效率之低，维护量之大可想而知</p>
<p><strong>使用 Docker Compose 可以轻松、高效的管理容器，它是一个用于定义和运行多容器 Docker 的应用程序工具</strong>mac和windows用户，当我们下载了Docker Desktop之后就自动安装了Docker Compose</p>
<h3 id="Cleaning-Up-our-Workspace"><a href="#Cleaning-Up-our-Workspace" class="headerlink" title="Cleaning Up our Workspace"></a>Cleaning Up our Workspace</h3><p><code>docker container rm -f $(docker container ls -aq)</code> 可以删除所有状态下的容器</p>
<p><code>docker image rm -f $(docker image ls -aq)</code> 可以删除所有状态下的 Image</p>
<p>其中<code>-aq</code> 中的a代表all， <code>-q</code> 则代表获取所有对象的ID。  </p>
<h3 id="The-Sample-Web-Application"><a href="#The-Sample-Web-Application" class="headerlink" title="The Sample Web Application"></a>The Sample Web Application</h3><p>这是一个有前端和后端的Web项目：</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/45.png" style="zoom:100%;"></p>
<p>按正常的方法，我们需要分别进入前后端文件夹并使用<code>npm run start</code> 但是如果我们使用了 docker compose，编写了yml文件，我们就可以直接输入<code>docker-compose up</code>让项目在docker容器中运行。</p>
<h4 id="bug"><a href="#bug" class="headerlink" title="bug"></a>bug</h4><p>这里我遇到了一个比较难发现的bug，那就是我一直无法启动 <code>./docker-entrypoint.sh</code> 这个文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">echo "Waiting for MongoDB to start..."</span><br><span class="line">./wait-for db:27017 </span><br><span class="line"></span><br><span class="line">echo "Migrating the databse..."</span><br><span class="line">npm run db:up </span><br><span class="line"></span><br><span class="line">echo "Starting the server..."</span><br><span class="line">npm start</span><br></pre></td></tr></table></figure>
<p>当后端启动，我们再调用这个文件，就能在container中运行shell命令。</p>
<p>但是，我这个文件是本地创建的，创建时并没有像app用户开放执行权限，导致我<code>docker-compose up</code> 的时候始终报：Permission denied。 因此，我们要在运行<code>docker-compose up</code> 前手动修改<code>docker-entrypoint.sh</code> 的权限：</p>
<p><code>chmod a+x docker-entrypoint.sh</code> 修改执行权限，再执行<code>docker-compose up</code> 之后，bug解决。</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/46.png" style="zoom:100%;"></p>
<h3 id="JSON-and-YAML-Formats"><a href="#JSON-and-YAML-Formats" class="headerlink" title="JSON and YAML Formats"></a>JSON and YAML Formats</h3><p> 现在我们就来介绍一下YAML格式以及它和JSON格式的区别。</p>
<p>首先我们看以下JSON格式的文件：JSON格式就是键值对</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"vidly-frontend"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"0.1.0"</span>,</span><br><span class="line">  <span class="attr">"private"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"axios"</span>: <span class="string">"^0.21.1"</span>,</span><br><span class="line">    <span class="attr">"react"</span>: <span class="string">"^17.0.1"</span>,</span><br><span class="line">    <span class="attr">"react-dom"</span>: <span class="string">"^17.0.1"</span>,</span><br><span class="line">    <span class="attr">"react-scripts"</span>: <span class="string">"4.0.2"</span>,</span><br><span class="line">    <span class="attr">"web-vitals"</span>: <span class="string">"^1.0.1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"start"</span>: <span class="string">"react-scripts start"</span>,</span><br><span class="line">    <span class="attr">"build"</span>: <span class="string">"react-scripts build"</span>,</span><br><span class="line">    <span class="attr">"test"</span>: <span class="string">"react-scripts test --colors"</span>,</span><br><span class="line">    <span class="attr">"eject"</span>: <span class="string">"react-scripts eject"</span></span><br><span class="line">  &#125;,  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>YAML的语法和其他高级语言类似，并且可以简单表达清单、散列表，标量等数据形态。它使用空白符号缩进和大量依赖外观的特色，特别适合用来表达或编辑数据结构、各种配置文件、倾印调试内容、文件大纲（例如：许多电子邮件标题格式和YAML非常接近）。那么YAML格式长啥样呢？下面是 <code>docker-compose.yml</code> 文件中的信息：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3.8"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">frontend:</span></span><br><span class="line">    <span class="attr">depends_on:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">./frontend</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">3000</span><span class="string">:3000</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">backend:</span> </span><br><span class="line">    <span class="attr">depends_on:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">./backend</span></span><br><span class="line">    <span class="attr">ports:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="number">3001</span><span class="string">:3001</span></span><br><span class="line">    <span class="attr">environment:</span> </span><br><span class="line">      <span class="attr">DB_URL:</span> <span class="string">mongodb://db/vidly</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">./docker-entrypoint.sh</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mongo:4.0-xenial</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">27017</span><span class="string">:27017</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">vidly:/data/db</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">vidly:</span></span><br></pre></td></tr></table></figure>
<p>我们发现，YAML其实就是JSON格式去掉所有的大括号和引号，并用缩进来表示从属关系。</p>
<p>在一个冒号下的多个数值的列举，使用 <code>-</code> 使条理清晰</p>
<p>那么YAML可读性比JSON高的话，为什么我们步一直使用YAML呢？因为解析YAML格式的文件要比解析JSON格式的文件更慢一些，所以说各有利弊</p>
<p>接下来这章，我们就来复盘一下这样一份 <code>docker-compose.yml</code> 是怎么写出来的</p>
<h3 id="Creating-a-Compose-File"><a href="#Creating-a-Compose-File" class="headerlink" title="Creating a Compose File"></a>Creating a Compose File</h3><p>首先，我们新建一个 <code>docker-compose.yml</code> 文件。</p>
<h4 id="version字段"><a href="#version字段" class="headerlink" title="version字段"></a>version字段</h4><p>在文件的开始，我们要确定compose版本：</p>
<p>在： <a href="https://docs.docker.com/compose/compose-file/" target="_blank" rel="noopener">https://docs.docker.com/compose/compose-file/</a> 中，我们可以查到compose file与Docker Engine对应的表格，按照上面写即可：</p>
<p>这里我们使用3.8版本：</p>
<p><code>Version: &quot;3.8&quot;</code> </p>
<h4 id="services字段"><a href="#services字段" class="headerlink" title="services字段"></a>services字段</h4><p>然后我们要确定<code>services</code>字段：这个字段告诉Docker，它要创建哪些container，比如frontend，backend，db，这些服务的名字我们可以乱取，Docker会依次为其创建容器。但是为了简洁起见，我们还是将其命名为frontend，backend，db三个服务，分别代表前端，后端，数据库</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3.8"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">frontend:</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">backend:</span> </span><br><span class="line">  </span><br><span class="line">  <span class="attr">db:</span></span><br></pre></td></tr></table></figure>
<h5 id="frontend"><a href="#frontend" class="headerlink" title="frontend"></a>frontend</h5><p>在前端服务中，我们首先要运行frontend文件夹中的 <code>dockerfile</code> 文件。我们可以这么写：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">frontend:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">./frontend</span></span><br></pre></td></tr></table></figure>
<p>接下来我们做端口映射，也就是将容器中的端口映射到本地。这里虽然我们只做一个端口映射，但是考虑到可能有多重端口映射，因此这里使用 <code>-</code> 来列举</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">frontend:</span></span><br><span class="line">  <span class="attr">build:</span> <span class="string">./frontend</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">3000</span><span class="string">:3000</span></span><br></pre></td></tr></table></figure>
<h5 id="backend"><a href="#backend" class="headerlink" title="backend"></a>backend</h5><p>和frontend一样，这里我们也要定义build属性，它将执行 backend文件夹下的dockerfile文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">backend:</span> </span><br><span class="line">	<span class="attr">build:</span> <span class="string">./backend</span></span><br></pre></td></tr></table></figure>
<p>和frontend一样，后端服务也需要端口映射：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">backend:</span> </span><br><span class="line">    <span class="attr">build:</span> <span class="string">./backend</span></span><br><span class="line">    <span class="attr">ports:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="number">3001</span><span class="string">:3001</span></span><br></pre></td></tr></table></figure>
<p>下面一个属性是<code>environment</code>,这是后端服务所需要</p>
<p>然后，我们要做一个volume映射，来告诉后端数据库在哪里.这个关键变量其实就是一个Mongodb的Connection URL ——  <code>mongodb://db/vidly</code> ，db是一个host(因为按照YAML创建的container中的host名与service的名字一样)，因此，这里是<code>db</code>;  <code>/vidly</code>代表这个db数据库下的一张数据表.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">backend:</span> </span><br><span class="line">  <span class="attr">depends_on:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">  <span class="attr">build:</span> <span class="string">./backend</span></span><br><span class="line">  <span class="attr">ports:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="number">3001</span><span class="string">:3001</span></span><br><span class="line">  <span class="attr">environment:</span> </span><br><span class="line">    <span class="attr">DB_URL:</span> <span class="string">mongodb://db/vidly</span></span><br></pre></td></tr></table></figure>
<h5 id="db"><a href="#db" class="headerlink" title="db"></a>db</h5><p>这是一个数据库服务，因为我们本地没有相关的文件，所以就要用为其规定image属性，比如说这里的 <code>mongo:4.0-xenial</code> ，这是一个ubuntu 版本的mongodb，比windows下的mongodb要轻量化许多。然后同样做一个端口映射</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">db:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">mongo:4.0-xenial</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">27017</span><span class="string">:27017</span></span><br></pre></td></tr></table></figure>
<p>通常情况下，一个容器启动之后，所有容器中的数据都存在容器内部的临时文件中，如果容器停止，则数据也就清空了，为了能够在使用容器的过程中，还能把一些数据持久化下来，也即容器消失掉，这些数据依然还存在，因此dockercompose支持了数据卷（volume）功能，通过他可以指定Docker中一块持久化的区域，该区域在容器消失之后，还可以依然将区域中的数据保存下来。</p>
<p>相当于这部分区域不在属于某一个容器了，而是由dockercompose管理的一部分区域，只要通过compose启动容器，这部分区域就一直会存在</p>
<p>这里我们就要定义一个持久化的数据卷：左边的是主机目录，右边的是容器目录。也就是说，如果项目往容器数据库中写数据的话，那么这些数据会保存在主机上不会消失。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">db:</span> </span><br><span class="line">  <span class="attr">image:</span> <span class="string">mongo:4.0-xenial</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">27017</span><span class="string">:27017</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vidly:/data/db</span></span><br></pre></td></tr></table></figure>
<h4 id="volumes"><a href="#volumes" class="headerlink" title="volumes:"></a>volumes:</h4><p>上面我们使用了一个数据卷 ，但我们还没有定义，因此接下来我们要定义它。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">vidly:</span></span><br></pre></td></tr></table></figure>
<h3 id="Building-Images-1"><a href="#Building-Images-1" class="headerlink" title="Building Images"></a>Building Images</h3><p>之前我们说了 Docker-Compose 是建立在 Docker-engine之上的，因此docker engine能完成的工作(build,run,listening等)，docker-compose都能够完成 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Commands:</span><br><span class="line">  build              Build or rebuild services</span><br><span class="line">  config             Validate and view the Compose file</span><br><span class="line">  create             Create services</span><br><span class="line">  down               Stop and remove resources</span><br><span class="line">  events             Receive real time events from containers</span><br><span class="line">  exec               Execute a command in a running container</span><br><span class="line">  help               Get help on a command</span><br><span class="line">  images             List images</span><br><span class="line">  kill               Kill containers</span><br><span class="line">  logs               View output from containers</span><br><span class="line">  pause              Pause services</span><br><span class="line">  port               Print the public port for a port binding</span><br><span class="line">  ps                 List containers</span><br><span class="line">  pull               Pull service images</span><br><span class="line">  push               Push service images</span><br><span class="line">  restart            Restart services</span><br><span class="line">  rm                 Remove stopped containers</span><br><span class="line">  run                Run a one-off command</span><br><span class="line">  scale              Set number of containers for a service</span><br><span class="line">  start              Start services</span><br><span class="line">  stop               Stop services</span><br><span class="line">  top                Display the running processes</span><br><span class="line">  unpause            Unpause services</span><br><span class="line">  up                 Create and start containers</span><br><span class="line">  version            Show version information and quit</span><br></pre></td></tr></table></figure>
<p>现在我们来学习如何用 build 指令, build就是用来构建刚才我们写的服务的。build完成后service会以 image的形式存在。</p>
<p>当我们想不借助cache，重新编译的时候，可以使用 <code>docker-compose build --no-cache</code> 但是显然这样会比较慢</p>
<h3 id="Starting-and-Stopping-the-Application"><a href="#Starting-and-Stopping-the-Application" class="headerlink" title="Starting and Stopping the Application"></a>Starting and Stopping the Application</h3><p>之前学的 <code>docker-compose up</code> 是将 build image，run container一步到位了。如果我们想重新build一遍，并运行起来，可以使用 <code>docker-compose up --build</code> ；如果我们想要其在后台运行，可以使用<code>docker-compose up -d</code> </p>
<p>使用docker-compose运行起来的容器可以使用 <code>docker-compose ps</code> 一览</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/47.png" style="zoom:100%;"></p>
<p>当我们想要关掉后台运行中的的容器时，可以 <code>docker-compose down</code> </p>
<h3 id="Docker-Networking"><a href="#Docker-Networking" class="headerlink" title="Docker Networking"></a>Docker Networking</h3><p>当我们用 docker-compose 启用一个项目的时候，Docker Compose会自动创建一个关系网络并将containers加到这个网络上，一遍这几个网络可以互相通讯。</p>
<p>我们可以使用<code>docker network ls</code> 来查看这几个container 的关系网：</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/48.png" style="zoom:100%;"></p>
<p>然后我用 root 用户登录backend(否则没有ping的权限)，然后ping 本地的frontend地址，就可以发现它们是可以互相通讯的。</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/49.png" style="zoom:100%;"></p>
<p>这也是为什么backend container能够通过 connection url与mongodb container 通讯了。</p>
<h3 id="Viewing-Logs"><a href="#Viewing-Logs" class="headerlink" title="Viewing Logs"></a>Viewing Logs</h3><p>使用<code>docker-compose logs</code> 可以查看后端程序日志信息，和<code>docker logs</code> 一样，也可以加上 <code>-f,-t</code> 用来跟踪日志或者打印时间戳。</p>
<h3 id="Publishing-Changes"><a href="#Publishing-Changes" class="headerlink" title="Publishing Changes"></a>Publishing Changes</h3><p>和单个container一样，我们不希望修改一点代码就要rebuild整个项目，那样太麻烦了。因此我们要降本的文件夹和container中的/app 文件夹做映射，而且要比之前的利用绝对路径<code>$(PWD)</code>做映射更简单。比如说，我要把 本地的backend文件夹和/app文件夹做映射。只要 <code>./backend:/app</code> 即可</p>
<p>但是这有一个bug，就是后端会报一个错误，也就是 <code>nodemon:not found</code> </p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/50.png" style="zoom:100%;"></p>
<p>我们知道nodemon是一个很有用的包，它会监测文件的修改并实时渲染。但是，我们只在container中装载了node_modules文件夹而本地的backend目录下并没有node_modules文件夹。因此无法实现监测。</p>
<p>为了解决这个问题，我们可以在本地也安装<code>node_modules</code> 文件夹。这样再次启动前后端，就能实现同步更新了。</p>
<p><img src="/2021/04/07/docker%E5%9F%BA%E7%A1%801/51.png" style="zoom:100%;"></p>
<h3 id="Migrating-the-Database"><a href="#Migrating-the-Database" class="headerlink" title="Migrating the Database"></a>Migrating the Database</h3><p>如果要在一个新的电脑上运行这个项目，我们势必要把数据插入到新的mongodb当中去。因此这就需要用到数据迁移。在nodejs中有个很好用的工具，可以用来迁移mongodb数据库：<code>migrate-mongo</code></p>
<p>使用了这个工具，我们可以创建 <code>database-migration scripts</code> 如下：</p>
<p>这个文件存放在 <code>migrations</code>文件夹中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="keyword">async</span> up(db, client) &#123;</span><br><span class="line">    <span class="keyword">await</span> db</span><br><span class="line">      .collection(<span class="string">"movies"</span>)</span><br><span class="line">      .insertMany([</span><br><span class="line">        &#123; <span class="attr">title</span>: <span class="string">"Avatar"</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">title</span>: <span class="string">"Star Wars"</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">title</span>: <span class="string">"Terminator"</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">title</span>: <span class="string">"Titanic"</span> &#125;,</span><br><span class="line">      ]);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> down(db, client) &#123;</span><br><span class="line">    <span class="keyword">await</span> db.collection(<span class="string">"movies"</span>).deleteMany(&#123;</span><br><span class="line">      title: &#123;</span><br><span class="line">        $<span class="keyword">in</span>: [<span class="string">"Avatar"</span>, <span class="string">"Star Wars"</span>, <span class="string">"Terminator"</span>, <span class="string">"Titanic"</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里有两个模块：up函数是往database的movies数据表中中添加数据，down函数是在database删除数据。这两个函数式异步的</p>
<p>要启动这个脚本文件，可以 <code>migrate-mongo up</code>。因为在数据库中有变更日志，所以migrate-mongo 模块并不会重复执行一个脚本，插入重复的数据。</p>
<p>在package.json 中，我们看到可以用<code>npm run db:up</code>来简化<code>migrate-mongo up</code> </p>
<p>介绍完database migration之后，我们希望在启动项目的一开始先执行数据库迁移,在后端的Dockerfile中，我们只写了 <code>CMD [&quot;npm&quot;,&quot;start&quot;]</code> , 这是不够的，我们可在<code>docker-compose</code> 中定义 <code>command</code>字段来重写要执行的操作。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">backend:</span> </span><br><span class="line">    <span class="comment">#...</span></span><br><span class="line">	<span class="attr">command:</span> <span class="string">migrate-mongo</span> <span class="string">up</span> <span class="string">&amp;&amp;</span> <span class="string">npm</span> <span class="string">start</span></span><br></pre></td></tr></table></figure>
<p>但是这样写有个问题，因为当我执行<code>migrate-mongo up</code> 的时候， 我的db service可能还没有启动，这样就会报错了。为解决这个问题，需要在启动命令前增加<code>判断依赖服务状态的工具</code>，主要有三种：<strong>wait-for-it，dockerize，waitfor</strong>在这我使用<code>./wait-for</code> : </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">backend:</span> </span><br><span class="line">    <span class="comment">#...</span></span><br><span class="line">	<span class="attr">command:</span> <span class="string">./wait-for</span> <span class="string">db:27017</span> <span class="string">&amp;&amp;</span> <span class="string">migrate-mongo</span> <span class="string">up</span> <span class="string">&amp;&amp;</span> <span class="string">npm</span> <span class="string">start</span></span><br></pre></td></tr></table></figure>
<p>其中<code>./wait-for</code>后面的第一个参数是service 的名字，第二个参数是其对应的端口.</p>
<p>虽然写是写好了，但是这样的command未免有点不美观，因此，我们可以新建一个<code>docker-entrypoint.sh</code>的可执行文件，然后用command来执行它。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">echo "Waiting for MongoDB to start..."</span><br><span class="line">./wait-for db:27017 # 首先等待db service 启动</span><br><span class="line"></span><br><span class="line">echo "Migrating the databse..."</span><br><span class="line">npm run db:up # 进行数据迁移操作</span><br><span class="line"></span><br><span class="line">echo "Starting the server..."</span><br><span class="line">npm start # 最后启动backend server</span><br></pre></td></tr></table></figure>
<p>把command字段改成执行docker-entrypoint.sh 即可</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">backend:</span> </span><br><span class="line"><span class="comment">#...</span></span><br><span class="line">  <span class="attr">command:</span> <span class="string">./docker-entrypoint.sh</span></span><br></pre></td></tr></table></figure>
<p>最后我们来设置一下服务器的顺序启动问题，比如说先启动db服务，再启动backend服务，最后启动frontend服务，但是注意这只能保证容器进入了running状态，而不保证进入 ready状态,所以说我们要将depends_on和wait-for搭配使用。可以设置 <code>depends_on</code>字段来解决</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3.8"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">frontend:</span></span><br><span class="line">    <span class="attr">depends_on:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">backend</span></span><br><span class="line">   <span class="comment">#...</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attr">backend:</span> </span><br><span class="line">    <span class="attr">depends_on:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">   <span class="comment">#...</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">  <span class="comment">#...</span></span><br></pre></td></tr></table></figure>
<h3 id="Summary-1"><a href="#Summary-1" class="headerlink" title="Summary"></a>Summary</h3><p>这一节我们主要讲了这几个命令以及它们的延伸。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker-compose build</span><br><span class="line">docker-compose build --no-cached</span><br><span class="line">ocker-compose up</span><br><span class="line">docker-compose up -d</span><br><span class="line">docker-compose up —build</span><br><span class="line">docker-compose down</span><br><span class="line">docker-compose ps</span><br><span class="line">docker-compose logs</span><br><span class="line">Docker Compose commands</span><br></pre></td></tr></table></figure>
<h2 id="Deploying-Applications"><a href="#Deploying-Applications" class="headerlink" title="Deploying Applications"></a>Deploying Applications</h2><p>这一章节我们来讲一下如何发布一个应用</p>
<h3 id="Deployment-Options"><a href="#Deployment-Options" class="headerlink" title="Deployment Options"></a>Deployment Options</h3><p>对于一个项目，有两种部署的方式，其一可以部署到一个服务器上(single-host deployment)，也可以部署到一个服务器集群上(Cluster deployment)</p>
<p>只部署到一个服务器上，虽然操作比较简单，但是一旦服务器宕机，我们的项目也就失效了。而且当应用的瞬时流量较大时，单个服务器可能承受不了这样的压力。</p>
<p>如果选择<code>cluster deployment</code> 这种方式，这需要编制软件(orchestration tools)帮忙，主流orchestration tools有： <code>docker swarm</code> 和 <code>kubernetes(俗称k8s)</code> ，但是部署的逻辑较为复杂，因此这章还是使用<code>single-host deployment</code> 这种方式。</p>
<h3 id="Getting-a-Virtual-Private-Server"><a href="#Getting-a-Virtual-Private-Server" class="headerlink" title="Getting a Virtual Private Server"></a>Getting a Virtual Private Server</h3><p>VPS提供商有很多,比如说：</p>
<ul>
<li>Digital Ocean</li>
<li>Google Cloud Platform(GCP)</li>
<li>Microsoft Azure</li>
<li>Amazon Web Services(AWS) </li>
</ul>
<p>一般来说租个VPS都是要花钱的，我这里使用Oracle Virtualbox 来演示</p>
<h3 id="Installing-Docker-Machine"><a href="#Installing-Docker-Machine" class="headerlink" title="Installing Docker Machine"></a>Installing Docker Machine</h3><p>首先我们需要在项目文件夹中安装 Docker Machine。Docker Machine 是一种可以让您在虚拟主机上安装 Docker 的工具，并可以使用 docker-machine 命令来管理主机。Docker Machine 也可以集中管理所有的 docker 主机，比如快速的给 100 台服务器安装上 docker。</p>
<p>可以在这里下载：<a href="https://github.com/docker/machine/releases" target="_blank" rel="noopener">https://github.com/docker/machine/releases</a></p>
<p>我们使用的是mac os，那就复制这段连接：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -L https:&#x2F;&#x2F;github.com&#x2F;docker&#x2F;machine&#x2F;releases&#x2F;download&#x2F;v0.16.2&#x2F;docker-machine-&#96;uname -s&#96;-&#96;uname -m&#96; &gt;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;docker-machine &amp;&amp; \</span><br><span class="line">  chmod +x &#x2F;usr&#x2F;local&#x2F;bin&#x2F;docker-machine</span><br></pre></td></tr></table></figure>
<p>当然，我们下载了homebrew，可直接用 <code>brew install docker docker-machine</code></p>
<h3 id="Provisioning-a-Host"><a href="#Provisioning-a-Host" class="headerlink" title="Provisioning a Host"></a>Provisioning a Host</h3><p>现在我们要用docker machine 创建一个虚拟机。docker-machine支持的虚拟机提供服务如下:</p>
<p><a href="https://docs.docker.com/machine/drivers/" target="_blank" rel="noopener">https://docs.docker.com/machine/drivers/</a></p>
<h3 id="Connecting-to-the-Host"><a href="#Connecting-to-the-Host" class="headerlink" title="Connecting to the Host"></a>Connecting to the Host</h3><h3 id="Defining-the-Production-Configuration"><a href="#Defining-the-Production-Configuration" class="headerlink" title="Defining the Production Configuration"></a>Defining the Production Configuration</h3><h3 id="Reducing-the-Image-Size"><a href="#Reducing-the-Image-Size" class="headerlink" title="Reducing the Image Size"></a>Reducing the Image Size</h3><h3 id="Deploying-the-Application"><a href="#Deploying-the-Application" class="headerlink" title="Deploying the Application"></a>Deploying the Application</h3><h3 id="Troubleshooting-Deployment-Issues"><a href="#Troubleshooting-Deployment-Issues" class="headerlink" title="Troubleshooting Deployment Issues"></a>Troubleshooting Deployment Issues</h3><h3 id="Publishing-Changes-1"><a href="#Publishing-Changes-1" class="headerlink" title="Publishing Changes"></a>Publishing Changes</h3><h3 id="Course-Wrap-Up"><a href="#Course-Wrap-Up" class="headerlink" title="Course Wrap Up"></a>Course Wrap Up</h3>
      
    </div>
    
    
    
    <div>
      
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束，感谢您的阅读-------------</div>
    
</div>

      
    </div>
    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:</strong>
    Jason
  </li>
  <li class="post-copyright-link">
    <strong>Post link:</strong>
    <a href="https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/" title="docker基础1">https://jasonxqh.github.io/2021/04/07/docker%E5%9F%BA%E7%A1%801/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice: </strong>
    All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> unless stating additionally.
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/docker/" rel="tag"><i class="fa fa-tag"></i> docker</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/04/04/%E5%A4%9A%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F3-1-3-3/" rel="next" title="多维随机变量3.1-3.3">
                <i class="fa fa-chevron-left"></i> 多维随机变量3.1-3.3
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/04/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%8A%A5%E5%91%8A6/" rel="prev" title="计算机网络报告6">
                计算机网络报告6 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80OTgyMC8yNjMxMQ=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Jason</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives%7C%7C%20archive">
              
                  <span class="site-state-item-count">426</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">60</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/JasonXQH" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:10195501423@stu.ecnu.edu.cn" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://yanghong.tech/" title="友链:杨弘的博客" target="_blank">友链:杨弘的博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://ankate.github.io/" title="友链:赵奕轲的博客" target="_blank">友链:赵奕轲的博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://github.com/JasonXQH/JasonXQH.github.io" title="Like it, STAR ME" target="_blank">Like it, STAR ME</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#docker基础1"><span class="nav-number">1.</span> <span class="nav-text">docker基础1</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux基础"><span class="nav-number">1.1.</span> <span class="nav-text">Linux基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Managing-packages"><span class="nav-number">1.1.1.</span> <span class="nav-text">Managing packages</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Navigating-the-file-system"><span class="nav-number">1.1.2.</span> <span class="nav-text">Navigating the file system</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Manipulating-files-and-directories"><span class="nav-number">1.1.3.</span> <span class="nav-text">Manipulating files and directories</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Editing-and-viewing-files"><span class="nav-number">1.1.4.</span> <span class="nav-text">Editing and viewing files</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Searching-for-text"><span class="nav-number">1.1.5.</span> <span class="nav-text">Searching for text</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Finding-files-and-directories"><span class="nav-number">1.1.6.</span> <span class="nav-text">Finding files and directories</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Managing-environment-variables"><span class="nav-number">1.1.7.</span> <span class="nav-text">Managing environment variables</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Managing-processes"><span class="nav-number">1.1.8.</span> <span class="nav-text">Managing processes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Managing-users-and-groups"><span class="nav-number">1.1.9.</span> <span class="nav-text">Managing users and groups</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#File-permissions"><span class="nav-number">1.1.10.</span> <span class="nav-text">File permissions</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Building-Images"><span class="nav-number">1.2.</span> <span class="nav-text">Building Images</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Images-and-Containers"><span class="nav-number">1.2.1.</span> <span class="nav-text">Images and Containers</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Image"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">Image</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Container"><span class="nav-number">1.2.1.2.</span> <span class="nav-text">Container</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sample-Web-Application"><span class="nav-number">1.2.2.</span> <span class="nav-text">Sample Web Application</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dockerfile-Instructions"><span class="nav-number">1.2.3.</span> <span class="nav-text">Dockerfile Instructions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Choosing-the-Right-Base-Image"><span class="nav-number">1.2.4.</span> <span class="nav-text">Choosing the Right Base Image</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Copying-Files-and-Directories"><span class="nav-number">1.2.5.</span> <span class="nav-text">Copying Files and Directories</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ADD-特有功能"><span class="nav-number">1.2.5.1.</span> <span class="nav-text">ADD 特有功能</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#构建："><span class="nav-number">1.2.5.2.</span> <span class="nav-text">构建：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Excluding-Files-and-Directories"><span class="nav-number">1.2.6.</span> <span class="nav-text">Excluding Files and Directories</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Running-Commands"><span class="nav-number">1.2.7.</span> <span class="nav-text">Running Commands</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Setting-Environment-Variables"><span class="nav-number">1.2.8.</span> <span class="nav-text">Setting Environment Variables</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exposing-Ports"><span class="nav-number">1.2.9.</span> <span class="nav-text">Exposing Ports</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Setting-the-User"><span class="nav-number">1.2.10.</span> <span class="nav-text">Setting the User</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Defining-Entrypoints"><span class="nav-number">1.2.11.</span> <span class="nav-text">Defining Entrypoints</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#在terminal中直接启动项目"><span class="nav-number">1.2.11.1.</span> <span class="nav-text">在terminal中直接启动项目</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在dockerfile中启动项目"><span class="nav-number">1.2.11.2.</span> <span class="nav-text">在dockerfile中启动项目</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Speeding-Up-Builds"><span class="nav-number">1.2.12.</span> <span class="nav-text">Speeding Up Builds</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Removing-Images"><span class="nav-number">1.2.13.</span> <span class="nav-text">Removing Images</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tagging-Images"><span class="nav-number">1.2.14.</span> <span class="nav-text">Tagging Images</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sharing-Images"><span class="nav-number">1.2.15.</span> <span class="nav-text">Sharing Images</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Saving-and-Loading-Images"><span class="nav-number">1.2.16.</span> <span class="nav-text">Saving and Loading Images</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Summary"><span class="nav-number">1.2.17.</span> <span class="nav-text">Summary</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Working-with-Containers"><span class="nav-number">1.3.</span> <span class="nav-text">Working with Containers</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Starting-Containers"><span class="nav-number">1.3.1.</span> <span class="nav-text">Starting Containers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Viewing-the-Logs"><span class="nav-number">1.3.2.</span> <span class="nav-text">Viewing the Logs</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Publishing-Ports"><span class="nav-number">1.3.3.</span> <span class="nav-text">Publishing Ports</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Executing-Commands-in-Running-Containers"><span class="nav-number">1.3.4.</span> <span class="nav-text">Executing Commands in Running Containers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Stopping-and-Starting-Containers"><span class="nav-number">1.3.5.</span> <span class="nav-text">Stopping and Starting Containers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Removing-Containers"><span class="nav-number">1.3.6.</span> <span class="nav-text">Removing Containers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Containers-File-System"><span class="nav-number">1.3.7.</span> <span class="nav-text">Containers File System</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Persisting-Data-using-Volumes"><span class="nav-number">1.3.8.</span> <span class="nav-text">Persisting Data using Volumes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Copying-Files-between-the-Host-and-Containers"><span class="nav-number">1.3.9.</span> <span class="nav-text">Copying Files between the Host and Containers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sharing-the-Source-Code-with-a-Container"><span class="nav-number">1.3.10.</span> <span class="nav-text">Sharing the Source Code with a Container</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Running-Multi-container-Applications"><span class="nav-number">1.4.</span> <span class="nav-text">Running Multi-container Applications</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Installing-Docker-Compose"><span class="nav-number">1.4.1.</span> <span class="nav-text">Installing Docker Compose</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Cleaning-Up-our-Workspace"><span class="nav-number">1.4.2.</span> <span class="nav-text">Cleaning Up our Workspace</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#The-Sample-Web-Application"><span class="nav-number">1.4.3.</span> <span class="nav-text">The Sample Web Application</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#bug"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">bug</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JSON-and-YAML-Formats"><span class="nav-number">1.4.4.</span> <span class="nav-text">JSON and YAML Formats</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Creating-a-Compose-File"><span class="nav-number">1.4.5.</span> <span class="nav-text">Creating a Compose File</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#version字段"><span class="nav-number">1.4.5.1.</span> <span class="nav-text">version字段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#services字段"><span class="nav-number">1.4.5.2.</span> <span class="nav-text">services字段</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#frontend"><span class="nav-number">1.4.5.2.1.</span> <span class="nav-text">frontend</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#backend"><span class="nav-number">1.4.5.2.2.</span> <span class="nav-text">backend</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#db"><span class="nav-number">1.4.5.2.3.</span> <span class="nav-text">db</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#volumes"><span class="nav-number">1.4.5.3.</span> <span class="nav-text">volumes:</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Building-Images-1"><span class="nav-number">1.4.6.</span> <span class="nav-text">Building Images</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Starting-and-Stopping-the-Application"><span class="nav-number">1.4.7.</span> <span class="nav-text">Starting and Stopping the Application</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Docker-Networking"><span class="nav-number">1.4.8.</span> <span class="nav-text">Docker Networking</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Viewing-Logs"><span class="nav-number">1.4.9.</span> <span class="nav-text">Viewing Logs</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Publishing-Changes"><span class="nav-number">1.4.10.</span> <span class="nav-text">Publishing Changes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Migrating-the-Database"><span class="nav-number">1.4.11.</span> <span class="nav-text">Migrating the Database</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Summary-1"><span class="nav-number">1.4.12.</span> <span class="nav-text">Summary</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Deploying-Applications"><span class="nav-number">1.5.</span> <span class="nav-text">Deploying Applications</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Deployment-Options"><span class="nav-number">1.5.1.</span> <span class="nav-text">Deployment Options</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Getting-a-Virtual-Private-Server"><span class="nav-number">1.5.2.</span> <span class="nav-text">Getting a Virtual Private Server</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Installing-Docker-Machine"><span class="nav-number">1.5.3.</span> <span class="nav-text">Installing Docker Machine</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Provisioning-a-Host"><span class="nav-number">1.5.4.</span> <span class="nav-text">Provisioning a Host</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Connecting-to-the-Host"><span class="nav-number">1.5.5.</span> <span class="nav-text">Connecting to the Host</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Defining-the-Production-Configuration"><span class="nav-number">1.5.6.</span> <span class="nav-text">Defining the Production Configuration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reducing-the-Image-Size"><span class="nav-number">1.5.7.</span> <span class="nav-text">Reducing the Image Size</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Deploying-the-Application"><span class="nav-number">1.5.8.</span> <span class="nav-text">Deploying the Application</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Troubleshooting-Deployment-Issues"><span class="nav-number">1.5.9.</span> <span class="nav-text">Troubleshooting Deployment Issues</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Publishing-Changes-1"><span class="nav-number">1.5.10.</span> <span class="nav-text">Publishing Changes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Course-Wrap-Up"><span class="nav-number">1.5.11.</span> <span class="nav-text">Course Wrap Up</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart" aria-hidden="true"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jason</span>
 <!--
  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">1257.9k</span>
  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>



-->
        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('-1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->


  
  

  
  


  

  

</body>
</html>
